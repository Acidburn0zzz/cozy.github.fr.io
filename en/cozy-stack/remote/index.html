<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <meta name="author" content="CozyCloud - https://cozy.io">
        <link rel="canonical" href="https://docs.cozy.io/cozy-stack/remote/">
        <link rel="shortcut icon" href="../../img/favicon.png">
        
        <title>/remote - Proxy for remote data/API - Documentation</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
            <link href="../../css/extra.css" rel="stylesheet">
            <link href="../../css/highlight_theme.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

	<script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://docs.cozy.io/">Documentation</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../..">Home</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Install <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../install/">Install Cozy on your own server</a>
</li>
                            
<li >
    <a href="../../install/debian/">Debian</a>
</li>
                            
<li >
    <a href="../../install/manual/">Manual installation</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Develop <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="/en/dev/">Let's hack some code</a>
</li>
                            
<li >
    <a href="/en/dev/connect-mobile-app-local-stack/">Connect a mobile app to your local stack</a>
</li>
                            
<li >
    <a href="/en/dev/intro/">Architecture</a>
</li>
                            
<li >
    <a href="/en/dev/app/">Create your first app</a>
</li>
                            
<li >
    <a href="/en/dev/konnector/">Develop a connector</a>
</li>
                            
<li >
    <a href="/en/dev/cordova/">Create a mobile app with cordova</a>
</li>
                            
<li >
    <a href="/en/dev/sendmail/">How to send mail in development</a>
</li>
                            
  <li class="dropdown-submenu">
    <a href="#">References</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">cozy-client-js</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-client-js/intro/">Introduction</a>
</li>
            
<li >
    <a href="../../cozy-client-js/browser-sdk-transition/">Transition from cozy-browser-sdk</a>
</li>
            
<li >
    <a href="../../cozy-client-js/offline/">How to support offline</a>
</li>
            
<li >
    <a href="../../cozy-client-js/oauth/">OAuth guide</a>
</li>
            
<li >
    <a href="../../cozy-client-js/auth-api/">Authentication API</a>
</li>
            
<li >
    <a href="../../cozy-client-js/data-api/">Data System API</a>
</li>
            
<li >
    <a href="../../cozy-client-js/files-api/">Files API</a>
</li>
            
<li >
    <a href="../../cozy-client-js/jobs-api/">Jobs API</a>
</li>
            
<li >
    <a href="../../cozy-client-js/intents-api/">Intents API</a>
</li>
            
<li >
    <a href="../../cozy-client-js/settings-api/">Settings API</a>
</li>
            
<li >
    <a href="../../cozy-client-js/sharing-api/">Sharing API</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-konnector-libs</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-konnector-libs/api/">API</a>
</li>
            
<li >
    <a href="../../cozy-konnector-libs/cli/">CLI</a>
</li>
            
<li >
    <a href="../../cozy-konnector-libs/dev/">Develop</a>
</li>
            
<li >
    <a href="../../cozy-konnector-libs/errors/">Errors</a>
</li>
            
<li >
    <a href="../../cozy-konnector-libs/operation-linking/">Operation linking</a>
</li>
            
<li >
    <a href="../../cozy-konnector-libs/synchronization/">Synchronization</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-doctypes</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.accounts/">Accounts</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.photos.albums/">Albums</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.bank/">Banking doctypes</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.bills/">Bills</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.konnectors/">Connectors</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.contacts/">Contacts</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.files/">Files</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.notifications/">Notifications</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.payslips/">Payslips</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.remote.requests/">Remote requests</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.sessions.logins/">Session logins</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.sharings/">Sharings</a>
</li>
            
<li >
    <a href="../../cozy-doctypes/docs/io.cozy.triggers/">Triggers</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">cozy-stack</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../README/">README</a>
</li>
            
  <li class="dropdown-submenu">
    <a href="#">Architecture</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../architecture/">General overview</a>
</li>
            
<li >
    <a href="../security/">Security</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Usage</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../INSTALL/">Install the cozy-stack</a>
</li>
            
<li >
    <a href="../cli/cozy-stack/">Manpages of the command-line tool</a>
</li>
            
<li >
    <a href="../config/">Configuration file</a>
</li>
            
<li >
    <a href="../instance/">Managing Instances</a>
</li>
            
<li >
    <a href="../onboarding/">Onboarding</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">For developpers</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../client-app-dev/">Develop a client-side app</a>
</li>
            
<li >
    <a href="../docker/">Running and building Docker images</a>
</li>
            
<li >
    <a href="../release/">Build a release</a>
</li>
            
<li >
    <a href="../CONTRIBUTING/">The contributing guide</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Services</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../auth/">/auth - Authentication & OAuth</a>
</li>
            
<li >
    <a href="../apps/">/apps - Applications Management</a>
</li>
            
<li >
    <a href="../registry/">Apps registry</a>
</li>
            
<li >
    <a href="../data-system/">/data - Data System</a>
</li>
            
<li >
    <a href="../mango/">Mango</a>
</li>
            
<li >
    <a href="../replication/">Replication</a>
</li>
            
<li >
    <a href="../couchdb-quirks/">CouchDB Quirks</a>
</li>
            
<li >
    <a href="../pouchdb-quirks/">PouchDB Quirks</a>
</li>
            
<li >
    <a href="../files/">/files - Virtual File System</a>
</li>
            
<li >
    <a href="../references-docs-in-vfs/">References of documents in VFS</a>
</li>
            
<li >
    <a href="../intents/">/intents - Intents</a>
</li>
            
<li >
    <a href="../jobs/">/jobs Jobs</a>
</li>
            
<li >
    <a href="../konnectors/">Konnectors</a>
</li>
            
<li >
    <a href="../workers/">Workers</a>
</li>
            
<li >
    <a href="../move/">/move - Move, export and import an instance</a>
</li>
            
<li >
    <a href="../notifications/">/notifications - Notifications</a>
</li>
            
<li >
    <a href="../permissions/">/permissions - Permissions</a>
</li>
            
<li >
    <a href="../realtime/">/realtime - Realtime</a>
</li>
            
<li class="active">
    <a href="./">/remote - Proxy for remote data/API</a>
</li>
            
<li >
    <a href="../settings/">/settings - Settings</a>
</li>
            
<li >
    <a href="../sharing/">/sharings - Sharing</a>
</li>
            
<li >
    <a href="../sharing-design/">Request for comments</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">konitor</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../konitor/cli/">CLI</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                        </ul>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li>
                        <a href="https://github.com/cozy/cozy.github.io/">
                                <i class="fa fa-github"></i>GitHub
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3">
<div class="bs-sidebar hidden-print affix" role="complementary">
    <ul class="nav bs-sidenav well" style='padding-left: 0; padding-right: 0; margin-bottom: 1.5rem'>
        <li class="main active"><a href="#proxy-for-remote-dataapi">Proxy for remote data/API</a></li>
            <li><a href="#declaring-a-remote-doctype">Declaring a remote doctype</a></li>
            <li><a href="#declaring-permissions">Declaring permissions</a></li>
            <li><a href="#calling-the-remote-api">Calling the remote API</a></li>
            <li><a href="#logs">Logs</a></li>
            <li><a href="#for-developers">For developers</a></li>
    </ul>
  <div style='padding-left: 2rem'>
    
    <a id='edit-link' href='https://github.com/cozy/cozy.github.io/edit/dev/src/cozy-stack/remote.md'>Edit documentation</a>
    <script type='text/javascript'>
        /* Here we detect if the current page is from an external documentation and we 
        change the href of the editing link so it goes to the right repository and file */
        const outsideDocs = [{"repo": "https://github.com/cozy/cozy-client-js.git", "name": "cozy-client-js", "subdir": "docs"}, {"repo": "https://github.com/konnectors/libs.git", "name": "cozy-konnector-libs", "subdir": "packages/cozy-konnector-libs/docs"}, {"repo": "https://github.com/cozy/cozy-doctypes.git", "name": "cozy-doctypes", "subdir": "."}, {"repo": "https://github.com/cozy/cozy-stack.git", "name": "cozy-stack", "subdir": "docs"}, {"repo": "https://github.com/konnectors/konitor.git", "name": "konitor", "subdir": "docs"}]
        const editNode = document.querySelector('#edit-link')
        const pathname = window.location.pathname
        const editURI = 'edit/master/'
        const removeGitSuffix = function (x) { return x.replace(/\.git$/, '') }

        // Returns the external repo associated to a pathname
        const detectExternalRepo = function (pathname) {
            for (var outsideDoc of outsideDocs) {
                if (window.location.pathname.includes('/' + outsideDoc.name + '/')) {
                    return outsideDoc
                }
            }
        }

        // Change the href attribute of a link to point to the correct edition page on GitHub
        // for the passed external documentation
        const fixEditLink = function (editNode, externalDoc) {
            const repoFile = pathname.replace('/en/' + externalDoc.name, '').replace(/\/$/, '.md')
            const baseRepo = removeGitSuffix(externalDoc.repo)
            editNode.href = baseRepo + '/' + editURI + externalDoc.subdir + repoFile
        }

        const externalRepo = detectExternalRepo(pathname)
        if (externalRepo) {
            fixEditLink(editNode, externalRepo)
        }
    </script>
    
  </div>
</div></div>
                <div class="col-md-9" role="main">

<p><a href="../README/#table-of-contents">Table of contents</a></p>
<h1 id="proxy-for-remote-dataapi">Proxy for remote data/API<a class="headerlink" href="#proxy-for-remote-dataapi" title="Permanent link">&para;</a></h1>
<p>The client side applications in Cozy are constrained and cannot speak with
external websites to avoid leaking personal data. Technically, it is made with
the Content Security Policy. These rules are very strict and it would be a pity
to now allow a client side app to load public informations from a source like
Wikipedia. Our proposal is to make client side apps able to query external
websites of their choices, but these requests will be made via the cozy-stack
(as a proxy) and will be logged to check later that no personal data was leaked
unintentionally. We can see the data loaded from the external website as a
document with a doctype: it&rsquo;s just not a doctype local to our cozy, but a remote
one.</p>
<p>A client side app can request data from external websites by doing these three
steps:</p>
<ol>
<li>Declaring a remote doctype and its requests</li>
<li>Declaring permissions on these doctypes in the manifest</li>
<li>Calling the <code>/remote</code> API of cozy-stack</li>
</ol>
<h2 id="declaring-a-remote-doctype">Declaring a remote doctype<a class="headerlink" href="#declaring-a-remote-doctype" title="Permanent link">&para;</a></h2>
<p>Doctypes are formalized in this repository:
<a href="https://github.com/cozy/cozy-doctypes">github.com/cozy/cozy-doctypes</a>. Each
doctype has its own directory inside the repository. For a remote doctype, it
will include a file called <code>request</code> that will describe how the cozy-stack will
request the external website.</p>
<p>Let&rsquo;s take an example:</p>
<pre class="codehilite"><code>$ tree cozy-doctypes
cozy-doctypes
├── [...]
├── org.wikidata.entity
│   └── request
└── org.wikidata.search
    └── request

$ cat cozy-doctypes/org.wikidata.entity/request
GET https://www.wikidata.org/wiki/Special:EntityData/{{entity}}.json
Accept: application/json

$ cat cozy-doctypes/org.wikidata.search/request
GET https://www.wikidata.org/w/api.php?action=wbsearchentities&amp;search={{q}}&amp;language=en&amp;format=json</code></pre>


<p>Here, we have two remote doctypes. Each one has a request defined for it.</p>
<p>The format for the request file is:</p>
<ul>
<li>the verb and the URL on the first line</li>
<li>then some lines that describe the HTTP headers</li>
<li>then a blank line and the body if the request is a POST</li>
</ul>
<p>For the path, the query-string, the headers, and the body, it&rsquo;s possible to have
some dynamic part by using <code>{{</code>, a variable name, and <code>}}</code>.</p>
<p>Some templating helpers are available to escape specific variables using <code>{{</code>
function name - space - variable name <code>}}</code>. These helpers are only available for
the body part of the template.</p>
<p>Available helpers:</p>
<ul>
<li><code>json</code>: for json parts (<code>{ "key": "{{json val}}" }</code>)</li>
<li><code>html</code>: for html parts (<code>&lt;p&gt;{{html val}}&lt;/p&gt;</code>)</li>
<li><code>query</code>: for query parameter of a url (<code>http://foobar.com?q={{query q}}</code>)</li>
<li><code>path</code>: for path component of a url (<code>http://foobar.com/{{path p}}</code>)</li>
</ul>
<p>Values injected in the URL are automatically URI-escaped based on the part they
are included in: namely as a query parameter or as a path component.</p>
<p><strong>Note</strong>: by default, the User-Agent is set to a default value (&ldquo;cozy-stack&rdquo; and
a version number). It can be overriden in the request description.</p>
<p>Example:</p>
<pre class="codehilite"><code>GET https://foobar.com/{{path}}?q={{query}}
Content-Type: {{contentType}}

{
  &quot;key&quot;: &quot;{{json value}}&quot;,
  &quot;url&quot;: &quot;http://anotherurl.com/{{path anotherPath}}?q={{query anotherQuery}}&quot;,
}</code></pre>


<h2 id="declaring-permissions">Declaring permissions<a class="headerlink" href="#declaring-permissions" title="Permanent link">&para;</a></h2>
<p>Nothing special here. The client side app must declare that it will use these
doctypes in its manifest, like for other doctypes:</p>
<pre class="codehilite"><code class="language-json">{
  &quot;...&quot;: &quot;...&quot;,
  &quot;permissions&quot;: {
    &quot;search&quot;: {
      &quot;description&quot;: &quot;Required for searching on wikidata&quot;,
      &quot;type&quot;: &quot;org.wikidata.search&quot;
    },
    &quot;entity&quot;: {
      &quot;description&quot;:
        &quot;Required for getting more informations about an entity on wikidata&quot;,
      &quot;type&quot;: &quot;org.wikidata.entity&quot;
    }
  }
}</code></pre>


<h2 id="calling-the-remote-api">Calling the remote API<a class="headerlink" href="#calling-the-remote-api" title="Permanent link">&para;</a></h2>
<h3 id="getpost-remotedoctype">GET/POST <code>/remote/:doctype</code><a class="headerlink" href="#getpost-remotedoctype" title="Permanent link">&para;</a></h3>
<p>The client side app must use the same verb as the defined request (<code>GET</code> in our
two previous examples). It can use the query-string for GET, and a JSON body for
POST, to give values for the variables.</p>
<p>Example:</p>
<pre class="codehilite"><code class="language-http">GET /remote/org.wikidata.search?q=Douglas+Adams HTTP/1.1
Host: alice.cozy.tools</code></pre>


<p>It is possible to send some extra informations, to make it easier to understand
the request. If no variable in the request matches it, it won&rsquo;t be send to the
remote website.</p>
<p>Example:</p>
<pre class="codehilite"><code class="language-http">POST /remote/org.example HTTP/1.1
Host: alice.cozy.tools
Content-Type: application/json</code></pre>


<pre class="codehilite"><code class="language-json">{
  &quot;query&quot;: &quot;Qbhtynf Nqnzf&quot;,
  &quot;comment&quot;: &quot;query is rot13 for Douglas Adams&quot;
}</code></pre>


<p><strong>Note</strong>: currently, only the response with a content-type that is an image,
JSON or XML are accepted. Other content-types are blocked the time to evaluate
if they are useful and their security implication (javascript is probably not
something we want to allow).</p>
<h3 id="get-remoteassetsasset-name">GET <code>/remote/assets/:asset-name</code><a class="headerlink" href="#get-remoteassetsasset-name" title="Permanent link">&para;</a></h3>
<p>The client application can fetch a list of predefined assets via this route.
The resources available are defined in the configuration file.</p>
<p>Example:</p>
<pre class="codehilite"><code class="language-http">GET /remote/assets/bank HTTP/1.1
Host: alice.cozy.tools</code></pre>


<h2 id="logs">Logs<a class="headerlink" href="#logs" title="Permanent link">&para;</a></h2>
<p>The requests are logged as the <code>io.cozy.remote.requests</code> doctype, with the
doctype asked, the parameter (even those that have not been used, like <code>comment</code>
in the previous example), and the application that has made the request.</p>
<h2 id="for-developers">For developers<a class="headerlink" href="#for-developers" title="Permanent link">&para;</a></h2>
<p>If you are a developer and you want to use a new remote doctype, it can be
difficult to first make it available in the github.com/cozy/cozy-doctypes
repository and only then test it. So, the cozy-stack serve command will have a
<code>--doctypes</code> option to gives a local directory with the doctypes. You can fork
the repository, clone it, work on a new doctype inside, test it locally, and
when OK, make a pull request for it.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <!-- Piwik -->
        <script type="text/javascript">
          var _paq = _paq || [];
          /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
          _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
          _paq.push(['trackPageView']);
          _paq.push(['enableLinkTracking']);
          (function() {
            var u="//piwik.cozycloud.cc/";
            _paq.push(['setTrackerUrl', u+'piwik.php']);
            _paq.push(['setSiteId', '7']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
          })();
        </script>
        <noscript><p><img src="//piwik.cozycloud.cc/piwik.php?idsite=7&rec=1" style="border:0;" alt="" /></p></noscript>
        <!-- End Piwik Code -->
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>
        <script src="../../extra.js"></script>
        <script src="../../search/main.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
