{
    "docs": [
        {
            "location": "/", 
            "text": "Cozy Documentation\n\n\nThe go-to website about Cozy configuration and setup.\n\n\n\n\n\n    \n\n      \n\n      \nLearn how to use your server\n\n    \n\n  \n\n\n\n    \n\n      \n\n      \nKeep your devices in sync\n\n    \n\n  \n\n\n\n    \n\n      \n\n      \nInstall your own server\n\n    \n\n  \n\n\n\n    \n\n      \n\n      \nDevelop applications\n\n      Learn how to develop applications and connectors.\n    \n\n  \n\n\n\n\nGet in touch\n\n\nIf you have any questions, you can contact us via these 3 medias:\n\n\n\n\nWrite an email to our Support team: contact at cozy.io\n\n\nPost on the forum\n\n\nChat with us on IRC", 
            "title": "Home"
        }, 
        {
            "location": "/#cozy-documentation", 
            "text": "The go-to website about Cozy configuration and setup.   \n     \n       \n       Learn how to use your server \n     \n    \n     \n       \n       Keep your devices in sync \n     \n    \n     \n       \n       Install your own server \n     \n    \n     \n       \n       Develop applications \n      Learn how to develop applications and connectors.", 
            "title": "Cozy Documentation"
        }, 
        {
            "location": "/#get-in-touch", 
            "text": "If you have any questions, you can contact us via these 3 medias:   Write an email to our Support team: contact at cozy.io  Post on the forum  Chat with us on IRC", 
            "title": "Get in touch"
        }, 
        {
            "location": "/use/", 
            "text": "Welcome to your new home\n\n\nHello, I\u2019m Claude, Cozy support team member. Let me introduce you to your new home in the cloud.\n\n\nOur charter\n\n\nBefore starting the visit, I\u2019d like to tell you a few words about our values. Our priority is to help you take back the control on your data, by importing them into a safe place, a place that you\u2019re the only one to have access.\n\n\nIn your personal cloud, you\u2019re at home\n\n\nBy default, you are the only one that can access your data. (\u2026)\n\n\nYour data belongs to you\n\n\nYour are the one and only owner of the data stored on your cloud.\n\n\nOpenness brings confidence\n\n\nCozy is and will stay a service built on free software: you can use, copy, improve the source code.\n\n\nYou decide how your data can be used\n\n\nYour Cozy server allows to control the data that you share with third party.\n\n\nCreate your home in the cloud\n\n\nYour home has an address. Your home in the cloud also has an address. Let\u2019s choose it!\n\n\n\n\nClaude\u2019s tip\n\n\nCreating a good password may be hard.\n\n\n\n\nYour toolbox\n\n\nSave all your files and documents in just a click\n\n\nAccess your files wherever your are, whenever you want\n\n\nConnect to deconnect\n\n\nChecklist\n\n\nHave you installed the Cozy application on your phone?\n\n\nHave you installed the Cozy application on your computers?\n\n\nAny question?\n\n\nOne last surprise", 
            "title": "User guide"
        }, 
        {
            "location": "/use/#welcome-to-your-new-home", 
            "text": "Hello, I\u2019m Claude, Cozy support team member. Let me introduce you to your new home in the cloud.", 
            "title": "Welcome to your new home"
        }, 
        {
            "location": "/use/#our-charter", 
            "text": "Before starting the visit, I\u2019d like to tell you a few words about our values. Our priority is to help you take back the control on your data, by importing them into a safe place, a place that you\u2019re the only one to have access.", 
            "title": "Our charter"
        }, 
        {
            "location": "/use/#in-your-personal-cloud-youre-at-home", 
            "text": "By default, you are the only one that can access your data. (\u2026)", 
            "title": "In your personal cloud, you\u2019re at home"
        }, 
        {
            "location": "/use/#your-data-belongs-to-you", 
            "text": "Your are the one and only owner of the data stored on your cloud.", 
            "title": "Your data belongs to you"
        }, 
        {
            "location": "/use/#openness-brings-confidence", 
            "text": "Cozy is and will stay a service built on free software: you can use, copy, improve the source code.", 
            "title": "Openness brings confidence"
        }, 
        {
            "location": "/use/#you-decide-how-your-data-can-be-used", 
            "text": "Your Cozy server allows to control the data that you share with third party.", 
            "title": "You decide how your data can be used"
        }, 
        {
            "location": "/use/#create-your-home-in-the-cloud", 
            "text": "Your home has an address. Your home in the cloud also has an address. Let\u2019s choose it!   Claude\u2019s tip  Creating a good password may be hard.", 
            "title": "Create your home in the cloud"
        }, 
        {
            "location": "/use/#your-toolbox", 
            "text": "", 
            "title": "Your toolbox"
        }, 
        {
            "location": "/use/#save-all-your-files-and-documents-in-just-a-click", 
            "text": "", 
            "title": "Save all your files and documents in just a click"
        }, 
        {
            "location": "/use/#access-your-files-wherever-your-are-whenever-you-want", 
            "text": "", 
            "title": "Access your files wherever your are, whenever you want"
        }, 
        {
            "location": "/use/#connect-to-deconnect", 
            "text": "", 
            "title": "Connect to deconnect"
        }, 
        {
            "location": "/use/#checklist", 
            "text": "", 
            "title": "Checklist"
        }, 
        {
            "location": "/use/#have-you-installed-the-cozy-application-on-your-phone", 
            "text": "", 
            "title": "Have you installed the Cozy application on your phone?"
        }, 
        {
            "location": "/use/#have-you-installed-the-cozy-application-on-your-computers", 
            "text": "", 
            "title": "Have you installed the Cozy application on your computers?"
        }, 
        {
            "location": "/use/#any-question", 
            "text": "", 
            "title": "Any question?"
        }, 
        {
            "location": "/use/#one-last-surprise", 
            "text": "", 
            "title": "One last surprise"
        }, 
        {
            "location": "/sync/", 
            "text": "Sync all your devices with your server\n\n\n\n\nsynchronize your phone\n\n\nsynchronize your desktop computer", 
            "title": "Stay in sync"
        }, 
        {
            "location": "/sync/#sync-all-your-devices-with-your-server", 
            "text": "synchronize your phone  synchronize your desktop computer", 
            "title": "Sync all your devices with your server"
        }, 
        {
            "location": "/sync/phone/", 
            "text": "Sync your phone with your server\n\n\nComing soon!", 
            "title": "Synchronize your phone"
        }, 
        {
            "location": "/sync/phone/#sync-your-phone-with-your-server", 
            "text": "Coming soon!", 
            "title": "Sync your phone with your server"
        }, 
        {
            "location": "/sync/desktop/", 
            "text": "Sync your desktop computer with your server\n\n\nCozy Drive for desktop allows you to synchronize your files and folders between your Cozy and your desktop. Thus, you can work on your files offline. Your modifications will be synchronized as soon as network will be available.\n\n\nInstallation\n\n\nBefore installing Cozy Drive, make sure your Cozy should be up-to-date.\n\n\nWindows\n\n\nYou can download Cozy Drive for Windows on \nthis page\n.\n\n\nList of known to work versions\n\n\nMacOS\n\n\nYou can download Cozy Drive for macOS on \nthis page\n.\n\n\nList of known to work versions\n\n\nLinux\n\n\nLearn how to download and use the GNU/linux client on \nthis page\n.\n\n\nConfiguration\n\n\nAt the end of the installation, application will start and ask you for a few informations:\n\n\n\n\nYour Cozy URL. In other words, the address used to access to your Cozy.\n\n\nYour Cozy password. We don\u2019t save your password, we only use it to create a new device login which it uses to synchronize your files.\n\n\nThe folder where you want to synchronize your files.\n\n\n\n\n\n\nOnce done, you will be redirected to the dashboard. First synchronization can now start.\n\n\nThe dashboard is composed of :\n\n\n\n\nAn information panel about synchronizations and available disk space on your Cozy.\n\n\nA settings panel to configure autostart.\n\n\nAn account panel with information on your Cozy and possibility to unlink your Cozy.\n\n\nA help panel in case of problem\n\n\n\n\n\n\nTroubleshooting\n\n\nWhen you hit a problem with the application, you can send us a message with the application logs, so we can try to understand and fix the problem.\n\n\nOpen help panel, then click on \nSend us a message\n in \nOfficial support\n.\n\n\n\n\nDon\u2019t forget to describe your problem by adding as many details as you can.", 
            "title": "Synchronize your computer"
        }, 
        {
            "location": "/sync/desktop/#sync-your-desktop-computer-with-your-server", 
            "text": "Cozy Drive for desktop allows you to synchronize your files and folders between your Cozy and your desktop. Thus, you can work on your files offline. Your modifications will be synchronized as soon as network will be available.", 
            "title": "Sync your desktop computer with your server"
        }, 
        {
            "location": "/sync/desktop/#installation", 
            "text": "Before installing Cozy Drive, make sure your Cozy should be up-to-date.", 
            "title": "Installation"
        }, 
        {
            "location": "/sync/desktop/#windows", 
            "text": "You can download Cozy Drive for Windows on  this page .  List of known to work versions", 
            "title": "Windows"
        }, 
        {
            "location": "/sync/desktop/#macos", 
            "text": "You can download Cozy Drive for macOS on  this page .  List of known to work versions", 
            "title": "MacOS"
        }, 
        {
            "location": "/sync/desktop/#linux", 
            "text": "Learn how to download and use the GNU/linux client on  this page .", 
            "title": "Linux"
        }, 
        {
            "location": "/sync/desktop/#configuration", 
            "text": "At the end of the installation, application will start and ask you for a few informations:   Your Cozy URL. In other words, the address used to access to your Cozy.  Your Cozy password. We don\u2019t save your password, we only use it to create a new device login which it uses to synchronize your files.  The folder where you want to synchronize your files.    Once done, you will be redirected to the dashboard. First synchronization can now start.  The dashboard is composed of :   An information panel about synchronizations and available disk space on your Cozy.  A settings panel to configure autostart.  An account panel with information on your Cozy and possibility to unlink your Cozy.  A help panel in case of problem", 
            "title": "Configuration"
        }, 
        {
            "location": "/sync/desktop/#troubleshooting", 
            "text": "When you hit a problem with the application, you can send us a message with the application logs, so we can try to understand and fix the problem.  Open help panel, then click on  Send us a message  in  Official support .   Don\u2019t forget to describe your problem by adding as many details as you can.", 
            "title": "Troubleshooting"
        }, 
        {
            "location": "/sync/linux/", 
            "text": "Install the desktop client on your GNU/Linux system\n\n\nTo ease the use of Cozy Drive on any distribution, we distribute the application using the \nAppImage\n format. This way, you have nothing to install, just download the application and run it.\n\n\nWe provide packages for both \n32 bits\n and \n64 bits\n systems. All you have to do is download the file, move it to some dedicated folder, make it executable and run it.\n\n\nList of known to work distributions\n\n\nDetailed instructions on Gnome\n\n\nClick on one of these links to download Cozy Drive for your OS:\n\n\n\n\nCozy Drive for GNU/Linux 32 bits\n;\n\n\nCozy Drive for GNU/Linux 64 bits\n;\n\n\n\n\nOnce the binary file downloaded, go to the folder where your browser has stored it. For example, if you use Firefox, click on the folder icon in the download list.\n\n\n\n\nTo be able to run the application, you have to edit its properties to make it executable. Just right click on the application and select \nProperties\n inside the context menu:\n\n\n\nThen go to the \nPermissions\n tab and check the box to make the application executable:\n\n\n\nThere\u2019s no need to install the application, you can just run it from the folder you have downloaded it, but we recommend to move it to a dedicated folder to be able to find it easily. You can create an \nApplications\n folder inside your home directory and move the application there:\n\n\n\n\n\n\n\n\nTip: you can add this folder to your bookmarks to find it easily:\n\n\n\n\nFrom 3.26 onwards, GNOME removed the systray (that little bar with some icons) which is the interface for \nCozy Drive\n. You will need to install an extension such as \nTopIcons\n in order to see the cozy-desktop application and launch it.\n\n\nThat\u2019s all. You can now double-click on the application to launch it and connect it to your server. Have fun!\n\n\nMore\n\n\nMore in deep insights on the GNU/Linux client\n.\n\n\nIf your distribution is not supported, you can try the \nmanual build guide\n.", 
            "title": "Install on GNU/Linux"
        }, 
        {
            "location": "/sync/linux/#install-the-desktop-client-on-your-gnulinux-system", 
            "text": "To ease the use of Cozy Drive on any distribution, we distribute the application using the  AppImage  format. This way, you have nothing to install, just download the application and run it.  We provide packages for both  32 bits  and  64 bits  systems. All you have to do is download the file, move it to some dedicated folder, make it executable and run it.  List of known to work distributions", 
            "title": "Install the desktop client on your GNU/Linux system"
        }, 
        {
            "location": "/sync/linux/#detailed-instructions-on-gnome", 
            "text": "Click on one of these links to download Cozy Drive for your OS:   Cozy Drive for GNU/Linux 32 bits ;  Cozy Drive for GNU/Linux 64 bits ;   Once the binary file downloaded, go to the folder where your browser has stored it. For example, if you use Firefox, click on the folder icon in the download list.   To be able to run the application, you have to edit its properties to make it executable. Just right click on the application and select  Properties  inside the context menu:  Then go to the  Permissions  tab and check the box to make the application executable:  There\u2019s no need to install the application, you can just run it from the folder you have downloaded it, but we recommend to move it to a dedicated folder to be able to find it easily. You can create an  Applications  folder inside your home directory and move the application there:     Tip: you can add this folder to your bookmarks to find it easily:   From 3.26 onwards, GNOME removed the systray (that little bar with some icons) which is the interface for  Cozy Drive . You will need to install an extension such as  TopIcons  in order to see the cozy-desktop application and launch it.  That\u2019s all. You can now double-click on the application to launch it and connect it to your server. Have fun!", 
            "title": "Detailed instructions on Gnome"
        }, 
        {
            "location": "/sync/linux/#more", 
            "text": "More in deep insights on the GNU/Linux client .  If your distribution is not supported, you can try the  manual build guide .", 
            "title": "More"
        }, 
        {
            "location": "/download/", 
            "text": "Download Cozy Drive for all your devices\n\n\nCozy Drive on your phone\n\n\n\n\n Cozy Drive for iOS\n\n\nRequires iOS 10\n\n\n\n\n\n\n\n\n Cozy Drive for Android\n\n\nRequires Android 5.0.0\n\n\n\n\n(Advanced users that don\u2019t want to connect to Google Play can \nuse the APK\n)\n\n\n\n\nCozy Drive on your computer\n\n\n\n\n Cozy Drive for Mac OS\n\n\n\n\nDownload for MacOS\n\n\n\n\nActively tested on MacOS 10.12.x Sierra and higher, \nshould work on older versions\n\n\n\n\n\n\n Cozy Drive for Windows\n\n\n\n\nDownload for Microsoft Windows\n\n\n\n\nActively tested on Windows 10, \nshould work on older versions\n\n\n\n\n\n\nCozy Drive for GNU/Linux\n\n\nFull documentation\n on how to install Cozy Drive for GNU/Linux.\n\n\nList of known to work distributions", 
            "title": "Download"
        }, 
        {
            "location": "/download/#download-cozy-drive-for-all-your-devices", 
            "text": "", 
            "title": "Download Cozy Drive for all your devices"
        }, 
        {
            "location": "/download/#cozy-drive-on-your-phone", 
            "text": "", 
            "title": "Cozy Drive on your phone"
        }, 
        {
            "location": "/download/#cozy-drive-for-ios", 
            "text": "Requires iOS 10", 
            "title": "Cozy Drive for iOS"
        }, 
        {
            "location": "/download/#cozy-drive-for-android", 
            "text": "Requires Android 5.0.0   (Advanced users that don\u2019t want to connect to Google Play can  use the APK )", 
            "title": "Cozy Drive for Android"
        }, 
        {
            "location": "/download/#cozy-drive-on-your-computer", 
            "text": "", 
            "title": "Cozy Drive on your computer"
        }, 
        {
            "location": "/download/#cozy-drive-for-mac-os", 
            "text": "Download for MacOS   Actively tested on MacOS 10.12.x Sierra and higher,  should work on older versions", 
            "title": "Cozy Drive for Mac OS"
        }, 
        {
            "location": "/download/#cozy-drive-for-windows", 
            "text": "Download for Microsoft Windows   Actively tested on Windows 10,  should work on older versions", 
            "title": "Cozy Drive for Windows"
        }, 
        {
            "location": "/download/#cozy-drive-for-gnulinux", 
            "text": "Full documentation  on how to install Cozy Drive for GNU/Linux.  List of known to work distributions", 
            "title": "Cozy Drive for GNU/Linux"
        }, 
        {
            "location": "/install/", 
            "text": "Install Cozy on your own server\n\n\nLearn how to install Cozy \non Debian Stretch, Ubuntu Xenial or Raspbian Stretch\n;", 
            "title": "Install Cozy on your own server"
        }, 
        {
            "location": "/install/#install-cozy-on-your-own-server", 
            "text": "Learn how to install Cozy  on Debian Stretch, Ubuntu Xenial or Raspbian Stretch ;", 
            "title": "Install Cozy on your own server"
        }, 
        {
            "location": "/install/debian/", 
            "text": "Install Cozy on a Debian server\n\n\nA Debian repository serves packages to setup a Cozy self-hosted environment.\n\n\nIt provides:\n\n\n\n\ncozy-couchdb\n: \nCouchDB\n database engine used by cozy\n\n\ncozy-nsjail\n: \nNSJail\n isolation tool used by konnectors\n\n\ncozy-stack\n: \nCozy core\n\n\ncozy-coclyco\n: \nCLI\n to manage vhosts and certificates\n\n\ncozy\n: metapackage installing everything to setup a self-hosted environment\n\n\n\n\nThis repository currently supports:\n\n\n\n\nDebian Stretch\n (9.x): amd64\n\n\nUbuntu Xenial\n (16.04 LTS): amd64\n\n\nRaspbian Stretch\n (9.x): armhf\n\n\n\n\nAvailable channels are:\n\n\n\n\nstable\n: official and supported releases\n\n\ntesting\n: future official releases, for testing purposes. Updated \u00b1 twice a month.\n\n\nunstable\n: nightly builds, to be use with caution\n\n\n\n\ncozy-couchdb\n and \ncozy-nsjail\n are temporary packages. They will be removed when official \ncouchdb\n and \nnsjail\n will be available\n\n\nYou can choose to install \ncozy-couchdb\n on the same host as \ncozy-stack\n, or use a remote CouchDB server. Cozy only needs a 2.x CouchDB (1.x not supported).\n\n\nLike CouchDB, you can choose to install your reverse proxy on the same host, or use a remote one. Right now \ncozy-coclyco\n supports only local \nnginx\n. If you want to use \napache2\n or remote reverse proxy, you need to manually configure it for vhost or TLS certificate issuances.\n\n\nPrerequisites\n\n\nThird party repositories\n\n\nLet\ns Encrypt\n official packages require to use unofficial/third party repositories to have recent and supported version of ACME libraries.\nPackages provided by standard Debian or Ubuntu repositories are quite old and not compatible with \ncozy-coclyco\n.  \n\n\n\n\nFor Debian/Raspbian, you need to \nenable \nbackports\n repository\n.  \n\n\nFor Ubuntu, you need to \nactivate a third party \nppa\n repository\n.\n\n\n\n\nRefer to the \ncertbot\n documentation to activate needed repositories.\n(You don\nt need to install packages like \ncertbot\n or \npython-certbot-xxx\n, only to activate repositories.)\n\n\nYou may change your \nAPT preferences\n to allow APT to install from backports/ppa by default instead of from official repositories. For example:\n\n\n/etc/apt/preferences.d/cozy \nPackage: python3-acme\nPin: release n=stretch-backports\nPin-Priority: 510\nEOF\n\n\n\n\nCozy repositories\n\n\nFirst, install the packages required to install cozy\n\n\napt install ca-certificates apt-transport-https curl\n\n\n\n\nThen, fetch the GPG Cozy signing key:\n\n\ncurl https://apt.cozy.io/cozy.gpg | \\\n    apt-key --keyring /etc/apt/trusted.gpg.d/cozy.gpg add -\ncurl https://apt.cozy.io/nightly/cozy.gpg | \\\n    apt-key --keyring /etc/apt/trusted.gpg.d/cozy.gpg add -\n\n\n\n\nFinally, setup your repository. Select the channel that best fit your needs:\n\n\n\n\nFor now, we recommend to use \ntesting\n repositories, or \nnightly/unstable\n channels.\n\n\nstable\n packages are quite old and currently provide deprecated and unsecured CouchDB version (2.0.x).\n\nAdapt your \nsources.list\n accordingly.\n\n\n\n\nSupported repositories are:\n\n\n\n\nDebian Stretch (9.x)\n\n\ndeb https://apt.cozy.io/debian/ stretch stable\n\n\ndeb https://apt.cozy.io/debian/ stretch testing\n\n\ndeb https://apt.cozy.io/nightly/debian/ stretch unstable\n\n\n\n\n\n\nUbuntu Xenial (16.04 LTS)\n\n\ndeb https://apt.cozy.io/ubuntu/ xenial stable\n\n\ndeb https://apt.cozy.io/ubuntu/ xenial testing\n\n\ndeb https://apt.cozy.io/nightly/ubuntu/ xenial unstable\n\n\n\n\n\n\nRaspbian Stretch (9.x)\n\n\ndeb https://apt.cozy.io/raspbian/ stretch stable\n\n\ndeb https://apt.cozy.io/raspbian/ stretch testing\n\n\ndeb https://apt.cozy.io/nightly/raspbian/ stretch unstable\n\n\n\n\n\n\n\n\necho \ndeb https://apt.cozy.io/debian/ stretch testing\n \n /etc/apt/sources.list.d/cozy.list\napt update\n\n\n\n\nIf you want to use unstable/nightly builds, you have to accept another key (weaker and passwordless on our side because of unattended automated builds)\n\n\ncurl https://apt.cozy.io/nightly/cozy.gpg | \\\n    apt-key --keyring /etc/apt/trusted.gpg.d/cozy.gpg add -\n\n\n\n\nSetup\n\n\nFor the rest of this document, we assume you install components one by one to allow intermediate verification\n\n\nFor a full local environment (\ncouchdb\n + \nnginx\n + \ncozy\n), just install the \ncozy\n package which can install all needed packages in one shot.\n\n\nCouchDB\n\n\napt install cozy-couchdb\n\n\n\n\nInstall CouchDB in \nstandalone\n mode\n\n\nConfigure CouchDB to listen on \n127.0.0.1\n\n\nPick an administrator password\n\n(This password is used by shell scripts, so currently avoid to use one with simple or double quotes or others shell meaningfull symbols. We advice you to choose one with only alphanumeric digits to avoid troubles.)\n\n\nAt this point, you must have a working CouchDB instance\n\n\ncurl http://localhost:5984/       \n{\ncouchdb\n:\nWelcome\n,\nversion\n:\n2.1.0\n,\nfeatures\n:[\nscheduler\n],\nvendor\n:{\nname\n:\nThe Apache Software Foundation\n}}\n\n\n\n\nIf you want to use unstable/nightly builds, you might get another version of the database.\n\n\nCozy stack\n\n\napt install cozy-stack\n\n\n\n\nCozy need to create a CouchDB administrator and so to connect as admin to the CouchDB. Fill those mandatory parameters to allow this creation:\n\n\n\n\nAddress: by default, it\ns \nlocalhost:5984\n\n\nNode name: by default, it\ns \ncouchdb@localhost\n\n\nAdmin user: by default, it\ns \nadmin\n\n\nAdmin password: put the one you choose during CouchDB setup\n\n\nCozy user: by default, it\ns \ncozy\n\n\nCozy password: pick a password\n\n\n\n\n(Those passwords are used by shell scripts, so currently avoid to use ones with simple or double quotes or others shell meaningfull symbols. We advice you to choose ones with only alphanumeric digits to avoid troubles.)\n\n\nFor stack management (create instances, install applications\n), \nCozy need an administrator password\n. So pick a new one.\n\nWhen invoking \ncozy-stack\n (or \ncozy-coclyco\n which use it under the hood), you need to set the \nCOZY_ADMIN_PASSWORD\n environment variable with this password. You can put it on your \n.bashrc\n for simplier life if you want. If you don\nt, cozy-stack will simply ask for it.\n\n\nAt this point, you must have a working Cozy stack, depending on the branch you\nve chosen you can get a different version displayed.\n\n\ncurl http://localhost:8080/version\n{\nbuild_mode\n:\nproduction\n,\nbuild_time\n:\n2017-09-28T10:26:03Z\n,\nruntime_version\n:\ngo1.8.1\n,\nversion\n:\n0.1.0\n}#\n\n\n\n\nIf you want to use konnectors, you need to initialize the NodeJS chroot\n\n\n(Currently this script only works for Debian and will be adapted for Ubuntu and Raspbian soon)\n\n\n/usr/share/cozy/konnector-create-chroot.sh\n\n\n\n\nIf you use a self-signed certificate or a not official certificate authority, you need to deploy the corresponding root certificate in \n/usr/share/cozy/chroot/etc/ssl/certs/custom.crt\n.\n\nFor example, if you use \nLet\ns Encrypt staging environment\n for testing purpose\u00a0:\n\n\nwget -q https://letsencrypt.org/certs/fakelerootx1.pem \\\n    -O /usr/share/cozy/chroot/etc/ssl/certs/custom.crt\n\n\n\n\nFinally\n\n\napt install cozy\n\n\n\n\nCozy instance setup\n\n\nDNS\n\n\nCozy relies on sub-domains for each applications you installed on your instance.\nFor an instance \ncozy.example.org\n, \napp\n.cozy.example.org\n must be available too. Currently, you need at least:\n\n\n\n\nonboarding.cozy.example.org\n\n\nsettings.cozy.example.org\n\n\ndrive.cozy.example.org\n\n\nphotos.cozy.example.org\n\n\ncollect.cozy.example.org\n\n\nstore.cozy.example.org\n\n\napp\n.cozy.example.org\n for each application you use\n\n\n\n\nFollow your usual way to create those entries on your domain zone.\nThe simpliest way to handle this is to use a wildcard entry if supported by your domain hosting.\n\n\ncozy 1h IN A x.x.x.x\n*.cozy 1h IN CNAME cozy\n\n\n\n\nACME (Let\ns Encrypt)\n\n\nLike DNS, each application will use a different sub-domain and so request a certificate which include all needed domains.\n\n\ncozy-coclyco\n use Let\ns Encrypt and it ACME protocol to prove your ownership over the domain you try to issue a certificate.\nThis protocol requires your reverse proxy to be able to serve \nhttp://\napp\n.cozy.example.org/.well-known/acme-challenge/\n requests correctly.\n\n\nThe simplest way to achieve this is to configure your reverse proxy with a generic rule to forward any \n/.well-known/acme-challenge/\n request to the corresponding \n/etc\n/ssl/private/acme-challenge/\n folder.\nFor \nnginx\n, this can be done with\n\n\n/etc/nginx/sites-available/default\nserver {\n    listen 80 default_server;\n    listen [::]:80 default_server;\n\n    root /var/www/html;\n    server_name _;\n\n    location /.well-known/acme-challenge/ {\n        alias /etc/ssl/private/acme-challenge/;\n    }\n\n    location / {\n        return 301 https://$host$request_uri;\n    }\n}\n\napt install ssl-cert\nadduser www-data ssl-cert\nsystemctl restart nginx\n\n\n\n\nCreate instances\n\n\nOnce you\nve got a stack, your DNS\u00a0and your reverse proxy correctly configured, you can create instances on your Cozy stack.\nRemember to set the \nCOZY_ADMIN_PASSWORD\n environment variable.\n\n\nexport COZY_ADMIN_PASSWORD=\nyour-admin-password\n\ncozy-coclyco create cozy.example.org me@example.org\n\n\n\n\nFor complete reference of Coclyco, refer to the documentation of \ncozy-coclyco\n.", 
            "title": "Debian"
        }, 
        {
            "location": "/install/debian/#install-cozy-on-a-debian-server", 
            "text": "A Debian repository serves packages to setup a Cozy self-hosted environment.  It provides:   cozy-couchdb :  CouchDB  database engine used by cozy  cozy-nsjail :  NSJail  isolation tool used by konnectors  cozy-stack :  Cozy core  cozy-coclyco :  CLI  to manage vhosts and certificates  cozy : metapackage installing everything to setup a self-hosted environment   This repository currently supports:   Debian Stretch  (9.x): amd64  Ubuntu Xenial  (16.04 LTS): amd64  Raspbian Stretch  (9.x): armhf   Available channels are:   stable : official and supported releases  testing : future official releases, for testing purposes. Updated \u00b1 twice a month.  unstable : nightly builds, to be use with caution   cozy-couchdb  and  cozy-nsjail  are temporary packages. They will be removed when official  couchdb  and  nsjail  will be available  You can choose to install  cozy-couchdb  on the same host as  cozy-stack , or use a remote CouchDB server. Cozy only needs a 2.x CouchDB (1.x not supported).  Like CouchDB, you can choose to install your reverse proxy on the same host, or use a remote one. Right now  cozy-coclyco  supports only local  nginx . If you want to use  apache2  or remote reverse proxy, you need to manually configure it for vhost or TLS certificate issuances.", 
            "title": "Install Cozy on a Debian server"
        }, 
        {
            "location": "/install/debian/#prerequisites", 
            "text": "", 
            "title": "Prerequisites"
        }, 
        {
            "location": "/install/debian/#third-party-repositories", 
            "text": "Let s Encrypt  official packages require to use unofficial/third party repositories to have recent and supported version of ACME libraries.\nPackages provided by standard Debian or Ubuntu repositories are quite old and not compatible with  cozy-coclyco .     For Debian/Raspbian, you need to  enable  backports  repository .    For Ubuntu, you need to  activate a third party  ppa  repository .   Refer to the  certbot  documentation to activate needed repositories.\n(You don t need to install packages like  certbot  or  python-certbot-xxx , only to activate repositories.)  You may change your  APT preferences  to allow APT to install from backports/ppa by default instead of from official repositories. For example:  /etc/apt/preferences.d/cozy \nPackage: python3-acme\nPin: release n=stretch-backports\nPin-Priority: 510\nEOF", 
            "title": "Third party repositories"
        }, 
        {
            "location": "/install/debian/#cozy-repositories", 
            "text": "First, install the packages required to install cozy  apt install ca-certificates apt-transport-https curl  Then, fetch the GPG Cozy signing key:  curl https://apt.cozy.io/cozy.gpg | \\\n    apt-key --keyring /etc/apt/trusted.gpg.d/cozy.gpg add -\ncurl https://apt.cozy.io/nightly/cozy.gpg | \\\n    apt-key --keyring /etc/apt/trusted.gpg.d/cozy.gpg add -  Finally, setup your repository. Select the channel that best fit your needs:   For now, we recommend to use  testing  repositories, or  nightly/unstable  channels.  stable  packages are quite old and currently provide deprecated and unsecured CouchDB version (2.0.x). \nAdapt your  sources.list  accordingly.   Supported repositories are:   Debian Stretch (9.x)  deb https://apt.cozy.io/debian/ stretch stable  deb https://apt.cozy.io/debian/ stretch testing  deb https://apt.cozy.io/nightly/debian/ stretch unstable    Ubuntu Xenial (16.04 LTS)  deb https://apt.cozy.io/ubuntu/ xenial stable  deb https://apt.cozy.io/ubuntu/ xenial testing  deb https://apt.cozy.io/nightly/ubuntu/ xenial unstable    Raspbian Stretch (9.x)  deb https://apt.cozy.io/raspbian/ stretch stable  deb https://apt.cozy.io/raspbian/ stretch testing  deb https://apt.cozy.io/nightly/raspbian/ stretch unstable     echo  deb https://apt.cozy.io/debian/ stretch testing    /etc/apt/sources.list.d/cozy.list\napt update  If you want to use unstable/nightly builds, you have to accept another key (weaker and passwordless on our side because of unattended automated builds)  curl https://apt.cozy.io/nightly/cozy.gpg | \\\n    apt-key --keyring /etc/apt/trusted.gpg.d/cozy.gpg add -", 
            "title": "Cozy repositories"
        }, 
        {
            "location": "/install/debian/#setup", 
            "text": "For the rest of this document, we assume you install components one by one to allow intermediate verification  For a full local environment ( couchdb  +  nginx  +  cozy ), just install the  cozy  package which can install all needed packages in one shot.", 
            "title": "Setup"
        }, 
        {
            "location": "/install/debian/#couchdb", 
            "text": "apt install cozy-couchdb  Install CouchDB in  standalone  mode  Configure CouchDB to listen on  127.0.0.1  Pick an administrator password \n(This password is used by shell scripts, so currently avoid to use one with simple or double quotes or others shell meaningfull symbols. We advice you to choose one with only alphanumeric digits to avoid troubles.)  At this point, you must have a working CouchDB instance  curl http://localhost:5984/       \n{ couchdb : Welcome , version : 2.1.0 , features :[ scheduler ], vendor :{ name : The Apache Software Foundation }}  If you want to use unstable/nightly builds, you might get another version of the database.", 
            "title": "CouchDB"
        }, 
        {
            "location": "/install/debian/#cozy-stack", 
            "text": "apt install cozy-stack  Cozy need to create a CouchDB administrator and so to connect as admin to the CouchDB. Fill those mandatory parameters to allow this creation:   Address: by default, it s  localhost:5984  Node name: by default, it s  couchdb@localhost  Admin user: by default, it s  admin  Admin password: put the one you choose during CouchDB setup  Cozy user: by default, it s  cozy  Cozy password: pick a password   (Those passwords are used by shell scripts, so currently avoid to use ones with simple or double quotes or others shell meaningfull symbols. We advice you to choose ones with only alphanumeric digits to avoid troubles.)  For stack management (create instances, install applications ),  Cozy need an administrator password . So pick a new one. \nWhen invoking  cozy-stack  (or  cozy-coclyco  which use it under the hood), you need to set the  COZY_ADMIN_PASSWORD  environment variable with this password. You can put it on your  .bashrc  for simplier life if you want. If you don t, cozy-stack will simply ask for it.  At this point, you must have a working Cozy stack, depending on the branch you ve chosen you can get a different version displayed.  curl http://localhost:8080/version\n{ build_mode : production , build_time : 2017-09-28T10:26:03Z , runtime_version : go1.8.1 , version : 0.1.0 }#  If you want to use konnectors, you need to initialize the NodeJS chroot  (Currently this script only works for Debian and will be adapted for Ubuntu and Raspbian soon)  /usr/share/cozy/konnector-create-chroot.sh  If you use a self-signed certificate or a not official certificate authority, you need to deploy the corresponding root certificate in  /usr/share/cozy/chroot/etc/ssl/certs/custom.crt . \nFor example, if you use  Let s Encrypt staging environment  for testing purpose\u00a0:  wget -q https://letsencrypt.org/certs/fakelerootx1.pem \\\n    -O /usr/share/cozy/chroot/etc/ssl/certs/custom.crt", 
            "title": "Cozy stack"
        }, 
        {
            "location": "/install/debian/#finally", 
            "text": "apt install cozy", 
            "title": "Finally"
        }, 
        {
            "location": "/install/debian/#cozy-instance-setup", 
            "text": "", 
            "title": "Cozy instance setup"
        }, 
        {
            "location": "/install/debian/#dns", 
            "text": "Cozy relies on sub-domains for each applications you installed on your instance.\nFor an instance  cozy.example.org ,  app .cozy.example.org  must be available too. Currently, you need at least:   onboarding.cozy.example.org  settings.cozy.example.org  drive.cozy.example.org  photos.cozy.example.org  collect.cozy.example.org  store.cozy.example.org  app .cozy.example.org  for each application you use   Follow your usual way to create those entries on your domain zone.\nThe simpliest way to handle this is to use a wildcard entry if supported by your domain hosting.  cozy 1h IN A x.x.x.x\n*.cozy 1h IN CNAME cozy", 
            "title": "DNS"
        }, 
        {
            "location": "/install/debian/#acme-lets-encrypt", 
            "text": "Like DNS, each application will use a different sub-domain and so request a certificate which include all needed domains.  cozy-coclyco  use Let s Encrypt and it ACME protocol to prove your ownership over the domain you try to issue a certificate.\nThis protocol requires your reverse proxy to be able to serve  http:// app .cozy.example.org/.well-known/acme-challenge/  requests correctly.  The simplest way to achieve this is to configure your reverse proxy with a generic rule to forward any  /.well-known/acme-challenge/  request to the corresponding  /etc\n/ssl/private/acme-challenge/  folder.\nFor  nginx , this can be done with  /etc/nginx/sites-available/default\nserver {\n    listen 80 default_server;\n    listen [::]:80 default_server;\n\n    root /var/www/html;\n    server_name _;\n\n    location /.well-known/acme-challenge/ {\n        alias /etc/ssl/private/acme-challenge/;\n    }\n\n    location / {\n        return 301 https://$host$request_uri;\n    }\n}\n\napt install ssl-cert\nadduser www-data ssl-cert\nsystemctl restart nginx", 
            "title": "ACME (Let's Encrypt)"
        }, 
        {
            "location": "/install/debian/#create-instances", 
            "text": "Once you ve got a stack, your DNS\u00a0and your reverse proxy correctly configured, you can create instances on your Cozy stack.\nRemember to set the  COZY_ADMIN_PASSWORD  environment variable.  export COZY_ADMIN_PASSWORD= your-admin-password \ncozy-coclyco create cozy.example.org me@example.org  For complete reference of Coclyco, refer to the documentation of  cozy-coclyco .", 
            "title": "Create instances"
        }, 
        {
            "location": "/install/manual/", 
            "text": "How to install Cozy on Debian Stable\n\n\n\n\n\u26a0\ufe0f This is a work in progress. For now, there\u2019s no easy and officially supported way to install Cozy. You have to install it and all this dependencies by hand. This tutorial is intended for tech savvy people wanting to give Cozy a first try without waiting for the official documentation and images.\n\n\n\n\n\n\nFor now, this documentation don\u2019t explain how to install the technology stack required for connector, as the technology we use may evolve. So you won\u2019t be able to run the connectors.\n\n\n\n\n\n\nMost of the following commands require root privileges. You can either open a root shell or use \nsudo\n when needed;\n\n\n\n\nPre-requisites\n\n\nCozy requires a CouchDB 2 database server, a reverse proxy and an SMTP server. We\u2019ll use Nginx in this tutorial but feel free to use your reverse proxy of choice.\n\n\nYou\nll also need a domain name and know how to associate all of its subdomains to the IP address of your server.\n\n\nInstall dependencies\n\n\nOn a fresh new Debian Stretch, here are the packages that may be useful to install and manage your server:\n\n\napt-get update \n apt-get --no-install-recommends -y install \\\n            ca-certificates \\\n            curl \\\n            net-tools \\\n            nginx \\\n            sudo \\\n            vim-tiny \\\n            build-essential \\\n            pkg-config \\\n            erlang \\\n            libicu-dev \\\n            libmozjs185-dev \\\n            libcurl4-openssl-dev\n\n\n\n\nInstall CouchDB\n\n\nDownload \nthe source code on CouchDB 2\n and \ninstall it\n.\n\n\ncd /tmp\ncurl -LO https://dist.apache.org/repos/dist/release/couchdb/source/2.1.1/apache-couchdb-2.1.1.tar.gz\ntar xf apache-couchdb-2.1.1.tar.gz\ncd apache-couchdb-2.1.1\n./configure\nmake release\nadduser --system \\\n        --no-create-home \\\n        --shell /bin/bash \\\n        --group --gecos \\\n        \nCouchDB Administrator\n couchdb\n\n\n\n\nWe\u2019ll install CouchDB inside \n/home/couchdb\n:\n\n\ncp -R rel/couchdb /home/couchdb\nchown -R couchdb:couchdb /home/couchdb\nfind /home/couchdb -type d -exec chmod 0770 {} \\;\nchmod -R 0644 /home/couchdb/etc/*\nmkdir /var/log/couchdb \n chown couchdb: /var/log/couchdb\n\n\n\n\nFor now, we\u2019ll just run the database as a background job, but it is highly recommended to use some supervisor software.\n\n\nsudo -b -i -u couchdb sh -c '/home/couchdb/bin/couchdb \n /var/log/couchdb/couch.log 2\n /var/log/couchdb/couch-err.log'\n\n\n\n\nAlternatively, you can setup a service script, and use systemd to run couchdb as a service :\n\n\ncat \nEOT \n /etc/systemd/system/couchdb.service\n[Unit]\nDescription=Couchdb service\nAfter=network.target\n\n[Service]\nType=simple\nUser=couchdb\nExecStart=/home/couchdb/bin/couchdb -o /dev/stdout -e /dev/stderr\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\nEOT\n\n\n\n\nThen to start and enable (start at boot) the service :\n\n\nsystemctl  daemon-reload\nsystemctl  start couchdb.service\nsystemctl  enable couchdb.service\n\n\n\n\nLast but not least, let\u2019s create the default databases:\n\n\ncurl -X PUT http://127.0.0.1:5984/_users\ncurl -X PUT http://127.0.0.1:5984/_replicator\ncurl -X PUT http://127.0.0.1:5984/_global_changes\n\n\n\n\n\n\n\u26a0\ufe0f The default CouchDB installation has no admin user. Everybody can query the server. So, in production environment, make sure to create en admin user and update the CouchDB connexion URL inside the configuration file of Cozy.\n\n\n\n\nInstall the Cozy Stack\n\n\nThe Cozy server is just a single binary. You can fetch one of its releases from Github:\n\n\ncurl -o /usr/local/bin/cozy-stack \\\n     -L https://github.com/cozy/cozy-stack/releases/download/2017M2-alpha/cozy-stack-linux-amd64-2017M2-alpha\nchmod +x /usr/local/bin/cozy-stack\nadduser --system \\\n        --no-create-home \\\n        --shell /bin/bash \\\n        --group --gecos \\\n          \nCozy\n cozy\nmkdir /var/log/cozy\nchown cozy: /var/log/cozy\nmkdir /var/lib/cozy\nchown -R cozy: /var/lib/cozy\n\n\n\n\nYou can configure your server using a JSON or YAML file. Let\u2019s fetch the sample configuration file:\n\n\nmkdir /etc/cozy\ncurl -o /etc/cozy/cozy.yaml \\\n     https://raw.githubusercontent.com/cozy/cozy-stack/master/cozy.example.yaml\nchown -R cozy: /etc/cozy\n\n\n\n\nEdit this file to adapt it to your configuration. You should setup a directory to store the files. For example:\n\n\n  fs:\n    url: file://localhost/var/lib/cozy\n\n\n\n\nDon\u2019t forget to allow Cozy user to write inside this folder.\n\n\nCompile a recent stack\n\n\nThe released build may not contain the latest fixes. If you want an up to date version of the stack, you can compile it from the sources. This requires to install the Go compiler, fetch the sources and compile them:\n\n\napt-get --no-install-recommends -y install \\\n        ca-certificates \\\n        curl \\\n        net-tools \\\n        nginx \\\n        sudo \\\n        vim-tiny \\\n        build-essential \\\n        pkg-config \\\n        erlang \\\n        libicu-dev \\\n        libmozjs185-dev \\\n        libcurl4-openssl-dev \\\n        git\ncd /tmp\ncurl -LO https://storage.googleapis.com/golang/go1.8.3.linux-amd64.tar.gz\ntar -C /usr/local -xzf go1.8.3.linux-amd64.tar.gz\nPATH=$PATH:/usr/local/go/bin go get -u github.com/cozy/cozy-stack\ncp /root/go/bin/cozy-stack /usr/local/bin/cozy-stack\nchmod +x /usr/local/bin/cozy-stack\n\n\n\n\nConfiguration\n\n\nNGinx\n\n\nLet\u2019s assume you want to host a server on \nmycozy.tld\n with a self-signed certificate.\n\n\nGenerate the certificate. We need a wild-card certificate, as every application inside Cozy will have it\u2019s own sub-domain:\n\n\nsudo openssl req -x509 -nodes -newkey rsa:4096 \\\n    -keyout /etc/cozy/mycozy.tld.key \\\n    -out /etc/cozy/mycozy.tld.crt \\\n    -days 365 -subj \n/CN={*.mycozy.tld}\n\n\n\n\nThen create a virtual host for your server by creating a file at \n/etc/cozy/sites-available/mycozy.tld.conf\n with \nthe following configuration template\n.\nAnd enable it by creating a symbolic link:\n\n\nsudo ln -s \n/etc/nginx/sites-available/mycozy.tld.conf\n \\\n       /etc/nginx/sites-enabled/\n\n\n\n\nYou can check that your configuration is valid by running\n\n\nsudo nginx -t -c /etc/nginx/nginx.conf\n\n\n\n\nAnd start NGinx:\n\n\nsudo service nginx start\n\n\n\n\nOr, if you use systemd:\n\n\nsudo systemctl start nginx\nsudo systemctl enable nginx # enable the nginx service at startup, if need to\n\n\n\n\nCozy\n\n\nThe Cozy server requires a main password:\n\n\nsudo /usr/local/bin/cozy-stack config passwd /etc/cozy/\n\n\n\n\nThis password will be asked every time you use the \ncozy-stack\n command line. To prevent this, you can set the \nCOZY_ADMIN_PASSWORD\n environment variable.\n\n\nDNS\n\n\nMake sure to associate \n*.mycozy.tld\n with the IP address of your server.\n\n\nFor example, add the following records to your DNS (replacing \nmycozy.tld\n with your domain of choice):\n\n\nmycozy.tld   A     your IP\n*.mycozy.tld CNAME mycozy.tld\n\n\n\n\nRunning\n\n\nFor now, we\u2019ll just run the server as a background job, but it is highly recommended to use some supervisor software.\n\n\nFirst, start the server:\n\n\nsudo -b -u cozy sh -c '/usr/local/bin/cozy-stack serve \\\n     --log-level info \\\n     --host 0.0.0.0 \n /var/log/cozy/cozy.log 2\n /var/log/cozy/cozy-err.log'\n\n\n\n\nThen, create your instance and install the applications:\n\n\ncozy-stack instances add \\\n           --host 0.0.0.0 \\\n           --apps drive,photos,collect,settings \\\n           --passphrase \nXXX\n \\\n           mycozy.tld\n\n\n\n\n--passphrase \"XXX\"\n allows to set the initial password of the instance.\n\n\nYou can add other instances by just running this commands again.\n\n\n\n\nThe url of your cozy determines the name of your instance.\nIf you choose another public port than the default public port for SSL (443), say \n1443\n, then you should reflect this when creating your cozy instance with the ${instance_domain} as \nmycozy.tld:1443\n.\n\n\n\n\nSample configuration files\n\n\nNginx\n\n\nPut this file into \n/etc/nginx/sites-available\n and enable it by creating a symlink in \n/etc/nginx/sites-enabled\n.\n\n\nIn this template, you need to replace the following placeholders:\n\n\n\n\n%PORT% with the public port nginx will listen to (default should be 443)\n\n\n%SERVER_PORT% with the private port cozy will listen to (default should be 8080)\n\n\n%DOMAIN% with your domain of choice: \nmycozy.tld\n in this example\n\n\n\n\nserver {\n    listen %PORT%;\n\n    server_name *.%DOMAIN%;\n\n    ssl_certificate /etc/cozy/%DOMAIN%.crt;\n    ssl_certificate_key /etc/cozy/%DOMAIN%.key;\n    ssl_session_cache shared:SSL:10m;\n    ssl_session_timeout 10m;\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n    ssl_ciphers EECDH+AES;\n    ssl_prefer_server_ciphers on;\n    ssl on;\n\n    gzip_vary on;\n    client_max_body_size 1024M;\n\n    add_header Strict-Transport-Security max-age=31536000;\n\n    location / {\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header Host $http_host;\n        proxy_redirect http:// https://;\n        proxy_pass http://127.0.0.1:8080;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection \nupgrade\n;\n    }\n\n    access_log /var/log/nginx/cozy.log;\n}\n\n\n\n\nTODO\n\n\nCozy also requires a SMTP server (or relay).", 
            "title": "Manual installation"
        }, 
        {
            "location": "/install/manual/#how-to-install-cozy-on-debian-stable", 
            "text": "\u26a0\ufe0f This is a work in progress. For now, there\u2019s no easy and officially supported way to install Cozy. You have to install it and all this dependencies by hand. This tutorial is intended for tech savvy people wanting to give Cozy a first try without waiting for the official documentation and images.    For now, this documentation don\u2019t explain how to install the technology stack required for connector, as the technology we use may evolve. So you won\u2019t be able to run the connectors.    Most of the following commands require root privileges. You can either open a root shell or use  sudo  when needed;", 
            "title": "How to install Cozy on Debian Stable"
        }, 
        {
            "location": "/install/manual/#pre-requisites", 
            "text": "Cozy requires a CouchDB 2 database server, a reverse proxy and an SMTP server. We\u2019ll use Nginx in this tutorial but feel free to use your reverse proxy of choice.  You ll also need a domain name and know how to associate all of its subdomains to the IP address of your server.", 
            "title": "Pre-requisites"
        }, 
        {
            "location": "/install/manual/#install-dependencies", 
            "text": "On a fresh new Debian Stretch, here are the packages that may be useful to install and manage your server:  apt-get update   apt-get --no-install-recommends -y install \\\n            ca-certificates \\\n            curl \\\n            net-tools \\\n            nginx \\\n            sudo \\\n            vim-tiny \\\n            build-essential \\\n            pkg-config \\\n            erlang \\\n            libicu-dev \\\n            libmozjs185-dev \\\n            libcurl4-openssl-dev", 
            "title": "Install dependencies"
        }, 
        {
            "location": "/install/manual/#install-couchdb", 
            "text": "Download  the source code on CouchDB 2  and  install it .  cd /tmp\ncurl -LO https://dist.apache.org/repos/dist/release/couchdb/source/2.1.1/apache-couchdb-2.1.1.tar.gz\ntar xf apache-couchdb-2.1.1.tar.gz\ncd apache-couchdb-2.1.1\n./configure\nmake release\nadduser --system \\\n        --no-create-home \\\n        --shell /bin/bash \\\n        --group --gecos \\\n         CouchDB Administrator  couchdb  We\u2019ll install CouchDB inside  /home/couchdb :  cp -R rel/couchdb /home/couchdb\nchown -R couchdb:couchdb /home/couchdb\nfind /home/couchdb -type d -exec chmod 0770 {} \\;\nchmod -R 0644 /home/couchdb/etc/*\nmkdir /var/log/couchdb   chown couchdb: /var/log/couchdb  For now, we\u2019ll just run the database as a background job, but it is highly recommended to use some supervisor software.  sudo -b -i -u couchdb sh -c '/home/couchdb/bin/couchdb   /var/log/couchdb/couch.log 2  /var/log/couchdb/couch-err.log'  Alternatively, you can setup a service script, and use systemd to run couchdb as a service :  cat  EOT   /etc/systemd/system/couchdb.service\n[Unit]\nDescription=Couchdb service\nAfter=network.target\n\n[Service]\nType=simple\nUser=couchdb\nExecStart=/home/couchdb/bin/couchdb -o /dev/stdout -e /dev/stderr\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\nEOT  Then to start and enable (start at boot) the service :  systemctl  daemon-reload\nsystemctl  start couchdb.service\nsystemctl  enable couchdb.service  Last but not least, let\u2019s create the default databases:  curl -X PUT http://127.0.0.1:5984/_users\ncurl -X PUT http://127.0.0.1:5984/_replicator\ncurl -X PUT http://127.0.0.1:5984/_global_changes   \u26a0\ufe0f The default CouchDB installation has no admin user. Everybody can query the server. So, in production environment, make sure to create en admin user and update the CouchDB connexion URL inside the configuration file of Cozy.", 
            "title": "Install CouchDB"
        }, 
        {
            "location": "/install/manual/#install-the-cozy-stack", 
            "text": "The Cozy server is just a single binary. You can fetch one of its releases from Github:  curl -o /usr/local/bin/cozy-stack \\\n     -L https://github.com/cozy/cozy-stack/releases/download/2017M2-alpha/cozy-stack-linux-amd64-2017M2-alpha\nchmod +x /usr/local/bin/cozy-stack\nadduser --system \\\n        --no-create-home \\\n        --shell /bin/bash \\\n        --group --gecos \\\n           Cozy  cozy\nmkdir /var/log/cozy\nchown cozy: /var/log/cozy\nmkdir /var/lib/cozy\nchown -R cozy: /var/lib/cozy  You can configure your server using a JSON or YAML file. Let\u2019s fetch the sample configuration file:  mkdir /etc/cozy\ncurl -o /etc/cozy/cozy.yaml \\\n     https://raw.githubusercontent.com/cozy/cozy-stack/master/cozy.example.yaml\nchown -R cozy: /etc/cozy  Edit this file to adapt it to your configuration. You should setup a directory to store the files. For example:    fs:\n    url: file://localhost/var/lib/cozy  Don\u2019t forget to allow Cozy user to write inside this folder.", 
            "title": "Install the Cozy Stack"
        }, 
        {
            "location": "/install/manual/#compile-a-recent-stack", 
            "text": "The released build may not contain the latest fixes. If you want an up to date version of the stack, you can compile it from the sources. This requires to install the Go compiler, fetch the sources and compile them:  apt-get --no-install-recommends -y install \\\n        ca-certificates \\\n        curl \\\n        net-tools \\\n        nginx \\\n        sudo \\\n        vim-tiny \\\n        build-essential \\\n        pkg-config \\\n        erlang \\\n        libicu-dev \\\n        libmozjs185-dev \\\n        libcurl4-openssl-dev \\\n        git\ncd /tmp\ncurl -LO https://storage.googleapis.com/golang/go1.8.3.linux-amd64.tar.gz\ntar -C /usr/local -xzf go1.8.3.linux-amd64.tar.gz\nPATH=$PATH:/usr/local/go/bin go get -u github.com/cozy/cozy-stack\ncp /root/go/bin/cozy-stack /usr/local/bin/cozy-stack\nchmod +x /usr/local/bin/cozy-stack", 
            "title": "Compile a recent stack"
        }, 
        {
            "location": "/install/manual/#configuration", 
            "text": "", 
            "title": "Configuration"
        }, 
        {
            "location": "/install/manual/#nginx", 
            "text": "Let\u2019s assume you want to host a server on  mycozy.tld  with a self-signed certificate.  Generate the certificate. We need a wild-card certificate, as every application inside Cozy will have it\u2019s own sub-domain:  sudo openssl req -x509 -nodes -newkey rsa:4096 \\\n    -keyout /etc/cozy/mycozy.tld.key \\\n    -out /etc/cozy/mycozy.tld.crt \\\n    -days 365 -subj  /CN={*.mycozy.tld}  Then create a virtual host for your server by creating a file at  /etc/cozy/sites-available/mycozy.tld.conf  with  the following configuration template .\nAnd enable it by creating a symbolic link:  sudo ln -s  /etc/nginx/sites-available/mycozy.tld.conf  \\\n       /etc/nginx/sites-enabled/  You can check that your configuration is valid by running  sudo nginx -t -c /etc/nginx/nginx.conf  And start NGinx:  sudo service nginx start  Or, if you use systemd:  sudo systemctl start nginx\nsudo systemctl enable nginx # enable the nginx service at startup, if need to", 
            "title": "NGinx"
        }, 
        {
            "location": "/install/manual/#cozy", 
            "text": "The Cozy server requires a main password:  sudo /usr/local/bin/cozy-stack config passwd /etc/cozy/  This password will be asked every time you use the  cozy-stack  command line. To prevent this, you can set the  COZY_ADMIN_PASSWORD  environment variable.", 
            "title": "Cozy"
        }, 
        {
            "location": "/install/manual/#dns", 
            "text": "Make sure to associate  *.mycozy.tld  with the IP address of your server.  For example, add the following records to your DNS (replacing  mycozy.tld  with your domain of choice):  mycozy.tld   A     your IP\n*.mycozy.tld CNAME mycozy.tld", 
            "title": "DNS"
        }, 
        {
            "location": "/install/manual/#running", 
            "text": "For now, we\u2019ll just run the server as a background job, but it is highly recommended to use some supervisor software.  First, start the server:  sudo -b -u cozy sh -c '/usr/local/bin/cozy-stack serve \\\n     --log-level info \\\n     --host 0.0.0.0   /var/log/cozy/cozy.log 2  /var/log/cozy/cozy-err.log'  Then, create your instance and install the applications:  cozy-stack instances add \\\n           --host 0.0.0.0 \\\n           --apps drive,photos,collect,settings \\\n           --passphrase  XXX  \\\n           mycozy.tld  --passphrase \"XXX\"  allows to set the initial password of the instance.  You can add other instances by just running this commands again.   The url of your cozy determines the name of your instance.\nIf you choose another public port than the default public port for SSL (443), say  1443 , then you should reflect this when creating your cozy instance with the ${instance_domain} as  mycozy.tld:1443 .", 
            "title": "Running"
        }, 
        {
            "location": "/install/manual/#sample-configuration-files", 
            "text": "", 
            "title": "Sample configuration files"
        }, 
        {
            "location": "/install/manual/#nginx_1", 
            "text": "Put this file into  /etc/nginx/sites-available  and enable it by creating a symlink in  /etc/nginx/sites-enabled .  In this template, you need to replace the following placeholders:   %PORT% with the public port nginx will listen to (default should be 443)  %SERVER_PORT% with the private port cozy will listen to (default should be 8080)  %DOMAIN% with your domain of choice:  mycozy.tld  in this example   server {\n    listen %PORT%;\n\n    server_name *.%DOMAIN%;\n\n    ssl_certificate /etc/cozy/%DOMAIN%.crt;\n    ssl_certificate_key /etc/cozy/%DOMAIN%.key;\n    ssl_session_cache shared:SSL:10m;\n    ssl_session_timeout 10m;\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n    ssl_ciphers EECDH+AES;\n    ssl_prefer_server_ciphers on;\n    ssl on;\n\n    gzip_vary on;\n    client_max_body_size 1024M;\n\n    add_header Strict-Transport-Security max-age=31536000;\n\n    location / {\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header Host $http_host;\n        proxy_redirect http:// https://;\n        proxy_pass http://127.0.0.1:8080;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection  upgrade ;\n    }\n\n    access_log /var/log/nginx/cozy.log;\n}", 
            "title": "Nginx"
        }, 
        {
            "location": "/install/manual/#todo", 
            "text": "Cozy also requires a SMTP server (or relay).", 
            "title": "TODO"
        }, 
        {
            "location": "/dev/", 
            "text": "Let\ns hack some code\n\n\nTutorials\n\n\n\n\nintroduction to Cozy architecture\n\n\nhow to develop your first application\n\n\nhow to develop a connector\n\n\nhow to create a mobile application with cordova\n\n\nhow to send mail in development\n\n\n\n\nHow to\n\n\nComing soon!\n\n\nAPI References\n\n\nBrowse the full API reference inside our repositories:\n\n\nCozy Client JS Reference\n\n\n\n\ndocuments\n\n\nfiles\n\n\nauthentification\n\n\nauthentication with OAuth2\n\n\nsettings\n\n\ninter-app communication\n\n\njobs and triggers\n\n\nsharing\n\n\noffline\n\n\nCozy Bar\n\n\n\n\nCozy UI\n\n\n\n\nintroduction\n\n\nstyleguide\n\n\nreact components in storybook\n\n\n\n\nRaw Server API\n\n\n\n\n\n\nintroduction:\n\n\n\n\nAPI architecture\n\n\nconventions\n\n\nJSON-API\n\n\n\n\n\n\n\n\napplications\n: install, update, list applications\n\n\n\n\nmarketplace\n\n\npermissions\n\n\nnotifications\n\n\nsettings\n\n\nauth\n\n\ndocuments\n\n\nquery the database\n\n\nfiles\n\n\nlink files to documents\n\n\njobs\n\n\nworkers\n architecture\n and \nAPI\n\n\ninter-application communication\n\n\nsharing\n\n\nconnectors\n\n\nrealtime\n\n\n\n\nAvailable doctypes\n\n\nWe maintain an index of \nall the currently available doctypes\n. To make your own doctypes available to other applications, please send a pull request to this repository.", 
            "title": "Let's hack some code"
        }, 
        {
            "location": "/dev/#lets-hack-some-code", 
            "text": "", 
            "title": "Let's hack some code"
        }, 
        {
            "location": "/dev/#tutorials", 
            "text": "introduction to Cozy architecture  how to develop your first application  how to develop a connector  how to create a mobile application with cordova  how to send mail in development", 
            "title": "Tutorials"
        }, 
        {
            "location": "/dev/#how-to", 
            "text": "Coming soon!", 
            "title": "How to"
        }, 
        {
            "location": "/dev/#api-references", 
            "text": "Browse the full API reference inside our repositories:", 
            "title": "API References"
        }, 
        {
            "location": "/dev/#cozy-client-js-reference", 
            "text": "documents  files  authentification  authentication with OAuth2  settings  inter-app communication  jobs and triggers  sharing  offline  Cozy Bar", 
            "title": "Cozy Client JS Reference"
        }, 
        {
            "location": "/dev/#cozy-ui", 
            "text": "introduction  styleguide  react components in storybook", 
            "title": "Cozy UI"
        }, 
        {
            "location": "/dev/#raw-server-api", 
            "text": "introduction:   API architecture  conventions  JSON-API     applications : install, update, list applications   marketplace  permissions  notifications  settings  auth  documents  query the database  files  link files to documents  jobs  workers  architecture  and  API  inter-application communication  sharing  connectors  realtime", 
            "title": "Raw Server API"
        }, 
        {
            "location": "/dev/#available-doctypes", 
            "text": "We maintain an index of  all the currently available doctypes . To make your own doctypes available to other applications, please send a pull request to this repository.", 
            "title": "Available doctypes"
        }, 
        {
            "location": "/dev/connect-mobile-app-local-stack/", 
            "text": "How to connect a mobile app to your local stack\n\n\nSometimes we need to test a feature on a mobile app by connecting it to our locally installed stack. For this to work, we need to achieve some things.\n\n\nPrerequisite\n\n\n\n\nHave a local stack installed\n\n\nHave an Android emulator created\n\n\n\n\nStart the emulator with the ability to remount its file system as writable\n\n\nSince we will need to edit the hosts of the emulator, we need to be able to remount its file system as writable. For that, we need to start our emulator with the following command :\n\n\n./emulator -writable-system -avd Pixel_API_27\n\n\n\n\nThe \nemulator\n binary is located at \n/home/user/Android/Sdk/emulator/\n on Linux systems by default. \nPixel_API_27\n is the name of the emulator I want to start. If you don\nt know the name of your emulator, you can get it with :\n\n\n./emulator -list-avds\n\n\n\n\nRoot the emulator\n\n\nNow that the emulator is started, we need to gain root access on it. Run the following command :\n\n\nadb root\n\n\n\n\nThis restarts the adb daemon with root privileges.\n\n\nRemount the file sytem as writable\n\n\nBy default, the file system is read-only. We need it to be writable, so we run this command :\n\n\nadb remount\n\n\n\n\nPull the emulator\ns hosts file\n\n\nTo edit the \nhosts\n file, we need to pull it on our system :\n\n\nadb pull /etc/hosts hosts\n\n\n\n\nThis creates a \nhosts\n file in your current directory.\n\n\nEdit the hosts\n\n\nFor the emulator to be able to connect to our stack, we need to add the IP address of our machine to the hosts. Actually, we don\nt really need it since in an Android emulator \n10.0.2.2\n is automatically pointing to our machine. So we just need to add this to the \nhosts\n file :\n\n\n10.0.2.2 cozy.tools\n\n\n\n\nPush the new file to the emulator\n\n\nNow that we have added what\ns necessary in the file, we have to push it to the emulator :\n\n\nadb push hosts /system/etc/hosts\n\n\n\n\nThen try to ping \ncozy.tools\n to see if everything is working well :\n\n\nadb shell ping api.dev.local\n\n\n\n\nYou can now enter \nhttp://cozy.tools\n in the login page of your mobile app and you will not get an error anymore.", 
            "title": "Connect a mobile app to your local stack"
        }, 
        {
            "location": "/dev/connect-mobile-app-local-stack/#how-to-connect-a-mobile-app-to-your-local-stack", 
            "text": "Sometimes we need to test a feature on a mobile app by connecting it to our locally installed stack. For this to work, we need to achieve some things.", 
            "title": "How to connect a mobile app to your local stack"
        }, 
        {
            "location": "/dev/connect-mobile-app-local-stack/#prerequisite", 
            "text": "Have a local stack installed  Have an Android emulator created", 
            "title": "Prerequisite"
        }, 
        {
            "location": "/dev/connect-mobile-app-local-stack/#start-the-emulator-with-the-ability-to-remount-its-file-system-as-writable", 
            "text": "Since we will need to edit the hosts of the emulator, we need to be able to remount its file system as writable. For that, we need to start our emulator with the following command :  ./emulator -writable-system -avd Pixel_API_27  The  emulator  binary is located at  /home/user/Android/Sdk/emulator/  on Linux systems by default.  Pixel_API_27  is the name of the emulator I want to start. If you don t know the name of your emulator, you can get it with :  ./emulator -list-avds", 
            "title": "Start the emulator with the ability to remount its file system as writable"
        }, 
        {
            "location": "/dev/connect-mobile-app-local-stack/#root-the-emulator", 
            "text": "Now that the emulator is started, we need to gain root access on it. Run the following command :  adb root  This restarts the adb daemon with root privileges.", 
            "title": "Root the emulator"
        }, 
        {
            "location": "/dev/connect-mobile-app-local-stack/#remount-the-file-sytem-as-writable", 
            "text": "By default, the file system is read-only. We need it to be writable, so we run this command :  adb remount", 
            "title": "Remount the file sytem as writable"
        }, 
        {
            "location": "/dev/connect-mobile-app-local-stack/#pull-the-emulators-hosts-file", 
            "text": "To edit the  hosts  file, we need to pull it on our system :  adb pull /etc/hosts hosts  This creates a  hosts  file in your current directory.", 
            "title": "Pull the emulator's hosts file"
        }, 
        {
            "location": "/dev/connect-mobile-app-local-stack/#edit-the-hosts", 
            "text": "For the emulator to be able to connect to our stack, we need to add the IP address of our machine to the hosts. Actually, we don t really need it since in an Android emulator  10.0.2.2  is automatically pointing to our machine. So we just need to add this to the  hosts  file :  10.0.2.2 cozy.tools", 
            "title": "Edit the hosts"
        }, 
        {
            "location": "/dev/connect-mobile-app-local-stack/#push-the-new-file-to-the-emulator", 
            "text": "Now that we have added what s necessary in the file, we have to push it to the emulator :  adb push hosts /system/etc/hosts  Then try to ping  cozy.tools  to see if everything is working well :  adb shell ping api.dev.local  You can now enter  http://cozy.tools  in the login page of your mobile app and you will not get an error anymore.", 
            "title": "Push the new file to the emulator"
        }, 
        {
            "location": "/dev/intro/", 
            "text": "Introduction\n\n\nCozy is a personal server hosting applications that allow collect and manipulate all your personal data.\n\n\nThere are two kind of applications:\n\n\n\n\nweb applications\n: that\ns Single Page Applications (SPA) written in HTML and JavaScript that run inside the user\ns browser. They interact with the server through its API. This API allows to manipulate data and files and to perform miscellaneous tasks, like send emails\n\n\nconnectors\n: that\ns small application written in JavaScript, running on the server side, that import your data from remote sources.\n\n\n\n\nIn this tutorial, you\nll learn how to \nwrite a client application\n and \na connector\n.\n\n\nArchitecture\n\n\nSeveral layers can be distinguished. From inside to outside:\n\n\n\n\nthe core is a database that store all user data;\n\n\nthe database is accessible through a layer that control accesses and expose a REST API;\n\n\nWeb applications and other clients offer nice user interfaces to interact with the data.\n\n\n\n\nOne of our motto is \u00ab\u00a0Cozy is Simple, Versatile, Yours\u00a0\u00bb. This applies to our architecture:\n\n\n\n\nsimple\n and easy to understand and deploy. Cozy doesn\u2019t require to setup and manage a lot of micro-services;\n\n\nversatile\n: our server is comfortable anywhere. You can host a single instance on a small Raspberry \u03c0 at home, or a cluster of thousands instances on dedicated servers inside a datacenter;\n\n\nyours\n: the users are the owners of their data, they keep the control. They can migrate their data from one server to another, and are not dependant from a single hosting provider. As we say: \u201cyou will stay because you can leave\u201d;\n\n\n\n\n\n\nThe server\n\n\nThe server consist of a single process. We call it \nthe Cozy stack\n. It provides services through a REST API that allow to:\n\n\n\n\ncreate, update, delete documents inside the database;\n\n\nsend emails;\n\n\nlaunch jobs on the server. Connectors that import data from remote websites are some sort of jobs. Jobs can be one time tasks (sending a message) or periodic tasks. Some jobs, like the connectors, that require executing third party code on the server side, are sandboxed (we user \nnsjail\n for now).\n\n\n\u2026\n\n\n\n\nThe server also allow to access the database replication API, allowing to sync documents between the server and local databases, for example in mobile clients.\n\n\nTwo authentication methods are available:\n\n\n\n\nWeb applications running on the server get a session token when the user log in;\n\n\nOAuth2 for other applications.\n\n\n\n\nThe server is in charge of serving the Web applications users have installed from the application store.\n\n\nThe database\n\n\nCouchDB is a document database. Everything, from user data to server settings, is stored inside typed documents, identified by an unique id.\n\n\nTwo request methods are allowed: map-reduce or \nMango\n, a specific query language.\n\n\nEvery document has a \ndoctype\n, and we keep an index of the definition of every doctype.\n\n\nBinary data are stored outside the database. Depending on the server configuration, they may be stored on a file system or a dedicated object storage like \nswift\n.\n\n\nThe \ndatasystem\n layer inside the Cozy stack is in charge of controlling access rights on documents and binaries. It allows fine gained access control, on a whole doctype or on a set of documents.\n\n\nThe applications\n\n\nThe server provide services to applications:\n\n\n\n\nreal time notifications of events;\n\n\nmethods allowing applications to communicate and share data;\n\n\nmethods allowing sharing of documents between servers.\n\n\n\n\nApplication store\n\n\nAn application registry lists every available applications, and their characteristics. Each application can:\n\n\n\n\ncreate its own doctypes;\n\n\nrequest permission to access documents;\n\n\noffer services to other applications;\n\n\nregister publics routes;\n\n\ncreate jobs that will be run on server side.\n\n\n\n\nSecurity\n\n\nEach application uses its own sub-domain name, so it gets sandboxed inside the browser: other application are not able to steal it access token and access its data.\n\n\nWe use \nContent Security Policy\n to control what the application is allowed to do. For example, Web applications running inside Cozy are not allowed to send requests to other websites. This allow a strict control over applications, preventing them to leak your data.", 
            "title": "Architecture"
        }, 
        {
            "location": "/dev/intro/#introduction", 
            "text": "Cozy is a personal server hosting applications that allow collect and manipulate all your personal data.  There are two kind of applications:   web applications : that s Single Page Applications (SPA) written in HTML and JavaScript that run inside the user s browser. They interact with the server through its API. This API allows to manipulate data and files and to perform miscellaneous tasks, like send emails  connectors : that s small application written in JavaScript, running on the server side, that import your data from remote sources.   In this tutorial, you ll learn how to  write a client application  and  a connector .", 
            "title": "Introduction"
        }, 
        {
            "location": "/dev/intro/#architecture", 
            "text": "Several layers can be distinguished. From inside to outside:   the core is a database that store all user data;  the database is accessible through a layer that control accesses and expose a REST API;  Web applications and other clients offer nice user interfaces to interact with the data.   One of our motto is \u00ab\u00a0Cozy is Simple, Versatile, Yours\u00a0\u00bb. This applies to our architecture:   simple  and easy to understand and deploy. Cozy doesn\u2019t require to setup and manage a lot of micro-services;  versatile : our server is comfortable anywhere. You can host a single instance on a small Raspberry \u03c0 at home, or a cluster of thousands instances on dedicated servers inside a datacenter;  yours : the users are the owners of their data, they keep the control. They can migrate their data from one server to another, and are not dependant from a single hosting provider. As we say: \u201cyou will stay because you can leave\u201d;", 
            "title": "Architecture"
        }, 
        {
            "location": "/dev/intro/#the-server", 
            "text": "The server consist of a single process. We call it  the Cozy stack . It provides services through a REST API that allow to:   create, update, delete documents inside the database;  send emails;  launch jobs on the server. Connectors that import data from remote websites are some sort of jobs. Jobs can be one time tasks (sending a message) or periodic tasks. Some jobs, like the connectors, that require executing third party code on the server side, are sandboxed (we user  nsjail  for now).  \u2026   The server also allow to access the database replication API, allowing to sync documents between the server and local databases, for example in mobile clients.  Two authentication methods are available:   Web applications running on the server get a session token when the user log in;  OAuth2 for other applications.   The server is in charge of serving the Web applications users have installed from the application store.", 
            "title": "The server"
        }, 
        {
            "location": "/dev/intro/#the-database", 
            "text": "CouchDB is a document database. Everything, from user data to server settings, is stored inside typed documents, identified by an unique id.  Two request methods are allowed: map-reduce or  Mango , a specific query language.  Every document has a  doctype , and we keep an index of the definition of every doctype.  Binary data are stored outside the database. Depending on the server configuration, they may be stored on a file system or a dedicated object storage like  swift .  The  datasystem  layer inside the Cozy stack is in charge of controlling access rights on documents and binaries. It allows fine gained access control, on a whole doctype or on a set of documents.", 
            "title": "The database"
        }, 
        {
            "location": "/dev/intro/#the-applications", 
            "text": "The server provide services to applications:   real time notifications of events;  methods allowing applications to communicate and share data;  methods allowing sharing of documents between servers.", 
            "title": "The applications"
        }, 
        {
            "location": "/dev/intro/#application-store", 
            "text": "An application registry lists every available applications, and their characteristics. Each application can:   create its own doctypes;  request permission to access documents;  offer services to other applications;  register publics routes;  create jobs that will be run on server side.", 
            "title": "Application store"
        }, 
        {
            "location": "/dev/intro/#security", 
            "text": "Each application uses its own sub-domain name, so it gets sandboxed inside the browser: other application are not able to steal it access token and access its data.  We use  Content Security Policy  to control what the application is allowed to do. For example, Web applications running inside Cozy are not allowed to send requests to other websites. This allow a strict control over applications, preventing them to leak your data.", 
            "title": "Security"
        }, 
        {
            "location": "/dev/app/", 
            "text": "How to create your first Cozy application\n\n\nPrerequisite\n\n\nDeveloping an application for Cozy is quite easy. All you need to know is:\n\n\n\n\nhow to develop a single page application in HTML5. You can use the tools or framework of your choice, or no framework\n\n\nbasic Docker knowledges.\n\n\n\n\nThe only required tool is Docker. We have been told that installing Docker on some familial flavours of Windows may be a bit difficult. If you use Windows, please check if Docker is available on your system.\n\n\nInstall the development environment\n\n\n\n\nOn GNU/Linux, according \nto the documentation\n: \u00ab\u00a0The docker daemon binds to a Unix socket instead of a TCP port. By default that Unix socket is owned by the user root and other users can only access it using sudo. If you don\u2019t want to use sudo when you use the docker command, create a Unix group called docker and add users to it. Be warned that the docker group grants privileges equivalent to the root user. You should have a look at \nDocker\u2019s documentation on security\n.\n\n\n\n\nEvery application running inside Cozy is a client-side HTML5 application interacting with your data through the API of the server. To develop an application, you\u2019ll require a running Cozy server.\n\n\nThe easiest way is to use the Docker image for developers we provide.\n\n\nJust install it:\n\n\ndocker pull cozy/cozy-app-dev\n\n\n\n\n(We update this image on a regular basis with the latest version of the server and our library. Don\u2019t forget to update the image by running \ndocker pull cozy/cozy-app-dev\n from time to time).\n\n\nCreate your first application\n\n\nThe minimal application consist of only two files:\n\n\n\n\nan HTML file, \nindex.html\n, with the markup and the code of your application\n\n\na manifest describing the application. It\u2019s a JSON file named \nmanifest.webapp\n with the name of the application, the permissions it requires\u2026 We\u2019ll have a deeper look to it content later. #TODO add an inner link to the manifest description.\n\n\n\n\nYour application will be able to use some shared libraries provided by the server, so you don\u2019t have to include them into your project.\n\n\nYour application requires some informations to interact with the server API, for example the URL of its entrypoint, and an auth token. This data will be dynamically injected into \nindex.html\n when it serves the page. So the \nindex.html\n file has to contain some string that will be replaced by the server. The general syntax of this variables is \n{{\u2026}}\n, so don\u2019t use this syntax for other purpose in the page, for example inside comments.\n\n\nYou can use the following variables:\n\n\n\n\n{{.Domain}}\n will be substituted by the URL of the API entrypoint\n\n\n{{.Token}}\n will be replaced by a token that authenticate your application when accessing the API\n\n\n{{.Locale}}\n: the lang f the instance\n\n\n{{.AppName}}\n: the name of the application\n\n\n{{.IconPath}}\n will be replaced by HTML code to display the \nfavicon\n\n\n{{.CozyClientJS}}\n will be replaced with HTML code to inject the Cozy client library\n\n\n{{.CozyBar}}\n will be replaced with HTML code to inject the upper menu bar.\n\n\n\n\nUse the API\n\n\nIf you added \n{{.CozyClientJS}}\n to your page, interacting with the server will be as easy as using the Cozy Client JS library. All you have to do is to initiate the library with the server parameters (the URL of the API and the auth token of your application):\n\n\n  window.cozy.client.init({cozyURL: \n\u2026\n, token: \n\u2026\n});\n\n\n\n\nYou can then interact with the server by using methods of the \nwindow.cozy.client\n properties. For example, to get current disk usage:\n\n\n  cozy.client.settings.diskUsage()\n    .then(function (usage) {console.log(\nUsage (promise)\n, usage);});\n    .catch(function(err){ console.log(\nfail\n, err); });\n\n\n\n\nThis library embeds most of the available server APIs: manipulate documents and files, manage applications and server settings\u2026 It also provides some some methods to help application keep working while being offline.\n\n\nSome server APIs may not be available right now through the library. If you want to use one of this method, you\u2019ll have to call it manually. See below. #TODO - add inner link.\n\n\nBehind the magic\n\n\nSome server APIs may not be available right now through the library. If you want to use one of this method, you\u2019ll have to call it manually. We\u2019ll describe here how to access the API without using the Cozy Cliznt JS library.\n\n\nConnecting to the API requires three things:\n\n\n\n\nits URL, injected into the page through the \n{{.Domain}}\n variable\n\n\nthe application auth token, injected into the page through the \n{{.Token}}\n variable. Each request sent to the server must include this token in the \nAuthorization\n header\n\n\nthe session cookie, created when you connect to your server. This is an \nHttpOnly cookie\n, meaning that JavaScript applications can\u2019t read it. This prevent a malicious script to stole the cookie.\n\n\n\n\nHere\u2019s a sample code that get API informations provided by the server and query the API:\n\n\n    \ndiv data-cozy-token=\n{{.Token}}\n data-cozy-domain=\n{{.Domain}}\n /\n\n\n\n\ndocument.addEventListener('DOMContentLoaded', () =\n {\n  \nuse strict\n;\n  const app = document.querySelector('[data-cozy-token]');\n  fetch(`//${app.dataset.cozyDomain}/apps`,\n  {\n    method: 'GET',\n    headers: {\n      Authorization: `Bearer ${app.dataset.cozyToken}` // Here we use the auth token\n    },\n    credentials: 'include' // don\u2019t forget to include the session cookie\n  })\n  .then(function (response) {\n    if (response.ok) {\n      response.json().then((result) =\n {\n        console.log(result);\n      });\n    } else {\n      throw new Error('Network response was not ok.');\n    }\n  })\n  .catch(function (error) {\n    console.log('There has been a problem with your fetch operation: ' + error.message);\n  });\n});\n\n\n\n\nThe manifest\n\n\nEach application must have a \u201cmanifest\u201d. It\u2019s a JSON file named \nmanifest.webapp\n stored at the root of the application directory. It describes the application, the type of documents it uses, the permissions it require\u2026\n\n\nHere\u2019s a sample manifest:\n\n\n{\n  \nname\n: \nMy Awesome application\n,\n  \npermissions\n: {\n    \napps\n: {\n      \ntype\n: \nio.cozy.apps\n\n    },\n    \npermissions\n: {\n      \ntype\n: \nio.cozy.permissions\n\n    },\n    \nsettings\n: {\n      \ntype\n: \nio.cozy.settings\n\n    },\n    \nsample\n: {\n      \ntype\n: \nio.cozy.dev.sample\n,\n      \nverbs\n: [\nGET\n, \nPOST\n, \nPUT\n, \nPATCH\n, \nDELETE\n]\n    },\n    \njobs\n: {\n      \ntype\n: \nio.cozy.jobs\n\n    }\n  },\n  \nroutes\n: {\n    \n/\n: {\n      \nfolder\n: \n/\n,\n      \nindex\n: \nindex.html\n,\n      \npublic\n: false\n    },\n    \n/public\n: {\n      \nfolder\n: \n/public\n,\n      \nindex\n: \nindex.html\n,\n      \npublic\n: true\n    }\n  }\n}\n\n\n\n\nPermissions\n\n\nApplications require permissions to use most of the APIs. Permissions can be described inside the manifest, so the server can ask the user to grant them during installation. Applications can also request permissions at run time.\n\n\nA permission must at type contain a target, the type of objects the application want to interact with. Can be a document type, or an action on the server. By default, all grant on this object are granted, but we can also request fine grained permissions, for example limiting to read access. We can also limit the scope to a subset of the documents.\n\n\nIn the manifest, each permission is an object, with a random name and some properties:\n\n\n\n\ntype\n: \nmandatory\n the document type or action name\n\n\ndescription\n: a text that will be displayed to the user to explain why the application require this permission\n\n\nverbs\n: an array of HTTP verbs. For example, to limit permissions to read access, use \n[\"GET\"]\n\n\nselector\n: a document attribute to limit access to a subset of documents\n\n\nvalues\n: array of allowed values for this attribute.\n\n\n\n\nAn application can request a token that grant access to a subset of its own permissions. For example if the application has full access to the files, it can obtain a token that give only read access on a file. Thus, the application can make some documents publicly available. The public page of the application will use this token as authentication token when accessing the API.\n\n\nSamples\n\n\nApplication require full access to files:\n\n\n{\n  \npermissions\n: {\n    \nfiles\n: {\n      \ndescription\n: \n\u2026\n,\n      \ntype\n: \nio.cozy.files\n\n    },\n  }\n}\n\n\n\n\nApplication want to be able to read the contact informations of \ncozy@cozycloud.cc\n\n\n{\n  \npermissions\n: {\n    \ncontact\n: {\n      \ntype\n: \nio.cozy.contacts\n,\n      \nverbs\n: [\nGET\n],\n      \nselector\n: \nemail\n,\n      \nvalues\n: [\ncozy@cozycloud.cc\n]\n    }\n  }\n}\n\n\n\n\nRouting\n\n\nThe application must declare all of its URLs (routes) inside the manifest. A route is an object associating an URL to an HTML file. Each route has the following properties:\n\n\n\n\nfolder\n: the base folder of the route\n\n\nindex\n: the name of the file inside this folder\n\n\npublic\n: a boolean specifying whether the route is public or private (default).\n\n\n\n\nSample:\n\n\nroutes\n: {\n  \n/admin\n: {\n    \nfolder\n: \n/\n,\n    \nindex\n: \nadmin.html\n,\n    \npublic\n: false\n  },\n  \n/public\n: {\n    \nfolder\n: \n/public\n,\n    \nindex\n: \nindex.html\n,\n    \npublic\n: true\n  },\n  \n/assets\n: {\n    \nfolder\n: \n/assets\n,\n    \npublic\n: true\n  }\n}\n\n\n\n\ncozy-client-js\n\n\nThis library embeds most of the available server APIs: manipulate documents and files, manage applications and server settings\u2026 It also provides some some methods to help application keep working while being offline.\n\n\nThe library expose a client API under the \nwindow.cozy.client\n namespace. Before using it, you have to initiate the library with the server parameters (the URL of the API and the auth token of your application):\n\n\n  window.cozy.client.init({cozyURL: \n\u2026\n, token: \n\u2026\n});\n\n\n\n\nThe library supports two programming paradigms: callback and Promises, so you can use your favorite one. If you prefer using callbacks rather than Promises, just add \ndisablePromises\n to the options when initializing the library:\n\n\n  window.cozy.client.init({cozyURL: \n\u2026\n, token: \n\u2026\n, disablePromises: true});\n  window.client.settings.diskUsage(function (err, res) {\n    (\u2026)\n  });\n\n\n\n\nRaw API documentation\n\n\nIn this tutorial, we\u2019ll only see a few samples of how to use the library. For a complete description of all available methods, please refer to its own documentation:\n\n\n\n\ndocuments\n\n\nfiles\n\n\nauthentification\n\n\nauthentication with OAuth2\n\n\nsettings\n\n\ninter-app communication\n\n\njobs and triggers\n\n\nsharing\n\n\noffline\n\n\nCozy Bar\n\n\n\n\nManipulating documents\n\n\nInside cozy data system, all documents are typed. To prevent applications to create document types with the same name but different description, the naming of the doctypes use \nthe Java specification\n. Every document type name must be prefixed by the reverted domain name of its creator. If you don\u2019t own a domain name, you can also use your email address. For example, doctypes created by Cozy are prefixed by \nio.cozy\n or \nio.cozy.labs\n. If you don\u2019t own a domain name, and your email address is \nfoo@bar.cloud\n, prefix your doctype names with \ncloud.bar.foo\n.\n\n\nWe maintain an index of \nall the currently available doctypes\n. To make your own doctypes available to other applications, please send a pull request to this repository.\n\n\nBefore manipulating documents, you have to request permission to access their doctype, either in the manifest or dynamically.\n\n\nEvery method allowing to handle document are available under the \ncozy.client.data\n namespace. For example:\n\n\n\n\ncozy.client.data.create(doctype, attributes)\n, \ncozy.client.data.update(doctype, doc, newdoc)\n \ncozy.client.data.delete(doctype, doc)\n to create, update and delete documents\n\n\ncozy.client.data.updateAttributes(doctype, id, changes)\n to only update some attributes of a document\n\n\ncozy.client.data.find(doctype, id)\n return a document using its ident\n\n\ncozy.client.data.changesFeed(doctype, options)\n get the latests updates of documents of a doctype\n\n\nyou can attach files to a document using \ncozy.client.data.addReferencedFiles(doc, fileIds)\n and list attachments with \ncozy.client.data.listReferencedFiles(doc)\n\n\n\n\nQuerying\n\n\nTo search documents inside the database, you first need to create an index on some attributes of the documents, then perform a query on this index. The library offers the following methods:\n\n\n\n\ncozy.client.data.defineIndex(doctype, fields)\n to create the index\n\n\ncozy.client.data.query(indexReference, query)\n to query an index. The query parameter uses the syntax of the \nMango API\n from CouchDB 2.\n\n\n\n\nFor example, to search contacts by their email address, you could use:\n\n\ncozy.client.data.defineIndex(\nio.cozy.contacts\n, [\nemail\n])\n.then((index) =\n {\n  return cozy.data.query(index, {\nselector\n: {email: \ncozy@cozycloud.cc\n}})\n})\n.then( (result) =\n {\n  console.log(result[0].name);\n});\n\n\n\n\nManipulating files\n\n\nThe metadata of the files are stored inside the server database, allowing to perform advanced queries, and the files themselves on a virtual file system.\n\n\nThe library offer a lot of methods under \ncozy.client.files\n namespace to manipulate files. Most of the methods allows to manipulate a file or folder either by its id or by its full path. Here are the most commons ones, but a lot of other methods are available in the \nraw API documentation\n:\n\n\n\n\ncreate()\n and \nupdateById()\n to create and update a file\n\n\ncreateDirectory()\n to create a folder\n\n\nupdateAttributesById()\n et \nupdateAttributesByPath()\n allow to update some metadata\n\n\nuse \ndestroyById\n to remove a file\n\n\na virtual trash is available. You can put files into the trash (\ntrashById()\n) and restore them (\nrestoreById()\n). You can also list the content of the trash (\nlistTrash()\n) and purge all trashed files (\nclearTrash()\n)\n\n\nstatById(id)\n et \nstatByPath(path)\n return the metadata and, or folders, their content\n\n\n\n\nFolders\n\n\nWhen using \nstatById()\n or \nstatByPath()\n to get metadata of of folder, you can than call \nrelations()\n on the resulting object to access their content. For example, to list content of the root folder, use:\n\n\ncozy.client.files.statByPath(\n/\n)\n.then((dir) =\n {\n  console.log(dir.relations(\ncontents\n));\n})\n\n\n\n\nSome special folder have a pre-defined id that will never change:\n\n\n\n\nio.cozy.files.root-dir\n is the root of the filesystem\n\n\nio.cozy.files.trash-dir\n is the trash.\n\n\n\n\nThe Cozy Bar\n\n\nThe \nCozy Bar\n is a component that display the Cozy menu on the top of your application and allow inter-apps features like content sharing.\n\n\nYour application interacts with this component through \ncozy-bar.js\n, a library injected into your pages by the server when you add \n{{.CozyBar}}\n in the header. It exposes an API behind the window.cozy.bar namespace.\n\n\nBefore using it, you have to initialize the library: \nwindow.cozy.bar.init({appName: \"Mon application\"})\n.\n\n\nStyling\n\n\nIf you plan to build a webapp to run on Cozy, you\u2019ll probably want to use a simple and elegant solution to build your interfaces without the mess of dealing with complex markup and CSS. Then \nCozy UI\n is here for you!\n\n\nIt relies on Stylus as preprocessor. You can add it as a library in your project to use it out-of-the-box.\n\n\nStart the development server\n\n\nNow it\u2019s time to start the development server, to test our application.\n\n\n(remember what we previously said about the permissions required to run Docker: if your user doesn\u2019t belong to the docker group, you\u2019ll have to use \nsudo\n to run each of this commands.)\n\n\nTo run your application inside the development server, just run the following command from the folder where your \nindex.html\n and \nmanifest.webapp\n files leave:\n\n\ndocker run --rm -it -p 8080:8080 -p 5984:5984 -p 8025:8025 -v $(pwd):/data/cozy-app --name cozydev cozy/cozy-app-dev\n\n\n\n\nLet\u2019s have a quick look at this command, so you can adapt it to your needs:\n\n\n\n\n--rm\n will delete the server when you stop it. This prevent Docker from keeping a lot of unused stopped images\n\n\n-it\n allow to attach an interactive terminal, so you\u2019ll be able to use the command line inside the server\n\n\n-p 8080:8080\n: the server listens on port 8080 on the virtual machine. We forward this port to the same port on your local machine. To use another local port, for example 9090, use \n-p 9090:8080\n\n\n-p 5984:5984\n: this is just a convenient way to access the CouchDB database running inside the server. Point your browser to \nhttp://cozy.tools:5984/_utils/\n to access its administrative interface\n\n\n-p 8025:8025\n\u00a0: Cozy requires a mail server. In the development image, we don\u2019t use a real email server, but a software that can display the sent messages. Just point your browser to \nhttp://cozy.tools:8025/\n to display the messages sent by the server\n\n\n-v $(pwd):/data/cozy-app\n this mount the current folder, where your application leaves, inside the server. This is what make the application available on the server\n\n\n--name cozydev\n name the running virtual machine \ncozydev\n, so you can easily refer to it from other Docker commands. For example, if you want to connect to a shell inside the server, you can use \ndocker exec -ti /bin/bash\n\n\n\n\nWith this syntax, there is no data persistance: all your test data will be lost every time you stop the server. This is a good way to prevent side effects and start on a clean base, with an empty database.\n\n\nHowever, if you want to persist data, you have to mount two folders from the virtual server to local folders: \n/usr/local/couchdb/data\n (database) and \n/data/cozy-storage\n (the virtual filesystem). This can be achieved by adding to the command line \n-v ~/cozy/data/db:/usr/local/couchdb/data -v ~/cozy/data/storage:/data/cozy-storage\n which will store the server\u2019s data into \n~/cozy/data\n.\n\n\nOnce the server started, go to \nhttp://app.cozy.tools:8080/#\n, connect to the server with the default password \ncozy\n and you should be able to start testing your application.\n\n\nYou can also access the following URLs:\n\n\n\n\nhttp://cozy.tools:5984/_utils\n to get the database administrative panel\n\n\nhttp://cozy.tools:8025/\n to display the emails sent by the server.\n\n\n\n\nTest multiple applications\n\n\nYou can install more than one application into the development server, for example to test communication between applications. In order to achieve this, you have to mount the folder where your application leaves into subfolders of \n/data/cozy-apps\n. For example, if the code of Cozy Drive and Cozy Photos is on your local filesystem in \n~/cozy/drive\n and \n~/cozy/photos\n, start the development server with:\n\n\ndocker run --rm -it -p 8080:8080 -p 5984:5984 -p 8025:8025 -v \n~/cozy/drive\n:/data/cozy-app/drive\n -v \n~/cozy/photos:/data-cozy-app/photos\n --name=cozydev cozy/cozy-app-dev\n\n\n\n\nYou\u2019ll access the applications by connecting to \nhttp://drive.cozy.tools:8080/\n and \nhttp://photos.cozy.tools:8080\n.\n\n\nTODO\n\n\nThis development server use the domain names \n*.cozy.tools\n. We have parameterized this domain to always redirect to \n127.0.0.1\n, your local computer address.\n\n\nThe \nsample\n branch of this documentation repository contains a minimalist template with the needed files to create an app. You can get them with the following command:\n\n\ngit clone -b sample https://github.com/cozy/cozy-docdev-v3.git myapp\ncd myapp", 
            "title": "Create your first app"
        }, 
        {
            "location": "/dev/app/#how-to-create-your-first-cozy-application", 
            "text": "", 
            "title": "How to create your first Cozy application"
        }, 
        {
            "location": "/dev/app/#prerequisite", 
            "text": "Developing an application for Cozy is quite easy. All you need to know is:   how to develop a single page application in HTML5. You can use the tools or framework of your choice, or no framework  basic Docker knowledges.   The only required tool is Docker. We have been told that installing Docker on some familial flavours of Windows may be a bit difficult. If you use Windows, please check if Docker is available on your system.", 
            "title": "Prerequisite"
        }, 
        {
            "location": "/dev/app/#install-the-development-environment", 
            "text": "On GNU/Linux, according  to the documentation : \u00ab\u00a0The docker daemon binds to a Unix socket instead of a TCP port. By default that Unix socket is owned by the user root and other users can only access it using sudo. If you don\u2019t want to use sudo when you use the docker command, create a Unix group called docker and add users to it. Be warned that the docker group grants privileges equivalent to the root user. You should have a look at  Docker\u2019s documentation on security .   Every application running inside Cozy is a client-side HTML5 application interacting with your data through the API of the server. To develop an application, you\u2019ll require a running Cozy server.  The easiest way is to use the Docker image for developers we provide.  Just install it:  docker pull cozy/cozy-app-dev  (We update this image on a regular basis with the latest version of the server and our library. Don\u2019t forget to update the image by running  docker pull cozy/cozy-app-dev  from time to time).", 
            "title": "Install the development environment"
        }, 
        {
            "location": "/dev/app/#create-your-first-application", 
            "text": "The minimal application consist of only two files:   an HTML file,  index.html , with the markup and the code of your application  a manifest describing the application. It\u2019s a JSON file named  manifest.webapp  with the name of the application, the permissions it requires\u2026 We\u2019ll have a deeper look to it content later. #TODO add an inner link to the manifest description.   Your application will be able to use some shared libraries provided by the server, so you don\u2019t have to include them into your project.  Your application requires some informations to interact with the server API, for example the URL of its entrypoint, and an auth token. This data will be dynamically injected into  index.html  when it serves the page. So the  index.html  file has to contain some string that will be replaced by the server. The general syntax of this variables is  {{\u2026}} , so don\u2019t use this syntax for other purpose in the page, for example inside comments.  You can use the following variables:   {{.Domain}}  will be substituted by the URL of the API entrypoint  {{.Token}}  will be replaced by a token that authenticate your application when accessing the API  {{.Locale}} : the lang f the instance  {{.AppName}} : the name of the application  {{.IconPath}}  will be replaced by HTML code to display the  favicon  {{.CozyClientJS}}  will be replaced with HTML code to inject the Cozy client library  {{.CozyBar}}  will be replaced with HTML code to inject the upper menu bar.", 
            "title": "Create your first application"
        }, 
        {
            "location": "/dev/app/#use-the-api", 
            "text": "If you added  {{.CozyClientJS}}  to your page, interacting with the server will be as easy as using the Cozy Client JS library. All you have to do is to initiate the library with the server parameters (the URL of the API and the auth token of your application):    window.cozy.client.init({cozyURL:  \u2026 , token:  \u2026 });  You can then interact with the server by using methods of the  window.cozy.client  properties. For example, to get current disk usage:    cozy.client.settings.diskUsage()\n    .then(function (usage) {console.log( Usage (promise) , usage);});\n    .catch(function(err){ console.log( fail , err); });  This library embeds most of the available server APIs: manipulate documents and files, manage applications and server settings\u2026 It also provides some some methods to help application keep working while being offline.  Some server APIs may not be available right now through the library. If you want to use one of this method, you\u2019ll have to call it manually. See below. #TODO - add inner link.", 
            "title": "Use the API"
        }, 
        {
            "location": "/dev/app/#behind-the-magic", 
            "text": "Some server APIs may not be available right now through the library. If you want to use one of this method, you\u2019ll have to call it manually. We\u2019ll describe here how to access the API without using the Cozy Cliznt JS library.  Connecting to the API requires three things:   its URL, injected into the page through the  {{.Domain}}  variable  the application auth token, injected into the page through the  {{.Token}}  variable. Each request sent to the server must include this token in the  Authorization  header  the session cookie, created when you connect to your server. This is an  HttpOnly cookie , meaning that JavaScript applications can\u2019t read it. This prevent a malicious script to stole the cookie.   Here\u2019s a sample code that get API informations provided by the server and query the API:       div data-cozy-token= {{.Token}}  data-cozy-domain= {{.Domain}}  /  document.addEventListener('DOMContentLoaded', () =  {\n   use strict ;\n  const app = document.querySelector('[data-cozy-token]');\n  fetch(`//${app.dataset.cozyDomain}/apps`,\n  {\n    method: 'GET',\n    headers: {\n      Authorization: `Bearer ${app.dataset.cozyToken}` // Here we use the auth token\n    },\n    credentials: 'include' // don\u2019t forget to include the session cookie\n  })\n  .then(function (response) {\n    if (response.ok) {\n      response.json().then((result) =  {\n        console.log(result);\n      });\n    } else {\n      throw new Error('Network response was not ok.');\n    }\n  })\n  .catch(function (error) {\n    console.log('There has been a problem with your fetch operation: ' + error.message);\n  });\n});", 
            "title": "Behind the magic"
        }, 
        {
            "location": "/dev/app/#the-manifest", 
            "text": "Each application must have a \u201cmanifest\u201d. It\u2019s a JSON file named  manifest.webapp  stored at the root of the application directory. It describes the application, the type of documents it uses, the permissions it require\u2026  Here\u2019s a sample manifest:  {\n   name :  My Awesome application ,\n   permissions : {\n     apps : {\n       type :  io.cozy.apps \n    },\n     permissions : {\n       type :  io.cozy.permissions \n    },\n     settings : {\n       type :  io.cozy.settings \n    },\n     sample : {\n       type :  io.cozy.dev.sample ,\n       verbs : [ GET ,  POST ,  PUT ,  PATCH ,  DELETE ]\n    },\n     jobs : {\n       type :  io.cozy.jobs \n    }\n  },\n   routes : {\n     / : {\n       folder :  / ,\n       index :  index.html ,\n       public : false\n    },\n     /public : {\n       folder :  /public ,\n       index :  index.html ,\n       public : true\n    }\n  }\n}", 
            "title": "The manifest"
        }, 
        {
            "location": "/dev/app/#permissions", 
            "text": "Applications require permissions to use most of the APIs. Permissions can be described inside the manifest, so the server can ask the user to grant them during installation. Applications can also request permissions at run time.  A permission must at type contain a target, the type of objects the application want to interact with. Can be a document type, or an action on the server. By default, all grant on this object are granted, but we can also request fine grained permissions, for example limiting to read access. We can also limit the scope to a subset of the documents.  In the manifest, each permission is an object, with a random name and some properties:   type :  mandatory  the document type or action name  description : a text that will be displayed to the user to explain why the application require this permission  verbs : an array of HTTP verbs. For example, to limit permissions to read access, use  [\"GET\"]  selector : a document attribute to limit access to a subset of documents  values : array of allowed values for this attribute.   An application can request a token that grant access to a subset of its own permissions. For example if the application has full access to the files, it can obtain a token that give only read access on a file. Thus, the application can make some documents publicly available. The public page of the application will use this token as authentication token when accessing the API.", 
            "title": "Permissions"
        }, 
        {
            "location": "/dev/app/#samples", 
            "text": "Application require full access to files:  {\n   permissions : {\n     files : {\n       description :  \u2026 ,\n       type :  io.cozy.files \n    },\n  }\n}  Application want to be able to read the contact informations of  cozy@cozycloud.cc  {\n   permissions : {\n     contact : {\n       type :  io.cozy.contacts ,\n       verbs : [ GET ],\n       selector :  email ,\n       values : [ cozy@cozycloud.cc ]\n    }\n  }\n}", 
            "title": "Samples"
        }, 
        {
            "location": "/dev/app/#routing", 
            "text": "The application must declare all of its URLs (routes) inside the manifest. A route is an object associating an URL to an HTML file. Each route has the following properties:   folder : the base folder of the route  index : the name of the file inside this folder  public : a boolean specifying whether the route is public or private (default).   Sample:  routes : {\n   /admin : {\n     folder :  / ,\n     index :  admin.html ,\n     public : false\n  },\n   /public : {\n     folder :  /public ,\n     index :  index.html ,\n     public : true\n  },\n   /assets : {\n     folder :  /assets ,\n     public : true\n  }\n}", 
            "title": "Routing"
        }, 
        {
            "location": "/dev/app/#cozy-client-js", 
            "text": "This library embeds most of the available server APIs: manipulate documents and files, manage applications and server settings\u2026 It also provides some some methods to help application keep working while being offline.  The library expose a client API under the  window.cozy.client  namespace. Before using it, you have to initiate the library with the server parameters (the URL of the API and the auth token of your application):    window.cozy.client.init({cozyURL:  \u2026 , token:  \u2026 });  The library supports two programming paradigms: callback and Promises, so you can use your favorite one. If you prefer using callbacks rather than Promises, just add  disablePromises  to the options when initializing the library:    window.cozy.client.init({cozyURL:  \u2026 , token:  \u2026 , disablePromises: true});\n  window.client.settings.diskUsage(function (err, res) {\n    (\u2026)\n  });", 
            "title": "cozy-client-js"
        }, 
        {
            "location": "/dev/app/#raw-api-documentation", 
            "text": "In this tutorial, we\u2019ll only see a few samples of how to use the library. For a complete description of all available methods, please refer to its own documentation:   documents  files  authentification  authentication with OAuth2  settings  inter-app communication  jobs and triggers  sharing  offline  Cozy Bar", 
            "title": "Raw API documentation"
        }, 
        {
            "location": "/dev/app/#manipulating-documents", 
            "text": "Inside cozy data system, all documents are typed. To prevent applications to create document types with the same name but different description, the naming of the doctypes use  the Java specification . Every document type name must be prefixed by the reverted domain name of its creator. If you don\u2019t own a domain name, you can also use your email address. For example, doctypes created by Cozy are prefixed by  io.cozy  or  io.cozy.labs . If you don\u2019t own a domain name, and your email address is  foo@bar.cloud , prefix your doctype names with  cloud.bar.foo .  We maintain an index of  all the currently available doctypes . To make your own doctypes available to other applications, please send a pull request to this repository.  Before manipulating documents, you have to request permission to access their doctype, either in the manifest or dynamically.  Every method allowing to handle document are available under the  cozy.client.data  namespace. For example:   cozy.client.data.create(doctype, attributes) ,  cozy.client.data.update(doctype, doc, newdoc)   cozy.client.data.delete(doctype, doc)  to create, update and delete documents  cozy.client.data.updateAttributes(doctype, id, changes)  to only update some attributes of a document  cozy.client.data.find(doctype, id)  return a document using its ident  cozy.client.data.changesFeed(doctype, options)  get the latests updates of documents of a doctype  you can attach files to a document using  cozy.client.data.addReferencedFiles(doc, fileIds)  and list attachments with  cozy.client.data.listReferencedFiles(doc)", 
            "title": "Manipulating documents"
        }, 
        {
            "location": "/dev/app/#querying", 
            "text": "To search documents inside the database, you first need to create an index on some attributes of the documents, then perform a query on this index. The library offers the following methods:   cozy.client.data.defineIndex(doctype, fields)  to create the index  cozy.client.data.query(indexReference, query)  to query an index. The query parameter uses the syntax of the  Mango API  from CouchDB 2.   For example, to search contacts by their email address, you could use:  cozy.client.data.defineIndex( io.cozy.contacts , [ email ])\n.then((index) =  {\n  return cozy.data.query(index, { selector : {email:  cozy@cozycloud.cc }})\n})\n.then( (result) =  {\n  console.log(result[0].name);\n});", 
            "title": "Querying"
        }, 
        {
            "location": "/dev/app/#manipulating-files", 
            "text": "The metadata of the files are stored inside the server database, allowing to perform advanced queries, and the files themselves on a virtual file system.  The library offer a lot of methods under  cozy.client.files  namespace to manipulate files. Most of the methods allows to manipulate a file or folder either by its id or by its full path. Here are the most commons ones, but a lot of other methods are available in the  raw API documentation :   create()  and  updateById()  to create and update a file  createDirectory()  to create a folder  updateAttributesById()  et  updateAttributesByPath()  allow to update some metadata  use  destroyById  to remove a file  a virtual trash is available. You can put files into the trash ( trashById() ) and restore them ( restoreById() ). You can also list the content of the trash ( listTrash() ) and purge all trashed files ( clearTrash() )  statById(id)  et  statByPath(path)  return the metadata and, or folders, their content", 
            "title": "Manipulating files"
        }, 
        {
            "location": "/dev/app/#folders", 
            "text": "When using  statById()  or  statByPath()  to get metadata of of folder, you can than call  relations()  on the resulting object to access their content. For example, to list content of the root folder, use:  cozy.client.files.statByPath( / )\n.then((dir) =  {\n  console.log(dir.relations( contents ));\n})  Some special folder have a pre-defined id that will never change:   io.cozy.files.root-dir  is the root of the filesystem  io.cozy.files.trash-dir  is the trash.", 
            "title": "Folders"
        }, 
        {
            "location": "/dev/app/#the-cozy-bar", 
            "text": "The  Cozy Bar  is a component that display the Cozy menu on the top of your application and allow inter-apps features like content sharing.  Your application interacts with this component through  cozy-bar.js , a library injected into your pages by the server when you add  {{.CozyBar}}  in the header. It exposes an API behind the window.cozy.bar namespace.  Before using it, you have to initialize the library:  window.cozy.bar.init({appName: \"Mon application\"}) .", 
            "title": "The Cozy Bar"
        }, 
        {
            "location": "/dev/app/#styling", 
            "text": "If you plan to build a webapp to run on Cozy, you\u2019ll probably want to use a simple and elegant solution to build your interfaces without the mess of dealing with complex markup and CSS. Then  Cozy UI  is here for you!  It relies on Stylus as preprocessor. You can add it as a library in your project to use it out-of-the-box.", 
            "title": "Styling"
        }, 
        {
            "location": "/dev/app/#start-the-development-server", 
            "text": "Now it\u2019s time to start the development server, to test our application.  (remember what we previously said about the permissions required to run Docker: if your user doesn\u2019t belong to the docker group, you\u2019ll have to use  sudo  to run each of this commands.)  To run your application inside the development server, just run the following command from the folder where your  index.html  and  manifest.webapp  files leave:  docker run --rm -it -p 8080:8080 -p 5984:5984 -p 8025:8025 -v $(pwd):/data/cozy-app --name cozydev cozy/cozy-app-dev  Let\u2019s have a quick look at this command, so you can adapt it to your needs:   --rm  will delete the server when you stop it. This prevent Docker from keeping a lot of unused stopped images  -it  allow to attach an interactive terminal, so you\u2019ll be able to use the command line inside the server  -p 8080:8080 : the server listens on port 8080 on the virtual machine. We forward this port to the same port on your local machine. To use another local port, for example 9090, use  -p 9090:8080  -p 5984:5984 : this is just a convenient way to access the CouchDB database running inside the server. Point your browser to  http://cozy.tools:5984/_utils/  to access its administrative interface  -p 8025:8025 \u00a0: Cozy requires a mail server. In the development image, we don\u2019t use a real email server, but a software that can display the sent messages. Just point your browser to  http://cozy.tools:8025/  to display the messages sent by the server  -v $(pwd):/data/cozy-app  this mount the current folder, where your application leaves, inside the server. This is what make the application available on the server  --name cozydev  name the running virtual machine  cozydev , so you can easily refer to it from other Docker commands. For example, if you want to connect to a shell inside the server, you can use  docker exec -ti /bin/bash   With this syntax, there is no data persistance: all your test data will be lost every time you stop the server. This is a good way to prevent side effects and start on a clean base, with an empty database.  However, if you want to persist data, you have to mount two folders from the virtual server to local folders:  /usr/local/couchdb/data  (database) and  /data/cozy-storage  (the virtual filesystem). This can be achieved by adding to the command line  -v ~/cozy/data/db:/usr/local/couchdb/data -v ~/cozy/data/storage:/data/cozy-storage  which will store the server\u2019s data into  ~/cozy/data .  Once the server started, go to  http://app.cozy.tools:8080/# , connect to the server with the default password  cozy  and you should be able to start testing your application.  You can also access the following URLs:   http://cozy.tools:5984/_utils  to get the database administrative panel  http://cozy.tools:8025/  to display the emails sent by the server.", 
            "title": "Start the development server"
        }, 
        {
            "location": "/dev/app/#test-multiple-applications", 
            "text": "You can install more than one application into the development server, for example to test communication between applications. In order to achieve this, you have to mount the folder where your application leaves into subfolders of  /data/cozy-apps . For example, if the code of Cozy Drive and Cozy Photos is on your local filesystem in  ~/cozy/drive  and  ~/cozy/photos , start the development server with:  docker run --rm -it -p 8080:8080 -p 5984:5984 -p 8025:8025 -v  ~/cozy/drive :/data/cozy-app/drive  -v  ~/cozy/photos:/data-cozy-app/photos  --name=cozydev cozy/cozy-app-dev  You\u2019ll access the applications by connecting to  http://drive.cozy.tools:8080/  and  http://photos.cozy.tools:8080 .", 
            "title": "Test multiple applications"
        }, 
        {
            "location": "/dev/app/#todo", 
            "text": "This development server use the domain names  *.cozy.tools . We have parameterized this domain to always redirect to  127.0.0.1 , your local computer address.  The  sample  branch of this documentation repository contains a minimalist template with the needed files to create an app. You can get them with the following command:  git clone -b sample https://github.com/cozy/cozy-docdev-v3.git myapp\ncd myapp", 
            "title": "TODO"
        }, 
        {
            "location": "/dev/konnector/", 
            "text": "How to write a connector\n\n\nIntroduction\n\n\nA connector is a simple script which imports data from other web services and put it in your cozy.\nEach connector is an independant application, managed by the \nCozy Collect\n\napplication.\n\n\nTo protect your data, each connector runs inside a container in order to sandbox all their\ninteractions with your data.\n\n\nHow does it work ?\n\n\nA connector is a NodeJS script. The target node version used to run your connector is the\n\ncurrent LTS version\n (8 at the moment).\n\n\nLike client side apps, connectors communicate with the \nCozy Stack\n\nusing its API, and get an auth token every time they start. They need to register with a manifest,\nand ask permissions to the user.\n\n\nTo ease the development of a connector, a npm package, named \ncozy-konnector-libs\n\nprovides some shared libraries which are adapted to be used for a connector :\n\n\n\n\ncheerio\n to easily request html pages like jQuery\n\n\nrequest-promise\n: \nrequest\n wrapped in promises\n\n\nrequest-debug\n which displays all the requests and\n   responses in the standard output. Check \ndebug\n option in \nrequestFactory\n\n\n\n\nBut you may need some other npm packages not integrated in \ncozy-konnector-libs\n to help you run your connector :\n\n\n\n\nmomentjs\n or \ndate-fns\n to manage dates\n\n\nbluebird\n to get enhanced promises\n\n\n\n\nWhen the connector is started, it also gets some data through environment variables:\n\n\n\n\nCOZY_CREDENTIALS\n\u00a0: the auth token used by \ncozy-client-js\n to communicate with the server\n\n\nCOZY_URL\n\u00a0: the API entry point\n\n\nCOZY_FIELDS\n\u00a0: the settings coming from \nCozy Collect\n and filled by the user of the connector (login, password, directory path).\n\n\n\n\nThose variables are used by the BaseKonnector and the cozy-client to configure the connection to\nthe \nCozy Stack\n with the right permissions as defined in your manifest.konnector. These are\nsimulated in standalone mode so that you don\nt need a real cozy stack to develop your connector.\n\n\nMore information\n\n\nFrom the server point of view, each connector is a \njob\n that is run periodically via a \ntrigger\n. \nMore information\n\n\nLet\u2019s create our first connector\n\n\nThe easiest way to create a new connector is to use \ncozy-konnector-template\n:\n\n\ncozy-konnector-template\n and standalone mode\n\n\ngit clone https://github.com/cozy/cozy-konnector-template cozy-konnector-monservice\ncd cozy-konnector-monservice\nyarn # or npm install\n\n\n\n\nnote: the Cozy Team uses \nyarn\n, but if you prefer \nnpm\n, just keep using it, everything should just work.\n\n\nThe connector template is ready with demo code to show you how to scrape a fictional\nwebsite: \nbooks.toscrape.com\n, for which you do not need to have\ncredentials.\n\n\nAs indicated in the README, just run it:\n\n\nyarn standalone\n\n\n\n\nThe first run will create a \nkonnector-dev-config.json\n file which allows you to configure the input\nof the connector when running it in the CLI.\n\n\n{\n  \nCOZY_URL\n: \nhttp://cozy.tools:8080\n,\n  \nfields\n: {}\n}\n\n\n\n\nCOZY_URL\n is for later, but the \nfields\n attribute will allow you to define credentials to the\ntarget web service, like \nlogin\n and \npassword\n as if they would come from a real \nCozy Stack\n.\n\n\nThis way to run the connector is the \nstandalone\n mode. In this mode, \ncozyClient\n is stubbed and\nall data meant to be saved in a cozy is displayed in the standard output and files are directly\nsaved in the root directory of the connector. This is useful to first develop your connector\nwithout handling the state of a real \nCozy Stack\n.\n\n\nYou have more documentation about this in the \nCLI section of the documentation\n.\n\n\nConnector structure\n\n\nBasically, a connector is just a function passed to the BaseKonnector constructor, and which\neventually returns a promise:\n\n\nTo create the connector, just create a new instance of BaseKonnector with the function as argument\n\n\nconst {BaseKonnector} = require('cozy-konnector-libs')\n\nmodule.exports = new BaseKonnector(fields =\n {\n  // use fields to get user credentials and choices\n  console.log(fields, 'fields')\n})\n\n\n\n\nFetch operations\n\n\nEvery time the connector is run, it will call the function and wait for the resolution of the\nreturned promise. This function can then log into the remote site, fetch data and save it in the\nform of an array of objects with specific attributes expected by the different saving functions\n(\nsaveFiles\n, \naddData\n, \nfilterData\n, \nsaveBills\n).\n\n\nA basic connector workflow involves:\n\n\n\n\ngetting data and storing them into a variable. You can get the data by calling an API, scraping the remote website\u2026\n\n\nfiltering data to remove the ones already present inside the database using \nfilterData\n\n\nsave the filtered data into the database (\naddData\n)\n\n\nsave the related files using (\nsaveFiles\n)\n\n\n\n\nError handling\n\n\nIf your connector hits an issue fetching or saving the data, it can return an error code by throwing it as an error. The error codes are defined inside the \nCozy Collect\n application and will display an explicit error to the user:\n\n\n\n\nLOGIN_FAILED\n: the konnector could not login\n\n\nNOT_EXISTING_DIRECTORY\n: the folder specified as folder_to_save does not exist (checked automatically by the BaseKonnector)\n\n\nUNKNOWN_ERROR\n: there was an unexpected error, please take a look at the logs to know what appened\n\n\nVENDOR_DOWN\n: the target web site is down now\n\n\nUSER_ACTION_NEEDED\n: The user needs to login to the service to do manual actions (could be Terms Of Service to validate)\n\n\n\n\nYou can get the list of error codes in \nrequire('cozy-konnector-libs').errors\n\n\nconst {BaseKonnector, errors} = require('cozy-konnector-libs')\n\nmodule.exports = new BaseKonnector(fields =\n {\n    // Here, the following message will be displayed in cozy-collect : \nBad credentials. Check the konnector fields and run the connection again.\n\n    throw new Error(errors.LOGIN_FAILED)\n})\n\n\n\n\ncozy-konnector-libs\n\n\nThe Cozy Konnector Libs provide several useful methods for common tasks:\n\n\n\n\nBaseKonnector\n: creates the connector and fetches data\n\n\ncozyClient\n gives an instance of \ncozy-client-js\n already initialized according to \nCOZY_URL\n, and \nCOZY_CREDENTIALS\n\n\nrequestFactory\n a function which returns an instance of request-promise initialized with defaults often used in connector development.\n\n\nlog\n allows to log messages with different levels\n\n\nfilterData\n to filter data\n\n\naddData\n to add Data to the cozy\n\n\nlinkBankOperations\n to link a bill to a bank operation\n\n\nsaveBills\n which uses filterData, addData, saveFiles and linkBankOperations and which is specific to bills\n\n\nupdateOrCreate\n create or update documents inside database\n\n\n\n\nLinking with a cozy and dev mode\n\n\nOnce your connector is able to gather data from the targeted web service in standalone mode. Now is\nthe time to put this data in a real cozy. Here comes the dev mode.\n\n\nBut before doing that, your connector needs more setup : a \nmanifest.konnector\n file and\n\nkonnector-dev-config.json\ns \nCOZY_URL\n section.\n\n\nThe manifest\n\n\nEach connector is described by a manifest. This is a JSON file named \nmanifest.konnector\n at the root of your code folder. It should include the following minimal information:\n\n\n{\n  \nname\n: \nkonnector name\n,\n  \ntype\n: \nnode\n,\n  \nslug\n: \nkonnectorslug\n,\n  \ndescription\n: \ndescription\n,\n  \nsource\n: \ngit://github.com/cozy/cozy-konnector-thename.git\n,\n  \npermissions\n: {\n    \naccounts\n: {\n      \ndescription\n: \nRequired to get the account's data\n,\n      \ntype\n: \nio.cozy.accounts\n,\n      \nverbs\n: [\nGET\n]\n    }\n  }\n}\n\n\n\n\ncozy-konnector-template\n already has a manifest which you can customize.\n\n\nYou may add some permissions for your own doctype. \nHere\n is the detailed list of fields for a\nconnector manifest file.\n\n\nYou can also get more information on permissions in the official \ncozy-stack documentation\n\n\nkonnector-dev-config.json\n\n\nIf you want to put data from your connector to a real cozy, your must define where to find this\ncozy, and this must be a cozy for which you have the credentials.\n\n\nHere comes the \nCOZY_URL\n in konnector-dev-config.json which defines just that.\n\n\nThen you just have to run:\n\n\nyarn dev\n\n\n\n\nAnd for the first run, the CLI will open a tab in your browser asking you to give permissions to the\nconnector and the connector will save data directly in your cozy. This will validate that your\nmanifest has the needed permissions on the data you want to save.\n\n\nthis is the \ndev\n mode\n\n\nIntegration in cozy-collect for all the users\n\n\nTo run a connector, we do not want the cozy to install all dependencies of the connector each time\nit installs it.\n\n\nTo avoid this, the connectors need to be compiled into one file in a dedicated branch of the\nrepository and the repository needs to be a public git repository. The \npackage.json\n file\nfrom \ncozy-konnector-template\n gives you the commands to do this : \nyarn build\n and \nyarn deploy\n \nbut the last one needs to be configured in \npackage.json\n\n\nOnce your public git repository is configured, you only have to declare it.\n\n\nCozy will soon have a store for connectors and you will be able to publish connectors yourself. But\nat the moment, you need to declare your new connector on the \ncozy forum\n.\nThe Cozy team will review your code and add your connector to the \nCozy Collect\n application.\n\n\nFAQ\n\n\nWhen I run my connector, a ghost node process eats all my memory\n\n\nCozy-konnector-libs uses \ncheerio\n which is great but causes some problems\nwhen you try to console.log a cheerio object.\n\n\nIn standalone or dev mode, the BaseKonnector tries to catch errors and display a maximum of details\nabout them. But when the error contains a cheerio object, the problem happens.\n\n\nIf you get this problem, catch the error yourself and only display the message :\n\n\n.catch(err) {\n  console.log(err.message) // good\n  console.log(err) // bad\n}\n\n\n\n\nHow do I scrap a website\n\n\nUse the request function from \ncozy-konnector-libs\n with the proper options\n\n\nHere\u2019s a sample code that will fetch the login page to get the value of the anti-CSRF token, submit the login form, browse to the bills page and fetch a bill:\n\n\nconst {BaseKonnector, requestFactory} = require('cozy-konnector-libs')\nconst rq = requestFactory({\n  jar: true, // handle the cookies like a browser\n  json: false, // do not try to parse the result as a json document\n  cheerio: true // automatically parse the result with [cheerio](https://github.com/cheeriojs/cheerio)\n})\nconst moment = require('moment')\n\nmodule.exports = new BaseKonnector(function fetch (fields) {\n  return rq(\nhttps://login.remote.web\n)\n  .then($ =\n { // the result is automatically wrapped with cheerio and you can use it like jQuery\n    const form = {\n      form: {\n        login: fields.login,\n        password: fields.password,\n        csrf_token: $('[name=\ncsrf_token\n]').val(),\n      }\n    }\n    return rq({\n      method: 'POST',\n      form\n    })\n  })\n  .then($ =\n rq(\nhttps://admin.remote.web/bills\n))\n  .then($ =\n {\n    return [{date: moment($(\n#bill_date\n)), value: $(\n#bill_value\n)}]\n  })\n  .then(entries =\n addData(entries, 'io.cozy.bills'))\n})", 
            "title": "Develop a connector"
        }, 
        {
            "location": "/dev/konnector/#how-to-write-a-connector", 
            "text": "", 
            "title": "How to write a connector"
        }, 
        {
            "location": "/dev/konnector/#introduction", 
            "text": "A connector is a simple script which imports data from other web services and put it in your cozy.\nEach connector is an independant application, managed by the  Cozy Collect \napplication.  To protect your data, each connector runs inside a container in order to sandbox all their\ninteractions with your data.", 
            "title": "Introduction"
        }, 
        {
            "location": "/dev/konnector/#how-does-it-work", 
            "text": "A connector is a NodeJS script. The target node version used to run your connector is the current LTS version  (8 at the moment).  Like client side apps, connectors communicate with the  Cozy Stack \nusing its API, and get an auth token every time they start. They need to register with a manifest,\nand ask permissions to the user.  To ease the development of a connector, a npm package, named  cozy-konnector-libs \nprovides some shared libraries which are adapted to be used for a connector :   cheerio  to easily request html pages like jQuery  request-promise :  request  wrapped in promises  request-debug  which displays all the requests and\n   responses in the standard output. Check  debug  option in  requestFactory   But you may need some other npm packages not integrated in  cozy-konnector-libs  to help you run your connector :   momentjs  or  date-fns  to manage dates  bluebird  to get enhanced promises   When the connector is started, it also gets some data through environment variables:   COZY_CREDENTIALS \u00a0: the auth token used by  cozy-client-js  to communicate with the server  COZY_URL \u00a0: the API entry point  COZY_FIELDS \u00a0: the settings coming from  Cozy Collect  and filled by the user of the connector (login, password, directory path).   Those variables are used by the BaseKonnector and the cozy-client to configure the connection to\nthe  Cozy Stack  with the right permissions as defined in your manifest.konnector. These are\nsimulated in standalone mode so that you don t need a real cozy stack to develop your connector.  More information  From the server point of view, each connector is a  job  that is run periodically via a  trigger .  More information", 
            "title": "How does it work ?"
        }, 
        {
            "location": "/dev/konnector/#lets-create-our-first-connector", 
            "text": "The easiest way to create a new connector is to use  cozy-konnector-template :", 
            "title": "Let\u2019s create our first connector"
        }, 
        {
            "location": "/dev/konnector/#cozy-konnector-template-and-standalone-mode", 
            "text": "git clone https://github.com/cozy/cozy-konnector-template cozy-konnector-monservice\ncd cozy-konnector-monservice\nyarn # or npm install  note: the Cozy Team uses  yarn , but if you prefer  npm , just keep using it, everything should just work.  The connector template is ready with demo code to show you how to scrape a fictional\nwebsite:  books.toscrape.com , for which you do not need to have\ncredentials.  As indicated in the README, just run it:  yarn standalone  The first run will create a  konnector-dev-config.json  file which allows you to configure the input\nof the connector when running it in the CLI.  {\n   COZY_URL :  http://cozy.tools:8080 ,\n   fields : {}\n}  COZY_URL  is for later, but the  fields  attribute will allow you to define credentials to the\ntarget web service, like  login  and  password  as if they would come from a real  Cozy Stack .  This way to run the connector is the  standalone  mode. In this mode,  cozyClient  is stubbed and\nall data meant to be saved in a cozy is displayed in the standard output and files are directly\nsaved in the root directory of the connector. This is useful to first develop your connector\nwithout handling the state of a real  Cozy Stack .  You have more documentation about this in the  CLI section of the documentation .", 
            "title": "cozy-konnector-template and standalone mode"
        }, 
        {
            "location": "/dev/konnector/#connector-structure", 
            "text": "Basically, a connector is just a function passed to the BaseKonnector constructor, and which\neventually returns a promise:  To create the connector, just create a new instance of BaseKonnector with the function as argument  const {BaseKonnector} = require('cozy-konnector-libs')\n\nmodule.exports = new BaseKonnector(fields =  {\n  // use fields to get user credentials and choices\n  console.log(fields, 'fields')\n})", 
            "title": "Connector structure"
        }, 
        {
            "location": "/dev/konnector/#fetch-operations", 
            "text": "Every time the connector is run, it will call the function and wait for the resolution of the\nreturned promise. This function can then log into the remote site, fetch data and save it in the\nform of an array of objects with specific attributes expected by the different saving functions\n( saveFiles ,  addData ,  filterData ,  saveBills ).  A basic connector workflow involves:   getting data and storing them into a variable. You can get the data by calling an API, scraping the remote website\u2026  filtering data to remove the ones already present inside the database using  filterData  save the filtered data into the database ( addData )  save the related files using ( saveFiles )", 
            "title": "Fetch operations"
        }, 
        {
            "location": "/dev/konnector/#error-handling", 
            "text": "If your connector hits an issue fetching or saving the data, it can return an error code by throwing it as an error. The error codes are defined inside the  Cozy Collect  application and will display an explicit error to the user:   LOGIN_FAILED : the konnector could not login  NOT_EXISTING_DIRECTORY : the folder specified as folder_to_save does not exist (checked automatically by the BaseKonnector)  UNKNOWN_ERROR : there was an unexpected error, please take a look at the logs to know what appened  VENDOR_DOWN : the target web site is down now  USER_ACTION_NEEDED : The user needs to login to the service to do manual actions (could be Terms Of Service to validate)   You can get the list of error codes in  require('cozy-konnector-libs').errors  const {BaseKonnector, errors} = require('cozy-konnector-libs')\n\nmodule.exports = new BaseKonnector(fields =  {\n    // Here, the following message will be displayed in cozy-collect :  Bad credentials. Check the konnector fields and run the connection again. \n    throw new Error(errors.LOGIN_FAILED)\n})", 
            "title": "Error handling"
        }, 
        {
            "location": "/dev/konnector/#cozy-konnector-libs", 
            "text": "The Cozy Konnector Libs provide several useful methods for common tasks:   BaseKonnector : creates the connector and fetches data  cozyClient  gives an instance of  cozy-client-js  already initialized according to  COZY_URL , and  COZY_CREDENTIALS  requestFactory  a function which returns an instance of request-promise initialized with defaults often used in connector development.  log  allows to log messages with different levels  filterData  to filter data  addData  to add Data to the cozy  linkBankOperations  to link a bill to a bank operation  saveBills  which uses filterData, addData, saveFiles and linkBankOperations and which is specific to bills  updateOrCreate  create or update documents inside database", 
            "title": "cozy-konnector-libs"
        }, 
        {
            "location": "/dev/konnector/#linking-with-a-cozy-and-dev-mode", 
            "text": "Once your connector is able to gather data from the targeted web service in standalone mode. Now is\nthe time to put this data in a real cozy. Here comes the dev mode.  But before doing that, your connector needs more setup : a  manifest.konnector  file and konnector-dev-config.json s  COZY_URL  section.", 
            "title": "Linking with a cozy and dev mode"
        }, 
        {
            "location": "/dev/konnector/#the-manifest", 
            "text": "Each connector is described by a manifest. This is a JSON file named  manifest.konnector  at the root of your code folder. It should include the following minimal information:  {\n   name :  konnector name ,\n   type :  node ,\n   slug :  konnectorslug ,\n   description :  description ,\n   source :  git://github.com/cozy/cozy-konnector-thename.git ,\n   permissions : {\n     accounts : {\n       description :  Required to get the account's data ,\n       type :  io.cozy.accounts ,\n       verbs : [ GET ]\n    }\n  }\n}  cozy-konnector-template  already has a manifest which you can customize.  You may add some permissions for your own doctype.  Here  is the detailed list of fields for a\nconnector manifest file.  You can also get more information on permissions in the official  cozy-stack documentation", 
            "title": "The manifest"
        }, 
        {
            "location": "/dev/konnector/#konnector-dev-configjson", 
            "text": "If you want to put data from your connector to a real cozy, your must define where to find this\ncozy, and this must be a cozy for which you have the credentials.  Here comes the  COZY_URL  in konnector-dev-config.json which defines just that.  Then you just have to run:  yarn dev  And for the first run, the CLI will open a tab in your browser asking you to give permissions to the\nconnector and the connector will save data directly in your cozy. This will validate that your\nmanifest has the needed permissions on the data you want to save.  this is the  dev  mode", 
            "title": "konnector-dev-config.json"
        }, 
        {
            "location": "/dev/konnector/#integration-in-cozy-collect-for-all-the-users", 
            "text": "To run a connector, we do not want the cozy to install all dependencies of the connector each time\nit installs it.  To avoid this, the connectors need to be compiled into one file in a dedicated branch of the\nrepository and the repository needs to be a public git repository. The  package.json  file\nfrom  cozy-konnector-template  gives you the commands to do this :  yarn build  and  yarn deploy  \nbut the last one needs to be configured in  package.json  Once your public git repository is configured, you only have to declare it.  Cozy will soon have a store for connectors and you will be able to publish connectors yourself. But\nat the moment, you need to declare your new connector on the  cozy forum .\nThe Cozy team will review your code and add your connector to the  Cozy Collect  application.", 
            "title": "Integration in cozy-collect for all the users"
        }, 
        {
            "location": "/dev/konnector/#faq", 
            "text": "", 
            "title": "FAQ"
        }, 
        {
            "location": "/dev/konnector/#when-i-run-my-connector-a-ghost-node-process-eats-all-my-memory", 
            "text": "Cozy-konnector-libs uses  cheerio  which is great but causes some problems\nwhen you try to console.log a cheerio object.  In standalone or dev mode, the BaseKonnector tries to catch errors and display a maximum of details\nabout them. But when the error contains a cheerio object, the problem happens.  If you get this problem, catch the error yourself and only display the message :  .catch(err) {\n  console.log(err.message) // good\n  console.log(err) // bad\n}", 
            "title": "When I run my connector, a ghost node process eats all my memory"
        }, 
        {
            "location": "/dev/konnector/#how-do-i-scrap-a-website", 
            "text": "Use the request function from  cozy-konnector-libs  with the proper options  Here\u2019s a sample code that will fetch the login page to get the value of the anti-CSRF token, submit the login form, browse to the bills page and fetch a bill:  const {BaseKonnector, requestFactory} = require('cozy-konnector-libs')\nconst rq = requestFactory({\n  jar: true, // handle the cookies like a browser\n  json: false, // do not try to parse the result as a json document\n  cheerio: true // automatically parse the result with [cheerio](https://github.com/cheeriojs/cheerio)\n})\nconst moment = require('moment')\n\nmodule.exports = new BaseKonnector(function fetch (fields) {\n  return rq( https://login.remote.web )\n  .then($ =  { // the result is automatically wrapped with cheerio and you can use it like jQuery\n    const form = {\n      form: {\n        login: fields.login,\n        password: fields.password,\n        csrf_token: $('[name= csrf_token ]').val(),\n      }\n    }\n    return rq({\n      method: 'POST',\n      form\n    })\n  })\n  .then($ =  rq( https://admin.remote.web/bills ))\n  .then($ =  {\n    return [{date: moment($( #bill_date )), value: $( #bill_value )}]\n  })\n  .then(entries =  addData(entries, 'io.cozy.bills'))\n})", 
            "title": "How do I scrap a website"
        }, 
        {
            "location": "/dev/cordova/", 
            "text": "How to create a mobile Cozy application\n\n\nThe simplest way to create a mobile Cozy application is to use JavaScript as there already are JavaScript libraries to connect to the Cozy server, as known as cozy-stack.\n\n\nTherefore we will use the classical stack:\n\n\n\n\na JavaScript web application\n\n\nand cordova\n\n\n\n\n\n\nAt the end of this documentation\n, you will find \nhow-tos\n to help you with \ncordova configuration\n, \nwebpack builds\n and \ncordova deployments for Android and iOS\n.\n\n\n\n\nTo create \nyour first Cozy application\n, just follow the guide.\nAs you can read there, Cozy applications are served by the Cozy server, this is the way that Cozy applications retrieve a token to query data.\n\n\nIn the case of a mobile application, you need to retrieve a token differently. Hopefully we provide everything you need to do it easily.\n\n\nYou\nll need two libraries:\n\n\n\n\ncozy-client (\nsource\n)\n\n\ncozy-bar (\nsource\n)\n\n\n\n\n\n\nIn the case of Cozy web applications served by the Cozy server, these two libraries are injected in the html file with variables \n{{.CozyClientJS}}\n and \n{{.CozyBar}}\n.\n\n\n\n\nSetup index.html\n\n\nFirst thing first, add JavaScript libraries files into your \nindex.html\n:\n\n\n!DOCTYPE html\n\n\nhtml lang=\nen\n\n  \nhead\n\n    \nmeta charset=\nutf-8\n\n    \ntitle\nmobile Cozy application with Cordova\n/title\n\n    \nscript src=\ncozy-client.js\n/script\n\n    \nscript src=\ncozy-bar.js\n/script\n\n  \n/head\n\n  \nbody\n\n    \n!-- page content --\n\n  \n/body\n\n\n/html\n\n\n\n\nConnect to Cozy server\n\n\nWhen an user will start your mobile Cozy application, she/he will need to point to her/his server url to ask for permissions for her/his device.\n\n\nThis is done by our library \ncozy-client\n, you just need to add a HTML form:\n\n\nform id=\nform\n\n  \nlabel\nWhat is your cozy server url?\n    \ninput name=\nurl\n id=\nurl\n type=\ntext\n /\n\n  \n/label\n\n  \nbutton type=\nsubmit\nSubmit\n/button\n\n\n/form\n\n\n\n\nconst urlInput = document.getElementById(\nurl\n);\nconst form = document.getElementById(\nform\n);\nform.addEventListener(\nsubmit\n, registerClient);\nfunction registerClient (event) {\n  event.preventDefault();\n  const url = urlInput.value;\n  const { client, token } = await cozyClient.register(url);\n  // do whatever you need with client and token like persist\n}\n\n\n\n\nJS Bin on jsbin.com\n\n\nWhen \ncozyClient.register(url)\n is called, \nthe cordova inapp browser plugin\n is used to display a password request and a permission acceptation page to let the end-user to register her/his device.\n\n\nThat\ns all!\n\n\nThen you can use the cozy-client library as \nyou would within a classic Cozy application\n.\n\n\nInitialize the Cozy bar\n\n\nThe Cozy bar needs some information to be initialized and its initialization must be done in your front-end code:\n\n\ncozy.bar.init({\n  appName: \nApp Name\n,\n  appEditor: \nEditor Name\n,\n  iconPath: require(\n./assets/app-icon.svg\n),\n  lang: \nen-US\n,\n  replaceTitleOnMobile: true\n})\n\n\n\n\nUse Cordova\n\n\nInstall and setup cordova\n\n\nCordova is a tool\n to build Android and iOS applications from a web app.\n\n\nIt works with a CLI that needs \nnode\n.\nLook at the \ncordova documentation to install everything needed\n.\n\n\nOnce cordova is installed, just run \ncordova create cozy-app com.example.cozyapp CozyApp\n and you get the following structure: \n\n\n./\n\u251c\u2500\u2500 config.xml\n\u251c\u2500\u2500 hooks\n\u2502   \u2514\u2500\u2500 README.md\n\u251c\u2500\u2500 platforms\n\u251c\u2500\u2500 plugins\n\u2514\u2500\u2500 www\n    \u251c\u2500\u2500 css\n    \u2502   \u2514\u2500\u2500 index.css\n    \u251c\u2500\u2500 img\n    \u2502   \u2514\u2500\u2500 logo.png\n    \u251c\u2500\u2500 index.html\n    \u2514\u2500\u2500 js\n        \u2514\u2500\u2500 index.js\n\n7 directories, 6 files\n\n\n\n\nNote:\n everything you put in \nwww/\n will be served as your application content.\n\n\nConfigure your build tool\n\n\nIf you use a build tool to transpile your JavaScript code, you need to configure your tool to output the build into \nwww/\n.\n\n\nwebpack configuration\n\n\nAs \nWebpack is the most used build tool\n we will show you how to configure it with cordova:\n\n\nCreate a \nwebpack.config.js\n on the root folder of your project with:\n\n\nconst path = require('path');\n\nmodule.exports = {\n  entry: './src/app.js',\n  output: {\n    filename: 'bundle.js',\n    path.resolve(__dirname, 'www')\n  }\n}\n\n\n\n\nAnd add the output bundle in the \nwww/index.html\n file:\n\n\nhtml\n\n  \nhead\n\n    ...\n  \n/head\n\n  \nbody\n\n    ...\n    \nscript src=\nbundle.js\n/script\n\n  \n/body\n\n\n/html\n\n\n\n\nSee \nthe official webpack documentation\n for more details.\n\n\nCordova\n\n\nAndroid Platform\n\n\nUse \ncordova platform add android\n and check your environment with \ncordova requirements\n:\n\n\nA bad requirements check:\n\n\nRequirements check results for android:\nJava JDK: installed .\nAndroid SDK: installed\nAndroid target: not installed\nAndroid SDK not found. Make sure that it is installed. If it is not at the default location, set the ANDROID_HOME environment variable.\nGradle: installed\nError: Some of requirements check failed\n\n\n\n\nA good requirements check:\n\n\nRequirements check results for android:\nJava JDK: installed .\nAndroid SDK: installed\nAndroid target: installed android-19,android-21,android-22,android-23,Google Inc.:Google APIs:19,Google Inc.:Google APIs (x86 System Image):19,Google Inc.:Google APIs:23\nGradle: installed\n\n\n\n\nSee cordova, android and ios documentation to customize your development environment for your special needs.\n\n\nOnce everything is right, you could run \ncordova build\n and \ncordova run android\n to create an APK and push the APK on a device.\n\n\nNote:\n The device should be connected with usb.\nSee \nofficial android documentation for more details\n.\n\n\niOS development\n\n\nFor building an iOS app, you need \nxcode\n.\n\n\n[[more to come]]\n\n\nSee further details on \nthe cordova official documentation about iOS\n.", 
            "title": "Create a mobile app with cordova"
        }, 
        {
            "location": "/dev/cordova/#how-to-create-a-mobile-cozy-application", 
            "text": "The simplest way to create a mobile Cozy application is to use JavaScript as there already are JavaScript libraries to connect to the Cozy server, as known as cozy-stack.  Therefore we will use the classical stack:   a JavaScript web application  and cordova    At the end of this documentation , you will find  how-tos  to help you with  cordova configuration ,  webpack builds  and  cordova deployments for Android and iOS .   To create  your first Cozy application , just follow the guide.\nAs you can read there, Cozy applications are served by the Cozy server, this is the way that Cozy applications retrieve a token to query data.  In the case of a mobile application, you need to retrieve a token differently. Hopefully we provide everything you need to do it easily.  You ll need two libraries:   cozy-client ( source )  cozy-bar ( source )    In the case of Cozy web applications served by the Cozy server, these two libraries are injected in the html file with variables  {{.CozyClientJS}}  and  {{.CozyBar}} .", 
            "title": "How to create a mobile Cozy application"
        }, 
        {
            "location": "/dev/cordova/#setup-indexhtml", 
            "text": "First thing first, add JavaScript libraries files into your  index.html :  !DOCTYPE html  html lang= en \n   head \n     meta charset= utf-8 \n     title mobile Cozy application with Cordova /title \n     script src= cozy-client.js /script \n     script src= cozy-bar.js /script \n   /head \n   body \n     !-- page content -- \n   /body  /html", 
            "title": "Setup index.html"
        }, 
        {
            "location": "/dev/cordova/#connect-to-cozy-server", 
            "text": "When an user will start your mobile Cozy application, she/he will need to point to her/his server url to ask for permissions for her/his device.  This is done by our library  cozy-client , you just need to add a HTML form:  form id= form \n   label What is your cozy server url?\n     input name= url  id= url  type= text  / \n   /label \n   button type= submit Submit /button  /form  const urlInput = document.getElementById( url );\nconst form = document.getElementById( form );\nform.addEventListener( submit , registerClient);\nfunction registerClient (event) {\n  event.preventDefault();\n  const url = urlInput.value;\n  const { client, token } = await cozyClient.register(url);\n  // do whatever you need with client and token like persist\n}  JS Bin on jsbin.com  When  cozyClient.register(url)  is called,  the cordova inapp browser plugin  is used to display a password request and a permission acceptation page to let the end-user to register her/his device.  That s all!  Then you can use the cozy-client library as  you would within a classic Cozy application .", 
            "title": "Connect to Cozy server"
        }, 
        {
            "location": "/dev/cordova/#initialize-the-cozy-bar", 
            "text": "The Cozy bar needs some information to be initialized and its initialization must be done in your front-end code:  cozy.bar.init({\n  appName:  App Name ,\n  appEditor:  Editor Name ,\n  iconPath: require( ./assets/app-icon.svg ),\n  lang:  en-US ,\n  replaceTitleOnMobile: true\n})", 
            "title": "Initialize the Cozy bar"
        }, 
        {
            "location": "/dev/cordova/#use-cordova", 
            "text": "", 
            "title": "Use Cordova"
        }, 
        {
            "location": "/dev/cordova/#install-and-setup-cordova", 
            "text": "Cordova is a tool  to build Android and iOS applications from a web app.  It works with a CLI that needs  node .\nLook at the  cordova documentation to install everything needed .  Once cordova is installed, just run  cordova create cozy-app com.example.cozyapp CozyApp  and you get the following structure:   ./\n\u251c\u2500\u2500 config.xml\n\u251c\u2500\u2500 hooks\n\u2502   \u2514\u2500\u2500 README.md\n\u251c\u2500\u2500 platforms\n\u251c\u2500\u2500 plugins\n\u2514\u2500\u2500 www\n    \u251c\u2500\u2500 css\n    \u2502   \u2514\u2500\u2500 index.css\n    \u251c\u2500\u2500 img\n    \u2502   \u2514\u2500\u2500 logo.png\n    \u251c\u2500\u2500 index.html\n    \u2514\u2500\u2500 js\n        \u2514\u2500\u2500 index.js\n\n7 directories, 6 files  Note:  everything you put in  www/  will be served as your application content.", 
            "title": "Install and setup cordova"
        }, 
        {
            "location": "/dev/cordova/#configure-your-build-tool", 
            "text": "If you use a build tool to transpile your JavaScript code, you need to configure your tool to output the build into  www/ .", 
            "title": "Configure your build tool"
        }, 
        {
            "location": "/dev/cordova/#webpack-configuration", 
            "text": "As  Webpack is the most used build tool  we will show you how to configure it with cordova:  Create a  webpack.config.js  on the root folder of your project with:  const path = require('path');\n\nmodule.exports = {\n  entry: './src/app.js',\n  output: {\n    filename: 'bundle.js',\n    path.resolve(__dirname, 'www')\n  }\n}  And add the output bundle in the  www/index.html  file:  html \n   head \n    ...\n   /head \n   body \n    ...\n     script src= bundle.js /script \n   /body  /html  See  the official webpack documentation  for more details.", 
            "title": "webpack configuration"
        }, 
        {
            "location": "/dev/cordova/#cordova", 
            "text": "", 
            "title": "Cordova"
        }, 
        {
            "location": "/dev/cordova/#android-platform", 
            "text": "Use  cordova platform add android  and check your environment with  cordova requirements :  A bad requirements check:  Requirements check results for android:\nJava JDK: installed .\nAndroid SDK: installed\nAndroid target: not installed\nAndroid SDK not found. Make sure that it is installed. If it is not at the default location, set the ANDROID_HOME environment variable.\nGradle: installed\nError: Some of requirements check failed  A good requirements check:  Requirements check results for android:\nJava JDK: installed .\nAndroid SDK: installed\nAndroid target: installed android-19,android-21,android-22,android-23,Google Inc.:Google APIs:19,Google Inc.:Google APIs (x86 System Image):19,Google Inc.:Google APIs:23\nGradle: installed  See cordova, android and ios documentation to customize your development environment for your special needs.  Once everything is right, you could run  cordova build  and  cordova run android  to create an APK and push the APK on a device.  Note:  The device should be connected with usb.\nSee  official android documentation for more details .", 
            "title": "Android Platform"
        }, 
        {
            "location": "/dev/cordova/#ios-development", 
            "text": "For building an iOS app, you need  xcode .  [[more to come]]  See further details on  the cordova official documentation about iOS .", 
            "title": "iOS development"
        }, 
        {
            "location": "/dev/sendmail/", 
            "text": "Share and send mail in development\n\n\nCozy apps let users \nshare documents from cozy to cozy\n.\n\n\nMeet Alice and Bob.\nAlice wants to share a folder with Bob.\nAlice clicks on the share button and fills in the email input with Bob\ns email address.\nBob receives an email with a \n\u00ab Accept the sharing \u00bb\n button.\nBob clicks on that button and is redirected to Alice\ns cozy to enter his own cozy url to link both cozys.\nBob sees Alice\ns shared folder in his own cozy.\n\n\n\ud83e\udd14 But how could we do this scenario on development environment?\n\n\nWith the docker image\n\n\nIf you develop with the \ncozy-app-dev docker image\n, \nMailHog\n is running inside it to catch emails.\n\n\nIf cozy-stack has to send an email, MailHog catches it and exposes it on its web interface on http://cozy.tools:8025/.\n\n\nWith the binary cozy-stack\n\n\nIf you develop with the \ncozy-stack CLI\n, you have to run \nMailHog\n on your computer and tell \ncozy-stack serve\n where to find the mail server with some \noptions\n:\n\n\n./cozy-stack serve --appdir drive:../cozy-drive/build,settings:../cozy-settings/build --mail-disable-tls --mail-port 1025\n\n\n\n\nThis commands assumes you \ngit clone\n \ncozy-drive\n and \ncozy-settings\n in the same folder than you \ngit clone\n \ncozy-stack\n.\n\n\nThen simply run \nMailHog\n and open http://cozy.tools:8025/.\n\n\nRetrieve sent emails\n\n\nWith MailHog, \nevery email\n sent by cozy-stack is caught. That means the email address \ndoes not have to be a real one\n, ie. \nbob@cozy\n, \nbob@cozy.tools\n are perfectly fine. It \ncould be a real one\n, but the email will not reach the real recipient\ns inbox, say \ncontact@cozycloud.cc\n.", 
            "title": "How to send mail in development"
        }, 
        {
            "location": "/dev/sendmail/#share-and-send-mail-in-development", 
            "text": "Cozy apps let users  share documents from cozy to cozy .  Meet Alice and Bob.\nAlice wants to share a folder with Bob.\nAlice clicks on the share button and fills in the email input with Bob s email address.\nBob receives an email with a  \u00ab Accept the sharing \u00bb  button.\nBob clicks on that button and is redirected to Alice s cozy to enter his own cozy url to link both cozys.\nBob sees Alice s shared folder in his own cozy.  \ud83e\udd14 But how could we do this scenario on development environment?", 
            "title": "Share and send mail in development"
        }, 
        {
            "location": "/dev/sendmail/#with-the-docker-image", 
            "text": "If you develop with the  cozy-app-dev docker image ,  MailHog  is running inside it to catch emails.  If cozy-stack has to send an email, MailHog catches it and exposes it on its web interface on http://cozy.tools:8025/.", 
            "title": "With the docker image"
        }, 
        {
            "location": "/dev/sendmail/#with-the-binary-cozy-stack", 
            "text": "If you develop with the  cozy-stack CLI , you have to run  MailHog  on your computer and tell  cozy-stack serve  where to find the mail server with some  options :  ./cozy-stack serve --appdir drive:../cozy-drive/build,settings:../cozy-settings/build --mail-disable-tls --mail-port 1025  This commands assumes you  git clone   cozy-drive  and  cozy-settings  in the same folder than you  git clone   cozy-stack .  Then simply run  MailHog  and open http://cozy.tools:8025/.", 
            "title": "With the binary cozy-stack"
        }, 
        {
            "location": "/dev/sendmail/#retrieve-sent-emails", 
            "text": "With MailHog,  every email  sent by cozy-stack is caught. That means the email address  does not have to be a real one , ie.  bob@cozy ,  bob@cozy.tools  are perfectly fine. It  could be a real one , but the email will not reach the real recipient s inbox, say  contact@cozycloud.cc .", 
            "title": "Retrieve sent emails"
        }, 
        {
            "location": "/cozy-client-js/intro/", 
            "text": "{% raw %}\n\n\nIntroduction to cozy-client-js\n\n\nReminder about cozy architectures\n\n\nThere is two actives cozy architectures:\n\n\n\n\nThe first, thereafter named \nv2\n is the existing cozy structure. It\ns based on 1 container / user with many node.js processes in each container (cozy-data-system, cozy-proxy, cozy-home, 1 process per app).\n\n\nThe second, thereafter named \nv3\n is the new cozy-stack (\nrepository\n). It\ns based on go and aim to support multiple user on a single process.\n\n\n\n\nv2\n supported both \nserver-side\n applications with their own node.js process and \nclient-side\n applications which run in the user browser.\n\n\nv3\n will not support \nserver-side\n applications. We will support server side modules managed by server administrator, but the applications themselves will all be \nclient-side\n application.\n\n\nThis repository provides a library which allows you to build a \nclient-side\n application compatible with both version.\n\n\nThe former javascript library for making client-side application was \ncozy-browser-sdk\n. We aim to deprecate it once \ncozy-client-js\n reaches feature-parity.\n\n\nIf you already have an application using \ncozy-browser-sdk\n, you can see what will change in the \ntransition document\n. If you have any doubt, please open an issue!\n\n\nInclude the library in your application\n\n\nYou can \nimport\n/\nrequire\n cozy-client-js using npm \n webpack.\n\n\nYou can also copy-paste the \ndist/cozy-client.js\n bundle file into your application, and include it in your application \nindex.html\n with \nscript src=\"./cozy-client.js\"\n.\n\n\nIf you are developing a client-side app for Cozy V3, you can import the lib directly from the stack, by using \n{{.CozyClientJS}}\n.\n\n\nIf you are developing a nodejs app, you will need some polyfills. You can add them to your project with this command:\n\n\n$ yarn add isomorphic-fetch core-js regenerator-runtime btoa\n\n\n\n\nDoctypes \n Permissions\n\n\nA doctype is a simple javascript string identifying a type of document.\nSome basic doctypes are provided by cozy, but you can pick your own.\n\n\nCozy \nv3\n expects doctypes to be qualified to ensure uniqueness.\n\n\nAll doctypes designed by the cozy\ns team will be prefixed with \nio.cozy.\n, or \nio.cozy.labs.\n\n\nAny doctype you introduce is expected to be prefixed with the reverse notation of a domain you own (JLS#7.7). If you do not own a domain, you can also use a reverse notation of your email address.\n\n\nYou are free to reuse another applications documents by using their doctypes but you \nSHOULD\n discuss with the domain owner if you want to add fields or format them differently.\n\n\nTo ensure retrocompatibility, when used on stack v2, all known doctypes will be auto-prefixed, but a warning will be written to the console. Unknown doctype will cause a fatal error. DO NOT rely on this behaviour in new applications, use qualified doctypes.\n\n\n// contacts is a doctype defined by cozy\ncozyContactsDoctype = \nio.cozy.contacts\n\n// your application handle books, let's create a doctype\nmyBooksDoctype = \ncom.mydomain.book\n\n\n\n\nWhen you use a doctype, even one created by your application, you need to ask for its permission in your manifest. How to do it depends on which stack you are developping for.\n\n\nTODO\n Have some docs about \nv2\n package.json vs \nv3\n manifest.webapp\n\n\nPromises \n Callbacks\n\n\nAll cozy-client-js functions support callback or promise.\n\n\nIf no callback is provided, a promise is returned.\n\n\ncozy.client.data.create(myBooksDoctype, doc)\n    .then(function(result){ console.log('done', result); });\n    .catch(function(err){ console.log('fail', err); });\n\n\n\n\nIf your build pipeline supports it, use async/await for sweet sweet async\n\n\ntry {\n  result = await cozy.client.data.create(myBooksDoctype, doc)\n  console.log('done', result)\n} catch(err) {\n  console.log('fail', err)\n}\n\n\n\n\nIf for some reason you do not want to use promises, you can pass the \ndisablePromises\n flag to the init function. This way, you will be able to use the functions with a classic callback.\n\n\ncozy.client.init({ disablePromises: true })\ncozy.client.data.create(myBooksDoctype, doc, function(err, result) {\n    if (err) {\n      console.log('fail', err);\n    } else {\n      console.log('done', result);\n    }\n});\n\n undefined\n\n\n\n\nConstructor\n\n\nnew cozy.Client(options)\n\n\nnew cozy.Client(options)\n returns a new cozy client.\n\n\nIt does return a Cozy instance.\n\n\nIt takes the same options object as the \ncozy.client.init(options)\n function.\n\n\ncozy.client.init(options)\n\n\ncozy.client.init(options)\n setups initialize the global cozy instance.\n\n\nIt does not return a value.\n\n\n\n\noptions\n is an object with the following fields:\n\n\ncozyURL\n: absolute url of the cozy stack\n\n\ndisablePromises\n: boolean to make function that returns promise used with a classical \ncallback as last argument\n (default value is \nfalse\n)\n\n\noauth\n: an object with the OAuth parameters, see \nOAuth\n for details\n\n\nversion\n: the version of Cozy (2 or 3), it\ns optional, by default with a request to the server it can deduce automatically the version. (Must be specified for an offline mode)\n\n\n\n\ncozy.client.init({\n  cozyURL: 'http://cozy.tools:8080',\n  disablePromises: false,\n  version: 3,\n  oauth: {\n    clientParams: {/*...*/},\n    scopes: [\nio.cozy.files:GET\n],\n    onRegistered: (client, url) =\n { /* */ },\n    storage: new cozy.auth.LocalStorage(window.localStorage)\n  }\n})\n\n\n\n\nFuture APIs\n\n\nThis is the end of what we already have implemented, if you want to do something else (manipulating binary file, sharing, \n), you will have to wait a bit :smile:.\n\n\nFeel free to open an issue if you see something missing, or if you disagree with the API design !\n\n\n{% endraw %}", 
            "title": "Introduction"
        }, 
        {
            "location": "/cozy-client-js/intro/#introduction-to-cozy-client-js", 
            "text": "", 
            "title": "Introduction to cozy-client-js"
        }, 
        {
            "location": "/cozy-client-js/intro/#reminder-about-cozy-architectures", 
            "text": "There is two actives cozy architectures:   The first, thereafter named  v2  is the existing cozy structure. It s based on 1 container / user with many node.js processes in each container (cozy-data-system, cozy-proxy, cozy-home, 1 process per app).  The second, thereafter named  v3  is the new cozy-stack ( repository ). It s based on go and aim to support multiple user on a single process.   v2  supported both  server-side  applications with their own node.js process and  client-side  applications which run in the user browser.  v3  will not support  server-side  applications. We will support server side modules managed by server administrator, but the applications themselves will all be  client-side  application.  This repository provides a library which allows you to build a  client-side  application compatible with both version.  The former javascript library for making client-side application was  cozy-browser-sdk . We aim to deprecate it once  cozy-client-js  reaches feature-parity.  If you already have an application using  cozy-browser-sdk , you can see what will change in the  transition document . If you have any doubt, please open an issue!", 
            "title": "Reminder about cozy architectures"
        }, 
        {
            "location": "/cozy-client-js/intro/#include-the-library-in-your-application", 
            "text": "You can  import / require  cozy-client-js using npm   webpack.  You can also copy-paste the  dist/cozy-client.js  bundle file into your application, and include it in your application  index.html  with  script src=\"./cozy-client.js\" .  If you are developing a client-side app for Cozy V3, you can import the lib directly from the stack, by using  {{.CozyClientJS}} .  If you are developing a nodejs app, you will need some polyfills. You can add them to your project with this command:  $ yarn add isomorphic-fetch core-js regenerator-runtime btoa", 
            "title": "Include the library in your application"
        }, 
        {
            "location": "/cozy-client-js/intro/#doctypes-permissions", 
            "text": "A doctype is a simple javascript string identifying a type of document.\nSome basic doctypes are provided by cozy, but you can pick your own.  Cozy  v3  expects doctypes to be qualified to ensure uniqueness.  All doctypes designed by the cozy s team will be prefixed with  io.cozy. , or  io.cozy.labs.  Any doctype you introduce is expected to be prefixed with the reverse notation of a domain you own (JLS#7.7). If you do not own a domain, you can also use a reverse notation of your email address.  You are free to reuse another applications documents by using their doctypes but you  SHOULD  discuss with the domain owner if you want to add fields or format them differently.  To ensure retrocompatibility, when used on stack v2, all known doctypes will be auto-prefixed, but a warning will be written to the console. Unknown doctype will cause a fatal error. DO NOT rely on this behaviour in new applications, use qualified doctypes.  // contacts is a doctype defined by cozy\ncozyContactsDoctype =  io.cozy.contacts \n// your application handle books, let's create a doctype\nmyBooksDoctype =  com.mydomain.book  When you use a doctype, even one created by your application, you need to ask for its permission in your manifest. How to do it depends on which stack you are developping for.  TODO  Have some docs about  v2  package.json vs  v3  manifest.webapp", 
            "title": "Doctypes &amp; Permissions"
        }, 
        {
            "location": "/cozy-client-js/intro/#promises-callbacks", 
            "text": "All cozy-client-js functions support callback or promise.  If no callback is provided, a promise is returned.  cozy.client.data.create(myBooksDoctype, doc)\n    .then(function(result){ console.log('done', result); });\n    .catch(function(err){ console.log('fail', err); });  If your build pipeline supports it, use async/await for sweet sweet async  try {\n  result = await cozy.client.data.create(myBooksDoctype, doc)\n  console.log('done', result)\n} catch(err) {\n  console.log('fail', err)\n}  If for some reason you do not want to use promises, you can pass the  disablePromises  flag to the init function. This way, you will be able to use the functions with a classic callback.  cozy.client.init({ disablePromises: true })\ncozy.client.data.create(myBooksDoctype, doc, function(err, result) {\n    if (err) {\n      console.log('fail', err);\n    } else {\n      console.log('done', result);\n    }\n});  undefined", 
            "title": "Promises &amp; Callbacks"
        }, 
        {
            "location": "/cozy-client-js/intro/#constructor", 
            "text": "", 
            "title": "Constructor"
        }, 
        {
            "location": "/cozy-client-js/intro/#new-cozyclientoptions", 
            "text": "new cozy.Client(options)  returns a new cozy client.  It does return a Cozy instance.  It takes the same options object as the  cozy.client.init(options)  function.", 
            "title": "new cozy.Client(options)"
        }, 
        {
            "location": "/cozy-client-js/intro/#cozyclientinitoptions", 
            "text": "cozy.client.init(options)  setups initialize the global cozy instance.  It does not return a value.   options  is an object with the following fields:  cozyURL : absolute url of the cozy stack  disablePromises : boolean to make function that returns promise used with a classical  callback as last argument  (default value is  false )  oauth : an object with the OAuth parameters, see  OAuth  for details  version : the version of Cozy (2 or 3), it s optional, by default with a request to the server it can deduce automatically the version. (Must be specified for an offline mode)   cozy.client.init({\n  cozyURL: 'http://cozy.tools:8080',\n  disablePromises: false,\n  version: 3,\n  oauth: {\n    clientParams: {/*...*/},\n    scopes: [ io.cozy.files:GET ],\n    onRegistered: (client, url) =  { /* */ },\n    storage: new cozy.auth.LocalStorage(window.localStorage)\n  }\n})", 
            "title": "cozy.client.init(options)"
        }, 
        {
            "location": "/cozy-client-js/intro/#future-apis", 
            "text": "This is the end of what we already have implemented, if you want to do something else (manipulating binary file, sharing,  ), you will have to wait a bit :smile:.  Feel free to open an issue if you see something missing, or if you disagree with the API design !  {% endraw %}", 
            "title": "Future APIs"
        }, 
        {
            "location": "/cozy-client-js/browser-sdk-transition/", 
            "text": "How to transition your app from cozy-browser-sdk to cozy-client-js\n\n\nFull doctype qualification\n\n\nCozy \nv3\n expects \ndoctypes\n to be qualified to ensure uniqueness.\n\n\nAll doctypes designed by the cozy\ns team will be prefixed with \nio.cozy.\n\n\nAny doctype you introduce is expected to be prefixed with the reverse notation of a domain you own (JLS#7.7).\n\n\nYou are free to reuse another applications documents by using their doctypes but you SHOULD discuss with the domain owner if you want to add fields or format them differently.\n\n\nTo ensure retrocompatibility, when used on stack v2, all known doctypes will be auto-prefixed by \nio.cozy.\n or \nio.cozy.labs.\n, but a warning will be written to the console. Unknown doctype will cause a fatal error. DO NOT rely on this behaviour in new applications, use qualified doctypes.\n\n\n// old version, using cozy-browser-sdk\ncozysdk.create(\nContact\n, {})\ncozysdk.create(\nBook\n, {})\n// new version, with cozy-client-js\ncozy.data.create(\nio.cozy.contacts\n, {})\ncozy.data.create(\ncom.mydomain.book\n, {})\n\n\n\n\nMapReduce Views vs Mango queries\n\n\nCozy \nv3\n recommends using Couchdb 2 indexes \n mango queries instead of Couchdb 1.X map-reduce views. We feel they are \nsimpler to understand and explain\n and avoid useless overindexing.\n\n\nWhen used on a \nv2\n cozy, the \ndefineIndex\n and \nquery\n calls will be translated to MapReduce views.\n\n\nIf you need the full power of MapReduce, please open a issue on cozy-stack with your usecase.\n\n\n// cozy-browser-sdk\ncozysdk.defineMapReduceView('Event', 'all', function(doc) { emit(doc.year); })\ncozysdk.queryView('Event', 'all', {key: 2016, limit: 10})\n// cozy-client-js\nindex = cozy.data.defineIndex('Event', ['year'])\ncozy.data.query(index, {selector: {year: 2016}, limit: 10})\n\n\n\n\nBinaries\n\n\nWe do not yet have a plan for binaries attachments to documents.\nThey will be probably placed in the VFS under a special path.\n\n\nCrud is fully compatible\n\n\nThe following functions have the same signature than the cozy-browser-sdk\n\n\ncreated = await cozy.data.create(myType, book)\ndoc = await cozy.data.find(myType, id)\ndoc2 = await cozy.data.updateAttributes(myType, id, {year: 1851})\nawait cozy.data.destroy(\nmy.domain.book\n, id)", 
            "title": "Transition from cozy-browser-sdk"
        }, 
        {
            "location": "/cozy-client-js/browser-sdk-transition/#how-to-transition-your-app-from-cozy-browser-sdk-to-cozy-client-js", 
            "text": "", 
            "title": "How to transition your app from cozy-browser-sdk to cozy-client-js"
        }, 
        {
            "location": "/cozy-client-js/browser-sdk-transition/#full-doctype-qualification", 
            "text": "Cozy  v3  expects  doctypes  to be qualified to ensure uniqueness.  All doctypes designed by the cozy s team will be prefixed with  io.cozy.  Any doctype you introduce is expected to be prefixed with the reverse notation of a domain you own (JLS#7.7).  You are free to reuse another applications documents by using their doctypes but you SHOULD discuss with the domain owner if you want to add fields or format them differently.  To ensure retrocompatibility, when used on stack v2, all known doctypes will be auto-prefixed by  io.cozy.  or  io.cozy.labs. , but a warning will be written to the console. Unknown doctype will cause a fatal error. DO NOT rely on this behaviour in new applications, use qualified doctypes.  // old version, using cozy-browser-sdk\ncozysdk.create( Contact , {})\ncozysdk.create( Book , {})\n// new version, with cozy-client-js\ncozy.data.create( io.cozy.contacts , {})\ncozy.data.create( com.mydomain.book , {})", 
            "title": "Full doctype qualification"
        }, 
        {
            "location": "/cozy-client-js/browser-sdk-transition/#mapreduce-views-vs-mango-queries", 
            "text": "Cozy  v3  recommends using Couchdb 2 indexes   mango queries instead of Couchdb 1.X map-reduce views. We feel they are  simpler to understand and explain  and avoid useless overindexing.  When used on a  v2  cozy, the  defineIndex  and  query  calls will be translated to MapReduce views.  If you need the full power of MapReduce, please open a issue on cozy-stack with your usecase.  // cozy-browser-sdk\ncozysdk.defineMapReduceView('Event', 'all', function(doc) { emit(doc.year); })\ncozysdk.queryView('Event', 'all', {key: 2016, limit: 10})\n// cozy-client-js\nindex = cozy.data.defineIndex('Event', ['year'])\ncozy.data.query(index, {selector: {year: 2016}, limit: 10})", 
            "title": "MapReduce Views vs Mango queries"
        }, 
        {
            "location": "/cozy-client-js/browser-sdk-transition/#binaries", 
            "text": "We do not yet have a plan for binaries attachments to documents.\nThey will be probably placed in the VFS under a special path.", 
            "title": "Binaries"
        }, 
        {
            "location": "/cozy-client-js/browser-sdk-transition/#crud-is-fully-compatible", 
            "text": "The following functions have the same signature than the cozy-browser-sdk  created = await cozy.data.create(myType, book)\ndoc = await cozy.data.find(myType, id)\ndoc2 = await cozy.data.updateAttributes(myType, id, {year: 1851})\nawait cozy.data.destroy( my.domain.book , id)", 
            "title": "Crud is fully compatible"
        }, 
        {
            "location": "/cozy-client-js/offline/", 
            "text": "Offline support\n\n\nThis document describes in more details how to use this library in offline mode.\n\n\nAll applications do not require offline mode, and offline mode needs two dependencies : \npouchdb\n and \npouchdb-find\n.\nAs both are very large, we decide not to provide them by default, since v0.2.0.\n\n\nSo if your app needs to use offline mode, you have to add those dependencies by yourself. It means you just need to do:\n\n\n$/your-app\n yarn add pouchdb\n$/your-app\n yarn add pouchdb-find\n\n\n\n\nThen they will have to import \npouchdb\n and \npouchdbfind\n globally, as they are not imported in codebase anymore. This means adding the following configuration in all concerned webpack target files (for example \nwebpack.target.mobile.js\n) :\n\n\nmodule.exports = {\n  ...\n  plugins: [\n    new webpack.ProvidePlugin({\n      'PouchDB': 'pouchdb',\n      'pouchdbFind': 'pouchdb-find'\n    })\n  ]\n}\n\n\n\n\nThis same configuration has to be added in file \nwepback.config.prod.js\n, to make the build possible.\n\n\nIn prod, since \ncozy-client-js\n is injected by the stack, it has not been processed by \nwepback\n and the \nProvidePlugin\n. Thus you need to bind \nPouchDB\n to \nwindow\n.\n\n\n/* global PouchDB, pouchdbFind */\n// Bind PouchDB to window for cozy-client-js to find it\n// PouchDB is provided by webpack through ProvidedPlugin\nwindow.PouchDB = PouchDB\nwindow.pouchdbFind = pouchdbFind", 
            "title": "How to support offline"
        }, 
        {
            "location": "/cozy-client-js/offline/#offline-support", 
            "text": "This document describes in more details how to use this library in offline mode.  All applications do not require offline mode, and offline mode needs two dependencies :  pouchdb  and  pouchdb-find .\nAs both are very large, we decide not to provide them by default, since v0.2.0.  So if your app needs to use offline mode, you have to add those dependencies by yourself. It means you just need to do:  $/your-app  yarn add pouchdb\n$/your-app  yarn add pouchdb-find  Then they will have to import  pouchdb  and  pouchdbfind  globally, as they are not imported in codebase anymore. This means adding the following configuration in all concerned webpack target files (for example  webpack.target.mobile.js ) :  module.exports = {\n  ...\n  plugins: [\n    new webpack.ProvidePlugin({\n      'PouchDB': 'pouchdb',\n      'pouchdbFind': 'pouchdb-find'\n    })\n  ]\n}  This same configuration has to be added in file  wepback.config.prod.js , to make the build possible.  In prod, since  cozy-client-js  is injected by the stack, it has not been processed by  wepback  and the  ProvidePlugin . Thus you need to bind  PouchDB  to  window .  /* global PouchDB, pouchdbFind */\n// Bind PouchDB to window for cozy-client-js to find it\n// PouchDB is provided by webpack through ProvidedPlugin\nwindow.PouchDB = PouchDB\nwindow.pouchdbFind = pouchdbFind", 
            "title": "Offline support"
        }, 
        {
            "location": "/cozy-client-js/oauth/", 
            "text": "This document describes in more details how to use this library along with OAuth.\n\n\nBefore reading this document, to better understand how authentication and OAuth work on the cozy-stack, you should read \nthis document\n.\n\n\nThe library exposes internal methods to access the OAuth endpoints of the cozy-stack. See \ncozy.auth.* methods\n. However, the library also provides a more automated way to perform de OAuth flow by implementing many details of the OAuth registration and authorization flow for you.\n\n\nHere we describe the automated and stateful method.\n\n\nStorage\n\n\nTo handle the workflow automatically, the user of the library shoud pass a storage object that will be used to store the OAuth client and tokens informations.\n\n\nThis storage should implement the following \ninterface\n:\n\n\ninterface Storage {\n  load(key: string) : Promise\nany\n\n  save(key: string, value: any) : Promise\nany\n\n  delete(key: string) : Promise\nboolean\n\n  clear() : Promise\n\n}\n\n\n\n\nThe library provides two implementation of such storage:\n  - \ncozy.auth.MemoryStorage\n storing data in-memory\n  - \ncozy.auth.LocalStorage\n storage data in a html5 \nlocalStorage\n\n\nThe library constructor (on \ninit\n method) should be passed the storage in the \nstorage\n field of the \noauth\n options.\n\n\nRegistration parameters\n\n\nIn order to handle the registration of the client, two callbacks should be provided to the cozy-client-js instance.\n\n\n\n\nclientParams\n an object with the following parameters:\n\n\nredirectURI\n: the URI on which the user is redirected after accepting the client (mandatory)\n\n\nsoftwareID\n: identifier of the software (by default \ngithub.com/cozy/cozy-client-js\n)\n\n\nsoftwareVersion\n: version of the software (optional)\n\n\nclientName\n: string (optional)\n\n\nclientKind\n: string (optional)\n\n\nclientURI\n: string (optional)\n\n\nlogoURI\n: string (optional)\n\n\npolicyURI\n: string (optional)\n\n\nscopes\n: array of \nkey:value\n elements representing the permission scopes required by the application that the user should accept (mandatory)\n\n\n\n\n\n\nonRegistered(client, url)\n which should provide the wanted \nside effect\n after the client registration and return a promise containing the request URL provided by the user containing the access code and state.\n\n\n\n\nThe \nonRegistered\n callback is called with the registered client and the URL on which the user should go to give access to the application.\n\n\nComplete example for Node.JS\n\n\nHere is a complete example running on Node.JS with a local http server receiving as redirect URI receiving the call of the user to complete the authorization of the client.\n\n\nconst http = require('http');\nconst {Cozy,MemoryStorage} = require('./dist/cozy-client.node.js')\n\nfunction onRegistered(client, url) {\n  let server\n  return new Promise((resolve) =\n {\n    server = http.createServer((request, response) =\n {\n      if (request.url.indexOf('/do_access') === 0) {\n        console.log('Received access from user with url', request.url)\n        resolve(request.url)\n        response.end()\n      }\n    })\n    server.listen(3333, () =\n {\n      console.log('Please visit the following url to authorize the application: ', url)\n    })\n  })\n    .then(\n      (url) =\n { server.close(); return url; },\n      (err) =\n { server.close(); throw err; }\n    )\n}\n\nconst cozy = new Cozy({\n  cozyURL: 'http://cozy.tools:8080',\n  oauth: {\n    storage: new MemoryStorage(),\n    clientParams: {\n      redirectURI: 'http://localhost:3333/do_access',\n      softwareID: 'foobar',\n      clientName: 'client',\n      scopes: ['files/images:read']\n    },\n    onRegistered: onRegistered,\n  }\n})\n\ncozy.authorize().then((creds) =\n console.log(creds))", 
            "title": "OAuth guide"
        }, 
        {
            "location": "/cozy-client-js/oauth/#storage", 
            "text": "To handle the workflow automatically, the user of the library shoud pass a storage object that will be used to store the OAuth client and tokens informations.  This storage should implement the following  interface :  interface Storage {\n  load(key: string) : Promise any \n  save(key: string, value: any) : Promise any \n  delete(key: string) : Promise boolean \n  clear() : Promise \n}  The library provides two implementation of such storage:\n  -  cozy.auth.MemoryStorage  storing data in-memory\n  -  cozy.auth.LocalStorage  storage data in a html5  localStorage  The library constructor (on  init  method) should be passed the storage in the  storage  field of the  oauth  options.", 
            "title": "Storage"
        }, 
        {
            "location": "/cozy-client-js/oauth/#registration-parameters", 
            "text": "In order to handle the registration of the client, two callbacks should be provided to the cozy-client-js instance.   clientParams  an object with the following parameters:  redirectURI : the URI on which the user is redirected after accepting the client (mandatory)  softwareID : identifier of the software (by default  github.com/cozy/cozy-client-js )  softwareVersion : version of the software (optional)  clientName : string (optional)  clientKind : string (optional)  clientURI : string (optional)  logoURI : string (optional)  policyURI : string (optional)  scopes : array of  key:value  elements representing the permission scopes required by the application that the user should accept (mandatory)    onRegistered(client, url)  which should provide the wanted  side effect  after the client registration and return a promise containing the request URL provided by the user containing the access code and state.   The  onRegistered  callback is called with the registered client and the URL on which the user should go to give access to the application.", 
            "title": "Registration parameters"
        }, 
        {
            "location": "/cozy-client-js/oauth/#complete-example-for-nodejs", 
            "text": "Here is a complete example running on Node.JS with a local http server receiving as redirect URI receiving the call of the user to complete the authorization of the client.  const http = require('http');\nconst {Cozy,MemoryStorage} = require('./dist/cozy-client.node.js')\n\nfunction onRegistered(client, url) {\n  let server\n  return new Promise((resolve) =  {\n    server = http.createServer((request, response) =  {\n      if (request.url.indexOf('/do_access') === 0) {\n        console.log('Received access from user with url', request.url)\n        resolve(request.url)\n        response.end()\n      }\n    })\n    server.listen(3333, () =  {\n      console.log('Please visit the following url to authorize the application: ', url)\n    })\n  })\n    .then(\n      (url) =  { server.close(); return url; },\n      (err) =  { server.close(); throw err; }\n    )\n}\n\nconst cozy = new Cozy({\n  cozyURL: 'http://cozy.tools:8080',\n  oauth: {\n    storage: new MemoryStorage(),\n    clientParams: {\n      redirectURI: 'http://localhost:3333/do_access',\n      softwareID: 'foobar',\n      clientName: 'client',\n      scopes: ['files/images:read']\n    },\n    onRegistered: onRegistered,\n  }\n})\n\ncozy.authorize().then((creds) =  console.log(creds))", 
            "title": "Complete example for Node.JS"
        }, 
        {
            "location": "/cozy-client-js/auth-api/", 
            "text": "Authentication and OAuth (internal)\n\n\ncozy.client.auth.registerClient(clientParams)\n\n\nThis method is for internal or advanced usages. Please see \nOAuth document\n to see how to use OAuth with this library\n\n\ncozy.client.auth.registerClient\n is used to register a new client with the specified informations.\n\n\nIt returns a promise of the newly registered Client, along with a client secret and identifier.\n\n\n\n\nclientParams\n are client parameters: a non registered instance of \ncozy.client.auth.Client\n\n\n\n\nconst clientParams = new cozy.client.auth.Client({\n  redirectURI: 'http://localhost:3000/',\n  softwareID: 'mysoftware',\n  clientName: 'Great mobile App'\n})\nconst client = await cozy.client.auth.registerClient(clientParams)\nconst clientID = client.clientID\nconst clientSecret = client.clientSecret\n\n\n\n\ncozy.client.auth.updateClient(client, resetSecret = false)\n\n\nThis method is for internal or advanced usages. Please see \nOAuth document\n to see how to use OAuth with this library\n\n\ncozy.client.auth.updateClient\n is used to update informations about the oauth client.\n\n\nIt returns a promise for the updated Client.\n\n\n\n\nclient\n a registered instance of \ncozy.client.auth.Client\n\n\nresetSecret\n by setting \nresetSecret\n to \ntrue\n, a new Secret is generated.\n\n\n\n\nconst client = await cozy.client.auth.registerClient(clientParams)\n\n// change the client's version\nclient.softwareVersion = \nv1.2.3\n\nconst client = await cozy.client.auth.updateClient(client)\n\n\n// change the client secret\nconst client = await cozy.client.auth.updateClient(client, true)\n\n\n\n\ncozy.client.auth.unregisterClient(client)\n\n\nThis method is for internal or advanced usages. Please see \nOAuth document\n to see how to use OAuth with this library\n\n\ncozy.client.auth.unregisterClient\n is used to unregister a client.\n\n\nIt returns a promise for completion\n\n\n\n\nclient\n a registered instance of \ncozy.client.auth.Client\n\n\n\n\nconst client = await cozy.client.auth.registerClient(clientParams)\nawait cozy.auth.client.unregisterClient(client)\n\n\n\n\ncozy.auth.client.getClient(client)\n\n\nThis method is for internal or advanced usages. Please see \nOAuth document\n to see how to use OAuth with this library\n\n\ncozy.client.auth.getClient\n is used to fetch a registered client with the specified clientID and token.\n\n\nIt returns a promise of the client returned by the server.\n\n\n\n\nclient\n is a registered \ncozy.client.auth.Client\n\n\n\n\nconst client = await cozy.client.auth.getClient(new cozy.client.auth.Client({\n  clientID: '1235'\n}))\n\n\n\n\ncozy.client.auth.getAuthCodeURL(client, scopes)\n\n\nThis method is for internal or advanced usages. Please see \nOAuth document\n to see how to use OAuth with this library\n\n\ncozy.client.auth.getAuthCodeURL\n is used to generate the URL on which the user should go to give access to the application with the specified scopes.\n\n\nIt returns an object with the url and a generated random state that should be stored to be matched again for the token exchange phase.\n\n\n\n\nclient\n is a registered \ncozy.client.auth.Client\n\n\nscopes\n is an array of permission strings formatted as \nkey:access\n (like \nfiles/images:read\n)\n\n\n\n\nconst {url, state} = cozy.client.auth.getAuthCodeURL(client, ['files/images:read'])\n\n// save state and redirect to url\nlocalStorage.setItem(\noauthstate\n, state)\nwindow.location.replace(url)\n\n\n\n\ncozy.client.auth.getAccessToken(client, state, pageURL)\n\n\nThis method is for internal or advanced usages. Please see \nOAuth document\n to see how to use OAuth with this library\n\n\ncozy.client.auth.getAccessToken\n is used from the page on which the user should have redirected after authorizing the application.\n\n\nIt returns a promise of an \ncozy.client.auth.AccessToken\n. The method verifies that the specified state and the extracted one match. It then ask the server for a new access token and returns it.\n\n\n\n\nclient\n is a registered \ncozy.client.auth.Client\n\n\nstate\n is the previously stored state that is matched against to prevent CSRF attacks\n\n\npageURL\n is the url of the current page from the which a code and state will be extracted. If empty, \nwindow.location.href\n is used\n\n\n\n\nconst client = cozy.client.auth.getClient(/* ... */)\nconst state = localStorage.getItem(\noauthstate\n)\nconst pageURL = window.location.href\nconst token = cozy.client.auth.getAccessToken(client, state, pageURL)\n\n\n\n\ncozy.client.auth.refreshToken\n\n\nThis method is for internal or advanced usages. Please see \nOAuth document\n to see how to use OAuth with this library\n\n\ncozy.client.auth.refreshToken\n is used to refresh a token that is expired or no more valid.\n\n\n\n\nclient\n is a registered \ncozy.client.auth.Client\n\n\ntoken\n is a valid \ncozy.client.auth.AccessToken\n\n\n\n\nconst newtoken = cozy.client.auth.refreshToken(client, oldtoken)\n\n\n\n\ncozy.client.auth.Client\n\n\nThis class is for internal or advanced usages. Please see \nOAuth document\n to see how to use OAuth with this library\n\n\ncozy.client.auth.Client\n is a class representing an OAuth client. It can be registered, in which case it is known by the server and has a \nclientID\n and \nclientSecret\n.\n\n\ntype Client {\n  clientID: string;                // informed by server\n  clientSecret: string;            // informed by server\n  registrationAccessToken: string; // informed by server\n  redirectURI: string; // mandatory\n  softwareID: string;  // mandatory\n  softwareVersion: string;\n  clientName: string;  // mandatory\n  clientKind: string;\n  clientURI: string;\n  logoURI: string;\n  policyURI: string;\n  notificationPlatform: string;\n  notificationDeviceToken: string;\n}\n\n\n\n\nThe constructor type is as follow:\n\n\n\n\nurl\n is a string of the url of the cozy\n\n\noptions\n is an object with the same fields as a client object, or is an instance of client\n\n\n\n\nnew Client(url, options)\n\n\n\n\ncozy.client.auth.AccessToken\n\n\nThis class is for internal or advanced usages. Please see \nOAuth document\n to see how to use OAuth with this library\n\n\ncozy.client.auth.AccessToken\n is a class representing an OAuth access token.\n\n\ntype Token {\n  tokenType: string;\n  accessToken: string;\n  refreshToken: string;\n  scope: string\n}\n\n\n\n\nThe constructor takes an object with the same fields as a Token object.", 
            "title": "Authentication API"
        }, 
        {
            "location": "/cozy-client-js/auth-api/#authentication-and-oauth-internal", 
            "text": "", 
            "title": "Authentication and OAuth (internal)"
        }, 
        {
            "location": "/cozy-client-js/auth-api/#cozyclientauthregisterclientclientparams", 
            "text": "This method is for internal or advanced usages. Please see  OAuth document  to see how to use OAuth with this library  cozy.client.auth.registerClient  is used to register a new client with the specified informations.  It returns a promise of the newly registered Client, along with a client secret and identifier.   clientParams  are client parameters: a non registered instance of  cozy.client.auth.Client   const clientParams = new cozy.client.auth.Client({\n  redirectURI: 'http://localhost:3000/',\n  softwareID: 'mysoftware',\n  clientName: 'Great mobile App'\n})\nconst client = await cozy.client.auth.registerClient(clientParams)\nconst clientID = client.clientID\nconst clientSecret = client.clientSecret", 
            "title": "cozy.client.auth.registerClient(clientParams)"
        }, 
        {
            "location": "/cozy-client-js/auth-api/#cozyclientauthupdateclientclient-resetsecret-false", 
            "text": "This method is for internal or advanced usages. Please see  OAuth document  to see how to use OAuth with this library  cozy.client.auth.updateClient  is used to update informations about the oauth client.  It returns a promise for the updated Client.   client  a registered instance of  cozy.client.auth.Client  resetSecret  by setting  resetSecret  to  true , a new Secret is generated.   const client = await cozy.client.auth.registerClient(clientParams)\n\n// change the client's version\nclient.softwareVersion =  v1.2.3 \nconst client = await cozy.client.auth.updateClient(client)\n\n\n// change the client secret\nconst client = await cozy.client.auth.updateClient(client, true)", 
            "title": "cozy.client.auth.updateClient(client, resetSecret = false)"
        }, 
        {
            "location": "/cozy-client-js/auth-api/#cozyclientauthunregisterclientclient", 
            "text": "This method is for internal or advanced usages. Please see  OAuth document  to see how to use OAuth with this library  cozy.client.auth.unregisterClient  is used to unregister a client.  It returns a promise for completion   client  a registered instance of  cozy.client.auth.Client   const client = await cozy.client.auth.registerClient(clientParams)\nawait cozy.auth.client.unregisterClient(client)", 
            "title": "cozy.client.auth.unregisterClient(client)"
        }, 
        {
            "location": "/cozy-client-js/auth-api/#cozyauthclientgetclientclient", 
            "text": "This method is for internal or advanced usages. Please see  OAuth document  to see how to use OAuth with this library  cozy.client.auth.getClient  is used to fetch a registered client with the specified clientID and token.  It returns a promise of the client returned by the server.   client  is a registered  cozy.client.auth.Client   const client = await cozy.client.auth.getClient(new cozy.client.auth.Client({\n  clientID: '1235'\n}))", 
            "title": "cozy.auth.client.getClient(client)"
        }, 
        {
            "location": "/cozy-client-js/auth-api/#cozyclientauthgetauthcodeurlclient-scopes", 
            "text": "This method is for internal or advanced usages. Please see  OAuth document  to see how to use OAuth with this library  cozy.client.auth.getAuthCodeURL  is used to generate the URL on which the user should go to give access to the application with the specified scopes.  It returns an object with the url and a generated random state that should be stored to be matched again for the token exchange phase.   client  is a registered  cozy.client.auth.Client  scopes  is an array of permission strings formatted as  key:access  (like  files/images:read )   const {url, state} = cozy.client.auth.getAuthCodeURL(client, ['files/images:read'])\n\n// save state and redirect to url\nlocalStorage.setItem( oauthstate , state)\nwindow.location.replace(url)", 
            "title": "cozy.client.auth.getAuthCodeURL(client, scopes)"
        }, 
        {
            "location": "/cozy-client-js/auth-api/#cozyclientauthgetaccesstokenclient-state-pageurl", 
            "text": "This method is for internal or advanced usages. Please see  OAuth document  to see how to use OAuth with this library  cozy.client.auth.getAccessToken  is used from the page on which the user should have redirected after authorizing the application.  It returns a promise of an  cozy.client.auth.AccessToken . The method verifies that the specified state and the extracted one match. It then ask the server for a new access token and returns it.   client  is a registered  cozy.client.auth.Client  state  is the previously stored state that is matched against to prevent CSRF attacks  pageURL  is the url of the current page from the which a code and state will be extracted. If empty,  window.location.href  is used   const client = cozy.client.auth.getClient(/* ... */)\nconst state = localStorage.getItem( oauthstate )\nconst pageURL = window.location.href\nconst token = cozy.client.auth.getAccessToken(client, state, pageURL)", 
            "title": "cozy.client.auth.getAccessToken(client, state, pageURL)"
        }, 
        {
            "location": "/cozy-client-js/auth-api/#cozyclientauthrefreshtoken", 
            "text": "This method is for internal or advanced usages. Please see  OAuth document  to see how to use OAuth with this library  cozy.client.auth.refreshToken  is used to refresh a token that is expired or no more valid.   client  is a registered  cozy.client.auth.Client  token  is a valid  cozy.client.auth.AccessToken   const newtoken = cozy.client.auth.refreshToken(client, oldtoken)", 
            "title": "cozy.client.auth.refreshToken"
        }, 
        {
            "location": "/cozy-client-js/auth-api/#cozyclientauthclient", 
            "text": "This class is for internal or advanced usages. Please see  OAuth document  to see how to use OAuth with this library  cozy.client.auth.Client  is a class representing an OAuth client. It can be registered, in which case it is known by the server and has a  clientID  and  clientSecret .  type Client {\n  clientID: string;                // informed by server\n  clientSecret: string;            // informed by server\n  registrationAccessToken: string; // informed by server\n  redirectURI: string; // mandatory\n  softwareID: string;  // mandatory\n  softwareVersion: string;\n  clientName: string;  // mandatory\n  clientKind: string;\n  clientURI: string;\n  logoURI: string;\n  policyURI: string;\n  notificationPlatform: string;\n  notificationDeviceToken: string;\n}  The constructor type is as follow:   url  is a string of the url of the cozy  options  is an object with the same fields as a client object, or is an instance of client   new Client(url, options)", 
            "title": "cozy.client.auth.Client"
        }, 
        {
            "location": "/cozy-client-js/auth-api/#cozyclientauthaccesstoken", 
            "text": "This class is for internal or advanced usages. Please see  OAuth document  to see how to use OAuth with this library  cozy.client.auth.AccessToken  is a class representing an OAuth access token.  type Token {\n  tokenType: string;\n  accessToken: string;\n  refreshToken: string;\n  scope: string\n}  The constructor takes an object with the same fields as a Token object.", 
            "title": "cozy.client.auth.AccessToken"
        }, 
        {
            "location": "/cozy-client-js/data-api/", 
            "text": "Data API\n\n\ncozy.client.data.create(doctype, attributes)\n\n\ncozy.client.data.create(doctype, attributes)\n adds a document to the database.\n\n\nIt returns a promise for the created object. The created object has the same attributes than thoses passed, with an added \n_id\n. It\ns the unique identifier for the created document.\n\n\nIf you use an existing doctype, you should follow its expected format. \nv2\n does not enforce this, but we plan to on \nv3\n. Anyway, do you want to be the app that creates empty contacts in the native app ?\n\n\n\n\ndoctype\n is a string specifying the \ndoctype\n\n\nattributes\n is an object that can be stringified using \nJSON.stringify\n: if it is a complex or cyclic object, add a \ntoJSON\n method to it (native behaviour of \nJSON.stringify\n).\n\n\n\n\nWarning\n: on \nv3\n, an extra field \n_rev\n is added, it is the unique identifier for the document revision, after creation, it will be of the shape \n1-xxxxxxxxx\n for first revision.\n\n\n// simple object\nconst book = { title: \nMoby Dick\n, author:\nHerman Melville\n, isbn: \n42\n }\nconst created = await cozy.client.data.create(myBooksDoctype, book)\n// same fields\nconsole.log(created.title, created.author, created.isbn)\n// _id, _rev are added\nconsole.log(created._id, created._rev)\n// let's keep it for later\ncreatedBookId = created._id\n\n\n\n\ncozy.client.data.find(doctype, id)\n\n\ncozy.client.data.find(doctype, id)\n returns the document associated to the given ID.\n\n\nIt returns a promise for the document. It will have the same fields than the returned value of \ncreate\n, including \n_id\n and \n_rev\n.\n\n\nIf the document does not exist, the promise will be rejected or the callback will be passed an error.\n\n\n\n\ndoctype\n is a string specifying the \ndoctype\n\n\nid\n is a string specifying the identifier of the document you look for\n\n\n\n\nconst doc = await cozy.client.data.find(myBooksDoctype, createdBookId)\nconsole.log(doc._id, doc._rev, doc.title, doc.author, doc.isbn)\n\n\n\n\ncozy.client.data.findMany(doctype, [ids])\n\n\ncozy.client.data.findMany(doctype, [ids])\n returns the documents associated to the given IDs.\n\n\nIt returns a promise for a map, with the given IDs as keys.\n\n\nWhen a document is found, the corresponding value will be an object with a\nsingle \ndoc\n key containing the document.\nDocuments will have the same fields than the returned values of \ncreate\n,\nincluding \n_id\n and \n_rev\n.\n\n\nWhen a document is missing, the corresponding value will be an object with a\nsingle \nerror\n key containing the error message.\nEven when some document is missing, the promise will still be fulfilled or the\ncallback will be passed the resulting map, so you can still access the other\ndocuments found and identify the missing ones.\n\n\n\n\ndoctype\n is a string specifying the\n  \ndoctype\n\n\nids\n is an array of strings specifying the identifiers of the documents you\n  look for\n\n\n\n\nWarning\n: Not available on \nv2\n. A fallback implementation could be\nprovided at some point.\n\n\nconst ids = [createdBookId, ...]\nconst resultsById = await cozy.client.data.findMany(myBooksDoctype, ids)\nfor (const id of ids) {\n  const {doc, error} = resultsById[id]\n  if (error) {\n    console.error(`Error while fetching book ${id}: ${error}`)\n  } else {\n    console.log(doc._id, doc._rev, doc.title, doc.author, doc.isbn)\n  }\n}\n\n\n\n\ncozy.client.data.findAll(doctype)\n\n\ncozy.client.data.findAll(doctype)\n returns the all documents associated to the given doctype.\n\n\nIt returns a promise for a map, with the given IDs as keys.\n\n\nWhen a document is found, the corresponding value will be an object with a\nsingle \ndoc\n key containing the document.\nDocuments will have the same fields than the returned values of \ncreate\n,\nincluding \n_id\n and \n_rev\n.\n\n\n\n\ndoctype\n is a string specifying the\n  \ndoctype\n\n  look for\n\n\n\n\nWarning\n: Not available on \nv2\n. A fallback implementation could be\nprovided at some point.\n\n\nconst result = await cozy.client.data.findAll(myBooksDoctype)\nif (result.error) {\n    console.error('Error while fetching books')\n}\nfor (const id of result.keys) {\n    const doc = result.docs[id]\n    console.log(doc._id, doc._rev, doc.title, doc.author, doc.isbn)\n}\n\n\n\n\ncozy.client.data.changesFeed(doctype, options)\n\n\ncozy.client.data.changesFeed(doctype, options)\n returns the last changes from CouchDB for the given doctype\n\n\nIt returns a promise for the changes.\n\n\n\n\ndoctype\n is a string specifying the \ndoctype\n\n\noptions\n is an object, only its \nsince\n parameter is supported currently\n\n\n\n\nconst changes = await.cozy.client.data.changesFeed(myBooksDoctype, { since: 0 })\nconsole.log(changes.last_seq, changes.results)\n\n\n\n\ncozy.client.data.update(doctype, doc, newdoc)\n\n\ncozy.client.data.update(doctype, doc, newdoc)\n replaces the document by a new version.\n\n\nIt returns a promise for the updated document. The updated document will have the same fields and values than provided in newdoc, the same \n_id\n than doc, and a \n_rev\n incremented from doc\ns number.\n\n\nIf the document does not exist, the promise will reject with an error.\n\n\nIf the document current \n_rev\n does not match the passed one, it means there is a conflict and the promise is rejected with an error.\n\n\n\n\ndoctype\n is a string specifying the \ndoctype\n\n\ndoc\n is an object with \nat least\n the fields \n_id\n and \n_rev\n containing the identifier and revision of the file you want to update.\n\n\nnewdoc\n is an object, specifying the new content of the document\n\n\n\n\nconst updates = { title: \nMoby Dick !\n, author:\nTHE Herman Melville\n}\nconst updated = await cozy.client.data.update(myBooksDoctype, doc, updates)\nconsole.log(updated._id === doc._id) // _id does not change\nconsole.log(updated._rev) // 2-xxxxxx\nconsole.log(updated.title, updated.year) // fields are changed\nconsole.log(updated.isbn === undefined) // update erase fields\n\n\n\n\ncozy.client.data.updateAttributes(doctype, id, changes)\n\n\ncozy.client.data.updateAttributes(doctype, id, changes)\n applies change to the document.\n\n\nIt returns a promise for the updated document. The updated document will be the result of merging changes into the document with given \n_id\n and a incremented \n_rev\n.\n\n\nIf the document does not exist, the promise will be rejected or the callback will be passed an error.\n\n\nThis function gives 3 attempts not to conflict.\n\n\n\n\ndoctype\n is a string specifying the \ndoctype\n\n\nid\n is a string specifying the identifier of the document to update\n\n\nchanges\n is an object\n\n\n\n\nconst updates = { year: 1852}\nconst updated = await cozy.client.data.updateAttributes(myBooksDoctype, id, updates)\nconsole.log(updated._id === doc._id) // _id does not change\nconsole.log(updated._rev) // 3-xxxxxx\nconsole.log(updated.year) // fields are changed\nconsole.log(updated.isbn) // updateAttributes preserve other fields\n\n\n\n\ncozy.client.data.delete(doctype, doc)\n\n\ncozy.client.data.delete(doctype, doc )\n will erase the document from the database.\n\n\nIt returns a promise which will be resolved when the document has been deleted.\n\n\nIf the document does not exist, the promise will be rejected with an error. If the document current \n_rev\n does not match the passed one, it means there is a conflict and the promise is rejected with an error.\n\n\n\n\ndoctype\n is a string specifying the \ndoctype\n\n\ndoc\n is an object with \nat least\n the fields \n_id\n and \n_rev\n containing the identifier and revision of the file you want to destroy.\n\n\n\n\nawait cozy.client.data.delete(myBooksDoctype, updated)\n\n\n\n\ncozy.client.data.defineIndex(doctype, fields)\n\n\ncozy.client.data.defineIndex(doctype, fields)\n creates an index for a document type. It is idempotent, it can be called several time with no bad effect.\n\n\nIt returns a promise for an \nindexReference\n, which can be passed to \ncozy.data.query\n.\n\n\n\n\ndoctype\n is a string specifying the \ndoctype\n\n\nfields\n is an array of the fields name to index\n\n\n\n\nWarning\n: when used on \nv2\n, a map-reduce view is created internally, when used on \nv3\n, we use couchdb built-in mango queries.\n\n\nconst booksByYearRef = await cozy.client.data.defineIndex(myType, ['year', 'rating'])\n\n\n\n\ncozy.client.data.query(indexReference, query)\n\n\ncozy.client.data.query(indexReference, query)\n find documents using an index.\n\n\nIt returns a promise with a list of documents matching the query. Results will be returned in the order defined for the index.\n\n\n\n\nquery\n is an object with the following fields:\n\n\nselector\n: a mango selector\n\n\nlimit\n: maximum number of results\n\n\nskip\n: ignore the first x results (pagination)\n\n\nwholeResponse\n: when set to true, the whole query response will be returned instead of just the docs. This is useful when paginating, because you\nll get the \nnext\n property in the response object.\n\n\n\n\nWarning\n: complex mango queries are not compatible with \nv2\n\n\nconst results = await cozy.client.data.query(booksByYearRef, {\n  \nselector\n: {year: 1851},\n  \nlimit\n: 3,\n  \nskip\n: 1\n})\n\nresults.length == 3 // we limited to 3 results\nresuts[0]._id === doc._id\nresuts[0].title === \nMoby Dick\n\nresuts[0].rating \n 2 // lowest rating first", 
            "title": "Data System API"
        }, 
        {
            "location": "/cozy-client-js/data-api/#data-api", 
            "text": "", 
            "title": "Data API"
        }, 
        {
            "location": "/cozy-client-js/data-api/#cozyclientdatacreatedoctype-attributes", 
            "text": "cozy.client.data.create(doctype, attributes)  adds a document to the database.  It returns a promise for the created object. The created object has the same attributes than thoses passed, with an added  _id . It s the unique identifier for the created document.  If you use an existing doctype, you should follow its expected format.  v2  does not enforce this, but we plan to on  v3 . Anyway, do you want to be the app that creates empty contacts in the native app ?   doctype  is a string specifying the  doctype  attributes  is an object that can be stringified using  JSON.stringify : if it is a complex or cyclic object, add a  toJSON  method to it (native behaviour of  JSON.stringify ).   Warning : on  v3 , an extra field  _rev  is added, it is the unique identifier for the document revision, after creation, it will be of the shape  1-xxxxxxxxx  for first revision.  // simple object\nconst book = { title:  Moby Dick , author: Herman Melville , isbn:  42  }\nconst created = await cozy.client.data.create(myBooksDoctype, book)\n// same fields\nconsole.log(created.title, created.author, created.isbn)\n// _id, _rev are added\nconsole.log(created._id, created._rev)\n// let's keep it for later\ncreatedBookId = created._id", 
            "title": "cozy.client.data.create(doctype, attributes)"
        }, 
        {
            "location": "/cozy-client-js/data-api/#cozyclientdatafinddoctype-id", 
            "text": "cozy.client.data.find(doctype, id)  returns the document associated to the given ID.  It returns a promise for the document. It will have the same fields than the returned value of  create , including  _id  and  _rev .  If the document does not exist, the promise will be rejected or the callback will be passed an error.   doctype  is a string specifying the  doctype  id  is a string specifying the identifier of the document you look for   const doc = await cozy.client.data.find(myBooksDoctype, createdBookId)\nconsole.log(doc._id, doc._rev, doc.title, doc.author, doc.isbn)", 
            "title": "cozy.client.data.find(doctype, id)"
        }, 
        {
            "location": "/cozy-client-js/data-api/#cozyclientdatafindmanydoctype-ids", 
            "text": "cozy.client.data.findMany(doctype, [ids])  returns the documents associated to the given IDs.  It returns a promise for a map, with the given IDs as keys.  When a document is found, the corresponding value will be an object with a\nsingle  doc  key containing the document.\nDocuments will have the same fields than the returned values of  create ,\nincluding  _id  and  _rev .  When a document is missing, the corresponding value will be an object with a\nsingle  error  key containing the error message.\nEven when some document is missing, the promise will still be fulfilled or the\ncallback will be passed the resulting map, so you can still access the other\ndocuments found and identify the missing ones.   doctype  is a string specifying the\n   doctype  ids  is an array of strings specifying the identifiers of the documents you\n  look for   Warning : Not available on  v2 . A fallback implementation could be\nprovided at some point.  const ids = [createdBookId, ...]\nconst resultsById = await cozy.client.data.findMany(myBooksDoctype, ids)\nfor (const id of ids) {\n  const {doc, error} = resultsById[id]\n  if (error) {\n    console.error(`Error while fetching book ${id}: ${error}`)\n  } else {\n    console.log(doc._id, doc._rev, doc.title, doc.author, doc.isbn)\n  }\n}", 
            "title": "cozy.client.data.findMany(doctype, [ids])"
        }, 
        {
            "location": "/cozy-client-js/data-api/#cozyclientdatafindalldoctype", 
            "text": "cozy.client.data.findAll(doctype)  returns the all documents associated to the given doctype.  It returns a promise for a map, with the given IDs as keys.  When a document is found, the corresponding value will be an object with a\nsingle  doc  key containing the document.\nDocuments will have the same fields than the returned values of  create ,\nincluding  _id  and  _rev .   doctype  is a string specifying the\n   doctype \n  look for   Warning : Not available on  v2 . A fallback implementation could be\nprovided at some point.  const result = await cozy.client.data.findAll(myBooksDoctype)\nif (result.error) {\n    console.error('Error while fetching books')\n}\nfor (const id of result.keys) {\n    const doc = result.docs[id]\n    console.log(doc._id, doc._rev, doc.title, doc.author, doc.isbn)\n}", 
            "title": "cozy.client.data.findAll(doctype)"
        }, 
        {
            "location": "/cozy-client-js/data-api/#cozyclientdatachangesfeeddoctype-options", 
            "text": "cozy.client.data.changesFeed(doctype, options)  returns the last changes from CouchDB for the given doctype  It returns a promise for the changes.   doctype  is a string specifying the  doctype  options  is an object, only its  since  parameter is supported currently   const changes = await.cozy.client.data.changesFeed(myBooksDoctype, { since: 0 })\nconsole.log(changes.last_seq, changes.results)", 
            "title": "cozy.client.data.changesFeed(doctype, options)"
        }, 
        {
            "location": "/cozy-client-js/data-api/#cozyclientdataupdatedoctype-doc-newdoc", 
            "text": "cozy.client.data.update(doctype, doc, newdoc)  replaces the document by a new version.  It returns a promise for the updated document. The updated document will have the same fields and values than provided in newdoc, the same  _id  than doc, and a  _rev  incremented from doc s number.  If the document does not exist, the promise will reject with an error.  If the document current  _rev  does not match the passed one, it means there is a conflict and the promise is rejected with an error.   doctype  is a string specifying the  doctype  doc  is an object with  at least  the fields  _id  and  _rev  containing the identifier and revision of the file you want to update.  newdoc  is an object, specifying the new content of the document   const updates = { title:  Moby Dick ! , author: THE Herman Melville }\nconst updated = await cozy.client.data.update(myBooksDoctype, doc, updates)\nconsole.log(updated._id === doc._id) // _id does not change\nconsole.log(updated._rev) // 2-xxxxxx\nconsole.log(updated.title, updated.year) // fields are changed\nconsole.log(updated.isbn === undefined) // update erase fields", 
            "title": "cozy.client.data.update(doctype, doc, newdoc)"
        }, 
        {
            "location": "/cozy-client-js/data-api/#cozyclientdataupdateattributesdoctype-id-changes", 
            "text": "cozy.client.data.updateAttributes(doctype, id, changes)  applies change to the document.  It returns a promise for the updated document. The updated document will be the result of merging changes into the document with given  _id  and a incremented  _rev .  If the document does not exist, the promise will be rejected or the callback will be passed an error.  This function gives 3 attempts not to conflict.   doctype  is a string specifying the  doctype  id  is a string specifying the identifier of the document to update  changes  is an object   const updates = { year: 1852}\nconst updated = await cozy.client.data.updateAttributes(myBooksDoctype, id, updates)\nconsole.log(updated._id === doc._id) // _id does not change\nconsole.log(updated._rev) // 3-xxxxxx\nconsole.log(updated.year) // fields are changed\nconsole.log(updated.isbn) // updateAttributes preserve other fields", 
            "title": "cozy.client.data.updateAttributes(doctype, id, changes)"
        }, 
        {
            "location": "/cozy-client-js/data-api/#cozyclientdatadeletedoctype-doc", 
            "text": "cozy.client.data.delete(doctype, doc )  will erase the document from the database.  It returns a promise which will be resolved when the document has been deleted.  If the document does not exist, the promise will be rejected with an error. If the document current  _rev  does not match the passed one, it means there is a conflict and the promise is rejected with an error.   doctype  is a string specifying the  doctype  doc  is an object with  at least  the fields  _id  and  _rev  containing the identifier and revision of the file you want to destroy.   await cozy.client.data.delete(myBooksDoctype, updated)", 
            "title": "cozy.client.data.delete(doctype, doc)"
        }, 
        {
            "location": "/cozy-client-js/data-api/#cozyclientdatadefineindexdoctype-fields", 
            "text": "cozy.client.data.defineIndex(doctype, fields)  creates an index for a document type. It is idempotent, it can be called several time with no bad effect.  It returns a promise for an  indexReference , which can be passed to  cozy.data.query .   doctype  is a string specifying the  doctype  fields  is an array of the fields name to index   Warning : when used on  v2 , a map-reduce view is created internally, when used on  v3 , we use couchdb built-in mango queries.  const booksByYearRef = await cozy.client.data.defineIndex(myType, ['year', 'rating'])", 
            "title": "cozy.client.data.defineIndex(doctype, fields)"
        }, 
        {
            "location": "/cozy-client-js/data-api/#cozyclientdataqueryindexreference-query", 
            "text": "cozy.client.data.query(indexReference, query)  find documents using an index.  It returns a promise with a list of documents matching the query. Results will be returned in the order defined for the index.   query  is an object with the following fields:  selector : a mango selector  limit : maximum number of results  skip : ignore the first x results (pagination)  wholeResponse : when set to true, the whole query response will be returned instead of just the docs. This is useful when paginating, because you ll get the  next  property in the response object.   Warning : complex mango queries are not compatible with  v2  const results = await cozy.client.data.query(booksByYearRef, {\n   selector : {year: 1851},\n   limit : 3,\n   skip : 1\n})\n\nresults.length == 3 // we limited to 3 results\nresuts[0]._id === doc._id\nresuts[0].title ===  Moby Dick \nresuts[0].rating   2 // lowest rating first", 
            "title": "cozy.client.data.query(indexReference, query)"
        }, 
        {
            "location": "/cozy-client-js/files-api/", 
            "text": "Files API\n\n\ncozy.client.files.create(data, options)\n\n\ncozy.client.files.create(data, options)\n is used to upload a new file onto your cozy\n\n\nIt returns a promise for the document of the file created.\n\n\n\n\ndata\n can be of the following type: \nBlob\n, \nFile\n, \nArrayBuffer\n, \nArrayBufferView\n, \nstream.Readable\n (node) or \nstring\n.\n\n\noptions\n is an object with the following fields:\n\n\nname\n: specify the name of the file. optional for a data of type \nFile\n, type, mandatory otherwise.\n\n\ndirID\n: specify identifier of the file\ns directory. if empty, it is the root directory.\n\n\ncontentType\n: specify the content type of the uploaded data. For a \nFile\n type, it is handled automatically in browsers (default: \napplication/octet-stream\n). For nodejs, you can rely on an external module like \nmime\n\n\nchecksum\n: the base64-encoded (with padding) MD5 digest of the file (optional).\n\n\nlastModifiedDate\n: a date to specify the last modification time to use for the uploaded file. If the given \ndata\n is a \nFile\n instance, the \nlastModifiedDate\n is automatically used (not overridden).\n\n\n\n\nWarning\n: this API is not v2 compatible.\n\n\nconst created = await cozy.client.files.create(blob, {\n    name: \nfilename\n,\n    dirID: \n123456\n,\n})\nconst fileCreated = await cozy.client.files.create(fileInput.files[0], {\n  dirID: \n,\n  checksum: \nrL0Y20zC+Fzt72VPzMSk2A==\n,\n  lastModifiedDate: new Date()\n})\n\n\n\n\ncozy.client.files.createDirectory(options)\n\n\ncozy.client.files.createDirectory(options)\n is used to create a new directory.\n\n\nIt returns a promise for the document of the directory created.\n\n\n\n\noptions\n is an object with the following fields:\n\n\nname\n: specify the name of the directory\n\n\ndirID\n: specify identifier of the file\ns directory. if empty, it is the root directory.\n\n\nlastModifiedDate\n: a date to specify the last modification time to use for the directory.\n\n\n\n\nconst created = await cozy.client.files.createDirectory({\n  name: \nmydir\n,\n  dirID: \n123456\n,\n  lastModifiedDate: new Date()\n})\n\n\n\n\ncozy.client.files.createDirectoryByPath(path)\n\n\ncozy.client.files.createDirectoryByPath(path)\n is used to create one or more directories for a given path.\n\n\nIt returns a promise for the document of the last directory created.\n\n\n\n\npath\n is a string\n\n\n\n\nconst barDirectory = await cozy.client.files.createDirectoryByPath('/Foo/Bar')\n\n\n\n\ncozy.client.files.updateById(id, data, options)\n\n\ncozy.client.files.updateById(id, data, options)\n is used to update the content of an already existing file.\n\n\nIt returns a promise for the document of the file updated.\n\n\n\n\nid\n is a string specifying the identifier of the file to modify.\n\n\ndata\n can be of the following type: \nBlob\n, \nFile\n, \nArrayBuffer\n, \nArrayBufferView\n or \nstring\n.\n\n\noptions\n is an object with the following fields:\n\n\ncontentType\n: specify the content type of the uploaded data. For a \nFile\n type, it is be handled automatically. default: \napplication/octet-stream\n.\n\n\nchecksum\n: the base64-encoded (with padding) MD5 digest of the file (optional).\n\n\nlastModifiedDate\n: a date to specify the last modification time to use for the uploaded file. If the given \ndata\n is a \nFile\n instance, the \nlastModifiedDate\n is automatically used (not overridden).\n\n\nifMatch\n: the previous revision of the file (optional). The update will be rejected if the remote revision doesn\nt match the given one.\n\n\n\n\nconst updated = await cozy.client.files.updateById(\n654321\n, blob, {\n  contentType: \ntext/plain\n,\n  checksum: \nrL0Y20zC+Fzt72VPzMSk2A==\n,\n  lastModifiedDate: new Date(),\n  ifMatch: \n1-0e6d5b72\n\n})\n\n\n\n\ncozy.client.files.updateAttributesById(id, attrs, options)\n\n\ncozy.client.files.updateAttributesById(id, attrs, options)\n is used to update the attributes associated to a file or directory specified by its id.\n\n\nIt returns a promise for the document of the updated directory or file.\n\n\n\n\nid\n is a string specifying the identifier of the file or directory to update\n\n\nattrs\n is an object containing the changes\n\n\noptions\n is an object with the following fields:\n\n\nifMatch\n: the previous revision of the file (optional). The update will be rejected if the remote revision doesn\nt match the given one.\n\n\n\n\nconst updated = await cozy.client.files.updateAttributesById(\n12345\n, { tags: [\nfoo\n] }, { ifMatch: \n1-0e6d5b72\n })\n\n\n\n\ncozy.client.files.updateAttributesByPath(path, attrs, options)\n\n\ncozy.client.files.updateAttributesByPath(path, attrs, options)\n is used to update the attributes associated to a file or directory specified by the given path.\n\n\nIt returns a promise for the document of the updated directory or file.\n\n\n\n\npath\n: string specifying the path of the file or directory to update\n\n\nattrs\n is an object containing the changes\n\n\noptions\n is an object with the following fields:\n\n\nifMatch\n: the previous revision of the file (optional). The update will be rejected if the remote revision doesn\nt match the given one.\n\n\n\n\nconst updated = await cozy.client.files.updateAttributes(\n/foo/bar\n, { executable: true }, { ifMatch: \n1-0e6d5b72\n })\n\n\n\n\ncozy.client.files.statById(id, offline, options)\n\n\ncozy.client.files.statById(id, offline, options)\n is used to get the metadata of a file specified by its id.\n\n\nIt returns a promise for the information of the file or directory. In the case of a directory, it contains the list of files and sub-directories inside it. This list is limited to 30 items by default, but the \noptions\n argument allows you\nto fetch more items.\n\n\n\n\nid\n is a string specifying the file\u2019s or directory\u2019s identifier\n\n\noffline\n is a boolean (default to \ntrue\n)\n\n\noptions\n is an object with the following fields:\n\n\nskip\n: number of items to skip (optional)\n\n\nlimit\n: maximum number of items to return (optional).\n\n\n\n\nBy default, \nstatById\n will fetch the metadata from the local database, if it is available. Set the second parameter to \nfalse\n to query the server.\n\n\nReturned directory have a \nrelations()\n method that allow to access to their content:\n\n\nconst dir = await cozy.client.files.statById(\nio.cozy.files.root-dir\n);\ndir.relations('contents').forEach( (file) =\n \u2026 )\n\n\n\n\ncozy.client.files.statByPath(path)\n\n\ncozy.client.files.statByPath(path)\n is used to get the metadata of a file specified by its path.\n\n\n\n\npath\n: string specifying the path of the file or directory;\n\n\n\n\ncozy.client.files.trashById(id, options)\n\n\ncozy.client.files.trashById(id, options)\n is used to move the file or directory identified by the given id to trash.\n\n\nIt returns a promise for the document of the file or directory moved to trash.\n\n\n\n\nid\n is a string specifying the identifier of the file or directory\n\n\noptions\n is an object with the following fields:\n\n\nifMatch\n: the previous revision of the file (optional). The update will be rejected if the remote revision doesn\nt match the given one.\n\n\n\n\nconst trashed = await cozy.client.files.trashById(\n1234567\n)\n\n\n\n\ncozy.client.files.destroyById(id, options)\n\n\ncozy.client.files.destroyById(id, options)\n is used to shred (destroy definitively) a file or directory identified by the given id.\n\n\nThe file must be in the trash folder first.\n\n\nIt returns a promise for completion\n\n\n\n\nid\n is a string specifying the identifier of the file or directory\n\n\noptions\n is an object with the following fields:\n\n\nifMatch\n: the previous revision of the file (optional). The update will be rejected if the remote revision doesn\nt match the given one.\n\n\n\n\nconst trashed = await cozy.client.files.trashById(\n1234567\n)\nawait cozy.client.files.destroyById(\n1234567\n)\n\n\n\n\ncozy.client.files.restoreById(id)\n\n\ncozy.client.files.restoreById(id)\n is used to restore a file or directory identified by the given id. The file must be in the trash folder.\n\n\nIt returns a promise for the restored doc. (with updated parent)\n\n\n\n\nid\n is a string specifying the identifier of the file or directory\n\n\n\n\nconst trashed = await cozy.client.files.trashById(\n1234567\n)\nconst restored = await cozy.client.files.restoreById(\n1234567\n)\n\n\n\n\ncozy.client.files.listTrash()\n\n\ncozy.client.files.listTrash()\n returns a promise for the list of all files in the trash.\n\n\nconst trashedFilesAndFolders = await cozy.client.files.listTrash()\n\n\n\n\ncozy.client.files.clearTrash()\n\n\ncozy.client.files.clearTrash()\n destroys definitively all trash content.\n\n\nawait cozy.client.files.clearTrash()\n\n\n\n\ncozy.client.files.downloadById(id)\n\n\ncozy.client.files.downloadById(id)\n is used to download a file identified by the given id. The file is downloaded through the browser fetch method, use this if you plan to use the file in javascript after.\n\n\nIt returns a promise of a fetch \nResponse\n object. This response object can be used to extract the information in the wanted form.\n\n\n\n\nid\n is a string specifying the identifier of the file\n\n\n\n\nconst response = await cozy.client.files.downloadById(\n1234567\n)\nconst blob = await response.blob()\nconst text = await response.text()\nconst buff = await response.arrayBuffer()\nresponse.pipe(fs.createWriteStream('/some/file'))\n\n\n\n\ncozy.client.files.downloadByPath(path)\n\n\ncozy.client.files.downloadByPath(path)\n is used to download a file identified by the given path. The file is downloaded through the browser fetch method, use this if you plan to use the file in javascript after.\n\n\nIt returns a promise of a fetch \nResponse\n object. This response object can be used to extract the information in the wanted form.\n\n\n\n\npath\n is a string specifying the path of the file\n\n\n\n\nconst response = await cozy.client.files.downloadByPath(\n/foo/hello.txt\n)\nconst blob = await response.blob()\nconst text = await response.text()\nconst buff = await response.arrayBuffer()\nresponse.pipe(fs.createWriteStream('/some/file'))\n\n\n\n\ncozy.client.files.getDownloadLinkById(id)\n\n\ncozy.client.files.getDownloadLinkById(id)\n is used to get a download link for the file identified by the given id.\n\n\nIt returns a promise for the download link.\nDownload link are only valid for a short while (default 1 hour)\nYou can use this link to start a browser download like this:\n\n\nconst href = await cozy.client.files.getDownloadLinkById(\nid424242\n)\nconst link = document.createElement('a')\nlink.href = href\nlink.download = fileName\ndocument.body.appendChild(link) \n link.click()\n\n\n\n\n\n\nid\n is a string specifying the id of the file\n\n\n\n\ncozy.client.files.getDownloadLinkByPath(path)\n\n\ncozy.client.files.getDownloadLinkByPath(path)\n is used to get a download link for the file identified by the given path.\n\n\nIt returns a promise for the download link.\nDownload link are only valid for a short while (default 1 hour)\nYou can use this link to start a browser download like this:\n\n\nconst href = await cozy.client.files.getDownloadLinkByPath(\n/foo/hello.txt\n)\nconst link = document.createElement('a')\nlink.href = href\nlink.download = fileName\ndocument.body.appendChild(link) \n link.click()\n\n\n\n\n\n\npath\n is a string specifying the path of the file\n\n\n\n\ncozy.client.files.getArchiveLinkByPaths(paths, name)\n\n\ncozy.client.files.getArchiveLinkByPaths(paths, name)\n is used to get a download link for a zip file containing all the files identified by the given paths.\n\n\nIt returns a promise for the download link.\nDownload link are only valid for a short while (default 1 hour)\nYou can use this link to start a browser download (see code in getDownloadLinkById)\n\n\nconst href = await cozy.client.files.getArchiveLinkByPaths([\n  \n/foo/hello.txt\n,\n  \n/bar/test.txt\n\n])\n// href === \n/files/archive/b1c127c25d99f0b37ac2c2a907f36069/files.zip\n\n\nconst href = await cozy.client.files.getArchiveLinkByPaths([\n/foo/hello.txt\n], \nsecretproject\n)\n// href === \n/files/archive/bc2a901c127c25d99f0b37a36069c27f/secretproject.zip\n\n\n\n\n\n\npaths\n is an array of paths\n\n\nname\n is the optional name for the generated archive file (default \nfiles\n).\n\n\n\n\ncozy.client.files.getArchiveLinkByIds(ids, name)\n\n\ncozy.client.files.getArchiveLinkByIds(ids, name)\n is used to get a download link for a zip file containing all the files identified by the given ids.\n\n\nIt returns a promise for the download link.\nDownload link are only valid for a short while (default 1 hour)\nYou can use this link to start a browser download (see code in getDownloadLinkById)\n\n\nconst href = await cozy.client.files.getArchiveLinkByIds([\n  \n1234567\n,\n  \n9876543\n\n])\n// href === \n/files/archive/b1c127c25d99f0b37ac2c2a907f36069/files.zip\n\n\nconst href = await cozy.client.files.getArchiveLinkByIds([\n1592673\n], \nsecretproject\n)\n// href === \n/files/archive/bc2a901c127c25d99f0b37a36069c27f/secretproject.zip\n\n\n\n\n\n\nids\n is an array of ids\n\n\nname\n is the optional name for the generated archive file (default \nfiles\n).\n\n\n\n\ncozy.client.files.getFilePath(file, folder)\n\n\ncozy.client.files.getFilePath(file, folder)\n is a helper that generates the file path from root directory. It may be used to specify the path parameter for functions like\n\ncozy.client.files.downloadByPath\n, \ncozy.client.files.getDownloadLinkByPath\n or \ncozy.client.files.getArchiveLinkByPaths\n.\n\n\ncozy.client.data.addReferencedFiles(doc, fileIds)\n\n\ncozy.client.data.addReferencedFiles(doc, fileIds)\n binds the files to the document.\n(see cozy-stack \ndocumentation\n for more details)\n\n\ncozy.client.data.removeReferencedFiles(doc, fileIds)\n\n\ncozy.client.data.removeReferencedFiles(doc, fileIds)\n unbinds the files to the document.\n(see cozy-stack \ndocumentation\n for more details)\n\n\ncozy.client.data.listReferencedFiles(doc)\n\n\ncozy.client.data.listReferencedFiles(doc)\n list the files bound to the document.\n(see cozy-stack \ndocumentation\n for more details).\n\n\nIt returns a promise for a list of filesIds. Files must then be fetched separately.\n\n\ncozy.client.data.fetchReferencedFiles(doc)\n\n\ncozy.client.data.fetchReferencedFiles(doc)\n fetches the files bound to the document.\n(see cozy-stack \ndocumentation\n for more details).\n\n\nIt returns a promise for a list of files.\n\n\ncozy.client.files.query(indexReference, query)\n\n\ncozy.client.files.query(indexReference, query)\n find files using an index.\n\n\nIt returns a promise with a list of files matching the query. Results will be returned in the order defined for the index.\n\n\n\n\nquery\n is an object with the following fields:\n\n\nselector\n: a mango selector\n\n\nlimit\n: maximum number of results\n\n\nskip\n: ignore the first x results (pagination)\n\n\nwholeResponse\n: when set to true, the whole query response will be returned instead of just the docs. This is useful when paginating, because you\nll get the \nnext\n property in the response object.\n\n\n\n\nconst results = await cozy.client.files.query(photosByDate, {\n  \nselector\n: {\nclass\n: \nimage\n},\n  \nlimit\n: 3,\n  \nskip\n: 1\n})", 
            "title": "Files API"
        }, 
        {
            "location": "/cozy-client-js/files-api/#files-api", 
            "text": "", 
            "title": "Files API"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientfilescreatedata-options", 
            "text": "cozy.client.files.create(data, options)  is used to upload a new file onto your cozy  It returns a promise for the document of the file created.   data  can be of the following type:  Blob ,  File ,  ArrayBuffer ,  ArrayBufferView ,  stream.Readable  (node) or  string .  options  is an object with the following fields:  name : specify the name of the file. optional for a data of type  File , type, mandatory otherwise.  dirID : specify identifier of the file s directory. if empty, it is the root directory.  contentType : specify the content type of the uploaded data. For a  File  type, it is handled automatically in browsers (default:  application/octet-stream ). For nodejs, you can rely on an external module like  mime  checksum : the base64-encoded (with padding) MD5 digest of the file (optional).  lastModifiedDate : a date to specify the last modification time to use for the uploaded file. If the given  data  is a  File  instance, the  lastModifiedDate  is automatically used (not overridden).   Warning : this API is not v2 compatible.  const created = await cozy.client.files.create(blob, {\n    name:  filename ,\n    dirID:  123456 ,\n})\nconst fileCreated = await cozy.client.files.create(fileInput.files[0], {\n  dirID:  ,\n  checksum:  rL0Y20zC+Fzt72VPzMSk2A== ,\n  lastModifiedDate: new Date()\n})", 
            "title": "cozy.client.files.create(data, options)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientfilescreatedirectoryoptions", 
            "text": "cozy.client.files.createDirectory(options)  is used to create a new directory.  It returns a promise for the document of the directory created.   options  is an object with the following fields:  name : specify the name of the directory  dirID : specify identifier of the file s directory. if empty, it is the root directory.  lastModifiedDate : a date to specify the last modification time to use for the directory.   const created = await cozy.client.files.createDirectory({\n  name:  mydir ,\n  dirID:  123456 ,\n  lastModifiedDate: new Date()\n})", 
            "title": "cozy.client.files.createDirectory(options)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientfilescreatedirectorybypathpath", 
            "text": "cozy.client.files.createDirectoryByPath(path)  is used to create one or more directories for a given path.  It returns a promise for the document of the last directory created.   path  is a string   const barDirectory = await cozy.client.files.createDirectoryByPath('/Foo/Bar')", 
            "title": "cozy.client.files.createDirectoryByPath(path)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientfilesupdatebyidid-data-options", 
            "text": "cozy.client.files.updateById(id, data, options)  is used to update the content of an already existing file.  It returns a promise for the document of the file updated.   id  is a string specifying the identifier of the file to modify.  data  can be of the following type:  Blob ,  File ,  ArrayBuffer ,  ArrayBufferView  or  string .  options  is an object with the following fields:  contentType : specify the content type of the uploaded data. For a  File  type, it is be handled automatically. default:  application/octet-stream .  checksum : the base64-encoded (with padding) MD5 digest of the file (optional).  lastModifiedDate : a date to specify the last modification time to use for the uploaded file. If the given  data  is a  File  instance, the  lastModifiedDate  is automatically used (not overridden).  ifMatch : the previous revision of the file (optional). The update will be rejected if the remote revision doesn t match the given one.   const updated = await cozy.client.files.updateById( 654321 , blob, {\n  contentType:  text/plain ,\n  checksum:  rL0Y20zC+Fzt72VPzMSk2A== ,\n  lastModifiedDate: new Date(),\n  ifMatch:  1-0e6d5b72 \n})", 
            "title": "cozy.client.files.updateById(id, data, options)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientfilesupdateattributesbyidid-attrs-options", 
            "text": "cozy.client.files.updateAttributesById(id, attrs, options)  is used to update the attributes associated to a file or directory specified by its id.  It returns a promise for the document of the updated directory or file.   id  is a string specifying the identifier of the file or directory to update  attrs  is an object containing the changes  options  is an object with the following fields:  ifMatch : the previous revision of the file (optional). The update will be rejected if the remote revision doesn t match the given one.   const updated = await cozy.client.files.updateAttributesById( 12345 , { tags: [ foo ] }, { ifMatch:  1-0e6d5b72  })", 
            "title": "cozy.client.files.updateAttributesById(id, attrs, options)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientfilesupdateattributesbypathpath-attrs-options", 
            "text": "cozy.client.files.updateAttributesByPath(path, attrs, options)  is used to update the attributes associated to a file or directory specified by the given path.  It returns a promise for the document of the updated directory or file.   path : string specifying the path of the file or directory to update  attrs  is an object containing the changes  options  is an object with the following fields:  ifMatch : the previous revision of the file (optional). The update will be rejected if the remote revision doesn t match the given one.   const updated = await cozy.client.files.updateAttributes( /foo/bar , { executable: true }, { ifMatch:  1-0e6d5b72  })", 
            "title": "cozy.client.files.updateAttributesByPath(path, attrs, options)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientfilesstatbyidid-offline-options", 
            "text": "cozy.client.files.statById(id, offline, options)  is used to get the metadata of a file specified by its id.  It returns a promise for the information of the file or directory. In the case of a directory, it contains the list of files and sub-directories inside it. This list is limited to 30 items by default, but the  options  argument allows you\nto fetch more items.   id  is a string specifying the file\u2019s or directory\u2019s identifier  offline  is a boolean (default to  true )  options  is an object with the following fields:  skip : number of items to skip (optional)  limit : maximum number of items to return (optional).   By default,  statById  will fetch the metadata from the local database, if it is available. Set the second parameter to  false  to query the server.  Returned directory have a  relations()  method that allow to access to their content:  const dir = await cozy.client.files.statById( io.cozy.files.root-dir );\ndir.relations('contents').forEach( (file) =  \u2026 )", 
            "title": "cozy.client.files.statById(id, offline, options)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientfilesstatbypathpath", 
            "text": "cozy.client.files.statByPath(path)  is used to get the metadata of a file specified by its path.   path : string specifying the path of the file or directory;", 
            "title": "cozy.client.files.statByPath(path)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientfilestrashbyidid-options", 
            "text": "cozy.client.files.trashById(id, options)  is used to move the file or directory identified by the given id to trash.  It returns a promise for the document of the file or directory moved to trash.   id  is a string specifying the identifier of the file or directory  options  is an object with the following fields:  ifMatch : the previous revision of the file (optional). The update will be rejected if the remote revision doesn t match the given one.   const trashed = await cozy.client.files.trashById( 1234567 )", 
            "title": "cozy.client.files.trashById(id, options)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientfilesdestroybyidid-options", 
            "text": "cozy.client.files.destroyById(id, options)  is used to shred (destroy definitively) a file or directory identified by the given id.  The file must be in the trash folder first.  It returns a promise for completion   id  is a string specifying the identifier of the file or directory  options  is an object with the following fields:  ifMatch : the previous revision of the file (optional). The update will be rejected if the remote revision doesn t match the given one.   const trashed = await cozy.client.files.trashById( 1234567 )\nawait cozy.client.files.destroyById( 1234567 )", 
            "title": "cozy.client.files.destroyById(id, options)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientfilesrestorebyidid", 
            "text": "cozy.client.files.restoreById(id)  is used to restore a file or directory identified by the given id. The file must be in the trash folder.  It returns a promise for the restored doc. (with updated parent)   id  is a string specifying the identifier of the file or directory   const trashed = await cozy.client.files.trashById( 1234567 )\nconst restored = await cozy.client.files.restoreById( 1234567 )", 
            "title": "cozy.client.files.restoreById(id)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientfileslisttrash", 
            "text": "cozy.client.files.listTrash()  returns a promise for the list of all files in the trash.  const trashedFilesAndFolders = await cozy.client.files.listTrash()", 
            "title": "cozy.client.files.listTrash()"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientfilescleartrash", 
            "text": "cozy.client.files.clearTrash()  destroys definitively all trash content.  await cozy.client.files.clearTrash()", 
            "title": "cozy.client.files.clearTrash()"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientfilesdownloadbyidid", 
            "text": "cozy.client.files.downloadById(id)  is used to download a file identified by the given id. The file is downloaded through the browser fetch method, use this if you plan to use the file in javascript after.  It returns a promise of a fetch  Response  object. This response object can be used to extract the information in the wanted form.   id  is a string specifying the identifier of the file   const response = await cozy.client.files.downloadById( 1234567 )\nconst blob = await response.blob()\nconst text = await response.text()\nconst buff = await response.arrayBuffer()\nresponse.pipe(fs.createWriteStream('/some/file'))", 
            "title": "cozy.client.files.downloadById(id)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientfilesdownloadbypathpath", 
            "text": "cozy.client.files.downloadByPath(path)  is used to download a file identified by the given path. The file is downloaded through the browser fetch method, use this if you plan to use the file in javascript after.  It returns a promise of a fetch  Response  object. This response object can be used to extract the information in the wanted form.   path  is a string specifying the path of the file   const response = await cozy.client.files.downloadByPath( /foo/hello.txt )\nconst blob = await response.blob()\nconst text = await response.text()\nconst buff = await response.arrayBuffer()\nresponse.pipe(fs.createWriteStream('/some/file'))", 
            "title": "cozy.client.files.downloadByPath(path)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientfilesgetdownloadlinkbyidid", 
            "text": "cozy.client.files.getDownloadLinkById(id)  is used to get a download link for the file identified by the given id.  It returns a promise for the download link.\nDownload link are only valid for a short while (default 1 hour)\nYou can use this link to start a browser download like this:  const href = await cozy.client.files.getDownloadLinkById( id424242 )\nconst link = document.createElement('a')\nlink.href = href\nlink.download = fileName\ndocument.body.appendChild(link)   link.click()   id  is a string specifying the id of the file", 
            "title": "cozy.client.files.getDownloadLinkById(id)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientfilesgetdownloadlinkbypathpath", 
            "text": "cozy.client.files.getDownloadLinkByPath(path)  is used to get a download link for the file identified by the given path.  It returns a promise for the download link.\nDownload link are only valid for a short while (default 1 hour)\nYou can use this link to start a browser download like this:  const href = await cozy.client.files.getDownloadLinkByPath( /foo/hello.txt )\nconst link = document.createElement('a')\nlink.href = href\nlink.download = fileName\ndocument.body.appendChild(link)   link.click()   path  is a string specifying the path of the file", 
            "title": "cozy.client.files.getDownloadLinkByPath(path)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientfilesgetarchivelinkbypathspaths-name", 
            "text": "cozy.client.files.getArchiveLinkByPaths(paths, name)  is used to get a download link for a zip file containing all the files identified by the given paths.  It returns a promise for the download link.\nDownload link are only valid for a short while (default 1 hour)\nYou can use this link to start a browser download (see code in getDownloadLinkById)  const href = await cozy.client.files.getArchiveLinkByPaths([\n   /foo/hello.txt ,\n   /bar/test.txt \n])\n// href ===  /files/archive/b1c127c25d99f0b37ac2c2a907f36069/files.zip \n\nconst href = await cozy.client.files.getArchiveLinkByPaths([ /foo/hello.txt ],  secretproject )\n// href ===  /files/archive/bc2a901c127c25d99f0b37a36069c27f/secretproject.zip   paths  is an array of paths  name  is the optional name for the generated archive file (default  files ).", 
            "title": "cozy.client.files.getArchiveLinkByPaths(paths, name)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientfilesgetarchivelinkbyidsids-name", 
            "text": "cozy.client.files.getArchiveLinkByIds(ids, name)  is used to get a download link for a zip file containing all the files identified by the given ids.  It returns a promise for the download link.\nDownload link are only valid for a short while (default 1 hour)\nYou can use this link to start a browser download (see code in getDownloadLinkById)  const href = await cozy.client.files.getArchiveLinkByIds([\n   1234567 ,\n   9876543 \n])\n// href ===  /files/archive/b1c127c25d99f0b37ac2c2a907f36069/files.zip \n\nconst href = await cozy.client.files.getArchiveLinkByIds([ 1592673 ],  secretproject )\n// href ===  /files/archive/bc2a901c127c25d99f0b37a36069c27f/secretproject.zip   ids  is an array of ids  name  is the optional name for the generated archive file (default  files ).", 
            "title": "cozy.client.files.getArchiveLinkByIds(ids, name)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientfilesgetfilepathfile-folder", 
            "text": "cozy.client.files.getFilePath(file, folder)  is a helper that generates the file path from root directory. It may be used to specify the path parameter for functions like cozy.client.files.downloadByPath ,  cozy.client.files.getDownloadLinkByPath  or  cozy.client.files.getArchiveLinkByPaths .", 
            "title": "cozy.client.files.getFilePath(file, folder)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientdataaddreferencedfilesdoc-fileids", 
            "text": "cozy.client.data.addReferencedFiles(doc, fileIds)  binds the files to the document.\n(see cozy-stack  documentation  for more details)", 
            "title": "cozy.client.data.addReferencedFiles(doc, fileIds)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientdataremovereferencedfilesdoc-fileids", 
            "text": "cozy.client.data.removeReferencedFiles(doc, fileIds)  unbinds the files to the document.\n(see cozy-stack  documentation  for more details)", 
            "title": "cozy.client.data.removeReferencedFiles(doc, fileIds)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientdatalistreferencedfilesdoc", 
            "text": "cozy.client.data.listReferencedFiles(doc)  list the files bound to the document.\n(see cozy-stack  documentation  for more details).  It returns a promise for a list of filesIds. Files must then be fetched separately.", 
            "title": "cozy.client.data.listReferencedFiles(doc)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientdatafetchreferencedfilesdoc", 
            "text": "cozy.client.data.fetchReferencedFiles(doc)  fetches the files bound to the document.\n(see cozy-stack  documentation  for more details).  It returns a promise for a list of files.", 
            "title": "cozy.client.data.fetchReferencedFiles(doc)"
        }, 
        {
            "location": "/cozy-client-js/files-api/#cozyclientfilesqueryindexreference-query", 
            "text": "cozy.client.files.query(indexReference, query)  find files using an index.  It returns a promise with a list of files matching the query. Results will be returned in the order defined for the index.   query  is an object with the following fields:  selector : a mango selector  limit : maximum number of results  skip : ignore the first x results (pagination)  wholeResponse : when set to true, the whole query response will be returned instead of just the docs. This is useful when paginating, because you ll get the  next  property in the response object.   const results = await cozy.client.files.query(photosByDate, {\n   selector : { class :  image },\n   limit : 3,\n   skip : 1\n})", 
            "title": "cozy.client.files.query(indexReference, query)"
        }, 
        {
            "location": "/cozy-client-js/jobs-api/", 
            "text": "Jobs\n\n\ncozy.clients.jobs.count(workerType)\n\n\ncozy.clients.jobs.count\n returns the number of jobs in the queue for \nworkerType\n.\n\n\nconst nb = cozy.client.jobs.count('sendmail')\nconsole.log(`There are ${count} mails waiting to be sent`)\n\n\n\n\ncozy.clients.jobs.create(workerType, arguments, options)\n\n\ncozy.clients.jobs.create\n enqueues a job in the queue for \nworkerType\n.\n\n\nconst job = cozy.client.jobs.create('sendmail', {\n  mode: 'from',\n  to: [\n    { name: 'Support', email: 'contact@cozycloud.cc' }\n  ],\n  subject: 'Ask support for cozy-desktop',\n  parts: [\n    { type: 'text/plain', body: 'Hello, I would like some help' }\n  ]\n})\n\n\n\n\nSee \nthe cozy-stack documentation\n for more informations", 
            "title": "Jobs API"
        }, 
        {
            "location": "/cozy-client-js/jobs-api/#jobs", 
            "text": "", 
            "title": "Jobs"
        }, 
        {
            "location": "/cozy-client-js/jobs-api/#cozyclientsjobscountworkertype", 
            "text": "cozy.clients.jobs.count  returns the number of jobs in the queue for  workerType .  const nb = cozy.client.jobs.count('sendmail')\nconsole.log(`There are ${count} mails waiting to be sent`)", 
            "title": "cozy.clients.jobs.count(workerType)"
        }, 
        {
            "location": "/cozy-client-js/jobs-api/#cozyclientsjobscreateworkertype-arguments-options", 
            "text": "cozy.clients.jobs.create  enqueues a job in the queue for  workerType .  const job = cozy.client.jobs.create('sendmail', {\n  mode: 'from',\n  to: [\n    { name: 'Support', email: 'contact@cozycloud.cc' }\n  ],\n  subject: 'Ask support for cozy-desktop',\n  parts: [\n    { type: 'text/plain', body: 'Hello, I would like some help' }\n  ]\n})  See  the cozy-stack documentation  for more informations", 
            "title": "cozy.clients.jobs.create(workerType, arguments, options)"
        }, 
        {
            "location": "/cozy-client-js/intents-api/", 
            "text": "Intents\n\n\ncozy.client.intents.create()\n\n\ncozy.client.intents.create(action, doctype [, data, permissions])\n create an intent. It returns a modified Promise for the intent document, having a custom \nstart(element)\n method. This method interacts with the DOM to append an iframe to the given HTML element. This iframe will provide an access to an app, which will serve a service page able to manage the intent action for the intent doctype. The \nstart(element)\n method returns a promise for the result document provided by intent service.\n\n\n\n\nOn Intent ready callback:\n This \nstart\n method also takes a second optional argument which is a callback function (\nstart(element, onReadyCallback)\n). When provided, this function will be run when the intent iframe will be completely loaded (using the \nonload\n iframe listener). This callback could be useful to run a client code only when the intent iframe is ready and loaded.\n\n\n\n\nAn intent has to be created everytime an app need to perform an action over a doctype for wich it does not have permission. For example, the Cozy Drive app should create an intent to \npick\n a \nio.cozy.contacts\n document. The cozy-stack will determines which app can offer a service to resolve the intent. It\ns this service\ns URL that will be passed to the iframe \nsrc\n property.\n\n\nOnce the intent process is terminated by service, the iframe is removed from DOM.\n\n\nExample\n\n\ncozy.client.intents.create('EDIT', 'io.cozy.photos', {action: 'crop', width: 100, height: 100})\n  .start(document.getElementById('intent-service-wrapper'))\n\n\n\n\nSee cozy-stack \ndocumentation\n for more details.\n\n\nYou can also use \n.then\n to run some code after the intents is terminated like following:\n\n\ncozy.client.intents.create('EDIT', 'io.cozy.photos', {action: 'crop', width: 100, height: 100})\n  .start(document.getElementById('intent-service-wrapper'))\n  .then(doc =\n { // after service.terminate(doc)\n      // code to use the doc\n  })\n\n\n\n\nExample to use \nremoveIntentFrame()\n method (by passing the flag \nexposeIntentFrameRemoval\n flag):\n\n\ncozy.client.intents.create('EDIT', 'io.cozy.photos', {action: 'crop', width: 100, height: 100, exposeIntentFrameRemoval: true})\n  .start(document.getElementById('intent-service-wrapper'))\n  .then({removeIntentFrame, doc} =\n { // after service.terminate(doc)\n      // Code to be run before removing the terminated intent iframe\n      removeIntentFrame()\n      // Other code, use doc\n  })\n\n\n\n\ncozy.client.intents.createService()\n\n\ncozy.client.intents.createService([intentId, window])\n has to be used in the intent service page. It initializes communication with the parent window (remember: the service is supposed to be in an iframe).\n\n\nIf \nintentId\n and \nwindow\n parameters are not provided the method will try to retrieve them automatically.\n\n\nIt returns a \nservice\n object, which provides the following methods :\n * \ncompose(action, doctype, data)\n: request the client to make a second intent. This returns a promise fulfilled with the second intent result.\n \njs\n// ...\nconst app = await service.compose('INSTALL', 'io.cozy.apps', { slug: 'drive' })\n\n * \ngetData()\n: returns the data passed to the service by the client.\n * \ngetIntent()\n: returns the intent\n * \nresizeClient(doc, transitionProperty)\n: forces the size of the intent modale to a given width, maxWidth, height, maxHeight, or dimensions of a given element. The second optional argument \ntransitionProperty\n can be used to add a CSS transition property on the intent in order to \nanimate\n the resizing.\n \njs\n // resize the client ot 300 pixels max height\n service.resizeClient({\n    maxHeight: 300\n}, '.2s linear') // will be in css -\n transition: .2s linear;\n // or\n service.resizeClient({\n    element: document.querySelector('.class')\n })\n\n\n\n\nOn intent size:\n If an intent is used by multiple applications, we don\nt use resizeClient(), since each application can have his own layout. You have to define the size of the intent in your application\n\n\n\n\n\n\n\n\nterminate(doc)\n: ends the intent process by passing to the client the resulting document \ndoc\n. An intent service may only be terminated once.\n\n\n\n\nIf a boolean \nexposeIntentFrameRemoval\n is found as \ntrue\n in the data sent by the client, the \nterminate()\n method will return an object with as properties a function named \nremoveIntentFrame\n to remove the iframe DOM node (in order to be run by the client later on) and the resulting document \ndoc\n. This could be useful to animate an intent closing and remove the iframe node at the animation ending.\n\n\n\n\n\n\n\n\ncancel()\n: ends the intent process by passing a \nnull\n value to the client. This method terminate the intent service the same way that \nterminate()\n.\n\n\n\n\nthrow(error)\n: throw an error to client and causes the intent promise rejection.\n\n\n\n\nExample\n\n\ncozy.client.intents.createService('77bcc42c-0fd8-11e7-ac95-8f605f6e8338', window)\n  .then(intentService =\n {\n    const data = intentService.getData()\n\n    // [...]\n    // Do stuff with data\n    // [...]\n\n    const resultingDoc = {\n      type: 'io.cozy.photos',\n      width: 100,\n      height: 100\n    }\n\n    intentService.terminate(resultingDoc)\n  })\n\n\n\n\ncozy.client.intents.getRedirectionURL()\n\n\ncozy.client.intents.getRedirectionURL(doctype, data)\n retrieves a redirection URL for a given doctype, with specified data. It relies internally on a regular intent mechanism, which creates an intent for the \nREDIRECT\n action. It then build the redirection URL from URL sent by the stack and returns it. This URL can be used as link \nhref\n for example, to show the doctype or the document in an application able to handle it.\n\n\nExample\n\n\n  const myFolder = {\n    folder: '4bce4649-e7b7-4226-d82e-6b87dbb684e7'\n  }\n\n  const url = await cozy.client.getRedirectionURL('io.cozy.files', myFolder)\n  // url is http://domain-app.cozy.rocks/#/files?folder=4bce4649-e7b7-4226-d82e-6b87dbb684e7\n\n\n\n\ncozy.client.intents.redirect()\n\n\ncozy.client.intents.redirect(doctype, data)\n is based on \ncozy.client.intents.getRedirectionURL()\n and it redirects the browser to the retrieved URL.", 
            "title": "Intents API"
        }, 
        {
            "location": "/cozy-client-js/intents-api/#intents", 
            "text": "", 
            "title": "Intents"
        }, 
        {
            "location": "/cozy-client-js/intents-api/#cozyclientintentscreate", 
            "text": "cozy.client.intents.create(action, doctype [, data, permissions])  create an intent. It returns a modified Promise for the intent document, having a custom  start(element)  method. This method interacts with the DOM to append an iframe to the given HTML element. This iframe will provide an access to an app, which will serve a service page able to manage the intent action for the intent doctype. The  start(element)  method returns a promise for the result document provided by intent service.   On Intent ready callback:  This  start  method also takes a second optional argument which is a callback function ( start(element, onReadyCallback) ). When provided, this function will be run when the intent iframe will be completely loaded (using the  onload  iframe listener). This callback could be useful to run a client code only when the intent iframe is ready and loaded.   An intent has to be created everytime an app need to perform an action over a doctype for wich it does not have permission. For example, the Cozy Drive app should create an intent to  pick  a  io.cozy.contacts  document. The cozy-stack will determines which app can offer a service to resolve the intent. It s this service s URL that will be passed to the iframe  src  property.  Once the intent process is terminated by service, the iframe is removed from DOM.", 
            "title": "cozy.client.intents.create()"
        }, 
        {
            "location": "/cozy-client-js/intents-api/#example", 
            "text": "cozy.client.intents.create('EDIT', 'io.cozy.photos', {action: 'crop', width: 100, height: 100})\n  .start(document.getElementById('intent-service-wrapper'))  See cozy-stack  documentation  for more details.  You can also use  .then  to run some code after the intents is terminated like following:  cozy.client.intents.create('EDIT', 'io.cozy.photos', {action: 'crop', width: 100, height: 100})\n  .start(document.getElementById('intent-service-wrapper'))\n  .then(doc =  { // after service.terminate(doc)\n      // code to use the doc\n  })  Example to use  removeIntentFrame()  method (by passing the flag  exposeIntentFrameRemoval  flag):  cozy.client.intents.create('EDIT', 'io.cozy.photos', {action: 'crop', width: 100, height: 100, exposeIntentFrameRemoval: true})\n  .start(document.getElementById('intent-service-wrapper'))\n  .then({removeIntentFrame, doc} =  { // after service.terminate(doc)\n      // Code to be run before removing the terminated intent iframe\n      removeIntentFrame()\n      // Other code, use doc\n  })", 
            "title": "Example"
        }, 
        {
            "location": "/cozy-client-js/intents-api/#cozyclientintentscreateservice", 
            "text": "cozy.client.intents.createService([intentId, window])  has to be used in the intent service page. It initializes communication with the parent window (remember: the service is supposed to be in an iframe).  If  intentId  and  window  parameters are not provided the method will try to retrieve them automatically.  It returns a  service  object, which provides the following methods :\n *  compose(action, doctype, data) : request the client to make a second intent. This returns a promise fulfilled with the second intent result.\n  js\n// ...\nconst app = await service.compose('INSTALL', 'io.cozy.apps', { slug: 'drive' }) \n *  getData() : returns the data passed to the service by the client.\n *  getIntent() : returns the intent\n *  resizeClient(doc, transitionProperty) : forces the size of the intent modale to a given width, maxWidth, height, maxHeight, or dimensions of a given element. The second optional argument  transitionProperty  can be used to add a CSS transition property on the intent in order to  animate  the resizing.\n  js\n // resize the client ot 300 pixels max height\n service.resizeClient({\n    maxHeight: 300\n}, '.2s linear') // will be in css -  transition: .2s linear;\n // or\n service.resizeClient({\n    element: document.querySelector('.class')\n })   On intent size:  If an intent is used by multiple applications, we don t use resizeClient(), since each application can have his own layout. You have to define the size of the intent in your application     terminate(doc) : ends the intent process by passing to the client the resulting document  doc . An intent service may only be terminated once.   If a boolean  exposeIntentFrameRemoval  is found as  true  in the data sent by the client, the  terminate()  method will return an object with as properties a function named  removeIntentFrame  to remove the iframe DOM node (in order to be run by the client later on) and the resulting document  doc . This could be useful to animate an intent closing and remove the iframe node at the animation ending.     cancel() : ends the intent process by passing a  null  value to the client. This method terminate the intent service the same way that  terminate() .   throw(error) : throw an error to client and causes the intent promise rejection.", 
            "title": "cozy.client.intents.createService()"
        }, 
        {
            "location": "/cozy-client-js/intents-api/#example_1", 
            "text": "cozy.client.intents.createService('77bcc42c-0fd8-11e7-ac95-8f605f6e8338', window)\n  .then(intentService =  {\n    const data = intentService.getData()\n\n    // [...]\n    // Do stuff with data\n    // [...]\n\n    const resultingDoc = {\n      type: 'io.cozy.photos',\n      width: 100,\n      height: 100\n    }\n\n    intentService.terminate(resultingDoc)\n  })", 
            "title": "Example"
        }, 
        {
            "location": "/cozy-client-js/intents-api/#cozyclientintentsgetredirectionurl", 
            "text": "cozy.client.intents.getRedirectionURL(doctype, data)  retrieves a redirection URL for a given doctype, with specified data. It relies internally on a regular intent mechanism, which creates an intent for the  REDIRECT  action. It then build the redirection URL from URL sent by the stack and returns it. This URL can be used as link  href  for example, to show the doctype or the document in an application able to handle it.", 
            "title": "cozy.client.intents.getRedirectionURL()"
        }, 
        {
            "location": "/cozy-client-js/intents-api/#example_2", 
            "text": "const myFolder = {\n    folder: '4bce4649-e7b7-4226-d82e-6b87dbb684e7'\n  }\n\n  const url = await cozy.client.getRedirectionURL('io.cozy.files', myFolder)\n  // url is http://domain-app.cozy.rocks/#/files?folder=4bce4649-e7b7-4226-d82e-6b87dbb684e7", 
            "title": "Example"
        }, 
        {
            "location": "/cozy-client-js/intents-api/#cozyclientintentsredirect", 
            "text": "cozy.client.intents.redirect(doctype, data)  is based on  cozy.client.intents.getRedirectionURL()  and it redirects the browser to the retrieved URL.", 
            "title": "cozy.client.intents.redirect()"
        }, 
        {
            "location": "/cozy-client-js/settings-api/", 
            "text": "Settings\n\n\ncozy.client.settings.diskUsage()\n\n\ncozy.client.settings.diskUsage\n is used to known informations about the total used space on the cozy disk.\n\n\nIt returns a promise of the document of the disk-usage of id \nio.cozy.settings.disk-usage\n, with attributes containing a \nused\n field a string of how many \nbytes\n are used on the disk.\n\n\nThe \nused\n field is a string since the underlying data is an \nint64\n which may not be properly represented in javascript.\n\n\nconst usage = await cozy.client.settings.diskUsage()\nconsole.log(usage.attributes.used)\n\n\n\n\ncozy.client.settings.changePassphrase(oldPassphrase, newPassphrase)\n\n\ncozy.client.settings.changePassphrase\n is used to change the passphrase of the current user. You must supply the currently used passphrase, as well as the new one. It simply returns a promise that will resolve if the change was successful.\n\n\ncozy.client.settings.getInstance()\n\n\ncozy.client.settings.getInstance\n returns a promise with informations about the current Cozy instance, such as the locale or the public name. See cozy-stack \ndocumentation\n for more details.\n\n\ncozy.client.settings.updateInstance(instance)\n\n\ncozy.client.settings.updateInstance\n is used to update informations about the current instance. \ninstance\n is an object that should be based on to the one you receive from \ncozy.settings.getInstance()\n. It returns a promise with the updated instance information.\n\n\ncozy.client.settings.getClients()\n\n\ncozy.client.settings.getClients\n returns a promise for an array of registered clients. See the \ncozy-stack documentation\n for more details.\n\n\ncozy.client.settings.deleteClientById('123')\n\n\ncozy.client.settings.deleteClientById\n revokes the specified client from the instance. This method returns a promise that simply resolves if the revokation was successful.", 
            "title": "Settings API"
        }, 
        {
            "location": "/cozy-client-js/settings-api/#settings", 
            "text": "", 
            "title": "Settings"
        }, 
        {
            "location": "/cozy-client-js/settings-api/#cozyclientsettingsdiskusage", 
            "text": "cozy.client.settings.diskUsage  is used to known informations about the total used space on the cozy disk.  It returns a promise of the document of the disk-usage of id  io.cozy.settings.disk-usage , with attributes containing a  used  field a string of how many  bytes  are used on the disk.  The  used  field is a string since the underlying data is an  int64  which may not be properly represented in javascript.  const usage = await cozy.client.settings.diskUsage()\nconsole.log(usage.attributes.used)", 
            "title": "cozy.client.settings.diskUsage()"
        }, 
        {
            "location": "/cozy-client-js/settings-api/#cozyclientsettingschangepassphraseoldpassphrase-newpassphrase", 
            "text": "cozy.client.settings.changePassphrase  is used to change the passphrase of the current user. You must supply the currently used passphrase, as well as the new one. It simply returns a promise that will resolve if the change was successful.", 
            "title": "cozy.client.settings.changePassphrase(oldPassphrase, newPassphrase)"
        }, 
        {
            "location": "/cozy-client-js/settings-api/#cozyclientsettingsgetinstance", 
            "text": "cozy.client.settings.getInstance  returns a promise with informations about the current Cozy instance, such as the locale or the public name. See cozy-stack  documentation  for more details.", 
            "title": "cozy.client.settings.getInstance()"
        }, 
        {
            "location": "/cozy-client-js/settings-api/#cozyclientsettingsupdateinstanceinstance", 
            "text": "cozy.client.settings.updateInstance  is used to update informations about the current instance.  instance  is an object that should be based on to the one you receive from  cozy.settings.getInstance() . It returns a promise with the updated instance information.", 
            "title": "cozy.client.settings.updateInstance(instance)"
        }, 
        {
            "location": "/cozy-client-js/settings-api/#cozyclientsettingsgetclients", 
            "text": "cozy.client.settings.getClients  returns a promise for an array of registered clients. See the  cozy-stack documentation  for more details.", 
            "title": "cozy.client.settings.getClients()"
        }, 
        {
            "location": "/cozy-client-js/settings-api/#cozyclientsettingsdeleteclientbyid123", 
            "text": "cozy.client.settings.deleteClientById  revokes the specified client from the instance. This method returns a promise that simply resolves if the revokation was successful.", 
            "title": "cozy.client.settings.deleteClientById('123')"
        }, 
        {
            "location": "/cozy-client-js/sharing-api/", 
            "text": "Sharing\n\n\ncozy.client.files.getCollectionShareLink(id, collectionType)\n\n\ngetCollectionShareLink\n creates codes that can be used to share a collection by links. See \nthe stack documentation\n for more informations.\n\n\nconst sharing = cozy.client.files.getCollectionShareLink(albumID, 'io.cozy.albums')\nconsole.log('Sharing id:', sharing.id)\nconsole.log('Sharing query-string with the sharecode:', sharing.sharecode)", 
            "title": "Sharing API"
        }, 
        {
            "location": "/cozy-client-js/sharing-api/#sharing", 
            "text": "", 
            "title": "Sharing"
        }, 
        {
            "location": "/cozy-client-js/sharing-api/#cozyclientfilesgetcollectionsharelinkid-collectiontype", 
            "text": "getCollectionShareLink  creates codes that can be used to share a collection by links. See  the stack documentation  for more informations.  const sharing = cozy.client.files.getCollectionShareLink(albumID, 'io.cozy.albums')\nconsole.log('Sharing id:', sharing.id)\nconsole.log('Sharing query-string with the sharecode:', sharing.sharecode)", 
            "title": "cozy.client.files.getCollectionShareLink(id, collectionType)"
        }, 
        {
            "location": "/cozy-konnector-libs/api/", 
            "text": "API\n\n\nModules\n\n\n\n\naddData\n\n\nThis function saves the data into the cozy blindly without check\nYou need at least the \nPOST\n permission for the given doctype in your manifest, to be able to\nuse this function.\n\n\nParameters:\n\n\n\n\ndocuments\n: an array of objects corresponding to the data you want to save in the cozy\n\n\ndoctype\n (string): the doctype where you want to save data (ex: \nio.cozy.bills\n)\n\n\n\n\nconst documents = [\n  {\n    name: \ntoto\n,\n    height: 1.8\n  },\n  {\n    name: \ntiti\n,\n    height: 1.7\n  }\n]\n\nreturn addData(documents, \nio.cozy.height\n)\n\n\n\n\n\ncozyClient\n\n\nThis is a \ncozy-client-js\n instance already initialized and ready to use\n\n\nIf you want to access cozy-client-js directly, this method gives you directly an instance of it,\ninitialized according to \nCOZY_URL\n and \nCOZY_CREDENTIALS\n environment variable given by cozy-stack\nYou can refer to the \ncozy-client-js documentation\n for more information.\n\n\nExample :\n\n\nconst {cozyClient} = require(\ncozy-konnector-libs\n)\n\ncozyClient.data.defineIndex(\nmy.doctype\n, [\n_id\n])\n\n\n\n\n\nfilterData\n\n\nThis function filters the passed array from data already present in the cozy so that there is\nnot duplicated data in the cozy.\nYou need at least the \nGET\n permission for the given doctype in your manifest, to be able to\nuse this function.\n\n\nParameters:\n\n\n\n\ndocuments\n: an array of objects corresponding to the data you want to save in the cozy\n\n\ndoctype\n (string): the doctype where you want to save data (ex: \nio.cozy.bills\n)\n\n\noptions\n :\n\n\nkeys\n (array) : List of keys used to check that two items are the same. By default it is set to `[\nid\n]\n.\n\n\nindex\n (optionnal) : Return value returned by \ncozy.data.defineIndex\n, the default will correspond to all documents of the selected doctype.\n\n\nselector\n (optionnal object) : Mango request to get records. Default is built from the keys \n{selector: {_id: {\n$gt\n: null}}}\n to get all the records.\n\n\n\n\n\n\n\n\nconst documents = [\n  {\n    name: \ntoto\n,\n    height: 1.8\n  },\n  {\n    name: \ntiti\n,\n    height: 1.7\n  }\n]\n\nreturn filterData(documents, \nio.cozy.height\n, {\n  keys: [\nname\n]\n}).then(filteredDocuments =\n addData(filteredDocuments, \nio.cozy.height\n))\n\n\n\n\n\n\nlinkBankOperations\n\n\nlinkBankOperations ( entries, doctype, fields, options = {} )\n\n\nThis function will soon move to a dedicated service. You should not use it.\nThe goal of this function is to find links between bills and bank operations.\n\n\n\n\n\nmkdirp\n\n\nCreates a directory and its missing ancestors as needed.\n\n\nOptions :\n\n\n\n\n...pathComponents\n:  one or many path components to be joined\n\n\n\n\nawait mkdirp(\n/foo\n) // Creates /foo\nawait mkdirp(\n/foo\n) // Does nothing as /foo already exists\nawait mkdirp(\n/bar/baz\n) // Creates /bar, then /bar/baz\nawait mkdirp(\n/foo/bar/baz\n) // Creates /foo/bar, then /foo/bar/baz, not /foo\nawait mkdirp(\n/\n) // Does nothing\nawait mkdirp(\n/qux\n, \nqux2/qux3\n, \nqux4\n) // Creates /qux, then /qux/qux2,\n                                          // then /qux/qux2/qux3 and\n                                          // finally /qux/qux2/qux3/qux4\n\n\n\nThe function will automatically add a leading slash when missing:\n\n\nawait mkdirp(\nfoo\n, \nbar\n) // Creates /foo, then /foo/bar\n\n\nnormalizeFilename\n\n\nReturns the given name, replacing characters that could be an issue when\nused in a filename with spaces.\n\n\nReplaced characters include:\n\n\n\n\nThose forbidden on one or many popular OS or filesystem: \n:\n/\\|?*\n\n\nThose forbidden by the cozy-stack \n\\0\n, \n\\r\n and \n\\n\n\n\nMultiple spaces and/or tabs are replaced with a single space\n\n\nLeading \n trailing spaces and/or tabs are removed\n\n\n\n\nAn exception will be thrown in case there is not any filename-compatible\ncharacter in the given name.\n\n\nParameters:\n\n\n\n\nbasename\n is whatever string you want to generate the filename from\n\n\next\n is an optional file extension, with or without leading dot\n\n\n\n\nconst { normalizeFilename } = require(\ncozy-konnector-libs\n)\n\nconst filename = normalizeFilename(\n*foo/bar: \nbaz\n \\\\\nqux\n\\t???\n, \n.txt\n)\n// `filename` === `foo bar baz qux.txt`\n\n\n\n\n\n\nrequestFactory\n\n\nThis is a function which returns an instance of\n\nrequest-promise\n initialized with\ndefaults often used in connector development.\n\n\n// Showing defaults\nreq = requestFactory({\n  cheerio: false,\n  jar: true,\n  json: true\n})\n\n\n\nOptions :\n\n\n\n\ncheerio\n:  will parse automatically the \nresponse.body\n in a cheerio instance\n\n\n\n\nreq = requestFactory({ cheerio: true })\nreq(\nhttp://github.com\n, $ =\n {\n  const repos = $(\n#repo_listing .repo\n)\n})\n\n\n\n\n\njar\n: is passed to \nrequest\n options. Remembers cookies for future use.\n\n\njson\n: will parse the \nresponse.body\n as JSON\n\n\njson\n: will parse the \nresponse.body\n as JSON\n\n\nresolveWithFullResponse\n: The full response will be return in the promise. It is compatible\nwith cheerio and json options.\n\n\n\n\nreq = requestFactory({\n   resolveWithFullResponse: true,\n   cheerio: true\n})\nreq(\nhttp://github.com\n, response =\n {\n  console.log(response.statusCode)\n  const $ = response.body\n  const repos = $(\n#repo_listing .repo\n)\n})\n\n\n\nYou can find the full list of available options in \nrequest-promise\n and \nrequest\n documentations.\n\n\n\n\nsaveBills\n\n\nCombines the features of \nsaveFiles\n, \nfilterData\n, \naddData\n and \nlinkBankOperations\n for a\ncommon case: bills.\nWill create \nio.cozy.bills\n objects. The default deduplication keys are \n[\ndate\n, \namount\n, \nvendor\n]\n.\nYou need the full permission on \nio.cozy.bills\n, full permission on \nio.cozy.files\n and also\nfull permission on \nio.cozy.bank.operations\n in your manifest, to be able to * use this function.\n\n\nParameters:\n\n\n\n\ndocuments\n is an array of objects with any attributes :\n\n\nfields\n (object) this is the first parameter given to BaseKonnector\ns constructor\n\n\noptions\n is passed directly to \nsaveFiles\n, \nhydrateAndFilter\n, \naddData\n and \nlinkBankOperations\n.\n\n\n\n\nconst { BaseKonnector, saveBills } = require(\ncozy-konnector-libs\n)\n\nmodule.exports = new BaseKonnector(function fetch (fields) {\n  const documents = []\n  // some code which fills documents\n  return saveBills(documents, fields, {\n    identifiers: [\nvendorj\n]\n  })\n})\n\n\n\n\n\nsaveFiles\n\n\nThe goal of this function is to save the given files in the given folder via the Cozy API.\nYou need the full permission on \nio.cozy.files\n in your manifest to use this function.\n\n\n\n\nfiles\n is an array of \n{ fileurl, filename }\n :\n\n\n\n\nfileurl: The url of the file. This attribute is mandatory or\nthis item will be ignored\n\n\nfilename : The file name of the item written on disk. This attribute is optional and as default value, the\nfile name will be \nsmartly\n guessed by the function. Use this attribute if the guess is not smart\nenough for you.\n\n\n\n\n\n\nfolderPath\n (string) is relative to the main path given by the \ncozy-collect\n application to the connector. If the connector is run\nin standalone mode, the main path is the path of the connector.\n\n\n\n\noptions\n (object) is optional. Possible options :\n\n\n\n\ntimeout\n (timestamp) can be used if your connector needs to fetch a lot of files and if the\nstack does not give enough time to your connector to fetch it all. It could happen that the\nconnector is stopped right in the middle of the download of the file and the file will be\nbroken. With the \ntimeout\n option, the \nsaveFiles\n function will check if the timeout has\npassed right after downloading each file and then will be sure to be stopped cleanly if the\ntimeout is not too long. And since it is really fast to check that a file has already been\ndownloaded, on the next run of the connector, it will be able to download some more\nfiles, and so on. If you want the timeout to be in 10s, do \nDate.now() + 10*1000\n.\nYou can try it in the previous code.\n\n\n\n\n\n\n\n\n\n\nsignin\n\n\nThe goal of this function is to provide an handy method to log the user in,\non html form pages. On success, it resolves a promise with a parsed body.\n\n\nErrors:\n\n\n\n\nLOGIN_FAILED if the validate predicate is false\n\n\nINVALID_FORM if the element matched by \nformSelector\n is not a form or has\nno \naction\n attribute\n\n\nUNKNOWN_PARSING_STRATEGY if \nparse\n is not one of the accepted values:\n\nraw\n, \ncheerio\n, \njson\n.\n\n\nVENDOR_DOWN if a request throws a RequestError, or StatusCodeError\n\n\n\n\nIt does not submit values provided through \nselect\n tags, except if populated\nby user with \nformData\n.\n\n\n\n\nurl\n is the url to access the html form\n\n\n\n\nformSelector\n is used by cheerio to uniquely identify the form in which to\nlog in\n\n\n\n\nformData\n is an object \n{ name: value, \u2026 }\n. It is used to populate the\nform, in the proper inputs with the same name as the properties of this\nobject, before submitting it. It can also be a function that returns this\nobject. The page at \nurl\n would be given as argument, right after having\nbeen parsed through \ncheerio\n.\n\n\n\n\nparse\n allow the user to resolve \nsignin\n with a preparsed body. The\nchoice of the strategy for the parsing is one of : \nraw\n, \njson\n or\n\ncheerio\n. \ncheerio\n being the default.\n\n\n\n\nvalidate\n is a predicate taking two arguments \nstatusCode\n and\n\nparsedBody\n. If it is false, \nLOGIN_FAILED\n is thrown, otherwise the\nsignin resolves with \nparsedBody\n value.\n\n\n\n\nrequestOpts\n allows to pass eventual options to the \nsignin\ns\n\nrequestFactory\n. It could be useful for pages using \nlatin1\n \nencoding\n\nfor instance.\n\n\n\n\n\n\n\n\nupdateOrCreate\n\n\nThe goal of this function is create or update the given entries according to if they already\nexist in the cozy or not\nYou need the full permission for the given doctype in your manifest, to be able to\nuse this function.\n\n\nParameters:\n\n\n\n\nentries\n is an array of objects with any attributes :\n\n\ndoctype\n (string) is the cozy doctype where the entries should be saved\n\n\nmatchingAttributes\n (array of strings) is the list of attributes in each entry should be used to check if an entry\nis already saved in the cozy\n\n\n\n\n\n\n\n\n\nClasses\n\n\n\n\nBaseKonnector\n\n\nThe class from which all the connectors must inherit.\nIt takes a fetch function in parameter that must return a \nPromise\n.\nYou need at least the \nGET\n permission on \nio.cozy.accounts\n in your manifest to allow it to\nfetch account information for your connector.\n\n\n\n\nDocument\n\n\nSimple Model for Documents. Allows to specify\n\nshouldSave\n, \nshouldUpdate\n as methods.\n\n\nHas useful \nisEqual\n method\n\n\n\n\n\n\n\nConstants\n\n\n\n\nLOGIN_FAILED\n : \nString\n\n\nThe konnector could not login\n\n\n\n\nNOT_EXISTING_DIRECTORY\n : \nString\n\n\nThe folder specified as folder_to_save does not exist (checked by BaseKonnector)\n\n\n\n\nVENDOR_DOWN\n : \nString\n\n\nThe vendor\ns website is down\n\n\n\n\nUSER_ACTION_NEEDED\n : \nString\n\n\nThere was an unexpected error, please take a look at the logs to know what happened\n\n\n\n\nFILE_DOWNLOAD_FAILED\n : \nString\n\n\nThere was a problem while downloading a file\n\n\n\n\nSAVE_FILE_FAILED\n : \nString\n\n\nThere was a problem while saving a file\n\n\n\n\n\n\n\nFunctions\n\n\n\n\nmkSpec()\n\n\nDeclarative scraping.\n\n\nDescribe your items attributes and where to find/parse them\ninstead of imperatively building them.\n\n\nHeavily inspired by \nartoo\n scraping method.\n\n\n\n\nscrape($, spec(s), [childSelector])\n \u21d2 \nobject\n | \narray\n\n\nScrape a cheerio object for properties\n\n\n\n\n\n\n\n\n\naddData\n\n\nThis function saves the data into the cozy blindly without check\nYou need at least the \nPOST\n permission for the given doctype in your manifest, to be able to\nuse this function.\n\n\nParameters:\n\n\n\n\ndocuments\n: an array of objects corresponding to the data you want to save in the cozy\n\n\ndoctype\n (string): the doctype where you want to save data (ex: \nio.cozy.bills\n)\n\n\n\n\nconst documents = [\n  {\n    name: 'toto',\n    height: 1.8\n  },\n  {\n    name: 'titi',\n    height: 1.7\n  }\n]\n\nreturn addData(documents, 'io.cozy.height')\n\n\n\n\n\n\ncozyClient\n\n\nThis is a \ncozy-client-js\n instance already initialized and ready to use\n\n\nIf you want to access cozy-client-js directly, this method gives you directly an instance of it,\ninitialized according to \nCOZY_URL\n and \nCOZY_CREDENTIALS\n environment variable given by cozy-stack\nYou can refer to the \ncozy-client-js documentation\n for more information.\n\n\nExample :\n\n\nconst {cozyClient} = require('cozy-konnector-libs')\n\ncozyClient.data.defineIndex('my.doctype', ['_id'])\n\n\n\n\n\n\nfilterData\n\n\nThis function filters the passed array from data already present in the cozy so that there is\nnot duplicated data in the cozy.\nYou need at least the \nGET\n permission for the given doctype in your manifest, to be able to\nuse this function.\n\n\nParameters:\n\n\n\n\ndocuments\n: an array of objects corresponding to the data you want to save in the cozy\n\n\ndoctype\n (string): the doctype where you want to save data (ex: \nio.cozy.bills\n)\n\n\noptions\n :\n\n\nkeys\n (array) : List of keys used to check that two items are the same. By default it is set to `[\nid\n]\n.\n\n\nindex\n (optionnal) : Return value returned by \ncozy.data.defineIndex\n, the default will correspond to all documents of the selected doctype.\n\n\nselector\n (optionnal object) : Mango request to get records. Default is built from the keys \n{selector: {_id: {\"$gt\": null}}}\n to get all the records.\n\n\n\n\nconst documents = [\n  {\n    name: 'toto',\n    height: 1.8\n  },\n  {\n    name: 'titi',\n    height: 1.7\n  }\n]\n\nreturn filterData(documents, 'io.cozy.height', {\n  keys: ['name']\n}).then(filteredDocuments =\n addData(filteredDocuments, 'io.cozy.height'))\n\n\n\n\n\n\nfilterData~suitableCall()\n\n\nSince we can use methods or basic functions for\n\nshouldSave\n and \nshouldUpdate\n we pass the\nappropriate \nthis\n and \narguments\n.\n\n\nIf \nfuncOrMethod\n is a method, it will be called\nwith args[0] as \nthis\n and the rest as \narguments\n\nOtherwise, \nthis\n will be null and \nargs\n will be passed\nas \narguments\n.\n\n\nKind\n: inner method of \nfilterData\n\n\n\n\nlinkBankOperations\n\n\nlinkBankOperations ( entries, doctype, fields, options = {} )\n\n\nThis function will soon move to a dedicated service. You should not use it.\nThe goal of this function is to find links between bills and bank operations.\n\n\n\n\nmkdirp\n\n\nCreates a directory and its missing ancestors as needed.\n\n\nOptions :\n\n\n\n\n...pathComponents\n:  one or many path components to be joined\n\n\n\n\nawait mkdirp('/foo') // Creates /foo\nawait mkdirp('/foo') // Does nothing as /foo already exists\nawait mkdirp('/bar/baz') // Creates /bar, then /bar/baz\nawait mkdirp('/foo/bar/baz') // Creates /foo/bar, then /foo/bar/baz, not /foo\nawait mkdirp('/') // Does nothing\nawait mkdirp('/qux', 'qux2/qux3', 'qux4') // Creates /qux, then /qux/qux2,\n                                          // then /qux/qux2/qux3 and\n                                          // finally /qux/qux2/qux3/qux4\n\n\n\n\nThe function will automatically add a leading slash when missing:\n\n\nawait mkdirp('foo', 'bar') // Creates /foo, then /foo/bar\n\n\na name=\nmodule_normalizeFilename\n/a\n\n\n## normalizeFilename\nReturns the given name, replacing characters that could be an issue when\nused in a filename with spaces.\n\nReplaced characters include:\n\n- Those forbidden on one or many popular OS or filesystem: `\n:\n/\\|?*`\n- Those forbidden by the cozy-stack `\\0`, `\\r` and `\\n`\n- Multiple spaces and/or tabs are replaced with a single space\n- Leading \n trailing spaces and/or tabs are removed\n\nAn exception will be thrown in case there is not any filename-compatible\ncharacter in the given name.\n\nParameters:\n\n- `basename` is whatever string you want to generate the filename from\n- `ext` is an optional file extension, with or without leading dot\n\n```javascript\nconst { normalizeFilename } = require('cozy-konnector-libs')\n\nconst filename = normalizeFilename('*foo/bar: \nbaz\n \\\\\nqux\n\\t???', '.txt')\n// `filename` === `foo bar baz qux.txt`\n\n\n\n\n\n\nrequestFactory\n\n\nThis is a function which returns an instance of\n\nrequest-promise\n initialized with\ndefaults often used in connector development.\n\n\n// Showing defaults\nreq = requestFactory({\n  cheerio: false,\n  jar: true,\n  json: true\n})\n\n\n\n\nOptions :\n\n\n\n\ncheerio\n:  will parse automatically the \nresponse.body\n in a cheerio instance\n\n\n\n\nreq = requestFactory({ cheerio: true })\nreq('http://github.com', $ =\n {\n  const repos = $('#repo_listing .repo')\n})\n\n\n\n\n\n\njar\n: is passed to \nrequest\n options. Remembers cookies for future use.\n\n\njson\n: will parse the \nresponse.body\n as JSON\n\n\njson\n: will parse the \nresponse.body\n as JSON\n\n\nresolveWithFullResponse\n: The full response will be return in the promise. It is compatible\n  with cheerio and json options.\n\n\n\n\nreq = requestFactory({\n   resolveWithFullResponse: true,\n   cheerio: true\n})\nreq('http://github.com', response =\n {\n  console.log(response.statusCode)\n  const $ = response.body\n  const repos = $('#repo_listing .repo')\n})\n\n\n\n\nYou can find the full list of available options in \nrequest-promise\n and \nrequest\n documentations.\n\n\n\n\nsaveBills\n\n\nCombines the features of \nsaveFiles\n, \nfilterData\n, \naddData\n and \nlinkBankOperations\n for a\ncommon case: bills.\nWill create \nio.cozy.bills\n objects. The default deduplication keys are \n['date', 'amount', 'vendor']\n.\nYou need the full permission on \nio.cozy.bills\n, full permission on \nio.cozy.files\n and also\nfull permission on \nio.cozy.bank.operations\n in your manifest, to be able to * use this function.\n\n\nParameters:\n\n\n\n\ndocuments\n is an array of objects with any attributes :\n\n\nfields\n (object) this is the first parameter given to BaseKonnector\ns constructor\n\n\noptions\n is passed directly to \nsaveFiles\n, \nhydrateAndFilter\n, \naddData\n and \nlinkBankOperations\n.\n\n\n\n\nconst { BaseKonnector, saveBills } = require('cozy-konnector-libs')\n\nmodule.exports = new BaseKonnector(function fetch (fields) {\n  const documents = []\n  // some code which fills documents\n  return saveBills(documents, fields, {\n    identifiers: ['vendorj']\n  })\n})\n\n\n\n\n\n\nsaveFiles\n\n\nThe goal of this function is to save the given files in the given folder via the Cozy API.\nYou need the full permission on \nio.cozy.files\n in your manifest to use this function.\n\n\n\n\n\n\nfiles\n is an array of \n{ fileurl, filename }\n :\n\n\n\n\n\n\nfileurl: The url of the file. This attribute is mandatory or\n    this item will be ignored\n\n\n\n\n\n\nfilename : The file name of the item written on disk. This attribute is optional and as default value, the\n    file name will be \nsmartly\n guessed by the function. Use this attribute if the guess is not smart\n  enough for you.\n\n\n\n\n\n\nfolderPath\n (string) is relative to the main path given by the \ncozy-collect\n application to the connector. If the connector is run\nin standalone mode, the main path is the path of the connector.\n\n\n\n\n\n\noptions\n (object) is optional. Possible options :\n\n\n\n\n\n\ntimeout\n (timestamp) can be used if your connector needs to fetch a lot of files and if the\n  stack does not give enough time to your connector to fetch it all. It could happen that the\n  connector is stopped right in the middle of the download of the file and the file will be\n  broken. With the \ntimeout\n option, the \nsaveFiles\n function will check if the timeout has\n  passed right after downloading each file and then will be sure to be stopped cleanly if the\n  timeout is not too long. And since it is really fast to check that a file has already been\n  downloaded, on the next run of the connector, it will be able to download some more\n  files, and so on. If you want the timeout to be in 10s, do \nDate.now() + 10*1000\n.\n  You can try it in the previous code.\n\n\n\n\n\n\n\n\nsignin\n\n\nThe goal of this function is to provide an handy method to log the user in,\non html form pages. On success, it resolves a promise with a parsed body.\n\n\nErrors:\n\n\n\n\nLOGIN_FAILED if the validate predicate is false\n\n\nINVALID_FORM if the element matched by \nformSelector\n is not a form or has\n  no \naction\n attribute\n\n\nUNKNOWN_PARSING_STRATEGY if \nparse\n is not one of the accepted values:\n  \nraw\n, \ncheerio\n, \njson\n.\n\n\nVENDOR_DOWN if a request throws a RequestError, or StatusCodeError\n\n\n\n\nIt does not submit values provided through \nselect\n tags, except if populated\nby user with \nformData\n.\n\n\n\n\n\n\nurl\n is the url to access the html form\n\n\n\n\n\n\nformSelector\n is used by cheerio to uniquely identify the form in which to\n  log in\n\n\n\n\n\n\nformData\n is an object \n{ name: value, \u2026 }\n. It is used to populate the\n  form, in the proper inputs with the same name as the properties of this\n  object, before submitting it. It can also be a function that returns this\n  object. The page at \nurl\n would be given as argument, right after having\n  been parsed through \ncheerio\n.\n\n\n\n\n\n\nparse\n allow the user to resolve \nsignin\n with a preparsed body. The\n  choice of the strategy for the parsing is one of : \nraw\n, \njson\n or\n  \ncheerio\n. \ncheerio\n being the default.\n\n\n\n\n\n\nvalidate\n is a predicate taking two arguments \nstatusCode\n and\n  \nparsedBody\n. If it is false, \nLOGIN_FAILED\n is thrown, otherwise the\n  signin resolves with \nparsedBody\n value.\n\n\n\n\n\n\nrequestOpts\n allows to pass eventual options to the \nsignin\ns\n  \nrequestFactory\n. It could be useful for pages using \nlatin1\n \nencoding\n\n  for instance.\n\n\n\n\n\n\n\n\nupdateOrCreate\n\n\nThe goal of this function is create or update the given entries according to if they already\nexist in the cozy or not\nYou need the full permission for the given doctype in your manifest, to be able to\nuse this function.\n\n\nParameters:\n\n\n\n\nentries\n is an array of objects with any attributes :\n\n\ndoctype\n (string) is the cozy doctype where the entries should be saved\n\n\nmatchingAttributes\n (array of strings) is the list of attributes in each entry should be used to check if an entry\n  is already saved in the cozy\n\n\n\n\n\n\nBaseKonnector\n\n\nThe class from which all the connectors must inherit.\nIt takes a fetch function in parameter that must return a \nPromise\n.\nYou need at least the \nGET\n permission on \nio.cozy.accounts\n in your manifest to allow it to\nfetch account information for your connector.\n\n\nKind\n: global class  \n\n\n\n\nBaseKonnector\n\n\nnew BaseKonnector(fetch)\n\n\n.end()\n\n\n.fail()\n\n\n.init()\n \u21d2 \nPromise\n\n\n.saveAccountData(data, options)\n \u21d2 \nPromise\n\n\n.terminate(message)\n\n\n\n\n\n\n\n\n\n\nnew BaseKonnector(fetch)\n\n\nIts role is twofold :\n\n\n\n\nMake the link between account data and konnector\n\n\nHandle errors\n\n\n\n\n\u26a0\ufe0f  A promise should be returned from the \nfetch\n function otherwise\nthe konnector cannot know that asynchronous code has been called.\n\n\nthis.terminate('LOGIN_FAILED')\n\n\n\n\n\n\n\n\n\n\nParam\n\n\nType\n\n\nDescription\n\n\n\n\n\n\n\n\n\n\nfetch\n\n\nfunction\n\n\nFunction to be run automatically after account data is fetched. This function will be binded to the current connector. If not fetch function is given. The connector will have to handle itself it\ns own exection and error handling\n\n\n\n\n\n\n\n\nExample\n  \n\n\nconst { BaseKonnector } = require('cozy-konnector-libs')\n\nmodule.exports = new BaseKonnector(function fetch () {\n // use this to access the instance of the konnector to\n // store any information that needs to be passed to\n // different stages of the konnector\n return request('http://ameli.fr')\n   .then(computeReimbursements)\n   .then(saveBills)\n})\n\n\n\n\n\n\nbaseKonnector.end()\n\n\nHook called when the connector is ended\n\n\nKind\n: instance method of \nBaseKonnector\n\n\n\n\nbaseKonnector.fail()\n\n\nHook called when the connector fails\n\n\nKind\n: instance method of \nBaseKonnector\n\n\n\n\nbaseKonnector.init() \u21d2 \nPromise\n\n\nInitializes the current connector with data comming from the associated account\n\n\nKind\n: instance method of \nBaseKonnector\n\n\nReturns\n: \nPromise\n - with the fields as an object\n\n\n\n\nbaseKonnector.saveAccountData(data, options) \u21d2 \nPromise\n\n\nSaves data to the account that is passed to the konnector.\nUse it to persist data that needs to be passed to each\nkonnector run.\n\n\nBy default, the data is merged to the remote data, use\n\noptions.merge = false\n to overwrite the data.\n\n\nThe data is saved under the \n.data\n attribute of the cozy\naccount.\n\n\nKind\n: instance method of \nBaseKonnector\n  \n\n\n\n\n\n\n\n\nParam\n\n\nType\n\n\nDescription\n\n\n\n\n\n\n\n\n\n\ndata\n\n\nobject\n\n\nAttributes to be merged\n\n\n\n\n\n\noptions\n\n\nobject\n\n\n{ merge: true\n\n\n\n\n\n\n\n\n\n\nbaseKonnector.terminate(message)\n\n\nSend a special error code which is interpreted by the cozy stack to terminate the execution of the\nconnector now\n\n\nKind\n: instance method of \nBaseKonnector\n  \n\n\n\n\n\n\n\n\nParam\n\n\nType\n\n\nDescription\n\n\n\n\n\n\n\n\n\n\nmessage\n\n\nstring\n\n\nThe error code to be saved as connector result see [docs/ERROR_CODES.md]\n\n\n\n\n\n\n\n\n\n\nDocument\n\n\nSimple Model for Documents. Allows to specify\n\nshouldSave\n, \nshouldUpdate\n as methods.\n\n\nHas useful \nisEqual\n method\n\n\nKind\n: global class\n\n\n\n\ndocument.isEqual()\n\n\nCompares to another document deeply.\n\n\n_id\n and \n_rev\n are by default ignored in the comparison.\n\n\nBy default, will compare dates loosely since you often\ncompare existing documents (dates in ISO string) with documents\nthat just have been scraped where dates are \nDate\ns.\n\n\nKind\n: instance method of \nDocument\n\n\n\n\nLOGIN_FAILED : \nString\n\n\nThe konnector could not login\n\n\nKind\n: global constant\n\n\n\n\nNOT_EXISTING_DIRECTORY : \nString\n\n\nThe folder specified as folder_to_save does not exist (checked by BaseKonnector)\n\n\nKind\n: global constant\n\n\n\n\nVENDOR_DOWN : \nString\n\n\nThe vendor\ns website is down\n\n\nKind\n: global constant\n\n\n\n\nUSER_ACTION_NEEDED : \nString\n\n\nThere was an unexpected error, please take a look at the logs to know what happened\n\n\nKind\n: global constant\n\n\n\n\nFILE_DOWNLOAD_FAILED : \nString\n\n\nThere was a problem while downloading a file\n\n\nKind\n: global constant\n\n\n\n\nSAVE_FILE_FAILED : \nString\n\n\nThere was a problem while saving a file\n\n\nKind\n: global constant\n\n\n\n\nmkSpec()\n\n\nDeclarative scraping.\n\n\nDescribe your items attributes and where to find/parse them\ninstead of imperatively building them.\n\n\nHeavily inspired by \nartoo\n scraping method.\n\n\nKind\n: global function\n\n\n\n\nscrape($, spec(s), [childSelector]) \u21d2 \nobject\n | \narray\n\n\nScrape a cheerio object for properties\n\n\nKind\n: global function\n\n\nReturns\n: \nobject\n | \narray\n - - Item(s) scraped  \n\n\n\n\n\n\n\n\nParam\n\n\nType\n\n\nDescription\n\n\n\n\n\n\n\n\n\n\n$\n\n\ncheerio\n\n\nCheerio node which will be scraped\n\n\n\n\n\n\nspec(s)\n\n\nobject\n | \nstring\n\n\nOptions object describing what you want to scrape\n\n\n\n\n\n\n[childSelector]\n\n\nstring\n\n\nIf passed, scrape will return an array of items\n\n\n\n\n\n\n\n\n\u26a0 Permissions\n\n\nPlease note that some classes require some permissions:\n\n\n\n\nio.cozy.accounts\n for the \nBaseKonnector\n class (\nGET\n only)\n\n\nio.cozy.files\n to save files\n\n\nio.cozy.bills\n to save bills\n\n\nio.cozy.bank.operations\n for \nlinkBankOperations", 
            "title": "API"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#api", 
            "text": "", 
            "title": "API"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#modules", 
            "text": "addData  This function saves the data into the cozy blindly without check\nYou need at least the  POST  permission for the given doctype in your manifest, to be able to\nuse this function.  Parameters:   documents : an array of objects corresponding to the data you want to save in the cozy  doctype  (string): the doctype where you want to save data (ex:  io.cozy.bills )   const documents = [\n  {\n    name:  toto ,\n    height: 1.8\n  },\n  {\n    name:  titi ,\n    height: 1.7\n  }\n]\n\nreturn addData(documents,  io.cozy.height )   cozyClient  This is a  cozy-client-js  instance already initialized and ready to use  If you want to access cozy-client-js directly, this method gives you directly an instance of it,\ninitialized according to  COZY_URL  and  COZY_CREDENTIALS  environment variable given by cozy-stack\nYou can refer to the  cozy-client-js documentation  for more information.  Example :  const {cozyClient} = require( cozy-konnector-libs )\n\ncozyClient.data.defineIndex( my.doctype , [ _id ])   filterData  This function filters the passed array from data already present in the cozy so that there is\nnot duplicated data in the cozy.\nYou need at least the  GET  permission for the given doctype in your manifest, to be able to\nuse this function.  Parameters:   documents : an array of objects corresponding to the data you want to save in the cozy  doctype  (string): the doctype where you want to save data (ex:  io.cozy.bills )  options  :  keys  (array) : List of keys used to check that two items are the same. By default it is set to `[ id ] .  index  (optionnal) : Return value returned by  cozy.data.defineIndex , the default will correspond to all documents of the selected doctype.  selector  (optionnal object) : Mango request to get records. Default is built from the keys  {selector: {_id: { $gt : null}}}  to get all the records.     const documents = [\n  {\n    name:  toto ,\n    height: 1.8\n  },\n  {\n    name:  titi ,\n    height: 1.7\n  }\n]\n\nreturn filterData(documents,  io.cozy.height , {\n  keys: [ name ]\n}).then(filteredDocuments =  addData(filteredDocuments,  io.cozy.height ))   linkBankOperations", 
            "title": "Modules"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#classes", 
            "text": "BaseKonnector  The class from which all the connectors must inherit.\nIt takes a fetch function in parameter that must return a  Promise .\nYou need at least the  GET  permission on  io.cozy.accounts  in your manifest to allow it to\nfetch account information for your connector.   Document  Simple Model for Documents. Allows to specify shouldSave ,  shouldUpdate  as methods.  Has useful  isEqual  method", 
            "title": "Classes"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#constants", 
            "text": "LOGIN_FAILED  :  String  The konnector could not login   NOT_EXISTING_DIRECTORY  :  String  The folder specified as folder_to_save does not exist (checked by BaseKonnector)   VENDOR_DOWN  :  String  The vendor s website is down   USER_ACTION_NEEDED  :  String  There was an unexpected error, please take a look at the logs to know what happened   FILE_DOWNLOAD_FAILED  :  String  There was a problem while downloading a file   SAVE_FILE_FAILED  :  String  There was a problem while saving a file", 
            "title": "Constants"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#functions", 
            "text": "mkSpec()  Declarative scraping.  Describe your items attributes and where to find/parse them\ninstead of imperatively building them.  Heavily inspired by  artoo  scraping method.   scrape($, spec(s), [childSelector])  \u21d2  object  |  array  Scrape a cheerio object for properties", 
            "title": "Functions"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#adddata", 
            "text": "This function saves the data into the cozy blindly without check\nYou need at least the  POST  permission for the given doctype in your manifest, to be able to\nuse this function.  Parameters:   documents : an array of objects corresponding to the data you want to save in the cozy  doctype  (string): the doctype where you want to save data (ex:  io.cozy.bills )   const documents = [\n  {\n    name: 'toto',\n    height: 1.8\n  },\n  {\n    name: 'titi',\n    height: 1.7\n  }\n]\n\nreturn addData(documents, 'io.cozy.height')", 
            "title": "addData"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#cozyclient", 
            "text": "This is a  cozy-client-js  instance already initialized and ready to use  If you want to access cozy-client-js directly, this method gives you directly an instance of it,\ninitialized according to  COZY_URL  and  COZY_CREDENTIALS  environment variable given by cozy-stack\nYou can refer to the  cozy-client-js documentation  for more information.  Example :  const {cozyClient} = require('cozy-konnector-libs')\n\ncozyClient.data.defineIndex('my.doctype', ['_id'])", 
            "title": "cozyClient"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#filterdata", 
            "text": "This function filters the passed array from data already present in the cozy so that there is\nnot duplicated data in the cozy.\nYou need at least the  GET  permission for the given doctype in your manifest, to be able to\nuse this function.  Parameters:   documents : an array of objects corresponding to the data you want to save in the cozy  doctype  (string): the doctype where you want to save data (ex:  io.cozy.bills )  options  :  keys  (array) : List of keys used to check that two items are the same. By default it is set to `[ id ] .  index  (optionnal) : Return value returned by  cozy.data.defineIndex , the default will correspond to all documents of the selected doctype.  selector  (optionnal object) : Mango request to get records. Default is built from the keys  {selector: {_id: {\"$gt\": null}}}  to get all the records.   const documents = [\n  {\n    name: 'toto',\n    height: 1.8\n  },\n  {\n    name: 'titi',\n    height: 1.7\n  }\n]\n\nreturn filterData(documents, 'io.cozy.height', {\n  keys: ['name']\n}).then(filteredDocuments =  addData(filteredDocuments, 'io.cozy.height'))", 
            "title": "filterData"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#filterdatasuitablecall", 
            "text": "Since we can use methods or basic functions for shouldSave  and  shouldUpdate  we pass the\nappropriate  this  and  arguments .  If  funcOrMethod  is a method, it will be called\nwith args[0] as  this  and the rest as  arguments \nOtherwise,  this  will be null and  args  will be passed\nas  arguments .  Kind : inner method of  filterData", 
            "title": "filterData~suitableCall()"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#linkbankoperations", 
            "text": "", 
            "title": "linkBankOperations"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#linkbankoperations-entries-doctype-fields-options", 
            "text": "This function will soon move to a dedicated service. You should not use it.\nThe goal of this function is to find links between bills and bank operations.", 
            "title": "linkBankOperations ( entries, doctype, fields, options = {} )"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#mkdirp", 
            "text": "Creates a directory and its missing ancestors as needed.  Options :   ...pathComponents :  one or many path components to be joined   await mkdirp('/foo') // Creates /foo\nawait mkdirp('/foo') // Does nothing as /foo already exists\nawait mkdirp('/bar/baz') // Creates /bar, then /bar/baz\nawait mkdirp('/foo/bar/baz') // Creates /foo/bar, then /foo/bar/baz, not /foo\nawait mkdirp('/') // Does nothing\nawait mkdirp('/qux', 'qux2/qux3', 'qux4') // Creates /qux, then /qux/qux2,\n                                          // then /qux/qux2/qux3 and\n                                          // finally /qux/qux2/qux3/qux4  The function will automatically add a leading slash when missing:  await mkdirp('foo', 'bar') // Creates /foo, then /foo/bar a name= module_normalizeFilename /a \n\n## normalizeFilename\nReturns the given name, replacing characters that could be an issue when\nused in a filename with spaces.\n\nReplaced characters include:\n\n- Those forbidden on one or many popular OS or filesystem: ` : /\\|?*`\n- Those forbidden by the cozy-stack `\\0`, `\\r` and `\\n`\n- Multiple spaces and/or tabs are replaced with a single space\n- Leading   trailing spaces and/or tabs are removed\n\nAn exception will be thrown in case there is not any filename-compatible\ncharacter in the given name.\n\nParameters:\n\n- `basename` is whatever string you want to generate the filename from\n- `ext` is an optional file extension, with or without leading dot\n\n```javascript\nconst { normalizeFilename } = require('cozy-konnector-libs')\n\nconst filename = normalizeFilename('*foo/bar:  baz  \\\\ qux \\t???', '.txt')\n// `filename` === `foo bar baz qux.txt`", 
            "title": "mkdirp"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#requestfactory", 
            "text": "This is a function which returns an instance of request-promise  initialized with\ndefaults often used in connector development.  // Showing defaults\nreq = requestFactory({\n  cheerio: false,\n  jar: true,\n  json: true\n})  Options :   cheerio :  will parse automatically the  response.body  in a cheerio instance   req = requestFactory({ cheerio: true })\nreq('http://github.com', $ =  {\n  const repos = $('#repo_listing .repo')\n})   jar : is passed to  request  options. Remembers cookies for future use.  json : will parse the  response.body  as JSON  json : will parse the  response.body  as JSON  resolveWithFullResponse : The full response will be return in the promise. It is compatible\n  with cheerio and json options.   req = requestFactory({\n   resolveWithFullResponse: true,\n   cheerio: true\n})\nreq('http://github.com', response =  {\n  console.log(response.statusCode)\n  const $ = response.body\n  const repos = $('#repo_listing .repo')\n})  You can find the full list of available options in  request-promise  and  request  documentations.", 
            "title": "requestFactory"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#savebills", 
            "text": "Combines the features of  saveFiles ,  filterData ,  addData  and  linkBankOperations  for a\ncommon case: bills.\nWill create  io.cozy.bills  objects. The default deduplication keys are  ['date', 'amount', 'vendor'] .\nYou need the full permission on  io.cozy.bills , full permission on  io.cozy.files  and also\nfull permission on  io.cozy.bank.operations  in your manifest, to be able to * use this function.  Parameters:   documents  is an array of objects with any attributes :  fields  (object) this is the first parameter given to BaseKonnector s constructor  options  is passed directly to  saveFiles ,  hydrateAndFilter ,  addData  and  linkBankOperations .   const { BaseKonnector, saveBills } = require('cozy-konnector-libs')\n\nmodule.exports = new BaseKonnector(function fetch (fields) {\n  const documents = []\n  // some code which fills documents\n  return saveBills(documents, fields, {\n    identifiers: ['vendorj']\n  })\n})", 
            "title": "saveBills"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#savefiles", 
            "text": "The goal of this function is to save the given files in the given folder via the Cozy API.\nYou need the full permission on  io.cozy.files  in your manifest to use this function.    files  is an array of  { fileurl, filename }  :    fileurl: The url of the file. This attribute is mandatory or\n    this item will be ignored    filename : The file name of the item written on disk. This attribute is optional and as default value, the\n    file name will be  smartly  guessed by the function. Use this attribute if the guess is not smart\n  enough for you.    folderPath  (string) is relative to the main path given by the  cozy-collect  application to the connector. If the connector is run\nin standalone mode, the main path is the path of the connector.    options  (object) is optional. Possible options :    timeout  (timestamp) can be used if your connector needs to fetch a lot of files and if the\n  stack does not give enough time to your connector to fetch it all. It could happen that the\n  connector is stopped right in the middle of the download of the file and the file will be\n  broken. With the  timeout  option, the  saveFiles  function will check if the timeout has\n  passed right after downloading each file and then will be sure to be stopped cleanly if the\n  timeout is not too long. And since it is really fast to check that a file has already been\n  downloaded, on the next run of the connector, it will be able to download some more\n  files, and so on. If you want the timeout to be in 10s, do  Date.now() + 10*1000 .\n  You can try it in the previous code.", 
            "title": "saveFiles"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#signin", 
            "text": "The goal of this function is to provide an handy method to log the user in,\non html form pages. On success, it resolves a promise with a parsed body.  Errors:   LOGIN_FAILED if the validate predicate is false  INVALID_FORM if the element matched by  formSelector  is not a form or has\n  no  action  attribute  UNKNOWN_PARSING_STRATEGY if  parse  is not one of the accepted values:\n   raw ,  cheerio ,  json .  VENDOR_DOWN if a request throws a RequestError, or StatusCodeError   It does not submit values provided through  select  tags, except if populated\nby user with  formData .    url  is the url to access the html form    formSelector  is used by cheerio to uniquely identify the form in which to\n  log in    formData  is an object  { name: value, \u2026 } . It is used to populate the\n  form, in the proper inputs with the same name as the properties of this\n  object, before submitting it. It can also be a function that returns this\n  object. The page at  url  would be given as argument, right after having\n  been parsed through  cheerio .    parse  allow the user to resolve  signin  with a preparsed body. The\n  choice of the strategy for the parsing is one of :  raw ,  json  or\n   cheerio .  cheerio  being the default.    validate  is a predicate taking two arguments  statusCode  and\n   parsedBody . If it is false,  LOGIN_FAILED  is thrown, otherwise the\n  signin resolves with  parsedBody  value.    requestOpts  allows to pass eventual options to the  signin s\n   requestFactory . It could be useful for pages using  latin1   encoding \n  for instance.", 
            "title": "signin"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#updateorcreate", 
            "text": "The goal of this function is create or update the given entries according to if they already\nexist in the cozy or not\nYou need the full permission for the given doctype in your manifest, to be able to\nuse this function.  Parameters:   entries  is an array of objects with any attributes :  doctype  (string) is the cozy doctype where the entries should be saved  matchingAttributes  (array of strings) is the list of attributes in each entry should be used to check if an entry\n  is already saved in the cozy", 
            "title": "updateOrCreate"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#basekonnector", 
            "text": "The class from which all the connectors must inherit.\nIt takes a fetch function in parameter that must return a  Promise .\nYou need at least the  GET  permission on  io.cozy.accounts  in your manifest to allow it to\nfetch account information for your connector.  Kind : global class     BaseKonnector  new BaseKonnector(fetch)  .end()  .fail()  .init()  \u21d2  Promise  .saveAccountData(data, options)  \u21d2  Promise  .terminate(message)", 
            "title": "BaseKonnector"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#new-basekonnectorfetch", 
            "text": "Its role is twofold :   Make the link between account data and konnector  Handle errors   \u26a0\ufe0f  A promise should be returned from the  fetch  function otherwise\nthe konnector cannot know that asynchronous code has been called.  this.terminate('LOGIN_FAILED')     Param  Type  Description      fetch  function  Function to be run automatically after account data is fetched. This function will be binded to the current connector. If not fetch function is given. The connector will have to handle itself it s own exection and error handling     Example     const { BaseKonnector } = require('cozy-konnector-libs')\n\nmodule.exports = new BaseKonnector(function fetch () {\n // use this to access the instance of the konnector to\n // store any information that needs to be passed to\n // different stages of the konnector\n return request('http://ameli.fr')\n   .then(computeReimbursements)\n   .then(saveBills)\n})", 
            "title": "new BaseKonnector(fetch)"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#basekonnectorend", 
            "text": "Hook called when the connector is ended  Kind : instance method of  BaseKonnector", 
            "title": "baseKonnector.end()"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#basekonnectorfail", 
            "text": "Hook called when the connector fails  Kind : instance method of  BaseKonnector", 
            "title": "baseKonnector.fail()"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#basekonnectorinit-promise", 
            "text": "Initializes the current connector with data comming from the associated account  Kind : instance method of  BaseKonnector  Returns :  Promise  - with the fields as an object", 
            "title": "baseKonnector.init() \u21d2 Promise"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#basekonnectorsaveaccountdatadata-options-promise", 
            "text": "Saves data to the account that is passed to the konnector.\nUse it to persist data that needs to be passed to each\nkonnector run.  By default, the data is merged to the remote data, use options.merge = false  to overwrite the data.  The data is saved under the  .data  attribute of the cozy\naccount.  Kind : instance method of  BaseKonnector        Param  Type  Description      data  object  Attributes to be merged    options  object  { merge: true", 
            "title": "baseKonnector.saveAccountData(data, options) \u21d2 Promise"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#basekonnectorterminatemessage", 
            "text": "Send a special error code which is interpreted by the cozy stack to terminate the execution of the\nconnector now  Kind : instance method of  BaseKonnector        Param  Type  Description      message  string  The error code to be saved as connector result see [docs/ERROR_CODES.md]", 
            "title": "baseKonnector.terminate(message)"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#document", 
            "text": "Simple Model for Documents. Allows to specify shouldSave ,  shouldUpdate  as methods.  Has useful  isEqual  method  Kind : global class", 
            "title": "Document"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#documentisequal", 
            "text": "Compares to another document deeply.  _id  and  _rev  are by default ignored in the comparison.  By default, will compare dates loosely since you often\ncompare existing documents (dates in ISO string) with documents\nthat just have been scraped where dates are  Date s.  Kind : instance method of  Document", 
            "title": "document.isEqual()"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#login_failed-string", 
            "text": "The konnector could not login  Kind : global constant", 
            "title": "LOGIN_FAILED : String"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#not_existing_directory-string", 
            "text": "The folder specified as folder_to_save does not exist (checked by BaseKonnector)  Kind : global constant", 
            "title": "NOT_EXISTING_DIRECTORY : String"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#vendor_down-string", 
            "text": "The vendor s website is down  Kind : global constant", 
            "title": "VENDOR_DOWN : String"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#user_action_needed-string", 
            "text": "There was an unexpected error, please take a look at the logs to know what happened  Kind : global constant", 
            "title": "USER_ACTION_NEEDED : String"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#file_download_failed-string", 
            "text": "There was a problem while downloading a file  Kind : global constant", 
            "title": "FILE_DOWNLOAD_FAILED : String"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#save_file_failed-string", 
            "text": "There was a problem while saving a file  Kind : global constant", 
            "title": "SAVE_FILE_FAILED : String"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#mkspec", 
            "text": "Declarative scraping.  Describe your items attributes and where to find/parse them\ninstead of imperatively building them.  Heavily inspired by  artoo  scraping method.  Kind : global function", 
            "title": "mkSpec()"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#scrape-specs-childselector-object-124-array", 
            "text": "Scrape a cheerio object for properties  Kind : global function  Returns :  object  |  array  - - Item(s) scraped       Param  Type  Description      $  cheerio  Cheerio node which will be scraped    spec(s)  object  |  string  Options object describing what you want to scrape    [childSelector]  string  If passed, scrape will return an array of items", 
            "title": "scrape($, spec(s), [childSelector]) \u21d2 object | array"
        }, 
        {
            "location": "/cozy-konnector-libs/api/#permissions", 
            "text": "Please note that some classes require some permissions:   io.cozy.accounts  for the  BaseKonnector  class ( GET  only)  io.cozy.files  to save files  io.cozy.bills  to save bills  io.cozy.bank.operations  for  linkBankOperations", 
            "title": "\u26a0 Permissions"
        }, 
        {
            "location": "/cozy-konnector-libs/cli/", 
            "text": "CLI\n\n\ncozy-konnector-libs\n also comes with some cli tools which allow to run your connector in standalone\nor development mode\n\n\ncozy-konnector-standalone\n\n\nIf you just want to test your connector without any cozy available. Just add the following code in\nthe \nscripts\n section of your package.json file\n\n\n  scripts: {\n    standalone: \ncozy-konnector-standalone\n\n  }\n\n\n\n\nand run:\n\n\nyarn standalone\n\n\n\n\nThe requests to the cozy-stack will be stubbed using the [./fixture.json] file as source of data\nand when cozy-client-js is asked to create or update data, the data will be output to the console.\nThe bills (or any file) will be saved in the . directory.\n\n\nIt is possible to add an argument to this command which tells which file to run. Default is\ndefined in \npackage.json\n \nmain\n section or ./index.js\n\n\nIt is possible to record and replay the requests done by the standalone command using the\n\nreplay\n module.\n\n\nArguments\n\n\nUsage: cozy-konnector-standalone [options] \nfile\n\n\n\nOptions:\n\n  --record  Record all the requests in the ./fixtures directory using the replay module\n  --replay  Replay all the recorded requests\n  -h, --help  output usage information\n\n\n\n\ncozy-konnector-dev\n\n\nIf you want to run your connector linked to a cozy-stack, even remotely. Just add the follwing code\nin the \nscripts\n section of your package.json file:\n\n\n  scripts: {\n    dev: \ncozy-konnector-dev\n\n  }\n\n\n\n\nand run:\n\n\nyarn dev\n\n\n\n\nThis command will register your konnector as an OAuth application to the cozy-stack and then set the \nCOZY_CREDENTIALS\n and \nCOZY_FIELDS\n environment variable. By default,\nthe cozy-stack is supposed to be located in http://cozy.tools:8080. If this is not your case, just\nupdate the COZY_URL field in [./konnector-dev-config.json].\n\n\nAfter that, your konnector is running but should not work since you did not specify any credentials to\nthe target service. You can do this also in [./konnector-dev-config.json] in the \nfields\n section.\n\n\nThe files are saved in the root directory of your cozy by default.\n\n\nIt is also possible to add an argument to this command which tells which file to run. Default is\ndefined in \npackage.json\n \nmain\n section or ./index.js\n\n\nArguments\n\n\n$ cozy-konnector-dev \nfile\n [-t token.json] [-m manifest.webapp]\n\n\n\n\nAs for the \nstandalone\n command, you can specify which file to run. Default is \n./index.js\n.\n\n\n\n\n-t\n, \n--token\n : Specify where the token should be saved\n\n\n-m\n, \n--manifest\n : Specify the manifest.path that should be used for the permissions", 
            "title": "CLI"
        }, 
        {
            "location": "/cozy-konnector-libs/cli/#cli", 
            "text": "cozy-konnector-libs  also comes with some cli tools which allow to run your connector in standalone\nor development mode", 
            "title": "CLI"
        }, 
        {
            "location": "/cozy-konnector-libs/cli/#cozy-konnector-standalone", 
            "text": "If you just want to test your connector without any cozy available. Just add the following code in\nthe  scripts  section of your package.json file    scripts: {\n    standalone:  cozy-konnector-standalone \n  }  and run:  yarn standalone  The requests to the cozy-stack will be stubbed using the [./fixture.json] file as source of data\nand when cozy-client-js is asked to create or update data, the data will be output to the console.\nThe bills (or any file) will be saved in the . directory.  It is possible to add an argument to this command which tells which file to run. Default is\ndefined in  package.json   main  section or ./index.js  It is possible to record and replay the requests done by the standalone command using the replay  module.", 
            "title": "cozy-konnector-standalone"
        }, 
        {
            "location": "/cozy-konnector-libs/cli/#arguments", 
            "text": "Usage: cozy-konnector-standalone [options]  file \n\n\nOptions:\n\n  --record  Record all the requests in the ./fixtures directory using the replay module\n  --replay  Replay all the recorded requests\n  -h, --help  output usage information", 
            "title": "Arguments"
        }, 
        {
            "location": "/cozy-konnector-libs/cli/#cozy-konnector-dev", 
            "text": "If you want to run your connector linked to a cozy-stack, even remotely. Just add the follwing code\nin the  scripts  section of your package.json file:    scripts: {\n    dev:  cozy-konnector-dev \n  }  and run:  yarn dev  This command will register your konnector as an OAuth application to the cozy-stack and then set the  COZY_CREDENTIALS  and  COZY_FIELDS  environment variable. By default,\nthe cozy-stack is supposed to be located in http://cozy.tools:8080. If this is not your case, just\nupdate the COZY_URL field in [./konnector-dev-config.json].  After that, your konnector is running but should not work since you did not specify any credentials to\nthe target service. You can do this also in [./konnector-dev-config.json] in the  fields  section.  The files are saved in the root directory of your cozy by default.  It is also possible to add an argument to this command which tells which file to run. Default is\ndefined in  package.json   main  section or ./index.js", 
            "title": "cozy-konnector-dev"
        }, 
        {
            "location": "/cozy-konnector-libs/cli/#arguments_1", 
            "text": "$ cozy-konnector-dev  file  [-t token.json] [-m manifest.webapp]  As for the  standalone  command, you can specify which file to run. Default is  ./index.js .   -t ,  --token  : Specify where the token should be saved  -m ,  --manifest  : Specify the manifest.path that should be used for the permissions", 
            "title": "Arguments"
        }, 
        {
            "location": "/cozy-konnector-libs/dev/", 
            "text": "Developing a konnector\n\n\nWithout an accessible cozy-stack\n\n\nIf you just want to test this connector without any cozy available.\n\n\nYou first need an installed [nodejs] (LTS version is fine).\n\n\nAnd the last version of yarn :\n\n\nnpm install --global yarn\n\n\n\n\nThen just run :\n\n\nyarn\nyarn standalone\n\n\n\n\nThe requests to the cozy-stack will be stubbed using the [./fixture.json] file as source of data\nand when cozy-client is asked to create or update data, the data will be output to the console.\nThe bills (or any file) will be saved in the . directory.\n\n\nWith the cozy-stack\n\n\nIf you do not want to have to install the konnector on a cozy v3 to test it, you can register the\nkonnector as an OAuth application with the following commands :\n\n\nyarn\nyarn dev\n\n\n\n\nThis command will register your konnector as an OAuth application to the cozy-stack. By default,\nthe cozy-stack is supposed to be located in http://cozy.tools:8080. If this is not your case, just\nupdate the COZY_URL field in [./konnector-dev-config.json].\n\n\nAfter that, your konnector is running but should not work since you did not specify any credentials to\nthe target service. You can do this also in [./konnector-dev-config.json] in the \nfields\n\nattribute.\n\n\nNow run \nyarn dev\n one more time, it should be ok.\n\n\nThe files are saved in the root directory of your cozy by default.\n\n\nHow does the cozy-stack run the connector ?\n\n\nThe cozy-stack runs the connector in a nsjail container to be sure it does not affect the environment.\n\n\nThe connector is run by calling yarn start with the following envrionment variables :\n\n\n\n\nCOZY_CREDENTIALS needs to be the result of \ncozy-stack instances token-cli \ninstance name\n \nscope\n\n\nCOZY_URL is the full http or https url to your cozy\n\n\nCOZY_FIELDS is something like :\n\n\n\n\n{\n  \ndata\n:{\n    \nattributes\n:{\n      \narguments\n:{\n        \naccount\n:\ncf31eaef5d899404a7e8c3737c1c2d1f\n,\n        \nfolder_to_save\n:\nfolderPathId\n,\n        \nslug\n:\nmykonnector\n\n      }\n    }\n  }\n}\n\n\n\n\nThe \naccount\n field is the id of the record with doctype \nio.cozy.accounts\n which will be used as\nparameters for your konnector.\n\n\nBuild (without Travis)\n\n\nTo be able to run the connector, the cozy stack needs a connector which is built into only one\nfile, without needing to install its dependencies, this will be a lot faster to install.\n\n\nThere is a command in package.json to help you to do that : \nyarn build\n\n\nThis command uses [webpack] to bundle all the code needed by your connector into one file.\n\n\nThis will generate an index.js file in the build directory and add all files the connector will need.\n\n\nYou can deploy this build by using the specific script : \nyarn deploy\n\n\nThis command will commit and push your build in the branch \nbuild\n fo your project.\n\n\nAnd your konnector can now be installed using the following url :\n\n\ngit://github.com/konnectors/cozy-konnector-\n.git#build\n\n\nBuild using Travis CI\n\n\nThis project contains a \n.travis.yml\n config file which allows you to build your connector\nautomatically using [Travis-CI][travis].\n\n\nYou can follow these steps to enable building using Travis:\n\n\n\n\nOn your [travis-ci.org][travis] account, find your project name (should be the same than your Github repository) and enable Travis by using the related checkbox.\n\n\nOnce enabled, go to this project on Travis by clicking on it and go to the \nSettings\n menu by using the \nMore options\n menu at the top right.\n\n\nEnable these three options:\n\n\nBuild only if .travis.yml is present\n\n\nBuild branch updates\n (run Travis after each branch update)\n\n\nBuild pull request updates\n (run Travis after each Pull Request update)\n\n\n\n\n\n\nThen, you have to generate a Github token in \nyour Github account settings\n. Here is the \nGithub blog post about API token\n. Don\nt forget to authorize the access to the repo scope like following: \n\n\nThen, add an environment variable (still in your Travis project settings) named \nGITHUB_TOKEN\n and use your previous generated Github token as value (We highly recommand you to \nkeep the checkbox \nDisplay value in build log\n to OFF value\n in order to keep your token value hidden in the Travis logs.)\n\n\n\n\nNow Travis is ready to build your project, it should build it each time your push a commit in your repository or create a pull request.\n\n\n\n\nNote:\n Travis will push your build to your \nbuild\n branch ONLY for commits made on your master branch (included PR merge commits). You can see the related Travis statement \nhere\n.\n\n\n\n\nAdd your new connector to \nCozy Collect\n\n\nThe Cozy Collect application will soon use an application store as source of connectors. But for\nnow, if you want to add your new connector to Cozy Collect, you can submit a message in the forum\nin the \ncollect section\n, and we will handle this for\nyou.", 
            "title": "Develop"
        }, 
        {
            "location": "/cozy-konnector-libs/dev/#developing-a-konnector", 
            "text": "", 
            "title": "Developing a konnector"
        }, 
        {
            "location": "/cozy-konnector-libs/dev/#without-an-accessible-cozy-stack", 
            "text": "If you just want to test this connector without any cozy available.  You first need an installed [nodejs] (LTS version is fine).  And the last version of yarn :  npm install --global yarn  Then just run :  yarn\nyarn standalone  The requests to the cozy-stack will be stubbed using the [./fixture.json] file as source of data\nand when cozy-client is asked to create or update data, the data will be output to the console.\nThe bills (or any file) will be saved in the . directory.", 
            "title": "Without an accessible cozy-stack"
        }, 
        {
            "location": "/cozy-konnector-libs/dev/#with-the-cozy-stack", 
            "text": "If you do not want to have to install the konnector on a cozy v3 to test it, you can register the\nkonnector as an OAuth application with the following commands :  yarn\nyarn dev  This command will register your konnector as an OAuth application to the cozy-stack. By default,\nthe cozy-stack is supposed to be located in http://cozy.tools:8080. If this is not your case, just\nupdate the COZY_URL field in [./konnector-dev-config.json].  After that, your konnector is running but should not work since you did not specify any credentials to\nthe target service. You can do this also in [./konnector-dev-config.json] in the  fields \nattribute.  Now run  yarn dev  one more time, it should be ok.  The files are saved in the root directory of your cozy by default.", 
            "title": "With the cozy-stack"
        }, 
        {
            "location": "/cozy-konnector-libs/dev/#how-does-the-cozy-stack-run-the-connector", 
            "text": "The cozy-stack runs the connector in a nsjail container to be sure it does not affect the environment.  The connector is run by calling yarn start with the following envrionment variables :   COZY_CREDENTIALS needs to be the result of  cozy-stack instances token-cli  instance name   scope  COZY_URL is the full http or https url to your cozy  COZY_FIELDS is something like :   {\n   data :{\n     attributes :{\n       arguments :{\n         account : cf31eaef5d899404a7e8c3737c1c2d1f ,\n         folder_to_save : folderPathId ,\n         slug : mykonnector \n      }\n    }\n  }\n}  The  account  field is the id of the record with doctype  io.cozy.accounts  which will be used as\nparameters for your konnector.", 
            "title": "How does the cozy-stack run the connector ?"
        }, 
        {
            "location": "/cozy-konnector-libs/dev/#build-without-travis", 
            "text": "To be able to run the connector, the cozy stack needs a connector which is built into only one\nfile, without needing to install its dependencies, this will be a lot faster to install.  There is a command in package.json to help you to do that :  yarn build  This command uses [webpack] to bundle all the code needed by your connector into one file.  This will generate an index.js file in the build directory and add all files the connector will need.  You can deploy this build by using the specific script :  yarn deploy  This command will commit and push your build in the branch  build  fo your project.  And your konnector can now be installed using the following url :  git://github.com/konnectors/cozy-konnector- .git#build", 
            "title": "Build (without Travis)"
        }, 
        {
            "location": "/cozy-konnector-libs/dev/#build-using-travis-ci", 
            "text": "This project contains a  .travis.yml  config file which allows you to build your connector\nautomatically using [Travis-CI][travis].  You can follow these steps to enable building using Travis:   On your [travis-ci.org][travis] account, find your project name (should be the same than your Github repository) and enable Travis by using the related checkbox.  Once enabled, go to this project on Travis by clicking on it and go to the  Settings  menu by using the  More options  menu at the top right.  Enable these three options:  Build only if .travis.yml is present  Build branch updates  (run Travis after each branch update)  Build pull request updates  (run Travis after each Pull Request update)    Then, you have to generate a Github token in  your Github account settings . Here is the  Github blog post about API token . Don t forget to authorize the access to the repo scope like following:   Then, add an environment variable (still in your Travis project settings) named  GITHUB_TOKEN  and use your previous generated Github token as value (We highly recommand you to  keep the checkbox  Display value in build log  to OFF value  in order to keep your token value hidden in the Travis logs.)   Now Travis is ready to build your project, it should build it each time your push a commit in your repository or create a pull request.   Note:  Travis will push your build to your  build  branch ONLY for commits made on your master branch (included PR merge commits). You can see the related Travis statement  here .", 
            "title": "Build using Travis CI"
        }, 
        {
            "location": "/cozy-konnector-libs/dev/#add-your-new-connector-to-cozy-collect", 
            "text": "The Cozy Collect application will soon use an application store as source of connectors. But for\nnow, if you want to add your new connector to Cozy Collect, you can submit a message in the forum\nin the  collect section , and we will handle this for\nyou.", 
            "title": "Add your new connector to Cozy Collect"
        }, 
        {
            "location": "/cozy-konnector-libs/errors/", 
            "text": "Communication with the outside\n\n\nKonnectors communicate with the stack via its stdout. Each line is parsed by the stack as JSON.\n\n\nWhen an error is thrown by the konnector, it is catched and translated to JSON.\n\n\nMessage types\n\n\nThis is the list of error codes that your konnector can \nthrow\n and which will be translated by the \ncollect\n application.\n\n\nExample :\n\n\nconst login = function () {\n  throw new Error('LOGIN_FAILED')\n}\n\n\n\n\nCollect\n will then signal to the user that the credentials used are not correct.\n\n\n\n\n\n\n\n\nError code\n\n\nMeaning\n\n\n\n\n\n\n\n\n\n\nLOGIN_OK\n\n\nThe konnector has logged in\n\n\n\n\n\n\nLOGIN_FAILED\n\n\nThe konnector could not login\n\n\n\n\n\n\nNOT_EXISTING_DIRECTORY\n\n\nThe folder specified as folder_to_save does not exist (checked by BaseKonnector)\n\n\n\n\n\n\nVENDOR_DOWN\n\n\nThe vendor\ns website is down\n\n\n\n\n\n\nUSER_ACTION_NEEDED\n\n\nThe user needs to go to the vendor\ns website to fix something\n\n\n\n\n\n\nUNKNOWN_ERROR\n\n\nThere was an unexpected error, please take a look at the logs to know what happened\n\n\n\n\n\n\n\n\nSentry\n\n\nIf \nprocess.env.SENTRY_DSN\n is set :\n\n\n\n\nRaven will be configured to send exception to this address\n\n\nthe BaseKonnector will have its \nrun\n method wrapped into a \nRaven.context\n so that when it fails, it sends the exception to Raven before exiting.\n\n\n\n\nThe idea being that the \nprocess.env.SENTRY_DSN\n is only set up for people having opted in for exception handling. Self-hosted instances of the cozy-stack will be free to use or not our SENTRY_DSN.", 
            "title": "Errors"
        }, 
        {
            "location": "/cozy-konnector-libs/errors/#communication-with-the-outside", 
            "text": "Konnectors communicate with the stack via its stdout. Each line is parsed by the stack as JSON.  When an error is thrown by the konnector, it is catched and translated to JSON.", 
            "title": "Communication with the outside"
        }, 
        {
            "location": "/cozy-konnector-libs/errors/#message-types", 
            "text": "This is the list of error codes that your konnector can  throw  and which will be translated by the  collect  application.  Example :  const login = function () {\n  throw new Error('LOGIN_FAILED')\n}  Collect  will then signal to the user that the credentials used are not correct.     Error code  Meaning      LOGIN_OK  The konnector has logged in    LOGIN_FAILED  The konnector could not login    NOT_EXISTING_DIRECTORY  The folder specified as folder_to_save does not exist (checked by BaseKonnector)    VENDOR_DOWN  The vendor s website is down    USER_ACTION_NEEDED  The user needs to go to the vendor s website to fix something    UNKNOWN_ERROR  There was an unexpected error, please take a look at the logs to know what happened", 
            "title": "Message types"
        }, 
        {
            "location": "/cozy-konnector-libs/errors/#sentry", 
            "text": "If  process.env.SENTRY_DSN  is set :   Raven will be configured to send exception to this address  the BaseKonnector will have its  run  method wrapped into a  Raven.context  so that when it fails, it sends the exception to Raven before exiting.   The idea being that the  process.env.SENTRY_DSN  is only set up for people having opted in for exception handling. Self-hosted instances of the cozy-stack will be free to use or not our SENTRY_DSN.", 
            "title": "Sentry"
        }, 
        {
            "location": "/cozy-konnector-libs/operation-linking/", 
            "text": "Linking bank operations\n\n\nWhen bills are saved via saveBills, we try to find a bank operation\nthat matches it.\n\n\nCriterias for matching :\n\n\n\n\nLabel : the label of the operation must match an identifier provided in the\nkonnector\n\n\n\n\nFor example, for SFR mobile, the identifiers that we try to find in the label is\n\nsfr mobile\n. For SFR box, we try to find \nsfr fixe\n and \nsfr adsl\n. We try to\nfind without the case.\n\n\n\n\n\n\nDate : the date of the banking operation must be +- 15 days of the bill\n\n\n\n\n\n\nAmount : the amount of the banking operation must be +-0.001 of the original\nbill amount\n\n\n\n\n\n\nThose criterias can be changed by the konnector themselves.", 
            "title": "Operation linking"
        }, 
        {
            "location": "/cozy-konnector-libs/operation-linking/#linking-bank-operations", 
            "text": "When bills are saved via saveBills, we try to find a bank operation\nthat matches it.  Criterias for matching :   Label : the label of the operation must match an identifier provided in the\nkonnector   For example, for SFR mobile, the identifiers that we try to find in the label is sfr mobile . For SFR box, we try to find  sfr fixe  and  sfr adsl . We try to\nfind without the case.    Date : the date of the banking operation must be +- 15 days of the bill    Amount : the amount of the banking operation must be +-0.001 of the original\nbill amount    Those criterias can be changed by the konnector themselves.", 
            "title": "Linking bank operations"
        }, 
        {
            "location": "/cozy-konnector-libs/synchronization/", 
            "text": "Table of contents\n\n\n\n\nKonnector synchronisation data and options\n\n\nProblems\n\n\nCurrent usage\n\n\nObjectives of this document\n\n\nStoring synchronization data in documents\n\n\nSimple case, by id\n\n\nBy multiple attributes\n\n\nBy custom method\n\n\n\n\n\n\nSaving document based on synchronization strategy\n\n\nAdding synchronization data\n\n\nFiltering entries\n\n\n\n\n\n\nSynchronization strategy\n\n\nfindLegacyDocument\n\n\ngetSyncData\n\n\nArray\n\n\nExample\n\n\n\n\n\n\nfunction\n\n\nExample\n\n\n\n\n\n\nkonnector\n\n\nshouldSave\n\n\nshouldUpdate\n\n\n\n\n\n\nWhole example\n\n\n\n\nKonnector synchronisation data and options\n\n\nProblems\n\n\nExcept bank konnectors which are already solving the addressed problem, all konnectors are currently processing data they are collecting in the same way:\n\n\n\n\nGet all data to synchronize\n\n\nStore it in CouchDB, even if it means overriding previously synchronized data.\n\n\n\n\nThis process has at least two major flows :\n\n We are always synchronizing \nall\n the data provided by the external service.\n\n When something is modified (for example, the name of the stored file, it\ns almost sure that the previous one will be kept and that we\nll have a duplicate)\n\n\nAnother side effect could be that in a very large set of documents to synchronize, the whole process may take more than 3 minutes and never synchronize documents at the end of the list.\n\n\nCurrent usage\n\n\nWhen saving bills, \ncozy-konnector-libs\n provides a filtering and hydratation mechanism, to avoid overriding existing bills. It is done in function \nhydrateAndFilters\n.\n\n\nThis method performs two actions :\n\n hydrate entries retrieved from service with usable data from couchDB (like existing bill id)\n\n filter entries retrieved from service and return only entries that need to be saved/synchronized.\n\n\nObjectives of this document\n\n\nThe goals of this document are:\n\n\n\n\nDefine a common way to store synchronization data for all konnector\n\n\nPropose a naive implementation for an abstract synchronisation data storing mechanism, provided by \ncozy-konnector-libs\n\n\nPropose a solution to synchronize every type of data or file, not only bills\n\n\nTaking the \nhydrateAndFilter\n function as basis, split it in three functions performing the following tasks : actual filtering, synchronization data hydratation and saving/updating current database document with correspondig external entries (the part done by the actual \nhydratation\n)\n\n\n\n\nStoring synchronization data in documents\n\n\nBefore saving any data or file, we will add in the relying document every synchronization data we will need. The added data will depend on how the service the konnector connects to retrieve entries and which information they gave us.\n\n\nSimple case, by id\n\n\nWe suppose that in the most cases, we will face to entries provinding their own \nid\n attribute. The idea is to store it as synchronization data to be able to easily retrieve them later.\nTo store synchronization data, we are using a \nsync\n attribute in document \nmetadata\n attribute. Example:\n\n\n{\n  \nmetadata\n: {\n    \nsync\n: {\n      \nid\n: \n7ee401e841c94159addb47f190903139\n,\n      \nkonnector\n: \ntrainline\n,\n      \nlast_sync\n: \nMon, 12 Feb 2018 16:25:34 GMT\n\n    }\n  }\n}\n\n\n\n\nThe expected information to be save is:\n\n\n\n\n\n\n\n\nfield\n\n\nrole\n\n\n\n\n\n\n\n\n\n\nid\n\n\nThe id of the document, but given by the external service. If the external service does not provide any id or uuid, it could be interesting to generate one, with an hash of the file for example.\n\n\n\n\n\n\nkonnector\n\n\nThe slug of the konnector (Example: \ntrainline\n, \nfreemobile\n, \ncic\n). This could be very useful to retrieve data synchronized with this konnector.\n\n\n\n\n\n\nlast_sync\n\n\nDate of last synchronization, set to \nnow()\n when storage is made.\n\n\n\n\n\n\n\n\nBy multiple attributes\n\n\nIf the external service does not provide any \nid\n attribute, we may need to use instead a list of attributes, for example \nfirstname\n, \nlastname\n, \ndateofbirth\n.\n\n\n{\n  \nmetadata\n: {\n    \nsync\n: {\n      \nfirstname\n: \nClaude\n,\n      \nlastname\n: \nCausi\n,\n      \ndateofbirth\n: \n06/12/1980\n\n    }\n  }\n}\n\n\n\n\nAs we cannot be sure that we will have different data, it could be better to use a custom way of providing an unique identifier.\n\n\nBy custom method\n\n\nWhen the external service does not provide any identifier, we have to use a custom method to generate one.\nIt could be for example the filename or a hash generated with the document content.\n\n\n{\n  \nmetadata\n: {\n    \nsync\n: {\n      \nid:\n: \ncustomhash34FED5465645ABF54656FCB\n\n    }\n  }\n}\n\n\n\n\nSaving document based on synchronization strategy\n\n\nTo solve the synchronization process weed need to:\n\n be able to add synchronization data on any type of document\n\n be able to compare external entries to current database state\n* provide a default implementation while letting the contributors to define their own ones\n\n\nAdding synchronization data\n\n\nWe should provide an \naddSyncData\n function could, which look like this (naive implementation, this piece of code needs to be improved to handle cases where \nsynchronizationStrategy.idAttribute\n is an array or a function):\n\n\nconst addSyncData = (document, entry, synchronizationStrategy) =\n {\n  return {\n    ...document,\n    metadata: {\n      ...document.metadata,\n      id: entry[synchronizationStrategy.idAttribute]\n    }\n}\n````\n\nWhere `document` is the future document to save, `entry` the corresponding external entry, and `synchronizationStrategy` and object defining the synchronization properties and methods (see below).\n\n### Filtering entries\n\nNow we have saved our documents in database with consistent synchronization metadata, we need to provide a way to filter external entries.\n\nWe should provide a `filterEntriesToSynchronize` which returns a list of entries with new data or data to update.\n\nAs `addSyncData`, this method will receive a `synchronizationStrategy`. The filtering algorithm should be based on the returned value of `synchronizationStrategy.shouldSave` and `synchronizationStrategy.shouldUpdate`.\n\n\n \u26a0\ufe0f As the `synchronizationStrategy.shouldSave` and `synchronizationStrategy.shouldUpdate` will be asynchronous methods, `filterEntriesToSynchronize` should also be asynchronous.\n\nA naive example of `filterEntriesToSynchronize` implementation should be:\n\n```js\nconst filterEntriesToSynchronize = async (cozy, entries, synchronizationStrategy) = {\n  const filtered = []\n\n  // getExistingSynchronizedDocument needs to be implemented, it should retrieve\n  // existing document from database, based on synchronization data.\n  const existingDocument = cozy.getExistingSynchronizedDocument(entry, synchronizationStrategy)\n\n  entries.forEach(entry =\n {\n    const toSave = await synchronizationStrategy.shouldSave(entry, existingDocument)\n    const toUpdate = await synchronizationStrategy.shouldUpdate(entry, existingDocument)\n\n    if (toSave || toUpdate) filtered.push(entry)\n  })\n\n  return filtered\n}\n\n\n\n\nSynchronization strategy\n\n\nFor our functions or methods dealing with synchronization, we pass a \nsynchronizationStrategy\n object. Internally, we will use a default one but let the ability to contributors to pass their own ones.\n\n\nIt is a simple object containing the following properties:\n\n\n\n\n\n\n\n\nOption\n\n\nRole\n\n\n\n\n\n\n\n\n\n\ndisableSyncData\n\n\n(boolean) Disable storage of  synchronization data. Default: \nfalse\n\n\n\n\n\n\nfindLegacyDocument\n\n\n(function) Custom function which a konnector may use to look for a legacy document. Default is \nnull\n. See below for more details.\n\n\n\n\n\n\ngetSyncData\n\n\n(function) A mapping method returning additional synchronization data which have to be added to the document.\n\n\n\n\n\n\nidAttribute\n\n\n(string\nArray\nfunction) How the identifier attribute is named in the entry. Default value: \nid\n. See below for additional customization\n\n\n\n\n\n\nkonnector\n\n\nMandatory\n (string) The slug (or better, an uuid) of the current konnector.\n\n\n\n\n\n\nshouldSave\n\n\n(function) A method taking current entry and matching document in database to evaluate if an entry has to be saved in database. See below default method and customization.\n\n\n\n\n\n\nshouldUpdate\n\n\n(function) A method taking current entry and matching document in database to evaluate if a document must be updated with current entry. See below for default method and customization.\n\n\n\n\n\n\n\n\nfindLegacyDocument\n\n\nIf a document has not been saved yet with actual synchronization data, we will have no way to retrieve it, except by providing a \nfindLegacyDocument\n function to \nsaveEntry\n options. This signature of a \nfindLegacyDocument\n function is:\n\n\nasync function (entry, cozy) =\n { /* look for your document */ }\n````\n\nThe `cozy` parameter is an instance of Cozy-Client.\n\nThe idea is for example to retrive a document by its file path or any other accurate information.\n\n### getSyncData\nThis method returns any addtional synchronization data the konnector should need. Default method should be something returning an empty object or `null`.\n\n```js\n(entry) =\n ({})\n\n\n\n\nA konnector should provide its own method:\n\n\n{\n  getSyncData: (entry) =\n ({\n    filename: entry.name\n  })\n}```\n\n### idAttribute\n#### String\nName of the id attribute in entry. Default is `id`. If we want to use another name, we may use:\n```js\nsaveFiles(files, {idAttribute: 'uuid'})\n\n\n\n\nArray\n\n\nThis attribute may also be an array of string, defining each entry attribute which must be used for identifier.\n\n\nExample\n\n\nsaveFiles(files, {idAttribute: ['name', 'author', 'date']})\n\n\n\n\nIn this case, all fields are used in synchronization data.\n\n\nfunction\n\n\nWhen an entry does not provide an unique identifer, it is possible to use a function as \nidAttribute\n to customize the way the unique identifer is generated.\n\n\nExample\n\n\naddData(file, {idAttribute: (entry) =\n hash(entry)})\n// hash() is a custom method  hashing the current file.\n\n\n\n\nkonnector\n\n\nThe konnector attribute is used as a key reference to retrieve all document synchronized by this konnector.\n\n\nFor now, the \nkonnector\n option will be needed for every call. But it could be interesting to initialize some kind of runner with it, which may encapsulate all the \ncozy-konnector-libs\n functions.\n\n\nshouldSave\n\n\nThe shouldSave function returns a boolean which indicate if the entry should be saved. The default method should be:\n\n\nasync function shouldSave (entry, existingDocument, cozy) =\n {\n  return Promise.resolve(!existingDocument)\n}\n\n\n\n\nWhen calling this function, it is assumed that \ncozy-konnector-libs\n first queries the database for an exisring document, based on synchronization data and pass the document resulting the query to the \nshouldSave\n function, event if this document is \nnull\n. We pass the whole document, and not only synchronization data, to let the contributors free on their way they are determining it a document should be saved.\n\n\nAs a third parameter, a cozyClient instance is passed, it may be used by a konnector to perform another query.\n\n\nBecause of this third parameter, the whole \nshouldSave\n method is asynchronous.\n\n\nshouldUpdate\n\n\nThe \nshouldUpdate\n function acts exactly like \nshouldSave\n, except that it is used to determine if a document should be updated. By default, we make the choice to never update a document (except if it does not have synchronization data, see \nfindLegacyDocument\n above). But some konnectors like \nLinxo\n related ones need to update existing documents.\n\n\nThe default method is:\n\n\nasync function shouldUpdate (entry, existingDocument, cozy) {\n  // Update an existing document only if it does not have synchronization data\n  const hasSyncData = !!existingDocument \n !!existingDocument.metadata \n !! existingDocument.metadata.sync\n  return Promise.resolve(!hasSyncData)\n}\n````\n\n## Whole example\n\nAs the way data are saved from `cozy-konnector-libs` differs based on data type, we let the saving mechanism to others functions or methods. For example, in existing codebase, bills are saved in a specific way, resulting in two documents in database. However, we could provide top-level functions or methods, like `synchronizeBills` or a more generic `synchronizeData`.\n\nHere is a whole and naive example of how `synchronizeBills` could be implemebted:\n\n```js\nconst synchronizeBills = async (cozy, entries, synchronizationStrategy) =\n {\n  return await filteredEntries = await filterEntriesToSynchronize(cozy, entries, synchronizationStrategy)\n    .then(filteredEntries =\n filteredEntries.map(entry =\n addSyncData(entry, synchronizationStrategy)))\n    // existing saveBills method (with maybe some little changes)\n    .saveBills(synchronizedDocuments)\n}\n\n\n\n\nUsage could be:\n\n\nsynchronizeBills(cozy, entries, {\n  findLegacyDocument: (entry, cozy) =\n {\n    return cozy.files.statByPath(getEntryPath(entry))\n  },\n  getSyncData: (file) =\n ({\n    fileName: file.name\n  }),\n  idAttribute: 'uuid',\n  konnector: 'myservice',\n  shouldSave: (file) =\n {\n    // For whatever reason we only save files created after 2010\n    return Promise.resolve(moment(file.creationDate).year().isAfter(2010))\n  },\n  shouldUpdate: (file, existingDocument) =\n {\n    const hasBeenModified = moment(file.modificationDate).isAfter(existingDocument.metadata.sync.last_sync)\n    return Promise.resolve(hasBeenModified)\n  }\n})\n\n\n\n\nEvery synchronized document will contain:\n\n\n{\n  \nmetadata\n: {\n    \nsync\n: {\n      \nkonnector\n: \nmyservice\n,\n      \nid\n: \nentry_id\n,\n      \nlast_sync\n: \nnow\n,\n      \nfileName\n: \nfileName\n\n    }\n  }\n}", 
            "title": "Synchronization"
        }, 
        {
            "location": "/cozy-konnector-libs/synchronization/#table-of-contents", 
            "text": "Konnector synchronisation data and options  Problems  Current usage  Objectives of this document  Storing synchronization data in documents  Simple case, by id  By multiple attributes  By custom method    Saving document based on synchronization strategy  Adding synchronization data  Filtering entries    Synchronization strategy  findLegacyDocument  getSyncData  Array  Example    function  Example    konnector  shouldSave  shouldUpdate    Whole example", 
            "title": "Table of contents"
        }, 
        {
            "location": "/cozy-konnector-libs/synchronization/#konnector-synchronisation-data-and-options", 
            "text": "", 
            "title": "Konnector synchronisation data and options"
        }, 
        {
            "location": "/cozy-konnector-libs/synchronization/#problems", 
            "text": "Except bank konnectors which are already solving the addressed problem, all konnectors are currently processing data they are collecting in the same way:   Get all data to synchronize  Store it in CouchDB, even if it means overriding previously synchronized data.   This process has at least two major flows :  We are always synchronizing  all  the data provided by the external service.  When something is modified (for example, the name of the stored file, it s almost sure that the previous one will be kept and that we ll have a duplicate)  Another side effect could be that in a very large set of documents to synchronize, the whole process may take more than 3 minutes and never synchronize documents at the end of the list.", 
            "title": "Problems"
        }, 
        {
            "location": "/cozy-konnector-libs/synchronization/#current-usage", 
            "text": "When saving bills,  cozy-konnector-libs  provides a filtering and hydratation mechanism, to avoid overriding existing bills. It is done in function  hydrateAndFilters .  This method performs two actions :  hydrate entries retrieved from service with usable data from couchDB (like existing bill id)  filter entries retrieved from service and return only entries that need to be saved/synchronized.", 
            "title": "Current usage"
        }, 
        {
            "location": "/cozy-konnector-libs/synchronization/#objectives-of-this-document", 
            "text": "The goals of this document are:   Define a common way to store synchronization data for all konnector  Propose a naive implementation for an abstract synchronisation data storing mechanism, provided by  cozy-konnector-libs  Propose a solution to synchronize every type of data or file, not only bills  Taking the  hydrateAndFilter  function as basis, split it in three functions performing the following tasks : actual filtering, synchronization data hydratation and saving/updating current database document with correspondig external entries (the part done by the actual  hydratation )", 
            "title": "Objectives of this document"
        }, 
        {
            "location": "/cozy-konnector-libs/synchronization/#storing-synchronization-data-in-documents", 
            "text": "Before saving any data or file, we will add in the relying document every synchronization data we will need. The added data will depend on how the service the konnector connects to retrieve entries and which information they gave us.", 
            "title": "Storing synchronization data in documents"
        }, 
        {
            "location": "/cozy-konnector-libs/synchronization/#simple-case-by-id", 
            "text": "We suppose that in the most cases, we will face to entries provinding their own  id  attribute. The idea is to store it as synchronization data to be able to easily retrieve them later.\nTo store synchronization data, we are using a  sync  attribute in document  metadata  attribute. Example:  {\n   metadata : {\n     sync : {\n       id :  7ee401e841c94159addb47f190903139 ,\n       konnector :  trainline ,\n       last_sync :  Mon, 12 Feb 2018 16:25:34 GMT \n    }\n  }\n}  The expected information to be save is:     field  role      id  The id of the document, but given by the external service. If the external service does not provide any id or uuid, it could be interesting to generate one, with an hash of the file for example.    konnector  The slug of the konnector (Example:  trainline ,  freemobile ,  cic ). This could be very useful to retrieve data synchronized with this konnector.    last_sync  Date of last synchronization, set to  now()  when storage is made.", 
            "title": "Simple case, by id"
        }, 
        {
            "location": "/cozy-konnector-libs/synchronization/#by-multiple-attributes", 
            "text": "If the external service does not provide any  id  attribute, we may need to use instead a list of attributes, for example  firstname ,  lastname ,  dateofbirth .  {\n   metadata : {\n     sync : {\n       firstname :  Claude ,\n       lastname :  Causi ,\n       dateofbirth :  06/12/1980 \n    }\n  }\n}  As we cannot be sure that we will have different data, it could be better to use a custom way of providing an unique identifier.", 
            "title": "By multiple attributes"
        }, 
        {
            "location": "/cozy-konnector-libs/synchronization/#by-custom-method", 
            "text": "When the external service does not provide any identifier, we have to use a custom method to generate one.\nIt could be for example the filename or a hash generated with the document content.  {\n   metadata : {\n     sync : {\n       id: :  customhash34FED5465645ABF54656FCB \n    }\n  }\n}", 
            "title": "By custom method"
        }, 
        {
            "location": "/cozy-konnector-libs/synchronization/#saving-document-based-on-synchronization-strategy", 
            "text": "To solve the synchronization process weed need to:  be able to add synchronization data on any type of document  be able to compare external entries to current database state\n* provide a default implementation while letting the contributors to define their own ones", 
            "title": "Saving document based on synchronization strategy"
        }, 
        {
            "location": "/cozy-konnector-libs/synchronization/#adding-synchronization-data", 
            "text": "We should provide an  addSyncData  function could, which look like this (naive implementation, this piece of code needs to be improved to handle cases where  synchronizationStrategy.idAttribute  is an array or a function):  const addSyncData = (document, entry, synchronizationStrategy) =  {\n  return {\n    ...document,\n    metadata: {\n      ...document.metadata,\n      id: entry[synchronizationStrategy.idAttribute]\n    }\n}\n````\n\nWhere `document` is the future document to save, `entry` the corresponding external entry, and `synchronizationStrategy` and object defining the synchronization properties and methods (see below).\n\n### Filtering entries\n\nNow we have saved our documents in database with consistent synchronization metadata, we need to provide a way to filter external entries.\n\nWe should provide a `filterEntriesToSynchronize` which returns a list of entries with new data or data to update.\n\nAs `addSyncData`, this method will receive a `synchronizationStrategy`. The filtering algorithm should be based on the returned value of `synchronizationStrategy.shouldSave` and `synchronizationStrategy.shouldUpdate`.  \u26a0\ufe0f As the `synchronizationStrategy.shouldSave` and `synchronizationStrategy.shouldUpdate` will be asynchronous methods, `filterEntriesToSynchronize` should also be asynchronous.\n\nA naive example of `filterEntriesToSynchronize` implementation should be:\n\n```js\nconst filterEntriesToSynchronize = async (cozy, entries, synchronizationStrategy) = {\n  const filtered = []\n\n  // getExistingSynchronizedDocument needs to be implemented, it should retrieve\n  // existing document from database, based on synchronization data.\n  const existingDocument = cozy.getExistingSynchronizedDocument(entry, synchronizationStrategy)\n\n  entries.forEach(entry =  {\n    const toSave = await synchronizationStrategy.shouldSave(entry, existingDocument)\n    const toUpdate = await synchronizationStrategy.shouldUpdate(entry, existingDocument)\n\n    if (toSave || toUpdate) filtered.push(entry)\n  })\n\n  return filtered\n}", 
            "title": "Adding synchronization data"
        }, 
        {
            "location": "/cozy-konnector-libs/synchronization/#synchronization-strategy", 
            "text": "For our functions or methods dealing with synchronization, we pass a  synchronizationStrategy  object. Internally, we will use a default one but let the ability to contributors to pass their own ones.  It is a simple object containing the following properties:     Option  Role      disableSyncData  (boolean) Disable storage of  synchronization data. Default:  false    findLegacyDocument  (function) Custom function which a konnector may use to look for a legacy document. Default is  null . See below for more details.    getSyncData  (function) A mapping method returning additional synchronization data which have to be added to the document.    idAttribute  (string Array function) How the identifier attribute is named in the entry. Default value:  id . See below for additional customization    konnector  Mandatory  (string) The slug (or better, an uuid) of the current konnector.    shouldSave  (function) A method taking current entry and matching document in database to evaluate if an entry has to be saved in database. See below default method and customization.    shouldUpdate  (function) A method taking current entry and matching document in database to evaluate if a document must be updated with current entry. See below for default method and customization.", 
            "title": "Synchronization strategy"
        }, 
        {
            "location": "/cozy-konnector-libs/synchronization/#findlegacydocument", 
            "text": "If a document has not been saved yet with actual synchronization data, we will have no way to retrieve it, except by providing a  findLegacyDocument  function to  saveEntry  options. This signature of a  findLegacyDocument  function is:  async function (entry, cozy) =  { /* look for your document */ }\n````\n\nThe `cozy` parameter is an instance of Cozy-Client.\n\nThe idea is for example to retrive a document by its file path or any other accurate information.\n\n### getSyncData\nThis method returns any addtional synchronization data the konnector should need. Default method should be something returning an empty object or `null`.\n\n```js\n(entry) =  ({})  A konnector should provide its own method:  {\n  getSyncData: (entry) =  ({\n    filename: entry.name\n  })\n}```\n\n### idAttribute\n#### String\nName of the id attribute in entry. Default is `id`. If we want to use another name, we may use:\n```js\nsaveFiles(files, {idAttribute: 'uuid'})", 
            "title": "findLegacyDocument"
        }, 
        {
            "location": "/cozy-konnector-libs/synchronization/#array", 
            "text": "This attribute may also be an array of string, defining each entry attribute which must be used for identifier.", 
            "title": "Array"
        }, 
        {
            "location": "/cozy-konnector-libs/synchronization/#example", 
            "text": "saveFiles(files, {idAttribute: ['name', 'author', 'date']})  In this case, all fields are used in synchronization data.", 
            "title": "Example"
        }, 
        {
            "location": "/cozy-konnector-libs/synchronization/#function", 
            "text": "When an entry does not provide an unique identifer, it is possible to use a function as  idAttribute  to customize the way the unique identifer is generated.", 
            "title": "function"
        }, 
        {
            "location": "/cozy-konnector-libs/synchronization/#example_1", 
            "text": "addData(file, {idAttribute: (entry) =  hash(entry)})\n// hash() is a custom method  hashing the current file.", 
            "title": "Example"
        }, 
        {
            "location": "/cozy-konnector-libs/synchronization/#konnector", 
            "text": "The konnector attribute is used as a key reference to retrieve all document synchronized by this konnector.  For now, the  konnector  option will be needed for every call. But it could be interesting to initialize some kind of runner with it, which may encapsulate all the  cozy-konnector-libs  functions.", 
            "title": "konnector"
        }, 
        {
            "location": "/cozy-konnector-libs/synchronization/#shouldsave", 
            "text": "The shouldSave function returns a boolean which indicate if the entry should be saved. The default method should be:  async function shouldSave (entry, existingDocument, cozy) =  {\n  return Promise.resolve(!existingDocument)\n}  When calling this function, it is assumed that  cozy-konnector-libs  first queries the database for an exisring document, based on synchronization data and pass the document resulting the query to the  shouldSave  function, event if this document is  null . We pass the whole document, and not only synchronization data, to let the contributors free on their way they are determining it a document should be saved.  As a third parameter, a cozyClient instance is passed, it may be used by a konnector to perform another query.  Because of this third parameter, the whole  shouldSave  method is asynchronous.", 
            "title": "shouldSave"
        }, 
        {
            "location": "/cozy-konnector-libs/synchronization/#shouldupdate", 
            "text": "The  shouldUpdate  function acts exactly like  shouldSave , except that it is used to determine if a document should be updated. By default, we make the choice to never update a document (except if it does not have synchronization data, see  findLegacyDocument  above). But some konnectors like  Linxo  related ones need to update existing documents.  The default method is:  async function shouldUpdate (entry, existingDocument, cozy) {\n  // Update an existing document only if it does not have synchronization data\n  const hasSyncData = !!existingDocument   !!existingDocument.metadata   !! existingDocument.metadata.sync\n  return Promise.resolve(!hasSyncData)\n}\n````\n\n## Whole example\n\nAs the way data are saved from `cozy-konnector-libs` differs based on data type, we let the saving mechanism to others functions or methods. For example, in existing codebase, bills are saved in a specific way, resulting in two documents in database. However, we could provide top-level functions or methods, like `synchronizeBills` or a more generic `synchronizeData`.\n\nHere is a whole and naive example of how `synchronizeBills` could be implemebted:\n\n```js\nconst synchronizeBills = async (cozy, entries, synchronizationStrategy) =  {\n  return await filteredEntries = await filterEntriesToSynchronize(cozy, entries, synchronizationStrategy)\n    .then(filteredEntries =  filteredEntries.map(entry =  addSyncData(entry, synchronizationStrategy)))\n    // existing saveBills method (with maybe some little changes)\n    .saveBills(synchronizedDocuments)\n}  Usage could be:  synchronizeBills(cozy, entries, {\n  findLegacyDocument: (entry, cozy) =  {\n    return cozy.files.statByPath(getEntryPath(entry))\n  },\n  getSyncData: (file) =  ({\n    fileName: file.name\n  }),\n  idAttribute: 'uuid',\n  konnector: 'myservice',\n  shouldSave: (file) =  {\n    // For whatever reason we only save files created after 2010\n    return Promise.resolve(moment(file.creationDate).year().isAfter(2010))\n  },\n  shouldUpdate: (file, existingDocument) =  {\n    const hasBeenModified = moment(file.modificationDate).isAfter(existingDocument.metadata.sync.last_sync)\n    return Promise.resolve(hasBeenModified)\n  }\n})  Every synchronized document will contain:  {\n   metadata : {\n     sync : {\n       konnector :  myservice ,\n       id :  entry_id ,\n       last_sync :  now ,\n       fileName :  fileName \n    }\n  }\n}", 
            "title": "shouldUpdate"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.accounts/", 
            "text": "Table of contents\n\n\nCozy Accounts doctype\n\n\nThe \nio.cozy.accounts\n doctype stores authentification informations used by \nkonnectors\n to connect to external services or API.\n\n\nAccounts can be managed in \nCozy-Collect\n. They are generally associated to a \nio.cozy.triggers\n document.\n\n\nio.cozy.accounts\n attributes are:\n\n\n\n\naccount_type\n (\ndeprecated\n) : {string} Slug of the konnector the account is related to.\n\n\nauth\n: {object} Contains authentification data, typically a couple with \nlogin\n/\npassword\n. It could also contain an attribute \ntoken\n for OAuth konnectors.\n\n\ndata\n: {object} Additional custom data.\n\n\nlabel\n: {string} Label given by user.\n\n\n\n\nauth\n\n\nThe \nauth\n attribute may also contain other data, like  \naccountName\n, \nfolderPath\n or \nfrequency\n. As \nauth\n should only be used for authentication mechanisms, those two values should disappear soon.\n\n\n\n\nfolderPath\n should purely and simply disappear, the folder information is stored in \nio.cozy.trigger\n.\n\n\naccountName\n is in reality the \nlabel\n, change should be made soon to fix this mistake.\n\n\nfrequency\n should move at the root of the account.\n\n\n\n\nAbout \nlogin\n\n\nSome konnectors does not use a \nlogin\n parameter, but \nidentifier\n or \nemail\n. The usage of anything except \nlogin\n is deprecated and should not be done.\n\n\nExamples\n\n\nFreemobile (regular connector, with current deprecation)\n\n\n{\n  \nauth\n: {\n    \naccountName\n: \nfreemobile\n,\n    \ncredentials_encrypted\n: \naaDtwWSWsdpbbbbbbbbbbbbbbOzp2pBEbXlZLWjiTzOGumGRomrF2LwlRn4Y8c=\n,\n    \nfolderPath\n: \n/Administratif/Free Mobile\n,\n    \nlogin\n: \n000000000\n,\n    \nnamePath\n: \nFree Mobile\n,\n    \npassword\n: \n*******\n\n  }\n}\n\n\n\n\nWhat we aim:\n\n\n{\n  \nauth\n: {\n    \ncredentials_encrypted\n: \naaDtwWSWsdpbbbbbbbbbbbbbbOzp2pBEbXlZLWjiTzOGumGRomrF2LwlRn4Y8c=\n,\n    \nlogin\n: \n000000000\n,\n    \npassword\n: \n**********\n\n  },\n  \nfolderPath\n: \n/Administratif/Free Mobile\n,\n  \nlabel\n: \nfreemobile\n,\n  \nnamePath\n: \nFree Mobile\n\n}\n\n\n\n\nCaisse d\n\u00c9pargne (Linxo connector)\n\n\nThe connectors based on Linxo API are storing specific informations into \ndata\n attribute.\n\n\n{\n  \naccount_type\n: \nlinxo\n,\n  \nauth\n: {\n    \nfolderPath\n: null,\n    \nfrequency\n: \nweek\n,\n    \nidentifier\n: \n0000000000\n,\n    \nsecret\n: \n*********\n\n  },\n  \ndata\n: {\n    \nauth\n: {\n      \nlogin\n: \n00000.00000000@cozyclaudy.red.cloud\n,\n      \npassword\n: \n********************************\n\n    },\n    \nstatus\n: \nconnected\n,\n    \ntoken\n: \nf415e\n,\n    \nuuid\n: \ndeadbeef-912e-4ba8-9378-067c5c3e4f54\n\n\n  }\n}", 
            "title": "Accounts"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.accounts/#cozy-accounts-doctype", 
            "text": "The  io.cozy.accounts  doctype stores authentification informations used by  konnectors  to connect to external services or API.  Accounts can be managed in  Cozy-Collect . They are generally associated to a  io.cozy.triggers  document.  io.cozy.accounts  attributes are:   account_type  ( deprecated ) : {string} Slug of the konnector the account is related to.  auth : {object} Contains authentification data, typically a couple with  login / password . It could also contain an attribute  token  for OAuth konnectors.  data : {object} Additional custom data.  label : {string} Label given by user.", 
            "title": "Cozy Accounts doctype"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.accounts/#auth", 
            "text": "The  auth  attribute may also contain other data, like   accountName ,  folderPath  or  frequency . As  auth  should only be used for authentication mechanisms, those two values should disappear soon.   folderPath  should purely and simply disappear, the folder information is stored in  io.cozy.trigger .  accountName  is in reality the  label , change should be made soon to fix this mistake.  frequency  should move at the root of the account.", 
            "title": "auth"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.accounts/#about-login", 
            "text": "Some konnectors does not use a  login  parameter, but  identifier  or  email . The usage of anything except  login  is deprecated and should not be done.", 
            "title": "About login"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.accounts/#examples", 
            "text": "", 
            "title": "Examples"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.accounts/#freemobile-regular-connector-with-current-deprecation", 
            "text": "{\n   auth : {\n     accountName :  freemobile ,\n     credentials_encrypted :  aaDtwWSWsdpbbbbbbbbbbbbbbOzp2pBEbXlZLWjiTzOGumGRomrF2LwlRn4Y8c= ,\n     folderPath :  /Administratif/Free Mobile ,\n     login :  000000000 ,\n     namePath :  Free Mobile ,\n     password :  ******* \n  }\n}  What we aim:  {\n   auth : {\n     credentials_encrypted :  aaDtwWSWsdpbbbbbbbbbbbbbbOzp2pBEbXlZLWjiTzOGumGRomrF2LwlRn4Y8c= ,\n     login :  000000000 ,\n     password :  ********** \n  },\n   folderPath :  /Administratif/Free Mobile ,\n   label :  freemobile ,\n   namePath :  Free Mobile \n}", 
            "title": "Freemobile (regular connector, with current deprecation)"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.accounts/#caisse-depargne-linxo-connector", 
            "text": "The connectors based on Linxo API are storing specific informations into  data  attribute.  {\n   account_type :  linxo ,\n   auth : {\n     folderPath : null,\n     frequency :  week ,\n     identifier :  0000000000 ,\n     secret :  ********* \n  },\n   data : {\n     auth : {\n       login :  00000.00000000@cozyclaudy.red.cloud ,\n       password :  ******************************** \n    },\n     status :  connected ,\n     token :  f415e ,\n     uuid :  deadbeef-912e-4ba8-9378-067c5c3e4f54 \n\n  }\n}", 
            "title": "Caisse d'\u00c9pargne (Linxo connector)"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.photos.albums/", 
            "text": "Table of contents\n\n\nPhotos Albums doctype\n\n\nio.cozy.photos.albums\n\n\nThis doctype is really simple. It just has one attribute:\n\n\n\n\nname\n: {string} the name of the album\n\n\n\n\nThe photos in an album are files (with the class \nimage\n) that are \nreferenced\n by the album document.", 
            "title": "Albums"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.photos.albums/#photos-albums-doctype", 
            "text": "", 
            "title": "Photos Albums doctype"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.photos.albums/#iocozyphotosalbums", 
            "text": "This doctype is really simple. It just has one attribute:   name : {string} the name of the album   The photos in an album are files (with the class  image ) that are  referenced  by the album document.", 
            "title": "io.cozy.photos.albums"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.bank/", 
            "text": "Table of contents\n\n\nCozy Bank doctypes\n\n\nCozy can stores and manipulate bank related datas, distributed across several doctypes.\n\n\nio.cozy.bank.settings\n\n\nThis doctype store informations about Bank application settings. There is only one document, by default:\n\n\n{\n  notifications: {\n    amountMax: {\n      enable: false,\n      value: 30\n    }\n  }\n}\n\n\n\n\nio.cozy.bank.accounts\n\n\nThis doctypes stores informations about a Bank account:\n\n\n\n\nlabel\n: {string} - The bank account label (e.g. \nJohn Doe Bank Account\n)\n\n\ninstitutionLabel\n: {string} - The financial institution name the bank account belongs to\n\n\nbalance\n: {number} - The current account balance\n\n\ntype\n: {string} - The account type in the list \n['none', 'bank', 'cash', 'asset', 'credit card', 'liability']\n\n\nnumber\n: {string} - The bank account number in its institution\n\n\niban\n: {string} - The bank account international identifier\n\n\nserviceID\n: {number} - In case of external service used to import transactions, this key can stores the service\ns account ID; can be \nundefined\n is the account isn\nt managed by any external service\n\n\n\n\nExample\n\n\n{\n  \n_id\n: \n2165d9a310deadbeeffc08d54c45102\n,\n  \nbalance\n: 1337.73,\n  \ninstitutionLabel\n: \nSoci\u00e9t\u00e9 G\u00e9n\u00e9rale (Particuliers)\n,\n  \nlabel\n: \nLivret D\u00e9velop. Durable (x1337)\n,\n  \nlinxoId\n: \n123456\n,\n  \nmetadata\n: {\n    \nversion\n: 1\n  },\n  \nnumber\n: \n03791 00048085818\n,\n  \nshortLabel\n: \nLivret D\u00e9velop. Durable\n,\n  \ntype\n: \nSavings\n\n}\n\n\n\n\nio.cozy.bank.operations\n\n\nThis doctype stors informations about a bank transaction:\n\n\n\n\nlabel\n: {string} - The label describing the transaction\n\n\ntype\n: {string} - A type in the list : \n['none', 'credit card', 'cash', 'check', 'transfer', 'internal transfer', 'debit card', 'deposit', 'financial fee', 'direct debit']\n\n\ndate\n: {date} - The date the transaction is emmited\n\n\ndateOperation\n: {date} - The date the transaction is registered in the account\n\n\ndateImport\n: {date} - The date the transaction is imported (can differ of the date of creation of the document as the import can be done by an external service)\n\n\namount\n: {number} - The amount of the transaction\n\n\ncurrency\n: {string} - A 3 uppercased chars defining the currecny used for the transaction as stated in \nISO4217\n\n\nmanualCategoryId\n: {string} - A category that apply to the transaction and is manually selected by the user\n\n\nautomaticCategoryId\n: {string} - A category that apply to the transaction and is automatically calculated\n\n\naccount\n: {identifier} - The related account id the transaction belongs to\n\n\nbills\n: {array[\n]} - List of bills id.\n\n\nreimbursements\n: {array[\n]} - List of bills id.\n\n\ncreditOperations\n: {array[\n]} - List of credit operations id\n\n\ndebitOperations\n: {array[\n]} - List of debit operations id\n\n\nparent\n: {_id} - In case of a split transaction, the one refers the global transaction the split one belongs to\n\n\n\n\nFor the dates, any string or integer which can be interpreted by new Date(date) is possible but the\nbest the result of Date.toString() -\n like \nFri Mar 09 2018 19:04:40 GMT+0100 (CET)\n which contains\nthe time zones.\n\n\nExample\n\n\n{\n  \n_id\n: \nf0426fdeadbeef55755ee7f4d6555\n,\n  \naccount\n: \n15fb6402426bcdeadbeeffd5f4587bb\n,\n  \namount\n: 10,\n  \nautomaticCategoryId\n: \n400110\n,\n  \ncurrency\n: \nEUR\n,\n  \ndate\n: \n2017-09-22 00:00:00+01:00\n,\n  \ndateOperation\n: null,\n  \nlabel\n: \nM  PIERRE RICHARD\n,\n  \nlinxoId\n: \n845811337\n,\n  \nmetadata\n: {\n    \ndateImport\n: \n2018-03-09T09:23:40.075Z\n,\n    \nversion\n: 1\n  },\n  \noriginalBankLabel\n: \nVIR RECU    5383518660S DE: M  PIERRE RICHARD J MOTIF: Cascade REF: NOT PROVIDED\n,\n  \ntype\n: \ntransfer\n\n}", 
            "title": "Banking doctypes"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.bank/#cozy-bank-doctypes", 
            "text": "Cozy can stores and manipulate bank related datas, distributed across several doctypes.", 
            "title": "Cozy Bank doctypes"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.bank/#iocozybanksettings", 
            "text": "This doctype store informations about Bank application settings. There is only one document, by default:  {\n  notifications: {\n    amountMax: {\n      enable: false,\n      value: 30\n    }\n  }\n}", 
            "title": "io.cozy.bank.settings"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.bank/#iocozybankaccounts", 
            "text": "This doctypes stores informations about a Bank account:   label : {string} - The bank account label (e.g.  John Doe Bank Account )  institutionLabel : {string} - The financial institution name the bank account belongs to  balance : {number} - The current account balance  type : {string} - The account type in the list  ['none', 'bank', 'cash', 'asset', 'credit card', 'liability']  number : {string} - The bank account number in its institution  iban : {string} - The bank account international identifier  serviceID : {number} - In case of external service used to import transactions, this key can stores the service s account ID; can be  undefined  is the account isn t managed by any external service", 
            "title": "io.cozy.bank.accounts"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.bank/#example", 
            "text": "{\n   _id :  2165d9a310deadbeeffc08d54c45102 ,\n   balance : 1337.73,\n   institutionLabel :  Soci\u00e9t\u00e9 G\u00e9n\u00e9rale (Particuliers) ,\n   label :  Livret D\u00e9velop. Durable (x1337) ,\n   linxoId :  123456 ,\n   metadata : {\n     version : 1\n  },\n   number :  03791 00048085818 ,\n   shortLabel :  Livret D\u00e9velop. Durable ,\n   type :  Savings \n}", 
            "title": "Example"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.bank/#iocozybankoperations", 
            "text": "This doctype stors informations about a bank transaction:   label : {string} - The label describing the transaction  type : {string} - A type in the list :  ['none', 'credit card', 'cash', 'check', 'transfer', 'internal transfer', 'debit card', 'deposit', 'financial fee', 'direct debit']  date : {date} - The date the transaction is emmited  dateOperation : {date} - The date the transaction is registered in the account  dateImport : {date} - The date the transaction is imported (can differ of the date of creation of the document as the import can be done by an external service)  amount : {number} - The amount of the transaction  currency : {string} - A 3 uppercased chars defining the currecny used for the transaction as stated in  ISO4217  manualCategoryId : {string} - A category that apply to the transaction and is manually selected by the user  automaticCategoryId : {string} - A category that apply to the transaction and is automatically calculated  account : {identifier} - The related account id the transaction belongs to  bills : {array[ ]} - List of bills id.  reimbursements : {array[ ]} - List of bills id.  creditOperations : {array[ ]} - List of credit operations id  debitOperations : {array[ ]} - List of debit operations id  parent : {_id} - In case of a split transaction, the one refers the global transaction the split one belongs to   For the dates, any string or integer which can be interpreted by new Date(date) is possible but the\nbest the result of Date.toString() -  like  Fri Mar 09 2018 19:04:40 GMT+0100 (CET)  which contains\nthe time zones.", 
            "title": "io.cozy.bank.operations"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.bank/#example_1", 
            "text": "{\n   _id :  f0426fdeadbeef55755ee7f4d6555 ,\n   account :  15fb6402426bcdeadbeeffd5f4587bb ,\n   amount : 10,\n   automaticCategoryId :  400110 ,\n   currency :  EUR ,\n   date :  2017-09-22 00:00:00+01:00 ,\n   dateOperation : null,\n   label :  M  PIERRE RICHARD ,\n   linxoId :  845811337 ,\n   metadata : {\n     dateImport :  2018-03-09T09:23:40.075Z ,\n     version : 1\n  },\n   originalBankLabel :  VIR RECU    5383518660S DE: M  PIERRE RICHARD J MOTIF: Cascade REF: NOT PROVIDED ,\n   type :  transfer \n}", 
            "title": "Example"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.bills/", 
            "text": "Table of contents\n\n\nBills doctype\n\n\nio.cozy.bills\n\n\n\n\ntype\n: {string} - Type of the bill\n\n\nsubtype\n: {string} - Used for labelling the bill. ie: \nOst\u00e9opathie\n\n\nvendor\n: {string} - Vendor which issued the bill\n\n\ndate\n: {date} - Date the bill was emitted\n\n\noriginalDate\n - For health bills, represents the date of the health act (presumably the date the account was charged)\n\n\namount\n: {number} - Amount of the bill, \nalways positive\n even if it is a refund\n\n\noriginalAmount\n: {number} - Original amount in case of a partial refund\n\n\ngroupAmount\n: Group amount in case this bill was part of a grouped refund\n\n\nthirdPartyRefund\n : {number} - Amount reimbursed to third parties\n\n\nsocialSecurityRefund\n : {number} - Amount reimbursed to social security\n\n\nisRefund\n: {boolean} - Indicate if the bill represents a refund/reimbursement\n\n\nisThirdPartyPayer\n: {boolean} - Indicate if the bill has been already covered by a third party payer. This attribute can be useful when Cozy retrieves bills issued by french medical insurances.\nWhen this attribute is in \ntrue\n no associated debit is expected to be found in the client bank\nstatements.\n\n\ninvoice\n: {string} - The associated file. ex: \nio.cozy.files:c43645a93831827c7ec512eac3006e51\n\n\ncontent\n: {string}\n\n\ndebitOperations\n: {array[io.cozy.bank.operations._id]} - List of debit operations id\n\n\ncreditOperations\n: {array[io.cozy.bank.operations._id]} - List of credit operations id\n\n\n\n\nTypes\n\n\n\n\nhealth_costs\n: Health related bills\n\n\nphone\n: Phone related bills\n\n\n\n\nSome more attributes for reimbursement bills\n\n\nThe are some more possible attributes for reimbursement bills. The \noriginal*\n attributes\nare there to help the connector to link this bills to their original debit operation.\n\n\n\n\nisRefund\n: {boolean} - Indicate if the bill represents a refund/reimbursement (defaults to false)\n\n\nsubtype\n: {string} - Used for labelling the bill. ie: \nOst\u00e9opathie\n (optionnal)\n\n\noriginalAmount\n: {number} - Original amount in case of a partial refund\n\n\noriginalDate\n - Represents the date of the associated spent (presumably the date the account was charged)\n\n\n\n\nExample\n\n\n{\n  \n_id\n: \n62e5d80d6e11d19992b7efce794263f0\n,\n  \namount\n: 700,\n  \nbeneficiary\n: \nPIERRE RICHARD\n,\n  \ndate\n: \n2018-02-07T23:00:00.000Z\n,\n  \ngroupAmount\n: 7.5,\n  \nisRefund\n: true,\n  \nmetadata\n: {\n    \nversion\n: 1\n  },\n  \noriginalAmount\n: 25,\n  \noriginalDate\n: \n2018-03-11T23:00:00.000Z\n,\n  \nsocialSecurityRefund\n: 17.5,\n  \nsubtype\n: \nConsultation sp\u00e9cialiste\n,\n  \ntype\n: \nhealth_costs\n,\n  \nvendor\n: \nHarmonie\n\n}", 
            "title": "Bills"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.bills/#bills-doctype", 
            "text": "", 
            "title": "Bills doctype"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.bills/#iocozybills", 
            "text": "type : {string} - Type of the bill  subtype : {string} - Used for labelling the bill. ie:  Ost\u00e9opathie  vendor : {string} - Vendor which issued the bill  date : {date} - Date the bill was emitted  originalDate  - For health bills, represents the date of the health act (presumably the date the account was charged)  amount : {number} - Amount of the bill,  always positive  even if it is a refund  originalAmount : {number} - Original amount in case of a partial refund  groupAmount : Group amount in case this bill was part of a grouped refund  thirdPartyRefund  : {number} - Amount reimbursed to third parties  socialSecurityRefund  : {number} - Amount reimbursed to social security  isRefund : {boolean} - Indicate if the bill represents a refund/reimbursement  isThirdPartyPayer : {boolean} - Indicate if the bill has been already covered by a third party payer. This attribute can be useful when Cozy retrieves bills issued by french medical insurances.\nWhen this attribute is in  true  no associated debit is expected to be found in the client bank\nstatements.  invoice : {string} - The associated file. ex:  io.cozy.files:c43645a93831827c7ec512eac3006e51  content : {string}  debitOperations : {array[io.cozy.bank.operations._id]} - List of debit operations id  creditOperations : {array[io.cozy.bank.operations._id]} - List of credit operations id", 
            "title": "io.cozy.bills"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.bills/#types", 
            "text": "health_costs : Health related bills  phone : Phone related bills", 
            "title": "Types"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.bills/#some-more-attributes-for-reimbursement-bills", 
            "text": "The are some more possible attributes for reimbursement bills. The  original*  attributes\nare there to help the connector to link this bills to their original debit operation.   isRefund : {boolean} - Indicate if the bill represents a refund/reimbursement (defaults to false)  subtype : {string} - Used for labelling the bill. ie:  Ost\u00e9opathie  (optionnal)  originalAmount : {number} - Original amount in case of a partial refund  originalDate  - Represents the date of the associated spent (presumably the date the account was charged)", 
            "title": "Some more attributes for reimbursement bills"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.bills/#example", 
            "text": "{\n   _id :  62e5d80d6e11d19992b7efce794263f0 ,\n   amount : 700,\n   beneficiary :  PIERRE RICHARD ,\n   date :  2018-02-07T23:00:00.000Z ,\n   groupAmount : 7.5,\n   isRefund : true,\n   metadata : {\n     version : 1\n  },\n   originalAmount : 25,\n   originalDate :  2018-03-11T23:00:00.000Z ,\n   socialSecurityRefund : 17.5,\n   subtype :  Consultation sp\u00e9cialiste ,\n   type :  health_costs ,\n   vendor :  Harmonie \n}", 
            "title": "Example"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.konnectors/", 
            "text": "Table of contents\n\n\nKonnectors doctype\n\n\nThe \nio.cozy.konnectors\n doctype is used to store installed connectors.\n\n\nConnectors\n are autonomous applications ran on the stack to connect to external services or API.\n\n\nWhen installing a konnector, the Cozy stack creates a new \nio.cozy.konnector\n document from the fields in the \nmanifest.konnector\n. See the \nreference\n for more information on each attributes.\n\n\nio.cozy.konnectors\n are used by \nCozy-Store\n to install and uninstall connectors, and by \nCozy-Collect\n to manage \naccounts\n for connectors\n\n\nAttributes\n\n\nRetrieved from \nmanifest.konnector\n\n\nThe available attributes in a \nio.cozy.konnectors\n document are :\n\n\n\n\ncategories\n\n\ndata_type\n\n\ndeveloper\n\n\ndoctypes\n\n\neditor\n\n\nfields\n\n\nfrequency\n\n\nicon\n\n\nlangs\n\n\nlanguage\n\n\nlicense\n\n\nlocales\n\n\nmessages\n\n\nname\n\n\nname_prefix\n\n\nnotifications\n\n\noauth\n\n\nparameters\n\n\npermissions\n\n\nplatforms\n\n\nscreenshots\n\n\nslug\n\n\nsource\n\n\nstate\n\n\ntags\n\n\ntime_interval\n\n\ntype\n\n\nvendor_link\n\n\nversion\n\n\n\n\nOther Attributes\n\n\n\n\n\n\n\n\nAttribute\n\n\nRole\n\n\n\n\n\n\n\n\n\n\nstate\n\n\nStore the installation state of the konnector. Value can be \nAVAILABLE\n, \nINSTALLING\n, \nUPGRADING\n, \nUNINSTALLING\n, \nINSTALLED\n, \nREADY\n\n\n\n\n\n\n\n\nExample\n\n\n{\n  \nname\n: \nDebug\n,\n  \neditor\n: \n,\n  \nslug\n: \ndebug\n,\n  \ndeveloper\n: {\n    \nname\n: \ncozy\n,\n    \nurl\n: \ncozy.io\n\n  },\n  \nlong_description\n: \n,\n  \nshort_description\n: \n,\n  \ncategories\n: [\nother\n],\n  \nlocales\n: null,\n  \nlangs\n: null,\n  \ntags\n: null,\n  \nicon\n: \n,\n  \nlicense\n: \n,\n  \nstate\n: \nready\n,\n  \nsource\n: \ngit://github.com/cozy/cozy-konnector-debug.git#build\n,\n  \nparameters\n: null,\n  \nversion\n: \n1.0.0-edf48da7b2d959517aea59767c3d8d45b2ce7fa2\n,\n  \npermissions\n: {\n    \naccounts\n: {\n      \ntype\n: \nio.cozy.accounts\n,\n      \ndescription\n: \nRequired to get the account's data\n,\n      \nverbs\n: [\n        \nGET\n\n      ]\n    }\n  }\n}", 
            "title": "Connectors"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.konnectors/#konnectors-doctype", 
            "text": "The  io.cozy.konnectors  doctype is used to store installed connectors.  Connectors  are autonomous applications ran on the stack to connect to external services or API.  When installing a konnector, the Cozy stack creates a new  io.cozy.konnector  document from the fields in the  manifest.konnector . See the  reference  for more information on each attributes.  io.cozy.konnectors  are used by  Cozy-Store  to install and uninstall connectors, and by  Cozy-Collect  to manage  accounts  for connectors", 
            "title": "Konnectors doctype"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.konnectors/#attributes", 
            "text": "", 
            "title": "Attributes"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.konnectors/#retrieved-from-manifestkonnector", 
            "text": "The available attributes in a  io.cozy.konnectors  document are :   categories  data_type  developer  doctypes  editor  fields  frequency  icon  langs  language  license  locales  messages  name  name_prefix  notifications  oauth  parameters  permissions  platforms  screenshots  slug  source  state  tags  time_interval  type  vendor_link  version", 
            "title": "Retrieved from manifest.konnector"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.konnectors/#other-attributes", 
            "text": "Attribute  Role      state  Store the installation state of the konnector. Value can be  AVAILABLE ,  INSTALLING ,  UPGRADING ,  UNINSTALLING ,  INSTALLED ,  READY", 
            "title": "Other Attributes"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.konnectors/#example", 
            "text": "{\n   name :  Debug ,\n   editor :  ,\n   slug :  debug ,\n   developer : {\n     name :  cozy ,\n     url :  cozy.io \n  },\n   long_description :  ,\n   short_description :  ,\n   categories : [ other ],\n   locales : null,\n   langs : null,\n   tags : null,\n   icon :  ,\n   license :  ,\n   state :  ready ,\n   source :  git://github.com/cozy/cozy-konnector-debug.git#build ,\n   parameters : null,\n   version :  1.0.0-edf48da7b2d959517aea59767c3d8d45b2ce7fa2 ,\n   permissions : {\n     accounts : {\n       type :  io.cozy.accounts ,\n       description :  Required to get the account's data ,\n       verbs : [\n         GET \n      ]\n    }\n  }\n}", 
            "title": "Example"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.contacts/", 
            "text": "Table of contents\n\n\nCozy Contacts doctype\n\n\nio.cozy.contacts\n\n\nThe \nio.cozy.contacts\n doctype is loosely based on the \nvCard RFC\n, in that some of the attributes have been renamed for clarity. The attributes with a \n?\n are optional.\n\n\n\n\nfullname?\n: {string} Unstructured representation of the name (example: \n\"Dr. Gregory House, M.D.\"\n)\n\n\nname?\n: {object} Optional structured representation of the name, with the following possible attributes:\n\n\nfamilyName?\n: {string} (example: \n\"House\"\n)\n\n\ngivenName?\n: {string} (example: \n\"Gregory\"\n)\n\n\nadditionalName?\n: {string} (example: \n\"J.\"\n)\n\n\nnamePrefix?\n: {string} (example: \n\"Dr.\"\n)\n\n\nnameSuffix?\n: {string} (example: \n\"III\"\n)\n\n\nbirthday?\n: {date} (example: \n\"1959-05-15\"\n)\n\n\nnote?\n: {string}\n\n\nemail?\n: {array} An array of email addresses objects with the following attributes:\n\n\naddress\n: {string} Email adress\n\n\ntype?\n: {string} Programmatic type of email (\n\"work\"\n, \n\"home\"\n, \n\"other\"\n)\n\n\nlabel?\n: {string} A user-provided localized type of email (example: \n\"Work\"\n)\n\n\nprimary?\n: {boolean} Indicates a preferred-use address\n\n\naddress?\n: {array} An array of postal addresses objects with the following attributes:\n\n\nstreet?\n: {string}\n\n\npobox?\n: {string}\n\n\ncity?\n: {string}\n\n\nregion?\n: {string}\n\n\npostcode?\n: {string}\n\n\ncountry?\n: {string}\n\n\ntype?\n: {string} Programmatic type of email (\n\"work\"\n, \n\"home\"\n, \n\"other\"\n)\n\n\nprimary?\n: {boolean} Indicates a preferred-use address\n\n\nlabel?\n: {string}\n\n\nformattedAddress?\n: {string} Unstructured version of the address\n\n\nphone?\n: {array} An array of phone number objects with the following attributes:\n\n\nnumber\n: {string}\n\n\ntype?\n: {string} Programmatic type of phone number (\n\"work\"\n, \n\"home\"\n, \n\"mobile\"\n, \n\"fax\"\n, \n\"other\"\n)\n\n\nlabel?\n: {string} A user-provided localized type of phone number (example: \n\"Work\"\n)\n\n\nprimary?\n: {boolean} Indicates a preferred-use number\n\n\ncozy?\n: {array} An array of cozy instances with the following attributes:\n\n\nurl\n: {string}\n\n\nlabel?\n: {string} A user-provided localized type of instance\n\n\nprimary?\n: {boolean} Indicates a preferred-use instance\n\n\ngroups\n: {array} An array containing a list of ids of \nio.cozy.contacts.groups\n documents that this contact is part of\n\n\nmetadata\n: {object}\n \u00a0- \nversion\n: {integer} Used for migrations. Current version is \n1\n\n\n\n\nio.cozy.contacts.groups\n\n\nUsed to group contacts together. A group can obviously have multiple contacts, but contacts can also be part of multiple groups.\n\n\n\n\nname\n: {string} is the group\ns public name\n\n\nmetadata\n: {object}\n \u00a0- \nversion\n: {integer} Used for migrations. Current version is \n1", 
            "title": "Contacts"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.contacts/#cozy-contacts-doctype", 
            "text": "", 
            "title": "Cozy Contacts doctype"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.contacts/#iocozycontacts", 
            "text": "The  io.cozy.contacts  doctype is loosely based on the  vCard RFC , in that some of the attributes have been renamed for clarity. The attributes with a  ?  are optional.   fullname? : {string} Unstructured representation of the name (example:  \"Dr. Gregory House, M.D.\" )  name? : {object} Optional structured representation of the name, with the following possible attributes:  familyName? : {string} (example:  \"House\" )  givenName? : {string} (example:  \"Gregory\" )  additionalName? : {string} (example:  \"J.\" )  namePrefix? : {string} (example:  \"Dr.\" )  nameSuffix? : {string} (example:  \"III\" )  birthday? : {date} (example:  \"1959-05-15\" )  note? : {string}  email? : {array} An array of email addresses objects with the following attributes:  address : {string} Email adress  type? : {string} Programmatic type of email ( \"work\" ,  \"home\" ,  \"other\" )  label? : {string} A user-provided localized type of email (example:  \"Work\" )  primary? : {boolean} Indicates a preferred-use address  address? : {array} An array of postal addresses objects with the following attributes:  street? : {string}  pobox? : {string}  city? : {string}  region? : {string}  postcode? : {string}  country? : {string}  type? : {string} Programmatic type of email ( \"work\" ,  \"home\" ,  \"other\" )  primary? : {boolean} Indicates a preferred-use address  label? : {string}  formattedAddress? : {string} Unstructured version of the address  phone? : {array} An array of phone number objects with the following attributes:  number : {string}  type? : {string} Programmatic type of phone number ( \"work\" ,  \"home\" ,  \"mobile\" ,  \"fax\" ,  \"other\" )  label? : {string} A user-provided localized type of phone number (example:  \"Work\" )  primary? : {boolean} Indicates a preferred-use number  cozy? : {array} An array of cozy instances with the following attributes:  url : {string}  label? : {string} A user-provided localized type of instance  primary? : {boolean} Indicates a preferred-use instance  groups : {array} An array containing a list of ids of  io.cozy.contacts.groups  documents that this contact is part of  metadata : {object}\n \u00a0-  version : {integer} Used for migrations. Current version is  1", 
            "title": "io.cozy.contacts"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.contacts/#iocozycontactsgroups", 
            "text": "Used to group contacts together. A group can obviously have multiple contacts, but contacts can also be part of multiple groups.   name : {string} is the group s public name  metadata : {object}\n \u00a0-  version : {integer} Used for migrations. Current version is  1", 
            "title": "io.cozy.contacts.groups"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.files/", 
            "text": "Table of contents\n\n\nCozy Files doctype\n\n\nio.cozy.files\n\n\nThe \nio.cozy.files\n doctype is used for both the files and directories.\n\n\nFolder\n\n\nFor a folder, its attributes are:\n\n\n\n\ntype\n: {string} always \ndirectory\n\n\nname\n: {string} the directory name\n\n\npath\n: {string} the path to this directory, which is the path of its parent, then \n/\n, then its name\n\n\ncreated_at\n: {timestamp} the date of the creation of this directory\n\n\nupdated_at\n: {timestamp} the date of the last update of this directory\n\n\ntags\n: {array of strings} a list of tags\n\n\n\n\nIt also has a relationship with its \nparent\n in the JSON-API representation, and another called \ndata\n with the files and directory inside it.\n\n\nFiles\n\n\nThe attributes of a file are:\n\n\n\n\ntype\n: {string} always \nfile\n\n\nname\n: {string} the file name\n\n\ntrashed\n: {bool} true if the file is in the trash\n\n\nmd5sum\n: {string} the checksum of its content, computed with the MD5 algorithm\n\n\ncreated_at\n: {timestamp} the date of the creation of this directory\n\n\nupdated_at\n: {timestamp} the date of the last update of this directory\n\n\ntags\n: {array of strings} a list of tags\n\n\nsize\n: {number} the size of its content, in bytes\n\n\nexecutable\n: {bool} true is the file has the executable bit on UNIX (\nchmod +x\n)\n\n\nclass\n: {string} a class in the list: \n['image', 'document', 'audio', 'video', 'text', 'binary']\n\n\nmime\n: {string} the full mime-type\n\n\nmetadata\n: {map} an optional map of metadata (for example \nwidth\n, \nheight\n, and \ndatetime\n for an image)\n\n\n\n\nIt also has a relationship with its \nparent\n in the JSON-API representation.\n\n\nFor an \nimage\n, there are 3 links to thumbnails: \nsmall\n, \nmedium\n, and \nlarge\n.\n\n\nReferences\n\n\nIt\ns possible to link a file or a folder to another document.\nIt\ns called \na reference\n.\nIt appears in the JSON-API representation as a \nrefererenced_by\n relationship.", 
            "title": "Files"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.files/#cozy-files-doctype", 
            "text": "", 
            "title": "Cozy Files doctype"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.files/#iocozyfiles", 
            "text": "The  io.cozy.files  doctype is used for both the files and directories.", 
            "title": "io.cozy.files"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.files/#folder", 
            "text": "For a folder, its attributes are:   type : {string} always  directory  name : {string} the directory name  path : {string} the path to this directory, which is the path of its parent, then  / , then its name  created_at : {timestamp} the date of the creation of this directory  updated_at : {timestamp} the date of the last update of this directory  tags : {array of strings} a list of tags   It also has a relationship with its  parent  in the JSON-API representation, and another called  data  with the files and directory inside it.", 
            "title": "Folder"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.files/#files", 
            "text": "The attributes of a file are:   type : {string} always  file  name : {string} the file name  trashed : {bool} true if the file is in the trash  md5sum : {string} the checksum of its content, computed with the MD5 algorithm  created_at : {timestamp} the date of the creation of this directory  updated_at : {timestamp} the date of the last update of this directory  tags : {array of strings} a list of tags  size : {number} the size of its content, in bytes  executable : {bool} true is the file has the executable bit on UNIX ( chmod +x )  class : {string} a class in the list:  ['image', 'document', 'audio', 'video', 'text', 'binary']  mime : {string} the full mime-type  metadata : {map} an optional map of metadata (for example  width ,  height , and  datetime  for an image)   It also has a relationship with its  parent  in the JSON-API representation.  For an  image , there are 3 links to thumbnails:  small ,  medium , and  large .", 
            "title": "Files"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.files/#references", 
            "text": "It s possible to link a file or a folder to another document.\nIt s called  a reference .\nIt appears in the JSON-API representation as a  refererenced_by  relationship.", 
            "title": "References"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.notifications/", 
            "text": "Table of contents\n\n\nCozy Notifications doctype\n\n\nio.cozy.notifications\n\n\nApplications can notify the cozy owner. They will appear in the cozy-bar, the\nmobile app, and a summary can be sent by email.\n\n\n\n\nsource\n: {id} the id of the application/konnector that has made the notification\n\n\nreference\n: {string} a reference for the application (it can be used to hide other notifications like this one, or to update a count in a notification)\n\n\ntitle\n: {string} a title to explain the notification\n\n\ncontent\n: {string} more context about the notification\n\n\nicon\n: {image} an icon to display with the notification\n\n\nactions\n: [{text, intent}] an array of objects with a text and an intent.\n  Each action can be seen as a link, the text being what is shown and the\n  intent what happens when clicking on the link.\n\n\ncreated_at\n: {timestamp} the date of the creation.\n\n\n\n\nSee also \nthe notification documentation\n\nfor more informations.", 
            "title": "Notifications"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.notifications/#cozy-notifications-doctype", 
            "text": "", 
            "title": "Cozy Notifications doctype"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.notifications/#iocozynotifications", 
            "text": "Applications can notify the cozy owner. They will appear in the cozy-bar, the\nmobile app, and a summary can be sent by email.   source : {id} the id of the application/konnector that has made the notification  reference : {string} a reference for the application (it can be used to hide other notifications like this one, or to update a count in a notification)  title : {string} a title to explain the notification  content : {string} more context about the notification  icon : {image} an icon to display with the notification  actions : [{text, intent}] an array of objects with a text and an intent.\n  Each action can be seen as a link, the text being what is shown and the\n  intent what happens when clicking on the link.  created_at : {timestamp} the date of the creation.   See also  the notification documentation \nfor more informations.", 
            "title": "io.cozy.notifications"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.payslips/", 
            "text": "Table of contents\n\n\nPayslips doctype\n\n\nio.cozy.payslips\n\n\n\n\nvendor\n: {string} - Vendor which issued the payslip\n\n\ndate\n: {date} - Date the payslip was emitted\n\n\namount\n: {number} - Amount of the payslip, \nalways positive\n even if it is the payslip of an employee. This amount should always be the amount which will be found in the bank operations.\n\n\n\n\nRelationships\n\n\nThe eventual related documents\n- \ndocument\n: {object} - The associated file. ex:\n\n\n{\n  data: {\n    _id: \nc43645a93831827c7ec512eac3006e51\n,\n    _type: \nio.cozy.files\n\n  }\n}\n\n\n\n\nSome more attributes for employee\ns payslip\n\n\nThe are some more possible attributes for employee payslips.\n\n\n\n\nisEmployee\n: {boolean} - Indicate if this payslip is paid to an employee of the owner of the cozy. If false, this is a payslip received by the owner.\n\n\nbeneficiary\n: {string} - Indicate the name of the employee\n\n\n\n\nExample\n\n\n{\n  \n_id\n: \n62e5d80d6e11d19992b7efce794263f0\n,\n  \namount\n: 2000,\n  \ndate\n: \n2018-02-07T23:00:00.000Z\n,\n  \nvendor\n: \nPayfit\n,\n  \nmetadata\n: {\n    \nversion\n: 1\n  },\n  $relationships: {\n    document: { data: { _id: \nc43645a93831827c7ec512eac3006e51\n, _type: \nio.cozy.files\n } }\n  }\n}\n\n\n\n\n{\n  \n_id\n: \n62e5d83d6e11d19992b7efce794263f0\n,\n  \namount\n: 100,\n  \ndate\n: \n2018-04-07T03:00:00.000Z\n,\n  \nvendor\n: \nCESU\n,\n  \nisEmployee\n: true,\n  \nbeneficiary\n: \nPierre Richard\n,\n  \nmetadata\n: {\n    \nversion\n: 1\n  },\n  $relationships: {\n    payslip: { data: { _id: \nc43645a93831827c7ec512eac3006e51\n, _type: \nio.cozy.files\n } }\n  }\n}", 
            "title": "Payslips"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.payslips/#payslips-doctype", 
            "text": "", 
            "title": "Payslips doctype"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.payslips/#iocozypayslips", 
            "text": "vendor : {string} - Vendor which issued the payslip  date : {date} - Date the payslip was emitted  amount : {number} - Amount of the payslip,  always positive  even if it is the payslip of an employee. This amount should always be the amount which will be found in the bank operations.", 
            "title": "io.cozy.payslips"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.payslips/#relationships", 
            "text": "The eventual related documents\n-  document : {object} - The associated file. ex:  {\n  data: {\n    _id:  c43645a93831827c7ec512eac3006e51 ,\n    _type:  io.cozy.files \n  }\n}", 
            "title": "Relationships"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.payslips/#some-more-attributes-for-employees-payslip", 
            "text": "The are some more possible attributes for employee payslips.   isEmployee : {boolean} - Indicate if this payslip is paid to an employee of the owner of the cozy. If false, this is a payslip received by the owner.  beneficiary : {string} - Indicate the name of the employee", 
            "title": "Some more attributes for employee's payslip"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.payslips/#example", 
            "text": "{\n   _id :  62e5d80d6e11d19992b7efce794263f0 ,\n   amount : 2000,\n   date :  2018-02-07T23:00:00.000Z ,\n   vendor :  Payfit ,\n   metadata : {\n     version : 1\n  },\n  $relationships: {\n    document: { data: { _id:  c43645a93831827c7ec512eac3006e51 , _type:  io.cozy.files  } }\n  }\n}  {\n   _id :  62e5d83d6e11d19992b7efce794263f0 ,\n   amount : 100,\n   date :  2018-04-07T03:00:00.000Z ,\n   vendor :  CESU ,\n   isEmployee : true,\n   beneficiary :  Pierre Richard ,\n   metadata : {\n     version : 1\n  },\n  $relationships: {\n    payslip: { data: { _id:  c43645a93831827c7ec512eac3006e51 , _type:  io.cozy.files  } }\n  }\n}", 
            "title": "Example"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.remote.requests/", 
            "text": "Table of contents\n\n\nLogs of the requests via the remote doctypes\n\n\nio.cozy.remote.requests\n\n\n\n\ndoctype\n: the remote doctype used in the request (example: \norg.wikidata.entity\n)\n\n\nverb\n: the HTTP verb used for the request (\nGET\n or \nPOST\n)\n\n\nurl\n: the URL of the remote website, with variables injected in it\n\n\nresponse_code\n: the HTTP response code, (often \n200\n)\n\n\ncontent_type\n: the content-type of the response (example: \napplication/json\n)\n\n\nvariables\n: the key-\nvalue map of the variables sent to the stack,\n  including the \ncomments\n (variables that are not sent to the remote website,\n  but can be useful for the people reading the logs).\n\n\ncreated_at\n: the date/time of the request", 
            "title": "Remote requests"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.remote.requests/#logs-of-the-requests-via-the-remote-doctypes", 
            "text": "", 
            "title": "Logs of the requests via the remote doctypes"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.remote.requests/#iocozyremoterequests", 
            "text": "doctype : the remote doctype used in the request (example:  org.wikidata.entity )  verb : the HTTP verb used for the request ( GET  or  POST )  url : the URL of the remote website, with variables injected in it  response_code : the HTTP response code, (often  200 )  content_type : the content-type of the response (example:  application/json )  variables : the key- value map of the variables sent to the stack,\n  including the  comments  (variables that are not sent to the remote website,\n  but can be useful for the people reading the logs).  created_at : the date/time of the request", 
            "title": "io.cozy.remote.requests"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.sessions.logins/", 
            "text": "Table of contents\n\n\nSession login entry\n\n\nio.cozy.sessions.logins\n\n\nThis doctype represent an entry in the session history:\n\n\n\n\nip\n: {string} the ip used to login\n\n\ncity\n: {string} the city from where the user has logged in (estimated from IP)\n\n\ncountry\n: {string} the country from where the user has logged in (estimated from IP)\n\n\nuser_agent\n: {string} the full useragent string used to login\n\n\nos\n: {string} the os used to login\n\n\nbrowser\n: {string} the browser used to login\n\n\ncreated_at\n: {string} the login date", 
            "title": "Session logins"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.sessions.logins/#session-login-entry", 
            "text": "", 
            "title": "Session login entry"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.sessions.logins/#iocozysessionslogins", 
            "text": "This doctype represent an entry in the session history:   ip : {string} the ip used to login  city : {string} the city from where the user has logged in (estimated from IP)  country : {string} the country from where the user has logged in (estimated from IP)  user_agent : {string} the full useragent string used to login  os : {string} the os used to login  browser : {string} the browser used to login  created_at : {string} the login date", 
            "title": "io.cozy.sessions.logins"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.triggers/", 
            "text": "Table of contents\n\n\nTriggers doctype\n\n\nio.cozy.triggers\n documents are used by the stack to configure \nhow and when a job should be runned\n.\n\n\nThis is a special doctype which can only be created from an app. We are using it in \nCozy-Collect\n to manage konnectors scheduling.\n\n\nAttributes\n\n\n\n\n\n\n\n\nAttribute\n\n\nRole\n\n\n\n\n\n\n\n\n\n\narguments\n\n\nArguments related to the \ntype\n attribute. For example it\ns a cron configuration when the \ntype\n is set to \n@cron\n.\n\n\n\n\n\n\ndebounce\n\n\nAmount of time until the job cannot be run again. This attribute is used to limite the amount of jobs in a burst.\n\n\n\n\n\n\nmessage\n\n\nParameters to pass to the the worker. For example, when the \nworker\n is set to \nkonnector\n, \nmessage\n contains the related konnector and the related account.\n\n\n\n\n\n\noptions\n\n\nParameters related to the job.\n\n\n\n\n\n\ntype\n\n\nType of trigger. Can be \n@at\n, \n@cron\n, \n@event\n, \n@every\n, and \n@in\n. See the \nstack documentation\n for more informations.\n\n\n\n\n\n\nworker\n\n\nType of worker. Can be \nkonnector\n or \nsendmail\n.\n\n\n\n\n\n\n\n\nExample\n\n\nTrigger configured to run the konnector \nDebug\n with the \nio.cozy.accounts\n document having the id \n53fe4d0e4f6d3be99ba7a5d2580081a8\n.\n\n\n{\n  \ntype\n: \n@cron\n,\n  \nworker\n: \nkonnector\n,\n  \narguments\n: \n0 45 4 * * 3\n,\n  \ndebounce\n: \n,\n  \noptions\n: null,\n  \nmessage\n: {\n    \nkonnector\n: \ndebug\n,\n    \naccount\n: \n53fe4d0e4f6d3be99ba7a5d2580081a8\n\n  }\n}", 
            "title": "Triggers"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.triggers/#triggers-doctype", 
            "text": "io.cozy.triggers  documents are used by the stack to configure  how and when a job should be runned .  This is a special doctype which can only be created from an app. We are using it in  Cozy-Collect  to manage konnectors scheduling.", 
            "title": "Triggers doctype"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.triggers/#attributes", 
            "text": "Attribute  Role      arguments  Arguments related to the  type  attribute. For example it s a cron configuration when the  type  is set to  @cron .    debounce  Amount of time until the job cannot be run again. This attribute is used to limite the amount of jobs in a burst.    message  Parameters to pass to the the worker. For example, when the  worker  is set to  konnector ,  message  contains the related konnector and the related account.    options  Parameters related to the job.    type  Type of trigger. Can be  @at ,  @cron ,  @event ,  @every , and  @in . See the  stack documentation  for more informations.    worker  Type of worker. Can be  konnector  or  sendmail .", 
            "title": "Attributes"
        }, 
        {
            "location": "/cozy-doctypes/docs/io.cozy.triggers/#example", 
            "text": "Trigger configured to run the konnector  Debug  with the  io.cozy.accounts  document having the id  53fe4d0e4f6d3be99ba7a5d2580081a8 .  {\n   type :  @cron ,\n   worker :  konnector ,\n   arguments :  0 45 4 * * 3 ,\n   debounce :  ,\n   options : null,\n   message : {\n     konnector :  debug ,\n     account :  53fe4d0e4f6d3be99ba7a5d2580081a8 \n  }\n}", 
            "title": "Example"
        }, 
        {
            "location": "/cozy-stack/README/", 
            "text": "Table of contents\n\n\nArchitecture\n\n\n\n\nGeneral overview\n\n\nSecurity\n\n\n\n\nUsage\n\n\n\n\nInstall the cozy-stack\n\n\nManpages of the command-line tool\n\n\nConfiguration file\n\n\nManaging Instances\n\n\nOnboarding\n\n\n\n\nFor developpers\n\n\n\n\nDevelop a client-side app\n\n\nRunning and building Docker images\n\n\nBuild a release\n\n\nThe contributing guide\n\n\n\n\nServices\n\n\n\n\n/auth\n - \nAuthentication \n OAuth\n\n\n/apps\n - \nApplications Management\n\n\nApps registry\n\n\n/data\n - \nData System\n\n\nMango\n\n\nReplication\n\n\nCouchDB Quirks\n\n\n/files\n - \nVirtual File System\n\n\nReferences of documents in VFS\n\n\n/intents\n - \nIntents\n\n\n/jobs\n - \nJobs\n\n\nKonnectors\n\n\nWorkers\n\n\n/notifications\n - \nNotifications\n\n\n/permissions\n - \nPermissions\n\n\n/realtime\n - \nRealtime\n\n\n/remote\n - \nProxy for remote data/API\n\n\n/settings\n - \nSettings\n\n\nTerms of Services\n\n\n/sharings\n - \nSharing\n\n\nRequest for comments\n\n\n\n\nArchives\n\n\nThese pages are the results of studies we made:\n\n\n\n\nMoving\n\n\nGolang Couchdb Plugins\n\n\nKonnectors design", 
            "title": "README"
        }, 
        {
            "location": "/cozy-stack/README/#table-of-contents", 
            "text": "", 
            "title": "Table of contents"
        }, 
        {
            "location": "/cozy-stack/README/#architecture", 
            "text": "General overview  Security", 
            "title": "Architecture"
        }, 
        {
            "location": "/cozy-stack/README/#usage", 
            "text": "Install the cozy-stack  Manpages of the command-line tool  Configuration file  Managing Instances  Onboarding", 
            "title": "Usage"
        }, 
        {
            "location": "/cozy-stack/README/#for-developpers", 
            "text": "Develop a client-side app  Running and building Docker images  Build a release  The contributing guide", 
            "title": "For developpers"
        }, 
        {
            "location": "/cozy-stack/README/#services", 
            "text": "/auth  -  Authentication   OAuth  /apps  -  Applications Management  Apps registry  /data  -  Data System  Mango  Replication  CouchDB Quirks  /files  -  Virtual File System  References of documents in VFS  /intents  -  Intents  /jobs  -  Jobs  Konnectors  Workers  /notifications  -  Notifications  /permissions  -  Permissions  /realtime  -  Realtime  /remote  -  Proxy for remote data/API  /settings  -  Settings  Terms of Services  /sharings  -  Sharing  Request for comments", 
            "title": "Services"
        }, 
        {
            "location": "/cozy-stack/README/#archives", 
            "text": "These pages are the results of studies we made:   Moving  Golang Couchdb Plugins  Konnectors design", 
            "title": "Archives"
        }, 
        {
            "location": "/cozy-stack/architecture/", 
            "text": "Table of contents\n\n\nCozy Architecture\n\n\nWhat is Cozy?\n\n\nCozy is a personal platform as a service with a focus on data. Cozy can be seen\nas 4 layers, from inside to outside:\n\n\n\n\nA place to keep your personal data\n\n\nA core API to handle the data\n\n\nYour web apps, and also the mobile \n desktop clients\n\n\nA coherent User Experience.\n\n\n\n\nIt\ns also a set of values: Simple, Versatile, Yours. These values mean a lot for\nCozy in all aspects. From an architectural point of view, it declines to:\n\n\n\n\nSimple to deploy and understand, not built as a galaxy of optimized\n  microservices managed by kubernetes that only experts can debug.\n\n\nVersatile, can be hosted on a Raspberry Pi for geeks to massive scale on\n  multiple servers by specialized hosting. Users can install apps.\n\n\nYours, you own your data and you control it. If you want to take back your\n  data to go elsewhere, you can.\n\n\n\n\nOverview\n\n\nThe architecture of Cozy is composed of:\n\n\n\n\nA reverse proxy\n\n\nThe cozy stack\n\n\nA CouchDB instance to persist the JSON documents\n\n\nA space for storing files\n\n\nOptionally, Redis for caching and synchronization\n\n\nOptionally, a metrics server.\n\n\n\n\nAll of this can run on a personal server, self-hosted at home, like a Raspberry\nPi:\n\n\n\n\nBut it\ns also possible to deploy a cozy on a more powerful server in order to\nhost dozens of cozy instances (an association for example). It will looks like\nthis:\n\n\n\n\nAnd even to scale to thousands of cozy instances on a server farm, with high\navailability:\n\n\n\n\nThis elasticity comes with some constraints:\n\n\n\n\nMost applications are run in the browser, not in the server.\n\n\nWhat must run on the server is mutualized inside the cozy stack.\n\n\nThe cozy stack is stateless.\n\n\nThe data is stored in couchdb and a space for files.\n\n\nA couchdb database is specific to an instance (no mix of data from 2 users in\n  the same database).\n\n\n\n\nReverse proxy\n\n\nThe reverse proxy is here to accept HTTPS connexions and forward the request to\nthe cozy stack. It\ns here mainly to manage the TLS part and binding a port \n\n1024 without needing to launch the cozy stack as root. And it\ns better if http/2\nis supported, as it will make the web interface to load faster.\n\n\nThe Cozy Stack\n\n\nThe Cozy Stack is a single executable. It can do several things but its most\nimportant usage is starting an HTTP server to serve as an API for all the\nservices of Cozy, from authentication to real-time events. This API can be used\non several domains. Each domain is a cozy instance for a specific user\n(\nmulti-tenant\n).\n\n\nRedis\n\n\nRedis is optional when there is a single cozy stack running. When available, it\nis used to synchronize the Cozy Stacks: distributed locks for special operations\nlike installing an application, queues for recurrent jobs, etc. As a bonus, it\ncan also be used to cache some frequently used documents.\n\n\nDatabases\n\n\nThe JSON documents that represent the users data are stored in CouchDB, but they\nare not mixed in a single database. We don\nt mix data from 2 users in the same\ndatabase. It\ns easier and safer to control the access to the data by using\ndifferent databases per user.\n\n\nBut we think to go even further by splitting the data of a user in several\ndatabases, one per document type. For example, we can have a database for the\nemails of a user and one for her todo list. This can simplify the implementation\nof permissions (this app has access to these document types) and can improve\nperformance. CouchDB queries work with views. A view is defined ahead of its\nusage and is built by CouchDB when it is requested and is stale, i.e. there were\nwrites in the database since the last time it was updated. So, with a single\ndatabase per user, it\ns possible to experience lag when the todolist view is\nrequested after fetching a long list of emails. By splitting the databases per\ndoctypes, we gain on two fronts:\n\n\n\n\nThe views are updated less frequently, only when documents of the matching\n   doctypes are written.\n\n\nSome views are no longer necessary: those to access documents of a specific\n   doctypes.\n\n\n\n\nThere are downsides, mostly:\n\n\n\n\nIt can be harder to manage more databases.\n\n\nIt\ns no longer possible to use a single view for documents from doctypes that\n   are no longer in the same database.\n\n\n\n\nWe think that we can work on that and the pros will outweigh the cons.\n\n\nMetrics\n\n\nThe Cozy Stack can generate some metrics about its usage (the size of the files\ntransfered, the number of opened connexions, the number of requests to redis,\netc.) and export them to a metrics backend. It will help identify the\nbottlenecks when scaling to add more users.\n\n\nThe Warp 10 Platform\n looks like a good candidate for\nthis.\n\n\nGlossary\n\n\nInstance\n\n\nAn instance is a logical space owned by a user and identified by a domain. For\nexample, zoe.cozycloud.cc can be the cozy instance of Zo\u00e9. This instance has a\nspace for storing files and some CouchDB databases for storing the documents of\nits owner.\n\n\nEnvironment\n\n\nWhen creating an instance, it\ns possible to give an environment, \ndev\n, \ntest\n\nor \nprod\n. The default apps won\nt be the same on all environments. For example,\nin the \ndev\n environment, some devtools will be installed to help the front\ndevelopers to create their own apps.\n\n\nCozy Stack Build Mode\n\n\nThe cozy stack can run in several modes, set by a UNIX environment variable:\n\n\n\n\nproduction\n, the default\n\n\ndevelopment\n, for coding on the cozy stack.\n\n\n\n\nThis mode is set when compiling the cozy-stack. It is used to show more or less\nlogs, and what is acceptable to be displayed in errors.\n\n\nEven if the Cozy Stack Build Mode and Environment have similar values, they are\nnot the same. The Cozy Stack Mode will be used by core developers to hack on the\ncozy stack. The environment will be used by front developers to hack on cozy\napps.\n\n\nServices\n\n\nThe cozy stack came with several services. They run on the server, inside the\ngolang process and have an HTTP interface.\n\n\nAuthentication \n/auth\n\n\nThe cozy stack can authenticate the owner of a cozy instance. This can happen in\nthe classical web style, with a form and a cookie, but also with OAuth2 for\nremote interactions like cozy-mobile and cozy-desktop.\n\n\nApplications \n/apps\n\n\nIt\ns possible to manage serverless applications from the cozy stack and serve\nthem via cozy stack. The stack does the routing and serve the HTML and the\nassets for the applications.\n\n\nThe assets of the applications are installed in the virtual file system. On the\nbig instances, it means that even if it is the frontal 1 that installs the\napplication, frontal 2 will still be able to serve the application by getting\nits assets from Swift.\n\n\nIt will be possible to install applications from several sources (git,\nmercurial, npm or even just a tarball). Also, we want to offer two channels for\nour official apps: one with a stable and well tested release, and one with more\nfrequent updates for our more adventurous users.\n\n\nMore informations \nhere\n.\n\n\nData System \n/data\n\n\nCouchDB is used for persistence of JSON documents. The data service is a layer\non top of it for routing the requests to the corresponding CouchDB database and\nchecking the permissions.\n\n\nIn particular, a serverless application can declare some contexts and access\ndata in those contexts even if it\ns not the owner of the cozy instance that\naccess it. For example, the owner of a cozy can create a photo album with a\nselection of photos. This album can then be associated to a context to be shared\nwith friends of the owner. These friends can access the album and see the\nphotos, but not anonymous people.\n\n\nMore informations \nhere\n.\n\n\nVirtual File System \n/files\n\n\nIt\ns possible to store files on the cozy, including binary ones like photos and\nmovies, thanks to the virtual file system. It\ns a facade, with several\nimplementations, depending on where the files are effectively stored:\n\n\n\n\nIn a directory of a local file system (easier for self-hosted users)\n\n\nSwift from Open Stack (convenient for massive hosting)\n\n\nAnd more storage providers, like \nminio\n, later.\n\n\n\n\nThe range of possible operations with this endpoint goes from simple ones, like\nuploading a file, to more complex ones, like renaming a folder. It also ensure\nthat an instance is not exceeding its quota, and keeps a trash to recover files\nrecently deleted.\n\n\nMore informations \nhere\n.\n\n\nSharing \n/sharings\n\n\nUsers will want to share things like calendars. This service is there for\nsharing JSON documents between cozy instances, with respect to the access\ncontrol.\n\n\nJobs \n/jobs\n\n\nThe cozy stack has queues where job descriptions can be put. For example, a job\ncan be to fetch the latest bills from a specific provider. These queues can be\nconsumed by external workers to complete the associated jobs.\n\n\nWe can imagine having a media worker that extract thumbnails from photos and\nvideos. It will fetch jobs from a media queue and each job description will\ncontain the path to the photo or video from which the thumbnail will be\nextracted.\n\n\nThere is also a scheduler that acts like a crontab. It can add jobs at recurrent\ntime. For example, it can add a job for fetching github commits every hour.\n\n\nLater, we can dream about having more ways to create jobs (webhooks, on document\ncreation) and make them communicate. With a web interface on that, it can become\na simplified \nIfttt\n.\n\n\nSync \n/sync\n\n\nThis endpoint will be for synchronizing your contacts and calendars by using\nstandard methods like caldav and carddav. Later, we hope to support also Webdav\nand RemoteStorage.\n\n\nSettings \n/settings\n\n\nEach cozy instance has some settings, like its domain name, its language, the\nname of its owner, the background for the home, etc.\n\n\nNotifications \n/notifications\n\n\nThe applications can put some notifications for the user. That goes from a\nreminder for a meeting in 10 minutes to a suggestion to update your app.\n\n\nReal-time \n/realtime\n\n\nThis endpoint can be used to subscribe for real-time events. An application that\nshows items of a specific doctype can listen for this doctype to be notified of\nall the changes for this doctype. For example, the calendar app can listen for\nall the events and if a synchronization with the mobile adds a new event, the\napp will be notified and can show this new event.\n\n\nError catcher \n/errors\n\n\nClient-side applications can have some JS errors. By sending the error, with its\nbacktrace, to this endpoint, it will be kept in a logfile to help the developers\ndebug the application later. We should look at the\n\nairbrake API\n and probably be compatible with it\nto avoid redeveloping JS code to send the errors.\n\n\nProxy \n/proxy\n\n\nIt can be useful for client-side apps to get data from public APIs. But,\nsometimes, these APIs don\nt have CORS enabled. A proxy endpoint can be a simple\nbut effective solution for these cases.\n\n\nStatus \n/status\n\n\nIt\ns here just to say that the API is up and that it can access the CouchDB\ndatabases, for debugging and monitoring purposes.\n\n\nWorkers\n\n\nThe workers take jobs from the queues and process them.\n\n\nFetch emails \n/jobs/mailbox\n\n\nIt fetches a mailbox to synchronize it and see if there are some new emails.\n\n\nPayload: the mailbox\n\n\nSend email \n/jobs/sendmail\n\n\nIt connects to the SMTP server to send an email.\n\n\nPayload: mail account, recipient, body, attachments\n\n\nExtract metadata \n/jobs/metadata\n\n\nWhen a file is added or updated, this worker will extract its metadata (EXIF for\nan image, id3 for a music, etc.)\n\n\nPayload: the filepath\n\n\nKonnectors \n/jobs/konnector\n\n\nIt synchronizes an account on a remote service (fetch bills for example).\n\n\nPayload: the kind of konnector, the credentials of the account and some optional\nparameters (like the folder where to put the files)\n\n\nRegistry \n/jobs/registry\n\n\nIt updates the list of available applications.\n\n\nPayload: none\n\n\nIndexer \n/jobs/indexer\n\n\nWhen a JSON document is added, updated or deleted, this worker will update the\nindex for full text search. \nBleve\n looks like a\ngood candidate for the indexing and full text search technology.\n\n\nPayload: the doctype and the document to index\n\n\nServerless apps\n\n\nHome \n/apps/home\n\n\nIt\ns where you land on your cozy and launch your apps. Having widgets to display\ninformations would be nice too!\n\n\nStore (was marketplace) \n/apps/store\n\n\nYou can install new apps here.\n\n\nSettings (was My apps) \n/apps/settings\n\n\nIt\ns a list of your installed apps and devices, and you can configure some\nsettings like your email address.\n\n\nCollect (was konnectors) \n/apps/collect\n\n\nYou can configure new accounts, to fetch data from them, and see the already\nconfigured accounts.\n\n\nDevtools \n/apps/devtools\n\n\nSome tools for the developpers of applications only: an API console,\ndocumentation, logs of the permission checks, etc.\n\n\nContacts \n/apps/contacts\n\n\nManage your contact books.\n\n\nCalendar \n/apps/calendar\n\n\nManage your events and alarms.\n\n\nDrive \n/apps/drive\n\n\nA web interface to browse your files.\n\n\nPhotos \n/apps/photos\n\n\nOrganize your photos and share them with friends.\n\n\nTodo list \n/apps/todo\n\n\nA task manager to never forgot what you should do.\n\n\nOnboarding \n/apps/onboarding\n\n\nStart your cozy and setup your accounts.\n\n\nClients\n\n\nMobile\n\n\nCozy-mobile is an application for android and iOS for synchronizing files,\ncontacts and calendars between the phone and the cozy instance.\n\n\nDesktop\n\n\nCozy-desktop is a client for Linux, OSX and windows that allows to sync the\nfiles in a cozy instance with a laptop or desktop.\n\n\nGuidelines\n\n\nThe Go Programming Language\n\n\nGo (often referred as golang) is an open source programming language created at\nGoogle in 2007. It has nice properties for our usage:\n\n\n\n\nSimplicity (the language can be learned in weeks, not years).\n\n\nA focus on productivity.\n\n\nGood performance.\n\n\nA good support of concurrency with channels and goroutines.\n\n\n\n\nMoreover, Go is\n\nused by a lot of companies\n, is in\n\nthe Top 10 of the most used languages\n\nand has some known open source projects: docker, kubernetes, grafana, syncthing,\ninfluxdb, caddy, etc. And it works on\n\nthe ARM platforms\n.\n\n\nGo has some tools to help the developers to format its code (\ngo fmt\n), retrieve\nand install external packages (\ngo get\n), display documentation (\ngodoc\n), check\nfor potential errors with static analysis (\ngo vet\n), etc. Most of them can be\nused via \ngometalinter\n, which is\nnice for continuous integration.\n\n\nSo, we think that writing the Cozy Stack in Go is the right choice.\n\n\nRepository organisation\n\n\n\u251c\u2500\u2500 assets          The assets for the front-end\n\u2502   \u251c\u2500\u2500 images      The images\n\u2502   \u251c\u2500\u2500 scripts     The javascript files\n\u2502   \u251c\u2500\u2500 styles      The CSS files\n\u2502   \u2514\u2500\u2500 templates   The HTML templates\n\u251c\u2500\u2500 cmd             One .go file for each command of the cozy executable\n\u251c\u2500\u2500 docs            Documentation, including this file\n\u251c\u2500\u2500 pkg             One sub-directory for each golang package\n\u251c\u2500\u2500 scripts         Some shell scripts for developers and testing\n\u2514\u2500\u2500 web             One sub-directory for each of the services listed above\n\n\n\n\nRest API\n\n\nWe follow the best practices about Rest API (using the right status codes, HTTP\nverbs, organise code by resources, use content-negociation, etc.). When known\nstandards make sense (caldav \n carddav for example), use them. Else,\n\nJSON API\n is a good default.\n\n\nThe golang web framework used for the cozy stack is\n\nEcho\n.\n\n\nHTTP status codes\n\n\nThere are some HTTP status codes that are generally used in the API:\n\n\n\n\n200 OK, when everything is OK\n\n\n201 Created, when a resource was created\n\n\n204 No Content, when a resource was deleted\n\n\n400 Bad Request, when the request has some unknown parameters and the request\n  body is not in the expected format\n\n\n401 Unauthorized, when the user is not authenticated\n\n\n403 Forbidden, when the permissions forbid this action\n\n\n404 Not Found, when the resouce can\nt be found\n\n\n500 Internal Server Error, when a bug occurs\n\n\n503 Service Unavailable, when the stack, CouchDB, Redis or Swift is\n  unavailable.\n\n\n\n\nDocTypes\n\n\nEach JSON document saved in CouchDB has a field \ndocType\n that identify the kind\nof thing it is. For example, a contact will have the docType \nio.cozy.contacts\n,\nand in the cozy-doctypes repository, there will be a contacts JSON file inside\nit that describes this doctype:\n\n\n\n\nWhat are the mandatory and optional fields?\n\n\nWhat is the type (string, integer, date) of the fields?\n\n\nIs there a validation rule for a field?\n\n\nHow the fields can be indexed for full text search?\n\n\nWhat is the role of each field (documentation)?\n\n\n\n\nThis description can be used by any cozy client library (JS, Golang, etc.) to\ngenerate some models to simplify the use of documents of this doctype.\n\n\nWhen a docType has a lot of logic (calendar events for example), a JS class\nshould be shared between the several client-side apps that use this docType, in\norder to avoid recoding this logic in each application.\n\n\nImport and export\n\n\n\n\nYou will stay because you can leave.\n\n\n\n\nAn important promise of Cozy is to give back to the users the control of their\ndata. And this promise is not complete with a way to export the data to use it\nsomewhere else.\n\n\nThe Cozy Stack will offer an export button that gives a tarball to the user with\nthe full data. She can then import it on another instance for example. It should\nalso be possible to use the data outside of Cozy. So, the format for the tarball\nshould be as simple as possible and be documented. Of course, when it\ns\npossible, we will use open formats.\n\n\nHow to contribute?\n\n\nCozy\ns DNA is fundamentally Open Source and we want our community to thrive.\nHaving contributions (code, design, translations) is important for us and we\nwill try to create the favorable conditions to support it.\n\n\nAdding a new konnector\n\n\nAdding a konnector is easy for someone who knows JavaScript. The repository has\nalready a lot of pull requests by external contributors. The wiki has\ndocumentation to explain the first steps of creating a new konnector. 3 active\ncontributors have been promoted to the maintainers team and can merge the pull\nrequests. We have done workshops to help new developers code their first\nkonnector and we will keep doing it.\n\n\nCreating a new application\n\n\nOne of the goals of the new architecture is to make it easier for developers to\nwrite new apps. It means having a good documentation, but also some devtools to\nhelp:\n\n\n\n\nThe \ncozy\n executable will have a command to setup a new project.\n\n\nThe devtools on the cozy interface will give documentation about the doctypes,\n  help explore the Rest API, and check if the permissions are OK.\n\n\ncozy-ui\n will make it easy to reuse some widgets and offer an application\n  with a style coherent to the cozy identity.\n\n\nSome docTypes with heavy logic will be available as JS classes to be reused in\n  the apps.\n\n\n\n\nReporting a bug or suggesting a new feature\n\n\nWe are listening to our users. The forum is here to discuss on many subjects,\nincluding how the applications are used. The issues on github are a good place\nfor bug tracking.\n\n\nTranslating to a new language\n\n\nWe will keep having internationalization for our applications and the\ntranslations are maintained on transifex by the community. Translating to a new\nlanguage, or reviewing an existing one, is really appreciated.\n\n\nFAQ\n\n\n\n\nDoes the current konnectors in nodejs will be lost?\n\n\n\n\nNo, they won\nt. The business logic to scrap data from the many sources will be\nkept and they will be adapted to fit in this new architecture. It is explained\nhow we will do that \nhere\n.\n\n\n\n\nSo, it\ns not possible to have a custom application with a server part, like\nthe lounge IRC client?\n\n\n\n\nWe want to support this use case, just not on the short term. It\ns not clear how\nwe can do that (while not weakening the security). One idea is to run the\napplications in a different server, or maybe in docker.\n\n\n\n\nHow to install and update cozy?\n\n\n\n\nThe Cozy Stack will have no auto-update mechanism. For installing and updating\nit, you can use the classical ways:\n\n\n\n\nUsing a package manager, like apt for debian \n ubuntu.\n\n\nUsing an official image for Raspberry Pi (and other embedded platforms).\n\n\nUsing the image and services of an hosting company.\n\n\nOr compiling and installing it manually if you are really brave ;-)\n\n\n\n\n\n\nHow to add a cozy instance to a farm?\n\n\n\n\n\n\nChoose a (sub-)domain and configure the DNS for this (sub-)domain.\n\n\nConfigure the reverse-proxy to accept this (sub-)domain.\n\n\nUse the \ncozy\n executable to configure the cozy stack.\n\n\n\n\n\n\nHow to migrate from the nodejs cozy to this new architecture for cozy?\n\n\n\n\n\n\nExport the data from the nodejs cozy (we need to add a button in the web\n   interface for that in the coming months).\n\n\nInstall the new cozy.\n\n\nImport the data.\n\n\n\n\nPlease note that we don\nt support a continuous replication method that will\nenable to use both the nodejs and the new architecture at the same time. It\nlooks too complicated for a temporary thing.\n\n\n\n\nHow to backup the data?\n\n\n\n\nThere are 2 sensitive places with data:\n\n\n\n\nIn CouchDB.\n\n\non the place used for the Virtual File System (a directory on the local\n  filesystem, or in Swift).\n\n\n\n\nYou can use the tools of your choice to backup these 2 locations. The good old\nrsync works fine (CouchDB files are append-only, except when compaction happens,\nso it\ns friendly to rsync).\n\n\nIt\ns highly recommended to have an automated backup, but sometimes it can be\nuseful to have a way to backup manually the data. The \nexport data\n button in\nthe web interface give a tarball that can be used to transfer your data from one\ninstance to another, and so, it can be used as a backup.\n\n\n\n\nAren\nt microservices better for scaling?\n\n\n\n\nYes, it\ns often easier to scale by separating concerns, and microservices is a\nway to achieve that. But, it has some serious downsides:\n\n\n\n\nIt takes more memory and it\ns probably a no-go for Raspberry Pi.\n\n\nIt\ns more complicated for a developper to install the whole stack before\n  coding its application.\n\n\nIt\ns harder to deploy in production.\n\n\n\n\nFor the scalability, we can also deploy some specialized instances of the Cozy\nStack. For example, we can have some Cozy Stack processes dedicated for\nreal-time. Even, if they have all the code, we can route only the relevant\ntrafic from the load-balancer.\n\n\n\n\nWhat are the frameworks and tools used for the front-end apps?\n\n\n\n\nIf you want to develop your own app, you can use the framework and the tools you\nlike, nothing is mandatory. For the official apps, we will want to move to:\n\n\n\n\nes2017 (but converting the existing coffeescript code will take time)\n\n\nnpm scripts and webpack\n\n\npreact \n JSX.\n\n\n\n\nMore about this\n\nhere\n\n\n\n\nWhen will this new architecture be available?\n\n\n\n\nThe roadmap for Cozy v3 has been explained on our blog:\nhttps://blog.cozycloud.cc/post/2016/11/21/On-the-road-to-Cozy-version-3", 
            "title": "General overview"
        }, 
        {
            "location": "/cozy-stack/architecture/#cozy-architecture", 
            "text": "", 
            "title": "Cozy Architecture"
        }, 
        {
            "location": "/cozy-stack/architecture/#what-is-cozy", 
            "text": "Cozy is a personal platform as a service with a focus on data. Cozy can be seen\nas 4 layers, from inside to outside:   A place to keep your personal data  A core API to handle the data  Your web apps, and also the mobile   desktop clients  A coherent User Experience.   It s also a set of values: Simple, Versatile, Yours. These values mean a lot for\nCozy in all aspects. From an architectural point of view, it declines to:   Simple to deploy and understand, not built as a galaxy of optimized\n  microservices managed by kubernetes that only experts can debug.  Versatile, can be hosted on a Raspberry Pi for geeks to massive scale on\n  multiple servers by specialized hosting. Users can install apps.  Yours, you own your data and you control it. If you want to take back your\n  data to go elsewhere, you can.", 
            "title": "What is Cozy?"
        }, 
        {
            "location": "/cozy-stack/architecture/#overview", 
            "text": "The architecture of Cozy is composed of:   A reverse proxy  The cozy stack  A CouchDB instance to persist the JSON documents  A space for storing files  Optionally, Redis for caching and synchronization  Optionally, a metrics server.   All of this can run on a personal server, self-hosted at home, like a Raspberry\nPi:   But it s also possible to deploy a cozy on a more powerful server in order to\nhost dozens of cozy instances (an association for example). It will looks like\nthis:   And even to scale to thousands of cozy instances on a server farm, with high\navailability:   This elasticity comes with some constraints:   Most applications are run in the browser, not in the server.  What must run on the server is mutualized inside the cozy stack.  The cozy stack is stateless.  The data is stored in couchdb and a space for files.  A couchdb database is specific to an instance (no mix of data from 2 users in\n  the same database).", 
            "title": "Overview"
        }, 
        {
            "location": "/cozy-stack/architecture/#reverse-proxy", 
            "text": "The reverse proxy is here to accept HTTPS connexions and forward the request to\nthe cozy stack. It s here mainly to manage the TLS part and binding a port  \n1024 without needing to launch the cozy stack as root. And it s better if http/2\nis supported, as it will make the web interface to load faster.", 
            "title": "Reverse proxy"
        }, 
        {
            "location": "/cozy-stack/architecture/#the-cozy-stack", 
            "text": "The Cozy Stack is a single executable. It can do several things but its most\nimportant usage is starting an HTTP server to serve as an API for all the\nservices of Cozy, from authentication to real-time events. This API can be used\non several domains. Each domain is a cozy instance for a specific user\n( multi-tenant ).", 
            "title": "The Cozy Stack"
        }, 
        {
            "location": "/cozy-stack/architecture/#redis", 
            "text": "Redis is optional when there is a single cozy stack running. When available, it\nis used to synchronize the Cozy Stacks: distributed locks for special operations\nlike installing an application, queues for recurrent jobs, etc. As a bonus, it\ncan also be used to cache some frequently used documents.", 
            "title": "Redis"
        }, 
        {
            "location": "/cozy-stack/architecture/#databases", 
            "text": "The JSON documents that represent the users data are stored in CouchDB, but they\nare not mixed in a single database. We don t mix data from 2 users in the same\ndatabase. It s easier and safer to control the access to the data by using\ndifferent databases per user.  But we think to go even further by splitting the data of a user in several\ndatabases, one per document type. For example, we can have a database for the\nemails of a user and one for her todo list. This can simplify the implementation\nof permissions (this app has access to these document types) and can improve\nperformance. CouchDB queries work with views. A view is defined ahead of its\nusage and is built by CouchDB when it is requested and is stale, i.e. there were\nwrites in the database since the last time it was updated. So, with a single\ndatabase per user, it s possible to experience lag when the todolist view is\nrequested after fetching a long list of emails. By splitting the databases per\ndoctypes, we gain on two fronts:   The views are updated less frequently, only when documents of the matching\n   doctypes are written.  Some views are no longer necessary: those to access documents of a specific\n   doctypes.   There are downsides, mostly:   It can be harder to manage more databases.  It s no longer possible to use a single view for documents from doctypes that\n   are no longer in the same database.   We think that we can work on that and the pros will outweigh the cons.", 
            "title": "Databases"
        }, 
        {
            "location": "/cozy-stack/architecture/#metrics", 
            "text": "The Cozy Stack can generate some metrics about its usage (the size of the files\ntransfered, the number of opened connexions, the number of requests to redis,\netc.) and export them to a metrics backend. It will help identify the\nbottlenecks when scaling to add more users.  The Warp 10 Platform  looks like a good candidate for\nthis.", 
            "title": "Metrics"
        }, 
        {
            "location": "/cozy-stack/architecture/#glossary", 
            "text": "", 
            "title": "Glossary"
        }, 
        {
            "location": "/cozy-stack/architecture/#instance", 
            "text": "An instance is a logical space owned by a user and identified by a domain. For\nexample, zoe.cozycloud.cc can be the cozy instance of Zo\u00e9. This instance has a\nspace for storing files and some CouchDB databases for storing the documents of\nits owner.", 
            "title": "Instance"
        }, 
        {
            "location": "/cozy-stack/architecture/#environment", 
            "text": "When creating an instance, it s possible to give an environment,  dev ,  test \nor  prod . The default apps won t be the same on all environments. For example,\nin the  dev  environment, some devtools will be installed to help the front\ndevelopers to create their own apps.", 
            "title": "Environment"
        }, 
        {
            "location": "/cozy-stack/architecture/#cozy-stack-build-mode", 
            "text": "The cozy stack can run in several modes, set by a UNIX environment variable:   production , the default  development , for coding on the cozy stack.   This mode is set when compiling the cozy-stack. It is used to show more or less\nlogs, and what is acceptable to be displayed in errors.  Even if the Cozy Stack Build Mode and Environment have similar values, they are\nnot the same. The Cozy Stack Mode will be used by core developers to hack on the\ncozy stack. The environment will be used by front developers to hack on cozy\napps.", 
            "title": "Cozy Stack Build Mode"
        }, 
        {
            "location": "/cozy-stack/architecture/#services", 
            "text": "The cozy stack came with several services. They run on the server, inside the\ngolang process and have an HTTP interface.", 
            "title": "Services"
        }, 
        {
            "location": "/cozy-stack/architecture/#authentication-auth", 
            "text": "The cozy stack can authenticate the owner of a cozy instance. This can happen in\nthe classical web style, with a form and a cookie, but also with OAuth2 for\nremote interactions like cozy-mobile and cozy-desktop.", 
            "title": "Authentication /auth"
        }, 
        {
            "location": "/cozy-stack/architecture/#applications-apps", 
            "text": "It s possible to manage serverless applications from the cozy stack and serve\nthem via cozy stack. The stack does the routing and serve the HTML and the\nassets for the applications.  The assets of the applications are installed in the virtual file system. On the\nbig instances, it means that even if it is the frontal 1 that installs the\napplication, frontal 2 will still be able to serve the application by getting\nits assets from Swift.  It will be possible to install applications from several sources (git,\nmercurial, npm or even just a tarball). Also, we want to offer two channels for\nour official apps: one with a stable and well tested release, and one with more\nfrequent updates for our more adventurous users.  More informations  here .", 
            "title": "Applications /apps"
        }, 
        {
            "location": "/cozy-stack/architecture/#data-system-data", 
            "text": "CouchDB is used for persistence of JSON documents. The data service is a layer\non top of it for routing the requests to the corresponding CouchDB database and\nchecking the permissions.  In particular, a serverless application can declare some contexts and access\ndata in those contexts even if it s not the owner of the cozy instance that\naccess it. For example, the owner of a cozy can create a photo album with a\nselection of photos. This album can then be associated to a context to be shared\nwith friends of the owner. These friends can access the album and see the\nphotos, but not anonymous people.  More informations  here .", 
            "title": "Data System /data"
        }, 
        {
            "location": "/cozy-stack/architecture/#virtual-file-system-files", 
            "text": "It s possible to store files on the cozy, including binary ones like photos and\nmovies, thanks to the virtual file system. It s a facade, with several\nimplementations, depending on where the files are effectively stored:   In a directory of a local file system (easier for self-hosted users)  Swift from Open Stack (convenient for massive hosting)  And more storage providers, like  minio , later.   The range of possible operations with this endpoint goes from simple ones, like\nuploading a file, to more complex ones, like renaming a folder. It also ensure\nthat an instance is not exceeding its quota, and keeps a trash to recover files\nrecently deleted.  More informations  here .", 
            "title": "Virtual File System /files"
        }, 
        {
            "location": "/cozy-stack/architecture/#sharing-sharings", 
            "text": "Users will want to share things like calendars. This service is there for\nsharing JSON documents between cozy instances, with respect to the access\ncontrol.", 
            "title": "Sharing /sharings"
        }, 
        {
            "location": "/cozy-stack/architecture/#jobs-jobs", 
            "text": "The cozy stack has queues where job descriptions can be put. For example, a job\ncan be to fetch the latest bills from a specific provider. These queues can be\nconsumed by external workers to complete the associated jobs.  We can imagine having a media worker that extract thumbnails from photos and\nvideos. It will fetch jobs from a media queue and each job description will\ncontain the path to the photo or video from which the thumbnail will be\nextracted.  There is also a scheduler that acts like a crontab. It can add jobs at recurrent\ntime. For example, it can add a job for fetching github commits every hour.  Later, we can dream about having more ways to create jobs (webhooks, on document\ncreation) and make them communicate. With a web interface on that, it can become\na simplified  Ifttt .", 
            "title": "Jobs /jobs"
        }, 
        {
            "location": "/cozy-stack/architecture/#sync-sync", 
            "text": "This endpoint will be for synchronizing your contacts and calendars by using\nstandard methods like caldav and carddav. Later, we hope to support also Webdav\nand RemoteStorage.", 
            "title": "Sync /sync"
        }, 
        {
            "location": "/cozy-stack/architecture/#settings-settings", 
            "text": "Each cozy instance has some settings, like its domain name, its language, the\nname of its owner, the background for the home, etc.", 
            "title": "Settings /settings"
        }, 
        {
            "location": "/cozy-stack/architecture/#notifications-notifications", 
            "text": "The applications can put some notifications for the user. That goes from a\nreminder for a meeting in 10 minutes to a suggestion to update your app.", 
            "title": "Notifications /notifications"
        }, 
        {
            "location": "/cozy-stack/architecture/#real-time-realtime", 
            "text": "This endpoint can be used to subscribe for real-time events. An application that\nshows items of a specific doctype can listen for this doctype to be notified of\nall the changes for this doctype. For example, the calendar app can listen for\nall the events and if a synchronization with the mobile adds a new event, the\napp will be notified and can show this new event.", 
            "title": "Real-time /realtime"
        }, 
        {
            "location": "/cozy-stack/architecture/#error-catcher-errors", 
            "text": "Client-side applications can have some JS errors. By sending the error, with its\nbacktrace, to this endpoint, it will be kept in a logfile to help the developers\ndebug the application later. We should look at the airbrake API  and probably be compatible with it\nto avoid redeveloping JS code to send the errors.", 
            "title": "Error catcher /errors"
        }, 
        {
            "location": "/cozy-stack/architecture/#proxy-proxy", 
            "text": "It can be useful for client-side apps to get data from public APIs. But,\nsometimes, these APIs don t have CORS enabled. A proxy endpoint can be a simple\nbut effective solution for these cases.", 
            "title": "Proxy /proxy"
        }, 
        {
            "location": "/cozy-stack/architecture/#status-status", 
            "text": "It s here just to say that the API is up and that it can access the CouchDB\ndatabases, for debugging and monitoring purposes.", 
            "title": "Status /status"
        }, 
        {
            "location": "/cozy-stack/architecture/#workers", 
            "text": "The workers take jobs from the queues and process them.", 
            "title": "Workers"
        }, 
        {
            "location": "/cozy-stack/architecture/#fetch-emails-jobsmailbox", 
            "text": "It fetches a mailbox to synchronize it and see if there are some new emails.  Payload: the mailbox", 
            "title": "Fetch emails /jobs/mailbox"
        }, 
        {
            "location": "/cozy-stack/architecture/#send-email-jobssendmail", 
            "text": "It connects to the SMTP server to send an email.  Payload: mail account, recipient, body, attachments", 
            "title": "Send email /jobs/sendmail"
        }, 
        {
            "location": "/cozy-stack/architecture/#extract-metadata-jobsmetadata", 
            "text": "When a file is added or updated, this worker will extract its metadata (EXIF for\nan image, id3 for a music, etc.)  Payload: the filepath", 
            "title": "Extract metadata /jobs/metadata"
        }, 
        {
            "location": "/cozy-stack/architecture/#konnectors-jobskonnector", 
            "text": "It synchronizes an account on a remote service (fetch bills for example).  Payload: the kind of konnector, the credentials of the account and some optional\nparameters (like the folder where to put the files)", 
            "title": "Konnectors /jobs/konnector"
        }, 
        {
            "location": "/cozy-stack/architecture/#registry-jobsregistry", 
            "text": "It updates the list of available applications.  Payload: none", 
            "title": "Registry /jobs/registry"
        }, 
        {
            "location": "/cozy-stack/architecture/#indexer-jobsindexer", 
            "text": "When a JSON document is added, updated or deleted, this worker will update the\nindex for full text search.  Bleve  looks like a\ngood candidate for the indexing and full text search technology.  Payload: the doctype and the document to index", 
            "title": "Indexer /jobs/indexer"
        }, 
        {
            "location": "/cozy-stack/architecture/#serverless-apps", 
            "text": "", 
            "title": "Serverless apps"
        }, 
        {
            "location": "/cozy-stack/architecture/#home-appshome", 
            "text": "It s where you land on your cozy and launch your apps. Having widgets to display\ninformations would be nice too!", 
            "title": "Home /apps/home"
        }, 
        {
            "location": "/cozy-stack/architecture/#store-was-marketplace-appsstore", 
            "text": "You can install new apps here.", 
            "title": "Store (was marketplace) /apps/store"
        }, 
        {
            "location": "/cozy-stack/architecture/#settings-was-my-apps-appssettings", 
            "text": "It s a list of your installed apps and devices, and you can configure some\nsettings like your email address.", 
            "title": "Settings (was My apps) /apps/settings"
        }, 
        {
            "location": "/cozy-stack/architecture/#collect-was-konnectors-appscollect", 
            "text": "You can configure new accounts, to fetch data from them, and see the already\nconfigured accounts.", 
            "title": "Collect (was konnectors) /apps/collect"
        }, 
        {
            "location": "/cozy-stack/architecture/#devtools-appsdevtools", 
            "text": "Some tools for the developpers of applications only: an API console,\ndocumentation, logs of the permission checks, etc.", 
            "title": "Devtools /apps/devtools"
        }, 
        {
            "location": "/cozy-stack/architecture/#contacts-appscontacts", 
            "text": "Manage your contact books.", 
            "title": "Contacts /apps/contacts"
        }, 
        {
            "location": "/cozy-stack/architecture/#calendar-appscalendar", 
            "text": "Manage your events and alarms.", 
            "title": "Calendar /apps/calendar"
        }, 
        {
            "location": "/cozy-stack/architecture/#drive-appsdrive", 
            "text": "A web interface to browse your files.", 
            "title": "Drive /apps/drive"
        }, 
        {
            "location": "/cozy-stack/architecture/#photos-appsphotos", 
            "text": "Organize your photos and share them with friends.", 
            "title": "Photos /apps/photos"
        }, 
        {
            "location": "/cozy-stack/architecture/#todo-list-appstodo", 
            "text": "A task manager to never forgot what you should do.", 
            "title": "Todo list /apps/todo"
        }, 
        {
            "location": "/cozy-stack/architecture/#onboarding-appsonboarding", 
            "text": "Start your cozy and setup your accounts.", 
            "title": "Onboarding /apps/onboarding"
        }, 
        {
            "location": "/cozy-stack/architecture/#clients", 
            "text": "", 
            "title": "Clients"
        }, 
        {
            "location": "/cozy-stack/architecture/#mobile", 
            "text": "Cozy-mobile is an application for android and iOS for synchronizing files,\ncontacts and calendars between the phone and the cozy instance.", 
            "title": "Mobile"
        }, 
        {
            "location": "/cozy-stack/architecture/#desktop", 
            "text": "Cozy-desktop is a client for Linux, OSX and windows that allows to sync the\nfiles in a cozy instance with a laptop or desktop.", 
            "title": "Desktop"
        }, 
        {
            "location": "/cozy-stack/architecture/#guidelines", 
            "text": "", 
            "title": "Guidelines"
        }, 
        {
            "location": "/cozy-stack/architecture/#the-go-programming-language", 
            "text": "Go (often referred as golang) is an open source programming language created at\nGoogle in 2007. It has nice properties for our usage:   Simplicity (the language can be learned in weeks, not years).  A focus on productivity.  Good performance.  A good support of concurrency with channels and goroutines.   Moreover, Go is used by a lot of companies , is in the Top 10 of the most used languages \nand has some known open source projects: docker, kubernetes, grafana, syncthing,\ninfluxdb, caddy, etc. And it works on the ARM platforms .  Go has some tools to help the developers to format its code ( go fmt ), retrieve\nand install external packages ( go get ), display documentation ( godoc ), check\nfor potential errors with static analysis ( go vet ), etc. Most of them can be\nused via  gometalinter , which is\nnice for continuous integration.  So, we think that writing the Cozy Stack in Go is the right choice.", 
            "title": "The Go Programming Language"
        }, 
        {
            "location": "/cozy-stack/architecture/#repository-organisation", 
            "text": "\u251c\u2500\u2500 assets          The assets for the front-end\n\u2502   \u251c\u2500\u2500 images      The images\n\u2502   \u251c\u2500\u2500 scripts     The javascript files\n\u2502   \u251c\u2500\u2500 styles      The CSS files\n\u2502   \u2514\u2500\u2500 templates   The HTML templates\n\u251c\u2500\u2500 cmd             One .go file for each command of the cozy executable\n\u251c\u2500\u2500 docs            Documentation, including this file\n\u251c\u2500\u2500 pkg             One sub-directory for each golang package\n\u251c\u2500\u2500 scripts         Some shell scripts for developers and testing\n\u2514\u2500\u2500 web             One sub-directory for each of the services listed above", 
            "title": "Repository organisation"
        }, 
        {
            "location": "/cozy-stack/architecture/#rest-api", 
            "text": "We follow the best practices about Rest API (using the right status codes, HTTP\nverbs, organise code by resources, use content-negociation, etc.). When known\nstandards make sense (caldav   carddav for example), use them. Else, JSON API  is a good default.  The golang web framework used for the cozy stack is Echo .", 
            "title": "Rest API"
        }, 
        {
            "location": "/cozy-stack/architecture/#http-status-codes", 
            "text": "There are some HTTP status codes that are generally used in the API:   200 OK, when everything is OK  201 Created, when a resource was created  204 No Content, when a resource was deleted  400 Bad Request, when the request has some unknown parameters and the request\n  body is not in the expected format  401 Unauthorized, when the user is not authenticated  403 Forbidden, when the permissions forbid this action  404 Not Found, when the resouce can t be found  500 Internal Server Error, when a bug occurs  503 Service Unavailable, when the stack, CouchDB, Redis or Swift is\n  unavailable.", 
            "title": "HTTP status codes"
        }, 
        {
            "location": "/cozy-stack/architecture/#doctypes", 
            "text": "Each JSON document saved in CouchDB has a field  docType  that identify the kind\nof thing it is. For example, a contact will have the docType  io.cozy.contacts ,\nand in the cozy-doctypes repository, there will be a contacts JSON file inside\nit that describes this doctype:   What are the mandatory and optional fields?  What is the type (string, integer, date) of the fields?  Is there a validation rule for a field?  How the fields can be indexed for full text search?  What is the role of each field (documentation)?   This description can be used by any cozy client library (JS, Golang, etc.) to\ngenerate some models to simplify the use of documents of this doctype.  When a docType has a lot of logic (calendar events for example), a JS class\nshould be shared between the several client-side apps that use this docType, in\norder to avoid recoding this logic in each application.", 
            "title": "DocTypes"
        }, 
        {
            "location": "/cozy-stack/architecture/#import-and-export", 
            "text": "You will stay because you can leave.   An important promise of Cozy is to give back to the users the control of their\ndata. And this promise is not complete with a way to export the data to use it\nsomewhere else.  The Cozy Stack will offer an export button that gives a tarball to the user with\nthe full data. She can then import it on another instance for example. It should\nalso be possible to use the data outside of Cozy. So, the format for the tarball\nshould be as simple as possible and be documented. Of course, when it s\npossible, we will use open formats.", 
            "title": "Import and export"
        }, 
        {
            "location": "/cozy-stack/architecture/#how-to-contribute", 
            "text": "Cozy s DNA is fundamentally Open Source and we want our community to thrive.\nHaving contributions (code, design, translations) is important for us and we\nwill try to create the favorable conditions to support it.", 
            "title": "How to contribute?"
        }, 
        {
            "location": "/cozy-stack/architecture/#adding-a-new-konnector", 
            "text": "Adding a konnector is easy for someone who knows JavaScript. The repository has\nalready a lot of pull requests by external contributors. The wiki has\ndocumentation to explain the first steps of creating a new konnector. 3 active\ncontributors have been promoted to the maintainers team and can merge the pull\nrequests. We have done workshops to help new developers code their first\nkonnector and we will keep doing it.", 
            "title": "Adding a new konnector"
        }, 
        {
            "location": "/cozy-stack/architecture/#creating-a-new-application", 
            "text": "One of the goals of the new architecture is to make it easier for developers to\nwrite new apps. It means having a good documentation, but also some devtools to\nhelp:   The  cozy  executable will have a command to setup a new project.  The devtools on the cozy interface will give documentation about the doctypes,\n  help explore the Rest API, and check if the permissions are OK.  cozy-ui  will make it easy to reuse some widgets and offer an application\n  with a style coherent to the cozy identity.  Some docTypes with heavy logic will be available as JS classes to be reused in\n  the apps.", 
            "title": "Creating a new application"
        }, 
        {
            "location": "/cozy-stack/architecture/#reporting-a-bug-or-suggesting-a-new-feature", 
            "text": "We are listening to our users. The forum is here to discuss on many subjects,\nincluding how the applications are used. The issues on github are a good place\nfor bug tracking.", 
            "title": "Reporting a bug or suggesting a new feature"
        }, 
        {
            "location": "/cozy-stack/architecture/#translating-to-a-new-language", 
            "text": "We will keep having internationalization for our applications and the\ntranslations are maintained on transifex by the community. Translating to a new\nlanguage, or reviewing an existing one, is really appreciated.", 
            "title": "Translating to a new language"
        }, 
        {
            "location": "/cozy-stack/architecture/#faq", 
            "text": "Does the current konnectors in nodejs will be lost?   No, they won t. The business logic to scrap data from the many sources will be\nkept and they will be adapted to fit in this new architecture. It is explained\nhow we will do that  here .   So, it s not possible to have a custom application with a server part, like\nthe lounge IRC client?   We want to support this use case, just not on the short term. It s not clear how\nwe can do that (while not weakening the security). One idea is to run the\napplications in a different server, or maybe in docker.   How to install and update cozy?   The Cozy Stack will have no auto-update mechanism. For installing and updating\nit, you can use the classical ways:   Using a package manager, like apt for debian   ubuntu.  Using an official image for Raspberry Pi (and other embedded platforms).  Using the image and services of an hosting company.  Or compiling and installing it manually if you are really brave ;-)    How to add a cozy instance to a farm?    Choose a (sub-)domain and configure the DNS for this (sub-)domain.  Configure the reverse-proxy to accept this (sub-)domain.  Use the  cozy  executable to configure the cozy stack.    How to migrate from the nodejs cozy to this new architecture for cozy?    Export the data from the nodejs cozy (we need to add a button in the web\n   interface for that in the coming months).  Install the new cozy.  Import the data.   Please note that we don t support a continuous replication method that will\nenable to use both the nodejs and the new architecture at the same time. It\nlooks too complicated for a temporary thing.   How to backup the data?   There are 2 sensitive places with data:   In CouchDB.  on the place used for the Virtual File System (a directory on the local\n  filesystem, or in Swift).   You can use the tools of your choice to backup these 2 locations. The good old\nrsync works fine (CouchDB files are append-only, except when compaction happens,\nso it s friendly to rsync).  It s highly recommended to have an automated backup, but sometimes it can be\nuseful to have a way to backup manually the data. The  export data  button in\nthe web interface give a tarball that can be used to transfer your data from one\ninstance to another, and so, it can be used as a backup.   Aren t microservices better for scaling?   Yes, it s often easier to scale by separating concerns, and microservices is a\nway to achieve that. But, it has some serious downsides:   It takes more memory and it s probably a no-go for Raspberry Pi.  It s more complicated for a developper to install the whole stack before\n  coding its application.  It s harder to deploy in production.   For the scalability, we can also deploy some specialized instances of the Cozy\nStack. For example, we can have some Cozy Stack processes dedicated for\nreal-time. Even, if they have all the code, we can route only the relevant\ntrafic from the load-balancer.   What are the frameworks and tools used for the front-end apps?   If you want to develop your own app, you can use the framework and the tools you\nlike, nothing is mandatory. For the official apps, we will want to move to:   es2017 (but converting the existing coffeescript code will take time)  npm scripts and webpack  preact   JSX.   More about this here   When will this new architecture be available?   The roadmap for Cozy v3 has been explained on our blog:\nhttps://blog.cozycloud.cc/post/2016/11/21/On-the-road-to-Cozy-version-3", 
            "title": "FAQ"
        }, 
        {
            "location": "/cozy-stack/security/", 
            "text": "Table of contents\n\n\nSecurity\n\n\nChecklist\n\n\n\n\nStrong security is centered on the user\n\n\nDefense in depth is still worthy\n\n\nHave a strict control of all the accesses to the Cozy\n\n\nProtect client-side apps by default\n\n\nDon\nt trust inputs, always sanitize them\n\n\nEncryption is not the solution to all the problems, but it helps\n\n\nUse standards (https, OAuth2)\n\n\nHave a reliable way to deploy, with sane defaults\n\n\nNo one is perfect, code must be reviewed\n\n\nBe open to external contributors\n\n\n\n\nRationale\n\n\nStrong security is centered on the user\n\n\nFor systems well designed, the user is often the weakest link in the security\nchain. Engineers have a tendancy to overestimate the technical risks and\nunderestimate the human interactions. It doesn\nt mean that we can avoid\ntechnical measures. But it\ns very important to take in account the possible\nbehaviour of the user. That means that adding a text to explain him/her the\nconsequences of a click on a button can increase the security a lot much than\nforcing him/her to do things. For example, forcing users to change regulary\ntheir password makes them choose passwords that are a lot weaker (but easier for\nthem to remember).\n\n\n\n\nDefense in depth is still worthy\n\n\nAlso known as layered defense, defense in depth is a security principle where\nsingle points of complete compromise are eliminated or mitigated by the\nincorporation of a series or multiple layers of security safeguards and\nrisk-mitigation countermeasures. Have diverse defensive strategies, so that if\none layer of defense turns out to be inadequate, another layer of defense will\nhopefully prevent a full breach.\n\n\nHave a strict control of all the accesses to the Cozy\n\n\nAll the requests to the cozy stack have a strict access control. It is based on\nseveral informations:\n\n\n\n\nIs the user connected?\n\n\nWhat is the application that makes this request?\n\n\nWhat are the permissions for this application?\n\n\nWhich grant is used, in particular for applications with public pages?\n\n\nWhat are the permissions for this grant?\n\n\n\n\nMore informations \nhere\n.\n\n\nProtect client-side apps by default\n\n\nThis is mostly applying the state of the art:\n\n\n\n\nUsing HTTPS, with HSTS.\n\n\nUsing secure, httpOnly,\n  \nsameSite\n\n  cookies to avoid cookies theft or misuse.\n\n\nUsing a Content Security Policy (CSP).\n\n\nUsing X-frame-options http header to protect against click-jacking.\n\n\n\n\nBut we will use a CSP very restrictive by default (no access to other web\ndomains for example).\n\n\nDon\nt trust inputs, always sanitize them\n\n\nIf we take\n\nthe OWASP top 10 vulnerabilities\n,\nwe can see that a lot of them are related to trusting inputs. It starts with the\nfirst one, injections, but it goes also to XSS and unvalidated forwards (in\nOAuth2 notably). Always sanitizing inputs is a good pratice that improves\nsecurity, but has also some nice effects like helping developers discover hidden\nbugs.\n\n\nEncryption is not the solution to all the problems, but it helps\n\n\nSome data are encrypted before being saved in CouchDB (passwords for the\naccounts for example). Encrypting everything has some downsides:\n\n\n\n\nIt\ns not possible to index encryped documents or do computations on the\n  encrypted fields in reasonable time\n  (\nhomomorphic encryption\n\n  is still an open subject).\n\n\nHaving more encrypted data can globally weaken the encryption, if it\ns not\n  handled properly.\n\n\nIf the encryption key is lost or a bug happen, the data is lost with no way to\n  recover them.\n\n\n\n\nSo, we are more confortable to encrypt only some fields. And later, when we will\nhave more experience and feedbacks from the user, extend the encryption to more\nfields.\n\n\nWe are also working with \nSMIS\n, a research lab,\nto find a way to securely store and backup the encryption keys.\n\n\nUse standards (https, OAuth2)\n\n\nStandards like https and OAuth2 had a lot of eyes to look at them, and are\ntherefore more robust. Reinventing the wheel can be valuable for some things.\nBut for security, the cost is very high and only some very particular\nconstraints can justify such an high cost. Cozy don\nt have these constraints, so\nwe will stick to the standards.\n\n\nHave a reliable way to deploy, with sane defaults\n\n\nIt\ns important that deploying a cozy is well documented, doesn\nt require too\nmany steps and can be automatized. An error on the installation can have\ndramatic effects, like the database being leaked on internet. So, we need to\nreally take care of the devops experience. In particular, having sane defaults\nfor the configuration will help to minimize the number of things he/she has to\ndo, and such the number of places where he/she can make faux pas.\n\n\nNo one is perfect, code must be reviewed\n\n\nNo code is directly pushed to the master branch in git. It has to be reviewed by\nat least one member of the core team (ideally the whole team), and this person\ncan\nt be the author of the change. Even the best developers can make mistakes,\nand we don\nt pretend to be them. Our force is to work as team.\n\n\nBe open to external contributors\n\n\nOur code is Open Source, external contributors can review it. If they (you?)\nfind a weakness, please contact us by sending an email to security AT\ncozycloud.cc. This is a mailing-list specially setup for responsible disclosure\nof security weaknesses in Cozy. We will respond in less than 72 hours.\n\n\nWhen a security flaw is found, the process is the following:\n\n\n\n\nMake a pull-request to fix (on our private git instance) and test it.\n\n\nDeploy the fix on cozycloud.cc\n\n\nPublish a new version, announce it on\n  \nthe forum\n as\n  a security update and on the mailing-lists.\n\n\n15 days later, add the details on the forum.", 
            "title": "Security"
        }, 
        {
            "location": "/cozy-stack/security/#security", 
            "text": "", 
            "title": "Security"
        }, 
        {
            "location": "/cozy-stack/security/#checklist", 
            "text": "Strong security is centered on the user  Defense in depth is still worthy  Have a strict control of all the accesses to the Cozy  Protect client-side apps by default  Don t trust inputs, always sanitize them  Encryption is not the solution to all the problems, but it helps  Use standards (https, OAuth2)  Have a reliable way to deploy, with sane defaults  No one is perfect, code must be reviewed  Be open to external contributors", 
            "title": "Checklist"
        }, 
        {
            "location": "/cozy-stack/security/#rationale", 
            "text": "", 
            "title": "Rationale"
        }, 
        {
            "location": "/cozy-stack/security/#strong-security-is-centered-on-the-user", 
            "text": "For systems well designed, the user is often the weakest link in the security\nchain. Engineers have a tendancy to overestimate the technical risks and\nunderestimate the human interactions. It doesn t mean that we can avoid\ntechnical measures. But it s very important to take in account the possible\nbehaviour of the user. That means that adding a text to explain him/her the\nconsequences of a click on a button can increase the security a lot much than\nforcing him/her to do things. For example, forcing users to change regulary\ntheir password makes them choose passwords that are a lot weaker (but easier for\nthem to remember).", 
            "title": "Strong security is centered on the user"
        }, 
        {
            "location": "/cozy-stack/security/#defense-in-depth-is-still-worthy", 
            "text": "Also known as layered defense, defense in depth is a security principle where\nsingle points of complete compromise are eliminated or mitigated by the\nincorporation of a series or multiple layers of security safeguards and\nrisk-mitigation countermeasures. Have diverse defensive strategies, so that if\none layer of defense turns out to be inadequate, another layer of defense will\nhopefully prevent a full breach.", 
            "title": "Defense in depth is still worthy"
        }, 
        {
            "location": "/cozy-stack/security/#have-a-strict-control-of-all-the-accesses-to-the-cozy", 
            "text": "All the requests to the cozy stack have a strict access control. It is based on\nseveral informations:   Is the user connected?  What is the application that makes this request?  What are the permissions for this application?  Which grant is used, in particular for applications with public pages?  What are the permissions for this grant?   More informations  here .", 
            "title": "Have a strict control of all the accesses to the Cozy"
        }, 
        {
            "location": "/cozy-stack/security/#protect-client-side-apps-by-default", 
            "text": "This is mostly applying the state of the art:   Using HTTPS, with HSTS.  Using secure, httpOnly,\n   sameSite \n  cookies to avoid cookies theft or misuse.  Using a Content Security Policy (CSP).  Using X-frame-options http header to protect against click-jacking.   But we will use a CSP very restrictive by default (no access to other web\ndomains for example).", 
            "title": "Protect client-side apps by default"
        }, 
        {
            "location": "/cozy-stack/security/#dont-trust-inputs-always-sanitize-them", 
            "text": "If we take the OWASP top 10 vulnerabilities ,\nwe can see that a lot of them are related to trusting inputs. It starts with the\nfirst one, injections, but it goes also to XSS and unvalidated forwards (in\nOAuth2 notably). Always sanitizing inputs is a good pratice that improves\nsecurity, but has also some nice effects like helping developers discover hidden\nbugs.", 
            "title": "Don't trust inputs, always sanitize them"
        }, 
        {
            "location": "/cozy-stack/security/#encryption-is-not-the-solution-to-all-the-problems-but-it-helps", 
            "text": "Some data are encrypted before being saved in CouchDB (passwords for the\naccounts for example). Encrypting everything has some downsides:   It s not possible to index encryped documents or do computations on the\n  encrypted fields in reasonable time\n  ( homomorphic encryption \n  is still an open subject).  Having more encrypted data can globally weaken the encryption, if it s not\n  handled properly.  If the encryption key is lost or a bug happen, the data is lost with no way to\n  recover them.   So, we are more confortable to encrypt only some fields. And later, when we will\nhave more experience and feedbacks from the user, extend the encryption to more\nfields.  We are also working with  SMIS , a research lab,\nto find a way to securely store and backup the encryption keys.", 
            "title": "Encryption is not the solution to all the problems, but it helps"
        }, 
        {
            "location": "/cozy-stack/security/#use-standards-https-oauth2", 
            "text": "Standards like https and OAuth2 had a lot of eyes to look at them, and are\ntherefore more robust. Reinventing the wheel can be valuable for some things.\nBut for security, the cost is very high and only some very particular\nconstraints can justify such an high cost. Cozy don t have these constraints, so\nwe will stick to the standards.", 
            "title": "Use standards (https, OAuth2)"
        }, 
        {
            "location": "/cozy-stack/security/#have-a-reliable-way-to-deploy-with-sane-defaults", 
            "text": "It s important that deploying a cozy is well documented, doesn t require too\nmany steps and can be automatized. An error on the installation can have\ndramatic effects, like the database being leaked on internet. So, we need to\nreally take care of the devops experience. In particular, having sane defaults\nfor the configuration will help to minimize the number of things he/she has to\ndo, and such the number of places where he/she can make faux pas.", 
            "title": "Have a reliable way to deploy, with sane defaults"
        }, 
        {
            "location": "/cozy-stack/security/#no-one-is-perfect-code-must-be-reviewed", 
            "text": "No code is directly pushed to the master branch in git. It has to be reviewed by\nat least one member of the core team (ideally the whole team), and this person\ncan t be the author of the change. Even the best developers can make mistakes,\nand we don t pretend to be them. Our force is to work as team.", 
            "title": "No one is perfect, code must be reviewed"
        }, 
        {
            "location": "/cozy-stack/security/#be-open-to-external-contributors", 
            "text": "Our code is Open Source, external contributors can review it. If they (you?)\nfind a weakness, please contact us by sending an email to security AT\ncozycloud.cc. This is a mailing-list specially setup for responsible disclosure\nof security weaknesses in Cozy. We will respond in less than 72 hours.  When a security flaw is found, the process is the following:   Make a pull-request to fix (on our private git instance) and test it.  Deploy the fix on cozycloud.cc  Publish a new version, announce it on\n   the forum  as\n  a security update and on the mailing-lists.  15 days later, add the details on the forum.", 
            "title": "Be open to external contributors"
        }, 
        {
            "location": "/cozy-stack/INSTALL/", 
            "text": "How to install Cozy-stack?\n\n\nDependencies\n\n\n\n\nA reverse-proxy (nginx, caddy, haproxy, etc.)\n\n\nA SMTP server\n\n\nCouchDB 2\n\n\nGit\n\n\nImage Magick\n\n\n\n\nTo install CouchDB 2 through Docker, take a look at our\n\nDocker specific documentation\n.\n\n\nNote:\n to generate thumbnails for heic/heif images, the version 7.0.7-22 of\nImage Magick is required.\n\n\nInstall for self-hosting\n\n\nWe have started to write documentation on how to install cozy on your own\nserver. \nThe guide\n is still work in\nprogress. So, don\nt hesitate to report issues with it. It will help us improve\nit.\n\n\nInstall for development / local tests\n\n\nInstall the binary\n\n\nYou can either download the binary or compile it.\n\n\nDownload an official release\n\n\nYou can download a \ncozy-stack\n binary from our official releases:\nhttps://github.com/cozy/cozy-stack/releases. It is a just a single executable\nfile (choose the one for your platform). Rename it to cozy-stack, give it the\nexecutable bit (\nchmod +x cozy-stack\n) and put it in your \n$PATH\n. \ncozy-stack\nversion\n should show you the version if every thing is right.\n\n\nUsing \ngo\n\n\nInstall go\n, version \n= 1.9. With \ngo\n\ninstalled and configured, you can run the following command:\n\n\ngo get -u github.com/cozy/cozy-stack\n\n\n\n\nThis will fetch the sources in \n$GOPATH/src/github.com/cozy/cozy-stack\n and\nbuild a binary in \n$GOPATH/bin/cozy-stack\n.\n\n\nDon\nt forget to add your \n$GOPATH\n to your \n$PATH\n in your \n*rc\n file so that\nyou can execute the binary without entering its full path.\n\n\nexport PATH=\n$(go env GOPATH)/bin:$PATH\n\n\n\n\nAdd an instance for testing\n\n\nYou can configure your \ncozy-stack\n using a configuration file or different\ncomand line arguments. Assuming CouchDB is installed and running on default port\n\n5984\n, you can start the server:\n\n\ncozy-stack serve\n\n\n\n\nAnd then create an instance for development:\n\n\ncozy-stack instances add --dev --apps drive,photos,settings --passphrase cozy \ncozy.tools:8080\n\n\n\n\nThe cozy-stack server listens on http://cozy.tools:8080/ by default. See\n\ncozy-stack --help\n for more informations.\n\n\nThe above command will create an instance on http://cozy.tools:8080/ with the\npassphrase \ncozy\n.\n\n\nMake sure the full stack is up with:\n\n\ncurl -H 'Accept: application/json' 'http://cozy.tools:8080/status/'\n\n\n\n\nYou can then remove your test instance:\n\n\ncozy-stack instances rm cozy.tools:8080", 
            "title": "Install the cozy-stack"
        }, 
        {
            "location": "/cozy-stack/INSTALL/#how-to-install-cozy-stack", 
            "text": "", 
            "title": "How to install Cozy-stack?"
        }, 
        {
            "location": "/cozy-stack/INSTALL/#dependencies", 
            "text": "A reverse-proxy (nginx, caddy, haproxy, etc.)  A SMTP server  CouchDB 2  Git  Image Magick   To install CouchDB 2 through Docker, take a look at our Docker specific documentation .  Note:  to generate thumbnails for heic/heif images, the version 7.0.7-22 of\nImage Magick is required.", 
            "title": "Dependencies"
        }, 
        {
            "location": "/cozy-stack/INSTALL/#install-for-self-hosting", 
            "text": "We have started to write documentation on how to install cozy on your own\nserver.  The guide  is still work in\nprogress. So, don t hesitate to report issues with it. It will help us improve\nit.", 
            "title": "Install for self-hosting"
        }, 
        {
            "location": "/cozy-stack/INSTALL/#install-for-development-local-tests", 
            "text": "", 
            "title": "Install for development / local tests"
        }, 
        {
            "location": "/cozy-stack/INSTALL/#install-the-binary", 
            "text": "You can either download the binary or compile it.", 
            "title": "Install the binary"
        }, 
        {
            "location": "/cozy-stack/INSTALL/#download-an-official-release", 
            "text": "You can download a  cozy-stack  binary from our official releases:\nhttps://github.com/cozy/cozy-stack/releases. It is a just a single executable\nfile (choose the one for your platform). Rename it to cozy-stack, give it the\nexecutable bit ( chmod +x cozy-stack ) and put it in your  $PATH .  cozy-stack\nversion  should show you the version if every thing is right.", 
            "title": "Download an official release"
        }, 
        {
            "location": "/cozy-stack/INSTALL/#using-go", 
            "text": "Install go , version  = 1.9. With  go \ninstalled and configured, you can run the following command:  go get -u github.com/cozy/cozy-stack  This will fetch the sources in  $GOPATH/src/github.com/cozy/cozy-stack  and\nbuild a binary in  $GOPATH/bin/cozy-stack .  Don t forget to add your  $GOPATH  to your  $PATH  in your  *rc  file so that\nyou can execute the binary without entering its full path.  export PATH= $(go env GOPATH)/bin:$PATH", 
            "title": "Using go"
        }, 
        {
            "location": "/cozy-stack/INSTALL/#add-an-instance-for-testing", 
            "text": "You can configure your  cozy-stack  using a configuration file or different\ncomand line arguments. Assuming CouchDB is installed and running on default port 5984 , you can start the server:  cozy-stack serve  And then create an instance for development:  cozy-stack instances add --dev --apps drive,photos,settings --passphrase cozy  cozy.tools:8080  The cozy-stack server listens on http://cozy.tools:8080/ by default. See cozy-stack --help  for more informations.  The above command will create an instance on http://cozy.tools:8080/ with the\npassphrase  cozy .  Make sure the full stack is up with:  curl -H 'Accept: application/json' 'http://cozy.tools:8080/status/'  You can then remove your test instance:  cozy-stack instances rm cozy.tools:8080", 
            "title": "Add an instance for testing"
        }, 
        {
            "location": "/cozy-stack/cli/cozy-stack/", 
            "text": "cozy-stack\n\n\ncozy-stack is the main command\n\n\nSynopsis\n\n\nCozy is a platform that brings all your web services in the same private space.\nWith it, your web apps and your devices can share data easily, providing you\nwith a new experience. You can install Cozy on your own hardware where no one\nprofiles you.\n\n\ncozy-stack [flags]\n\n\n\n\nOptions\n\n\n      --admin-host string   administration server host (default \nlocalhost\n)\n      --admin-port int      administration server port (default 6060)\n      --client-use-https    if set the client will use https to communicate with the server\n  -c, --config string       configuration file (default \n$HOME/.cozy.yaml\n)\n  -h, --help                help for cozy-stack\n      --host string         server host (default \nlocalhost\n)\n  -p, --port int            server port (default 8080)\n\n\n\n\nSEE ALSO\n\n\n\n\ncozy-stack apps\n  - Interact with the applications\n\n\ncozy-stack bug\n    - start a bug report\n\n\ncozy-stack completion\n  - Output shell completion code for the specified shell\n\n\ncozy-stack config\n  - Show and manage configuration elements\n\n\ncozy-stack doc\n    - Print the documentation\n\n\ncozy-stack files\n    - Interact with the cozy filesystem\n\n\ncozy-stack fixer\n    - A set of tools to fix issues or migrate content for retro-compatibility.\n\n\ncozy-stack instances\n    - Manage instances of a stack\n\n\ncozy-stack konnectors\n  - Interact with the konnectors\n\n\ncozy-stack serve\n    - Starts the stack and listens for HTTP calls\n\n\ncozy-stack settings\n  - Display and update settings\n\n\ncozy-stack status\n  - Check if the HTTP server is running\n\n\ncozy-stack triggers\n  - Interact with the triggers\n\n\ncozy-stack version\n    - Print the version number", 
            "title": "Manpages of the command-line tool"
        }, 
        {
            "location": "/cozy-stack/cli/cozy-stack/#cozy-stack", 
            "text": "cozy-stack is the main command", 
            "title": "cozy-stack"
        }, 
        {
            "location": "/cozy-stack/cli/cozy-stack/#synopsis", 
            "text": "Cozy is a platform that brings all your web services in the same private space.\nWith it, your web apps and your devices can share data easily, providing you\nwith a new experience. You can install Cozy on your own hardware where no one\nprofiles you.  cozy-stack [flags]", 
            "title": "Synopsis"
        }, 
        {
            "location": "/cozy-stack/cli/cozy-stack/#options", 
            "text": "--admin-host string   administration server host (default  localhost )\n      --admin-port int      administration server port (default 6060)\n      --client-use-https    if set the client will use https to communicate with the server\n  -c, --config string       configuration file (default  $HOME/.cozy.yaml )\n  -h, --help                help for cozy-stack\n      --host string         server host (default  localhost )\n  -p, --port int            server port (default 8080)", 
            "title": "Options"
        }, 
        {
            "location": "/cozy-stack/cli/cozy-stack/#see-also", 
            "text": "cozy-stack apps   - Interact with the applications  cozy-stack bug     - start a bug report  cozy-stack completion   - Output shell completion code for the specified shell  cozy-stack config   - Show and manage configuration elements  cozy-stack doc     - Print the documentation  cozy-stack files     - Interact with the cozy filesystem  cozy-stack fixer     - A set of tools to fix issues or migrate content for retro-compatibility.  cozy-stack instances     - Manage instances of a stack  cozy-stack konnectors   - Interact with the konnectors  cozy-stack serve     - Starts the stack and listens for HTTP calls  cozy-stack settings   - Display and update settings  cozy-stack status   - Check if the HTTP server is running  cozy-stack triggers   - Interact with the triggers  cozy-stack version     - Print the version number", 
            "title": "SEE ALSO"
        }, 
        {
            "location": "/cozy-stack/config/", 
            "text": "Table of contents\n\n\nConfiguration\n\n\nMain Configuration file\n\n\nYou can configure your \ncozy-stack\n using a configuration file. This file\nshould be named \ncozy.yaml\n or \ncozy.json\n depending on the format of your\nchosing, and should be present in one of these directories (ordered by\npriority):\n\n\n\n\n./.cozy\n\n\n$HOME/.cozy\n\n\n/etc/cozy\n\n\n\n\nThe path of the configuration file can also be define from an absolute path\ngiven by the \n--config\n (or \n-c\n) flag of the \ncozy-stack command\n.\n\n\nTemplating and Environment Variables\n\n\nIt is possible to pass environnment variable to this configuration using the\n\ntemplate language of golang\n,\ndelimited by \n{{\n and \n}}\n.\n\n\nThe environment variables are available in the \n.Env\n variable. For instance\nthe text \n{{.Env.COUCHDB_PASSPHRASE }}\n will be replaced by the value of the\n\nCOUCHDB_PASSPHRASE\n environment variable. The template is evaluated at\nstartup of the stack.\n\n\nValues and Example\n\n\nTo see the detail of the available parameters available, you can see an\nexample of configuration in the \ncozy.example.yaml\n file\nat the root of this repository.\n\n\nThis file contains all the parameters and fields that can be used to configure the stack with some example values.\n\n\nSome fields can be overriden by the flags of the \ncozy-stack serve command\n.\n\n\nAdministration secret\n\n\nTo access to the administration API (the \n/admin/*\n routes), a secret\npassphrase should be stored in a \ncozy-admin-passphrase\n. This file should be\nin one of the configuration directories, along with the main config file.\n\n\nThe passphrase is stored in a salted-hashed representation using scrypt. To\ngenerate this file, you can use the \ncozy-stack config passwd [config\ndirectory]\n command. This command will ask you for a passphrase and will\ncreate the \ncozy-admin-passphrase\n in the specified directory.\n\n\nYou can use the \nCOZY_ADMIN_PASSWORD\n env variable if you do not want to type\nthe passphrase each time you call \ncozy-stack\n.\n\n\nExample\n\n\ncozy-stack config passwd ~/.cozy\n# Hashed passphrase outputed in ~/.cozy/cozy-admin-passphrase\ncat ~/.cozy/cozy-admin-passphrase\n# scrypt$16384$8$1$936bd62faf633b5f946f653c21161a9b$4e0d11dfa5fc1676ed329938b11a6584d30e603e0d06b8a63a99e8cec392d682\n\n\n\n\nHooks\n\n\nCozy-stack can run scripts on some events to customize it. The scripts must be\nin the hooks directory defined in the config, have a predefined name, and be\nexecutable. Then, they should be fired automatically. Let\ns the available\nhooks.\n\n\nThe \npre-add-instance\n hook is run just before creating an instance. It can\nprevent the command from running by exiting with non-zero status. It can be\nused to check the domain for example. It is called with the following\nparameter:\n\n\n\n\nthe domain of the instance that will be created.\n\n\n\n\nThe \npost-add-instance\n hook is run just after an instance has been created.\ninstalled. It can be used to setup DNS for this instance for example. It is\ncalled with the following parameter:\n\n\n\n\nthe domain of the instance that has been created.\n\n\n\n\nThe \npre-remove-instance\n hook is run just before destroying an instance. It\ncan prevent the command from running by exiting with non-zero status. It can\nbe used to make a backup of the instance before destroying it. It is called\nwith the following parameter:\n\n\n\n\nthe domain of the instance that will be destroyed.\n\n\n\n\nThe \npost-remove-instance\n hook is run just after an instance has been\ndestroyed. It can be used to do some cleanup. It is called with the following\nparameter:\n\n\n\n\nthe domain of the instance that has been destroyed.\n\n\n\n\nThe \npre-install-app\n hook is run just before installing an application, and\ncan prevent the command from running by exiting with non-zero status. It is\ncalled with the following parameters:\n\n\n\n\nthe instance on which the application will be installed\n\n\nthe application name that will be installed.\n\n\n\n\nThe \npost-install-app\n hook is run just after an application has been\ninstalled. It can be used for logging, notification, statistics, etc. It\ns\nalso a good place to add a vhost for an application in the reverse-proxy\nconfiguration, with a TLS certificate. It is called with the following\nparameters:\n\n\n\n\nthe instance on which the application has been installed\n\n\nthe application name that has been installed.\n\n\n\n\nThe \npre-uninstall-app\n hook is run just before uninstalling an application,\nand can prevent the command from running by exiting with non-zero status. It\nis called with the following parameters:\n\n\n\n\nthe instance on which the application will be uninstalled\n\n\nthe application name that will be uninstalled.\n\n\n\n\nThe \npost-uninstall-app\n hook is run just after an application has been\nuninstalled. It can be used for cleaning the configuration of the reverse-\nproxy for example. It is called with the following parameters:\n\n\n\n\nthe instance on which the application has been uninstalled\n\n\nthe application name that has been uninstalled.", 
            "title": "Configuration file"
        }, 
        {
            "location": "/cozy-stack/config/#configuration", 
            "text": "", 
            "title": "Configuration"
        }, 
        {
            "location": "/cozy-stack/config/#main-configuration-file", 
            "text": "You can configure your  cozy-stack  using a configuration file. This file\nshould be named  cozy.yaml  or  cozy.json  depending on the format of your\nchosing, and should be present in one of these directories (ordered by\npriority):   ./.cozy  $HOME/.cozy  /etc/cozy   The path of the configuration file can also be define from an absolute path\ngiven by the  --config  (or  -c ) flag of the  cozy-stack command .", 
            "title": "Main Configuration file"
        }, 
        {
            "location": "/cozy-stack/config/#templating-and-environment-variables", 
            "text": "It is possible to pass environnment variable to this configuration using the template language of golang ,\ndelimited by  {{  and  }} .  The environment variables are available in the  .Env  variable. For instance\nthe text  {{.Env.COUCHDB_PASSPHRASE }}  will be replaced by the value of the COUCHDB_PASSPHRASE  environment variable. The template is evaluated at\nstartup of the stack.", 
            "title": "Templating and Environment Variables"
        }, 
        {
            "location": "/cozy-stack/config/#values-and-example", 
            "text": "To see the detail of the available parameters available, you can see an\nexample of configuration in the  cozy.example.yaml  file\nat the root of this repository.  This file contains all the parameters and fields that can be used to configure the stack with some example values.  Some fields can be overriden by the flags of the  cozy-stack serve command .", 
            "title": "Values and Example"
        }, 
        {
            "location": "/cozy-stack/config/#administration-secret", 
            "text": "To access to the administration API (the  /admin/*  routes), a secret\npassphrase should be stored in a  cozy-admin-passphrase . This file should be\nin one of the configuration directories, along with the main config file.  The passphrase is stored in a salted-hashed representation using scrypt. To\ngenerate this file, you can use the  cozy-stack config passwd [config\ndirectory]  command. This command will ask you for a passphrase and will\ncreate the  cozy-admin-passphrase  in the specified directory.  You can use the  COZY_ADMIN_PASSWORD  env variable if you do not want to type\nthe passphrase each time you call  cozy-stack .", 
            "title": "Administration secret"
        }, 
        {
            "location": "/cozy-stack/config/#example", 
            "text": "cozy-stack config passwd ~/.cozy\n# Hashed passphrase outputed in ~/.cozy/cozy-admin-passphrase\ncat ~/.cozy/cozy-admin-passphrase\n# scrypt$16384$8$1$936bd62faf633b5f946f653c21161a9b$4e0d11dfa5fc1676ed329938b11a6584d30e603e0d06b8a63a99e8cec392d682", 
            "title": "Example"
        }, 
        {
            "location": "/cozy-stack/config/#hooks", 
            "text": "Cozy-stack can run scripts on some events to customize it. The scripts must be\nin the hooks directory defined in the config, have a predefined name, and be\nexecutable. Then, they should be fired automatically. Let s the available\nhooks.  The  pre-add-instance  hook is run just before creating an instance. It can\nprevent the command from running by exiting with non-zero status. It can be\nused to check the domain for example. It is called with the following\nparameter:   the domain of the instance that will be created.   The  post-add-instance  hook is run just after an instance has been created.\ninstalled. It can be used to setup DNS for this instance for example. It is\ncalled with the following parameter:   the domain of the instance that has been created.   The  pre-remove-instance  hook is run just before destroying an instance. It\ncan prevent the command from running by exiting with non-zero status. It can\nbe used to make a backup of the instance before destroying it. It is called\nwith the following parameter:   the domain of the instance that will be destroyed.   The  post-remove-instance  hook is run just after an instance has been\ndestroyed. It can be used to do some cleanup. It is called with the following\nparameter:   the domain of the instance that has been destroyed.   The  pre-install-app  hook is run just before installing an application, and\ncan prevent the command from running by exiting with non-zero status. It is\ncalled with the following parameters:   the instance on which the application will be installed  the application name that will be installed.   The  post-install-app  hook is run just after an application has been\ninstalled. It can be used for logging, notification, statistics, etc. It s\nalso a good place to add a vhost for an application in the reverse-proxy\nconfiguration, with a TLS certificate. It is called with the following\nparameters:   the instance on which the application has been installed  the application name that has been installed.   The  pre-uninstall-app  hook is run just before uninstalling an application,\nand can prevent the command from running by exiting with non-zero status. It\nis called with the following parameters:   the instance on which the application will be uninstalled  the application name that will be uninstalled.   The  post-uninstall-app  hook is run just after an application has been\nuninstalled. It can be used for cleaning the configuration of the reverse-\nproxy for example. It is called with the following parameters:   the instance on which the application has been uninstalled  the application name that has been uninstalled.", 
            "title": "Hooks"
        }, 
        {
            "location": "/cozy-stack/instance/", 
            "text": "Table of contents\n\n\nInstances\n\n\nTODO\n it\ns still a work in progress that needs to be completed.\n\n\nA single cozy-stack can manage several instances. Requests to different\ninstances are identified through the \nHost\n HTTP Header, any reverse proxy\nplaced in front of the cozy-stack should forward this header.\n\n\nTo simplify development, a \ndev\n instance name is used when no Host Header is\nprovided. This behaviour will be kept when the stack is started in dev mode but\nwill be blocked in production environment.\n\n\nExemple:\n\n\n\n\ncurl -H \"Host: bob.cozycloud.cc\" localhost:8080\n \u2192\n  \nlocalhost:5984/bob-cozycloud.cc\n\n\ncurl -H \"Host: alice.cozycloud.cc\" localhost:8080\n \u2192\n  \nlocalhost:5984/alice-cozycloud.cc\n\n\ncurl localhost:8080\n \u2192 \nlocalhost:5984/dev\n (in dev mode only)\n\n\n\n\nCreation\n\n\nAn instance is created on the command line:\n\n\n$ cozy-stack instances add \ndomain\n\n\n\n\nWith some possible additional options\n\n\n\n\n--locale \nlang\n\n\n--tz \ntimezone\n\n\n--email \nemail\n\n\n--apps \napp1,app2,app3\n\n\n\n\nIt registers the instance in a global couchdb database \nglobal/instances\n\n\n{\n  \nhostname\n: \nexample.cozycloud.cc\n,\n  \ndbprefix\n: \nexample-clozycloud-cc/\n,\n  \nfsroot\n: \n/var/lib/cozy/example.cozycloud.cc/fs/\n\n}\n\n\n\n\nand creates the proper databases ($PREFIX/$DOCTYPE) for these doctypes:\n\n\n\n\nio.cozy.apps\n\n\nio.cozy.files\n\n\nio.cozy.notifications\n\n\nio.cozy.settings\n\n\n\n\nThen, it creates the following indexes for these doctypes :\n\n\n\n\nTODO :\n complete this list of indexes\n\n\n\n\nThen, it creates some directories:\n\n\n\n\n/\n, with the id \nio.cozy.files.root-dir\n\n\n/Apps\n, with the id \nio.cozy.files.apps-dir\n\n\n/Documents\n, with the id \nio.cozy.files.documents-dir\n\n\n/Documents/Downloads\n, with the id \nio.cozy.files.downloads-dir\n\n\n/Documents/Pictures\n, with the id \nio.cozy.files.pictures-dir\n\n\n/Documents/Music\n, with the id \nio.cozy.files.music-dir\n\n\n/Documents/Videos\n, with the id \nio.cozy.files.videos-dir\n\n\n\n\nThe ids are forced to known values:\n even if these directories are moved or\nrenamed, they can still be found for the permissions.\n\n\nThe names are localized:\n If a locale is provided through the CLI, the\ndirectories will be created with names in this locale. Otherwise, theses\ndirectories will be created in english and renamed to localized name the first\ntime the locale is set (during onboarding).\n\n\nThen it creates the basic settings\n\n\n\n\nemail\n if an email was provided through the CLI\n\n\nlocale\n if a locale was provided through the CLI\n\n\ntz\n if a timezone was provided through the CLI\n\n\n\n\nSettings are created as named id in the \n$PREFIX/io.cozy.settings\n database.\nDuring onboarding, the fields will be prefilled with these value if they were\nprovided.\n\n\nFinally, applications from the \n--apps\n CLI option are installed.\n\n\n\n\nRenaming\n\n\nAn instance is renamed through the command line.\n\n\n$ cozy-stack instances rename \nolddomain\n \nnewdomain\n\n\n\n\nRenaming an instance only change the HostName in global/instances base.\n\n\n\n\nDestroying\n\n\nAn instance is destroyed through the command line. A confirmation is asked from\nthe CLI user unless the \nyes flag is passed\n\n\n$ cozy-stack instances destroy \ndomain", 
            "title": "Managing Instances"
        }, 
        {
            "location": "/cozy-stack/instance/#instances", 
            "text": "TODO  it s still a work in progress that needs to be completed.  A single cozy-stack can manage several instances. Requests to different\ninstances are identified through the  Host  HTTP Header, any reverse proxy\nplaced in front of the cozy-stack should forward this header.  To simplify development, a  dev  instance name is used when no Host Header is\nprovided. This behaviour will be kept when the stack is started in dev mode but\nwill be blocked in production environment.  Exemple:   curl -H \"Host: bob.cozycloud.cc\" localhost:8080  \u2192\n   localhost:5984/bob-cozycloud.cc  curl -H \"Host: alice.cozycloud.cc\" localhost:8080  \u2192\n   localhost:5984/alice-cozycloud.cc  curl localhost:8080  \u2192  localhost:5984/dev  (in dev mode only)", 
            "title": "Instances"
        }, 
        {
            "location": "/cozy-stack/instance/#creation", 
            "text": "An instance is created on the command line:  $ cozy-stack instances add  domain  With some possible additional options   --locale  lang  --tz  timezone  --email  email  --apps  app1,app2,app3   It registers the instance in a global couchdb database  global/instances  {\n   hostname :  example.cozycloud.cc ,\n   dbprefix :  example-clozycloud-cc/ ,\n   fsroot :  /var/lib/cozy/example.cozycloud.cc/fs/ \n}  and creates the proper databases ($PREFIX/$DOCTYPE) for these doctypes:   io.cozy.apps  io.cozy.files  io.cozy.notifications  io.cozy.settings   Then, it creates the following indexes for these doctypes :   TODO :  complete this list of indexes   Then, it creates some directories:   / , with the id  io.cozy.files.root-dir  /Apps , with the id  io.cozy.files.apps-dir  /Documents , with the id  io.cozy.files.documents-dir  /Documents/Downloads , with the id  io.cozy.files.downloads-dir  /Documents/Pictures , with the id  io.cozy.files.pictures-dir  /Documents/Music , with the id  io.cozy.files.music-dir  /Documents/Videos , with the id  io.cozy.files.videos-dir   The ids are forced to known values:  even if these directories are moved or\nrenamed, they can still be found for the permissions.  The names are localized:  If a locale is provided through the CLI, the\ndirectories will be created with names in this locale. Otherwise, theses\ndirectories will be created in english and renamed to localized name the first\ntime the locale is set (during onboarding).  Then it creates the basic settings   email  if an email was provided through the CLI  locale  if a locale was provided through the CLI  tz  if a timezone was provided through the CLI   Settings are created as named id in the  $PREFIX/io.cozy.settings  database.\nDuring onboarding, the fields will be prefilled with these value if they were\nprovided.  Finally, applications from the  --apps  CLI option are installed.", 
            "title": "Creation"
        }, 
        {
            "location": "/cozy-stack/instance/#renaming", 
            "text": "An instance is renamed through the command line.  $ cozy-stack instances rename  olddomain   newdomain  Renaming an instance only change the HostName in global/instances base.", 
            "title": "Renaming"
        }, 
        {
            "location": "/cozy-stack/instance/#destroying", 
            "text": "An instance is destroyed through the command line. A confirmation is asked from\nthe CLI user unless the  yes flag is passed  $ cozy-stack instances destroy  domain", 
            "title": "Destroying"
        }, 
        {
            "location": "/cozy-stack/onboarding/", 
            "text": "Table of contents\n\n\nOnboarding\n\n\nThis document explains the architecture and process allowing a cozy instance\nowner to register to its cozy instance.\n\n\nCompatibility with the current developments on cozy onboarding is a goal :\n\nThe following documents has been consulted for this proposal\n\n\nInstance creation\n\n\nCreating an instance is done through CLI or through the (future) partner farm\nmanager system. Some \nsettings\n can be pre-defined on instance creation.\n(\ndoc\n).\n\n\nThe CLI also allows to specify which source to use for \nonboarding\n and \nhome\n\napplications. The defaults will be hosted on \ngithub.com/cozy\n.\n\n\nAfter creation, an instance has a \nregisterToken\n generated randomly.\n\n\nOnboarding steps\n\n\nThis document and the cozy-stack are only concerned with login and passphrase\nregistering step which are important for security.\n\n\nAll other steps are handled by the \nonboarding\n application.\n\n\nThe \nonboarding\n application SHOULD therefore provide the following features\n\n\n\n\nWhen started with a \nregisterToken\n, allow the user to create a passphrase\n\n\nWhen started with a \ncontextToken\n\n  (\nsee auth doc\n) use it to retrieve instance\n  document.\n\n\nIf the instance document is complete \naccording to the \nonboarding\n app\n,\n    redirect to \nhome\n application.\n\n\nOtherwise, performs whatever steps it deems necessary to fill out the\n    instance (ask for user email, help set up \nmyaccounts\n accounts, say thank\n    you\n)\n\n\n\n\nThis makes cozy-stack simple and safer while allowing behaviour modification for\nseveral install types by picking the correct \nonboarding\n application / branch.\n\n\nThis makes it easier to add more onboarding steps and have them run on\nalready-installed cozy : On next login after onboarding application update, it\nwill ask the user.\n\n\nRedirections\n\n\nWhen an user attempts to access the root of its instance\n(\nhttps://example.cozycloud.cc\n) or an application\n(\nhttps://contacts.example.cozycloud.cc\n), and she is not logged-in, she is\nredirected :\n\n\n\n\nIf the instance has a \npassphrase\n set, to the \n/login\n page\n\n\nIf the instance has a \nregisterToken\n set, to the \nonboarding\n application.\n\n\n\n\nAfter login, the user is always redirected to the \nonboarding\n application. It\nis the \nonboarding\n application responsibility to check if registering is\ncomplete and reredirect to home.\n\n\nRoutes\n\n\nSee \nsettings\n.\n\n\nFlow Example\n\n\n\n\nThe server administrator Bob creates an instance through the CLI. He knows the\n  instance should be in french for an user named \nalice\n.\n\n\n\n\ncozy-stack instances add alice.example.com --locale fr\n\n https://alice.cozycloud.cc?registerToken=42456565213125454842\n\n\n\n\nThe instance is created\n\n\n{\n  \ndomain\n: \nalice.example.com\n,\n  \nlocale\n: \nfr\n\n}\n\n\n\n\n\n\nEve knows Alice just had an instance created, she goes to\n  \nhttps://alice.cozycloud.cc\n. There is no \nregisterToken\n, so she only see a\n  message (in french) along the lines of \nThis is the cozy for Alice Martin,\n  this register link is incorrect, if you are Alice Martin please ask your\n  sysadmin for a new link\n.\n\n\nAlice navigates to \nhttps://alice.cozycloud.cc?registerToken=42...42\n\n\nShe is redirected to the \nonboarding\n application\n\n\nThe \nonboarding\n application receive the registerToken. It is the default\n  onboarding application and therefore display the cozy cloud agreement and then\n  ask for a Password.\n\n\nThe \nonboarding\n application use its \nregisterToken\n to register the\n  passphrase. Registering the passphrase automatically log Alice in and redirect\n  her back to the \nonboarding\n app.\n\n\nAfterward, the \nonboarding\n app receive its token normally through the\n  \ndata-cozy-token\n body attribute, as described in\n  \nauth documentation\n. and can do whatever it needs to do :\n\n\nread from the instance document to prefill/bypass form fields\n\n\nadd more informations to the instance document.\n\n\ncreate \nio.cozy.accounts\n documents for external accounts.\n\n\nWhen the onboarding application is satisfied, Alice is redirected to the\n  \nhome\n application", 
            "title": "Onboarding"
        }, 
        {
            "location": "/cozy-stack/onboarding/#onboarding", 
            "text": "This document explains the architecture and process allowing a cozy instance\nowner to register to its cozy instance.  Compatibility with the current developments on cozy onboarding is a goal : The following documents has been consulted for this proposal", 
            "title": "Onboarding"
        }, 
        {
            "location": "/cozy-stack/onboarding/#instance-creation", 
            "text": "Creating an instance is done through CLI or through the (future) partner farm\nmanager system. Some  settings  can be pre-defined on instance creation.\n( doc ).  The CLI also allows to specify which source to use for  onboarding  and  home \napplications. The defaults will be hosted on  github.com/cozy .  After creation, an instance has a  registerToken  generated randomly.", 
            "title": "Instance creation"
        }, 
        {
            "location": "/cozy-stack/onboarding/#onboarding-steps", 
            "text": "This document and the cozy-stack are only concerned with login and passphrase\nregistering step which are important for security.  All other steps are handled by the  onboarding  application.  The  onboarding  application SHOULD therefore provide the following features   When started with a  registerToken , allow the user to create a passphrase  When started with a  contextToken \n  ( see auth doc ) use it to retrieve instance\n  document.  If the instance document is complete  according to the  onboarding  app ,\n    redirect to  home  application.  Otherwise, performs whatever steps it deems necessary to fill out the\n    instance (ask for user email, help set up  myaccounts  accounts, say thank\n    you )   This makes cozy-stack simple and safer while allowing behaviour modification for\nseveral install types by picking the correct  onboarding  application / branch.  This makes it easier to add more onboarding steps and have them run on\nalready-installed cozy : On next login after onboarding application update, it\nwill ask the user.", 
            "title": "Onboarding steps"
        }, 
        {
            "location": "/cozy-stack/onboarding/#redirections", 
            "text": "When an user attempts to access the root of its instance\n( https://example.cozycloud.cc ) or an application\n( https://contacts.example.cozycloud.cc ), and she is not logged-in, she is\nredirected :   If the instance has a  passphrase  set, to the  /login  page  If the instance has a  registerToken  set, to the  onboarding  application.   After login, the user is always redirected to the  onboarding  application. It\nis the  onboarding  application responsibility to check if registering is\ncomplete and reredirect to home.", 
            "title": "Redirections"
        }, 
        {
            "location": "/cozy-stack/onboarding/#routes", 
            "text": "See  settings .", 
            "title": "Routes"
        }, 
        {
            "location": "/cozy-stack/onboarding/#flow-example", 
            "text": "The server administrator Bob creates an instance through the CLI. He knows the\n  instance should be in french for an user named  alice .   cozy-stack instances add alice.example.com --locale fr  https://alice.cozycloud.cc?registerToken=42456565213125454842  The instance is created  {\n   domain :  alice.example.com ,\n   locale :  fr \n}   Eve knows Alice just had an instance created, she goes to\n   https://alice.cozycloud.cc . There is no  registerToken , so she only see a\n  message (in french) along the lines of  This is the cozy for Alice Martin,\n  this register link is incorrect, if you are Alice Martin please ask your\n  sysadmin for a new link .  Alice navigates to  https://alice.cozycloud.cc?registerToken=42...42  She is redirected to the  onboarding  application  The  onboarding  application receive the registerToken. It is the default\n  onboarding application and therefore display the cozy cloud agreement and then\n  ask for a Password.  The  onboarding  application use its  registerToken  to register the\n  passphrase. Registering the passphrase automatically log Alice in and redirect\n  her back to the  onboarding  app.  Afterward, the  onboarding  app receive its token normally through the\n   data-cozy-token  body attribute, as described in\n   auth documentation . and can do whatever it needs to do :  read from the instance document to prefill/bypass form fields  add more informations to the instance document.  create  io.cozy.accounts  documents for external accounts.  When the onboarding application is satisfied, Alice is redirected to the\n   home  application", 
            "title": "Flow Example"
        }, 
        {
            "location": "/cozy-stack/client-app-dev/", 
            "text": "Table of contents\n\n\n{% raw %}\n\n\nDevelop a client-side application\n\n\nUsing \ncozy-app-dev\n\n\nThis document describe a tool to run an environment in order to develop\nclient-side application on the cozy-stack.\n\n\nWe provide two different ways to run this environment, either manually where you\nhave to install part of the dependencies yourself or \nvia\n a Docker image in\nwhich all dependencies are packed.\n\n\nThis environment will provide a running instance a http server serving both a\nspecified directory of your application on \napp.cozy.tools:8080\n and the\n\ncozy-stack\n on \ncozy.tools:8080\n (you can change the hostname and port if you\nwant, see below).\n\n\nThe default passphrase will be \ncozy\n\n\nManually\n\n\nTo run the \nscripts/cozy-app-dev.sh\n directly on you system, you\nll need to\nfollowing dependencies:\n\n\n\n\ngo\n\n\ncurl\n\n\ngit\n\n\ncouchdb2\n: you need at least a running instance of CouchDB 2\n\n\n\n\nExamples:\n\n\n$ ./scripts/cozy-app-dev.sh -d ~/code/myapp\n\n\n\n\nIf your CouchDB 2 instance is not running on \nlocalhost:5984\n, you can specify\nanother host and port with the variable \nCOUCHDB_URL\n like so:\n\n\n$ COUCHDB_URL=http://couchdb.local:1234/ ./scripts/cozy-app-dev.sh -d ~/code/myapp\n\n\n\n\nYou can have more informations about the usage of this script with the following\ncommand:\n\n\n$ ./scripts/cozy-app-dev.sh -h\n\n\n\n\nWith Docker\n\n\nIf you do not want to install the required dependencies, we provide a Docker\nimage which encapsulates the dev script and all its dependencies.\n\n\nTo run a ephemeral instance, on the \n$HOME/myapp\n directory, use the following\ncommand (warning: all the data stored by your application in couchdb and the VFS\nwon\nt remain after):\n\n\n$ docker run --rm -it \\\n    -p 8080:8080 \\\n    -p 8025:8025 \\\n    -v \n$HOME/myapp\n:/data/cozy-app \\\n    cozy/cozy-app-dev\n\n\n\n\nTo keep your data even when stopping the container, run the following command:\n\n\n$ docker run --rm -it \\\n    -p 8080:8080 \\\n    -p 8025:8025 \\\n    -v \n$HOME/myapp\n:/data/cozy-app \\\n    -v \n$(pwd)/db\n:/usr/local/couchdb/data \\\n    -v \n$(pwd)/storage\n:/data/cozy-storage \\\n    cozy/cozy-app-dev\n\n\n\n\nYou can mount your yaml config file, to change the log level for example:\n\n\n$ docker run --rm -it \\\n    -p 8080:8080 \\\n    -p 8025:8025 \\\n    -v \n$HOME/myapp\n:/data/cozy-app \\\n    -v \n$HOME/cozy.yaml\n:/etc/cozy/cozy.yaml \\\n    cozy/cozy-app-dev\n\n\n\n\nA \nMailHog\n is running inside docker to\ncatch emails. You can view the emails sent by the stack in a web interface on\nhttp://cozy.tools:8025/\n\n\nYou can also expose the couchdb port (listening in the container on 5984) in\norder to access its admin page. For instance add \n-p 1234:5984\n to access to the\nadmin interface on \nhttp://localhost:1234/_utils\n.\n\n\nMake sure you application is built into \n$HOME/myapp\n (it should have an\n\nindex.html\n and a \nmanifest.webapp\n files), otherwise it will not work. As an\nexample, for the \nDrive application\n, it\nshould be \n$HOME/drive/build\n.\n\n\nIf you want to use several applications (for testing the intents for example),\nyou can mount several directories inside \n/data/cozy-app\n like this:\n\n\n$ docker run --rm -it \\\n    -p 8080:8080 \\\n    -p 8025:8025 \\\n    -v \n$HOME/appone\n:/data/cozy-app/appone \\\n    -v \n$HOME/apptwo\n:/data/cozy-app/apptwo \\\n    cozy/cozy-app-dev\n\n\n\n\nGood practices for your application\n\n\nWhen an application makes a request to the stack, like loading a list of\ncontacts, it sends two informations that will be used by the stack to allow or\ndeny the access:\n\n\n\n\nthe user session cookie\n\n\na token that identifies the application (only when the user is connected).\n\n\n\n\nSo, the application needs such a token. It also needs to know where to send the\nrequests for the stack (it can be guessed, but with the nested vs flat\nsubdomains structures, it\ns better to get the information from the stack). To do\nthat, when the application loads its HTML index file, the stack will parse it as\na template and will insert the relevant values.\n\n\n\n\n{{.Token}}\n will be replaced by the token for the application.\n\n\n{{.Domain}}\n will be replaced by the stack hostname.\n\n\n{{.Locale}}\n will be replaced by the locale for the instance.\n\n\n{{.AppName}}\n: will be replaced by the application name.\n\n\n{{.AppNamePrefix}}\n: will be replaced by the application name prefix.\n\n\n{{.AppEditor}}\n: will be replaced by the application\ns editor.\n\n\n{{.IconPath}}\n: will be replaced by the application\ns icon path.\n\n\n{{.CozyBar}}\n will be replaced by the JavaScript to inject the cozy-bar.\n\n\n{{.CozyClientJS}}\n will be replaced by the JavaScript to inject the\n  cozy-client-js.\n\n\n\n\nSo, the \nindex.html\n should probably looks like:\n\n\n!DOCTYPE html\n\n\nhtml lang=\n{{.Locale}}\n\n  \nhead\n\n    \nmeta charset=\nutf-8\n\n    \ntitle\nMy Awesome App for Cozy\n/title\n\n    \nlink rel=\nstylesheet\n src=\nmy-app.css\n\n    {{.CozyClientJS}}\n    {{.CozyBar}}\n    \nscript defer src=\nmy-app.js\n/script\n\n    \nmeta name=\nviewport\n content=\nwidth=device-width, initial-scale=1\n\n  \n/head\n\n  \nbody\n\n    \ndiv role=\napplication\n data-cozy-token=\n{{.Token}}\n data-cozy-stack=\n{{.Domain}}\n\n    \n/div\n\n  \n/body\n\n\n/html\n\n\n\n\nAnd \nmy-app.js\n:\n\n\nuse strict\n;\n\ndocument.addEventListener(\nDOMContentLoaded\n, () =\n {\n  const app = document.querySelector(\n[role=application]\n);\n  cozy.client.init({\n    cozyURL: \n//\n + app.dataset.cozyStack,\n    token: app.dataset.cozyToken\n  });\n});\n\n// ...\n\n\n\n\n{% endraw %}", 
            "title": "Develop a client-side app"
        }, 
        {
            "location": "/cozy-stack/client-app-dev/#develop-a-client-side-application", 
            "text": "", 
            "title": "Develop a client-side application"
        }, 
        {
            "location": "/cozy-stack/client-app-dev/#using-cozy-app-dev", 
            "text": "This document describe a tool to run an environment in order to develop\nclient-side application on the cozy-stack.  We provide two different ways to run this environment, either manually where you\nhave to install part of the dependencies yourself or  via  a Docker image in\nwhich all dependencies are packed.  This environment will provide a running instance a http server serving both a\nspecified directory of your application on  app.cozy.tools:8080  and the cozy-stack  on  cozy.tools:8080  (you can change the hostname and port if you\nwant, see below).  The default passphrase will be  cozy", 
            "title": "Using cozy-app-dev"
        }, 
        {
            "location": "/cozy-stack/client-app-dev/#manually", 
            "text": "To run the  scripts/cozy-app-dev.sh  directly on you system, you ll need to\nfollowing dependencies:   go  curl  git  couchdb2 : you need at least a running instance of CouchDB 2   Examples:  $ ./scripts/cozy-app-dev.sh -d ~/code/myapp  If your CouchDB 2 instance is not running on  localhost:5984 , you can specify\nanother host and port with the variable  COUCHDB_URL  like so:  $ COUCHDB_URL=http://couchdb.local:1234/ ./scripts/cozy-app-dev.sh -d ~/code/myapp  You can have more informations about the usage of this script with the following\ncommand:  $ ./scripts/cozy-app-dev.sh -h", 
            "title": "Manually"
        }, 
        {
            "location": "/cozy-stack/client-app-dev/#with-docker", 
            "text": "If you do not want to install the required dependencies, we provide a Docker\nimage which encapsulates the dev script and all its dependencies.  To run a ephemeral instance, on the  $HOME/myapp  directory, use the following\ncommand (warning: all the data stored by your application in couchdb and the VFS\nwon t remain after):  $ docker run --rm -it \\\n    -p 8080:8080 \\\n    -p 8025:8025 \\\n    -v  $HOME/myapp :/data/cozy-app \\\n    cozy/cozy-app-dev  To keep your data even when stopping the container, run the following command:  $ docker run --rm -it \\\n    -p 8080:8080 \\\n    -p 8025:8025 \\\n    -v  $HOME/myapp :/data/cozy-app \\\n    -v  $(pwd)/db :/usr/local/couchdb/data \\\n    -v  $(pwd)/storage :/data/cozy-storage \\\n    cozy/cozy-app-dev  You can mount your yaml config file, to change the log level for example:  $ docker run --rm -it \\\n    -p 8080:8080 \\\n    -p 8025:8025 \\\n    -v  $HOME/myapp :/data/cozy-app \\\n    -v  $HOME/cozy.yaml :/etc/cozy/cozy.yaml \\\n    cozy/cozy-app-dev  A  MailHog  is running inside docker to\ncatch emails. You can view the emails sent by the stack in a web interface on\nhttp://cozy.tools:8025/  You can also expose the couchdb port (listening in the container on 5984) in\norder to access its admin page. For instance add  -p 1234:5984  to access to the\nadmin interface on  http://localhost:1234/_utils .  Make sure you application is built into  $HOME/myapp  (it should have an index.html  and a  manifest.webapp  files), otherwise it will not work. As an\nexample, for the  Drive application , it\nshould be  $HOME/drive/build .  If you want to use several applications (for testing the intents for example),\nyou can mount several directories inside  /data/cozy-app  like this:  $ docker run --rm -it \\\n    -p 8080:8080 \\\n    -p 8025:8025 \\\n    -v  $HOME/appone :/data/cozy-app/appone \\\n    -v  $HOME/apptwo :/data/cozy-app/apptwo \\\n    cozy/cozy-app-dev", 
            "title": "With Docker"
        }, 
        {
            "location": "/cozy-stack/client-app-dev/#good-practices-for-your-application", 
            "text": "When an application makes a request to the stack, like loading a list of\ncontacts, it sends two informations that will be used by the stack to allow or\ndeny the access:   the user session cookie  a token that identifies the application (only when the user is connected).   So, the application needs such a token. It also needs to know where to send the\nrequests for the stack (it can be guessed, but with the nested vs flat\nsubdomains structures, it s better to get the information from the stack). To do\nthat, when the application loads its HTML index file, the stack will parse it as\na template and will insert the relevant values.   {{.Token}}  will be replaced by the token for the application.  {{.Domain}}  will be replaced by the stack hostname.  {{.Locale}}  will be replaced by the locale for the instance.  {{.AppName}} : will be replaced by the application name.  {{.AppNamePrefix}} : will be replaced by the application name prefix.  {{.AppEditor}} : will be replaced by the application s editor.  {{.IconPath}} : will be replaced by the application s icon path.  {{.CozyBar}}  will be replaced by the JavaScript to inject the cozy-bar.  {{.CozyClientJS}}  will be replaced by the JavaScript to inject the\n  cozy-client-js.   So, the  index.html  should probably looks like:  !DOCTYPE html  html lang= {{.Locale}} \n   head \n     meta charset= utf-8 \n     title My Awesome App for Cozy /title \n     link rel= stylesheet  src= my-app.css \n    {{.CozyClientJS}}\n    {{.CozyBar}}\n     script defer src= my-app.js /script \n     meta name= viewport  content= width=device-width, initial-scale=1 \n   /head \n   body \n     div role= application  data-cozy-token= {{.Token}}  data-cozy-stack= {{.Domain}} \n     /div \n   /body  /html  And  my-app.js :  use strict ;\n\ndocument.addEventListener( DOMContentLoaded , () =  {\n  const app = document.querySelector( [role=application] );\n  cozy.client.init({\n    cozyURL:  //  + app.dataset.cozyStack,\n    token: app.dataset.cozyToken\n  });\n});\n\n// ...  {% endraw %}", 
            "title": "Good practices for your application"
        }, 
        {
            "location": "/cozy-stack/docker/", 
            "text": "Table of contents\n\n\nDocker\n\n\nThis page list various operations that can be automated \nvia\n Docker.\n\n\nRunning a CouchDB instance\n\n\nThis will run a new instance of CouchDB in \nsingle\n mode (no cluster) and in\n\nadmin-party-mode\n (no user). This command exposes couchdb on the port \n5984\n.\n\n\n$ docker run -d \\\n    --name cozy-stack-couch \\\n    -p 5984:5984 \\\n    -v $HOME/.cozy-stack-couch:/opt/couchdb/data \\\n    apache/couchdb:2.1\n$ curl -X PUT http://127.0.0.1:5984/{_users,_replicator,_global_changes}\n\n\n\n\nVerify your installation at: http://127.0.0.1:5984/_utils/#verifyinstall.\n\n\nBuilding a cozy-stack \nvia\n Docker\n\n\nWarning, this command will build a linux binary. Use\n\nGOOS\n and \nGOARCH\n to\nadapt to your own system.\n\n\n# From your cozy-stack developement folder\ndocker run -it --rm --name cozy-stack \\\n    -v $(pwd):/go/src/github.com/cozy/cozy-stack \\\n    -v $(pwd):/go/bin \\\n    golang:1.10 \\\n    go get -v github.com/cozy/cozy-stack\n\n\n\n\nPublishing a new cozy-app-dev image\n\n\n./scripts/build.sh docker-dev\ndocker push cozy/cozy-app-dev", 
            "title": "Running and building Docker images"
        }, 
        {
            "location": "/cozy-stack/docker/#docker", 
            "text": "This page list various operations that can be automated  via  Docker.", 
            "title": "Docker"
        }, 
        {
            "location": "/cozy-stack/docker/#running-a-couchdb-instance", 
            "text": "This will run a new instance of CouchDB in  single  mode (no cluster) and in admin-party-mode  (no user). This command exposes couchdb on the port  5984 .  $ docker run -d \\\n    --name cozy-stack-couch \\\n    -p 5984:5984 \\\n    -v $HOME/.cozy-stack-couch:/opt/couchdb/data \\\n    apache/couchdb:2.1\n$ curl -X PUT http://127.0.0.1:5984/{_users,_replicator,_global_changes}  Verify your installation at: http://127.0.0.1:5984/_utils/#verifyinstall.", 
            "title": "Running a CouchDB instance"
        }, 
        {
            "location": "/cozy-stack/docker/#building-a-cozy-stack-via-docker", 
            "text": "Warning, this command will build a linux binary. Use GOOS  and  GOARCH  to\nadapt to your own system.  # From your cozy-stack developement folder\ndocker run -it --rm --name cozy-stack \\\n    -v $(pwd):/go/src/github.com/cozy/cozy-stack \\\n    -v $(pwd):/go/bin \\\n    golang:1.10 \\\n    go get -v github.com/cozy/cozy-stack", 
            "title": "Building a cozy-stack via Docker"
        }, 
        {
            "location": "/cozy-stack/docker/#publishing-a-new-cozy-app-dev-image", 
            "text": "./scripts/build.sh docker-dev\ndocker push cozy/cozy-app-dev", 
            "title": "Publishing a new cozy-app-dev image"
        }, 
        {
            "location": "/cozy-stack/release/", 
            "text": "Table of contents\n\n\nBuilding a release\n\n\nTo build a release of cozy-stack, a \nbuild.sh\n script can automate the work. The\n\nrelease\n option of this script will generate a binary with a name containing\nthe version of the file, along with a SHA-256 sum of the binary.\n\n\nYou can use a \nlocal.env\n at the root of the repository to add your default\nvalues for environment variables.\n\n\nSee \n./scripts/build.sh --help\n for more informations.\n\n\nCOZY_ENV=development GOOS=linux GOARCH=amd64 ./scripts/build.sh release\n\n\n\n\nThe version string is deterministic and reflects entirely the state of the\nworking-directory from which the release is built from. It is generated using\nthe following format:\n\n\n    \nTAG\n[-\nNUMBER OF COMMITS AFTER TAG\n][-dirty][-dev]\n\n\n\n\nWhere:\n\n\n\n\nTAG\n: closest annotated tag of the current working directory. If no tag is\n  present, is uses the string \nv0\n. This is not allowed in a production release.\n\n\nNUMBER OF COMMITS AFTER TAG\n: number of commits after the closest tag if\n  the current working directory does not point exactly to a tag\n\n\ndirty\n: added if the working if the working-directory is not clean (contains\n  un-commited modifications). This is not allowed in production release.\n\n\ndev\n: added for a development mode release", 
            "title": "Build a release"
        }, 
        {
            "location": "/cozy-stack/release/#building-a-release", 
            "text": "To build a release of cozy-stack, a  build.sh  script can automate the work. The release  option of this script will generate a binary with a name containing\nthe version of the file, along with a SHA-256 sum of the binary.  You can use a  local.env  at the root of the repository to add your default\nvalues for environment variables.  See  ./scripts/build.sh --help  for more informations.  COZY_ENV=development GOOS=linux GOARCH=amd64 ./scripts/build.sh release  The version string is deterministic and reflects entirely the state of the\nworking-directory from which the release is built from. It is generated using\nthe following format:       TAG [- NUMBER OF COMMITS AFTER TAG ][-dirty][-dev]  Where:   TAG : closest annotated tag of the current working directory. If no tag is\n  present, is uses the string  v0 . This is not allowed in a production release.  NUMBER OF COMMITS AFTER TAG : number of commits after the closest tag if\n  the current working directory does not point exactly to a tag  dirty : added if the working if the working-directory is not clean (contains\n  un-commited modifications). This is not allowed in production release.  dev : added for a development mode release", 
            "title": "Building a release"
        }, 
        {
            "location": "/cozy-stack/CONTRIBUTING/", 
            "text": "How to contribute to the Cozy Stack?\n\n\nThank you for your interest in contributing to Cozy! There are many ways to\ncontribute, and we appreciate all of them.\n\n\nSecurity Issues\n\n\nIf you discover a security issue, please bring it to their attention right away!\nPlease \nDO NOT\n file a public issue, instead send your report privately to\nsecurity AT cozycloud DOT cc.\n\n\nSecurity reports are greatly appreciated and we will publicly thank you for it.\nWe currently do not offer a paid security bounty program, but are not ruling it\nout in the future.\n\n\nBug Reports\n\n\nWhile bugs are unfortunate, they\nre a reality in software. We can\nt fix what we\ndon\nt know about, so please report liberally. If you\nre not sure if something is\na bug or not, feel free to file a bug anyway.\n\n\nOpening an issue is as easy as following\n\nthis link\n and filling out the\nfields. Here are some things you can write about your bug:\n\n\n\n\nA short summary\n\n\nWhat did you try, step by step?\n\n\nWhat did you expect?\n\n\nWhat did happen instead?\n\n\nWhat is the version of the Cozy Stack?\n\n\n\n\nYou can also use the \ncozy-stack bug\n command to open\nthe form to report issue prefilled with some useful system informations.\n\n\nPull Requests\n\n\nWorkflow\n\n\nPull requests are the primary mechanism we use to change Cozy. GitHub itself has\nsome\n\ngreat documentation \n\non using the Pull Request feature. We use the \nfork and pull\n model described\nthere.\n\n\nStep 1: Fork\n\n\nFork the project on GitHub and\n\ncheck out your copy locally\n.\n\n\n$ go get -u github.com/cozy/cozy-stack\n$ cd $(go env GOPATH)/src/github.com/cozy/cozy-stack\n$ git remote add fork git://github.com/username/cozy-stack.git\n\n\n\n\nStep 2: Branch\n\n\nCreate a branch and start hacking:\n\n\n$ git checkout -b my-branch -t origin/master\n\n\n\n\nStep 3: Code\n\n\nWell, I think you know how to do that. Just be sure to follow the coding\nguidelines from the Go community (gofmt,\n\nEffective Go\n, comment the code,\netc.).\n\n\nWe are using \ngoimports\n\nto format code, and \ngometalinter\n\nto detect code smells.\n\n\nStep 4: Test\n\n\nDon\nt forget to add tests and be sure they are green:\n\n\n$ go test -v ./...\n\n\n\n\nIf you want to play with the modified cozy-stack (for example, testing it with\na webapp), you can build it locally and start it with this command:\n\n\n$ go build \n ./cozy-stack serve\n\n\n\n\nStep 5: Commit\n\n\nWriting\n\ngood commit messages\n\nis important. A commit message should describe what changed and why.\n\n\nStep 6: Rebase\n\n\nUse \ngit rebase\n (not \ngit merge\n) to sync your work from time to time.\n\n\n$ git fetch origin\n$ git rebase origin/master\n\n\n\n\nStep 7: Push\n\n\n$ git push fork my-branch\n\n\n\n\nGo to https://github.com/username/cozy-stack and select your branch. Click the\n\nPull Request\n button and fill out the form.\n\n\nPull requests are usually reviewed within a few days. If there are comments to\naddress, apply your changes in a separate commit and push that to your branch.\nPost a comment in the pull request afterwards; GitHub does not send out\nnotifications when you add commits.\n\n\nExternal assets\n\n\nThe cozy-stack serve some assets for the client application. In particular,\ncozy-client-js and cozy-bar assets are listed in \nassets/external\n. To update\nthem, you can open a pull request for this file. When a maintainer will accept\nthis pull request, he will also run \nscripts/build.sh assets\n to transform them\nin go code (to make the repository go gettable).\n\n\nUseful commands\n\n\nThere are some useful commands to know in order to develop with the go code of\ncozy-stack:\n\n\ngo get -u github.com/cozy/cozy-stack\ncd $(go env GOPATH)/src/github.com/cozy/cozy-stack\n\ngo get -t -u ./...      # To install or update the go dependencies\ngo test -v ./...        # To launch the tests\ngo run main.go serve    # To start the API server\ngodoc -http=:6060       # To start the documentation server\n                        # Open http://127.0.0.1:6060/pkg/github.com/cozy/cozy-stack/\n\n\n\n\nWriting documentation\n\n\nDocumentation improvements are very welcome. We try to keep a good documentation\nin the \ndocs/\n folder. But, you know, we are developers, we can forget to\ndocument important stuff that look obvious to us. And documentation can always\nbe improved.\n\n\nTranslations\n\n\nThe Cozy Stack is translated on a platform called\n\nTransifex\n.\n\nThis tutorial\n can help\nyou to learn how to make your first steps here. If you have any question, don\nt\nhesitate to ask us!\n\n\nThe translations are imported from transifex with \ntx pull -a\n in the\n\nassets/locales\n directory, and packed in the go code with \nscripts/build.sh\nassets\n.\n\n\nCommunity\n\n\nYou can help us by making our community even more vibrant. For example, you can\nwrite a blog post, take some videos, answer the questions on\n\nthe forum\n, organize new meetups, and speak about\nwhat you like in Cozy!", 
            "title": "The contributing guide"
        }, 
        {
            "location": "/cozy-stack/CONTRIBUTING/#how-to-contribute-to-the-cozy-stack", 
            "text": "Thank you for your interest in contributing to Cozy! There are many ways to\ncontribute, and we appreciate all of them.", 
            "title": "How to contribute to the Cozy Stack?"
        }, 
        {
            "location": "/cozy-stack/CONTRIBUTING/#security-issues", 
            "text": "If you discover a security issue, please bring it to their attention right away!\nPlease  DO NOT  file a public issue, instead send your report privately to\nsecurity AT cozycloud DOT cc.  Security reports are greatly appreciated and we will publicly thank you for it.\nWe currently do not offer a paid security bounty program, but are not ruling it\nout in the future.", 
            "title": "Security Issues"
        }, 
        {
            "location": "/cozy-stack/CONTRIBUTING/#bug-reports", 
            "text": "While bugs are unfortunate, they re a reality in software. We can t fix what we\ndon t know about, so please report liberally. If you re not sure if something is\na bug or not, feel free to file a bug anyway.  Opening an issue is as easy as following this link  and filling out the\nfields. Here are some things you can write about your bug:   A short summary  What did you try, step by step?  What did you expect?  What did happen instead?  What is the version of the Cozy Stack?   You can also use the  cozy-stack bug  command to open\nthe form to report issue prefilled with some useful system informations.", 
            "title": "Bug Reports"
        }, 
        {
            "location": "/cozy-stack/CONTRIBUTING/#pull-requests", 
            "text": "", 
            "title": "Pull Requests"
        }, 
        {
            "location": "/cozy-stack/CONTRIBUTING/#workflow", 
            "text": "Pull requests are the primary mechanism we use to change Cozy. GitHub itself has\nsome great documentation  \non using the Pull Request feature. We use the  fork and pull  model described\nthere.", 
            "title": "Workflow"
        }, 
        {
            "location": "/cozy-stack/CONTRIBUTING/#step-1-fork", 
            "text": "Fork the project on GitHub and check out your copy locally .  $ go get -u github.com/cozy/cozy-stack\n$ cd $(go env GOPATH)/src/github.com/cozy/cozy-stack\n$ git remote add fork git://github.com/username/cozy-stack.git", 
            "title": "Step 1: Fork"
        }, 
        {
            "location": "/cozy-stack/CONTRIBUTING/#step-2-branch", 
            "text": "Create a branch and start hacking:  $ git checkout -b my-branch -t origin/master", 
            "title": "Step 2: Branch"
        }, 
        {
            "location": "/cozy-stack/CONTRIBUTING/#step-3-code", 
            "text": "Well, I think you know how to do that. Just be sure to follow the coding\nguidelines from the Go community (gofmt, Effective Go , comment the code,\netc.).  We are using  goimports \nto format code, and  gometalinter \nto detect code smells.", 
            "title": "Step 3: Code"
        }, 
        {
            "location": "/cozy-stack/CONTRIBUTING/#step-4-test", 
            "text": "Don t forget to add tests and be sure they are green:  $ go test -v ./...  If you want to play with the modified cozy-stack (for example, testing it with\na webapp), you can build it locally and start it with this command:  $ go build   ./cozy-stack serve", 
            "title": "Step 4: Test"
        }, 
        {
            "location": "/cozy-stack/CONTRIBUTING/#step-5-commit", 
            "text": "Writing good commit messages \nis important. A commit message should describe what changed and why.", 
            "title": "Step 5: Commit"
        }, 
        {
            "location": "/cozy-stack/CONTRIBUTING/#step-6-rebase", 
            "text": "Use  git rebase  (not  git merge ) to sync your work from time to time.  $ git fetch origin\n$ git rebase origin/master", 
            "title": "Step 6: Rebase"
        }, 
        {
            "location": "/cozy-stack/CONTRIBUTING/#step-7-push", 
            "text": "$ git push fork my-branch  Go to https://github.com/username/cozy-stack and select your branch. Click the Pull Request  button and fill out the form.  Pull requests are usually reviewed within a few days. If there are comments to\naddress, apply your changes in a separate commit and push that to your branch.\nPost a comment in the pull request afterwards; GitHub does not send out\nnotifications when you add commits.", 
            "title": "Step 7: Push"
        }, 
        {
            "location": "/cozy-stack/CONTRIBUTING/#external-assets", 
            "text": "The cozy-stack serve some assets for the client application. In particular,\ncozy-client-js and cozy-bar assets are listed in  assets/external . To update\nthem, you can open a pull request for this file. When a maintainer will accept\nthis pull request, he will also run  scripts/build.sh assets  to transform them\nin go code (to make the repository go gettable).", 
            "title": "External assets"
        }, 
        {
            "location": "/cozy-stack/CONTRIBUTING/#useful-commands", 
            "text": "There are some useful commands to know in order to develop with the go code of\ncozy-stack:  go get -u github.com/cozy/cozy-stack\ncd $(go env GOPATH)/src/github.com/cozy/cozy-stack\n\ngo get -t -u ./...      # To install or update the go dependencies\ngo test -v ./...        # To launch the tests\ngo run main.go serve    # To start the API server\ngodoc -http=:6060       # To start the documentation server\n                        # Open http://127.0.0.1:6060/pkg/github.com/cozy/cozy-stack/", 
            "title": "Useful commands"
        }, 
        {
            "location": "/cozy-stack/CONTRIBUTING/#writing-documentation", 
            "text": "Documentation improvements are very welcome. We try to keep a good documentation\nin the  docs/  folder. But, you know, we are developers, we can forget to\ndocument important stuff that look obvious to us. And documentation can always\nbe improved.", 
            "title": "Writing documentation"
        }, 
        {
            "location": "/cozy-stack/CONTRIBUTING/#translations", 
            "text": "The Cozy Stack is translated on a platform called Transifex . This tutorial  can help\nyou to learn how to make your first steps here. If you have any question, don t\nhesitate to ask us!  The translations are imported from transifex with  tx pull -a  in the assets/locales  directory, and packed in the go code with  scripts/build.sh\nassets .", 
            "title": "Translations"
        }, 
        {
            "location": "/cozy-stack/CONTRIBUTING/#community", 
            "text": "You can help us by making our community even more vibrant. For example, you can\nwrite a blog post, take some videos, answer the questions on the forum , organize new meetups, and speak about\nwhat you like in Cozy!", 
            "title": "Community"
        }, 
        {
            "location": "/cozy-stack/auth/", 
            "text": "Table of contents\n\n\nAuthentication and access delegations\n\n\nIntroduction\n\n\nIn this document, we will cover how to protect the usage of the cozy-stack. When\nthe cozy-stack receives a request, it checks that the request is authorized, and\nif yes, it processes it and answers it.\n\n\nWhat about OAuth2?\n\n\nOAuth2 is about delegating an access to resources on a server to another party.\nIt is a framework, not a strictly defined protocol, for organizing the\ninteractions between these 4 actors:\n\n\n\n\nthe resource owner, the \nuser\n that can click on buttons\n\n\nthe client, the website or application that would like to access the resources\n\n\nthe authorization server, whose role is limited to give tokens but is central\n  in OAuth2 interactions\n\n\nthe resources server, the server that controls the resources.\n\n\n\n\nFor cozy, both the authorization server and the resources server roles are\nplayed by the cozy-stack. The resource owner is the owner of a cozy instance.\nThe client can be the cozy-desktop app, cozy-mobile, or many other applications.\n\n\nOAuth2, and its extensions, is a large world. At its core, there is 2 things:\nletting the client get a token issued by the authorization server, and using\nthis token to access to the resources. OAuth2 describe 4 flows, called grant\ntypes, for the first part:\n\n\n\n\nAuthorization code\n\n\nImplicit grant type\n\n\nClient credentials grant type\n\n\nResource owner credentials grant type.\n\n\n\n\nOn cozy, only the most typical one is used: authorization code. To start this\nflow, the client must have a \nclient_id\n and \nclient_secret\n. The Cozy stack\nimplements the OAuth2 Dynamic Client Registration Protocol (an extension to\nOAuth2) to allow the clients to obtain them.\n\n\nOAuth2 has also 3 ways to use a token:\n\n\n\n\nin the query-string (even if the spec does not recommended it)\n\n\nin the POST body\n\n\nin the HTTP Authorization header.\n\n\n\n\nOn cozy, only the HTTP header is supported.\n\n\nOAuth2 has a lot of assumptions. Let\ns see some of them and their consequences\non Cozy:\n\n\n\n\n\n\nTLS is very important to secure the communications. in OAuth 1, there was a\n  mechanism to sign the requests. But it was very difficult to get it right for\n  the developers and was abandonned in OAuth2, in favor of using TLS. The Cozy\n  instance are already accessible only in HTTPS, so there is nothing particular\n  to do for that.\n\n\n\n\n\n\nThere is a principle called TOFU, Trust On First Use. It said that if the user\n  will give his permission for delegating access to its resources when the\n  client will try to access them for the first time. Later, the client will be\n  able to keep accessing them even if the user is no longer here to give his\n  permissions.\n\n\n\n\n\n\nThe client can\nt make the assumptions about when its tokens will work. The\n  tokens have no meaning for him (like cookies in a browser), they are just\n  something it got from the authorization server and can send with its request.\n  The access token can expire, the user can revoke them, etc.\n\n\n\n\n\n\nOAuth 2.0 defines no cryptographic methods. But a developer that want to use\n  it will have to put her hands in that.\n\n\n\n\n\n\nIf you want to learn OAuth 2 in details, I recommend the\n\nOAuth 2 in Action book\n.\n\n\nThe cozy stack as an authorization server\n\n\nGET /auth/login\n\n\nDisplay a form with a password field to let the user authenticates herself to\nthe cozy stack.\n\n\nThis endpoint accepts a \nredirect\n parameter. If the user is already logged in,\nshe will be redirected immediately. Else, the parameter will be transfered in\nthe POST. This parameter can only contain a link to an application installed on\nthe cozy (thus to a subdomain of the cozy instance). To protect against stealing\nauthorization code with redirection, the fragment is always overriden:\n\n\nGET /auth/login?redirect=https://contacts.cozy.example.org/foo?bar#baz HTTP/1.1\nHost: cozy.example.org\nCookie: ...\n\n\n\n\nNote\n: the redirect parameter should be URL-encoded. We haven\nt done that to\nmake it clear what the path (\nfoo\n), the query-string (\nbar\n), and the fragment\n(\nbaz\n) are.\n\n\nHTTP/1.1 302 Moved Temporarily\nLocation: https://contacts.cozy.example.org/foo?bar#\n\n\n\n\nIf the \nredirect\n parameter is invalid, the response will be \n400 Bad Request\n.\nSame for other parameters, the redirection will happen only on success (even if\nOAuth2 says the authorization server can redirect on errors, it\ns very\ncomplicated to do it safely, and it is better to avoid this trap).\n\n\nPOST /auth/login\n\n\nAfter the user has typed her passphrase and clicked on \nLogin\n, a request is\nmade to this endpoint.\n\n\nThe \nredirect\n parameter is passed inside the body. If it is missing, the\nredirection will be made against the default target: the home application of\nthis cozy instance.\n\n\nPOST /auth/login HTTP/1.1\nHost: cozy.example.org\nContent-Type: application/x-www-form-urlencoded\n\npassphrase=p4ssw0rd\nredirect=https%3A%2F%2Fcontacts.cozy.example.org\n\n\n\n\nHTTP/1.1 302 Moved Temporarily\nSet-Cookie: ...\nLocation: https://contacts.cozy.example.org/foo\n\n\n\n\nWhen two-factor authentication (2FA) authentication is activated, this endpoint\nwill not directly sent a redirection after this first passphrase step. In such\ncase, a \n200 OK\n response is sent along with a token value in the response\n(either in JSON if requested or directly in a new HTML form).\n\n\nAlong with this token, on 2FA passcode is sent to the user via another transport\n(email for instance, depending on the user\ns preferences). Another request\nshould be sent to the same endpoint with a valid pair \n(token, passcode)\n,\nensuring that the user correctly entered its passphrase \nand\n received a fresh\npasscode by another mean.\n\n\nPOST /auth/login HTTP/1.1\nHost: cozy.example.org\nContent-Type: application/x-www-form-urlencoded\n\ntwo-factor-token=123123123123\npasscode=678678\nredirect=https%3A%2F%2Fcontacts.cozy.example.org\n\n\n\n\nHTTP/1.1 302 Moved Temporarily\nSet-Cookie: ...\nLocation: https://contacts.cozy.example.org/foo\n\n\n\n\nDELETE /auth/login\n\n\nThis can be used to log-out the user. An app token must be passed in the\n\nAuthorization\n header, to protect against CSRF attack on this (this can part of\nbigger attacks like session fixation).\n\n\nDELETE /auth/login HTTP/1.1\nHost: cozy.example.org\nCookie: seesioncookie....\nAuthorization: Bearer app-token\n\n\n\n\nDELETE /auth/login/others\n\n\nThis can be used to log-out all active sessions except the one used by the\nrequest. This allow to disconnect any other users currenctly authenticated on\nthe system. An app token must be passed in the \nAuthorization\n header, to\nprotect against CSRF attack on this (this can part of bigger attacks like\nsession fixation).\n\n\nDELETE /auth/login/others HTTP/1.1\nHost: cozy.example.org\nCookie: seesioncookie....\nAuthorization: Bearer app-token\n\n\n\n\nGET /auth/passphrase_reset\n\n\nDisplay a form for the user to reset its password, in case he has forgotten it\nfor example. If the user is connected, he won\nt be shown this form and he will\nbe directly redirected to his cozy.\n\n\nGET /auth/passphrase_reset HTTP/1.1\nHost: cozy.example.org\nContent-Type: text/html\nCookie: ...\n\n\n\n\nPOST /auth/passphrase_reset\n\n\nAfter the user has clicked on the reset button of the passphrase reset form, it\nwill execute a request to this endpoint.\n\n\nThis endpoint will create a token for the user to actually renew his passphrase.\nThe token has a short-live duration of about 15 minutes. After the token is\ncreated, it is sent to the user on its mailbox.\n\n\nThis endpoint will redirect the user on the login form page.\n\n\nPOST /auth/passphrase_reset HTTP/1.1\nHost: cozy.example.org\nContent-Type: application/x-www-form-urlencoded\n\ncsrf_token=123456890\n\n\n\n\nGET /auth/passphrase_renew\n\n\nDisplay a form for the user to enter a new password. This endpoint should be\nused with a \ntoken\n query parameter. This token makes sure that the user has\nactually reset its passphrase and should have been sent via its mailbox.\n\n\nGET /auth/passphrase_renew?token=123456789 HTTP/1.1\nHost: cozy.example.org\nContent-Type: text/html\nCookie: ...\n\n\n\n\nPOST /auth/passphrase_renew\n\n\nAfter the user has entered its new passphrase in the renew passphrase form, a\nrequest is made to this endpoint to renew the passphrase.\n\n\nThis endpoint requires a valid token to actually work. In case of a success, the\nuser is redirected to the login form.\n\n\nPOST /auth/passphrase_reset HTTP/1.1\nHost: cozy.example.org\nContent-Type: application/x-www-form-urlencoded\n\ncsrf_token=123456890\npassphrase_reset_token=123456789\npassphrase=mynewpassphrase\n\n\n\n\nPOST /auth/register\n\n\nThis route is used by OAuth2 clients to dynamically register them-selves.\n\n\nSee\n\nOAuth 2.0 Dynamic Client Registration Protocol\n\nfor the details.\n\n\nThe client must send a JSON request, with at least:\n\n\n\n\nredirect_uris\n, an array of strings with the redirect URIs that the client\n  will use in the authorization flow\n\n\nclient_name\n, human-readable string name of the client to be presented to the\n  end-user during authorization\n\n\nsoftware_id\n, an identifier of the software used by the client (it should\n  remain the same for all instances of the client software, whereas \nclient_id\n\n  varies between instances).\n\n\n\n\nIt can also send the optional fields:\n\n\n\n\nclient_kind\n (possible values: web, desktop, mobile, browser, etc.)\n\n\nclient_uri\n, URL string of a web page providing information about the client\n\n\nlogo_uri\n, to display an icon to the user in the authorization flow\n\n\npolicy_uri\n, URL string that points to a human-readable privacy policy\n  document that describes how the deployment organization collects, uses,\n  retains, and discloses personal data\n\n\nsoftware_version\n, a version identifier string for the client software.\n\n\nnotification_platform\n, to activate notifications on the associated\n  device, this field specify the platform used to send notifications:\n\n\n\"android\"\n: for Android devices with notifications via Firebase Cloud\n    Messageing\n\n\n\"ios\"\n: for iOS devices with notifications via APNS/2.\n\n\nnotification_device_token\n, the token used to identify the mobile device\n  for notifications\n\n\n\n\nThe server gives to the client the previous fields and these informations:\n\n\n\n\nclient_id\n\n\nclient_secret\n\n\nregistration_access_token\n\n\n\n\nExample:\n\n\nPOST /auth/register HTTP/1.1\nHost: cozy.example.org\nContent-Type: application/json\nAccept: application/json\n\n\n\n\n{\n  \nredirect_uris\n: [\nhttps://client.example.org/oauth/callback\n],\n  \nclient_name\n: \nClient\n,\n  \nsoftware_id\n: \ngithub.com/example/client\n,\n  \nsoftware_version\n: \n2.0.1\n,\n  \nclient_kind\n: \nweb\n,\n  \nclient_uri\n: \nhttps://client.example.org/\n,\n  \nlogo_uri\n: \nhttps://client.example.org/logo.svg\n,\n  \npolicy_uri\n: \nhttps://client/example.org/policy\n\n}\n\n\n\n\nHTTP/1.1 201 Created\nContent-Type: application/json\n\n\n\n\n{\n  \nclient_id\n: \n64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3\n,\n  \nclient_secret\n: \neyJpc3Mi[...omitted for brevity...]\n,\n  \nclient_secret_expires_at\n: 0,\n  \nregistration_access_token\n: \nJ9l-ZhwP[...omitted for brevity...]\n,\n  \ngrant_types\n: [\nauthorization_code\n, \nrefresh_token\n],\n  \nresponse_types\n: [\ncode\n],\n  \nredirect_uris\n: [\nhttps://client.example.org/oauth/callback\n],\n  \nclient_name\n: \nClient\n,\n  \nsoftware_id\n: \ngithub.com/example/client\n,\n  \nsoftware_version\n: \n2.0.1\n,\n  \nclient_kind\n: \nweb\n,\n  \nclient_uri\n: \nhttps://client.example.org/\n,\n  \nlogo_uri\n: \nhttps://client.example.org/logo.svg\n,\n  \npolicy_uri\n: \nhttps://client/example.org/policy\n\n}\n\n\n\n\nGET /auth/register/:client-id\n\n\nThis route is used by the clients to get informations about them-selves. The\nclient has to send its registration access token to be able to use this\nendpoint.\n\n\nSee\n\nOAuth 2.0 Dynamic Client Registration Management Protocol\n\nfor more details.\n\n\nGET /auth/register/64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 HTTP/1.1\nHost: cozy.example.org\nAccept: application/json\nAuthorization: Bearer J9l-ZhwP...\n\n\n\n\nHTTP/1.1 201 Created\nContent-Type: application/json\n\n\n\n\n{\n  \nclient_id\n: \n64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3\n,\n  \nclient_secret\n: \neyJpc3Mi[...omitted for brevity...]\n,\n  \nclient_secret_expires_at\n: 0,\n  \ngrant_types\n: [\nauthorization_code\n, \nrefresh_token\n],\n  \nresponse_types\n: [\ncode\n],\n  \nredirect_uris\n: [\nhttps://client.example.org/oauth/callback\n],\n  \nclient_name\n: \nClient\n,\n  \nsoftware_id\n: \ngithub.com/example/client\n,\n  \nsoftware_version\n: \n2.0.1\n,\n  \nclient_kind\n: \nweb\n,\n  \nclient_uri\n: \nhttps://client.example.org/\n,\n  \nlogo_uri\n: \nhttps://client.example.org/logo.svg\n,\n  \npolicy_uri\n: \nhttps://client/example.org/policy\n\n}\n\n\n\n\nPUT /auth/register/:client-id\n\n\nThis route is used by the clients to update informations about them-selves. The\nclient has to send its registration access token to be able to use this\nendpoint.\n\n\nNote:\n the client can ask to change its \nclient_secret\n. To do that, it must\nsend the current \nclient_secret\n, and the server will respond with the new\n\nclient_secret\n.\n\n\nPUT /auth/register/64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 HTTP/1.1\nHost: cozy.example.org\nAccept: application/json\nContent-Type: application/json\nAuthorization: Bearer J9l-ZhwP...\n\n\n\n\n{\n  \nclient_id\n: \n64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3\n,\n  \nclient_secret\n: \neyJpc3Mi[...omitted for brevity...]\n,\n  \nredirect_uris\n: [\nhttps://client.example.org/oauth/callback\n],\n  \nclient_name\n: \nClient\n,\n  \nsoftware_id\n: \ngithub.com/example/client\n,\n  \nsoftware_version\n: \n2.0.2\n,\n  \nclient_kind\n: \nweb\n,\n  \nclient_uri\n: \nhttps://client.example.org/\n,\n  \nlogo_uri\n: \nhttps://client.example.org/client-logo.svg\n,\n  \npolicy_uri\n: \nhttps://client/example.org/policy\n,\n  \nnotification_platform\n: \nandroid\n,\n  \nnotification_device_token\n: \nXXXXxxxx...\n\n}\n\n\n\n\nHTTP/1.1 200 OK\nContent-Type: application/json\n\n\n\n\n{\n  \nclient_id\n: \n64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3\n,\n  \nclient_secret\n: \nIFais2Ah[...omitted for brevity...]\n,\n  \nclient_secret_expires_at\n: 0,\n  \ngrant_types\n: [\nauthorization_code\n, \nrefresh_token\n],\n  \nresponse_types\n: [\ncode\n],\n  \nredirect_uris\n: [\nhttps://client.example.org/oauth/callback\n],\n  \nclient_name\n: \nClient\n,\n  \nsoftware_id\n: \ngithub.com/example/client\n,\n  \nsoftware_version\n: \n2.0.2\n,\n  \nclient_kind\n: \nweb\n,\n  \nclient_uri\n: \nhttps://client.example.org/\n,\n  \nlogo_uri\n: \nhttps://client.example.org/client-logo.svg\n,\n  \npolicy_uri\n: \nhttps://client/example.org/policy\n\n}\n\n\n\n\nDELETE /auth/register/:client-id\n\n\nThis route is used by the clients to unregister them-selves. The client has to\nsend its registration access token to be able to use this endpoint.\n\n\nDELETE /auth/register/64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 HTTP/1.1\nHost: cozy.example.org\nAuthorization: Bearer J9l-ZhwP...\n\n\n\n\nHTTP/1.1 204 No Content\nContent-Type: application/json\n\n\n\n\nGET /auth/authorize\n\n\nWhen an OAuth2 client wants to get access to the data of the cozy owner, it\nstarts the OAuth2 dance with this step. The user is shown what the client asks\nand has an accept button if she is OK with that.\n\n\nThe parameters are:\n\n\n\n\nclient_id\n, that identify the client\n\n\nredirect_uri\n, it has to be exactly the same as the one used in registration\n\n\nstate\n, it\ns a protection against CSRF on the client (a random string\n  generated by the client, that it can check when the user will be redirected\n  with the authorization code. It can be used as a key in local storage for\n  storing a state in a SPA).\n\n\nresponse_type\n, only \ncode\n is supported\n\n\nscope\n, a space separated list of the \npermissions\n asked\n  (like \nio.cozy.files:GET\n for read-only access to files).\n\n\n\n\nGET /auth/authorize?client_id=oauth-client-1\nresponse_type=code\nscope=io.cozy.files:GET%20io.cozy.contacts\nstate=Eh6ahshepei5Oojo\nredirect_uri=https%3A%2F%2Fclient.org%2F HTTP/1.1\nHost: cozy.example.org\n\n\n\n\nNote\n we warn the user that he is about to share his data with an application\nwhich only the callback URI is guaranteed.\n\n\nPOST /auth/authorize\n\n\nWhen the user accepts, her browser send a request to this endpoint:\n\n\nPOST /auth/authorize HTTP/1.1\nHost: cozy.example.org\nContent-Type: application/x-www-form-urlencoded\n\nstate=Eh6ahshepei5Oojo\nclient_id=oauth-client-1\nscope=io.cozy.files:GET%20io.cozy.contacts\ncsrf_token=johw6Sho\n\n\n\n\nNote\n: this endpoint is protected against CSRF attacks.\n\n\nThe user is then redirected to the original client, with an access code in the\nURL:\n\n\nHTTP/1.1 302 Moved Temporarily\nLocation: https://client.org/?state=Eh6ahshepei5Oojo\naccess_code=Aih7ohth#\n\n\n\n\nGET /auth/authorize/sharing \n POST /auth/authorize/sharing\n\n\nThey are similar to \n/auth/authorize\n: they also make the user accept an OAuth\nthing, but it is specialized for sharing. They are a few differences, like the\nscope format (sharing rules, not permissions) and the redirection after the\nPOST.\n\n\nPOST /auth/access_token\n\n\nNow, the client can check that the state is correct, and if it is the case, ask\nfor an \naccess_token\n. It can use this route with the \ncode\n (ie access_code)\ngiven above.\n\n\nThis endpoint is also used to refresh the access token, by sending the\n\nrefresh_token\n instead of the \naccess_code\n.\n\n\nThe parameters are:\n\n\n\n\ngrant_type\n, with \nauthorization_code\n or \nrefresh_token\n as value\n\n\ncode\n or \nrefresh_token\n, depending on which grant type is used\n\n\nclient_id\n\n\nclient_secret\n\n\n\n\nExample:\n\n\nPOST /auth/access_token HTTP/1.1\nHost: cozy.example.org\nContent-Type: application/x-www-form-urlencoded\nAccept: application/json\n\ngrant_type=authorization_code\ncode=Aih7ohth\nclient_id=oauth-client-1\nclient_secret=Oung7oi5\n\n\n\n\nHTTP/1.1 200 OK\nContent-type: application/json\n\n{\n  \naccess_token\n: \nooch1Yei\n,\n  \ntoken_type\n: \nbearer\n,\n  \nrefresh_token\n: \nui0Ohch8\n,\n  \nscope\n: \nio.cozy.files:GET io.cozy.contacts\n\n}\n\n\n\n\nFAQ\n\n\n\n\nWhat format is used for tokens?\n\n\n\n\nThe access tokens are formatted as \nJSON Web Tokens (JWT)\n,\nlike this:\n\n\n\n\n\n\n\n\nClaim\n\n\nFullname\n\n\nWhat it identifies\n\n\n\n\n\n\n\n\n\n\naud\n\n\nAudience\n\n\nIdentify the recipient where the token can be used (like \naccess\n)\n\n\n\n\n\n\niss\n\n\nIssuer\n\n\nIdentify the Cozy instance (its domain in fact)\n\n\n\n\n\n\niat\n\n\nIssued At\n\n\nIdentify when the token was issued (Unix timestamp)\n\n\n\n\n\n\nsub\n\n\nSubject\n\n\nIdentify the client that can use the token\n\n\n\n\n\n\nscope\n\n\nScope\n\n\nIdentify the scope of actions that the client can accomplish\n\n\n\n\n\n\n\n\nThe \nscope\n is used for \npermissions\n.\n\n\nOther tokens can be JWT with a similar formalism, or be a simple random value\n(when we want to have a clear revocation process).\n\n\n\n\nWhat happens when the user has lost her passphrase?\n\n\n\n\nShe can reset it from the command-line, like this:\n\n\n$ cozy-stack instances reset-passphrase cozy.example.org\nek0Jah1R\n\n\n\n\nA new password is generated and print in the console.\n\n\n\n\nIs two-factor authentication (2FA) possible?\n\n\n\n\nYes, it\ns possible. Via the cozy-settings application, the two-factor\nauthentication can be activated.\n\n\nHere is how it works in more details:\n\n\nOn each connection, when the 2FA is activated, the user is asked for its\npassphrase first. When entering correct passphrase, the user is then asked for:\n\n\n\n\na TOTP (Timebased One-Time password, RFC 6238) derived from a secret\n  associated with the instance.\n\n\na short term timestamped MAC with the same validity time-range and also\n  derived from the same secret.\n\n\n\n\nThe TOTP is valid for a time range of about 5 minutes. When sending a correct\nand still-valid pair \n(passcode, token)\n, the user is granted with\nauthentication cookie.\n\n\nThe passcode can be sent to the instance\ns owner via email \u2014 more transport\nshall be added later.\n\n\nClient-side apps\n\n\nImportant\n: OAuth2 is not used here! The steps looks similar (like obtaining\na token), but when going in the details, it doesn\nt match.\n\n\nHow to register the application?\n\n\nThe application is registered at install. See \napp management\n for\ndetails.\n\n\nHow to get a token?\n\n\nWhen a user access an application, she first loads the HTML page. Inside this\npage, a token specific to this app is injected (only for private routes), via a\ntemplating method.\n\n\nWe have prefered our custom solution to the implicit grant type of OAuth2 for 2\nreasons:\n\n\n\n\n\n\nIt has a better User Experience. The implicit grant type works with 2\n   redirections (the application to the stack, and then the stack to the\n   application), and the first one needs JS to detect if the token is present or\n   not in the fragment hash. It has a strong impact on the time to load the\n   application.\n\n\n\n\n\n\nThe implicit grant type of OAuth2 has a severe drawback on security: the\n   token appears in the URL and is shown by the browser. It can also be leaked\n   with the HTTP \nReferer\n header.\n\n\n\n\n\n\nThe token will be given only for the authenticated user. For nested subdomains\n(like \ncalendar.joe.example.net\n), the session cookie from the stack is enough\n(it is for \n.joe.example.net\n).\n\n\nBut for flat subdomains (like \njoe-calendar.example.net\n), it\ns more\ncomplicated. On the first try of the user, she will be redirected to the stack.\nAs she is already logged-in, she will be redirected to the app with a session\ncode (else she can login). This session code can be exchanged to a session\ncookie. A redirection will still happen to remove the code from the URL (it\nhelps to avoid the code being saved in the browser history). For security\nreasons, the session code have the following properties:\n\n\n\n\nIt can only be used once.\n\n\nIt is tied to an application (\ncalendar\n in our example).\n\n\nIt has a very short time span of validity (1 minute).\n\n\n\n\nHow to use a token?\n\n\nThe token can be sent to the cozy-stack as a \nBearer\n token in the\n\nAuthorization\n header, like this:\n\n\nGET /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee HTTP/1.1\nHost: cozy.example.org\nAuthorization: Bearer application-token\n\n\n\n\nIf the user is authenticated, her cookies will be sent automatically. The\ncookies are needed for a token to be valid.\n\n\nHow to refresh a token?\n\n\nThe token is valid only for 24 hours. If the application is opened for more than\nthat, it will need to get a new token. But most applications won\nt be kept open\nfor so long and it\ns okay if they don\nt try to refresh tokens. At worst, the\nuser just had to reload its page and it will work again.\n\n\nThe app can know it\ns time to get a new token when the stack starts sending 401\nUnauthorized responses. In that case, it can fetches the same html page that it\nwas loaded initially, parses it and extracts the new token.\n\n\nThird-party websites\n\n\nHow to register the application?\n\n\nIf a third-party websites would like to access a cozy, it had to register first.\nFor example, a big company can have data about a user and may want to offer her\na way to get her data back in her cozy. When the user is connected on the\nwebsite of this company, she can give her cozy address. The website will then\nregister on this cozy, using the OAuth2 Dynamic Client Registration Protocol, as\nexplained \nabove\n.\n\n\nHow to get a token?\n\n\nTo get an access token, it\ns enough to follow the authorization code flow of\nOAuth2:\n\n\n\n\nsending the user to the cozy, on the authorize page\n\n\nif the user approves, she is then redirected back to the client\n\n\nthe client gets the access code and can exchange it to an access token.\n\n\n\n\nHow to use a token?\n\n\nThe access token can be sent as a bearer token, in the Authorization header of\nHTTP:\n\n\nGET /data/io.cozy.contacts/6494e0ac-dfcb-11e5-88c1-472e84a9cbee HTTP/1.1\nHost: cozy.example.org\nAccept: application/json\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ\n\n\n\n\nHow to refresh a token?\n\n\nThe access token will be valid only for 24 hours. After that, a new access token\nmust be asked. To do that, just follow the refresh token flow, as explained\n\nabove\n.\n\n\nDevices and browser extensions\n\n\nFor devices and browser extensions, it is nearly the same than for third-party\nwebsites. The main difficulty is the redirect_uri. In OAuth2, the access code is\ngiven to the client by redirecting the user to an URL controlled by the client.\nBut devices and browser extensions don\nt have an obvious URL for that.\n\n\nThe IETF has published an RFC called\n\nOAuth 2.0 for Native Apps\n.\n\n\nNative apps on desktop\n\n\nA desktop native application can start an embedded webserver on localhost. The\nredirect_uri will be something like \nhttp://127.0.0.1:19856/callback\n.\n\n\nNative apps on mobile\n\n\nOn mobile, the native apps can often register a custom URI scheme, like\n\ncom.example.oauthclient:/\n. Just be sure that no other app has registered\nitself with the same URI.\n\n\nChrome extensions\n\n\nChrome extensions can use URL like\n\nhttps://\nextension-id\n.chromiumapp.org/\nanything-here\n for their usage. See\nhttps://developer.chrome.com/apps/app_identity#non for more details. It has also\na method to simplify the creation of such an URL:\n\nchrome.identity.getRedirectURL\n.\n\n\nFirefox extensions\n\n\nIt is possible to use an \nout of band\n URN: \nurn:ietf:wg:oauth:2.0:oob:auto\n.\nThe token is then extracted from the title of the page. See\n\nthis addon for google oauth2\n\nas an example.\n\n\nSecurity considerations\n\n\nThe password will be stored in a secure fashion, with a password hashing\nfunction. The hashing function and its parameter will be stored with the hash,\nin order to make it possible to change the algorithm and/or the parameters later\nif we had any suspicion that it became too weak. The initial algorithm is\n\nscrypt\n.\n\n\nThe access code is valid only once, and will expire after 5 minutes\n\n\nDynamically registered applications won\nt have access to all possible scopes.\nFor example, an application that has been dynamically registered can\nt ask the\ncozy owner to give it the right to install other applications. This limitation\nshould improve security, as avoiding too powerful scopes to be used with unknown\napplications.\n\n\nThe cozy stack will apply rate limiting to avoid brute-force attacks.\n\n\nThe cozy stack offers\n\nCORS\n\nfor most of its services. But it\ns disabled for \n/auth\n (it doesn\nt make sense\nhere) and for the client-side applications (to avoid leaking their tokens).\n\n\nThe client should really use HTTPS for its \nredirect_uri\n parameter, but it\ns\nallowed to use HTTP for localhost, as in the native desktop app example.\n\n\nOAuth2 says that the \nstate\n parameter is optional in the authorization code\nflow. But it is mandatory to use it with Cozy.\n\n\nFor more on this subject, here is a list of links:\n\n\n\n\nhttps://www.owasp.org/index.php/Authentication_Cheat_Sheet\n\n\nhttps://tools.ietf.org/html/rfc6749#page-53\n\n\nhttps://tools.ietf.org/html/rfc6819\n\n\nhttps://tools.ietf.org/html/draft-ietf-oauth-closing-redirectors-00\n\n\nhttp://www.oauthsecurity.com/\n\n\n\n\nConclusion\n\n\nSecurity is hard. If you want to share some concerns with us, do not hesitate to\nsend us an email to security AT cozycloud.cc.", 
            "title": "/auth - Authentication & OAuth"
        }, 
        {
            "location": "/cozy-stack/auth/#authentication-and-access-delegations", 
            "text": "", 
            "title": "Authentication and access delegations"
        }, 
        {
            "location": "/cozy-stack/auth/#introduction", 
            "text": "In this document, we will cover how to protect the usage of the cozy-stack. When\nthe cozy-stack receives a request, it checks that the request is authorized, and\nif yes, it processes it and answers it.", 
            "title": "Introduction"
        }, 
        {
            "location": "/cozy-stack/auth/#what-about-oauth2", 
            "text": "OAuth2 is about delegating an access to resources on a server to another party.\nIt is a framework, not a strictly defined protocol, for organizing the\ninteractions between these 4 actors:   the resource owner, the  user  that can click on buttons  the client, the website or application that would like to access the resources  the authorization server, whose role is limited to give tokens but is central\n  in OAuth2 interactions  the resources server, the server that controls the resources.   For cozy, both the authorization server and the resources server roles are\nplayed by the cozy-stack. The resource owner is the owner of a cozy instance.\nThe client can be the cozy-desktop app, cozy-mobile, or many other applications.  OAuth2, and its extensions, is a large world. At its core, there is 2 things:\nletting the client get a token issued by the authorization server, and using\nthis token to access to the resources. OAuth2 describe 4 flows, called grant\ntypes, for the first part:   Authorization code  Implicit grant type  Client credentials grant type  Resource owner credentials grant type.   On cozy, only the most typical one is used: authorization code. To start this\nflow, the client must have a  client_id  and  client_secret . The Cozy stack\nimplements the OAuth2 Dynamic Client Registration Protocol (an extension to\nOAuth2) to allow the clients to obtain them.  OAuth2 has also 3 ways to use a token:   in the query-string (even if the spec does not recommended it)  in the POST body  in the HTTP Authorization header.   On cozy, only the HTTP header is supported.  OAuth2 has a lot of assumptions. Let s see some of them and their consequences\non Cozy:    TLS is very important to secure the communications. in OAuth 1, there was a\n  mechanism to sign the requests. But it was very difficult to get it right for\n  the developers and was abandonned in OAuth2, in favor of using TLS. The Cozy\n  instance are already accessible only in HTTPS, so there is nothing particular\n  to do for that.    There is a principle called TOFU, Trust On First Use. It said that if the user\n  will give his permission for delegating access to its resources when the\n  client will try to access them for the first time. Later, the client will be\n  able to keep accessing them even if the user is no longer here to give his\n  permissions.    The client can t make the assumptions about when its tokens will work. The\n  tokens have no meaning for him (like cookies in a browser), they are just\n  something it got from the authorization server and can send with its request.\n  The access token can expire, the user can revoke them, etc.    OAuth 2.0 defines no cryptographic methods. But a developer that want to use\n  it will have to put her hands in that.    If you want to learn OAuth 2 in details, I recommend the OAuth 2 in Action book .", 
            "title": "What about OAuth2?"
        }, 
        {
            "location": "/cozy-stack/auth/#the-cozy-stack-as-an-authorization-server", 
            "text": "", 
            "title": "The cozy stack as an authorization server"
        }, 
        {
            "location": "/cozy-stack/auth/#get-authlogin", 
            "text": "Display a form with a password field to let the user authenticates herself to\nthe cozy stack.  This endpoint accepts a  redirect  parameter. If the user is already logged in,\nshe will be redirected immediately. Else, the parameter will be transfered in\nthe POST. This parameter can only contain a link to an application installed on\nthe cozy (thus to a subdomain of the cozy instance). To protect against stealing\nauthorization code with redirection, the fragment is always overriden:  GET /auth/login?redirect=https://contacts.cozy.example.org/foo?bar#baz HTTP/1.1\nHost: cozy.example.org\nCookie: ...  Note : the redirect parameter should be URL-encoded. We haven t done that to\nmake it clear what the path ( foo ), the query-string ( bar ), and the fragment\n( baz ) are.  HTTP/1.1 302 Moved Temporarily\nLocation: https://contacts.cozy.example.org/foo?bar#  If the  redirect  parameter is invalid, the response will be  400 Bad Request .\nSame for other parameters, the redirection will happen only on success (even if\nOAuth2 says the authorization server can redirect on errors, it s very\ncomplicated to do it safely, and it is better to avoid this trap).", 
            "title": "GET /auth/login"
        }, 
        {
            "location": "/cozy-stack/auth/#post-authlogin", 
            "text": "After the user has typed her passphrase and clicked on  Login , a request is\nmade to this endpoint.  The  redirect  parameter is passed inside the body. If it is missing, the\nredirection will be made against the default target: the home application of\nthis cozy instance.  POST /auth/login HTTP/1.1\nHost: cozy.example.org\nContent-Type: application/x-www-form-urlencoded\n\npassphrase=p4ssw0rd redirect=https%3A%2F%2Fcontacts.cozy.example.org  HTTP/1.1 302 Moved Temporarily\nSet-Cookie: ...\nLocation: https://contacts.cozy.example.org/foo  When two-factor authentication (2FA) authentication is activated, this endpoint\nwill not directly sent a redirection after this first passphrase step. In such\ncase, a  200 OK  response is sent along with a token value in the response\n(either in JSON if requested or directly in a new HTML form).  Along with this token, on 2FA passcode is sent to the user via another transport\n(email for instance, depending on the user s preferences). Another request\nshould be sent to the same endpoint with a valid pair  (token, passcode) ,\nensuring that the user correctly entered its passphrase  and  received a fresh\npasscode by another mean.  POST /auth/login HTTP/1.1\nHost: cozy.example.org\nContent-Type: application/x-www-form-urlencoded\n\ntwo-factor-token=123123123123 passcode=678678 redirect=https%3A%2F%2Fcontacts.cozy.example.org  HTTP/1.1 302 Moved Temporarily\nSet-Cookie: ...\nLocation: https://contacts.cozy.example.org/foo", 
            "title": "POST /auth/login"
        }, 
        {
            "location": "/cozy-stack/auth/#delete-authlogin", 
            "text": "This can be used to log-out the user. An app token must be passed in the Authorization  header, to protect against CSRF attack on this (this can part of\nbigger attacks like session fixation).  DELETE /auth/login HTTP/1.1\nHost: cozy.example.org\nCookie: seesioncookie....\nAuthorization: Bearer app-token", 
            "title": "DELETE /auth/login"
        }, 
        {
            "location": "/cozy-stack/auth/#delete-authloginothers", 
            "text": "This can be used to log-out all active sessions except the one used by the\nrequest. This allow to disconnect any other users currenctly authenticated on\nthe system. An app token must be passed in the  Authorization  header, to\nprotect against CSRF attack on this (this can part of bigger attacks like\nsession fixation).  DELETE /auth/login/others HTTP/1.1\nHost: cozy.example.org\nCookie: seesioncookie....\nAuthorization: Bearer app-token", 
            "title": "DELETE /auth/login/others"
        }, 
        {
            "location": "/cozy-stack/auth/#get-authpassphrase_reset", 
            "text": "Display a form for the user to reset its password, in case he has forgotten it\nfor example. If the user is connected, he won t be shown this form and he will\nbe directly redirected to his cozy.  GET /auth/passphrase_reset HTTP/1.1\nHost: cozy.example.org\nContent-Type: text/html\nCookie: ...", 
            "title": "GET /auth/passphrase_reset"
        }, 
        {
            "location": "/cozy-stack/auth/#post-authpassphrase_reset", 
            "text": "After the user has clicked on the reset button of the passphrase reset form, it\nwill execute a request to this endpoint.  This endpoint will create a token for the user to actually renew his passphrase.\nThe token has a short-live duration of about 15 minutes. After the token is\ncreated, it is sent to the user on its mailbox.  This endpoint will redirect the user on the login form page.  POST /auth/passphrase_reset HTTP/1.1\nHost: cozy.example.org\nContent-Type: application/x-www-form-urlencoded\n\ncsrf_token=123456890", 
            "title": "POST /auth/passphrase_reset"
        }, 
        {
            "location": "/cozy-stack/auth/#get-authpassphrase_renew", 
            "text": "Display a form for the user to enter a new password. This endpoint should be\nused with a  token  query parameter. This token makes sure that the user has\nactually reset its passphrase and should have been sent via its mailbox.  GET /auth/passphrase_renew?token=123456789 HTTP/1.1\nHost: cozy.example.org\nContent-Type: text/html\nCookie: ...", 
            "title": "GET /auth/passphrase_renew"
        }, 
        {
            "location": "/cozy-stack/auth/#post-authpassphrase_renew", 
            "text": "After the user has entered its new passphrase in the renew passphrase form, a\nrequest is made to this endpoint to renew the passphrase.  This endpoint requires a valid token to actually work. In case of a success, the\nuser is redirected to the login form.  POST /auth/passphrase_reset HTTP/1.1\nHost: cozy.example.org\nContent-Type: application/x-www-form-urlencoded\n\ncsrf_token=123456890 passphrase_reset_token=123456789 passphrase=mynewpassphrase", 
            "title": "POST /auth/passphrase_renew"
        }, 
        {
            "location": "/cozy-stack/auth/#post-authregister", 
            "text": "This route is used by OAuth2 clients to dynamically register them-selves.  See OAuth 2.0 Dynamic Client Registration Protocol \nfor the details.  The client must send a JSON request, with at least:   redirect_uris , an array of strings with the redirect URIs that the client\n  will use in the authorization flow  client_name , human-readable string name of the client to be presented to the\n  end-user during authorization  software_id , an identifier of the software used by the client (it should\n  remain the same for all instances of the client software, whereas  client_id \n  varies between instances).   It can also send the optional fields:   client_kind  (possible values: web, desktop, mobile, browser, etc.)  client_uri , URL string of a web page providing information about the client  logo_uri , to display an icon to the user in the authorization flow  policy_uri , URL string that points to a human-readable privacy policy\n  document that describes how the deployment organization collects, uses,\n  retains, and discloses personal data  software_version , a version identifier string for the client software.  notification_platform , to activate notifications on the associated\n  device, this field specify the platform used to send notifications:  \"android\" : for Android devices with notifications via Firebase Cloud\n    Messageing  \"ios\" : for iOS devices with notifications via APNS/2.  notification_device_token , the token used to identify the mobile device\n  for notifications   The server gives to the client the previous fields and these informations:   client_id  client_secret  registration_access_token   Example:  POST /auth/register HTTP/1.1\nHost: cozy.example.org\nContent-Type: application/json\nAccept: application/json  {\n   redirect_uris : [ https://client.example.org/oauth/callback ],\n   client_name :  Client ,\n   software_id :  github.com/example/client ,\n   software_version :  2.0.1 ,\n   client_kind :  web ,\n   client_uri :  https://client.example.org/ ,\n   logo_uri :  https://client.example.org/logo.svg ,\n   policy_uri :  https://client/example.org/policy \n}  HTTP/1.1 201 Created\nContent-Type: application/json  {\n   client_id :  64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 ,\n   client_secret :  eyJpc3Mi[...omitted for brevity...] ,\n   client_secret_expires_at : 0,\n   registration_access_token :  J9l-ZhwP[...omitted for brevity...] ,\n   grant_types : [ authorization_code ,  refresh_token ],\n   response_types : [ code ],\n   redirect_uris : [ https://client.example.org/oauth/callback ],\n   client_name :  Client ,\n   software_id :  github.com/example/client ,\n   software_version :  2.0.1 ,\n   client_kind :  web ,\n   client_uri :  https://client.example.org/ ,\n   logo_uri :  https://client.example.org/logo.svg ,\n   policy_uri :  https://client/example.org/policy \n}", 
            "title": "POST /auth/register"
        }, 
        {
            "location": "/cozy-stack/auth/#get-authregisterclient-id", 
            "text": "This route is used by the clients to get informations about them-selves. The\nclient has to send its registration access token to be able to use this\nendpoint.  See OAuth 2.0 Dynamic Client Registration Management Protocol \nfor more details.  GET /auth/register/64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 HTTP/1.1\nHost: cozy.example.org\nAccept: application/json\nAuthorization: Bearer J9l-ZhwP...  HTTP/1.1 201 Created\nContent-Type: application/json  {\n   client_id :  64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 ,\n   client_secret :  eyJpc3Mi[...omitted for brevity...] ,\n   client_secret_expires_at : 0,\n   grant_types : [ authorization_code ,  refresh_token ],\n   response_types : [ code ],\n   redirect_uris : [ https://client.example.org/oauth/callback ],\n   client_name :  Client ,\n   software_id :  github.com/example/client ,\n   software_version :  2.0.1 ,\n   client_kind :  web ,\n   client_uri :  https://client.example.org/ ,\n   logo_uri :  https://client.example.org/logo.svg ,\n   policy_uri :  https://client/example.org/policy \n}", 
            "title": "GET /auth/register/:client-id"
        }, 
        {
            "location": "/cozy-stack/auth/#put-authregisterclient-id", 
            "text": "This route is used by the clients to update informations about them-selves. The\nclient has to send its registration access token to be able to use this\nendpoint.  Note:  the client can ask to change its  client_secret . To do that, it must\nsend the current  client_secret , and the server will respond with the new client_secret .  PUT /auth/register/64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 HTTP/1.1\nHost: cozy.example.org\nAccept: application/json\nContent-Type: application/json\nAuthorization: Bearer J9l-ZhwP...  {\n   client_id :  64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 ,\n   client_secret :  eyJpc3Mi[...omitted for brevity...] ,\n   redirect_uris : [ https://client.example.org/oauth/callback ],\n   client_name :  Client ,\n   software_id :  github.com/example/client ,\n   software_version :  2.0.2 ,\n   client_kind :  web ,\n   client_uri :  https://client.example.org/ ,\n   logo_uri :  https://client.example.org/client-logo.svg ,\n   policy_uri :  https://client/example.org/policy ,\n   notification_platform :  android ,\n   notification_device_token :  XXXXxxxx... \n}  HTTP/1.1 200 OK\nContent-Type: application/json  {\n   client_id :  64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 ,\n   client_secret :  IFais2Ah[...omitted for brevity...] ,\n   client_secret_expires_at : 0,\n   grant_types : [ authorization_code ,  refresh_token ],\n   response_types : [ code ],\n   redirect_uris : [ https://client.example.org/oauth/callback ],\n   client_name :  Client ,\n   software_id :  github.com/example/client ,\n   software_version :  2.0.2 ,\n   client_kind :  web ,\n   client_uri :  https://client.example.org/ ,\n   logo_uri :  https://client.example.org/client-logo.svg ,\n   policy_uri :  https://client/example.org/policy \n}", 
            "title": "PUT /auth/register/:client-id"
        }, 
        {
            "location": "/cozy-stack/auth/#delete-authregisterclient-id", 
            "text": "This route is used by the clients to unregister them-selves. The client has to\nsend its registration access token to be able to use this endpoint.  DELETE /auth/register/64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 HTTP/1.1\nHost: cozy.example.org\nAuthorization: Bearer J9l-ZhwP...  HTTP/1.1 204 No Content\nContent-Type: application/json", 
            "title": "DELETE /auth/register/:client-id"
        }, 
        {
            "location": "/cozy-stack/auth/#get-authauthorize", 
            "text": "When an OAuth2 client wants to get access to the data of the cozy owner, it\nstarts the OAuth2 dance with this step. The user is shown what the client asks\nand has an accept button if she is OK with that.  The parameters are:   client_id , that identify the client  redirect_uri , it has to be exactly the same as the one used in registration  state , it s a protection against CSRF on the client (a random string\n  generated by the client, that it can check when the user will be redirected\n  with the authorization code. It can be used as a key in local storage for\n  storing a state in a SPA).  response_type , only  code  is supported  scope , a space separated list of the  permissions  asked\n  (like  io.cozy.files:GET  for read-only access to files).   GET /auth/authorize?client_id=oauth-client-1 response_type=code scope=io.cozy.files:GET%20io.cozy.contacts state=Eh6ahshepei5Oojo redirect_uri=https%3A%2F%2Fclient.org%2F HTTP/1.1\nHost: cozy.example.org  Note  we warn the user that he is about to share his data with an application\nwhich only the callback URI is guaranteed.", 
            "title": "GET /auth/authorize"
        }, 
        {
            "location": "/cozy-stack/auth/#post-authauthorize", 
            "text": "When the user accepts, her browser send a request to this endpoint:  POST /auth/authorize HTTP/1.1\nHost: cozy.example.org\nContent-Type: application/x-www-form-urlencoded\n\nstate=Eh6ahshepei5Oojo client_id=oauth-client-1 scope=io.cozy.files:GET%20io.cozy.contacts csrf_token=johw6Sho  Note : this endpoint is protected against CSRF attacks.  The user is then redirected to the original client, with an access code in the\nURL:  HTTP/1.1 302 Moved Temporarily\nLocation: https://client.org/?state=Eh6ahshepei5Oojo access_code=Aih7ohth#", 
            "title": "POST /auth/authorize"
        }, 
        {
            "location": "/cozy-stack/auth/#get-authauthorizesharing-post-authauthorizesharing", 
            "text": "They are similar to  /auth/authorize : they also make the user accept an OAuth\nthing, but it is specialized for sharing. They are a few differences, like the\nscope format (sharing rules, not permissions) and the redirection after the\nPOST.", 
            "title": "GET /auth/authorize/sharing &amp; POST /auth/authorize/sharing"
        }, 
        {
            "location": "/cozy-stack/auth/#post-authaccess_token", 
            "text": "Now, the client can check that the state is correct, and if it is the case, ask\nfor an  access_token . It can use this route with the  code  (ie access_code)\ngiven above.  This endpoint is also used to refresh the access token, by sending the refresh_token  instead of the  access_code .  The parameters are:   grant_type , with  authorization_code  or  refresh_token  as value  code  or  refresh_token , depending on which grant type is used  client_id  client_secret   Example:  POST /auth/access_token HTTP/1.1\nHost: cozy.example.org\nContent-Type: application/x-www-form-urlencoded\nAccept: application/json\n\ngrant_type=authorization_code code=Aih7ohth client_id=oauth-client-1 client_secret=Oung7oi5  HTTP/1.1 200 OK\nContent-type: application/json\n\n{\n   access_token :  ooch1Yei ,\n   token_type :  bearer ,\n   refresh_token :  ui0Ohch8 ,\n   scope :  io.cozy.files:GET io.cozy.contacts \n}", 
            "title": "POST /auth/access_token"
        }, 
        {
            "location": "/cozy-stack/auth/#faq", 
            "text": "What format is used for tokens?   The access tokens are formatted as  JSON Web Tokens (JWT) ,\nlike this:     Claim  Fullname  What it identifies      aud  Audience  Identify the recipient where the token can be used (like  access )    iss  Issuer  Identify the Cozy instance (its domain in fact)    iat  Issued At  Identify when the token was issued (Unix timestamp)    sub  Subject  Identify the client that can use the token    scope  Scope  Identify the scope of actions that the client can accomplish     The  scope  is used for  permissions .  Other tokens can be JWT with a similar formalism, or be a simple random value\n(when we want to have a clear revocation process).   What happens when the user has lost her passphrase?   She can reset it from the command-line, like this:  $ cozy-stack instances reset-passphrase cozy.example.org\nek0Jah1R  A new password is generated and print in the console.   Is two-factor authentication (2FA) possible?   Yes, it s possible. Via the cozy-settings application, the two-factor\nauthentication can be activated.  Here is how it works in more details:  On each connection, when the 2FA is activated, the user is asked for its\npassphrase first. When entering correct passphrase, the user is then asked for:   a TOTP (Timebased One-Time password, RFC 6238) derived from a secret\n  associated with the instance.  a short term timestamped MAC with the same validity time-range and also\n  derived from the same secret.   The TOTP is valid for a time range of about 5 minutes. When sending a correct\nand still-valid pair  (passcode, token) , the user is granted with\nauthentication cookie.  The passcode can be sent to the instance s owner via email \u2014 more transport\nshall be added later.", 
            "title": "FAQ"
        }, 
        {
            "location": "/cozy-stack/auth/#client-side-apps", 
            "text": "Important : OAuth2 is not used here! The steps looks similar (like obtaining\na token), but when going in the details, it doesn t match.", 
            "title": "Client-side apps"
        }, 
        {
            "location": "/cozy-stack/auth/#how-to-register-the-application", 
            "text": "The application is registered at install. See  app management  for\ndetails.", 
            "title": "How to register the application?"
        }, 
        {
            "location": "/cozy-stack/auth/#how-to-get-a-token", 
            "text": "When a user access an application, she first loads the HTML page. Inside this\npage, a token specific to this app is injected (only for private routes), via a\ntemplating method.  We have prefered our custom solution to the implicit grant type of OAuth2 for 2\nreasons:    It has a better User Experience. The implicit grant type works with 2\n   redirections (the application to the stack, and then the stack to the\n   application), and the first one needs JS to detect if the token is present or\n   not in the fragment hash. It has a strong impact on the time to load the\n   application.    The implicit grant type of OAuth2 has a severe drawback on security: the\n   token appears in the URL and is shown by the browser. It can also be leaked\n   with the HTTP  Referer  header.    The token will be given only for the authenticated user. For nested subdomains\n(like  calendar.joe.example.net ), the session cookie from the stack is enough\n(it is for  .joe.example.net ).  But for flat subdomains (like  joe-calendar.example.net ), it s more\ncomplicated. On the first try of the user, she will be redirected to the stack.\nAs she is already logged-in, she will be redirected to the app with a session\ncode (else she can login). This session code can be exchanged to a session\ncookie. A redirection will still happen to remove the code from the URL (it\nhelps to avoid the code being saved in the browser history). For security\nreasons, the session code have the following properties:   It can only be used once.  It is tied to an application ( calendar  in our example).  It has a very short time span of validity (1 minute).", 
            "title": "How to get a token?"
        }, 
        {
            "location": "/cozy-stack/auth/#how-to-use-a-token", 
            "text": "The token can be sent to the cozy-stack as a  Bearer  token in the Authorization  header, like this:  GET /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee HTTP/1.1\nHost: cozy.example.org\nAuthorization: Bearer application-token  If the user is authenticated, her cookies will be sent automatically. The\ncookies are needed for a token to be valid.", 
            "title": "How to use a token?"
        }, 
        {
            "location": "/cozy-stack/auth/#how-to-refresh-a-token", 
            "text": "The token is valid only for 24 hours. If the application is opened for more than\nthat, it will need to get a new token. But most applications won t be kept open\nfor so long and it s okay if they don t try to refresh tokens. At worst, the\nuser just had to reload its page and it will work again.  The app can know it s time to get a new token when the stack starts sending 401\nUnauthorized responses. In that case, it can fetches the same html page that it\nwas loaded initially, parses it and extracts the new token.", 
            "title": "How to refresh a token?"
        }, 
        {
            "location": "/cozy-stack/auth/#third-party-websites", 
            "text": "", 
            "title": "Third-party websites"
        }, 
        {
            "location": "/cozy-stack/auth/#how-to-register-the-application_1", 
            "text": "If a third-party websites would like to access a cozy, it had to register first.\nFor example, a big company can have data about a user and may want to offer her\na way to get her data back in her cozy. When the user is connected on the\nwebsite of this company, she can give her cozy address. The website will then\nregister on this cozy, using the OAuth2 Dynamic Client Registration Protocol, as\nexplained  above .", 
            "title": "How to register the application?"
        }, 
        {
            "location": "/cozy-stack/auth/#how-to-get-a-token_1", 
            "text": "To get an access token, it s enough to follow the authorization code flow of\nOAuth2:   sending the user to the cozy, on the authorize page  if the user approves, she is then redirected back to the client  the client gets the access code and can exchange it to an access token.", 
            "title": "How to get a token?"
        }, 
        {
            "location": "/cozy-stack/auth/#how-to-use-a-token_1", 
            "text": "The access token can be sent as a bearer token, in the Authorization header of\nHTTP:  GET /data/io.cozy.contacts/6494e0ac-dfcb-11e5-88c1-472e84a9cbee HTTP/1.1\nHost: cozy.example.org\nAccept: application/json\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ", 
            "title": "How to use a token?"
        }, 
        {
            "location": "/cozy-stack/auth/#how-to-refresh-a-token_1", 
            "text": "The access token will be valid only for 24 hours. After that, a new access token\nmust be asked. To do that, just follow the refresh token flow, as explained above .", 
            "title": "How to refresh a token?"
        }, 
        {
            "location": "/cozy-stack/auth/#devices-and-browser-extensions", 
            "text": "For devices and browser extensions, it is nearly the same than for third-party\nwebsites. The main difficulty is the redirect_uri. In OAuth2, the access code is\ngiven to the client by redirecting the user to an URL controlled by the client.\nBut devices and browser extensions don t have an obvious URL for that.  The IETF has published an RFC called OAuth 2.0 for Native Apps .", 
            "title": "Devices and browser extensions"
        }, 
        {
            "location": "/cozy-stack/auth/#native-apps-on-desktop", 
            "text": "A desktop native application can start an embedded webserver on localhost. The\nredirect_uri will be something like  http://127.0.0.1:19856/callback .", 
            "title": "Native apps on desktop"
        }, 
        {
            "location": "/cozy-stack/auth/#native-apps-on-mobile", 
            "text": "On mobile, the native apps can often register a custom URI scheme, like com.example.oauthclient:/ . Just be sure that no other app has registered\nitself with the same URI.", 
            "title": "Native apps on mobile"
        }, 
        {
            "location": "/cozy-stack/auth/#chrome-extensions", 
            "text": "Chrome extensions can use URL like https:// extension-id .chromiumapp.org/ anything-here  for their usage. See\nhttps://developer.chrome.com/apps/app_identity#non for more details. It has also\na method to simplify the creation of such an URL: chrome.identity.getRedirectURL .", 
            "title": "Chrome extensions"
        }, 
        {
            "location": "/cozy-stack/auth/#firefox-extensions", 
            "text": "It is possible to use an  out of band  URN:  urn:ietf:wg:oauth:2.0:oob:auto .\nThe token is then extracted from the title of the page. See this addon for google oauth2 \nas an example.", 
            "title": "Firefox extensions"
        }, 
        {
            "location": "/cozy-stack/auth/#security-considerations", 
            "text": "The password will be stored in a secure fashion, with a password hashing\nfunction. The hashing function and its parameter will be stored with the hash,\nin order to make it possible to change the algorithm and/or the parameters later\nif we had any suspicion that it became too weak. The initial algorithm is scrypt .  The access code is valid only once, and will expire after 5 minutes  Dynamically registered applications won t have access to all possible scopes.\nFor example, an application that has been dynamically registered can t ask the\ncozy owner to give it the right to install other applications. This limitation\nshould improve security, as avoiding too powerful scopes to be used with unknown\napplications.  The cozy stack will apply rate limiting to avoid brute-force attacks.  The cozy stack offers CORS \nfor most of its services. But it s disabled for  /auth  (it doesn t make sense\nhere) and for the client-side applications (to avoid leaking their tokens).  The client should really use HTTPS for its  redirect_uri  parameter, but it s\nallowed to use HTTP for localhost, as in the native desktop app example.  OAuth2 says that the  state  parameter is optional in the authorization code\nflow. But it is mandatory to use it with Cozy.  For more on this subject, here is a list of links:   https://www.owasp.org/index.php/Authentication_Cheat_Sheet  https://tools.ietf.org/html/rfc6749#page-53  https://tools.ietf.org/html/rfc6819  https://tools.ietf.org/html/draft-ietf-oauth-closing-redirectors-00  http://www.oauthsecurity.com/", 
            "title": "Security considerations"
        }, 
        {
            "location": "/cozy-stack/auth/#conclusion", 
            "text": "Security is hard. If you want to share some concerns with us, do not hesitate to\nsend us an email to security AT cozycloud.cc.", 
            "title": "Conclusion"
        }, 
        {
            "location": "/cozy-stack/apps/", 
            "text": "Table of contents\n\n\nApplications\n\n\nIt\ns possible to manage serverless applications from the cozy stack and serve\nthem via cozy stack. The stack does the routing and serve the HTML and the\nassets for the applications. The assets of the applications are installed in the\nvirtual file system.\n\n\nInstall an application\n\n\nThe manifest\n\n\nTo install an application, cozy needs a manifest. It\ns a JSON document that\ndescribes the application (its name and icon for example), how to install it and\nwhat it needs for its usage (the permissions in particular). While we have\nconsidered to use the same\n\nmanifest format as the W3C for PWAs\n, it\ndidn\nt match our expectations. The\n\nmanifest format for FirefoxOS\n\nis a better fit. We took a lot of inspirations from it, starting with the\nfilename for this file: \nmanifest.webapp\n.\n\n\n\n\n\n\n\n\nField\n\n\nDescription\n\n\n\n\n\n\n\n\n\n\nname\n\n\nthe name to display on the home\n\n\n\n\n\n\nname_prefix\n\n\nthe prefix to display with the name\n\n\n\n\n\n\nslug\n\n\nthe default slug (it can be changed at install time)\n\n\n\n\n\n\neditor\n\n\nthe editor\ns name to display on the cozy-bar of the app\n\n\n\n\n\n\nicon\n\n\nan icon for the home\n\n\n\n\n\n\nscreenshots\n\n\nan array of path to the screenshots of the application\n\n\n\n\n\n\ncategory\n\n\nthe category of the application\n\n\n\n\n\n\nshort_description\n\n\na short description of the application\n\n\n\n\n\n\nlong_description\n\n\na long description of the application\n\n\n\n\n\n\nsource\n\n\nwhere the files of the app can be downloaded\n\n\n\n\n\n\ndeveloper\n\n\nname\n and \nurl\n for the developer\n\n\n\n\n\n\nlocales\n\n\ntranslations of the name and description fields in other locales\n\n\n\n\n\n\nlangs\n\n\nlist of languages tags supported by the application\n\n\n\n\n\n\nversion\n\n\nthe current version number\n\n\n\n\n\n\nlicense\n\n\nthe SPDX license identifier\n\n\n\n\n\n\nplatforms\n\n\na list of \ntype\n, \nurl\n values for derivate of the application for other devices\n\n\n\n\n\n\nintents\n\n\na list of intents provided by this app (see \nhere\n for more details)\n\n\n\n\n\n\npermissions\n\n\na map of permissions needed by the app (see \nhere\n for more details)\n\n\n\n\n\n\nnotifications\n\n\na map of notifications needed by the app (see \nhere\n for more details)\n\n\n\n\n\n\nservices\n\n\na map of the services associated with the app (see below for more details)\n\n\n\n\n\n\nroutes\n\n\na map of routes for the app (see below for more details)\n\n\n\n\n\n\n\n\nRoutes\n\n\nA route make the mapping between the requested paths and the files. It can have\nan index, which is an HTML file, with a token injected on it that identify both\nthe application. This token must be used with the user cookies to use the\nservices of the cozy-stack.\n\n\nBy default, a route can be only visited by the authenticated owner of the\ninstance where the app is installed. But a route can be marked as public. In\nthat case, anybody can visit the route.\n\n\nFor example, an application can offer an administration interface on \n/admin\n, a\npublic page on \n/public\n, and shared assets in \n/assets\n:\n\n\n{\n  \n/admin\n: {\n    \nfolder\n: \n/\n,\n    \nindex\n: \nadmin.html\n,\n    \npublic\n: false\n  },\n  \n/public\n: {\n    \nfolder\n: \n/public\n,\n    \nindex\n: \nindex.html\n,\n    \npublic\n: true\n  },\n  \n/assets\n: {\n    \nfolder\n: \n/assets\n,\n    \npublic\n: true\n  }\n}\n\n\n\n\nIf an application has no routes in its manifest, the stack will create one\nroute, this default one:\n\n\n{\n  \n/\n: {\n    \nfolder\n: \n/\n,\n    \nindex\n: \nindex.html\n,\n    \npublic\n: false\n  }\n}\n\n\n\n\nNote\n: if you have a public route, it\ns probably better to put the app icon\nin it. So, the cozy-bar can display it for the users that go on the public part\nof the app.\n\n\nServices\n\n\nApplication may require background and offline process to analyse the user\ns\ndata and emit some notification or warning even without the user being on the\napplication. These part of the application are called services and can be\ndeclared as part of the application in its manifest.\n\n\nIn contrast to \nkonnectors\n, services have the same\npermissions as the web application and are not intended to collect outside\ninformations but rather analyse the current set of collected information\ninside the cozy. However they share the same mechanisms as the konnectors to\ndescribe how and when they should be executed: via our trigger system.\n\n\nTo define a service, first the code needs to be stored with the application\ncontent, as single (packaged) javascript files. In the manifest, declare the\nservice and its parameters following this example:\n\n\n{\n  \nservices\n: {\n    \nlow-budget-notification\n: {\n      \ntype\n: \nnode\n,\n      \nfile\n: \n/services/low-budget-notification.js\n,\n      \ntrigger\n: \n@cron 0 0 0 * * *\n\n    }\n    // ...\n  }\n}\n\n\n\n\nThe \ntrigger\n field should follow the available triggers described in the\n\njobs documentation\n. The \nfile\n field should specify the service\ncode run and the \ntype\n field describe the code type (only \n\"node\"\n for now).\n\n\nNotifications\n\n\nFor more informations on how te declare notifications in the manifest, see\nthe \nnotifications documentation\n.\n\n\nHere is an example:\n\n\n{\n  \nnotifications\n: {\n    \naccount-balance\n: {\n      \ndescription\n: \nAlert the user when its account balance is negative\n,\n      \ncollapsible\n: true, // only interested in the last value of the notification\n      \nmultiple\n: true, // require sub-categories for each account\n      \nstateful\n: false,\n      \ndefault_priority\n: \nhigh\n, // high priority for this notification\n      \ntemplates\n: {\n        \nmail\n: \nfile:./notifications/account-balance-mail.tpl\n\n      }\n    }\n  }\n}\n\n\n\n\nResource caching\n\n\nTo help caching of applications assets, we detect the presence of a unique\nidentifier in the name of assets: a unique identifier is matched when the file\nbase name contains a long hexadecimal subpart between \n.\n, of at least 10\ncharacters. For instance \napp.badf00dbadf00d.js\n or \nicon.badbeefbadbeef.1.png\n.\n\n\nWith such a unique identifier, the asset is considered immutable, and a long\ncache-control is added on corresponding HTTP responses.\n\n\nWe recommend the use of bundling tools like\n\nwebpack\n which offer the possibility to add such\nidentifier on the building step of the application packages for all assets.\n\n\nSources\n\n\nHere is the available sources, defined by the scheme of the source URL:\n\n\n\n\nregistry://\n: to install an application from the instance registries\n\n\ngit://\n or \ngit+ssh://\n: to install an application from a git repository\n\n\nhttp://\n or \nhttps://\n: to install an application from an http server (via a\n  tarball)\n\n\nfile://\n: to install an application from a local directory (for instance:\n  \nfile:///home/user/code/cozy-app\n)\n\n\n\n\nThe \nregistry\n scheme expect the following elements:\n\n\n\n\nscheme: \nregistry\n\n\nhost: the name of the application\n\n\npath: \n/:channel\n the channel of the application (see the\n  \nregistry\n doc)\n\n\n\n\nExamples: \nregistry://drive/stable\n, \nregistry://drive/beta\n, and\n\nregistry://drive/dev\n.\n\n\nFor the \ngit\n scheme, the fragment in the URL can be used to specify which\nbranch to install.\n\n\nFor the \nhttp\n and \nhttps\n schemes, the fragment can be used to give the\nexpected sha256sum.\n\n\nPOST /apps/:slug\n\n\nInstall an application, ie download the files and put them in \n/apps/:slug\n in\nthe virtual file system of the user, create an \nio.cozy.apps\n document, register\nthe permissions, etc.\n\n\nThis endpoint is asynchronous and returns a successful return as soon as the\napplication installation has started, meaning we have successfully reached the\nmanifest and started to fetch application data.\n\n\nTo make this endpoint synchronous, use the header \nAccept: text/event-stream\n.\nThis will make a eventsource stream sending the manifest and returning when the\napplication has been installed or failed.\n\n\nStatus codes\n\n\n\n\n202 Accepted, when the application installation has been accepted.\n\n\n400 Bad-Request, when the manifest of the application could not be processed\n  (for instance, it is not valid JSON).\n\n\n404 Not Found, when the manifest or the source of the application is not\n  reachable.\n\n\n422 Unprocessable Entity, when the sent data is invalid (for example, the slug\n  is invalid or the Source parameter is not a proper or supported url)\n\n\n\n\nQuery-String\n\n\n\n\n\n\n\n\nParameter\n\n\nDescription\n\n\n\n\n\n\n\n\n\n\nSource\n\n\nURL from where the app can be downloaded (only for install)\n\n\n\n\n\n\n\n\nRequest\n\n\nPOST /apps/emails?Source=git://github.com/cozy/cozy-emails.git HTTP/1.1\nAccept: application/vnd.api+json\n\n\n\n\nResponse\n\n\nHTTP/1.1 202 Accepted\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: [{\n    \nid\n: \n4cfbd8be-8968-11e6-9708-ef55b7c20863\n,\n    \ntype\n: \nio.cozy.apps\n,\n    \nmeta\n: {\n      \nrev\n: \n1-7a1f918147df94580c92b47275e4604a\n\n    },\n    \nattributes\n: {\n      \nname\n: \ncalendar\n,\n      \nstate\n: \ninstalling\n,\n      \nslug\n: \ncalendar\n,\n      ...\n    },\n    \nlinks\n: {\n      \nself\n: \n/apps/calendar\n\n    }\n  }]\n}\n\n\n\n\nNote\n: it\ns possible to choose a git branch by passing it in the fragment\nlike this:\n\n\nPOST /apps/emails-dev?Source=git://github.com/cozy/cozy-emails.git%23dev HTTP/1.1\n\n\n\n\nPUT /apps/:slug\n\n\nUpdate an application with the specified slug name.\n\n\nThis endpoint is asynchronous and returns a successful return as soon as the\napplication installation has started, meaning we have successfully reached the\nmanifest and started to fetch application data.\n\n\nTo make this endpoint synchronous, use the header \nAccept: text/event-stream\n.\nThis will make a eventsource stream sending the manifest and returning when the\napplication has been updated or failed.\n\n\nRequest\n\n\nPUT /apps/emails HTTP/1.1\nAccept: application/vnd.api+json\n\n\n\n\nResponse\n\n\nHTTP/1.1 202 Accepted\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: [{\n    \nid\n: \n4cfbd8be-8968-11e6-9708-ef55b7c20863\n,\n    \ntype\n: \nio.cozy.apps\n,\n    \nmeta\n: {\n      \nrev\n: \n1-7a1f918147df94580c92b47275e4604a\n\n    },\n    \nattributes\n: {\n      \nname\n: \ncalendar\n,\n      \nstate\n: \ninstalling\n,\n      \nslug\n: \ncalendar\n,\n      ...\n    },\n    \nlinks\n: {\n      \nself\n: \n/apps/calendar\n\n    }\n  }]\n}\n\n\n\n\nStatus codes\n\n\n\n\n202 Accepted, when the application installation has been accepted.\n\n\n400 Bad-Request, when the manifest of the application could not be processed\n  (for instance, it is not valid JSON).\n\n\n404 Not Found, when the application with the specified slug was not found or\n  when the manifest or the source of the application is not reachable.\n\n\n422 Unprocessable Entity, when the sent data is invalid (for example, the slug\n  is invalid or the Source parameter is not a proper or supported url)\n\n\n\n\nList installed applications\n\n\nGET /apps/\n\n\nAn application can be in one of these states:\n\n\n\n\ninstalled\n, the application is installed but still require some user\n  interaction to accept its permissions\n\n\nready\n, the user can use it\n\n\ninstalling\n, the installation is running and the app will soon be usable\n\n\nupgrading\n, a new version is being installed\n\n\nerrored\n, the app is in an error state and can not be used.\n\n\n\n\nRequest\n\n\nGET /apps/ HTTP/1.1\nAccept: application/vnd.api+json\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: [{\n    \nid\n: \n4cfbd8be-8968-11e6-9708-ef55b7c20863\n,\n    \ntype\n: \nio.cozy.apps\n,\n    \nmeta\n: {\n      \nrev\n: \n2-bbfb0fc32dfcdb5333b28934f195b96a\n\n    },\n    \nattributes\n: {\n      \nname\n: \ncalendar\n,\n      \nstate\n: \nready\n,\n      \nslug\n: \ncalendar\n,\n      ...\n    },\n    \nlinks\n: {\n      \nself\n: \n/apps/calendar\n,\n      \nicon\n: \n/apps/calendar/icon\n,\n      \nrelated\n: \nhttps://calendar.alice.example.com/\n\n    }\n  }]\n}\n\n\n\n\nGet informations about an application\n\n\nGET /apps/:slug\n\n\nGet the icon of an application\n\n\nGET /apps/:slug/icon\n\n\nRequest\n\n\nGET /apps/calendar/icon HTTP/1.1\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: image/svg+xml\n\n\n\n\nsvg xmlns=\nhttp://www.w3.org/2000/svg\n width=\n60\n height=\n60\n viewBox=\n0 0 60 60\n\n\ntitle\nCalendar\n/title\n\n\npath fill=\n#fff\n fill-opacity=\n.011\n d=\nM30 58.75c15.878 0 28.75-12.872 28.75-28.75s-12.872-28.75-28.75-28.75-28.75 12.872-28.75 28.75 12.872 28.75 28.75 28.75zm0 1.25c-16.569 0-30-13.432-30-30 0-16.569 13.431-30 30-30 16.568 0 30 13.431 30 30 0 16.568-13.432 30-30 30z\n/\n\n\npath d=\nM47.997 9h-35.993c-1.654 0-3.004 1.345-3.004 3.004v35.993c0 1.653 1.345 3.004 3.004 3.004h35.993c1.653 0 3.004-1.345 3.004-3.004v-35.993c0-1.654-1.345-3.004-3.004-3.004zm-35.997 3.035h4.148v2.257c0 .856.7 1.556 1.556 1.556s1.556-.7 1.556-1.556v-2.257h5.136v2.257c0 .856.7 1.556 1.556 1.556s1.556-.7 1.556-1.556v-2.257h5.137v2.257c0 .856.699 1.556 1.556 1.556s1.556-.7 1.556-1.556v-2.257h5.137v2.257c0 .856.699 1.556 1.556 1.556s1.556-.7 1.556-1.556v-2.257h3.992v6.965h-35.998v-6.965zm36 35.965h-36v-27h36v27zm-21.71-10.15c-.433.34-.997.51-1.69.51-.64 0-1.207-.137-1.7-.409-.493-.273-.933-.603-1.32-.99l-1.1 1.479c.453.508 1.027.934 1.72 1.28.693.347 1.56.521 2.6.521.613 0 1.19-.083 1.73-.25.54-.167 1.013-.407 1.42-.721.407-.312.727-.696.96-1.149.233-.453.35-.974.35-1.56 0-.841-.25-1.527-.75-2.061s-1.13-.9-1.89-1.1v-.08c.693-.268 1.237-.641 1.63-1.12.393-.48.59-1.08.59-1.8 0-.533-.1-1.01-.3-1.43-.2-.42-.48-.772-.84-1.06-.36-.287-.793-.503-1.3-.65-.507-.147-1.067-.22-1.68-.22-.76 0-1.45.147-2.07.44s-1.203.68-1.75 1.16l1.18 1.42c.387-.36.783-.65 1.19-.87.407-.22.863-.33 1.37-.33.587 0 1.047.15 1.38.45.333.3.5.717.5 1.25 0 .293-.057.566-.17.819-.113.253-.3.47-.56.65-.26.18-.6.319-1.02.42-.42.1-.943.149-1.57.149v1.681c.72 0 1.32.05 1.8.149.48.101.863.243 1.15.43.287.188.49.414.61.681.12.267.18.567.18.899 0 .602-.217 1.072-.65 1.412zm13.71.15h-3v-11h-2c-.4.24-.65.723-1.109.89-.461.167-1.25.49-1.891.61v1.5h3v8h-3v2h8v-2z\n/\n\n\n/svg\n\n\n\n\nUninstall an application\n\n\nDELETE /apps/:slug\n\n\nRequest\n\n\nDELETE /apps/tasky HTTP/1.1\n\n\n\n\nResponse\n\n\nHTTP/1.1 204 No Content\n\n\n\n\nAccess an application\n\n\nEach application will run on its sub-domain. The sub-domain is the slug used\nwhen installing the application (\ncalendar.cozy.example.org\n if it was installed\nvia a POST on /apps/calendar). On the main domain (\ncozy.example.org\n), there\nwill be the registration process, the login form, and it will redirect to\n\nhome.cozy.example.org\n for logged-in users.\n\n\nRationale\n\n\nThe applications have different roles and permissions. An application is\nidentified when talking to the stack via a token. The token has to be injected\nin the application, one way or another, and it have to be unaccessible from\nother apps.\n\n\nIf the applications run on the same domain (for example\n\nhttps://cozy.example.org/apps/calendar\n), it\ns nearly impossible to protect an\napplication to take the token of another application. The security model of the\nweb is based too heavily on\n\nSame Origin Policy\n\nfor that. If the token is put in the html of the index.html page of an app,\nanother app can use the fetch API to get the html page, parse its content and\nextract the token. We can think of other ways to inject the token (indexeddb,\nURL, cookies) but none will provide a better isolation. Maybe in a couple years,\nwhen \nthe origin spec\n will be more\nadvanced.\n\n\nSo, if having the apps on the same origin is not possible, we have to put them\non several origins. One interesting way to do that is using sandboxed iframes.\nAn iframe with\n\nthe sandbox attribute\n,\nand not \nallow-same-origin\n in it, will be assigned to a unique origin. The W3C\nwarns:\n\n\n\n\nPotentially hostile files should not be served from the same server as the\nfile containing the iframe element. Sandboxing hostile content is of minimal\nhelp if an attacker can convince the user to just visit the hostile content\ndirectly, rather than in the iframe. To limit the damage that can be caused by\nhostile HTML content, it should be served from a separate dedicated domain.\nUsing a different domain ensures that scripts in the files are unable to\nattack the site, even if the user is tricked into visiting those pages\ndirectly, without the protection of the sandbox attribute.\n\n\n\n\nIt may be possible to disable all html pages to have an html content-type,\nexcept the home, and having the home loading the apps in a sandboxed iframe, via\nthe \nsrcdoc\n attribute. But, it will mean that we will have to reinvent nearly\neverything. Even showing an image can no longer be done via an \nimg\n tag, it\nwill need to use post-message with the home. Such a solution is difficult to\nimplement, is a very fragile (both for the apps developer than for security) and\nis an hell to debug when it breaks. Clearly, it\ns not an acceptable solution.\n\n\nThus, the only choice is to have several origins, and sub-domains is the best\nway for that. Of course, it has the downside to be more complicated to deploy\n(DNS and TLS certificates). But, in the tradeoff between security and ease of\nadministration, we definetively take the security first.\n\n\nRoutes\n\n\n\n\nShould we be concerned that all the routes are on the same sub-domain?\n\n\n\n\nNo, it\ns not an issue. There are two types of routes: the ones that are publics\nand those reserved to the authenticated user. Public routes have no token\n\n\nPrivate routes are private, they can be accessed only with a valid session\ncookie, ie by the owner of the instance. Another application can\nt use the user\ncookies to read the token, because of the restrictions of the same origin policy\n(they are on different domains). And the application can\nt use an open proxy to\nread the private route, because it doesn\nt have the user cookies for that (the\ncookie is marked as \nhttpOnly\n).", 
            "title": "/apps - Applications Management"
        }, 
        {
            "location": "/cozy-stack/apps/#applications", 
            "text": "It s possible to manage serverless applications from the cozy stack and serve\nthem via cozy stack. The stack does the routing and serve the HTML and the\nassets for the applications. The assets of the applications are installed in the\nvirtual file system.", 
            "title": "Applications"
        }, 
        {
            "location": "/cozy-stack/apps/#install-an-application", 
            "text": "", 
            "title": "Install an application"
        }, 
        {
            "location": "/cozy-stack/apps/#the-manifest", 
            "text": "To install an application, cozy needs a manifest. It s a JSON document that\ndescribes the application (its name and icon for example), how to install it and\nwhat it needs for its usage (the permissions in particular). While we have\nconsidered to use the same manifest format as the W3C for PWAs , it\ndidn t match our expectations. The manifest format for FirefoxOS \nis a better fit. We took a lot of inspirations from it, starting with the\nfilename for this file:  manifest.webapp .     Field  Description      name  the name to display on the home    name_prefix  the prefix to display with the name    slug  the default slug (it can be changed at install time)    editor  the editor s name to display on the cozy-bar of the app    icon  an icon for the home    screenshots  an array of path to the screenshots of the application    category  the category of the application    short_description  a short description of the application    long_description  a long description of the application    source  where the files of the app can be downloaded    developer  name  and  url  for the developer    locales  translations of the name and description fields in other locales    langs  list of languages tags supported by the application    version  the current version number    license  the SPDX license identifier    platforms  a list of  type ,  url  values for derivate of the application for other devices    intents  a list of intents provided by this app (see  here  for more details)    permissions  a map of permissions needed by the app (see  here  for more details)    notifications  a map of notifications needed by the app (see  here  for more details)    services  a map of the services associated with the app (see below for more details)    routes  a map of routes for the app (see below for more details)", 
            "title": "The manifest"
        }, 
        {
            "location": "/cozy-stack/apps/#routes", 
            "text": "A route make the mapping between the requested paths and the files. It can have\nan index, which is an HTML file, with a token injected on it that identify both\nthe application. This token must be used with the user cookies to use the\nservices of the cozy-stack.  By default, a route can be only visited by the authenticated owner of the\ninstance where the app is installed. But a route can be marked as public. In\nthat case, anybody can visit the route.  For example, an application can offer an administration interface on  /admin , a\npublic page on  /public , and shared assets in  /assets :  {\n   /admin : {\n     folder :  / ,\n     index :  admin.html ,\n     public : false\n  },\n   /public : {\n     folder :  /public ,\n     index :  index.html ,\n     public : true\n  },\n   /assets : {\n     folder :  /assets ,\n     public : true\n  }\n}  If an application has no routes in its manifest, the stack will create one\nroute, this default one:  {\n   / : {\n     folder :  / ,\n     index :  index.html ,\n     public : false\n  }\n}  Note : if you have a public route, it s probably better to put the app icon\nin it. So, the cozy-bar can display it for the users that go on the public part\nof the app.", 
            "title": "Routes"
        }, 
        {
            "location": "/cozy-stack/apps/#services", 
            "text": "Application may require background and offline process to analyse the user s\ndata and emit some notification or warning even without the user being on the\napplication. These part of the application are called services and can be\ndeclared as part of the application in its manifest.  In contrast to  konnectors , services have the same\npermissions as the web application and are not intended to collect outside\ninformations but rather analyse the current set of collected information\ninside the cozy. However they share the same mechanisms as the konnectors to\ndescribe how and when they should be executed: via our trigger system.  To define a service, first the code needs to be stored with the application\ncontent, as single (packaged) javascript files. In the manifest, declare the\nservice and its parameters following this example:  {\n   services : {\n     low-budget-notification : {\n       type :  node ,\n       file :  /services/low-budget-notification.js ,\n       trigger :  @cron 0 0 0 * * * \n    }\n    // ...\n  }\n}  The  trigger  field should follow the available triggers described in the jobs documentation . The  file  field should specify the service\ncode run and the  type  field describe the code type (only  \"node\"  for now).", 
            "title": "Services"
        }, 
        {
            "location": "/cozy-stack/apps/#notifications", 
            "text": "For more informations on how te declare notifications in the manifest, see\nthe  notifications documentation .  Here is an example:  {\n   notifications : {\n     account-balance : {\n       description :  Alert the user when its account balance is negative ,\n       collapsible : true, // only interested in the last value of the notification\n       multiple : true, // require sub-categories for each account\n       stateful : false,\n       default_priority :  high , // high priority for this notification\n       templates : {\n         mail :  file:./notifications/account-balance-mail.tpl \n      }\n    }\n  }\n}", 
            "title": "Notifications"
        }, 
        {
            "location": "/cozy-stack/apps/#resource-caching", 
            "text": "To help caching of applications assets, we detect the presence of a unique\nidentifier in the name of assets: a unique identifier is matched when the file\nbase name contains a long hexadecimal subpart between  . , of at least 10\ncharacters. For instance  app.badf00dbadf00d.js  or  icon.badbeefbadbeef.1.png .  With such a unique identifier, the asset is considered immutable, and a long\ncache-control is added on corresponding HTTP responses.  We recommend the use of bundling tools like webpack  which offer the possibility to add such\nidentifier on the building step of the application packages for all assets.", 
            "title": "Resource caching"
        }, 
        {
            "location": "/cozy-stack/apps/#sources", 
            "text": "Here is the available sources, defined by the scheme of the source URL:   registry:// : to install an application from the instance registries  git://  or  git+ssh:// : to install an application from a git repository  http://  or  https:// : to install an application from an http server (via a\n  tarball)  file:// : to install an application from a local directory (for instance:\n   file:///home/user/code/cozy-app )   The  registry  scheme expect the following elements:   scheme:  registry  host: the name of the application  path:  /:channel  the channel of the application (see the\n   registry  doc)   Examples:  registry://drive/stable ,  registry://drive/beta , and registry://drive/dev .  For the  git  scheme, the fragment in the URL can be used to specify which\nbranch to install.  For the  http  and  https  schemes, the fragment can be used to give the\nexpected sha256sum.", 
            "title": "Sources"
        }, 
        {
            "location": "/cozy-stack/apps/#post-appsslug", 
            "text": "Install an application, ie download the files and put them in  /apps/:slug  in\nthe virtual file system of the user, create an  io.cozy.apps  document, register\nthe permissions, etc.  This endpoint is asynchronous and returns a successful return as soon as the\napplication installation has started, meaning we have successfully reached the\nmanifest and started to fetch application data.  To make this endpoint synchronous, use the header  Accept: text/event-stream .\nThis will make a eventsource stream sending the manifest and returning when the\napplication has been installed or failed.", 
            "title": "POST /apps/:slug"
        }, 
        {
            "location": "/cozy-stack/apps/#status-codes", 
            "text": "202 Accepted, when the application installation has been accepted.  400 Bad-Request, when the manifest of the application could not be processed\n  (for instance, it is not valid JSON).  404 Not Found, when the manifest or the source of the application is not\n  reachable.  422 Unprocessable Entity, when the sent data is invalid (for example, the slug\n  is invalid or the Source parameter is not a proper or supported url)", 
            "title": "Status codes"
        }, 
        {
            "location": "/cozy-stack/apps/#query-string", 
            "text": "Parameter  Description      Source  URL from where the app can be downloaded (only for install)", 
            "title": "Query-String"
        }, 
        {
            "location": "/cozy-stack/apps/#request", 
            "text": "POST /apps/emails?Source=git://github.com/cozy/cozy-emails.git HTTP/1.1\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/apps/#response", 
            "text": "HTTP/1.1 202 Accepted\nContent-Type: application/vnd.api+json  {\n   data : [{\n     id :  4cfbd8be-8968-11e6-9708-ef55b7c20863 ,\n     type :  io.cozy.apps ,\n     meta : {\n       rev :  1-7a1f918147df94580c92b47275e4604a \n    },\n     attributes : {\n       name :  calendar ,\n       state :  installing ,\n       slug :  calendar ,\n      ...\n    },\n     links : {\n       self :  /apps/calendar \n    }\n  }]\n}  Note : it s possible to choose a git branch by passing it in the fragment\nlike this:  POST /apps/emails-dev?Source=git://github.com/cozy/cozy-emails.git%23dev HTTP/1.1", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/apps/#put-appsslug", 
            "text": "Update an application with the specified slug name.  This endpoint is asynchronous and returns a successful return as soon as the\napplication installation has started, meaning we have successfully reached the\nmanifest and started to fetch application data.  To make this endpoint synchronous, use the header  Accept: text/event-stream .\nThis will make a eventsource stream sending the manifest and returning when the\napplication has been updated or failed.", 
            "title": "PUT /apps/:slug"
        }, 
        {
            "location": "/cozy-stack/apps/#request_1", 
            "text": "PUT /apps/emails HTTP/1.1\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/apps/#response_1", 
            "text": "HTTP/1.1 202 Accepted\nContent-Type: application/vnd.api+json  {\n   data : [{\n     id :  4cfbd8be-8968-11e6-9708-ef55b7c20863 ,\n     type :  io.cozy.apps ,\n     meta : {\n       rev :  1-7a1f918147df94580c92b47275e4604a \n    },\n     attributes : {\n       name :  calendar ,\n       state :  installing ,\n       slug :  calendar ,\n      ...\n    },\n     links : {\n       self :  /apps/calendar \n    }\n  }]\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/apps/#status-codes_1", 
            "text": "202 Accepted, when the application installation has been accepted.  400 Bad-Request, when the manifest of the application could not be processed\n  (for instance, it is not valid JSON).  404 Not Found, when the application with the specified slug was not found or\n  when the manifest or the source of the application is not reachable.  422 Unprocessable Entity, when the sent data is invalid (for example, the slug\n  is invalid or the Source parameter is not a proper or supported url)", 
            "title": "Status codes"
        }, 
        {
            "location": "/cozy-stack/apps/#list-installed-applications", 
            "text": "", 
            "title": "List installed applications"
        }, 
        {
            "location": "/cozy-stack/apps/#get-apps", 
            "text": "An application can be in one of these states:   installed , the application is installed but still require some user\n  interaction to accept its permissions  ready , the user can use it  installing , the installation is running and the app will soon be usable  upgrading , a new version is being installed  errored , the app is in an error state and can not be used.", 
            "title": "GET /apps/"
        }, 
        {
            "location": "/cozy-stack/apps/#request_2", 
            "text": "GET /apps/ HTTP/1.1\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/apps/#response_2", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json  {\n   data : [{\n     id :  4cfbd8be-8968-11e6-9708-ef55b7c20863 ,\n     type :  io.cozy.apps ,\n     meta : {\n       rev :  2-bbfb0fc32dfcdb5333b28934f195b96a \n    },\n     attributes : {\n       name :  calendar ,\n       state :  ready ,\n       slug :  calendar ,\n      ...\n    },\n     links : {\n       self :  /apps/calendar ,\n       icon :  /apps/calendar/icon ,\n       related :  https://calendar.alice.example.com/ \n    }\n  }]\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/apps/#get-informations-about-an-application", 
            "text": "", 
            "title": "Get informations about an application"
        }, 
        {
            "location": "/cozy-stack/apps/#get-appsslug", 
            "text": "", 
            "title": "GET /apps/:slug"
        }, 
        {
            "location": "/cozy-stack/apps/#get-the-icon-of-an-application", 
            "text": "", 
            "title": "Get the icon of an application"
        }, 
        {
            "location": "/cozy-stack/apps/#get-appsslugicon", 
            "text": "", 
            "title": "GET /apps/:slug/icon"
        }, 
        {
            "location": "/cozy-stack/apps/#request_3", 
            "text": "GET /apps/calendar/icon HTTP/1.1", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/apps/#response_3", 
            "text": "HTTP/1.1 200 OK\nContent-Type: image/svg+xml  svg xmlns= http://www.w3.org/2000/svg  width= 60  height= 60  viewBox= 0 0 60 60  title Calendar /title  path fill= #fff  fill-opacity= .011  d= M30 58.75c15.878 0 28.75-12.872 28.75-28.75s-12.872-28.75-28.75-28.75-28.75 12.872-28.75 28.75 12.872 28.75 28.75 28.75zm0 1.25c-16.569 0-30-13.432-30-30 0-16.569 13.431-30 30-30 16.568 0 30 13.431 30 30 0 16.568-13.432 30-30 30z /  path d= M47.997 9h-35.993c-1.654 0-3.004 1.345-3.004 3.004v35.993c0 1.653 1.345 3.004 3.004 3.004h35.993c1.653 0 3.004-1.345 3.004-3.004v-35.993c0-1.654-1.345-3.004-3.004-3.004zm-35.997 3.035h4.148v2.257c0 .856.7 1.556 1.556 1.556s1.556-.7 1.556-1.556v-2.257h5.136v2.257c0 .856.7 1.556 1.556 1.556s1.556-.7 1.556-1.556v-2.257h5.137v2.257c0 .856.699 1.556 1.556 1.556s1.556-.7 1.556-1.556v-2.257h5.137v2.257c0 .856.699 1.556 1.556 1.556s1.556-.7 1.556-1.556v-2.257h3.992v6.965h-35.998v-6.965zm36 35.965h-36v-27h36v27zm-21.71-10.15c-.433.34-.997.51-1.69.51-.64 0-1.207-.137-1.7-.409-.493-.273-.933-.603-1.32-.99l-1.1 1.479c.453.508 1.027.934 1.72 1.28.693.347 1.56.521 2.6.521.613 0 1.19-.083 1.73-.25.54-.167 1.013-.407 1.42-.721.407-.312.727-.696.96-1.149.233-.453.35-.974.35-1.56 0-.841-.25-1.527-.75-2.061s-1.13-.9-1.89-1.1v-.08c.693-.268 1.237-.641 1.63-1.12.393-.48.59-1.08.59-1.8 0-.533-.1-1.01-.3-1.43-.2-.42-.48-.772-.84-1.06-.36-.287-.793-.503-1.3-.65-.507-.147-1.067-.22-1.68-.22-.76 0-1.45.147-2.07.44s-1.203.68-1.75 1.16l1.18 1.42c.387-.36.783-.65 1.19-.87.407-.22.863-.33 1.37-.33.587 0 1.047.15 1.38.45.333.3.5.717.5 1.25 0 .293-.057.566-.17.819-.113.253-.3.47-.56.65-.26.18-.6.319-1.02.42-.42.1-.943.149-1.57.149v1.681c.72 0 1.32.05 1.8.149.48.101.863.243 1.15.43.287.188.49.414.61.681.12.267.18.567.18.899 0 .602-.217 1.072-.65 1.412zm13.71.15h-3v-11h-2c-.4.24-.65.723-1.109.89-.461.167-1.25.49-1.891.61v1.5h3v8h-3v2h8v-2z /  /svg", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/apps/#uninstall-an-application", 
            "text": "", 
            "title": "Uninstall an application"
        }, 
        {
            "location": "/cozy-stack/apps/#delete-appsslug", 
            "text": "", 
            "title": "DELETE /apps/:slug"
        }, 
        {
            "location": "/cozy-stack/apps/#request_4", 
            "text": "DELETE /apps/tasky HTTP/1.1", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/apps/#response_4", 
            "text": "HTTP/1.1 204 No Content", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/apps/#access-an-application", 
            "text": "Each application will run on its sub-domain. The sub-domain is the slug used\nwhen installing the application ( calendar.cozy.example.org  if it was installed\nvia a POST on /apps/calendar). On the main domain ( cozy.example.org ), there\nwill be the registration process, the login form, and it will redirect to home.cozy.example.org  for logged-in users.", 
            "title": "Access an application"
        }, 
        {
            "location": "/cozy-stack/apps/#rationale", 
            "text": "The applications have different roles and permissions. An application is\nidentified when talking to the stack via a token. The token has to be injected\nin the application, one way or another, and it have to be unaccessible from\nother apps.  If the applications run on the same domain (for example https://cozy.example.org/apps/calendar ), it s nearly impossible to protect an\napplication to take the token of another application. The security model of the\nweb is based too heavily on Same Origin Policy \nfor that. If the token is put in the html of the index.html page of an app,\nanother app can use the fetch API to get the html page, parse its content and\nextract the token. We can think of other ways to inject the token (indexeddb,\nURL, cookies) but none will provide a better isolation. Maybe in a couple years,\nwhen  the origin spec  will be more\nadvanced.  So, if having the apps on the same origin is not possible, we have to put them\non several origins. One interesting way to do that is using sandboxed iframes.\nAn iframe with the sandbox attribute ,\nand not  allow-same-origin  in it, will be assigned to a unique origin. The W3C\nwarns:   Potentially hostile files should not be served from the same server as the\nfile containing the iframe element. Sandboxing hostile content is of minimal\nhelp if an attacker can convince the user to just visit the hostile content\ndirectly, rather than in the iframe. To limit the damage that can be caused by\nhostile HTML content, it should be served from a separate dedicated domain.\nUsing a different domain ensures that scripts in the files are unable to\nattack the site, even if the user is tricked into visiting those pages\ndirectly, without the protection of the sandbox attribute.   It may be possible to disable all html pages to have an html content-type,\nexcept the home, and having the home loading the apps in a sandboxed iframe, via\nthe  srcdoc  attribute. But, it will mean that we will have to reinvent nearly\neverything. Even showing an image can no longer be done via an  img  tag, it\nwill need to use post-message with the home. Such a solution is difficult to\nimplement, is a very fragile (both for the apps developer than for security) and\nis an hell to debug when it breaks. Clearly, it s not an acceptable solution.  Thus, the only choice is to have several origins, and sub-domains is the best\nway for that. Of course, it has the downside to be more complicated to deploy\n(DNS and TLS certificates). But, in the tradeoff between security and ease of\nadministration, we definetively take the security first.", 
            "title": "Rationale"
        }, 
        {
            "location": "/cozy-stack/apps/#routes_1", 
            "text": "Should we be concerned that all the routes are on the same sub-domain?   No, it s not an issue. There are two types of routes: the ones that are publics\nand those reserved to the authenticated user. Public routes have no token  Private routes are private, they can be accessed only with a valid session\ncookie, ie by the owner of the instance. Another application can t use the user\ncookies to read the token, because of the restrictions of the same origin policy\n(they are on different domains). And the application can t use an open proxy to\nread the private route, because it doesn t have the user cookies for that (the\ncookie is marked as  httpOnly ).", 
            "title": "Routes"
        }, 
        {
            "location": "/cozy-stack/registry/", 
            "text": "Apps registry\n\n\nThe apps registry is a place where developers can submit their applications,\nboth web apps and konnectors. The applications metadata are stored and\nversioned. It can be used by a cozy to list applications to be installed, and\nfor auto-updating the applications.\n\n\nWe define the applications registry as an API. This should allow us to defer the\nreal implementation of the registry storage and allow different store\nimplementations.\n\n\nThe stack itself implement the\n\nquerying part of the registry API\n, proxying the\nrequest to\n\nthe registries attached to the instance\n.\n\n\nPublishing on our official registries\n\n\nIn order for you to publish on our official registries, please follow\n\nthis howto\n describing how to obtain a token and\nparameter you repository to automatically publish versions.\n\n\nChannels\n\n\nWe differentiate three channels of release for each application:\n\n\n\n\nstable: for stable releases\n\n\nbeta: for application that can be tested in advance\n\n\ndev: for the latest releases directly from the trunk of the repository\n\n\n\n\nFor each of these channels, the version string has a different format which\ndifferentiate the version channel:\n\n\n\n\nstable: \nX.Y.Z\n where \nX\n, \nY\n and \nZ\n are positive or null integers.\n\n\nbeta: \nX.Y.Z-beta.M\n where \nX\n, \nY\n, \nZ\n and \nM\n are positive or null integers\n\n\ndev: \nX.Y.Z-dev.checksum\n where \nX\n, \nY\n and \nZ\n are positive or null integers\n  and \nchecksum\n is a unique identifier of the dev release (typically a shasum\n  of the git commit)\n\n\n\n\nVersion order\n\n\nTLDR: 1.0.0-dev.\n \n 1.0.0 and 1.0.0-beta.\n \n 1.0.0, make sure you upgrade your\napp version after publishing stable.\n\n\nThe order used to determine the latest version of a channel is the following:\n\n\n- `1.0.0-dev.*  \n 1.0.0 (dev \n stable)`\n- `1.0.0-beta.* \n 1.0.0 (beta \n stable)`\n- `1.0.0-beta.1 \n 1.0.0-beta.2`\n\n\n\n\nTo order beta and dev releases, we apply a sort by their creation date.\n\n\nObjects\n\n\nTwo types of objects are managed in the registry: applications and versions.\n\n\nApplication\n\n\nAn application described a specific package. It is linked to multiple versions\n(releases) of the application.\n\n\nAn application object is \nmutable\n.\n\n\nAn application object contains the following fields:\n\n\n\n\nslug\n: the application slug (unique)\n\n\ntype\n: the application type (\nwebapp\n or \nkonnector\n)\n\n\neditor\n: the application editor name\n\n\nname\n: object containing a human readable name for the application in\n  multiple languages\n\n\ndescription\n: object containing the description description of the\n  application in multiple languages\n\n\ncategory\n: the application category\n\n\nrepository\n: object with type and URL of package repository\n\n\nlocales\n: list of locales supported by the application\n\n\ntags\n: list of tags associated with the application\n\n\nscreenshots\n: array of screenshots filenames\n\n\nversions\n: an object containing all the channels versions\n\n\n\n\nExample:\n\n\n{\n  \nslug\n: \ndrive\n,\n  \ntype\n: \nwebapp\n,\n  \neditor\n: \ncozy\n,\n  \nname\n: {\n    \nen\n: \nDrive\n,\n    \nfr\n: \nDrive\n\n  },\n  \ndescription\n: {\n    \nen\n: \nThe drive application\n,\n    \nfr\n: \nL'application drive gestionnaire de fichier\n\n  },\n  \ncategory\n: \nmain\n,\n  \nrepository\n: \nhttps://github.com/cozy/cozy-drive\n,\n  \nlocales\n: [\nen\n, \nfr\n],\n  \ntags\n: [\nfoo\n, \nbar\n, \nbaz\n],\n  \nscreenshots\n: [\nscreen1.jpg\n, \nscreen2.jpg\n],\n  \nversions\n: {\n    \nstable\n: [\n3.1.1\n],\n    \nbeta\n: [\n3.1.1-beta.1\n],\n    \ndev\n: [\n3.1.1-dev.7a8354f74b50d7beead7719252a18ed45f55d070\n]\n  }\n}\n\n\n\n\nVersion\n\n\nA version object describe a specific release of an application.\n\n\nA version object is \nimmutable\n.\n\n\nAn application version object contains the following fields:\n\n\n\n\nslug\n: the application slug\n\n\ntype\n: the application type (webapp, konnector, \n)\n\n\nmanifest\n: the \nentire\n\n  \nmanifest\n defined in the package\n\n\ncreated_at\n: date of the release creation\n\n\nurl\n: URL of the tarball containing the application at specified version\n\n\nsize\n: the size of the application package (uncompressed) in bytes as string\n\n\nsha256\n: the sha256 checksum of the application content\n\n\ntar_prefix\n: optional tar prefix directory specified to properly extract the\n  application content\n\n\n\n\nThe version string should follow the channels rule.\n\n\nExample:\n\n\n{\n  \nslug\n: \ndrive\n,\n  \ntype\n: \nwebapp\n,\n  \nversion\n: \n3.1.2\n,\n  \ncreated_at\n: \n2017-07-05T07:54:40.982Z\n,\n  \nurl\n: \nhttp://.../3.1.2\n,\n  \nsize\n: \n1000\n,\n  \nsha256\n: \n466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f\n,\n  \nmanifest\n: {\n    /* ... */\n  }\n}\n\n\n\n\nAPIs: Adding to registry\n\n\nThese APIs can be used to add elements to the registry.\n\n\nPOST /registry/:app\n\n\nThis route adds or modify an application to the registry. The content of the\nrequest should be a json object of an application.\n\n\nStatus codes\n\n\n\n\n201 Created, when the application has been successfully added\n\n\n409 Conflict, when an application with the same slug already exists\n\n\n400 Bad request, if the given application data is malformed (bad slug, missing\n  editor, \n)\n\n\n\n\nRequest\n\n\nPOST /registry/drive HTTP/1.1\nAuthorization: Token AbCdE\n\n\n\n\n{\n  \nslug\n: \ndrive\n,\n  \neditor\n: \ncozy\n,\n  \nname\n: {\n    \nen\n: \nDrive\n,\n    \nfr\n: \nDrive\n\n  },\n  \ndescription\n: {\n    \nen\n: \nThe drive application\n\n  },\n  \nrepository\n: \nhttps://github.com/cozy/cozy-drive\n,\n  \ntags\n: [\nfoo\n, \nbar\n, \nbaz\n]\n}\n\n\n\n\nPOST /registry/:app/:version or POST /registry/:app/versions\n\n\nThis route adds a version of an application to the registry to the specified\nchannel (stable, beta or dev).\n\n\nThe content of the manifest file extracted from the application data is used to\nfill the fields of the version. Before adding the application version to the\nregistry, the registry should check the following:\n\n\n\n\nthe \nmanifest\n file contained in the tarball should be checked and have its\n  fields checked against the application properties\n\n\nthe application content should check the sha256 checksum\n\n\n\n\nFields of the object sent to this request:\n\n\n\n\nurl\n: the url where the application tarball is stored\n\n\nsha256\n: the sha256 checksum of the tarball\n\n\nversion\n: the version value (should match the one in the manifest)\n\n\nparameters?\n: an optional json value (any) that will override the\n  \nparameters\n field of the manifest\n\n\nicon?\n: an optional path to override the \nicon\n field of the manifest\n\n\nscreenshots?\n: and optional array of path to override the \nscreenshots\n field\n  of the manifest\n\n\n\n\nStatus codes\n\n\n\n\n201 Created, when the version has been successfully added to the registry\n\n\n409 Conflict, when the version already exists\n\n\n404 Not Found, when the application does not exist\n\n\n412 Precondition Failed, when the sent application data is invalid (could not\n  fetch data URL, bad checksum, bad manifest in the tarball\n)\n\n\n400 Bad request, when the request is invalid (bad checksum encoding, bad\n  URL\n)\n\n\n\n\nRequest\n\n\nRequest to add a stable release:\n\n\nPOST /registry/drive/3.1.2 HTTP/1.1\nAuthorization: Token AbCdE\n\n\n\n\n{\n  \nversion\n: \n3.1.2\n,\n  \nurl\n: \nhttps://github.com/cozy/cozy-drive/archive/v3.1.2.tar.gz\n,\n  \nsha256\n: \n466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f\n\n}\n\n\n\n\nRequest to add a development release:\n\n\nPOST /registry/drive/3.1.2-dev.7a1618dff78ba445650f266bbe334cbc9176f03a HTTP/1.1\nAuthorization: Token AbCdE\n\n\n\n\n{\n  \nversion\n: \n3.1.2-dev.7a1618dff78ba445650f266bbe334cbc9176f03a\n,\n  \nurl\n:\n    \nhttps://github.com/cozy/cozy-photos-v3/archive/7a1618dff78ba445650f266bbe334cbc9176f03a.zip\n,\n  \nsha256\n: \n466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f\n\n}\n\n\n\n\nRequest to add a version with optional parameters:\n\n\nPOST /registry/drive/3.1.2 HTTP/1.1\nAuthorization: Token AbCdE\n\n\n\n\n{\n  \nversion\n: \n3.1.2\n,\n  \nurl\n:\n    \nhttps://github.com/cozy/cozy-photos-v3/archive/7a1618dff78ba445650f266bbe334cbc9176f03a.zip\n,\n  \nsha256\n: \n466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f\n,\n  \nparameters\n: { \nfoo\n: \nbar\n, \nbaz\n: 123 }\n}\n\n\n\n\nResponse\n\n\nHTTP/1.1 201 Created\nContent-Type: application/json\nLocation: http://.../3.1.2\n\n\n\n\n{\n  \nslug\n: \ndrive\n,\n  \ntype\n: \nwebapp\n,\n  \nversion\n: \n3.1.2-dev.7a1618dff78ba445650f266bbe334cbc9176f03a\n,\n  \ncreated_at\n: \n2017-07-05T07:54:40.982Z\n,\n  \nurl\n: \nhttp://.../7a1618dff78ba445650f266bbe334cbc9176f03a.zip\n,\n  \nsize\n: \n1000\n,\n  \nsha256\n: \n466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f\n,\n  \nmanifest\n: {\n    /* ... */\n  }\n}\n\n\n\n\nAPIs: Querying registry\n\n\nThese routes define the querying part of a registry to access to the available\napplications and versions. These APIs are also implemented directly by the\ncozy-stack.\n\n\nGET /registry\n\n\nGet the list of all applications.\n\n\nA pagination scheme is available via the \nlimit\n and \ncursor\n query parameter.\nThe \nfilter[???]\n query parameters can be used to filter by fields values.\n\n\nFiltering is allowed on the following fields:\n\n\n\n\ntype\n\n\neditor\n\n\ncategory\n\n\ntags\n\n\n\n\nFiltering is allowed on multiple tags with the \n,\n separator. For example:\n\nfilter[tags]=foo,bar\n will match the applications with both \nfoo\n and \nbar\n as\ntags.\n\n\nSorting is allowed on the following fields:\n\n\n\n\nslug\n\n\ntype\n\n\neditor\n\n\ncategory\n\n\ncreated_at\n\n\nupdated_at\n\n\n\n\nQuery-String\n\n\n\n\n\n\n\n\nParameter\n\n\nDescription\n\n\n\n\n\n\n\n\n\n\ncursor\n\n\nthe cursor of the last application on the previous page\n\n\n\n\n\n\nlimit\n\n\nthe maximum number of applications to show\n\n\n\n\n\n\nfilter[]\n\n\na filter to apply on fields of the application\n\n\n\n\n\n\nsort\n\n\nname of the field on which to apply the sort of the list\n\n\n\n\n\n\n\n\nRequest\n\n\nGET /registry?filter[category]=main\nlimit=20\nsort=slug HTTP/1.1\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/json\n\n\n\n\n{\n  \ndata\n: [\n    {\n      \nslug\n: \ndrive\n,\n      \ntype\n: \nwebapp\n,\n      \neditor\n: \ncozy\n,\n      \ncategory\n: \nmain\n,\n      \ndescription\n: \nThe drive application\n,\n      \nversions\n: {\n        \nstable\n: [\n3.1.1\n],\n        \nbeta\n: [\n3.1.1-beta.1\n],\n        \ndev\n: [\n3.1.1-dev.7a8354f74b50d7beead7719252a18ed45f55d070\n]\n      },\n      \nrepository\n: \nhttps://github.com/cozy/cozy-drive\n,\n      \nlicense\n: \nBSD\n\n    },\n    {\n      // ...\n    }\n  ],\n  \nmeta\n: {\n    \ncount\n: 2,\n    \nnext_cursor\n: \n...\n\n  }\n}\n\n\n\n\nGET /registry/:app\n\n\nGet an application object by slug.\n\n\nRequest\n\n\nGET /registry/drive HTTP/1.1\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/json\n\n\n\n\n{\n  \nslug\n: \ndrive\n,\n  \neditor\n: \ncozy\n,\n  \ndescription\n: \nThe drive application\n,\n  \nrepository\n: \nhttps://github.com/cozy/cozy-drive\n,\n  \ntags\n: [\nfoo\n, \nbar\n, \nbaz\n],\n  \nversions\n: {\n    \nstable\n: [\n3.1.1\n],\n    \nbeta\n: [\n3.1.1-beta.1\n],\n    \ndev\n: [\n3.1.1-dev.7a8354f74b50d7beead7719252a18ed45f55d070\n]\n  }\n}\n\n\n\n\nGET /registry/:app/icon\n\n\nGet the current application icon.\n\n\nRequest\n\n\nGET /registry/drive/icon HTTP/1.1\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: image/svg+xml\n\n\nsvg xmlns=\nhttp://www.w3.org/2000/svg\n width=\n64\n height=\n64\n viewBox=\n0 0 64 64\n\n  \ng fill=\nnone\n fill-rule=\nevenodd\n/g\n\n\n/svg\n\n\n\n\nGET /registry/:app/screenshots/:filename\n\n\nGet the screenshot with the specified filename from the field \nscreenshots\n of\nthe application.\n\n\nRequest\n\n\nGET /registry/drive/screenshots/screen1.jpg HTTP/1.1\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: image/jpeg\n\n...\n\n\n\n\nGET /registry/:app/:version\n\n\nGet an application version.\n\n\nRequest\n\n\nGET /registry/drive/3.1.1 HTTP/1.1\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/json\n\n\n\n\n{\n  \nslug\n: \ndrive\n,\n  \ntype\n: \nwebapp\n,\n  \nversion\n: \n3.1.1\n,\n  \nurl\n: \nhttp://.../3.1.1\n,\n  \nsha256\n: \n466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f\n,\n  \nsize\n: \n1000\n,\n  \ncreated_at\n: \n2017-07-05T07:54:40.982Z\n,\n  \nmanifest\n: {\n    /* ... */\n  }\n}\n\n\n\n\nGET /registry/:app/:channel/latest\n\n\nGet the latest version available on the specified channel.\n\n\nRequest\n\n\nGET /registry/drive/dev/latest HTTP/1.1\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/json\n\n\n\n\n{\n  \nslug\n: \ndrive\n,\n  \ntype\n: \nwebapp\n,\n  \nversion\n: \n3.1.1\n,\n  \nurl\n: \nhttp://.../3.1.1\n,\n  \nsha256\n: \n466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f\n,\n  \nsize\n: \n1000\n,\n  \ncreated_at\n: \n2017-07-05T07:54:40.982Z\n,\n  \nmanifest\n: {\n    /* ... */\n  }\n}\n\n\n\n\nAttaching a cozy-stack to a registry or a list of registries\n\n\nIn the configuration file of a stack, a \nregistries\n namespace is added. This\nnamespace can contain a list of URL for the different registries attached to the\nstack.\n\n\nThe stack itself implements the querying API of a registry. When querying this\nAPI, to ask for an application, the stack uses this hierarchy of registries to\nproxy or redirect the user.\n\n\nThe hierarchy can also be contextualised to specify different registries to\ndifferent contexts. The \ndefault\n context is applied lastly.\n\n\nExamples:\n\n\nregistries:\n  - https://myregistry.home/\n  - https://main.registry.cozy.io/\n\n\n\n\n# In this example, a \ncontext1\n instance will have the equivalent of the\n# following list of registries:\n#\n#   - https://context1.registry.cozy.io/\n#   - https://myregistry.home/\n#   - https://registry.cozy.io/\n#\n\nregistries:\n  context1:\n    - https://context1.registry.cozy.io/\n\n  context2:\n    - https://context2.registry.cozy.io/\n\n  default:\n    - https://myregistry.home/\n    - https://registry.cozy.io/\n\n\n\n\nAuthentication\n\n\nThe authentication is based on a token that allow you to publish applications\nand versions with for one specific editor name. This token is base64 encoded.\n\n\nIn order to receive this token, please take a look at the page on\n\npublication on the registry\n.", 
            "title": "Apps registry"
        }, 
        {
            "location": "/cozy-stack/registry/#apps-registry", 
            "text": "The apps registry is a place where developers can submit their applications,\nboth web apps and konnectors. The applications metadata are stored and\nversioned. It can be used by a cozy to list applications to be installed, and\nfor auto-updating the applications.  We define the applications registry as an API. This should allow us to defer the\nreal implementation of the registry storage and allow different store\nimplementations.  The stack itself implement the querying part of the registry API , proxying the\nrequest to the registries attached to the instance .", 
            "title": "Apps registry"
        }, 
        {
            "location": "/cozy-stack/registry/#publishing-on-our-official-registries", 
            "text": "In order for you to publish on our official registries, please follow this howto  describing how to obtain a token and\nparameter you repository to automatically publish versions.", 
            "title": "Publishing on our official registries"
        }, 
        {
            "location": "/cozy-stack/registry/#channels", 
            "text": "We differentiate three channels of release for each application:   stable: for stable releases  beta: for application that can be tested in advance  dev: for the latest releases directly from the trunk of the repository   For each of these channels, the version string has a different format which\ndifferentiate the version channel:   stable:  X.Y.Z  where  X ,  Y  and  Z  are positive or null integers.  beta:  X.Y.Z-beta.M  where  X ,  Y ,  Z  and  M  are positive or null integers  dev:  X.Y.Z-dev.checksum  where  X ,  Y  and  Z  are positive or null integers\n  and  checksum  is a unique identifier of the dev release (typically a shasum\n  of the git commit)", 
            "title": "Channels"
        }, 
        {
            "location": "/cozy-stack/registry/#version-order", 
            "text": "TLDR: 1.0.0-dev.    1.0.0 and 1.0.0-beta.    1.0.0, make sure you upgrade your\napp version after publishing stable.  The order used to determine the latest version of a channel is the following:  - `1.0.0-dev.*    1.0.0 (dev   stable)`\n- `1.0.0-beta.*   1.0.0 (beta   stable)`\n- `1.0.0-beta.1   1.0.0-beta.2`  To order beta and dev releases, we apply a sort by their creation date.", 
            "title": "Version order"
        }, 
        {
            "location": "/cozy-stack/registry/#objects", 
            "text": "Two types of objects are managed in the registry: applications and versions.", 
            "title": "Objects"
        }, 
        {
            "location": "/cozy-stack/registry/#application", 
            "text": "An application described a specific package. It is linked to multiple versions\n(releases) of the application.  An application object is  mutable .  An application object contains the following fields:   slug : the application slug (unique)  type : the application type ( webapp  or  konnector )  editor : the application editor name  name : object containing a human readable name for the application in\n  multiple languages  description : object containing the description description of the\n  application in multiple languages  category : the application category  repository : object with type and URL of package repository  locales : list of locales supported by the application  tags : list of tags associated with the application  screenshots : array of screenshots filenames  versions : an object containing all the channels versions   Example:  {\n   slug :  drive ,\n   type :  webapp ,\n   editor :  cozy ,\n   name : {\n     en :  Drive ,\n     fr :  Drive \n  },\n   description : {\n     en :  The drive application ,\n     fr :  L'application drive gestionnaire de fichier \n  },\n   category :  main ,\n   repository :  https://github.com/cozy/cozy-drive ,\n   locales : [ en ,  fr ],\n   tags : [ foo ,  bar ,  baz ],\n   screenshots : [ screen1.jpg ,  screen2.jpg ],\n   versions : {\n     stable : [ 3.1.1 ],\n     beta : [ 3.1.1-beta.1 ],\n     dev : [ 3.1.1-dev.7a8354f74b50d7beead7719252a18ed45f55d070 ]\n  }\n}", 
            "title": "Application"
        }, 
        {
            "location": "/cozy-stack/registry/#version", 
            "text": "A version object describe a specific release of an application.  A version object is  immutable .  An application version object contains the following fields:   slug : the application slug  type : the application type (webapp, konnector,  )  manifest : the  entire \n   manifest  defined in the package  created_at : date of the release creation  url : URL of the tarball containing the application at specified version  size : the size of the application package (uncompressed) in bytes as string  sha256 : the sha256 checksum of the application content  tar_prefix : optional tar prefix directory specified to properly extract the\n  application content   The version string should follow the channels rule.  Example:  {\n   slug :  drive ,\n   type :  webapp ,\n   version :  3.1.2 ,\n   created_at :  2017-07-05T07:54:40.982Z ,\n   url :  http://.../3.1.2 ,\n   size :  1000 ,\n   sha256 :  466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f ,\n   manifest : {\n    /* ... */\n  }\n}", 
            "title": "Version"
        }, 
        {
            "location": "/cozy-stack/registry/#apis-adding-to-registry", 
            "text": "These APIs can be used to add elements to the registry.", 
            "title": "APIs: Adding to registry"
        }, 
        {
            "location": "/cozy-stack/registry/#post-registryapp", 
            "text": "This route adds or modify an application to the registry. The content of the\nrequest should be a json object of an application.", 
            "title": "POST /registry/:app"
        }, 
        {
            "location": "/cozy-stack/registry/#status-codes", 
            "text": "201 Created, when the application has been successfully added  409 Conflict, when an application with the same slug already exists  400 Bad request, if the given application data is malformed (bad slug, missing\n  editor,  )", 
            "title": "Status codes"
        }, 
        {
            "location": "/cozy-stack/registry/#request", 
            "text": "POST /registry/drive HTTP/1.1\nAuthorization: Token AbCdE  {\n   slug :  drive ,\n   editor :  cozy ,\n   name : {\n     en :  Drive ,\n     fr :  Drive \n  },\n   description : {\n     en :  The drive application \n  },\n   repository :  https://github.com/cozy/cozy-drive ,\n   tags : [ foo ,  bar ,  baz ]\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/registry/#post-registryappversion-or-post-registryappversions", 
            "text": "This route adds a version of an application to the registry to the specified\nchannel (stable, beta or dev).  The content of the manifest file extracted from the application data is used to\nfill the fields of the version. Before adding the application version to the\nregistry, the registry should check the following:   the  manifest  file contained in the tarball should be checked and have its\n  fields checked against the application properties  the application content should check the sha256 checksum   Fields of the object sent to this request:   url : the url where the application tarball is stored  sha256 : the sha256 checksum of the tarball  version : the version value (should match the one in the manifest)  parameters? : an optional json value (any) that will override the\n   parameters  field of the manifest  icon? : an optional path to override the  icon  field of the manifest  screenshots? : and optional array of path to override the  screenshots  field\n  of the manifest", 
            "title": "POST /registry/:app/:version or POST /registry/:app/versions"
        }, 
        {
            "location": "/cozy-stack/registry/#status-codes_1", 
            "text": "201 Created, when the version has been successfully added to the registry  409 Conflict, when the version already exists  404 Not Found, when the application does not exist  412 Precondition Failed, when the sent application data is invalid (could not\n  fetch data URL, bad checksum, bad manifest in the tarball )  400 Bad request, when the request is invalid (bad checksum encoding, bad\n  URL )", 
            "title": "Status codes"
        }, 
        {
            "location": "/cozy-stack/registry/#request_1", 
            "text": "Request to add a stable release:  POST /registry/drive/3.1.2 HTTP/1.1\nAuthorization: Token AbCdE  {\n   version :  3.1.2 ,\n   url :  https://github.com/cozy/cozy-drive/archive/v3.1.2.tar.gz ,\n   sha256 :  466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f \n}  Request to add a development release:  POST /registry/drive/3.1.2-dev.7a1618dff78ba445650f266bbe334cbc9176f03a HTTP/1.1\nAuthorization: Token AbCdE  {\n   version :  3.1.2-dev.7a1618dff78ba445650f266bbe334cbc9176f03a ,\n   url :\n     https://github.com/cozy/cozy-photos-v3/archive/7a1618dff78ba445650f266bbe334cbc9176f03a.zip ,\n   sha256 :  466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f \n}  Request to add a version with optional parameters:  POST /registry/drive/3.1.2 HTTP/1.1\nAuthorization: Token AbCdE  {\n   version :  3.1.2 ,\n   url :\n     https://github.com/cozy/cozy-photos-v3/archive/7a1618dff78ba445650f266bbe334cbc9176f03a.zip ,\n   sha256 :  466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f ,\n   parameters : {  foo :  bar ,  baz : 123 }\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/registry/#response", 
            "text": "HTTP/1.1 201 Created\nContent-Type: application/json\nLocation: http://.../3.1.2  {\n   slug :  drive ,\n   type :  webapp ,\n   version :  3.1.2-dev.7a1618dff78ba445650f266bbe334cbc9176f03a ,\n   created_at :  2017-07-05T07:54:40.982Z ,\n   url :  http://.../7a1618dff78ba445650f266bbe334cbc9176f03a.zip ,\n   size :  1000 ,\n   sha256 :  466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f ,\n   manifest : {\n    /* ... */\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/registry/#apis-querying-registry", 
            "text": "These routes define the querying part of a registry to access to the available\napplications and versions. These APIs are also implemented directly by the\ncozy-stack.", 
            "title": "APIs: Querying registry"
        }, 
        {
            "location": "/cozy-stack/registry/#get-registry", 
            "text": "Get the list of all applications.  A pagination scheme is available via the  limit  and  cursor  query parameter.\nThe  filter[???]  query parameters can be used to filter by fields values.  Filtering is allowed on the following fields:   type  editor  category  tags   Filtering is allowed on multiple tags with the  ,  separator. For example: filter[tags]=foo,bar  will match the applications with both  foo  and  bar  as\ntags.  Sorting is allowed on the following fields:   slug  type  editor  category  created_at  updated_at", 
            "title": "GET /registry"
        }, 
        {
            "location": "/cozy-stack/registry/#query-string", 
            "text": "Parameter  Description      cursor  the cursor of the last application on the previous page    limit  the maximum number of applications to show    filter[]  a filter to apply on fields of the application    sort  name of the field on which to apply the sort of the list", 
            "title": "Query-String"
        }, 
        {
            "location": "/cozy-stack/registry/#request_2", 
            "text": "GET /registry?filter[category]=main limit=20 sort=slug HTTP/1.1", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/registry/#response_1", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/json  {\n   data : [\n    {\n       slug :  drive ,\n       type :  webapp ,\n       editor :  cozy ,\n       category :  main ,\n       description :  The drive application ,\n       versions : {\n         stable : [ 3.1.1 ],\n         beta : [ 3.1.1-beta.1 ],\n         dev : [ 3.1.1-dev.7a8354f74b50d7beead7719252a18ed45f55d070 ]\n      },\n       repository :  https://github.com/cozy/cozy-drive ,\n       license :  BSD \n    },\n    {\n      // ...\n    }\n  ],\n   meta : {\n     count : 2,\n     next_cursor :  ... \n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/registry/#get-registryapp", 
            "text": "Get an application object by slug.", 
            "title": "GET /registry/:app"
        }, 
        {
            "location": "/cozy-stack/registry/#request_3", 
            "text": "GET /registry/drive HTTP/1.1", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/registry/#response_2", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/json  {\n   slug :  drive ,\n   editor :  cozy ,\n   description :  The drive application ,\n   repository :  https://github.com/cozy/cozy-drive ,\n   tags : [ foo ,  bar ,  baz ],\n   versions : {\n     stable : [ 3.1.1 ],\n     beta : [ 3.1.1-beta.1 ],\n     dev : [ 3.1.1-dev.7a8354f74b50d7beead7719252a18ed45f55d070 ]\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/registry/#get-registryappicon", 
            "text": "Get the current application icon.", 
            "title": "GET /registry/:app/icon"
        }, 
        {
            "location": "/cozy-stack/registry/#request_4", 
            "text": "GET /registry/drive/icon HTTP/1.1", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/registry/#response_3", 
            "text": "HTTP/1.1 200 OK\nContent-Type: image/svg+xml svg xmlns= http://www.w3.org/2000/svg  width= 64  height= 64  viewBox= 0 0 64 64 \n   g fill= none  fill-rule= evenodd /g  /svg", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/registry/#get-registryappscreenshotsfilename", 
            "text": "Get the screenshot with the specified filename from the field  screenshots  of\nthe application.", 
            "title": "GET /registry/:app/screenshots/:filename"
        }, 
        {
            "location": "/cozy-stack/registry/#request_5", 
            "text": "GET /registry/drive/screenshots/screen1.jpg HTTP/1.1", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/registry/#response_4", 
            "text": "HTTP/1.1 200 OK\nContent-Type: image/jpeg\n\n...", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/registry/#get-registryappversion", 
            "text": "Get an application version.", 
            "title": "GET /registry/:app/:version"
        }, 
        {
            "location": "/cozy-stack/registry/#request_6", 
            "text": "GET /registry/drive/3.1.1 HTTP/1.1", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/registry/#response_5", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/json  {\n   slug :  drive ,\n   type :  webapp ,\n   version :  3.1.1 ,\n   url :  http://.../3.1.1 ,\n   sha256 :  466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f ,\n   size :  1000 ,\n   created_at :  2017-07-05T07:54:40.982Z ,\n   manifest : {\n    /* ... */\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/registry/#get-registryappchannellatest", 
            "text": "Get the latest version available on the specified channel.", 
            "title": "GET /registry/:app/:channel/latest"
        }, 
        {
            "location": "/cozy-stack/registry/#request_7", 
            "text": "GET /registry/drive/dev/latest HTTP/1.1", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/registry/#response_6", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/json  {\n   slug :  drive ,\n   type :  webapp ,\n   version :  3.1.1 ,\n   url :  http://.../3.1.1 ,\n   sha256 :  466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f ,\n   size :  1000 ,\n   created_at :  2017-07-05T07:54:40.982Z ,\n   manifest : {\n    /* ... */\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/registry/#attaching-a-cozy-stack-to-a-registry-or-a-list-of-registries", 
            "text": "In the configuration file of a stack, a  registries  namespace is added. This\nnamespace can contain a list of URL for the different registries attached to the\nstack.  The stack itself implements the querying API of a registry. When querying this\nAPI, to ask for an application, the stack uses this hierarchy of registries to\nproxy or redirect the user.  The hierarchy can also be contextualised to specify different registries to\ndifferent contexts. The  default  context is applied lastly.", 
            "title": "Attaching a cozy-stack to a registry or a list of registries"
        }, 
        {
            "location": "/cozy-stack/registry/#examples", 
            "text": "registries:\n  - https://myregistry.home/\n  - https://main.registry.cozy.io/  # In this example, a  context1  instance will have the equivalent of the\n# following list of registries:\n#\n#   - https://context1.registry.cozy.io/\n#   - https://myregistry.home/\n#   - https://registry.cozy.io/\n#\n\nregistries:\n  context1:\n    - https://context1.registry.cozy.io/\n\n  context2:\n    - https://context2.registry.cozy.io/\n\n  default:\n    - https://myregistry.home/\n    - https://registry.cozy.io/", 
            "title": "Examples:"
        }, 
        {
            "location": "/cozy-stack/registry/#authentication", 
            "text": "The authentication is based on a token that allow you to publish applications\nand versions with for one specific editor name. This token is base64 encoded.  In order to receive this token, please take a look at the page on publication on the registry .", 
            "title": "Authentication"
        }, 
        {
            "location": "/cozy-stack/data-system/", 
            "text": "Table of contents\n\n\nData System\n\n\nTyping\n\n\nThe notion of document type does not exist in Couchdb.\n\n\nCozy-stack introduce this notion through a special \n_type\n field.\n\n\nThis type name cannot contain \n/\n, and it should be unique among all developers,\nit is recommended to use the Java naming convention with a domain you own.\n\n\nAll CozyCloud types will be prefixed by io.cozy and be pluralized. Example :\n\n/data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee\n Where, \nio.cozy.\n is\nthe developer specific prefix, \nevents\n the actual type, and\n\n6494e0ac-dfcb-11e5-88c1-472e84a9cbee\n the document\ns unique id .\n\n\nAccess a document\n\n\nRequest\n\n\nGET /data/:type/:id HTTP/1.1\n\n\n\n\nGET /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee HTTP/1.1\n\n\n\n\nResponse OK\n\n\nHTTP/1.1 200 OK\nDate: Mon, 27 Sept 2016 12:28:53 GMT\nContent-Length: ...\nContent-Type: application/json\nEtag: \n3-6494e0ac6494e0ac\n\n\n\n\n{\n  \n_id\n: \n6494e0ac-dfcb-11e5-88c1-472e84a9cbee\n,\n  \n_type\n: \nio.cozy.events\n,\n  \n_rev\n: \n3-6494e0ac6494e0ac\n,\n  \nstartdate\n: \n20160823T150000Z\n,\n  \nenddate\n: \n20160923T160000Z\n,\n  \nsummary\n: \nA long month\n,\n  \ndescription\n: \nI could go on and on and on ....\n\n}\n\n\n\n\nResponse Error\n\n\nHTTP/1.1 404 Not Found\nContent-Length: ...\nContent-Type: application/json\n\n\n\n\n{\n  \nstatus\n: 404,\n  \nerror\n: \nnot_found\n,\n  \nreason\n: \ndeleted\n,\n  \ntitle\n: \nEvent deleted\n,\n  \ndetails\n: \nEvent 6494e0ac-dfcb-11e5-88c1-472e84a9cbee was deleted\n,\n  \nlinks\n: { \nabout\n: \nhttps://cozy.github.io/cozy-stack/errors.md#deleted\n }\n}\n\n\n\n\npossible errors :\n\n\n\n\n401 unauthorized (no authentication has been provided)\n\n\n403 forbidden (the authentication does not provide permissions for this\n  action)\n\n\n404 not_found\n\n\nreason: missing\n\n\nreason: deleted\n\n\n500 internal server error\n\n\n\n\nAccess multiple documents at once\n\n\nRequest\n\n\nPOST /data/:type/_all_docs HTTP/1.1\n\n\n\n\nPOST /data/io.cozy.files/_all_docs?include_docs=true HTTP/1.1\nContent-Length: ...\nContent-Type: application/json\nAccept: application/json\n\n\n\n\n{\n  \nkeys\n: [\n    \n7f46ed4ed2a775494da3b0b44e00314f\n,\n    \n7f46ed4ed2a775494da3b0b44e003b18\n\n  ]\n}\n\n\n\n\nResponse OK\n\n\nHTTP/1.1 200 OK\nDate: Mon, 27 Sept 2016 12:28:53 GMT\nContent-Length: ...\nContent-Type: application/json\nEtag: \n3-6494e0ac6494e0ac\n\n\n\n\n{\n  \ntotal_rows\n: 11,\n  \nrows\n: [\n    {\n      \nid\n: \n7f46ed4ed2a775494da3b0b44e00314f\n,\n      \nkey\n: \n7f46ed4ed2a775494da3b0b44e00314f\n,\n      \nvalue\n: {\n        \nrev\n: \n1-870e58f8a1b2130c3a41e767f9c7d93a\n\n      },\n      \ndoc\n: {\n        \n_id\n: \n7f46ed4ed2a775494da3b0b44e00314f\n,\n        \n_rev\n: \n1-870e58f8a1b2130c3a41e767f9c7d93a\n,\n        \ntype\n: \ndirectory\n,\n        \nname\n: \nUploaded from Cozy Photos\n,\n        \ndir_id\n: \n7f46ed4ed2a775494da3b0b44e0027df\n,\n        \ncreated_at\n: \n2017-07-04T06:49:12.844631837Z\n,\n        \nupdated_at\n: \n2017-07-04T06:49:12.844631837Z\n,\n        \ntags\n: [],\n        \npath\n: \n/Photos/Uploaded from Cozy Photos\n\n      }\n    },\n    {\n      \nkey\n: \n7f46ed4ed2a775494da3b0b44e003b18\n,\n      \nerror\n: \nnot_found\n\n    }\n  ]\n}\n\n\n\n\npossible errors :\n\n\n\n\n401 unauthorized (no authentication has been provided)\n\n\n403 forbidden (the authentication does not provide permissions for this\n  action)\n\n\n500 internal server error\n\n\n\n\nDetails\n\n\nWhen some keys don\nt match an existing document, the response still has a status\n200 and the errors are included in the \nrows\n field (see above, same behavior as\n\nCouchDB\n).\n\n\nCreate a document\n\n\nRequest\n\n\nPOST /data/:type/ HTTP/1.1\n\n\n\n\nPOST /data/io.cozy.events/ HTTP/1.1\nContent-Length: ...\nContent-Type: application/json\nAccept: application/json\n\n\n\n\n{\n  \nstartdate\n: \n20160712T150000\n,\n  \nenddate\n: \n20160712T150000\n\n}\n\n\n\n\nResponse OK\n\n\nHTTP/1.1 201 Created\nContent-Length: ...\nContent-Type: application/json\n\n\n\n\n{\n  \nid\n: \n6494e0ac-dfcb-11e5-88c1-472e84a9cbee\n,\n  \ntype\n: \nio.cozy.events\n,\n  \nok\n: true,\n  \nrev\n: \n1-6494e0ac6494e0ac\n,\n  \ndata\n: {\n    \n_id\n: \n6494e0ac-dfcb-11e5-88c1-472e84a9cbee\n,\n    \n_type\n: \nio.cozy.events\n,\n    \n_rev\n: \n1-6494e0ac6494e0ac\n,\n    \nstartdate\n: \n20160712T150000\n,\n    \nenddate\n: \n20160712T150000\n\n  }\n}\n\n\n\n\npossible errors :\n\n\n\n\n400 bad request\n\n\n401 unauthorized (no authentication has been provided)\n\n\n403 forbidden (the authentication does not provide permissions for this\n  action)\n\n\n500 internal server error\n\n\n\n\nDetails\n\n\n\n\nA doc cannot contain an \n_id\n field, if so an error 400 is returned\n\n\nA doc cannot contain any field starting with \n_\n, those are reserved for\n  future cozy \n couchdb api evolution\n\n\n\n\nUpdate an existing document\n\n\nRequest\n\n\nPUT /data/:type/:id HTTP/1.1\n\n\n\n\nPUT /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee HTTP/1.1\nContent-Length: ...\nContent-Type: application/json\nAccept: application/json\n\n\n\n\n{\n  \n_id\n: \n6494e0ac-dfcb-11e5-88c1-472e84a9cbee\n,\n  \n_type\n: \nio.cozy.events\n,\n  \n_rev\n: \n1-6494e0ac6494e0ac\n,\n  \nstartdate\n: \n20160712T150000\n,\n  \nenddate\n: \n20160712T200000\n\n}\n\n\n\n\nResponse OK\n\n\nHTTP/1.1 200 OK\nContent-Length: ...\nContent-Type: application/json\n\n\n\n\n{\n  \nid\n: \n6494e0ac-dfcb-11e5-88c1-472e84a9cbee\n,\n  \ntype\n: \nio.cozy.events\n,\n  \nok\n: true,\n  \nrev\n: \n2-056f5f44046ecafc08a2bc2b9c229e20\n,\n  \ndata\n: {\n    \n_id\n: \n6494e0ac-dfcb-11e5-88c1-472e84a9cbee\n,\n    \n_type\n: \nio.cozy.events\n,\n    \n_rev\n: \n2-056f5f44046ecafc08a2bc2b9c229e20\n,\n    \nstartdate\n: \n20160712T150000\n,\n    \nenddate\n: \n20160712T200000\n\n  }\n}\n\n\n\n\nPossible errors :\n\n\n\n\n400 bad request\n\n\n401 unauthorized (no authentication has been provided)\n\n\n403 forbidden (the authentication does not provide permissions for this\n  action)\n\n\n404 not_found\n\n\nreason: missing\n\n\nreason: deleted\n\n\n409 Conflict (see Conflict prevention section below)\n\n\n500 internal server error\n\n\n\n\nConflict prevention\n\n\nThe client MUST give a \n_rev\n field in the document. If this field is different\nfrom the one in the current version of the document, an error 409 Conflict will\nbe returned.\n\n\nDetails\n\n\n\n\nIf no id is provided in URL, an error 400 is returned\n\n\nIf the id provided in URL is not the same than the one in document, an error\n  400 is returned.\n\n\n\n\nCreate a document with a fixed id\n\n\nRequest\n\n\nPUT /data/:type/:id HTTP/1.1\n\n\n\n\nPUT /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee HTTP/1.1\nContent-Length: ...\nContent-Type: application/json\nAccept: application/json\n\n\n\n\n{\n  \nstartdate\n: \n20160712T150000\n,\n  \nenddate\n: \n20160712T200000\n\n}\n\n\n\n\nResponse OK\n\n\nHTTP/1.1 200 OK\nContent-Length: ...\nContent-Type: application/json\n\n\n\n\n{\n  \nid\n: \n6494e0ac-dfcb-11e5-88c1-472e84a9cbee\n,\n  \ntype\n: \nio.cozy.events\n,\n  \nok\n: true,\n  \nrev\n: \n1-056f5f44046ecafc08a2bc2b9c229e20\n,\n  \ndata\n: {\n    \n_id\n: \n6494e0ac-dfcb-11e5-88c1-472e84a9cbee\n,\n    \n_type\n: \nio.cozy.events\n,\n    \n_rev\n: \n1-056f5f44046ecafc08a2bc2b9c229e20\n,\n    \nstartdate\n: \n20160712T150000\n,\n    \nenddate\n: \n20160712T200000\n\n  }\n}\n\n\n\n\nPossible errors :\n\n\n\n\n400 bad request\n\n\n401 unauthorized (no authentication has been provided)\n\n\n403 forbidden (the authentication does not provide permissions for this\n  action)\n\n\n404 not_found\n\n\nreason: missing\n\n\nreason: deleted\n\n\n409 Conflict (see Conflict prevention section below)\n\n\n500 internal server error\n\n\n\n\nDetails\n\n\n\n\nNo id should be provide in the document itself\n\n\n\n\nDelete a document\n\n\nRequest\n\n\nDELETE /data/:type/:id?rev=:rev HTTP/1.1\n\n\n\n\nDELETE /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee?rev=1-82a7144c9ec228c9a851b8a1c1aa225b HTTP/1.1\nAccept: application/json\n\n\n\n\nResponse OK\n\n\nHTTP/1.1 200 OK\nContent-Length: ...\nContent-Type: application/json\n\n\n\n\n{\n  \nid\n: \n6494e0ac-dfcb-11e5-88c1-472e84a9cbee\n,\n  \ntype\n: \nio.cozy.events\n,\n  \nok\n: true,\n  \nrev\n: \n2-056f5f44046ecafc08a2bc2b9c229e20\n,\n  \n_deleted\n: true\n}\n\n\n\n\nPossible errors :\n\n\n\n\n400 bad request\n\n\n401 unauthorized (no authentication has been provided)\n\n\n403 forbidden (the authentication does not provide permissions for this\n  action)\n\n\n404 not_found\n\n\nreason: missing\n\n\nreason: deleted\n\n\n409 Conflict (see Conflict prevention section below)\n\n\n500 internal server error\n\n\n\n\nConflict prevention\n\n\nIt is possible to use either a \nrev\n query string parameter or a HTTP \nIf-Match\n\nheader to prevent conflict on deletion:\n\n\n\n\nIf none is passed or they are different, an error 400 is returned\n\n\nIf only one is passed or they are equals, the document will only be deleted if\n  its \n_rev\n match the passed one. Otherwise, an error 409 is returned.\n\n\n\n\nDetails\n\n\n\n\nIf no id is provided in URL, an error 400 is returned\n\n\n\n\nList all the documents\n\n\nRequest\n\n\nGET /data/io.cozy.events/_all_docs?include_docs=true HTTP/1.1\nAccept: application/json\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/json\n\n\n\n\n{\n  \noffset\n: 0,\n  \nrows\n: [\n    {\n      \nid\n: \n16e458537602f5ef2a710089dffd9453\n,\n      \nkey\n: \n16e458537602f5ef2a710089dffd9453\n,\n      \nvalue\n: {\n        \nrev\n: \n1-967a00dff5e02add41819138abb3284d\n\n      },\n      \ndoc\n: {\n        \nfield\n: \nvalue\n\n      }\n    },\n    {\n      \nid\n: \nf4ca7773ddea715afebc4b4b15d4f0b3\n,\n      \nkey\n: \nf4ca7773ddea715afebc4b4b15d4f0b3\n,\n      \nvalue\n: {\n        \nrev\n: \n2-7051cbe5c8faecd085a3fa619e6e6337\n\n      },\n      \ndoc\n: {\n        \nfield\n: \nother-value\n\n      }\n    }\n  ],\n  \ntotal_rows\n: 2\n}\n\n\n\n\nDetails\n\n\nSee\n\n_all_docs\n in couchdb docs\n\n\nList the known doctypes\n\n\nRequest\n\n\nGET /data/_all_doctypes HTTP/1.1\nAccept: application/json\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/json\n\n\n\n\n[\nio.cozy.files\n, \nio.cozy.jobs\n, \nio.cozy.triggers\n, \nio.cozy.settings\n]\n\n\n\n\nOthers\n\n\n\n\nThe creation and usage of \nMango indexes\n is possible.\n\n\nCouchDB behaviors are not always straight forward: see \nsome\n  quirks\n for more details.", 
            "title": "/data - Data System"
        }, 
        {
            "location": "/cozy-stack/data-system/#data-system", 
            "text": "", 
            "title": "Data System"
        }, 
        {
            "location": "/cozy-stack/data-system/#typing", 
            "text": "The notion of document type does not exist in Couchdb.  Cozy-stack introduce this notion through a special  _type  field.  This type name cannot contain  / , and it should be unique among all developers,\nit is recommended to use the Java naming convention with a domain you own.  All CozyCloud types will be prefixed by io.cozy and be pluralized. Example : /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee  Where,  io.cozy.  is\nthe developer specific prefix,  events  the actual type, and 6494e0ac-dfcb-11e5-88c1-472e84a9cbee  the document s unique id .", 
            "title": "Typing"
        }, 
        {
            "location": "/cozy-stack/data-system/#access-a-document", 
            "text": "", 
            "title": "Access a document"
        }, 
        {
            "location": "/cozy-stack/data-system/#request", 
            "text": "GET /data/:type/:id HTTP/1.1  GET /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee HTTP/1.1", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/data-system/#response-ok", 
            "text": "HTTP/1.1 200 OK\nDate: Mon, 27 Sept 2016 12:28:53 GMT\nContent-Length: ...\nContent-Type: application/json\nEtag:  3-6494e0ac6494e0ac  {\n   _id :  6494e0ac-dfcb-11e5-88c1-472e84a9cbee ,\n   _type :  io.cozy.events ,\n   _rev :  3-6494e0ac6494e0ac ,\n   startdate :  20160823T150000Z ,\n   enddate :  20160923T160000Z ,\n   summary :  A long month ,\n   description :  I could go on and on and on .... \n}", 
            "title": "Response OK"
        }, 
        {
            "location": "/cozy-stack/data-system/#response-error", 
            "text": "HTTP/1.1 404 Not Found\nContent-Length: ...\nContent-Type: application/json  {\n   status : 404,\n   error :  not_found ,\n   reason :  deleted ,\n   title :  Event deleted ,\n   details :  Event 6494e0ac-dfcb-11e5-88c1-472e84a9cbee was deleted ,\n   links : {  about :  https://cozy.github.io/cozy-stack/errors.md#deleted  }\n}", 
            "title": "Response Error"
        }, 
        {
            "location": "/cozy-stack/data-system/#possible-errors", 
            "text": "401 unauthorized (no authentication has been provided)  403 forbidden (the authentication does not provide permissions for this\n  action)  404 not_found  reason: missing  reason: deleted  500 internal server error", 
            "title": "possible errors :"
        }, 
        {
            "location": "/cozy-stack/data-system/#access-multiple-documents-at-once", 
            "text": "", 
            "title": "Access multiple documents at once"
        }, 
        {
            "location": "/cozy-stack/data-system/#request_1", 
            "text": "POST /data/:type/_all_docs HTTP/1.1  POST /data/io.cozy.files/_all_docs?include_docs=true HTTP/1.1\nContent-Length: ...\nContent-Type: application/json\nAccept: application/json  {\n   keys : [\n     7f46ed4ed2a775494da3b0b44e00314f ,\n     7f46ed4ed2a775494da3b0b44e003b18 \n  ]\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/data-system/#response-ok_1", 
            "text": "HTTP/1.1 200 OK\nDate: Mon, 27 Sept 2016 12:28:53 GMT\nContent-Length: ...\nContent-Type: application/json\nEtag:  3-6494e0ac6494e0ac  {\n   total_rows : 11,\n   rows : [\n    {\n       id :  7f46ed4ed2a775494da3b0b44e00314f ,\n       key :  7f46ed4ed2a775494da3b0b44e00314f ,\n       value : {\n         rev :  1-870e58f8a1b2130c3a41e767f9c7d93a \n      },\n       doc : {\n         _id :  7f46ed4ed2a775494da3b0b44e00314f ,\n         _rev :  1-870e58f8a1b2130c3a41e767f9c7d93a ,\n         type :  directory ,\n         name :  Uploaded from Cozy Photos ,\n         dir_id :  7f46ed4ed2a775494da3b0b44e0027df ,\n         created_at :  2017-07-04T06:49:12.844631837Z ,\n         updated_at :  2017-07-04T06:49:12.844631837Z ,\n         tags : [],\n         path :  /Photos/Uploaded from Cozy Photos \n      }\n    },\n    {\n       key :  7f46ed4ed2a775494da3b0b44e003b18 ,\n       error :  not_found \n    }\n  ]\n}", 
            "title": "Response OK"
        }, 
        {
            "location": "/cozy-stack/data-system/#possible-errors_1", 
            "text": "401 unauthorized (no authentication has been provided)  403 forbidden (the authentication does not provide permissions for this\n  action)  500 internal server error", 
            "title": "possible errors :"
        }, 
        {
            "location": "/cozy-stack/data-system/#details", 
            "text": "When some keys don t match an existing document, the response still has a status\n200 and the errors are included in the  rows  field (see above, same behavior as CouchDB ).", 
            "title": "Details"
        }, 
        {
            "location": "/cozy-stack/data-system/#create-a-document", 
            "text": "", 
            "title": "Create a document"
        }, 
        {
            "location": "/cozy-stack/data-system/#request_2", 
            "text": "POST /data/:type/ HTTP/1.1  POST /data/io.cozy.events/ HTTP/1.1\nContent-Length: ...\nContent-Type: application/json\nAccept: application/json  {\n   startdate :  20160712T150000 ,\n   enddate :  20160712T150000 \n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/data-system/#response-ok_2", 
            "text": "HTTP/1.1 201 Created\nContent-Length: ...\nContent-Type: application/json  {\n   id :  6494e0ac-dfcb-11e5-88c1-472e84a9cbee ,\n   type :  io.cozy.events ,\n   ok : true,\n   rev :  1-6494e0ac6494e0ac ,\n   data : {\n     _id :  6494e0ac-dfcb-11e5-88c1-472e84a9cbee ,\n     _type :  io.cozy.events ,\n     _rev :  1-6494e0ac6494e0ac ,\n     startdate :  20160712T150000 ,\n     enddate :  20160712T150000 \n  }\n}", 
            "title": "Response OK"
        }, 
        {
            "location": "/cozy-stack/data-system/#possible-errors_2", 
            "text": "400 bad request  401 unauthorized (no authentication has been provided)  403 forbidden (the authentication does not provide permissions for this\n  action)  500 internal server error", 
            "title": "possible errors :"
        }, 
        {
            "location": "/cozy-stack/data-system/#details_1", 
            "text": "A doc cannot contain an  _id  field, if so an error 400 is returned  A doc cannot contain any field starting with  _ , those are reserved for\n  future cozy   couchdb api evolution", 
            "title": "Details"
        }, 
        {
            "location": "/cozy-stack/data-system/#update-an-existing-document", 
            "text": "", 
            "title": "Update an existing document"
        }, 
        {
            "location": "/cozy-stack/data-system/#request_3", 
            "text": "PUT /data/:type/:id HTTP/1.1  PUT /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee HTTP/1.1\nContent-Length: ...\nContent-Type: application/json\nAccept: application/json  {\n   _id :  6494e0ac-dfcb-11e5-88c1-472e84a9cbee ,\n   _type :  io.cozy.events ,\n   _rev :  1-6494e0ac6494e0ac ,\n   startdate :  20160712T150000 ,\n   enddate :  20160712T200000 \n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/data-system/#response-ok_3", 
            "text": "HTTP/1.1 200 OK\nContent-Length: ...\nContent-Type: application/json  {\n   id :  6494e0ac-dfcb-11e5-88c1-472e84a9cbee ,\n   type :  io.cozy.events ,\n   ok : true,\n   rev :  2-056f5f44046ecafc08a2bc2b9c229e20 ,\n   data : {\n     _id :  6494e0ac-dfcb-11e5-88c1-472e84a9cbee ,\n     _type :  io.cozy.events ,\n     _rev :  2-056f5f44046ecafc08a2bc2b9c229e20 ,\n     startdate :  20160712T150000 ,\n     enddate :  20160712T200000 \n  }\n}", 
            "title": "Response OK"
        }, 
        {
            "location": "/cozy-stack/data-system/#possible-errors_3", 
            "text": "400 bad request  401 unauthorized (no authentication has been provided)  403 forbidden (the authentication does not provide permissions for this\n  action)  404 not_found  reason: missing  reason: deleted  409 Conflict (see Conflict prevention section below)  500 internal server error", 
            "title": "Possible errors :"
        }, 
        {
            "location": "/cozy-stack/data-system/#conflict-prevention", 
            "text": "The client MUST give a  _rev  field in the document. If this field is different\nfrom the one in the current version of the document, an error 409 Conflict will\nbe returned.", 
            "title": "Conflict prevention"
        }, 
        {
            "location": "/cozy-stack/data-system/#details_2", 
            "text": "If no id is provided in URL, an error 400 is returned  If the id provided in URL is not the same than the one in document, an error\n  400 is returned.", 
            "title": "Details"
        }, 
        {
            "location": "/cozy-stack/data-system/#create-a-document-with-a-fixed-id", 
            "text": "", 
            "title": "Create a document with a fixed id"
        }, 
        {
            "location": "/cozy-stack/data-system/#request_4", 
            "text": "PUT /data/:type/:id HTTP/1.1  PUT /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee HTTP/1.1\nContent-Length: ...\nContent-Type: application/json\nAccept: application/json  {\n   startdate :  20160712T150000 ,\n   enddate :  20160712T200000 \n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/data-system/#response-ok_4", 
            "text": "HTTP/1.1 200 OK\nContent-Length: ...\nContent-Type: application/json  {\n   id :  6494e0ac-dfcb-11e5-88c1-472e84a9cbee ,\n   type :  io.cozy.events ,\n   ok : true,\n   rev :  1-056f5f44046ecafc08a2bc2b9c229e20 ,\n   data : {\n     _id :  6494e0ac-dfcb-11e5-88c1-472e84a9cbee ,\n     _type :  io.cozy.events ,\n     _rev :  1-056f5f44046ecafc08a2bc2b9c229e20 ,\n     startdate :  20160712T150000 ,\n     enddate :  20160712T200000 \n  }\n}", 
            "title": "Response OK"
        }, 
        {
            "location": "/cozy-stack/data-system/#possible-errors_4", 
            "text": "400 bad request  401 unauthorized (no authentication has been provided)  403 forbidden (the authentication does not provide permissions for this\n  action)  404 not_found  reason: missing  reason: deleted  409 Conflict (see Conflict prevention section below)  500 internal server error", 
            "title": "Possible errors :"
        }, 
        {
            "location": "/cozy-stack/data-system/#details_3", 
            "text": "No id should be provide in the document itself", 
            "title": "Details"
        }, 
        {
            "location": "/cozy-stack/data-system/#delete-a-document", 
            "text": "", 
            "title": "Delete a document"
        }, 
        {
            "location": "/cozy-stack/data-system/#request_5", 
            "text": "DELETE /data/:type/:id?rev=:rev HTTP/1.1  DELETE /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee?rev=1-82a7144c9ec228c9a851b8a1c1aa225b HTTP/1.1\nAccept: application/json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/data-system/#response-ok_5", 
            "text": "HTTP/1.1 200 OK\nContent-Length: ...\nContent-Type: application/json  {\n   id :  6494e0ac-dfcb-11e5-88c1-472e84a9cbee ,\n   type :  io.cozy.events ,\n   ok : true,\n   rev :  2-056f5f44046ecafc08a2bc2b9c229e20 ,\n   _deleted : true\n}", 
            "title": "Response OK"
        }, 
        {
            "location": "/cozy-stack/data-system/#possible-errors_5", 
            "text": "400 bad request  401 unauthorized (no authentication has been provided)  403 forbidden (the authentication does not provide permissions for this\n  action)  404 not_found  reason: missing  reason: deleted  409 Conflict (see Conflict prevention section below)  500 internal server error", 
            "title": "Possible errors :"
        }, 
        {
            "location": "/cozy-stack/data-system/#conflict-prevention_1", 
            "text": "It is possible to use either a  rev  query string parameter or a HTTP  If-Match \nheader to prevent conflict on deletion:   If none is passed or they are different, an error 400 is returned  If only one is passed or they are equals, the document will only be deleted if\n  its  _rev  match the passed one. Otherwise, an error 409 is returned.", 
            "title": "Conflict prevention"
        }, 
        {
            "location": "/cozy-stack/data-system/#details_4", 
            "text": "If no id is provided in URL, an error 400 is returned", 
            "title": "Details"
        }, 
        {
            "location": "/cozy-stack/data-system/#list-all-the-documents", 
            "text": "", 
            "title": "List all the documents"
        }, 
        {
            "location": "/cozy-stack/data-system/#request_6", 
            "text": "GET /data/io.cozy.events/_all_docs?include_docs=true HTTP/1.1\nAccept: application/json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/data-system/#response", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/json  {\n   offset : 0,\n   rows : [\n    {\n       id :  16e458537602f5ef2a710089dffd9453 ,\n       key :  16e458537602f5ef2a710089dffd9453 ,\n       value : {\n         rev :  1-967a00dff5e02add41819138abb3284d \n      },\n       doc : {\n         field :  value \n      }\n    },\n    {\n       id :  f4ca7773ddea715afebc4b4b15d4f0b3 ,\n       key :  f4ca7773ddea715afebc4b4b15d4f0b3 ,\n       value : {\n         rev :  2-7051cbe5c8faecd085a3fa619e6e6337 \n      },\n       doc : {\n         field :  other-value \n      }\n    }\n  ],\n   total_rows : 2\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/data-system/#details_5", 
            "text": "See _all_docs  in couchdb docs", 
            "title": "Details"
        }, 
        {
            "location": "/cozy-stack/data-system/#list-the-known-doctypes", 
            "text": "", 
            "title": "List the known doctypes"
        }, 
        {
            "location": "/cozy-stack/data-system/#request_7", 
            "text": "GET /data/_all_doctypes HTTP/1.1\nAccept: application/json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/data-system/#response_1", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/json  [ io.cozy.files ,  io.cozy.jobs ,  io.cozy.triggers ,  io.cozy.settings ]", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/data-system/#others", 
            "text": "The creation and usage of  Mango indexes  is possible.  CouchDB behaviors are not always straight forward: see  some\n  quirks  for more details.", 
            "title": "Others"
        }, 
        {
            "location": "/cozy-stack/mango/", 
            "text": "Table of contents\n\n\nMango\n\n\nCreate an index for some documents\n\n\nThe body should contain a \nindex\n JSON field containing a \nfields\n which is an\nordered array of fields to index.\n\n\nRequest\n\n\nPOST /data/:doctype/_index HTTP/1.1\n\n\n\n\nPOST /data/io.cozy.events/_index HTTP/1.1\nContent-Type: application/json\n\n\n\n\n{\n  \nindex\n: {\n    \nfields\n: [\ncalendar\n, \ndate\n]\n  }\n}\n\n\n\n\nResponse OK\n\n\nHTTP/1.1 200 OK\nDate: Mon, 27 Sept 2016 12:28:53 GMT\nContent-Length: ...\nContent-Type: application/json\n\n\n\n\n{\n  \nresult\n: \ncreated\n,\n  \nid\n: \n_design/a5f4711fc9448864a13c81dc71e660b524d7410c\n,\n  \nname\n: \na5f4711fc9448864a13c81dc71e660b524d7410c\n\n}\n\n\n\n\nDetails\n\n\n\n\nif the doctype does not exist, the database is created.\n\n\nif the index already exists, a \n{result: \"exists\"}\n is returned, but the\n  response code is still 200\n\n\ndesign doc \n name can be provided in request. \nThis is not recommended\n, let\n  couchdb handle naming and deduplication.\n\n\n\n\n{\n  \nname\n: \nby-calendar-and-date\n,\n  \nddoc\n: \n_design/some-ddoc-name\n,\n  \nindex\n: { \nfields\n: ... }\n}\n\n\n\n\npossible errors :\n\n\n\n\n401 unauthorized (no authentication has been provided)\n\n\n403 forbidden (the authentication does not provide permissions for this\n  action)\n\n\n500 internal server error\n\n\n\n\nFind documents\n\n\nFind allows to find documents using a mango selector. You can read more about\nmango selectors\n\nhere\n\n\nRequest\n\n\nPOST /data/:doctype/_find HTTP/1.1\n\n\n\n\nPOST /data/io.cozy.events/_find HTTP/1.1\nContent-Type: application/json\n\n\n\n\n{\n  \nselector\n: {\n    \ncalendar\n: \nperso\n,\n    \ndate\n: { \n$gt\n: \n20161001T00:00:00\n }\n  },\n  \nlimit\n: 2,\n  \nskip\n: 3,\n  \nsort\n: [\ncalendar\n, \ndate\n],\n  \nfields\n: [\n_id\n, \n_type\n, \n_date\n],\n  \nuse_index\n: \n_design/a5f4711fc9448864a13c81dc71e660b524d7410c\n\n}\n\n\n\n\nResponse OK\n\n\nHTTP/1.1 200 OK\nDate: Mon, 27 Sept 2016 12:28:53 GMT\nContent-Length: ...\nContent-Type: application/json\n\n\n\n\n{\n  \ndocs\n: [\n    {\n      \n_id\n: \n6494e0ac-dfcb-11e5-88c1-472e84a9cbee\n,\n      \n_type\n: \nio.cozy.events\n,\n      \ndate\n: \n20161023T160000Z\n\n    },\n    {\n      \n_id\n: \n6494e0ac-dfcb-472e84a9cbee\n,\n      \n_type\n: \nio.cozy.events\n,\n      \ndate\n: \n20161013T160000Z\n\n    }\n  ]\n}\n\n\n\n\nDetails\n\n\n\n\nIf an index does not exist for the selector, an error 400 is returned\n\n\nThe sort field must contains all fields used in selector\n\n\nThe sort field must match an existing index\n\n\nIt is possible to sort in reverse direction \nsort:[{\"calendar\":\"desc\"}, {\"date\": \"desc\"}]\n but \nall fields\n must be sorted in same direction.\n\n\nuse_index\n is optional but recommended.\n\n\n\n\nPagination cookbook\n\n\nPagination of mango query should be handled by the client. The stack will always\nlimit query results to maximum 100 docs.\n\n\nThe limit applied to a query is visible in the HTTP response.\n\n\nIf the limit cause some docs to not be returned, the response will have a\n\nnext=true\n top level values.\n\n\n{\n  \nlimit\n: 100,\n  \nnext\n: true,\n  \ndocs\n: [\n... first hundred docs ...\n]\n}\n\n\n\n\nIf the number of docs is lower or equal to the limit, next will be false\n\n\n{\n  \nlimit\n: 100,\n  \nnext\n: false,\n  \ndocs\n: [\n... less than a hundred docs ...\n]\n}\n\n\n\n\nTo paginate, the client should keep track of the value of the last index field.\n\n\nExemple :\n\n\nIndex on io.cozy.events with fields \n[\"calendar\", \"date\"]\n\n\nTry to get all events for a month :\n\n\nselector: {\n  \ncalendar\n: \nmy-calendar\n,\n  \ndate\n: { \n$gt\n: \n20161001\n, \n$lt\n: \n20161030\n }\n}\n\n\n\n\nIf there is less than 100 events, the response \nnext\n field will be false and\nthere is nothing more to do. If there is more than 100 events for this month, we\nhave a \nnext=true\n in the response.\n\n\nTo keep iterating, we can take the date from the last item we received in the\nresults and use it as next request \n$gte\n\n\nselector: {\n  \ncalendar\n: \nmy-calendar\n,\n  \ndate\n: { \n$gte\n :\n20161023\n, \n$lt\n: \n20161030\n }\n}", 
            "title": "Mango"
        }, 
        {
            "location": "/cozy-stack/mango/#mango", 
            "text": "", 
            "title": "Mango"
        }, 
        {
            "location": "/cozy-stack/mango/#create-an-index-for-some-documents", 
            "text": "The body should contain a  index  JSON field containing a  fields  which is an\nordered array of fields to index.", 
            "title": "Create an index for some documents"
        }, 
        {
            "location": "/cozy-stack/mango/#request", 
            "text": "POST /data/:doctype/_index HTTP/1.1  POST /data/io.cozy.events/_index HTTP/1.1\nContent-Type: application/json  {\n   index : {\n     fields : [ calendar ,  date ]\n  }\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/mango/#response-ok", 
            "text": "HTTP/1.1 200 OK\nDate: Mon, 27 Sept 2016 12:28:53 GMT\nContent-Length: ...\nContent-Type: application/json  {\n   result :  created ,\n   id :  _design/a5f4711fc9448864a13c81dc71e660b524d7410c ,\n   name :  a5f4711fc9448864a13c81dc71e660b524d7410c \n}", 
            "title": "Response OK"
        }, 
        {
            "location": "/cozy-stack/mango/#details", 
            "text": "if the doctype does not exist, the database is created.  if the index already exists, a  {result: \"exists\"}  is returned, but the\n  response code is still 200  design doc   name can be provided in request.  This is not recommended , let\n  couchdb handle naming and deduplication.   {\n   name :  by-calendar-and-date ,\n   ddoc :  _design/some-ddoc-name ,\n   index : {  fields : ... }\n}", 
            "title": "Details"
        }, 
        {
            "location": "/cozy-stack/mango/#possible-errors", 
            "text": "401 unauthorized (no authentication has been provided)  403 forbidden (the authentication does not provide permissions for this\n  action)  500 internal server error", 
            "title": "possible errors :"
        }, 
        {
            "location": "/cozy-stack/mango/#find-documents", 
            "text": "Find allows to find documents using a mango selector. You can read more about\nmango selectors here", 
            "title": "Find documents"
        }, 
        {
            "location": "/cozy-stack/mango/#request_1", 
            "text": "POST /data/:doctype/_find HTTP/1.1  POST /data/io.cozy.events/_find HTTP/1.1\nContent-Type: application/json  {\n   selector : {\n     calendar :  perso ,\n     date : {  $gt :  20161001T00:00:00  }\n  },\n   limit : 2,\n   skip : 3,\n   sort : [ calendar ,  date ],\n   fields : [ _id ,  _type ,  _date ],\n   use_index :  _design/a5f4711fc9448864a13c81dc71e660b524d7410c \n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/mango/#response-ok_1", 
            "text": "HTTP/1.1 200 OK\nDate: Mon, 27 Sept 2016 12:28:53 GMT\nContent-Length: ...\nContent-Type: application/json  {\n   docs : [\n    {\n       _id :  6494e0ac-dfcb-11e5-88c1-472e84a9cbee ,\n       _type :  io.cozy.events ,\n       date :  20161023T160000Z \n    },\n    {\n       _id :  6494e0ac-dfcb-472e84a9cbee ,\n       _type :  io.cozy.events ,\n       date :  20161013T160000Z \n    }\n  ]\n}", 
            "title": "Response OK"
        }, 
        {
            "location": "/cozy-stack/mango/#details_1", 
            "text": "If an index does not exist for the selector, an error 400 is returned  The sort field must contains all fields used in selector  The sort field must match an existing index  It is possible to sort in reverse direction  sort:[{\"calendar\":\"desc\"}, {\"date\": \"desc\"}]  but  all fields  must be sorted in same direction.  use_index  is optional but recommended.", 
            "title": "Details"
        }, 
        {
            "location": "/cozy-stack/mango/#pagination-cookbook", 
            "text": "Pagination of mango query should be handled by the client. The stack will always\nlimit query results to maximum 100 docs.  The limit applied to a query is visible in the HTTP response.  If the limit cause some docs to not be returned, the response will have a next=true  top level values.  {\n   limit : 100,\n   next : true,\n   docs : [ ... first hundred docs ... ]\n}  If the number of docs is lower or equal to the limit, next will be false  {\n   limit : 100,\n   next : false,\n   docs : [ ... less than a hundred docs ... ]\n}  To paginate, the client should keep track of the value of the last index field.", 
            "title": "Pagination cookbook"
        }, 
        {
            "location": "/cozy-stack/mango/#exemple", 
            "text": "Index on io.cozy.events with fields  [\"calendar\", \"date\"]  Try to get all events for a month :  selector: {\n   calendar :  my-calendar ,\n   date : {  $gt :  20161001 ,  $lt :  20161030  }\n}  If there is less than 100 events, the response  next  field will be false and\nthere is nothing more to do. If there is more than 100 events for this month, we\nhave a  next=true  in the response.  To keep iterating, we can take the date from the last item we received in the\nresults and use it as next request  $gte  selector: {\n   calendar :  my-calendar ,\n   date : {  $gte  : 20161023 ,  $lt :  20161030  }\n}", 
            "title": "Exemple :"
        }, 
        {
            "location": "/cozy-stack/replication/", 
            "text": "Table of contents\n\n\nReplication\n\n\nReplication is the ability of a cozy-stack to copy / move all or a subset of its\ndata to another support. It should cover 2 use cases\n\n\n\n\nDevices: The continuous act of syncing change to a subset of the cozy\n  documents and files to and from an user cozy to the same user\ns Devices\n  through cozy-desktop and cozy-mobile\n\n\nSharing: The continuous act of syncing change to a subset of the cozy\n  documents and files to and from another user\ns cozy.\n\n\n\n\nReplication will not be used for Moving, nor Backup. See associated docs in this\nfolder.\n\n\nCouchDB replication is a well-understood, safe and stable algorithm ensuring\nreplication between two couchdb databases. It is delta-based, and is stateful:\nwe sync changes since a given checkpoint.\n\n\nFiles synchronization\n\n\nReplication of too heavy database (with a lot of attachments) has been, in cozy\nexperience, the source of some bugs. To avoid that (and some other issues), in\ncozy-stack, the attachments are stored outside of couchdb.\n\n\nThis means we need a way to synchronize files in parallel to couchdb\nreplication.\n\n\nRsync is a well-understood, safe and stable algorithm to replicate files\nhierarchy from one hosts to the other by only transfering changes. It is\none-shot and stateless. It could be an inspiration if we have to focus on\nsyncing small changes to big files. The option to use rsync/zsync have been\ndiscussed internally (https://github.com/cozy/cozy-stack/pull/57 \n Sprint Start\n2016-10-24), but for now we should focus on using the files/folders couchdb\ndocument for synchronization purpose and upload/download the actual binaries\nwith existing files routes or considering webdav.\n\n\nUseful golang package:\n http://rclone.org/ sync folder in FS / Swift (may be\nwe can add a driver for cozy)\n\n\nCouchdb replication \n limitation\n\n\nCouchdb 2 replication protocol is described\n\nin details here\n.\n\n\nQuick summary\n\n\n\n\nThe replicator figures out what was the last sequence number \nlastseqno\n\n   which was correctly synced from the source database, using a\n   \n_local/:replicationid\n document.\n\n\nThe replicator \nGET :source/changes?since=lastseqno\nlimit=batchsize\n and\n   identify which docs have changed (and their \nopen_revs\n).\n\n\nThe replicator \nPOST :target/_revs_diff\n to get a list of all revisions of\n   the changed documents the target does not know.\n\n\nThe replicator \nGET :source/:docid?open_revs=['rev1', ...]\n several times to\n   retrieve the missing documents revisions.\n\n\nThe replicator \nPOST :target/_bulk_docs\n with these documents revisions.\n\n\nStore the new last sequence number\n\n\n\n\nRepeat 2-5 until there is no more changes.\n\n\nDetails\n\n\n\n\nIn step 5, the replicator can also attempt to \nPUT :target/:docid\n if doc are\n  too heavy, but this should not happens in cozy-stack considering there wont be\n  attachment in couchdb.\n\n\nIn step 4, the replicator can optimize by calling \nGET\n\n\nThe main difference from couchdb 1.X is in the replication history and the\n  manner to determine and store the last sequence number. \nTODO:\n actually\n  understand this and how it might increase disk usage if we have a lot of\n  replications.\n\n\nCouchdb \n_changes\n and by extension replication can be either by polling or\n  continuous (SSE / COMET)\n\n\nIn couchdb benchmarking, we understood that the number of couch databases only\n  use a bit of disk space but no RAM or CPU \nas long as the database is not\n  used\n. Having a continuous replication active force us to keep the database\n  file open and will starve RAM \n FD usage. Moreover, continuous replication\n  costs a lot (cf. ScienceTeam benchmark). To permit an unlimited number of\n  inactive user on a single cozy-stack process, \nthe stack should avoid\n  continuous replication from couchdb\n.\n\n\nTwo way replication is simply two one way replications\n\n\n\n\nRoutes used by replication\n\n\nTo be a source of replication, the stack only need to support the following\nroute (and query parameters):\n\n\n\n\nGET :source/:docid\n get revisions of a document. The query parameters\n  \nopen_revs, revs, latest\n is necessary for replication.\n\n\nPOST :source/_all_docs\n is used by current version of cozy-mobile and pouchdb\n  as an optimization to fetch several document\ns revision at once.\n\n\nGET :source/_changes\n get a list of ID -\n New Revision since a given sequence\n  number. The query parameters \nsince, limit\n are necessary for replication.\n\n\n\n\nTo be a target of replication, the stack need to support the following routes:\n\n\n\n\nPOST :target/_revs_diff\n takes a list of ID -\n Rev and returns which one are\n  missing.\n\n\nPOST :target/_bulk_docs\n create several documents at once\n\n\nPOST :target/_ensure_full_commit\n ensure the documents are written to disk.\n  This is useless if couchdb is configured without delayed write (default), but\n  remote couchdb will call, so the stack should return the expected 201\n\n\n\n\nIn both case, we need to support\n\n\n\n\nPUT :both/_local/:revdocid\n to store the current sequence number.\n\n\n\n\nStack Sync API exploration\n\n\nEasy part: 1 db/doctype on stack AND remote, no binaries\n\n\nWe \njust\n need to implement the routes described above by proxying to the\nunderlying couchdb database.\n\n\nvar db = new PouchDB(\nmy-local-contacts\n);\ndb.replicate.from(\nhttps://bob.cozycloud.cc/data/contacts\n);\ndb.replicate.to(\nhttps://bob.cozycloud.cc/data/contacts\n);\n\n\n\n\nTo suport this we need to:\n\n\n\n\nProxy \n/data/:doctype/_changes\n route with since, limit, feed=normal. Refuse\n  all filter parameters with a clear error message.\n  \n(Doc)\n\n\nAdd support of \nopen_revs\n, \nrevs\n, \nlatest\n query parameter to \nGET /data/:doctype/:docid\n\n  \n(Doc) \n\n\nProxy the \n/data/:doctype/_revs_diff\n\n  \n(Doc)\n\n  and \n/data/:doctype/_bulk_docs\n routes\n  \n(Doc)\n routes\n\n\nHave \n/data/:doctype/_ensure_full_commit\n\n  \n(Doc)\n returns 201\n\n\n\n\nThis will cover documents part of the Devices use case.\n\n\nContinuous replication\n\n\nIt is impossible to implement it by simply proxying to couchdb (see unlimited\ninactive users).\n\n\nThe current version of cozy-desktop uses it. \nTODISCUSS\n It could be replaced\nby 3-minutes polling without big losses in functionality, eventually with some\nmore triggers based on user activity.\n\n\nThe big use case for which we might want it is Sharing. But, because Sharing\nwill (first) be stack to stack, we might imagine having the source of event\n\nping\n the remote through a separate route.\n\n\nConclusion:\n Start with polling replication. Consider alternative\nnotifications mechanism when the usecase appears and eventually use time-limited\ncontinuous replication for a few special case (collaborative edit).\n\n\nRealtime\n\n\nOne of the cool feature of cozy apps was how changes are sent to the client in\nrealtime through websocket. However this have a cost: every cozy and every apps\nopen in a browser, even while not used keep one socket open on the server, this\nis not scalable to thousands of users.\n\n\nSeveral technology can be used for realtime: Websocket, SSE or COMET like\nlong-polling. Goroutines makes all solution similar performances wise. COMET is\na hack, websocket seems more popular and tested (x/net/websocket vs\nhtml5-sse-example). SSE is not widely available and has some limitations\n(headers\n)\n\n\nDepending on benchmarking, we can do some optimization on the feed:\n\n\n\n\nclose feeds when the user is not on screen\n\n\nmultiplex different applications\n feed, so each open cozy will only use one\n  socket to the server. This is hard, as all apps live on separate domain, an\n  (hackish) option might be a iframe/SharedWorker bridge.\n\n\n\n\nTo have some form of couchdb-to-stack continuous changes monitoring, we can\nmonitor \n_db_udpates\n\n\n(Doc)\n\nwhich gives us an update when a couchdb has changed. We can then perform a\n\n_changes\n query on this database to get the changed docs and proxy that to the\nstack-to-client change feed.\n\n\nConclusion:\n We will use Websocket from the client to the stack. We will try\nto avoid using continuous changes feed from couchdb to the stack. We will\noptimize if proven needed by benchmarks, starting with \nuseless\n changes and\neventually some multiplexing.\n\n\nSharing\n\n\nTo be completed by discussing with Science team.\n\n\nCurrent ideas (as understood by Romain)\n\n\n\n\nany filtered replication is unscalable\n\n\n1 db for all shared docs \nsharing_db\n.\n\n\nCozy-stack is responsible for saving documents that should be shared in both\n  their dg implemented by 2-way replication between the 2 users \nsharing_db\n,\n  filtering is done by computing a list of IDs and then \ndoc_ids\n (sharing with\n  filters/views are not efficient)\n\n\nSharing is performed by batches regularly.\n\n\nContinuous replication can be considered for collaborative editing.\n\n\n\n\nProposal by Romain, if we find \n_selector\n filter replication performances to be\nacceptable on very large / very old databases.\n\n\n\n\nNo sharing database\n\n\nA permission, for anything is a mango-style selector.\n\n\non every query, the Mango selector is checked at the stack or couchdb level\n  (\n$and\n-ing for queries, testing output document, input document)\n\n\nSharing is a filtered replication between user\ns 1 doctypedb et user\ns 2\n  samedoctypedb\n\n\nNo continuous replication\n\n\nUpon update, the stack trigger a PUSH replication to its remote or \nping\n the\n  remote, and the remote perform a normal PULL replication.\n\n\n\n\nTODO\n experiment with performance of \n_selector\n filtered replication in\ncouchdb2", 
            "title": "Replication"
        }, 
        {
            "location": "/cozy-stack/replication/#replication", 
            "text": "Replication is the ability of a cozy-stack to copy / move all or a subset of its\ndata to another support. It should cover 2 use cases   Devices: The continuous act of syncing change to a subset of the cozy\n  documents and files to and from an user cozy to the same user s Devices\n  through cozy-desktop and cozy-mobile  Sharing: The continuous act of syncing change to a subset of the cozy\n  documents and files to and from another user s cozy.   Replication will not be used for Moving, nor Backup. See associated docs in this\nfolder.  CouchDB replication is a well-understood, safe and stable algorithm ensuring\nreplication between two couchdb databases. It is delta-based, and is stateful:\nwe sync changes since a given checkpoint.", 
            "title": "Replication"
        }, 
        {
            "location": "/cozy-stack/replication/#files-synchronization", 
            "text": "Replication of too heavy database (with a lot of attachments) has been, in cozy\nexperience, the source of some bugs. To avoid that (and some other issues), in\ncozy-stack, the attachments are stored outside of couchdb.  This means we need a way to synchronize files in parallel to couchdb\nreplication.  Rsync is a well-understood, safe and stable algorithm to replicate files\nhierarchy from one hosts to the other by only transfering changes. It is\none-shot and stateless. It could be an inspiration if we have to focus on\nsyncing small changes to big files. The option to use rsync/zsync have been\ndiscussed internally (https://github.com/cozy/cozy-stack/pull/57   Sprint Start\n2016-10-24), but for now we should focus on using the files/folders couchdb\ndocument for synchronization purpose and upload/download the actual binaries\nwith existing files routes or considering webdav.  Useful golang package:  http://rclone.org/ sync folder in FS / Swift (may be\nwe can add a driver for cozy)", 
            "title": "Files synchronization"
        }, 
        {
            "location": "/cozy-stack/replication/#couchdb-replication-limitation", 
            "text": "Couchdb 2 replication protocol is described in details here .", 
            "title": "Couchdb replication &amp; limitation"
        }, 
        {
            "location": "/cozy-stack/replication/#quick-summary", 
            "text": "The replicator figures out what was the last sequence number  lastseqno \n   which was correctly synced from the source database, using a\n    _local/:replicationid  document.  The replicator  GET :source/changes?since=lastseqno limit=batchsize  and\n   identify which docs have changed (and their  open_revs ).  The replicator  POST :target/_revs_diff  to get a list of all revisions of\n   the changed documents the target does not know.  The replicator  GET :source/:docid?open_revs=['rev1', ...]  several times to\n   retrieve the missing documents revisions.  The replicator  POST :target/_bulk_docs  with these documents revisions.  Store the new last sequence number   Repeat 2-5 until there is no more changes.", 
            "title": "Quick summary"
        }, 
        {
            "location": "/cozy-stack/replication/#details", 
            "text": "In step 5, the replicator can also attempt to  PUT :target/:docid  if doc are\n  too heavy, but this should not happens in cozy-stack considering there wont be\n  attachment in couchdb.  In step 4, the replicator can optimize by calling  GET  The main difference from couchdb 1.X is in the replication history and the\n  manner to determine and store the last sequence number.  TODO:  actually\n  understand this and how it might increase disk usage if we have a lot of\n  replications.  Couchdb  _changes  and by extension replication can be either by polling or\n  continuous (SSE / COMET)  In couchdb benchmarking, we understood that the number of couch databases only\n  use a bit of disk space but no RAM or CPU  as long as the database is not\n  used . Having a continuous replication active force us to keep the database\n  file open and will starve RAM   FD usage. Moreover, continuous replication\n  costs a lot (cf. ScienceTeam benchmark). To permit an unlimited number of\n  inactive user on a single cozy-stack process,  the stack should avoid\n  continuous replication from couchdb .  Two way replication is simply two one way replications", 
            "title": "Details"
        }, 
        {
            "location": "/cozy-stack/replication/#routes-used-by-replication", 
            "text": "To be a source of replication, the stack only need to support the following\nroute (and query parameters):   GET :source/:docid  get revisions of a document. The query parameters\n   open_revs, revs, latest  is necessary for replication.  POST :source/_all_docs  is used by current version of cozy-mobile and pouchdb\n  as an optimization to fetch several document s revision at once.  GET :source/_changes  get a list of ID -  New Revision since a given sequence\n  number. The query parameters  since, limit  are necessary for replication.   To be a target of replication, the stack need to support the following routes:   POST :target/_revs_diff  takes a list of ID -  Rev and returns which one are\n  missing.  POST :target/_bulk_docs  create several documents at once  POST :target/_ensure_full_commit  ensure the documents are written to disk.\n  This is useless if couchdb is configured without delayed write (default), but\n  remote couchdb will call, so the stack should return the expected 201   In both case, we need to support   PUT :both/_local/:revdocid  to store the current sequence number.", 
            "title": "Routes used by replication"
        }, 
        {
            "location": "/cozy-stack/replication/#stack-sync-api-exploration", 
            "text": "", 
            "title": "Stack Sync API exploration"
        }, 
        {
            "location": "/cozy-stack/replication/#easy-part-1-dbdoctype-on-stack-and-remote-no-binaries", 
            "text": "We  just  need to implement the routes described above by proxying to the\nunderlying couchdb database.  var db = new PouchDB( my-local-contacts );\ndb.replicate.from( https://bob.cozycloud.cc/data/contacts );\ndb.replicate.to( https://bob.cozycloud.cc/data/contacts );  To suport this we need to:   Proxy  /data/:doctype/_changes  route with since, limit, feed=normal. Refuse\n  all filter parameters with a clear error message.\n   (Doc)  Add support of  open_revs ,  revs ,  latest  query parameter to  GET /data/:doctype/:docid \n   (Doc)   Proxy the  /data/:doctype/_revs_diff \n   (Doc) \n  and  /data/:doctype/_bulk_docs  routes\n   (Doc)  routes  Have  /data/:doctype/_ensure_full_commit \n   (Doc)  returns 201   This will cover documents part of the Devices use case.", 
            "title": "Easy part: 1 db/doctype on stack AND remote, no binaries"
        }, 
        {
            "location": "/cozy-stack/replication/#continuous-replication", 
            "text": "It is impossible to implement it by simply proxying to couchdb (see unlimited\ninactive users).  The current version of cozy-desktop uses it.  TODISCUSS  It could be replaced\nby 3-minutes polling without big losses in functionality, eventually with some\nmore triggers based on user activity.  The big use case for which we might want it is Sharing. But, because Sharing\nwill (first) be stack to stack, we might imagine having the source of event ping  the remote through a separate route.  Conclusion:  Start with polling replication. Consider alternative\nnotifications mechanism when the usecase appears and eventually use time-limited\ncontinuous replication for a few special case (collaborative edit).", 
            "title": "Continuous replication"
        }, 
        {
            "location": "/cozy-stack/replication/#realtime", 
            "text": "One of the cool feature of cozy apps was how changes are sent to the client in\nrealtime through websocket. However this have a cost: every cozy and every apps\nopen in a browser, even while not used keep one socket open on the server, this\nis not scalable to thousands of users.  Several technology can be used for realtime: Websocket, SSE or COMET like\nlong-polling. Goroutines makes all solution similar performances wise. COMET is\na hack, websocket seems more popular and tested (x/net/websocket vs\nhtml5-sse-example). SSE is not widely available and has some limitations\n(headers )  Depending on benchmarking, we can do some optimization on the feed:   close feeds when the user is not on screen  multiplex different applications  feed, so each open cozy will only use one\n  socket to the server. This is hard, as all apps live on separate domain, an\n  (hackish) option might be a iframe/SharedWorker bridge.   To have some form of couchdb-to-stack continuous changes monitoring, we can\nmonitor  _db_udpates  (Doc) \nwhich gives us an update when a couchdb has changed. We can then perform a _changes  query on this database to get the changed docs and proxy that to the\nstack-to-client change feed.  Conclusion:  We will use Websocket from the client to the stack. We will try\nto avoid using continuous changes feed from couchdb to the stack. We will\noptimize if proven needed by benchmarks, starting with  useless  changes and\neventually some multiplexing.", 
            "title": "Realtime"
        }, 
        {
            "location": "/cozy-stack/replication/#sharing", 
            "text": "To be completed by discussing with Science team.  Current ideas (as understood by Romain)   any filtered replication is unscalable  1 db for all shared docs  sharing_db .  Cozy-stack is responsible for saving documents that should be shared in both\n  their dg implemented by 2-way replication between the 2 users  sharing_db ,\n  filtering is done by computing a list of IDs and then  doc_ids  (sharing with\n  filters/views are not efficient)  Sharing is performed by batches regularly.  Continuous replication can be considered for collaborative editing.   Proposal by Romain, if we find  _selector  filter replication performances to be\nacceptable on very large / very old databases.   No sharing database  A permission, for anything is a mango-style selector.  on every query, the Mango selector is checked at the stack or couchdb level\n  ( $and -ing for queries, testing output document, input document)  Sharing is a filtered replication between user s 1 doctypedb et user s 2\n  samedoctypedb  No continuous replication  Upon update, the stack trigger a PUSH replication to its remote or  ping  the\n  remote, and the remote perform a normal PULL replication.   TODO  experiment with performance of  _selector  filtered replication in\ncouchdb2", 
            "title": "Sharing"
        }, 
        {
            "location": "/cozy-stack/couchdb-quirks/", 
            "text": "CouchDB Quirks\n\n\nMango indexes\n\n\nExists operator\n\n\nThe \n$exists\n\noperator\n\ncan be used with a mango index for the \ntrue\n value, but not for the \nfalse\n\nvalue. For \nfalse\n, a more heavy solution is required: \na partial\nindex\n.\n\n\nIndex selection\n\n\nCouchDB may accept or refuse to use a mango index for a query, with obsure\nreasons. In general, you can follow these two rules of thumb:\n\n\n\n\n\n\nAn index on the fields \nfoo, bar, baz\n can be used only to fetch documents\n   where \nfoo\n, \nbar\n, and \nbaz\n exist. It means that a query that filters only\n   on the value on \nfoo\n won\nt use the mango index, because it can miss a\n   document where \nfoo\n has the expected value but without \nbar\n or \nbaz\n. If\n   you know that all the documents that you want have the \nbar\n and \nbaz\n\n   fields, you can just add two filters \n$exists: true\n (one for \nbar\n, the\n   other for \nbaz\n).\n\n\n\n\n\n\nYou should use exactly the same sequence of fields for creating the index\n   and the \nsort\n operator of the query. If you have an index on \nos, browser,\n   ip\n for the \nio.cozy.sessions.logins\n, and you want to have all the\n   documents for a login from \nwindows\n, sorted by \nbrowser\n, you can use the\n   index, but you should use \nos, browser, ip\n for the sort (or at least \nos,\n   browser\n, even if it is seems to weird to sort on \nos\n when all the sorted\n   documents will have the same value, \nwindows\n). Please note that using\n   \nuse_index\n on a request, the results will be sorted by default according\n   to this rule. So, you can omit the \nsort\n operator on the query (except if\n   you want the \ndescending\n order).\n\n\n\n\n\n\nOld revisions\n\n\nCouchDB keeps for each document a list of its revision (or more exactly a tree\nwith replication and conflicts).\n\n\nIt\ns possible to ask the list of the old revisions of a document with \nGET\n/db/{docid}?revs_info=true\n.\nIt works only if the document has not been deleted. For a deleted document, \na\ntrick\n\nis to query the changes feed to know the last revision of the document, and to\nrecreate the document from this revision.\n\n\nWith an old revision, it\ns possible to get the content of the document at this\nrevision with \nGET /db/{docid}?rev={rev}\n if the database was not compacted.\nOn CouchDB 2.x, compacts happen automatically on all databases from times to\ntimes.\n\n\nA \npurge\n operation consists to remove the tombstone for the deleted\ndocuments. It is a manual operation, triggered by a\n\nPOST /db/_purge\n.\n\n\nConflicts\n\n\nIt is possible to create a conflict on CouchDB like it does for the\nreplication by using \nnew_edits\n, but it is not well documented to say the\nleast. The more accurate description is on the old wiki:\nhttps://wiki.apache.org/couchdb/HTTP_Bulk_Document_API#Posting_Existing_Revisions.\n\n\nIn short, it\ns a \nPUT /doc/{id}?new_edits=false\n with \n_rev\n the new revision\nof the document, and \n_revisions\n the parents of this revision in the\nrevisions tree of this document.", 
            "title": "CouchDB Quirks"
        }, 
        {
            "location": "/cozy-stack/couchdb-quirks/#couchdb-quirks", 
            "text": "", 
            "title": "CouchDB Quirks"
        }, 
        {
            "location": "/cozy-stack/couchdb-quirks/#mango-indexes", 
            "text": "", 
            "title": "Mango indexes"
        }, 
        {
            "location": "/cozy-stack/couchdb-quirks/#exists-operator", 
            "text": "The  $exists \noperator \ncan be used with a mango index for the  true  value, but not for the  false \nvalue. For  false , a more heavy solution is required:  a partial\nindex .", 
            "title": "Exists operator"
        }, 
        {
            "location": "/cozy-stack/couchdb-quirks/#index-selection", 
            "text": "CouchDB may accept or refuse to use a mango index for a query, with obsure\nreasons. In general, you can follow these two rules of thumb:    An index on the fields  foo, bar, baz  can be used only to fetch documents\n   where  foo ,  bar , and  baz  exist. It means that a query that filters only\n   on the value on  foo  won t use the mango index, because it can miss a\n   document where  foo  has the expected value but without  bar  or  baz . If\n   you know that all the documents that you want have the  bar  and  baz \n   fields, you can just add two filters  $exists: true  (one for  bar , the\n   other for  baz ).    You should use exactly the same sequence of fields for creating the index\n   and the  sort  operator of the query. If you have an index on  os, browser,\n   ip  for the  io.cozy.sessions.logins , and you want to have all the\n   documents for a login from  windows , sorted by  browser , you can use the\n   index, but you should use  os, browser, ip  for the sort (or at least  os,\n   browser , even if it is seems to weird to sort on  os  when all the sorted\n   documents will have the same value,  windows ). Please note that using\n    use_index  on a request, the results will be sorted by default according\n   to this rule. So, you can omit the  sort  operator on the query (except if\n   you want the  descending  order).", 
            "title": "Index selection"
        }, 
        {
            "location": "/cozy-stack/couchdb-quirks/#old-revisions", 
            "text": "CouchDB keeps for each document a list of its revision (or more exactly a tree\nwith replication and conflicts).  It s possible to ask the list of the old revisions of a document with  GET\n/db/{docid}?revs_info=true .\nIt works only if the document has not been deleted. For a deleted document,  a\ntrick \nis to query the changes feed to know the last revision of the document, and to\nrecreate the document from this revision.  With an old revision, it s possible to get the content of the document at this\nrevision with  GET /db/{docid}?rev={rev}  if the database was not compacted.\nOn CouchDB 2.x, compacts happen automatically on all databases from times to\ntimes.  A  purge  operation consists to remove the tombstone for the deleted\ndocuments. It is a manual operation, triggered by a POST /db/_purge .", 
            "title": "Old revisions"
        }, 
        {
            "location": "/cozy-stack/couchdb-quirks/#conflicts", 
            "text": "It is possible to create a conflict on CouchDB like it does for the\nreplication by using  new_edits , but it is not well documented to say the\nleast. The more accurate description is on the old wiki:\nhttps://wiki.apache.org/couchdb/HTTP_Bulk_Document_API#Posting_Existing_Revisions.  In short, it s a  PUT /doc/{id}?new_edits=false  with  _rev  the new revision\nof the document, and  _revisions  the parents of this revision in the\nrevisions tree of this document.", 
            "title": "Conflicts"
        }, 
        {
            "location": "/cozy-stack/files/", 
            "text": "Table of contents\n\n\nVirtual File System\n\n\nCozy applications can use files for storing binary content, like photos or bills\nin PDF. This service offers a REST API to manipulate easily without having to\nknow the underlying storage layer. The metadata are kept in CouchDB, but the\nbinaries can go to the local system, or a Swift instance.\n\n\nDirectories\n\n\nA directory is a container for files and sub-directories.\n\n\nIts path is the path of its parent, a slash (\n/\n), and its name. It\ns case\nsensitive.\n\n\nRoot directory\n\n\nThe root of the virtual file system is a special directory with id\n\nio.cozy.files.root-dir\n.\n\n\nYou can use it in any request where you would use a directory, except you cannot\ndelete it.\n\n\nPOST /files/:dir-id\n\n\nCreate a new directory. The \ndir-id\n parameter is optional. When it\ns not given,\nthe directory is created at the root of the virtual file system.\n\n\nQuery-String\n\n\n\n\n\n\n\n\nParameter\n\n\nDescription\n\n\n\n\n\n\n\n\n\n\nType\n\n\ndirectory\n\n\n\n\n\n\nName\n\n\nthe directory name\n\n\n\n\n\n\nTags\n\n\nan array of tags\n\n\n\n\n\n\n\n\nHTTP headers\n\n\n\n\n\n\n\n\nParameter\n\n\nDescription\n\n\n\n\n\n\n\n\n\n\nDate\n\n\nThe modification date of the directory\n\n\n\n\n\n\n\n\nRequest\n\n\nPOST /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81?Type=directory\nName=phone\nTags=bills,konnectors HTTP/1.1\nAccept: application/vnd.api+json\nDate: Mon, 19 Sep 2016 12:35:08 GMT\n\n\n\n\nStatus codes\n\n\n\n\n201 Created, when the directory has been successfully created\n\n\n404 Not Found, when the parent directory does not exist\n\n\n409 Conflict, when a directory with the same name already exists\n\n\n422 Unprocessable Entity, when the \nType\n or \nName\n parameter is missing or\n  invalid\n\n\n\n\nResponse\n\n\nHTTP/1.1 201 Created\nContent-Type: application/vnd.api+json\nLocation: http://cozy.example.com/files/6494e0ac-dfcb-11e5-88c1-472e84a9cbee\n\n\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.files\n,\n    \nid\n: \n6494e0ac-dfcb-11e5-88c1-472e84a9cbee\n,\n    \nmeta\n: {\n      \nrev\n: \n1-ff3beeb456eb\n\n    },\n    \nattributes\n: {\n      \ntype\n: \ndirectory\n,\n      \nname\n: \nphone\n,\n      \npath\n: \n/Documents/phone\n,\n      \ncreated_at\n: \n2016-09-19T12:35:08Z\n,\n      \nupdated_at\n: \n2016-09-19T12:35:08Z\n,\n      \ntags\n: [\nbills\n]\n    },\n    \nrelationships\n: {\n      \nparent\n: {\n        \nlinks\n: {\n          \nrelated\n: \n/files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81\n\n        },\n        \ndata\n: {\n          \ntype\n: \nio.cozy.files\n,\n          \nid\n: \nfce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81\n\n        }\n      }\n    },\n    \nlinks\n: {\n      \nself\n: \n/files/6494e0ac-dfcb-11e5-88c1-472e84a9cbee\n\n    }\n  }\n}\n\n\n\n\nGET /files/:file-id\n\n\nGet a directory or a file informations. In the case of a directory, it contains\nthe list of files and sub-directories inside it.\n\n\nContents is paginated following \njsonapi conventions\n.\nThe default limit is 30 entries.\n\n\nRequest\n\n\nGET /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 HTTP/1.1\nAccept: application/vnd.api+json\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \nlinks\n: {\n    \nnext\n:\n      \n/files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81?page[cursor]=9152d568-7e7c-11e6-a377-37cbfb190b4b\n\n  },\n  \ndata\n: {\n    \ntype\n: \nio.cozy.files\n,\n    \nid\n: \nfce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81\n,\n    \nmeta\n: {\n      \nrev\n: \n1-e36ab092\n\n    },\n    \nattributes\n: {\n      \ntype\n: \ndirectory\n,\n      \nname\n: \nDocuments\n,\n      \npath\n: \n/Documents\n,\n      \ncreated_at\n: \n2016-09-19T12:35:00Z\n,\n      \nupdated_at\n: \n2016-09-19T12:35:00Z\n,\n      \ntags\n: []\n    },\n    \nrelationships\n: {\n      \ncontents\n: {\n        \ndata\n: [\n          {\n            \ntype\n: \nio.cozy.files\n,\n            \nid\n: \n6494e0ac-dfcb-11e5-88c1-472e84a9cbee\n\n          },\n          {\n            \ntype\n: \nio.cozy.files\n,\n            \nid\n: \n9152d568-7e7c-11e6-a377-37cbfb190b4b\n\n          }\n        ]\n      }\n    },\n    \nlinks\n: {\n      \nself\n: \n/files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81\n\n    }\n  },\n  \nincluded\n: [\n    {\n      \ntype\n: \nio.cozy.files\n,\n      \nid\n: \n6494e0ac-dfcb-11e5-88c1-472e84a9cbee\n,\n      \nmeta\n: {\n        \nrev\n: \n1-ff3beeb456eb\n\n      },\n      \nattributes\n: {\n        \ntype\n: \ndirectory\n,\n        \nname\n: \nphone\n,\n        \npath\n: \n/Documents/phone\n,\n        \ncreated_at\n: \n2016-09-19T12:35:08Z\n,\n        \nupdated_at\n: \n2016-09-19T12:35:08Z\n,\n        \ntags\n: [\nbills\n]\n      },\n      \nrelationships\n: {\n        \nparent\n: {\n          \nlinks\n: {\n            \nrelated\n: \n/files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81\n\n          },\n          \ndata\n: {\n            \ntype\n: \nio.cozy.files\n,\n            \nid\n: \nfce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81\n\n          }\n        }\n      },\n      \nlinks\n: {\n        \nself\n: \n/files/6494e0ac-dfcb-11e5-88c1-472e84a9cbee\n\n      }\n    },\n    {\n      \ntype\n: \nio.cozy.files\n,\n      \nid\n: \n9152d568-7e7c-11e6-a377-37cbfb190b4b\n,\n      \nmeta\n: {\n        \nrev\n: \n1-0e6d5b72\n\n      },\n      \nattributes\n: {\n        \ntype\n: \nfile\n,\n        \nname\n: \nhello.txt\n,\n        \ntrashed\n: false,\n        \nmd5sum\n: \nODZmYjI2OWQxOTBkMmM4NQo=\n,\n        \ncreated_at\n: \n2016-09-19T12:38:04Z\n,\n        \nupdated_at\n: \n2016-09-19T12:38:04Z\n,\n        \ntags\n: [],\n        \nsize\n: 12,\n        \nexecutable\n: false,\n        \nclass\n: \ndocument\n,\n        \nmime\n: \ntext/plain\n\n      },\n      \nrelationships\n: {\n        \nparent\n: {\n          \nlinks\n: {\n            \nrelated\n: \n/files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81\n\n          },\n          \ndata\n: {\n            \ntype\n: \nio.cozy.files\n,\n            \nid\n: \nfce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81\n\n          }\n        }\n      },\n      \nlinks\n: {\n        \nself\n: \n/files/9152d568-7e7c-11e6-a377-37cbfb190b4b\n\n      }\n    }\n  ]\n}\n\n\n\n\nDELETE /files/:dir-id\n\n\nPut a directory and its subtree in the trash.\n\n\nHTTP headers\n\n\nIt\ns possible to send the \nIf-Match\n header, with the previous revision of the\nfile/directory (optional).\n\n\nFiles\n\n\nA file is a binary content with some metadata.\n\n\nPOST /files/:dir-id\n\n\nUpload a file\n\n\nQuery-String\n\n\n\n\n\n\n\n\nParameter\n\n\nDescription\n\n\n\n\n\n\n\n\n\n\nType\n\n\nfile\n\n\n\n\n\n\nName\n\n\nthe file name\n\n\n\n\n\n\nTags\n\n\nan array of tags\n\n\n\n\n\n\nExecutable\n\n\ntrue\n if the file is executable (UNIX permission)\n\n\n\n\n\n\n\n\nHTTP headers\n\n\n\n\n\n\n\n\nParameter\n\n\nDescription\n\n\n\n\n\n\n\n\n\n\nContent-Length\n\n\nThe file size\n\n\n\n\n\n\nContent-MD5\n\n\nA Base64-encoded binary MD5 sum of the file\n\n\n\n\n\n\nContent-Type\n\n\nThe mime-type of the file\n\n\n\n\n\n\nDate\n\n\nThe modification date of the file\n\n\n\n\n\n\n\n\nRequest\n\n\nPOST /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81?Type=file\nName=hello.txt HTTP/1.1\nAccept: application/vnd.api+json\nContent-Length: 12\nContent-MD5: hvsmnRkNLIX24EaM7KQqIA==\nContent-Type: text/plain\nDate: Mon, 19 Sep 2016 12:38:04 GMT\n\nHello world!\n\n\n\n\nStatus codes\n\n\n\n\n201 Created, when the file has been successfully created\n\n\n404 Not Found, when the parent directory does not exist\n\n\n409 Conflict, when a file with the same name already exists\n\n\n412 Precondition Failed, when the md5sum is \nContent-MD5\n is not equal to the\n  md5sum computed by the server\n\n\n422 Unprocessable Entity, when the sent data is invalid (for example, the\n  parent doesn\nt exist, \nType\n or \nName\n parameter is missing or invalid, etc.)\n\n\n\n\nResponse\n\n\nHTTP/1.1 201 Created\nContent-Type: application/vnd.api+json\nLocation: http://cozy.example.com/files/9152d568-7e7c-11e6-a377-37cbfb190b4b\n\n\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.files\n,\n    \nid\n: \n9152d568-7e7c-11e6-a377-37cbfb190b4b\n,\n    \nmeta\n: {\n      \nrev\n: \n1-0e6d5b72\n\n    },\n    \nattributes\n: {\n      \ntype\n: \nfile\n,\n      \nname\n: \nsunset.jpg\n,\n      \ntrashed\n: false,\n      \nmd5sum\n: \nODZmYjI2OWQxOTBkMmM4NQo=\n,\n      \ncreated_at\n: \n2016-09-19T12:38:04Z\n,\n      \nupdated_at\n: \n2016-09-19T12:38:04Z\n,\n      \ntags\n: [],\n      \nmetadata\n: {\n        \ndatetime\n: \n2016-09-18T20:38:04Z\n,\n        \nheight\n: 1080,\n        \nwidth\n: 1920\n      },\n      \nsize\n: 12,\n      \nexecutable\n: false,\n      \nclass\n: \nimage\n,\n      \nmime\n: \nimage/jpg\n\n    },\n    \nrelationships\n: {\n      \nparent\n: {\n        \nlinks\n: {\n          \nrelated\n: \n/files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81\n\n        },\n        \ndata\n: {\n          \ntype\n: \nio.cozy.files\n,\n          \nid\n: \nfce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81\n\n        }\n      },\n      \nreferenced_by\n: {\n        \nlinks\n: {\n          \nself\n:\n            \n/files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81/relationships/references\n\n        },\n        \ndata\n: [\n          {\n            \ntype\n: \nio.cozy.albums\n,\n            \nid\n: \n94375086-e2e2-11e6-81b9-5bc0b9dd4aa4\n\n          }\n        ]\n      }\n    },\n    \nlinks\n: {\n      \nself\n: \n/files/9152d568-7e7c-11e6-a377-37cbfb190b4b\n,\n      \nsmall\n:\n        \n/files/9152d568-7e7c-11e6-a377-37cbfb190b4b/thumbnails/0f9cda56674282ac/small\n,\n      \nmedium\n:\n        \n/files/9152d568-7e7c-11e6-a377-37cbfb190b4b/thumbnails/0f9cda56674282ac/medium\n,\n      \nlarge\n:\n        \n/files/9152d568-7e7c-11e6-a377-37cbfb190b4b/thumbnails/0f9cda56674282ac/large\n\n    }\n  }\n}\n\n\n\n\nNote\n: see \nreferences of documents in VFS\n for\nmore informations about the references field.\n\n\nGET /files/download/:file-id\n\n\nDownload the file content.\n\n\nBy default the \ncontent-disposition\n will be \ninline\n, but it will be\n\nattachment\n if the query string contains the parameter \nDl=1\n\n\nRequest\n\n\nGET /files/download/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 HTTP/1.1\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Length: 12\nContent-Disposition: inline; filename=\nhello.txt\n\nContent-Type: text/plain\n\nHello world!\n\n\n\n\nGET /files/download\n\n\nDownload the file content from its path.\n\n\nBy default the \ncontent-disposition\n will be \ninline\n, but it will be\n\nattachment\n if the query string contains the parameter \nDl=1\n\n\nRequest\n\n\nGET /files/download?Path=/Documents/hello.txt\nDl=1 HTTP/1.1\n\n\n\n\nGET /files/:file-id/thumbnails/:secret/:format\n\n\nGet a thumbnail of a file (for an image only). \n:format\n can be \nsmall\n\n(640x480), \nmedium\n (1280x720), or \nlarge\n (1920x1080).\n\n\nPUT /files/:file-id\n\n\nOverwrite a file\n\n\nHTTP headers\n\n\nThe HTTP headers are the same than for uploading a file. There is one additional\nheader, \nIf-Match\n, with the previous revision of the file (optional).\n\n\nRequest\n\n\nPUT /files/9152d568-7e7c-11e6-a377-37cbfb190b4b HTTP/1.1\nAccept: application/vnd.api+json\nContent-Length: 12\nContent-MD5: hvsmnRkNLIX24EaM7KQqIA==\nContent-Type: text/plain\nDate: Mon, 20 Sep 2016 16:43:12 GMT\nIf-Match: 1-0e6d5b72\n\nHELLO WORLD!\n\n\n\n\nStatus codes\n\n\n\n\n200 OK, when the file has been successfully overwritten\n\n\n404 Not Found, when the file wasn\nt existing\n\n\n412 Precondition Failed, when the \nIf-Match\n header is set and doesn\nt match\n  the last revision of the file\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.files\n,\n    \nid\n: \n9152d568-7e7c-11e6-a377-37cbfb190b4b\n,\n    \nmeta\n: {\n      \nrev\n: \n2-d903b54c\n\n    },\n    \nattributes\n: {\n      \ntype\n: \nfile\n,\n      \nname\n: \nhello.txt\n,\n      \ntrashed\n: false,\n      \nmd5sum\n: \nYjU5YmMzN2Q2NDQxZDk2Nwo=\n,\n      \ncreated_at\n: \n2016-09-19T12:38:04Z\n,\n      \nupdated_at\n: \n2016-09-19T12:38:04Z\n,\n      \ntags\n: [],\n      \nsize\n: 12,\n      \nexecutable\n: false,\n      \nclass\n: \ndocument\n,\n      \nmime\n: \ntext/plain\n\n    },\n    \nrelationships\n: {\n      \nparent\n: {\n        \nlinks\n: {\n          \nrelated\n: \n/files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81\n\n        },\n        \ndata\n: {\n          \ntype\n: \nio.cozy.files\n,\n          \nid\n: \nfce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81\n\n        }\n      }\n    },\n    \nlinks\n: {\n      \nself\n: \n/files/9152d568-7e7c-11e6-a377-37cbfb190b4b\n\n    }\n  }\n}\n\n\n\n\nDELETE /files/:file-id\n\n\nPut a file in the trash.\n\n\nCommon\n\n\nGET /files/metadata\n\n\nSame as \n/files/:file-id\n but to retrieve informations from a path.\n\n\nRequest\n\n\nGET /files/metadata?Path=/Documents/hello.txt HTTP/1.1\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\nLocation: http://cozy.example.com/files/9152d568-7e7c-11e6-a377-37cbfb190b4b\n\n\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.files\n,\n    \nid\n: \n9152d568-7e7c-11e6-a377-37cbfb190b4b\n,\n    \nmeta\n: {\n      \nrev\n: \n1-0e6d5b72\n\n    },\n    \nattributes\n: {\n      \ntype\n: \nfile\n,\n      \nname\n: \nhello.txt\n,\n      \ntrashed\n: false,\n      \nmd5sum\n: \nODZmYjI2OWQxOTBkMmM4NQo=\n,\n      \ncreated_at\n: \n2016-09-19T12:38:04Z\n,\n      \nupdated_at\n: \n2016-09-19T12:38:04Z\n,\n      \ntags\n: [],\n      \nsize\n: 12,\n      \nexecutable\n: false,\n      \nclass\n: \ndocument\n,\n      \nmime\n: \ntext/plain\n\n    },\n    \nrelationships\n: {\n      \nparent\n: {\n        \nlinks\n: {\n          \nrelated\n: \n/files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81\n\n        },\n        \ndata\n: {\n          \ntype\n: \nio.cozy.files\n,\n          \nid\n: \nfce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81\n\n        }\n      }\n    },\n    \nlinks\n: {\n      \nself\n: \n/files/9152d568-7e7c-11e6-a377-37cbfb190b4b\n\n    }\n  }\n}\n\n\n\n\nPATCH /files/:file-id and PATCH /files/metadata\n\n\nBoth endpoints can be used to update the metadata of a file or directory, or to\nrename/move it. The difference is the first one uses an id to identify the\nfile/directory to update, and the second one uses the path.\n\n\nThe \ndir_id\n attribute can be updated to move a file or directory.\n\n\nHTTP headers\n\n\nIt\ns possible to send the \nIf-Match\n header, with the previous revision of the\nfile/directory (optional).\n\n\nRequest\n\n\nPATCH /files/9152d568-7e7c-11e6-a377-37cbfb190b4b HTTP/1.1\nAccept: application/vnd.api+json\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.files\n,\n    \nid\n: \n9152d568-7e7c-11e6-a377-37cbfb190b4b\n,\n    \nattributes\n: {\n      \ntype\n: \nfile\n,\n      \nname\n: \nhi.txt\n,\n      \ndir_id\n: \nf2f36fec-8018-11e6-abd8-8b3814d9a465\n,\n      \ntrashed\n: false,\n      \ntags\n: [\npoem\n]\n    }\n  }\n}\n\n\n\n\nStatus codes\n\n\n\n\n200 OK, when the file or directory metadata has been successfully updated\n\n\n400 Bad Request, when a the directory is asked to move to one of its\n  sub-directories\n\n\n404 Not Found, when the file/directory wasn\nt existing\n\n\n412 Precondition Failed, when the \nIf-Match\n header is set and doesn\nt match\n  the last revision of the file/directory\n\n\n422 Unprocessable Entity, when the sent data is invalid (for example, the\n  parent doesn\nt exist)\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\nLocation: http://cozy.example.com/files/9152d568-7e7c-11e6-a377-37cbfb190b4b\n\n\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.files\n,\n    \nid\n: \n9152d568-7e7c-11e6-a377-37cbfb190b4b\n,\n    \nmeta\n: {\n      \nrev\n: \n1-0e6d5b72\n\n    },\n    \nattributes\n: {\n      \ntype\n: \nfile\n,\n      \nname\n: \nhi.txt\n,\n      \ntrashed\n: false,\n      \nmd5sum\n: \nODZmYjI2OWQxOTBkMmM4NQo=\n,\n      \ncreated_at\n: \n2016-09-19T12:38:04Z\n,\n      \nupdated_at\n: \n2016-09-19T12:38:04Z\n,\n      \ntags\n: [\npoem\n],\n      \nsize\n: 12,\n      \nexecutable\n: false,\n      \nclass\n: \ndocument\n,\n      \nmime\n: \ntext/plain\n\n    },\n    \nrelationships\n: {\n      \nparent\n: {\n        \nlinks\n: {\n          \nrelated\n: \n/files/f2f36fec-8018-11e6-abd8-8b3814d9a465\n\n        },\n        \ndata\n: {\n          \ntype\n: \nio.cozy.files\n,\n          \nid\n: \nf2f36fec-8018-11e6-abd8-8b3814d9a465\n\n        }\n      }\n    },\n    \nlinks\n: {\n      \nself\n: \n/files/9152d568-7e7c-11e6-a377-37cbfb190b4b\n\n    }\n  }\n}\n\n\n\n\nPOST /files/archive\n\n\nCreate an archive. The body of the request lists the files and directories that\nwill be included in the archive. For directories, it includes all the files and\nsub-directories in the archive.\n\n\nIt\ns possible to give a file by its id (in the \nids\n array) or by its path (in\nthe \nfiles\n array).\n\n\nRequest\n\n\nPOST /files/archive HTTP/1.1\nAccept: application/zip\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.files.archives\n,\n    \nattributes\n: {\n      \nname\n: \nproject-X\n,\n      \nids\n: [\na51aeeea-4f79-11e7-9dc4-83f67e9494ab\n],\n      \nfiles\n: [\n        \n/Documents/bills\n,\n        \n/Documents/images/sunset.jpg\n,\n        \n/Documents/images/eiffel-tower.jpg\n\n      ]\n    }\n  }\n}\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \nlinks\n: {\n    \nrelated\n: \n/files/archive/4521DC87/project-X.zip\n\n  },\n  \ndata\n: {\n    \ntype\n: \nio.cozy.files.archives\n,\n    \nid\n: \n4521DC87\n,\n    \nattributes\n: {\n      \nhref\n: \n/files/archive/4521DC87/project-X.zip\n\n    }\n  }\n}\n\n\n\n\nGET /files/archive/:key/:name\n\n\nDownload a previously created archive. The name parameter is not used in the\nstack but aims to allow setting a name even for browser / downloader that do not\nsupport Content-Disposition filename.\n\n\nThis route does not require Basic Authentification\n\n\nGET /files/archive/4521DC87/project-X.zip HTTP/1.1\nAccept: application/zip\nContent-Length: 12345\nContent-Disposition: attachment; filename=\nproject-X.zip\n\nContent-Type: application/zip\n\n\n\n\nPOST /files/downloads?Path=file_path\n\n\nCreate a file download. The Path query parameter specifies the file to download.\nThe response json API links contains a \nrelated\n link for downloading the file,\nsee below.\n\n\nPOST /files/downloads?Id=file_id\n\n\nAlso create a file download. But it takes the id of the file and not its path.\n\n\nGET /files/downloads/:secret/:name\n\n\nAllows to download a file with a secret created from the route above.\n\n\nThe name parameter is not used in the stack but aims to allow setting a name\neven for browser / downloader that do not support Content-Disposition filename.\n\n\nBy default the \ncontent-disposition\n will be \ninline\n, but it will be\n\nattachment\n if the query string contains the parameter \nDl=1\n\n\nThis route does not require Basic Authentification\n\n\nTrash\n\n\nWhen a file is deleted, it is first moved to the trash. In the trash, it can be\nrestored. Or, after some time, it will be removed from the trash and permanently\ndestroyed.\n\n\nThe file \ntrashed\n attribute will be set to true.\n\n\nGET /files/trash\n\n\nList the files inside the trash. It\ns paginated.\n\n\nQuery-String\n\n\n\n\n\n\n\n\nParameter\n\n\nDescription\n\n\n\n\n\n\n\n\n\n\npage[cursor]\n\n\nthe last id of the results\n\n\n\n\n\n\npage[limit]\n\n\nthe number of entries (30 by default)\n\n\n\n\n\n\n\n\nRequest\n\n\nGET /files/trash HTTP/1.1\nAccept: application/vnd.api+json\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: [\n    {\n      \ntype\n: \nio.cozy.files\n,\n      \nid\n: \ndf24aac0-7f3d-11e6-81c0-d38812bfa0a8\n,\n      \nmeta\n: {\n        \nrev\n: \n1-3b75377c\n\n      },\n      \nattributes\n: {\n        \ntype\n: \nfile\n,\n        \nname\n: \nfoo.txt\n,\n        \ntrashed\n: true,\n        \nmd5sum\n: \nYjAxMzQxZTc4MDNjODAwYwo=\n,\n        \ncreated_at\n: \n2016-09-19T12:38:04Z\n,\n        \nupdated_at\n: \n2016-09-19T12:38:04Z\n,\n        \ntags\n: [],\n        \nsize\n: 123,\n        \nexecutable\n: false,\n        \nclass\n: \ndocument\n,\n        \nmime\n: \ntext/plain\n\n      },\n      \nlinks\n: {\n        \nself\n: \n/files/trash/df24aac0-7f3d-11e6-81c0-d38812bfa0a8\n\n      }\n    },\n    {\n      \ntype\n: \nio.cozy.files\n,\n      \nid\n: \n4a4fc582-7f3e-11e6-b9ca-278406b6ddd4\n,\n      \nmeta\n: {\n        \nrev\n: \n1-4a09030e\n\n      },\n      \nattributes\n: {\n        \ntype\n: \nfile\n,\n        \nname\n: \nbar.txt\n,\n        \ntrashed\n: true,\n        \nmd5sum\n: \nYWVhYjg3ZWI0OWQzZjRlMAo=\n,\n        \ncreated_at\n: \n2016-09-19T12:38:04Z\n,\n        \nupdated_at\n: \n2016-09-19T12:38:04Z\n,\n        \ntags\n: [],\n        \nsize\n: 456,\n        \nexecutable\n: false,\n        \nclass\n: \ndocument\n,\n        \nmime\n: \ntext/plain\n\n      },\n      \nlinks\n: {\n        \nself\n: \n/files/trash/4a4fc582-7f3e-11e6-b9ca-278406b6ddd4\n\n      }\n    }\n  ]\n}\n\n\n\n\nPOST /files/trash/:file-id\n\n\nRestore the file with the \nfile-id\n identifiant.\n\n\nThe file\ns \ntrashed\n attributes will be set to false.\n\n\nDELETE /files/trash/:file-id\n\n\nDestroy the file and make it unrecoverable (it will still be available in\nbackups).\n\n\nDELETE /files/trash\n\n\nClear out the trash.\n\n\nTrashed attribute\n\n\nAll files that are inside the trash will have a \ntrashed: true\n attribute. This\nattribute can be used in mango queries to only get \ninteresting\n files.", 
            "title": "/files - Virtual File System"
        }, 
        {
            "location": "/cozy-stack/files/#virtual-file-system", 
            "text": "Cozy applications can use files for storing binary content, like photos or bills\nin PDF. This service offers a REST API to manipulate easily without having to\nknow the underlying storage layer. The metadata are kept in CouchDB, but the\nbinaries can go to the local system, or a Swift instance.", 
            "title": "Virtual File System"
        }, 
        {
            "location": "/cozy-stack/files/#directories", 
            "text": "A directory is a container for files and sub-directories.  Its path is the path of its parent, a slash ( / ), and its name. It s case\nsensitive.", 
            "title": "Directories"
        }, 
        {
            "location": "/cozy-stack/files/#root-directory", 
            "text": "The root of the virtual file system is a special directory with id io.cozy.files.root-dir .  You can use it in any request where you would use a directory, except you cannot\ndelete it.", 
            "title": "Root directory"
        }, 
        {
            "location": "/cozy-stack/files/#post-filesdir-id", 
            "text": "Create a new directory. The  dir-id  parameter is optional. When it s not given,\nthe directory is created at the root of the virtual file system.", 
            "title": "POST /files/:dir-id"
        }, 
        {
            "location": "/cozy-stack/files/#query-string", 
            "text": "Parameter  Description      Type  directory    Name  the directory name    Tags  an array of tags", 
            "title": "Query-String"
        }, 
        {
            "location": "/cozy-stack/files/#http-headers", 
            "text": "Parameter  Description      Date  The modification date of the directory", 
            "title": "HTTP headers"
        }, 
        {
            "location": "/cozy-stack/files/#request", 
            "text": "POST /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81?Type=directory Name=phone Tags=bills,konnectors HTTP/1.1\nAccept: application/vnd.api+json\nDate: Mon, 19 Sep 2016 12:35:08 GMT", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/files/#status-codes", 
            "text": "201 Created, when the directory has been successfully created  404 Not Found, when the parent directory does not exist  409 Conflict, when a directory with the same name already exists  422 Unprocessable Entity, when the  Type  or  Name  parameter is missing or\n  invalid", 
            "title": "Status codes"
        }, 
        {
            "location": "/cozy-stack/files/#response", 
            "text": "HTTP/1.1 201 Created\nContent-Type: application/vnd.api+json\nLocation: http://cozy.example.com/files/6494e0ac-dfcb-11e5-88c1-472e84a9cbee  {\n   data : {\n     type :  io.cozy.files ,\n     id :  6494e0ac-dfcb-11e5-88c1-472e84a9cbee ,\n     meta : {\n       rev :  1-ff3beeb456eb \n    },\n     attributes : {\n       type :  directory ,\n       name :  phone ,\n       path :  /Documents/phone ,\n       created_at :  2016-09-19T12:35:08Z ,\n       updated_at :  2016-09-19T12:35:08Z ,\n       tags : [ bills ]\n    },\n     relationships : {\n       parent : {\n         links : {\n           related :  /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 \n        },\n         data : {\n           type :  io.cozy.files ,\n           id :  fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 \n        }\n      }\n    },\n     links : {\n       self :  /files/6494e0ac-dfcb-11e5-88c1-472e84a9cbee \n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/files/#get-filesfile-id", 
            "text": "Get a directory or a file informations. In the case of a directory, it contains\nthe list of files and sub-directories inside it.  Contents is paginated following  jsonapi conventions .\nThe default limit is 30 entries.", 
            "title": "GET /files/:file-id"
        }, 
        {
            "location": "/cozy-stack/files/#request_1", 
            "text": "GET /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 HTTP/1.1\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/files/#response_1", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json  {\n   links : {\n     next :\n       /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81?page[cursor]=9152d568-7e7c-11e6-a377-37cbfb190b4b \n  },\n   data : {\n     type :  io.cozy.files ,\n     id :  fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 ,\n     meta : {\n       rev :  1-e36ab092 \n    },\n     attributes : {\n       type :  directory ,\n       name :  Documents ,\n       path :  /Documents ,\n       created_at :  2016-09-19T12:35:00Z ,\n       updated_at :  2016-09-19T12:35:00Z ,\n       tags : []\n    },\n     relationships : {\n       contents : {\n         data : [\n          {\n             type :  io.cozy.files ,\n             id :  6494e0ac-dfcb-11e5-88c1-472e84a9cbee \n          },\n          {\n             type :  io.cozy.files ,\n             id :  9152d568-7e7c-11e6-a377-37cbfb190b4b \n          }\n        ]\n      }\n    },\n     links : {\n       self :  /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 \n    }\n  },\n   included : [\n    {\n       type :  io.cozy.files ,\n       id :  6494e0ac-dfcb-11e5-88c1-472e84a9cbee ,\n       meta : {\n         rev :  1-ff3beeb456eb \n      },\n       attributes : {\n         type :  directory ,\n         name :  phone ,\n         path :  /Documents/phone ,\n         created_at :  2016-09-19T12:35:08Z ,\n         updated_at :  2016-09-19T12:35:08Z ,\n         tags : [ bills ]\n      },\n       relationships : {\n         parent : {\n           links : {\n             related :  /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 \n          },\n           data : {\n             type :  io.cozy.files ,\n             id :  fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 \n          }\n        }\n      },\n       links : {\n         self :  /files/6494e0ac-dfcb-11e5-88c1-472e84a9cbee \n      }\n    },\n    {\n       type :  io.cozy.files ,\n       id :  9152d568-7e7c-11e6-a377-37cbfb190b4b ,\n       meta : {\n         rev :  1-0e6d5b72 \n      },\n       attributes : {\n         type :  file ,\n         name :  hello.txt ,\n         trashed : false,\n         md5sum :  ODZmYjI2OWQxOTBkMmM4NQo= ,\n         created_at :  2016-09-19T12:38:04Z ,\n         updated_at :  2016-09-19T12:38:04Z ,\n         tags : [],\n         size : 12,\n         executable : false,\n         class :  document ,\n         mime :  text/plain \n      },\n       relationships : {\n         parent : {\n           links : {\n             related :  /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 \n          },\n           data : {\n             type :  io.cozy.files ,\n             id :  fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 \n          }\n        }\n      },\n       links : {\n         self :  /files/9152d568-7e7c-11e6-a377-37cbfb190b4b \n      }\n    }\n  ]\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/files/#delete-filesdir-id", 
            "text": "Put a directory and its subtree in the trash.", 
            "title": "DELETE /files/:dir-id"
        }, 
        {
            "location": "/cozy-stack/files/#http-headers_1", 
            "text": "It s possible to send the  If-Match  header, with the previous revision of the\nfile/directory (optional).", 
            "title": "HTTP headers"
        }, 
        {
            "location": "/cozy-stack/files/#files", 
            "text": "A file is a binary content with some metadata.", 
            "title": "Files"
        }, 
        {
            "location": "/cozy-stack/files/#post-filesdir-id_1", 
            "text": "Upload a file", 
            "title": "POST /files/:dir-id"
        }, 
        {
            "location": "/cozy-stack/files/#query-string_1", 
            "text": "Parameter  Description      Type  file    Name  the file name    Tags  an array of tags    Executable  true  if the file is executable (UNIX permission)", 
            "title": "Query-String"
        }, 
        {
            "location": "/cozy-stack/files/#http-headers_2", 
            "text": "Parameter  Description      Content-Length  The file size    Content-MD5  A Base64-encoded binary MD5 sum of the file    Content-Type  The mime-type of the file    Date  The modification date of the file", 
            "title": "HTTP headers"
        }, 
        {
            "location": "/cozy-stack/files/#request_2", 
            "text": "POST /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81?Type=file Name=hello.txt HTTP/1.1\nAccept: application/vnd.api+json\nContent-Length: 12\nContent-MD5: hvsmnRkNLIX24EaM7KQqIA==\nContent-Type: text/plain\nDate: Mon, 19 Sep 2016 12:38:04 GMT\n\nHello world!", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/files/#status-codes_1", 
            "text": "201 Created, when the file has been successfully created  404 Not Found, when the parent directory does not exist  409 Conflict, when a file with the same name already exists  412 Precondition Failed, when the md5sum is  Content-MD5  is not equal to the\n  md5sum computed by the server  422 Unprocessable Entity, when the sent data is invalid (for example, the\n  parent doesn t exist,  Type  or  Name  parameter is missing or invalid, etc.)", 
            "title": "Status codes"
        }, 
        {
            "location": "/cozy-stack/files/#response_2", 
            "text": "HTTP/1.1 201 Created\nContent-Type: application/vnd.api+json\nLocation: http://cozy.example.com/files/9152d568-7e7c-11e6-a377-37cbfb190b4b  {\n   data : {\n     type :  io.cozy.files ,\n     id :  9152d568-7e7c-11e6-a377-37cbfb190b4b ,\n     meta : {\n       rev :  1-0e6d5b72 \n    },\n     attributes : {\n       type :  file ,\n       name :  sunset.jpg ,\n       trashed : false,\n       md5sum :  ODZmYjI2OWQxOTBkMmM4NQo= ,\n       created_at :  2016-09-19T12:38:04Z ,\n       updated_at :  2016-09-19T12:38:04Z ,\n       tags : [],\n       metadata : {\n         datetime :  2016-09-18T20:38:04Z ,\n         height : 1080,\n         width : 1920\n      },\n       size : 12,\n       executable : false,\n       class :  image ,\n       mime :  image/jpg \n    },\n     relationships : {\n       parent : {\n         links : {\n           related :  /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 \n        },\n         data : {\n           type :  io.cozy.files ,\n           id :  fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 \n        }\n      },\n       referenced_by : {\n         links : {\n           self :\n             /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81/relationships/references \n        },\n         data : [\n          {\n             type :  io.cozy.albums ,\n             id :  94375086-e2e2-11e6-81b9-5bc0b9dd4aa4 \n          }\n        ]\n      }\n    },\n     links : {\n       self :  /files/9152d568-7e7c-11e6-a377-37cbfb190b4b ,\n       small :\n         /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/thumbnails/0f9cda56674282ac/small ,\n       medium :\n         /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/thumbnails/0f9cda56674282ac/medium ,\n       large :\n         /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/thumbnails/0f9cda56674282ac/large \n    }\n  }\n}  Note : see  references of documents in VFS  for\nmore informations about the references field.", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/files/#get-filesdownloadfile-id", 
            "text": "Download the file content.  By default the  content-disposition  will be  inline , but it will be attachment  if the query string contains the parameter  Dl=1", 
            "title": "GET /files/download/:file-id"
        }, 
        {
            "location": "/cozy-stack/files/#request_3", 
            "text": "GET /files/download/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 HTTP/1.1", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/files/#response_3", 
            "text": "HTTP/1.1 200 OK\nContent-Length: 12\nContent-Disposition: inline; filename= hello.txt \nContent-Type: text/plain\n\nHello world!", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/files/#get-filesdownload", 
            "text": "Download the file content from its path.  By default the  content-disposition  will be  inline , but it will be attachment  if the query string contains the parameter  Dl=1", 
            "title": "GET /files/download"
        }, 
        {
            "location": "/cozy-stack/files/#request_4", 
            "text": "GET /files/download?Path=/Documents/hello.txt Dl=1 HTTP/1.1", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/files/#get-filesfile-idthumbnailssecretformat", 
            "text": "Get a thumbnail of a file (for an image only).  :format  can be  small \n(640x480),  medium  (1280x720), or  large  (1920x1080).", 
            "title": "GET /files/:file-id/thumbnails/:secret/:format"
        }, 
        {
            "location": "/cozy-stack/files/#put-filesfile-id", 
            "text": "Overwrite a file", 
            "title": "PUT /files/:file-id"
        }, 
        {
            "location": "/cozy-stack/files/#http-headers_3", 
            "text": "The HTTP headers are the same than for uploading a file. There is one additional\nheader,  If-Match , with the previous revision of the file (optional).", 
            "title": "HTTP headers"
        }, 
        {
            "location": "/cozy-stack/files/#request_5", 
            "text": "PUT /files/9152d568-7e7c-11e6-a377-37cbfb190b4b HTTP/1.1\nAccept: application/vnd.api+json\nContent-Length: 12\nContent-MD5: hvsmnRkNLIX24EaM7KQqIA==\nContent-Type: text/plain\nDate: Mon, 20 Sep 2016 16:43:12 GMT\nIf-Match: 1-0e6d5b72\n\nHELLO WORLD!", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/files/#status-codes_2", 
            "text": "200 OK, when the file has been successfully overwritten  404 Not Found, when the file wasn t existing  412 Precondition Failed, when the  If-Match  header is set and doesn t match\n  the last revision of the file", 
            "title": "Status codes"
        }, 
        {
            "location": "/cozy-stack/files/#response_4", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json  {\n   data : {\n     type :  io.cozy.files ,\n     id :  9152d568-7e7c-11e6-a377-37cbfb190b4b ,\n     meta : {\n       rev :  2-d903b54c \n    },\n     attributes : {\n       type :  file ,\n       name :  hello.txt ,\n       trashed : false,\n       md5sum :  YjU5YmMzN2Q2NDQxZDk2Nwo= ,\n       created_at :  2016-09-19T12:38:04Z ,\n       updated_at :  2016-09-19T12:38:04Z ,\n       tags : [],\n       size : 12,\n       executable : false,\n       class :  document ,\n       mime :  text/plain \n    },\n     relationships : {\n       parent : {\n         links : {\n           related :  /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 \n        },\n         data : {\n           type :  io.cozy.files ,\n           id :  fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 \n        }\n      }\n    },\n     links : {\n       self :  /files/9152d568-7e7c-11e6-a377-37cbfb190b4b \n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/files/#delete-filesfile-id", 
            "text": "Put a file in the trash.", 
            "title": "DELETE /files/:file-id"
        }, 
        {
            "location": "/cozy-stack/files/#common", 
            "text": "", 
            "title": "Common"
        }, 
        {
            "location": "/cozy-stack/files/#get-filesmetadata", 
            "text": "Same as  /files/:file-id  but to retrieve informations from a path.", 
            "title": "GET /files/metadata"
        }, 
        {
            "location": "/cozy-stack/files/#request_6", 
            "text": "GET /files/metadata?Path=/Documents/hello.txt HTTP/1.1", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/files/#response_5", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\nLocation: http://cozy.example.com/files/9152d568-7e7c-11e6-a377-37cbfb190b4b  {\n   data : {\n     type :  io.cozy.files ,\n     id :  9152d568-7e7c-11e6-a377-37cbfb190b4b ,\n     meta : {\n       rev :  1-0e6d5b72 \n    },\n     attributes : {\n       type :  file ,\n       name :  hello.txt ,\n       trashed : false,\n       md5sum :  ODZmYjI2OWQxOTBkMmM4NQo= ,\n       created_at :  2016-09-19T12:38:04Z ,\n       updated_at :  2016-09-19T12:38:04Z ,\n       tags : [],\n       size : 12,\n       executable : false,\n       class :  document ,\n       mime :  text/plain \n    },\n     relationships : {\n       parent : {\n         links : {\n           related :  /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 \n        },\n         data : {\n           type :  io.cozy.files ,\n           id :  fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 \n        }\n      }\n    },\n     links : {\n       self :  /files/9152d568-7e7c-11e6-a377-37cbfb190b4b \n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/files/#patch-filesfile-id-and-patch-filesmetadata", 
            "text": "Both endpoints can be used to update the metadata of a file or directory, or to\nrename/move it. The difference is the first one uses an id to identify the\nfile/directory to update, and the second one uses the path.  The  dir_id  attribute can be updated to move a file or directory.", 
            "title": "PATCH /files/:file-id and PATCH /files/metadata"
        }, 
        {
            "location": "/cozy-stack/files/#http-headers_4", 
            "text": "It s possible to send the  If-Match  header, with the previous revision of the\nfile/directory (optional).", 
            "title": "HTTP headers"
        }, 
        {
            "location": "/cozy-stack/files/#request_7", 
            "text": "PATCH /files/9152d568-7e7c-11e6-a377-37cbfb190b4b HTTP/1.1\nAccept: application/vnd.api+json\nContent-Type: application/vnd.api+json  {\n   data : {\n     type :  io.cozy.files ,\n     id :  9152d568-7e7c-11e6-a377-37cbfb190b4b ,\n     attributes : {\n       type :  file ,\n       name :  hi.txt ,\n       dir_id :  f2f36fec-8018-11e6-abd8-8b3814d9a465 ,\n       trashed : false,\n       tags : [ poem ]\n    }\n  }\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/files/#status-codes_3", 
            "text": "200 OK, when the file or directory metadata has been successfully updated  400 Bad Request, when a the directory is asked to move to one of its\n  sub-directories  404 Not Found, when the file/directory wasn t existing  412 Precondition Failed, when the  If-Match  header is set and doesn t match\n  the last revision of the file/directory  422 Unprocessable Entity, when the sent data is invalid (for example, the\n  parent doesn t exist)", 
            "title": "Status codes"
        }, 
        {
            "location": "/cozy-stack/files/#response_6", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\nLocation: http://cozy.example.com/files/9152d568-7e7c-11e6-a377-37cbfb190b4b  {\n   data : {\n     type :  io.cozy.files ,\n     id :  9152d568-7e7c-11e6-a377-37cbfb190b4b ,\n     meta : {\n       rev :  1-0e6d5b72 \n    },\n     attributes : {\n       type :  file ,\n       name :  hi.txt ,\n       trashed : false,\n       md5sum :  ODZmYjI2OWQxOTBkMmM4NQo= ,\n       created_at :  2016-09-19T12:38:04Z ,\n       updated_at :  2016-09-19T12:38:04Z ,\n       tags : [ poem ],\n       size : 12,\n       executable : false,\n       class :  document ,\n       mime :  text/plain \n    },\n     relationships : {\n       parent : {\n         links : {\n           related :  /files/f2f36fec-8018-11e6-abd8-8b3814d9a465 \n        },\n         data : {\n           type :  io.cozy.files ,\n           id :  f2f36fec-8018-11e6-abd8-8b3814d9a465 \n        }\n      }\n    },\n     links : {\n       self :  /files/9152d568-7e7c-11e6-a377-37cbfb190b4b \n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/files/#post-filesarchive", 
            "text": "Create an archive. The body of the request lists the files and directories that\nwill be included in the archive. For directories, it includes all the files and\nsub-directories in the archive.  It s possible to give a file by its id (in the  ids  array) or by its path (in\nthe  files  array).", 
            "title": "POST /files/archive"
        }, 
        {
            "location": "/cozy-stack/files/#request_8", 
            "text": "POST /files/archive HTTP/1.1\nAccept: application/zip\nContent-Type: application/vnd.api+json  {\n   data : {\n     type :  io.cozy.files.archives ,\n     attributes : {\n       name :  project-X ,\n       ids : [ a51aeeea-4f79-11e7-9dc4-83f67e9494ab ],\n       files : [\n         /Documents/bills ,\n         /Documents/images/sunset.jpg ,\n         /Documents/images/eiffel-tower.jpg \n      ]\n    }\n  }\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/files/#response_7", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json  {\n   links : {\n     related :  /files/archive/4521DC87/project-X.zip \n  },\n   data : {\n     type :  io.cozy.files.archives ,\n     id :  4521DC87 ,\n     attributes : {\n       href :  /files/archive/4521DC87/project-X.zip \n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/files/#get-filesarchivekeyname", 
            "text": "Download a previously created archive. The name parameter is not used in the\nstack but aims to allow setting a name even for browser / downloader that do not\nsupport Content-Disposition filename.  This route does not require Basic Authentification  GET /files/archive/4521DC87/project-X.zip HTTP/1.1\nAccept: application/zip\nContent-Length: 12345\nContent-Disposition: attachment; filename= project-X.zip \nContent-Type: application/zip", 
            "title": "GET /files/archive/:key/:name"
        }, 
        {
            "location": "/cozy-stack/files/#post-filesdownloadspathfile_path", 
            "text": "Create a file download. The Path query parameter specifies the file to download.\nThe response json API links contains a  related  link for downloading the file,\nsee below.", 
            "title": "POST /files/downloads?Path=file_path"
        }, 
        {
            "location": "/cozy-stack/files/#post-filesdownloadsidfile_id", 
            "text": "Also create a file download. But it takes the id of the file and not its path.", 
            "title": "POST /files/downloads?Id=file_id"
        }, 
        {
            "location": "/cozy-stack/files/#get-filesdownloadssecretname", 
            "text": "Allows to download a file with a secret created from the route above.  The name parameter is not used in the stack but aims to allow setting a name\neven for browser / downloader that do not support Content-Disposition filename.  By default the  content-disposition  will be  inline , but it will be attachment  if the query string contains the parameter  Dl=1  This route does not require Basic Authentification", 
            "title": "GET /files/downloads/:secret/:name"
        }, 
        {
            "location": "/cozy-stack/files/#trash", 
            "text": "When a file is deleted, it is first moved to the trash. In the trash, it can be\nrestored. Or, after some time, it will be removed from the trash and permanently\ndestroyed.  The file  trashed  attribute will be set to true.", 
            "title": "Trash"
        }, 
        {
            "location": "/cozy-stack/files/#get-filestrash", 
            "text": "List the files inside the trash. It s paginated.", 
            "title": "GET /files/trash"
        }, 
        {
            "location": "/cozy-stack/files/#query-string_2", 
            "text": "Parameter  Description      page[cursor]  the last id of the results    page[limit]  the number of entries (30 by default)", 
            "title": "Query-String"
        }, 
        {
            "location": "/cozy-stack/files/#request_9", 
            "text": "GET /files/trash HTTP/1.1\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/files/#response_8", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json  {\n   data : [\n    {\n       type :  io.cozy.files ,\n       id :  df24aac0-7f3d-11e6-81c0-d38812bfa0a8 ,\n       meta : {\n         rev :  1-3b75377c \n      },\n       attributes : {\n         type :  file ,\n         name :  foo.txt ,\n         trashed : true,\n         md5sum :  YjAxMzQxZTc4MDNjODAwYwo= ,\n         created_at :  2016-09-19T12:38:04Z ,\n         updated_at :  2016-09-19T12:38:04Z ,\n         tags : [],\n         size : 123,\n         executable : false,\n         class :  document ,\n         mime :  text/plain \n      },\n       links : {\n         self :  /files/trash/df24aac0-7f3d-11e6-81c0-d38812bfa0a8 \n      }\n    },\n    {\n       type :  io.cozy.files ,\n       id :  4a4fc582-7f3e-11e6-b9ca-278406b6ddd4 ,\n       meta : {\n         rev :  1-4a09030e \n      },\n       attributes : {\n         type :  file ,\n         name :  bar.txt ,\n         trashed : true,\n         md5sum :  YWVhYjg3ZWI0OWQzZjRlMAo= ,\n         created_at :  2016-09-19T12:38:04Z ,\n         updated_at :  2016-09-19T12:38:04Z ,\n         tags : [],\n         size : 456,\n         executable : false,\n         class :  document ,\n         mime :  text/plain \n      },\n       links : {\n         self :  /files/trash/4a4fc582-7f3e-11e6-b9ca-278406b6ddd4 \n      }\n    }\n  ]\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/files/#post-filestrashfile-id", 
            "text": "Restore the file with the  file-id  identifiant.  The file s  trashed  attributes will be set to false.", 
            "title": "POST /files/trash/:file-id"
        }, 
        {
            "location": "/cozy-stack/files/#delete-filestrashfile-id", 
            "text": "Destroy the file and make it unrecoverable (it will still be available in\nbackups).", 
            "title": "DELETE /files/trash/:file-id"
        }, 
        {
            "location": "/cozy-stack/files/#delete-filestrash", 
            "text": "Clear out the trash.", 
            "title": "DELETE /files/trash"
        }, 
        {
            "location": "/cozy-stack/files/#trashed-attribute", 
            "text": "All files that are inside the trash will have a  trashed: true  attribute. This\nattribute can be used in mango queries to only get  interesting  files.", 
            "title": "Trashed attribute"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/", 
            "text": "Table of contents\n\n\nReferences of documents in the Virtual File System\n\n\nWhat we want?\n\n\nCozy applications can use data from the Data System and files from the Virtual\nFile System. Of course, sometimes a link between data and files can be useful.\nFor example, the application can have an album with photos. The album will be a\ndocument in CouchDB (with a title and other fields), but il will also list the\nfiles to use as photos.\n\n\nA direct way to do that is storing the files IDs in the album document. It\ns\nsimple and will work pretty well if the files are manipulated only from this\napplication. But, files are often accessed from other apps, like cozy-desktop\nand cozy-drive. To improve the User eXperience, it should be nice to alert the\nuser when a file in an album is modified or deleted.\n\n\nWhen a file is modified, we can offer the user the choice between keeping the\noriginal version in the album, or using the new modified file. When a file is\nmoved to the trash, we can alert the user and let him/her restore the file.\n\n\nCozy-desktop, cozy-drive, and the other apps can\nt scan all the documents with\nmany different doctypes to find all the references to a file to detect such\ncases. The goal of this document is to offer a way to do that, and it is called\n\nReferences\n.\n\n\nThe references of a file are listed in its JSON-API representation in the\n\nreferences\n field, within the \nrelationships\n object of \ndata\n.\n\n\nExample\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.files\n,\n    \nid\n: \n9152d568-7e7c-11e6-a377-37cbfb190b4b\n,\n    \nmeta\n: {\n      \nrev\n: \n1-0e6d5b72\n\n    },\n    \nattributes\n: {\n      \ntype\n: \nfile\n,\n      \nname\n: \nhello.txt\n,\n      \nmd5sum\n: \nODZmYjI2OWQxOTBkMmM4NQo=\n,\n      \ncreated_at\n: \n2016-09-19T12:38:04Z\n,\n      \nupdated_at\n: \n2016-09-19T12:38:04Z\n,\n      \ntags\n: [],\n      \nsize\n: 12,\n      \nexecutable\n: false,\n      \nclass\n: \ndocument\n,\n      \nmime\n: \ntext/plain\n\n    },\n    \nrelationships\n: {\n      \nparent\n: {\n        \nlinks\n: {\n          \nrelated\n: \n/files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81\n\n        },\n        \ndata\n: {\n          \ntype\n: \nio.cozy.files\n,\n          \nid\n: \nfce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81\n\n        }\n      },\n      \nreferenced_by\n: {\n        \nlinks\n: {\n          \nself\n:\n            \n/files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81/relationships/references\n\n        },\n        \ndata\n: [\n          {\n            \ntype\n: \nio.cozy.playlists\n,\n            \nid\n: \n94375086-e2e2-11e6-81b9-5bc0b9dd4aa4\n\n          }\n        ]\n      }\n    },\n    \nlinks\n: {\n      \nself\n: \n/files/9152d568-7e7c-11e6-a377-37cbfb190b4b\n\n    }\n  }\n}\n\n\n\n\nRoutes\n\n\nPATCH /files/:file-id/relationships/referenced_by\n\n\nReplace the references for a file with the new ones.\n\n\nRequest\n\n\nPATCH /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/relationships/referenced_by HTTP/1.1\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: [\n    {\n      \ntype\n: \nio.cozy.playlists\n,\n      \nid\n: \n94375086-e2e2-11e6-81b9-5bc0b9dd4aa4\n\n    }\n  ]\n}\n\n\n\n\nResponse\n\n\nHTTP/1.1 204 No Content\nContent-Type: application/vnd.api+json\n\n\n\n\nPOST /files/:file-id/relationships/referenced_by\n\n\nAdd on a file one or more references to documents\n\n\nRequest\n\n\nPOST /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/relationships/referenced_by HTTP/1.1\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: [\n    {\n      \ntype\n: \nio.cozy.playlists\n,\n      \nid\n: \nf2625cc0-e2d6-11e6-a0d5-cfbbfb141af0\n\n    }\n  ]\n}\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: [\n    {\n      \ntype\n: \nio.cozy.playlists\n,\n      \nid\n: \n94375086-e2e2-11e6-81b9-5bc0b9dd4aa4\n\n    },\n    {\n      \ntype\n: \nio.cozy.playlists\n,\n      \nid\n: \nf2625cc0-e2d6-11e6-a0d5-cfbbfb141af0\n\n    }\n  ]\n}\n\n\n\n\nDELETE /files/:file-id/relationships/referenced_by\n\n\nRemove one or more references to documents on a file\n\n\nRequest\n\n\nDELETE /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/relationships/referenced_by HTTP/1.1\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: [\n    {\n      \ntype\n: \nio.cozy.playlists\n,\n      \nid\n: \nf2625cc0-e2d6-11e6-a0d5-cfbbfb141af0\n\n    }\n  ]\n}\n\n\n\n\nResponse\n\n\nHTTP/1.1 204 No Content\nContent-Type: application/vnd.api+json\n\n\n\n\nGET /data/:type/:doc-id/relationships/references\n\n\nReturns all the files associated to an album or playlist.\n\n\nContents is paginated following \njsonapi conventions\n.\nThe default limit is 100 entries.\n\n\nIt\ns also possible to sort the files by their datetime (for photos) with the\n\nsort\n query parameter: \n?sort=datetime\n.\n\n\nRequest\n\n\nGET /data/io.cozy.playlists/e9308dc2-e2e3-11e6-b685-fb88662613d4/relationships/references HTTP/1.1\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: [\n    { \ntype\n: \nio.cozy.files\n, \nid\n: \n417c4e58-e2e4-11e6-b7dc-2b68ed7b77f4\n },\n    { \ntype\n: \nio.cozy.files\n, \nid\n: \n4504f55c-e2e4-11e6-88f2-d77aeecab549\n },\n    { \ntype\n: \nio.cozy.files\n, \nid\n: \n4587727a-e2e4-11e6-bfe9-ef1be7df7f26\n },\n    { \ntype\n: \nio.cozy.files\n, \nid\n: \n45d591d0-e2e4-11e6-ab9a-ff3b218e31cc\n }\n  ]\n}\n\n\n\n\nPOST /data/:type/:doc-id/relationships/references\n\n\nWhen creating an album or a playlist, it\ns tedious to add the references to it\nfor each file individually. This route allows to make it in bulk.\n\n\nRequest\n\n\nPOST /data/io.cozy.playlists/e9308dc2-e2e3-11e6-b685-fb88662613d4/relationships/references HTTP/1.1\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: [\n    { \ntype\n: \nio.cozy.files\n, \nid\n: \n417c4e58-e2e4-11e6-b7dc-2b68ed7b77f4\n },\n    { \ntype\n: \nio.cozy.files\n, \nid\n: \n4504f55c-e2e4-11e6-88f2-d77aeecab549\n },\n    { \ntype\n: \nio.cozy.files\n, \nid\n: \n4587727a-e2e4-11e6-bfe9-ef1be7df7f26\n },\n    { \ntype\n: \nio.cozy.files\n, \nid\n: \n45d591d0-e2e4-11e6-ab9a-ff3b218e31cc\n }\n  ]\n}\n\n\n\n\nResponse\n\n\nHTTP/1.1 204 No Content\nContent-Type: application/vnd.api+json\n\n\n\n\nNote\n: if one of the id is a directory, the response will be a 400 Bad\nRequest. References are only for files.\n\n\nDELETE /data/:type/:doc-id/relationships/references\n\n\nThis bulk deletion of references on many files can be useful when an album or\nplaylist is deleted.\n\n\nRequest\n\n\nDELETE /data/io.cozy.playlists/e9308dc2-e2e3-11e6-b685-fb88662613d4/relationships/references HTTP/1.1\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: [\n    { \ntype\n: \nio.cozy.files\n, \nid\n: \n417c4e58-e2e4-11e6-b7dc-2b68ed7b77f4\n },\n    { \ntype\n: \nio.cozy.files\n, \nid\n: \n4504f55c-e2e4-11e6-88f2-d77aeecab549\n },\n    { \ntype\n: \nio.cozy.files\n, \nid\n: \n4587727a-e2e4-11e6-bfe9-ef1be7df7f26\n },\n    { \ntype\n: \nio.cozy.files\n, \nid\n: \n45d591d0-e2e4-11e6-ab9a-ff3b218e31cc\n }\n  ]\n}\n\n\n\n\nResponse\n\n\nHTTP/1.1 204 No Content\nContent-Type: application/vnd.api+json\n\n\n\n\nUsage\n\n\nModification of a referenced file\n\n\nBefore an application updates a file, it can check if the file has some\nreferences. If it is the case, it may offer to the user two choices:\n\n\n\n\nupdate the file with the new version (the albums and playlists will use the\n  new version)\n\n\nsave the new version as a new file and preserve the old file (the old file may\n  be moved to a \noriginals\n directory).\n\n\n\n\nMoving a referenced file to the trash\n\n\nThe stack will refuse to move a referenced file to the trash. It\ns the same for\na folder that contains a referenced file. The application has to remove the\nreferences first. It\ns possible to clear all the references on a file with a\n\nPATCH\n request like this:\n\n\nPATCH /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/relationships/references HTTP/1.1\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: []\n}\n\n\n\n\nImplementation\n\n\nThe references are persisted in the \nio.cozy.files\n documents in CouchDB. A\nmango index is used to fetch all the files that are associated to a given\ndocument (for \nGET /data/:type/:doc-id/relationships/references\n).\n\n\nFor request to update or move to trash a file, it is easy to fetch its CouchDB\ndocument to see if it has a reference. But it is more difficult when moving a\nfolder to trash. To do that, we need two requests to fetch the number of\nreferences in a folder.\n\n\n1/ Get all descendant folders from a given folder, with a CouchDB View:\n\n\nmap = function(doc) {\n  if (doc.type === \nfolder\n) emit(doc.path);\n};\nquery = {\n  starkey: parent_folder_path + \n/\n,\n  endkey: parent_folder_path + \n/\\uFFFF\n\n};\n\n\n\n\n2/ Get the total number of \nreferenced\n file for this folders list, with a\nmap/reduce CouchDB view:\n\n\nmap = function(doc) { if(doc.referenced != null) emit(doc.parentID) }\nreduce = count\nquery = {keys: [list from above]}", 
            "title": "References of documents in VFS"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#references-of-documents-in-the-virtual-file-system", 
            "text": "", 
            "title": "References of documents in the Virtual File System"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#what-we-want", 
            "text": "Cozy applications can use data from the Data System and files from the Virtual\nFile System. Of course, sometimes a link between data and files can be useful.\nFor example, the application can have an album with photos. The album will be a\ndocument in CouchDB (with a title and other fields), but il will also list the\nfiles to use as photos.  A direct way to do that is storing the files IDs in the album document. It s\nsimple and will work pretty well if the files are manipulated only from this\napplication. But, files are often accessed from other apps, like cozy-desktop\nand cozy-drive. To improve the User eXperience, it should be nice to alert the\nuser when a file in an album is modified or deleted.  When a file is modified, we can offer the user the choice between keeping the\noriginal version in the album, or using the new modified file. When a file is\nmoved to the trash, we can alert the user and let him/her restore the file.  Cozy-desktop, cozy-drive, and the other apps can t scan all the documents with\nmany different doctypes to find all the references to a file to detect such\ncases. The goal of this document is to offer a way to do that, and it is called References .  The references of a file are listed in its JSON-API representation in the references  field, within the  relationships  object of  data .", 
            "title": "What we want?"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#example", 
            "text": "{\n   data : {\n     type :  io.cozy.files ,\n     id :  9152d568-7e7c-11e6-a377-37cbfb190b4b ,\n     meta : {\n       rev :  1-0e6d5b72 \n    },\n     attributes : {\n       type :  file ,\n       name :  hello.txt ,\n       md5sum :  ODZmYjI2OWQxOTBkMmM4NQo= ,\n       created_at :  2016-09-19T12:38:04Z ,\n       updated_at :  2016-09-19T12:38:04Z ,\n       tags : [],\n       size : 12,\n       executable : false,\n       class :  document ,\n       mime :  text/plain \n    },\n     relationships : {\n       parent : {\n         links : {\n           related :  /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 \n        },\n         data : {\n           type :  io.cozy.files ,\n           id :  fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 \n        }\n      },\n       referenced_by : {\n         links : {\n           self :\n             /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81/relationships/references \n        },\n         data : [\n          {\n             type :  io.cozy.playlists ,\n             id :  94375086-e2e2-11e6-81b9-5bc0b9dd4aa4 \n          }\n        ]\n      }\n    },\n     links : {\n       self :  /files/9152d568-7e7c-11e6-a377-37cbfb190b4b \n    }\n  }\n}", 
            "title": "Example"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#routes", 
            "text": "", 
            "title": "Routes"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#patch-filesfile-idrelationshipsreferenced_by", 
            "text": "Replace the references for a file with the new ones.", 
            "title": "PATCH /files/:file-id/relationships/referenced_by"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#request", 
            "text": "PATCH /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/relationships/referenced_by HTTP/1.1\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json  {\n   data : [\n    {\n       type :  io.cozy.playlists ,\n       id :  94375086-e2e2-11e6-81b9-5bc0b9dd4aa4 \n    }\n  ]\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#response", 
            "text": "HTTP/1.1 204 No Content\nContent-Type: application/vnd.api+json", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#post-filesfile-idrelationshipsreferenced_by", 
            "text": "Add on a file one or more references to documents", 
            "title": "POST /files/:file-id/relationships/referenced_by"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#request_1", 
            "text": "POST /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/relationships/referenced_by HTTP/1.1\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json  {\n   data : [\n    {\n       type :  io.cozy.playlists ,\n       id :  f2625cc0-e2d6-11e6-a0d5-cfbbfb141af0 \n    }\n  ]\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#response_1", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json  {\n   data : [\n    {\n       type :  io.cozy.playlists ,\n       id :  94375086-e2e2-11e6-81b9-5bc0b9dd4aa4 \n    },\n    {\n       type :  io.cozy.playlists ,\n       id :  f2625cc0-e2d6-11e6-a0d5-cfbbfb141af0 \n    }\n  ]\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#delete-filesfile-idrelationshipsreferenced_by", 
            "text": "Remove one or more references to documents on a file", 
            "title": "DELETE /files/:file-id/relationships/referenced_by"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#request_2", 
            "text": "DELETE /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/relationships/referenced_by HTTP/1.1\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json  {\n   data : [\n    {\n       type :  io.cozy.playlists ,\n       id :  f2625cc0-e2d6-11e6-a0d5-cfbbfb141af0 \n    }\n  ]\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#response_2", 
            "text": "HTTP/1.1 204 No Content\nContent-Type: application/vnd.api+json", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#get-datatypedoc-idrelationshipsreferences", 
            "text": "Returns all the files associated to an album or playlist.  Contents is paginated following  jsonapi conventions .\nThe default limit is 100 entries.  It s also possible to sort the files by their datetime (for photos) with the sort  query parameter:  ?sort=datetime .", 
            "title": "GET /data/:type/:doc-id/relationships/references"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#request_3", 
            "text": "GET /data/io.cozy.playlists/e9308dc2-e2e3-11e6-b685-fb88662613d4/relationships/references HTTP/1.1\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#response_3", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json  {\n   data : [\n    {  type :  io.cozy.files ,  id :  417c4e58-e2e4-11e6-b7dc-2b68ed7b77f4  },\n    {  type :  io.cozy.files ,  id :  4504f55c-e2e4-11e6-88f2-d77aeecab549  },\n    {  type :  io.cozy.files ,  id :  4587727a-e2e4-11e6-bfe9-ef1be7df7f26  },\n    {  type :  io.cozy.files ,  id :  45d591d0-e2e4-11e6-ab9a-ff3b218e31cc  }\n  ]\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#post-datatypedoc-idrelationshipsreferences", 
            "text": "When creating an album or a playlist, it s tedious to add the references to it\nfor each file individually. This route allows to make it in bulk.", 
            "title": "POST /data/:type/:doc-id/relationships/references"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#request_4", 
            "text": "POST /data/io.cozy.playlists/e9308dc2-e2e3-11e6-b685-fb88662613d4/relationships/references HTTP/1.1\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json  {\n   data : [\n    {  type :  io.cozy.files ,  id :  417c4e58-e2e4-11e6-b7dc-2b68ed7b77f4  },\n    {  type :  io.cozy.files ,  id :  4504f55c-e2e4-11e6-88f2-d77aeecab549  },\n    {  type :  io.cozy.files ,  id :  4587727a-e2e4-11e6-bfe9-ef1be7df7f26  },\n    {  type :  io.cozy.files ,  id :  45d591d0-e2e4-11e6-ab9a-ff3b218e31cc  }\n  ]\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#response_4", 
            "text": "HTTP/1.1 204 No Content\nContent-Type: application/vnd.api+json  Note : if one of the id is a directory, the response will be a 400 Bad\nRequest. References are only for files.", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#delete-datatypedoc-idrelationshipsreferences", 
            "text": "This bulk deletion of references on many files can be useful when an album or\nplaylist is deleted.", 
            "title": "DELETE /data/:type/:doc-id/relationships/references"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#request_5", 
            "text": "DELETE /data/io.cozy.playlists/e9308dc2-e2e3-11e6-b685-fb88662613d4/relationships/references HTTP/1.1\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json  {\n   data : [\n    {  type :  io.cozy.files ,  id :  417c4e58-e2e4-11e6-b7dc-2b68ed7b77f4  },\n    {  type :  io.cozy.files ,  id :  4504f55c-e2e4-11e6-88f2-d77aeecab549  },\n    {  type :  io.cozy.files ,  id :  4587727a-e2e4-11e6-bfe9-ef1be7df7f26  },\n    {  type :  io.cozy.files ,  id :  45d591d0-e2e4-11e6-ab9a-ff3b218e31cc  }\n  ]\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#response_5", 
            "text": "HTTP/1.1 204 No Content\nContent-Type: application/vnd.api+json", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#usage", 
            "text": "", 
            "title": "Usage"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#modification-of-a-referenced-file", 
            "text": "Before an application updates a file, it can check if the file has some\nreferences. If it is the case, it may offer to the user two choices:   update the file with the new version (the albums and playlists will use the\n  new version)  save the new version as a new file and preserve the old file (the old file may\n  be moved to a  originals  directory).", 
            "title": "Modification of a referenced file"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#moving-a-referenced-file-to-the-trash", 
            "text": "The stack will refuse to move a referenced file to the trash. It s the same for\na folder that contains a referenced file. The application has to remove the\nreferences first. It s possible to clear all the references on a file with a PATCH  request like this:  PATCH /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/relationships/references HTTP/1.1\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json  {\n   data : []\n}", 
            "title": "Moving a referenced file to the trash"
        }, 
        {
            "location": "/cozy-stack/references-docs-in-vfs/#implementation", 
            "text": "The references are persisted in the  io.cozy.files  documents in CouchDB. A\nmango index is used to fetch all the files that are associated to a given\ndocument (for  GET /data/:type/:doc-id/relationships/references ).  For request to update or move to trash a file, it is easy to fetch its CouchDB\ndocument to see if it has a reference. But it is more difficult when moving a\nfolder to trash. To do that, we need two requests to fetch the number of\nreferences in a folder.  1/ Get all descendant folders from a given folder, with a CouchDB View:  map = function(doc) {\n  if (doc.type ===  folder ) emit(doc.path);\n};\nquery = {\n  starkey: parent_folder_path +  / ,\n  endkey: parent_folder_path +  /\\uFFFF \n};  2/ Get the total number of  referenced  file for this folders list, with a\nmap/reduce CouchDB view:  map = function(doc) { if(doc.referenced != null) emit(doc.parentID) }\nreduce = count\nquery = {keys: [list from above]}", 
            "title": "Implementation"
        }, 
        {
            "location": "/cozy-stack/intents/", 
            "text": "Table of contents\n\n\nIntents\n\n\n\n\nOverview\n\n\nGlossary\n\n\nProposal\n\n\n1. Manifest\n\n\n2. Intent Start\n\n\n3. Service Resolution\n\n\n4. Handshake\n\n\n5. Processing \n Terminating\n\n\nRoutes\n\n\nAnnexes\n\n\nUse cases\n\n\nBibliography \n Prior Art\n\n\nDiscarded Ideas\n\n\n\n\nOverview\n\n\nA typical Cozy Cloud runs multiple applications, but most of these applications\nare focused on one task and interact with one particular type of data.\n\n\nHowever, Cozy Cloud especially shines when data is combined across apps to\nprovide an integrated experience. This is made difficult by the fact that apps\nhave no dedicated back-end and that they have restricted access to documents.\n\n\nThis document outlines a proposal for apps to rely on each other to accomplish\ncertain tasks and gain access to new documents, in a way that hopefully is\nneither painful for the users nor the developers.\n\n\nGlossary\n\n\n\n\nIntent\n: Intents, sometimes also called Activities, is a pattern used in\n  environments where multiple apps with different purposes coexist. The idea is\n  that any app can express the need to do \nsomething\n that it can\nt do itself,\n  and an app that \ncan\n do it will take over from there.\n\n\nStack\n: refers to \ncozy-stack\n, the\n  server-side part of the Cozy infrastructure.\n\n\nClient\n: the client is the application that \nstarts\n an intent.\n\n\nService\n: the service is the application that \nhandles\n an intent started\n  by a client.\n\n\n\n\nProposal\n\n\nIn this proposal, services declare themselves through their manifest. When a\nclients starts an intent, the stack finds the appropriate service and help the\ntwo apps to create a communication channel between them. After the channel is\nready, the intent is processed. These steps are detailed below.\n\n\n1. Manifest\n\n\nEvery app can register itself as a potential handler for one or more intents. To\ndo so, it must provide the following information for each intent it wishes to\nhandle:\n\n\n\n\naction\n: A verb that describes what the service should do. The most common\n  actions are \nCREATE\n, \nEDIT\n, \nOPEN\n, \nPICK\n, and \nSHARE\n. While we recommend\n  using one of these verbs, the list is not exhaustive and may be extended by\n  any app.\n\n\ntype\n: One or more types of data on which the service knows how to operate\n  the \naction\n. A \ntype\n can be expressed as a\n  \nMIME type\n or a\n  \nCozy Document Type\n.\n  The application must have permissions for any Cozy Document Type listed here.\n  You can also think of the \ntype\n as the intent\ns subject.\n\n\nhref\n: the relative URL of the route designed to handle this intent. A\n  query-string with the intent id will be added to this URL.\n\n\n\n\nThese informations must be provided in the manifest of the application, inside\nthe \nintents\n key.\n\n\nHere is a very simple example:\n\n\nintents\n: [\n    {\n        \naction\n: \nPICK\n,\n        \ntype\n: [\nio.cozy.files\n],\n        \nhref\n: \n/pick\n\n    }\n]\n\n\n\n\nWhen this service is called, it will load the page\n\nhttps://service.domain.example.com/pick?intent=123abc\n.\n\n\nHere is an example of an app that supports multiple data types:\n\n\nintents\n: [\n    {\n        \naction\n: \nPICK\n,\n        \ntype\n: [\nio.cozy.files\n, \nimage/*\n],\n        \nhref\n: \n/pick\n\n    }\n]\n\n\n\n\nFinally, here is an example of an app that supports several intent types:\n\n\nintents\n: [\n    {\n        \naction\n: \nPICK\n,\n        \ntype\n: [\nio.cozy.files\n, \nimage/*\n],\n        \nhref\n: \n/pick\n\n    },\n    {\n        \naction\n: \nVIEW\n,\n        \ntype\n: [\nimage/gif\n],\n        \nhref\n: \n/viewer\n\n    }\n]\n\n\n\n\nThis information is stored by the stack when the application is installed.\n\n\n2. Intent Start\n\n\nAny app can start a new intent whenever it wants. When it does, the app becomes\nthe \nclient\n.\n\n\nTo start an intent, it must specify the following information:\n\n\n\n\naction\n : an action verb, which will be matched against the actions declared\n  in services manifest files.\n\n\ntype\n : a \nsingle\n data type, which will be matched against the types\n  declared in services manifest files.\n\n\n\n\nThere are also two optional fields that can be defined at the start of the\nintent:\n\n\n\n\ndata\n: Any data that the client wants to make available to the service.\n  \ndata\n must be a JSON object but its structure is left to the discretion of\n  the client. The only exception is when \ntype\n is a MIME type and the client\n  wishes to send a file to the service. In that case, the file should be\n  represented as a base-64 encoded \nData URL\n and\n  must be named \ncontent\n. This convention is also recomended when dealing with\n  other intent \ntype\ns. See the examples below for an example of this.\n\n\npermissions\n : When \ntype\n is a Cozy Document Type and the client expects to\n  receive one or more documents as part of the reply from the service, the\n  \npermissions\n field allows the client to request permissions for these\n  documents. \npermissions\n is a list of HTTP Verbs. Refer\n  \nto this section\n\n  of the permission documentation for more information.\n\n\n\n\nNote\n: if the intent\ns subject is a Cozy Doctype that holds references to\nother Cozy Documents (such as an album referencing photos or a playlist\nreferencing music files), the permissions should be granted for the referenced\ndocuments too, whenever possible.\n\n\nHere is an example of what the API could look like:\n\n\n// \nLet the user pick a file\n\ncozy.intents.start('PICK', 'io.cozy.files')\n.then(document =\n {\n    // document is a JSON representation of the picked file\n});\n\n// \nCreate a contact, with some information already filled out\n\ncozy.intents.start('CREATE', 'io.cozy.contacts', {\n    name: 'John Johnsons',\n    tel: '+12345678'\n    email: 'john@johnsons.com'\n})\n.then(document =\n {\n    // document is a JSON representation of the contact that was created\n});\n\n// \nSave this file somewhere\n\ncozy.intents.start('CREATE', 'io.cozy.files', {\n    content: 'data:application/zip;base64,UEsDB...',\n    name: 'photos.zip'\n});\n\n// \nCreate a new note, and give me read-only access to it\n\ncozy.intents.start('CREATE', 'io.cozy.notes', {}, ['GET'])\n.then(document =\n {\n    // document is a JSON representation of the note that was created.\n    // Additionally, this note can now be retrieved through the API since we have read access on it.\n});\n\n// \nCreate an event based on the provided data, and give me full access to it\n\ncozy.intents.start('CREATE', 'io.cozy.events', {\n    date: '2017/06/24',\n    title: 'Beach day'\n}, ['ALL'])\n.then(document =\n {\n    // document is a JSON representation of the note that was created.\n    // Additionally, this note can now be retrieved through the API since we have read access on it.\n});\n\n// \nCrop this picture\n\ncozy.intents.start('EDIT', 'image/png', {\n    content: 'data:image/png;base64,iVBORw...',\n    width: 50,\n    height: 50\n})\n.then(image =\n {\n    //image is the edited version of the image provided above.\n})\n\n\n\n\n3. Service Resolution\n\n\nThe service resolution is the phase where a service is chosen to handle an\nintent. This phase is handled by the stack.\n\n\nAfter the client has started it\ns intent, it sends the \naction\n, the \ntype\n and\nthe \npermissions\n to the stack. The stack will then traverse the list of\ninstalled apps and find all the apps that can handle that specific combination.\nNote that if the intent request \nGET\n permissions on a certain Cozy Document\nType, but the service does not have this permission itself, it can not handle\nthe intent.\n\n\nThe stack then stores the information for that intent:\n\n\n\n\nA unique id for that intent\n\n\nClient URL\n\n\nService URL\n\n\naction\n\n\ntype\n\n\npermissions\n\n\n\n\nFinally, the service URL is suffixed with \n?intent=\n followed by the intent\ns\nid, and then sent to the client.\n\n\nService choice\n\n\nIf more than one service match the intent\ns criteria, the stack returns the list\nof all matching service URLs to the client (and stores it in the service URL\nversion of the intent it keeps in memory). The client is then free to pick one\narbitrarily.\n\n\nThe client may also decide to let the user choose one of the services. To do\nthis, it should start another intent with a \nPICK\n action and a \nio.cozy.apps\n\n\ntype\n. This intent should be resolved by the stack to a special page, in order\nto avoid having multiple services trying to handle it and ending up in a loop.\n\n\nThis special page is a service like any other; it expects the list of services\nto pick from as input data, and will return the one that has been picked to the\nclient. The client can then proceed with the first intent.\n\n\nThe user may decide to abort the intent before picking a service. If that is the\ncase, the choice page will need to inform the client that the intent was\naborted.\n\n\nNo available service\n\n\nIf no service is available to handle an intent, the stack returns an error to\nthe client.\n\n\nAt a later phase of this project, the stack may traverse the applications\nregistered in a store to find suitable services, and prompt the user to install\none.\n\n\n4. Handshake\n\n\nThe next phase consist of the client and the service establishing a\ncommunication channel between them. The communication will be done using the\n\nwindow.postMessage\n\nAPI.\n\n\nService Initialization\n\n\nWhen the client receives the service URL from the stack, it starts to listen for\nmessages coming from that URL. Once the listener is started, it opens an iframe\nthat points to the service\ns URL.\n\n\nService to Client\n\n\nAt this point, the service app is opened on the route that it provided in the\n\nhref\n part of it\ns manifest. This route now also contains the intent\ns id.\n\n\nThe service queries the stack to find out information about the intent, passing\nalong the intent id. In response, the stack sends the client\ns URL, the\n\naction\n, and the \ntype\n. If the intent includes \npermissions\n, the stack sends\nthem too, as well as the client\ns permission id.\n\n\nIt then starts to listen for messages coming from the client\ns URL. Eventually,\nit sends a message to the client, as a mean to inform it that the service is now\nready.\n\n\nClient to Service\n\n\nAfter the client receives the \nready\n message from the service, it sends a\nmessage to the service acknowledging the \nready\n state.\n\n\nAlong with this message, it should send the \ndata\n that was provided at the\nstart of the intent, if any.\n\n\n5. Processing \n Terminating\n\n\nAfter this handshake, there is a confirmed communication channel between the\nclient and the service, and the service knows what it has to do. This is the\nphase where the user interacts with the service.\n\n\nIf the service is going to grant extra permissions to the client app, it is\nstrongly recommended to make this clear to the user.\n\n\nWhen the service has finished his task, it sends a \ncompleted\n message to the\nclient. Permissions extensions should have been done before that. Along with the\ncompleted message, the service should send any data it deems relevant. This data\nshould be a JSON object. Again, the structure of that object is left to the\ndiscretion of the service, except when \ntype\n is a MIME type. In that case, the\nfile should be represented as a base-64 encoded\n\nData URL\n and must be named \ncontent\n. This\nconvention is also recomended when dealing with other intent \ntype\ns.\n\n\nAfter the client receives a \ncompleted\n message, it can close the service\ns\niframe and resume operations as usual.\n\n\nIf, for whatever reason, the service can not fulfill the intent, it can send an\n\nerror\n message to the client. When the client receives an \nerror\n message, the\nintent is aborted and the iframe can be closed.\n\n\nRoutes\n\n\nPOST /intents\n\n\nThe client app can ask to start an intent via this route.\n\n\nAny client-side app can call this route, no permission is needed.\n\n\nRequest\n\n\nPOST /intents HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer eyJhbG...\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.intents\n,\n    \nattributes\n: {\n      \naction\n: \nPICK\n,\n      \ntype\n: \nio.cozy.files\n,\n      \npermissions\n: [\nGET\n]\n    }\n  }\n}\n\n\n\n\nResponse\n\n\nHTTP/1.1 201 Created\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \nid\n: \n77bcc42c-0fd8-11e7-ac95-8f605f6e8338\n,\n    \ntype\n: \nio.cozy.intents\n,\n    \nattributes\n: {\n      \naction\n: \nPICK\n,\n      \ntype\n: \nio.cozy.files\n,\n      \npermissions\n: [\nGET\n],\n      \nclient\n: \nhttps://contacts.cozy.example.net\n,\n      \nservices\n: [\n        {\n          \nslug\n: \nfiles\n,\n          \nhref\n:\n            \nhttps://files.cozy.example.net/pick?intent=77bcc42c-0fd8-11e7-ac95-8f605f6e8338\n\n        }\n      ]\n    },\n    \nlinks\n: {\n      \nself\n: \n/intents/77bcc42c-0fd8-11e7-ac95-8f605f6e8338\n,\n      \npermissions\n: \n/permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6\n\n    }\n  }\n}\n\n\n\n\nGET /intents/:id\n\n\nGet all the informations about the intent\n\n\nNote\n: only the service can access this route (no permission involved).\n\n\nRequest\n\n\nGET /intents/77bcc42c-0fd8-11e7-ac95-8f605f6e8338 HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer J9l-ZhwP...\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \nid\n: \n77bcc42c-0fd8-11e7-ac95-8f605f6e8338\n,\n    \ntype\n: \nio.cozy.intents\n,\n    \nattributes\n: {\n      \naction\n: \nPICK\n,\n      \ntype\n: \nio.cozy.files\n,\n      \npermissions\n: [\nGET\n],\n      \nclient\n: \nhttps://contacts.cozy.example.net\n,\n      \nservices\n: [\n        {\n          \nslug\n: \nfiles\n,\n          \nhref\n:\n            \nhttps://files.cozy.example.net/pick?intent=77bcc42c-0fd8-11e7-ac95-8f605f6e8338\n\n        }\n      ]\n    },\n    \nlinks\n: {\n      \nself\n: \n/intents/77bcc42c-0fd8-11e7-ac95-8f605f6e8338\n,\n      \npermissions\n: \n/permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6\n\n    }\n  }\n}\n\n\n\n\nAnnexes\n\n\nUse Cases\n\n\nHere is a non exhaustive list of situations that \nmay\n use intents:\n\n\n\n\nConfigure a new connector account\n\n\nShare a photo album via email\n\n\nAdd an attachment to an email\n\n\nAttach a note to a contact\n\n\nCreate a contact based on an email\n\n\nSave an attachment received in an email\n\n\nCreate a birthday event in a calendar, based on a contact\n\n\nCreate an event based on an email\ns content\n\n\nCreate an event based on an ICS file\n\n\nChose an avatar for a contact\n\n\nOpen a file from the file browser (music, PDF, image, \n)\n\n\nAttach a receipt to an expense\n\n\nProvide a tip for another application\n\n\n\n\nBibliography \n Prior Art\n\n\n\n\nPrior art:\n  https://forum.cozy.io/t/cozy-tech-topic-inter-app-communication-architecture/2287\n\n\nWeb intents: http://webintents.org/\n\n\nWebActivities: https://wiki.mozilla.org/WebAPI/WebActivities and\n  https://developer.mozilla.org/en-US/docs/Archive/Firefox_OS/API/Web_Activities\n\n\nSiri Intents:\n  https://developer.apple.com/library/content/documentation/Intents/Conceptual/SiriIntegrationGuide/ResolvingandHandlingIntents.html#//apple_ref/doc/uid/TP40016875-CH5-SW1\n\n\nAndroid Intents:\n  https://developer.android.com/reference/android/content/Intent.html\n\n\niOS extensions:\n  https://developer.apple.com/library/content/documentation/General/Conceptual/ExtensibilityPG/index.html\n\n\n\n\nDiscarded Ideas\n\n\nDisposition\n\n\nSome specifications include a \ndisposition\n field in the manifests, that gives a\nhint to the client about how to display the service (inlined or in a new\nwindow). Since we were unable to find a use case where a new window is required,\nwe decided not to include the \ndisposition\n in this specification. It might be\nadded later if the need arises.\n\n\nClient / Server architecture\n\n\nInstead of letting the two applications communicate with each other, they could\nbe made to talk through the stack. This would be useful as the stack could act\nas a middleware, transforming data on the fly or granting permissions where\nappropriate.\n\n\nHowever, this approach has also severe drawbacks, notably the fact that the\nstack must hold a copy of all the data that the apps want to transfer (which can\ninclude large files). It also makes it significantly harder for the client to\nknow when the intent has been processed.\n\n\nData representation\n\n\nThe client could explicitly request a data format to be used in the\ncommunication. However, this idea was abandoned because the format is \nalways\n\njson, except when then intent\ns \ntype\n is a MIME type, in which case the data\nformat \nalso\n uses this type.", 
            "title": "/intents - Intents"
        }, 
        {
            "location": "/cozy-stack/intents/#intents", 
            "text": "Overview  Glossary  Proposal  1. Manifest  2. Intent Start  3. Service Resolution  4. Handshake  5. Processing   Terminating  Routes  Annexes  Use cases  Bibliography   Prior Art  Discarded Ideas", 
            "title": "Intents"
        }, 
        {
            "location": "/cozy-stack/intents/#overview", 
            "text": "A typical Cozy Cloud runs multiple applications, but most of these applications\nare focused on one task and interact with one particular type of data.  However, Cozy Cloud especially shines when data is combined across apps to\nprovide an integrated experience. This is made difficult by the fact that apps\nhave no dedicated back-end and that they have restricted access to documents.  This document outlines a proposal for apps to rely on each other to accomplish\ncertain tasks and gain access to new documents, in a way that hopefully is\nneither painful for the users nor the developers.", 
            "title": "Overview"
        }, 
        {
            "location": "/cozy-stack/intents/#glossary", 
            "text": "Intent : Intents, sometimes also called Activities, is a pattern used in\n  environments where multiple apps with different purposes coexist. The idea is\n  that any app can express the need to do  something  that it can t do itself,\n  and an app that  can  do it will take over from there.  Stack : refers to  cozy-stack , the\n  server-side part of the Cozy infrastructure.  Client : the client is the application that  starts  an intent.  Service : the service is the application that  handles  an intent started\n  by a client.", 
            "title": "Glossary"
        }, 
        {
            "location": "/cozy-stack/intents/#proposal", 
            "text": "In this proposal, services declare themselves through their manifest. When a\nclients starts an intent, the stack finds the appropriate service and help the\ntwo apps to create a communication channel between them. After the channel is\nready, the intent is processed. These steps are detailed below.", 
            "title": "Proposal"
        }, 
        {
            "location": "/cozy-stack/intents/#1-manifest", 
            "text": "Every app can register itself as a potential handler for one or more intents. To\ndo so, it must provide the following information for each intent it wishes to\nhandle:   action : A verb that describes what the service should do. The most common\n  actions are  CREATE ,  EDIT ,  OPEN ,  PICK , and  SHARE . While we recommend\n  using one of these verbs, the list is not exhaustive and may be extended by\n  any app.  type : One or more types of data on which the service knows how to operate\n  the  action . A  type  can be expressed as a\n   MIME type  or a\n   Cozy Document Type .\n  The application must have permissions for any Cozy Document Type listed here.\n  You can also think of the  type  as the intent s subject.  href : the relative URL of the route designed to handle this intent. A\n  query-string with the intent id will be added to this URL.   These informations must be provided in the manifest of the application, inside\nthe  intents  key.  Here is a very simple example:  intents : [\n    {\n         action :  PICK ,\n         type : [ io.cozy.files ],\n         href :  /pick \n    }\n]  When this service is called, it will load the page https://service.domain.example.com/pick?intent=123abc .  Here is an example of an app that supports multiple data types:  intents : [\n    {\n         action :  PICK ,\n         type : [ io.cozy.files ,  image/* ],\n         href :  /pick \n    }\n]  Finally, here is an example of an app that supports several intent types:  intents : [\n    {\n         action :  PICK ,\n         type : [ io.cozy.files ,  image/* ],\n         href :  /pick \n    },\n    {\n         action :  VIEW ,\n         type : [ image/gif ],\n         href :  /viewer \n    }\n]  This information is stored by the stack when the application is installed.", 
            "title": "1. Manifest"
        }, 
        {
            "location": "/cozy-stack/intents/#2-intent-start", 
            "text": "Any app can start a new intent whenever it wants. When it does, the app becomes\nthe  client .  To start an intent, it must specify the following information:   action  : an action verb, which will be matched against the actions declared\n  in services manifest files.  type  : a  single  data type, which will be matched against the types\n  declared in services manifest files.   There are also two optional fields that can be defined at the start of the\nintent:   data : Any data that the client wants to make available to the service.\n   data  must be a JSON object but its structure is left to the discretion of\n  the client. The only exception is when  type  is a MIME type and the client\n  wishes to send a file to the service. In that case, the file should be\n  represented as a base-64 encoded  Data URL  and\n  must be named  content . This convention is also recomended when dealing with\n  other intent  type s. See the examples below for an example of this.  permissions  : When  type  is a Cozy Document Type and the client expects to\n  receive one or more documents as part of the reply from the service, the\n   permissions  field allows the client to request permissions for these\n  documents.  permissions  is a list of HTTP Verbs. Refer\n   to this section \n  of the permission documentation for more information.   Note : if the intent s subject is a Cozy Doctype that holds references to\nother Cozy Documents (such as an album referencing photos or a playlist\nreferencing music files), the permissions should be granted for the referenced\ndocuments too, whenever possible.  Here is an example of what the API could look like:  //  Let the user pick a file \ncozy.intents.start('PICK', 'io.cozy.files')\n.then(document =  {\n    // document is a JSON representation of the picked file\n});\n\n//  Create a contact, with some information already filled out \ncozy.intents.start('CREATE', 'io.cozy.contacts', {\n    name: 'John Johnsons',\n    tel: '+12345678'\n    email: 'john@johnsons.com'\n})\n.then(document =  {\n    // document is a JSON representation of the contact that was created\n});\n\n//  Save this file somewhere \ncozy.intents.start('CREATE', 'io.cozy.files', {\n    content: 'data:application/zip;base64,UEsDB...',\n    name: 'photos.zip'\n});\n\n//  Create a new note, and give me read-only access to it \ncozy.intents.start('CREATE', 'io.cozy.notes', {}, ['GET'])\n.then(document =  {\n    // document is a JSON representation of the note that was created.\n    // Additionally, this note can now be retrieved through the API since we have read access on it.\n});\n\n//  Create an event based on the provided data, and give me full access to it \ncozy.intents.start('CREATE', 'io.cozy.events', {\n    date: '2017/06/24',\n    title: 'Beach day'\n}, ['ALL'])\n.then(document =  {\n    // document is a JSON representation of the note that was created.\n    // Additionally, this note can now be retrieved through the API since we have read access on it.\n});\n\n//  Crop this picture \ncozy.intents.start('EDIT', 'image/png', {\n    content: 'data:image/png;base64,iVBORw...',\n    width: 50,\n    height: 50\n})\n.then(image =  {\n    //image is the edited version of the image provided above.\n})", 
            "title": "2. Intent Start"
        }, 
        {
            "location": "/cozy-stack/intents/#3-service-resolution", 
            "text": "The service resolution is the phase where a service is chosen to handle an\nintent. This phase is handled by the stack.  After the client has started it s intent, it sends the  action , the  type  and\nthe  permissions  to the stack. The stack will then traverse the list of\ninstalled apps and find all the apps that can handle that specific combination.\nNote that if the intent request  GET  permissions on a certain Cozy Document\nType, but the service does not have this permission itself, it can not handle\nthe intent.  The stack then stores the information for that intent:   A unique id for that intent  Client URL  Service URL  action  type  permissions   Finally, the service URL is suffixed with  ?intent=  followed by the intent s\nid, and then sent to the client.", 
            "title": "3. Service Resolution"
        }, 
        {
            "location": "/cozy-stack/intents/#service-choice", 
            "text": "If more than one service match the intent s criteria, the stack returns the list\nof all matching service URLs to the client (and stores it in the service URL\nversion of the intent it keeps in memory). The client is then free to pick one\narbitrarily.  The client may also decide to let the user choose one of the services. To do\nthis, it should start another intent with a  PICK  action and a  io.cozy.apps  type . This intent should be resolved by the stack to a special page, in order\nto avoid having multiple services trying to handle it and ending up in a loop.  This special page is a service like any other; it expects the list of services\nto pick from as input data, and will return the one that has been picked to the\nclient. The client can then proceed with the first intent.  The user may decide to abort the intent before picking a service. If that is the\ncase, the choice page will need to inform the client that the intent was\naborted.", 
            "title": "Service choice"
        }, 
        {
            "location": "/cozy-stack/intents/#no-available-service", 
            "text": "If no service is available to handle an intent, the stack returns an error to\nthe client.  At a later phase of this project, the stack may traverse the applications\nregistered in a store to find suitable services, and prompt the user to install\none.", 
            "title": "No available service"
        }, 
        {
            "location": "/cozy-stack/intents/#4-handshake", 
            "text": "The next phase consist of the client and the service establishing a\ncommunication channel between them. The communication will be done using the window.postMessage \nAPI.", 
            "title": "4. Handshake"
        }, 
        {
            "location": "/cozy-stack/intents/#service-initialization", 
            "text": "When the client receives the service URL from the stack, it starts to listen for\nmessages coming from that URL. Once the listener is started, it opens an iframe\nthat points to the service s URL.", 
            "title": "Service Initialization"
        }, 
        {
            "location": "/cozy-stack/intents/#service-to-client", 
            "text": "At this point, the service app is opened on the route that it provided in the href  part of it s manifest. This route now also contains the intent s id.  The service queries the stack to find out information about the intent, passing\nalong the intent id. In response, the stack sends the client s URL, the action , and the  type . If the intent includes  permissions , the stack sends\nthem too, as well as the client s permission id.  It then starts to listen for messages coming from the client s URL. Eventually,\nit sends a message to the client, as a mean to inform it that the service is now\nready.", 
            "title": "Service to Client"
        }, 
        {
            "location": "/cozy-stack/intents/#client-to-service", 
            "text": "After the client receives the  ready  message from the service, it sends a\nmessage to the service acknowledging the  ready  state.  Along with this message, it should send the  data  that was provided at the\nstart of the intent, if any.", 
            "title": "Client to Service"
        }, 
        {
            "location": "/cozy-stack/intents/#5-processing-terminating", 
            "text": "After this handshake, there is a confirmed communication channel between the\nclient and the service, and the service knows what it has to do. This is the\nphase where the user interacts with the service.  If the service is going to grant extra permissions to the client app, it is\nstrongly recommended to make this clear to the user.  When the service has finished his task, it sends a  completed  message to the\nclient. Permissions extensions should have been done before that. Along with the\ncompleted message, the service should send any data it deems relevant. This data\nshould be a JSON object. Again, the structure of that object is left to the\ndiscretion of the service, except when  type  is a MIME type. In that case, the\nfile should be represented as a base-64 encoded Data URL  and must be named  content . This\nconvention is also recomended when dealing with other intent  type s.  After the client receives a  completed  message, it can close the service s\niframe and resume operations as usual.  If, for whatever reason, the service can not fulfill the intent, it can send an error  message to the client. When the client receives an  error  message, the\nintent is aborted and the iframe can be closed.", 
            "title": "5. Processing &amp; Terminating"
        }, 
        {
            "location": "/cozy-stack/intents/#routes", 
            "text": "", 
            "title": "Routes"
        }, 
        {
            "location": "/cozy-stack/intents/#post-intents", 
            "text": "The client app can ask to start an intent via this route.  Any client-side app can call this route, no permission is needed.", 
            "title": "POST /intents"
        }, 
        {
            "location": "/cozy-stack/intents/#request", 
            "text": "POST /intents HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer eyJhbG...\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json  {\n   data : {\n     type :  io.cozy.intents ,\n     attributes : {\n       action :  PICK ,\n       type :  io.cozy.files ,\n       permissions : [ GET ]\n    }\n  }\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/intents/#response", 
            "text": "HTTP/1.1 201 Created\nContent-Type: application/vnd.api+json  {\n   data : {\n     id :  77bcc42c-0fd8-11e7-ac95-8f605f6e8338 ,\n     type :  io.cozy.intents ,\n     attributes : {\n       action :  PICK ,\n       type :  io.cozy.files ,\n       permissions : [ GET ],\n       client :  https://contacts.cozy.example.net ,\n       services : [\n        {\n           slug :  files ,\n           href :\n             https://files.cozy.example.net/pick?intent=77bcc42c-0fd8-11e7-ac95-8f605f6e8338 \n        }\n      ]\n    },\n     links : {\n       self :  /intents/77bcc42c-0fd8-11e7-ac95-8f605f6e8338 ,\n       permissions :  /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 \n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/intents/#get-intentsid", 
            "text": "Get all the informations about the intent  Note : only the service can access this route (no permission involved).", 
            "title": "GET /intents/:id"
        }, 
        {
            "location": "/cozy-stack/intents/#request_1", 
            "text": "GET /intents/77bcc42c-0fd8-11e7-ac95-8f605f6e8338 HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer J9l-ZhwP...\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/intents/#response_1", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json  {\n   data : {\n     id :  77bcc42c-0fd8-11e7-ac95-8f605f6e8338 ,\n     type :  io.cozy.intents ,\n     attributes : {\n       action :  PICK ,\n       type :  io.cozy.files ,\n       permissions : [ GET ],\n       client :  https://contacts.cozy.example.net ,\n       services : [\n        {\n           slug :  files ,\n           href :\n             https://files.cozy.example.net/pick?intent=77bcc42c-0fd8-11e7-ac95-8f605f6e8338 \n        }\n      ]\n    },\n     links : {\n       self :  /intents/77bcc42c-0fd8-11e7-ac95-8f605f6e8338 ,\n       permissions :  /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 \n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/intents/#annexes", 
            "text": "", 
            "title": "Annexes"
        }, 
        {
            "location": "/cozy-stack/intents/#use-cases", 
            "text": "Here is a non exhaustive list of situations that  may  use intents:   Configure a new connector account  Share a photo album via email  Add an attachment to an email  Attach a note to a contact  Create a contact based on an email  Save an attachment received in an email  Create a birthday event in a calendar, based on a contact  Create an event based on an email s content  Create an event based on an ICS file  Chose an avatar for a contact  Open a file from the file browser (music, PDF, image,  )  Attach a receipt to an expense  Provide a tip for another application", 
            "title": "Use Cases"
        }, 
        {
            "location": "/cozy-stack/intents/#bibliography-prior-art", 
            "text": "Prior art:\n  https://forum.cozy.io/t/cozy-tech-topic-inter-app-communication-architecture/2287  Web intents: http://webintents.org/  WebActivities: https://wiki.mozilla.org/WebAPI/WebActivities and\n  https://developer.mozilla.org/en-US/docs/Archive/Firefox_OS/API/Web_Activities  Siri Intents:\n  https://developer.apple.com/library/content/documentation/Intents/Conceptual/SiriIntegrationGuide/ResolvingandHandlingIntents.html#//apple_ref/doc/uid/TP40016875-CH5-SW1  Android Intents:\n  https://developer.android.com/reference/android/content/Intent.html  iOS extensions:\n  https://developer.apple.com/library/content/documentation/General/Conceptual/ExtensibilityPG/index.html", 
            "title": "Bibliography &amp; Prior Art"
        }, 
        {
            "location": "/cozy-stack/intents/#discarded-ideas", 
            "text": "", 
            "title": "Discarded Ideas"
        }, 
        {
            "location": "/cozy-stack/intents/#disposition", 
            "text": "Some specifications include a  disposition  field in the manifests, that gives a\nhint to the client about how to display the service (inlined or in a new\nwindow). Since we were unable to find a use case where a new window is required,\nwe decided not to include the  disposition  in this specification. It might be\nadded later if the need arises.", 
            "title": "Disposition"
        }, 
        {
            "location": "/cozy-stack/intents/#client-server-architecture", 
            "text": "Instead of letting the two applications communicate with each other, they could\nbe made to talk through the stack. This would be useful as the stack could act\nas a middleware, transforming data on the fly or granting permissions where\nappropriate.  However, this approach has also severe drawbacks, notably the fact that the\nstack must hold a copy of all the data that the apps want to transfer (which can\ninclude large files). It also makes it significantly harder for the client to\nknow when the intent has been processed.", 
            "title": "Client / Server architecture"
        }, 
        {
            "location": "/cozy-stack/intents/#data-representation", 
            "text": "The client could explicitly request a data format to be used in the\ncommunication. However, this idea was abandoned because the format is  always \njson, except when then intent s  type  is a MIME type, in which case the data\nformat  also  uses this type.", 
            "title": "Data representation"
        }, 
        {
            "location": "/cozy-stack/jobs/", 
            "text": "Table of contents\n\n\nJobs\n\n\nJobs are designed to represent asynchronous tasks that your cozy can execute.\nThese tasks can be scheduled in advance, recurring or sudden and provide various\nservices.\n\n\nAt the time, we do not provide \ngeneric\n and programmable tasks. This list of\navailable workers is part of the defined API.\n\n\nThe job queue can be either local to the cozy-stack when used as a monolithic\ninstance (self-hosted for instance) or distributed via a redis server for\ndistributed infrastructures.\n\n\nThis doc introduces two cozy types:\n\n\n\n\nio.cozy.jobs\n for jobs\n\n\nio.cozy.triggers\n for triggers\n\n\n\n\nTriggers\n\n\nJobs can be launched by five different types of triggers:\n\n\n\n\n@at\n to schedule a one-time job executed after at a specific time in the\n  future\n\n\n@in\n to schedule a one-time job executed after a specific amount of time\n\n\n@every\n to schedule periodic jobs executed at a given fix interval\n\n\n@cron\n to schedule recurring jobs scheduled at specific times\n\n\n@event\n to launch a job after a change in the cozy\n\n\n\n\nThese five triggers have specific syntaxes to describe when jobs should be\nscheduled. See below for more informations.\n\n\nJobs can also be queued up programatically, without the help of a specific\ntrigger directly via the \n/jobs/queue\n API. In this case the \ntrigger\n name is\nempty.\n\n\n@at\n syntax\n\n\nThe \n@at\n trigger takes a ISO-8601 formatted string indicating a UTC time in the\nfuture. The date is of this form: \nYYYY-MM-DDTHH:mm:ss.sssZ\n\n\nExamples\n\n\n@at 2018-12-12T15:36:25.507Z\n\n\n\n\n@in\n syntax\n\n\nThe \n@in\n trigger takes the same duration syntax as \n@every\n\n\nExamples\n\n\n@in 10m\n@in 1h30m\n\n\n\n\n@every\n syntax\n\n\nThe \n@every\n trigger uses the same syntax as golang\ns \ntime.ParseDuration\n (but\nonly support time units above seconds):\n\n\nA duration string is a possibly signed sequence of decimal numbers, each with\noptional fraction and a unit suffix, such as \n300ms\n, \n1.5h\n or \n2h45m\n. Valid\ntime units are \ns\n, \nm\n, \nh\n.\n\n\nExamples\n\n\n@every 1.5h   # schedules every 1 and a half hours\n@every 30m10s # schedules every 30 minutes and 10 seconds\n\n\n\n\n@cron\n syntax\n\n\nIn order to schedule recurring jobs, the \n@cron\n trigger has the syntax using\nsix fields:\n\n\n\n\n\n\n\n\nField name\n\n\nMandatory?\n\n\nAllowed values\n\n\nAllowed special characters\n\n\n\n\n\n\n\n\n\n\nSeconds\n\n\nYes\n\n\n0-59\n\n\n* / , -\n\n\n\n\n\n\nMinutes\n\n\nYes\n\n\n0-59\n\n\n* / , -\n\n\n\n\n\n\nHours\n\n\nYes\n\n\n0-23\n\n\n* / , -\n\n\n\n\n\n\nDay of month\n\n\nYes\n\n\n1-31\n\n\n* / , - ?\n\n\n\n\n\n\nMonth\n\n\nYes\n\n\n1-12 or JAN-DEC\n\n\n* / , -\n\n\n\n\n\n\nDay of week\n\n\nYes\n\n\n0-6 or SUN-SAT\n\n\n* / , - ?\n\n\n\n\n\n\n\n\nAsterisk ( \n*\n )\n\n\nThe asterisk indicates that the cron expression will match for all values of the\nfield; e.g., using an asterisk in the 5th field (month) would indicate every\nmonth.\n\n\nSlash ( \n/\n )\n\n\nSlashes are used to describe increments of ranges. For example 3-59/15 in the\n1st field (minutes) would indicate the 3rd minute of the hour and every 15\nminutes thereafter. The form \n\"*\\/...\"\n is equivalent to the form\n\n\"first-last/...\"\n, that is, an increment over the largest possible range of the\nfield. The form \n\"N-/...\"\n is accepted as meaning \n\"N-MAX/...\"\n, that is,\nstarting at N, use the increment until the end of that specific range. It does\nnot wrap around.\n\n\nComma ( \n,\n )\n\n\nCommas are used to separate items of a list. For example, using \n\"MON,WED,FRI\"\n\nin the 5th field (day of week) would mean Mondays, Wednesdays and Fridays.\n\n\nHyphen ( \n-\n )\n\n\nHyphens are used to define ranges. For example, 9-17 would indicate every hour\nbetween 9am and 5pm inclusive.\n\n\nQuestion mark ( \n?\n )\n\n\nQuestion mark may be used instead of \n*\n for leaving either day-of-month or\nday-of-week blank.\n\n\nTo schedule jobs given an interval:\n\n\nExamples:\n\n\n@cron 0 0 0 1 1 *  # Run once a year, midnight, Jan. 1st\n@cron 0 0 0 1 1 *  # Run once a year, midnight, Jan. 1st\n@cron 0 0 0 1 * *  # Run once a month, midnight, first of month\n@cron 0 0 0 * * 0  # Run once a week, midnight on Sunday\n@cron 0 0 0 * * *  # Run once a day, midnight\n@cron 0 0 * * * *  # Run once an hour, beginning of hour\n\n\n\n\n@event\n syntax\n\n\nThe \n@event\n syntax allows to trigger a job when something occurs in the stack.\nIt follow the same syntax than permissions scope string :\n\n\ntype[:verb][:values][:selector]\n\n\nUnlike for permissions string, the verb should be one of \nCREATED\n, \nDELETED\n,\n\nUPDATED\n.\n\n\nIt is a work in progress, for now only events on couchdb package triggers it.\n\n\nThe job worker will receive a compound message including original trigger_infos\nmessages and the event which has triggered it.\n\n\nExamples\n\n\n@event io.cozy.files // anything happens on files\n@event io.cozy.files:CREATED // a file was created\n@event io.cozy.files:DELETED:image/jpg:mime // an image was deleted\n\n\n\n\nError Handling\n\n\nJobs can fail to execute their task. We have two ways to parameterize such\ncases.\n\n\nRetry\n\n\nA retry count can be optionally specified to ask the worker to re-execute the\ntask if it has failed.\n\n\nEach retry is executed after a configurable delay. The try count is part of the\nattributes of the job. Also, each occurring error is kept in the \nerrors\n field\ncontaining all the errors that may have happened.\n\n\nTimeout\n\n\nA worker may never end. To prevent this, a configurable timeout value is\nspecified with the job.\n\n\nIf a job does not end after the specified amount of time, it will be aborted. A\ntimeout is just like another error from the worker and can provoke a retry if\nspecified.\n\n\nDefaults\n\n\nBy default, jobs are parameterized with a maximum of 3 tries with 1 minute\ntimeout.\n\n\nThese defaults may vary given the workload of the workers.\n\n\nJobs API\n\n\nExample and description of the attributes of a \nio.cozy.jobs\n:\n\n\n{\n  \ndomain\n: \nme.cozy.tools\n,\n  \nworker\n: \nsendmail\n,    // worker type name\n  \noptions\n: {\n    \npriority\n: 3,         // priority from 1 to 100, higher number is higher priority\n    \ntimeout\n: 60,         // timeout value in seconds\n    \nmax_exec_count\n: 3,   // maximum number of time the job should be executed (including retries)\n  },\n  \nstate\n: \nrunning\n,      // queued, running, errored\n  \nqueued_at\n: \n2016-09-19T12:35:08Z\n,  // time of the queuing\n  \nstarted_at\n: \n2016-09-19T12:35:08Z\n, // time of first execution\n  \nerror\n: \n             // error message if any\n}\n\n\n\n\nExample and description of a job creation options \u2014 as you can see, the options\nare replicated in the \nio.cozy.jobs\n attributes:\n\n\n{\n  \npriority\n: 3,         // priority from 1 to 100\n  \ntimeout\n: 60,         // timeout value in seconds\n  \nmax_exec_count\n: 3,   // maximum number of retry\n}\n\n\n\n\nGET /jobs/:job-id\n\n\nGet a job informations given its ID.\n\n\nRequest\n\n\nGET /jobs/123123 HTTP/1.1\nAccept: application/vnd.api+json\n\n\n\n\nResponse\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.jobs\n,\n    \nid\n: \n123123\n,\n    \nattributes\n: {\n      \ndomain\n: \nme.cozy.tools\n,\n      \nworker\n: \nsendmail\n,\n      \noptions\n: {\n        \npriority\n: 3,\n        \ntimeout\n: 60,\n        \nmax_exec_count\n: 3\n      },\n      \nstate\n: \nrunning\n,\n      \nqueued_at\n: \n2016-09-19T12:35:08Z\n,\n      \nstarted_at\n: \n2016-09-19T12:35:08Z\n,\n      \nerror\n: \n\n    },\n    \nlinks\n: {\n      \nself\n: \n/jobs/123123\n\n    }\n  }\n}\n\n\n\n\nPOST /jobs/queue/:worker-type\n\n\nEnqueue programmatically a new job.\n\n\nThis route requires a specific permission on the worker-type. A global\npermission on the global \nio.cozy.jobs\n doctype is not allowed.\n\n\nRequest\n\n\nPOST /jobs/queue/sendmail HTTP/1.1\nAccept: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \nattributes\n: {\n      \noptions\n: {\n        \npriority\n: 3,\n        \ntimeout\n: 60,\n        \nmax_exec_count\n: 3\n      },\n      \narguments\n: {} // any json value used as arguments for the job\n    }\n  }\n}\n\n\n\n\nResponse\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.jobs\n,\n    \nid\n: \n123123\n,\n    \nattributes\n: {\n      \ndomain\n: \nme.cozy.tools\n,\n      \nworker\n: \nsendmail\n,\n      \noptions\n: {\n        \npriority\n: 3,\n        \ntimeout\n: 60,\n        \nmax_exec_count\n: 3\n      },\n      \nstate\n: \nrunning\n,\n      \nqueued_at\n: \n2016-09-19T12:35:08Z\n,\n      \nstarted_at\n: \n2016-09-19T12:35:08Z\n,\n      \nerror\n: \n\n    },\n    \nlinks\n: {\n      \nself\n: \n/jobs/123123\n\n    }\n  }\n}\n\n\n\n\nPermissions\n\n\nTo use this endpoint, an application needs a permission on the type\n\nio.cozy.jobs\n for the verb \nPOST\n. The is required to restrict its permission\nto specific worker(s), like this (a global permission on the doctype is not\nallowed):\n\n\n{\n  \npermissions\n: {\n    \nmail-from-the-user\n: {\n      \ndescription\n: \nRequired to send mails from the user to his/her friends\n,\n      \ntype\n: \nio.cozy.jobs\n,\n      \nverbs\n: [\nPOST\n],\n      \nselector\n: \nworker\n,\n      \nvalues\n: [\nsendmail\n]\n    }\n  }\n}\n\n\n\n\nGET /jobs/queue/:worker-type\n\n\nList the jobs in the queue.\n\n\nRequest\n\n\nGET /jobs/queue/sendmail HTTP/1.1\nAccept: application/vnd.api+json\n\n\n\n\nResponse\n\n\n{\n  \ndata\n: [\n    {\n      \nattributes\n: {\n        \ndomain\n: \ncozy.tools:8080\n,\n        \noptions\n: null,\n        \nqueued_at\n: \n2017-09-29T15:32:31.953878568+02:00\n,\n        \nstarted_at\n: \n0001-01-01T00:00:00Z\n,\n        \nstate\n: \nqueued\n,\n        \nworker\n: \nlog\n\n      },\n      \nid\n: \n77689bca9634b4fb08d6ca3d1643de5f\n,\n      \nlinks\n: {\n        \nself\n: \n/jobs/log/77689bca9634b4fb08d6ca3d1643de5f\n\n      },\n      \nmeta\n: {\n        \nrev\n: \n1-f823bcd2759103a5ad1a98f4bf083b36\n\n      },\n      \ntype\n: \nio.cozy.jobs\n\n    }\n  ],\n  \nmeta\n: {\n    \ncount\n: 0\n  }\n}\n\n\n\n\nPermissions\n\n\nTo use this endpoint, an application needs a permission on the type\n\nio.cozy.jobs\n for the verb \nGET\n. In most cases, the application will restrict\nits permission to only one worker, like this:\n\n\n{\n  \npermissions\n: {\n    \nmail-from-the-user\n: {\n      \ndescription\n:\n        \nRequired to know the number of jobs in the sendmail queues\n,\n      \ntype\n: \nio.cozy.jobs\n,\n      \nverbs\n: [\nGET\n],\n      \nselector\n: \nworker\n,\n      \nvalues\n: [\nsendmail\n]\n    }\n  }\n}\n\n\n\n\nPOST /jobs/triggers\n\n\nAdd a trigger of the worker. See \ntriggers\n descriptions\n to see the\ntypes of trigger and their arguments syntax.\n\n\nThis route requires a specific permission on the worker type. A global\npermission on the global \nio.cozy.triggers\n doctype is not allowed.\n\n\nThe \ndebounce\n parameter can be used to limit the number of jobs created in a\nburst. It delays the creation of the job on the first input by the given time\nargument, and if the trigger has its condition matched again during this period,\nit won\nt create another job. It can be useful to combine it with the changes\nfeed of couchdb with a last sequence number persisted by the worker, as it\nallows to have a nice diff between two executions of the worker.\n\n\nRequest\n\n\nPOST /jobs/triggers HTTP/1.1\nAccept: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \nattributes\n: {\n      \ntype\n: \n@event\n,\n      \narguments\n: \nio.cozy.invitations\n,\n      \ndebounce\n: \n10m\n,\n      \nworker\n: \nsendmail\n,\n      \nworker_arguments\n: {},\n      \noptions\n: {\n        \npriority\n: 3,\n        \ntimeout\n: 60,\n        \nmax_exec_count\n: 3\n      }\n    }\n  }\n}\n\n\n\n\nResponse\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.triggers\n,\n    \nid\n: \n123123\n,\n    \nattributes\n: {\n      \ntype\n: \n@every\n,\n      \narguments\n: \n30m10s\n,\n      \ndebounce\n: \n10m\n,\n      \nworker\n: \nsendmail\n,\n      \noptions\n: {\n        \npriority\n: 3,\n        \ntimeout\n: 60,\n        \nmax_exec_count\n: 3\n      }\n    },\n    \nlinks\n: {\n      \nself\n: \n/jobs/triggers/123123\n\n    }\n  }\n}\n\n\n\n\nPermissions\n\n\nTo use this endpoint, an application needs a permission on the type\n\nio.cozy.triggers\n for the verb \nPOST\n. In most cases, the application will\nrestrict its permission to only one worker, like this:\n\n\n{\n  \npermissions\n: {\n    \nmail-from-the-user\n: {\n      \ndescription\n:\n        \nRequired to send regularly mails from the user to his/her friends\n,\n      \ntype\n: \nio.cozy.triggers\n,\n      \nverbs\n: [\nPOST\n],\n      \nselector\n: \nworker\n,\n      \nvalues\n: [\nsendmail\n]\n    }\n  }\n}\n\n\n\n\nGET /jobs/triggers/:trigger-id\n\n\nGet a trigger informations given its ID.\n\n\nRequest\n\n\nGET /jobs/triggers/123123 HTTP/1.1\nAccept: application/vnd.api+json\n\n\n\n\nResponse\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.triggers\n,\n    \nid\n: \n123123\n,\n    \nattributes\n: {\n      \ntype\n: \n@every\n,\n      \narguments\n: \n30m10s\n,\n      \nworker\n: \nsendmail\n,\n      \noptions\n: {\n        \npriority\n: 3,\n        \ntimeout\n: 60,\n        \nmax_exec_count\n: 3\n      },\n      \ncurrent_state\n: {\n        \nstatus\n: \ndone\n,\n        \nlast_success\n: \n2017-11-20T13:31:09.01641731\n,\n        \nlast_successful_job_id\n: \nabcde\n,\n        \nlast_execution\n: \n2017-11-20T13:31:09.01641731\n,\n        \nlast_executed_job_id\n: \nabcde\n,\n        \nlast_failure\n: \n2017-11-20T13:31:09.01641731\n,\n        \nlast_failed_job_id\n: \nabcde\n,\n        \nlast_error\n: \nerror value\n,\n        \nlast_manual_execution\n: \n2017-11-20T13:31:09.01641731\n,\n        \nlast_manual_job_id\n: \nabcde\n\n      }\n    },\n    \nlinks\n: {\n      \nself\n: \n/jobs/triggers/123123\n\n    }\n  }\n}\n\n\n\n\nPermissions\n\n\nTo use this endpoint, an application needs a permission on the type\n\nio.cozy.triggers\n for the verb \nGET\n.\n\n\nGET /jobs/triggers/:trigger-id/state\n\n\nGet the trigger current state, to give a big picture of the health of the\ntrigger.\n\n\n\n\nlast executed job status (\ndone\n, \nerrored\n, \nqueued\n or \nrunning\n)\n\n\nlast executed job that resulted in a successful executoin\n\n\nlast executed job that resulted in an error\n\n\nlast executed job from a manual execution (not executed by the trigger\n  directly)\n\n\n\n\nRequest\n\n\nGET /jobs/triggers/123123/state HTTP/1.1\nAccept: application/vnd.api+json\n\n\n\n\nResponse\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.jobs.state\n,\n    \nid\n: \n123123\n,\n    \nattributes\n: {\n      \nstatus\n: \ndone\n,\n      \nlast_success\n: \n2017-11-20T13:31:09.01641731\n,\n      \nlast_successful_job_id\n: \nabcde\n,\n      \nlast_execution\n: \n2017-11-20T13:31:09.01641731\n,\n      \nlast_executed_job_id\n: \nabcde\n,\n      \nlast_failure\n: \n2017-11-20T13:31:09.01641731\n,\n      \nlast_failed_job_id\n: \nabcde\n,\n      \nlast_error\n: \nerror value\n,\n      \nlast_manual_execution\n: \n2017-11-20T13:31:09.01641731\n,\n      \nlast_manual_job_id\n: \nabcde\n\n    }\n  }\n}\n\n\n\n\nPermissions\n\n\nTo use this endpoint, an application needs a permission on the type\n\nio.cozy.triggers\n for the verb \nGET\n.\n\n\nGET /jobs/triggers/:trigger-id/jobs\n\n\nGet the jobs launched by the trigger with the specified ID.\n\n\nQuery parameters:\n\n\n\n\nLimit\n: to specify the number of jobs to get out\n\n\n\n\nRequest\n\n\nGET /jobs/triggers/123123/jobs?Limit=1 HTTP/1.1\nAccept: application/vnd.api+json\n\n\n\n\nResponse\n\n\n{\n  \ndata\n: [\n    {\n      \ntype\n: \nio.cozy.jobs\n,\n      \nid\n: \n123123\n,\n      \nattributes\n: {},\n      \nlinks\n: {\n        \nself\n: \n/jobs/123123\n\n      }\n    }\n  ]\n}\n\n\n\n\nPOST /jobs/triggers/:trigger-id/launch\n\n\nLaunch a trigger manually given its ID and return the created job.\n\n\nRequest\n\n\nPOST /jobs/triggers/123123/launch HTTP/1.1\nAccept: application/vnd.api+json\n\n\n\n\nResponse\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.jobs\n,\n    \nid\n: \n123123\n,\n    \nattributes\n: {\n      \ndomain\n: \nme.cozy.tools\n,\n      \nworker\n: \nsendmail\n,\n      \noptions\n: {},\n      \nstate\n: \nrunning\n,\n      \nqueued_at\n: \n2016-09-19T12:35:08Z\n,\n      \nstarted_at\n: \n2016-09-19T12:35:08Z\n,\n      \nerror\n: \n\n    },\n    \nlinks\n: {\n      \nself\n: \n/jobs/123123\n\n    }\n  }\n}\n\n\n\n\nPermissions\n\n\nTo use this endpoint, an application needs a permission on the type\n\nio.cozy.triggers\n for the verb \nPOST\n.\n\n\nDELETE /jobs/triggers/:trigger-id\n\n\nDelete a trigger given its ID.\n\n\nRequest\n\n\nDELETE /jobs/triggers/123123 HTTP/1.1\nAccept: application/vnd.api+json\n\n\n\n\nPermissions\n\n\nTo use this endpoint, an application needs a permission on the type\n\nio.cozy.triggers\n for the verb \nDELETE\n.\n\n\nGET /jobs/triggers\n\n\nGet the list of triggers.\n\n\nQuery parameters:\n\n\n\n\nWorker\n: to filter only triggers associated with a specific worker.\n\n\n\n\nRequest\n\n\nGET /jobs/triggers?Worker=konnector HTTP/1.1\nAccept: application/vnd.api+json\n\n\n\n\nResponse\n\n\n{\n  \ndata\n: [\n    {\n      \ntype\n: \nio.cozy.triggers\n,\n      \nid\n: \n123123\n,\n      \nattributes\n: {},\n      \nlinks\n: {\n        \nself\n: \n/jobs/triggers/123123\n\n      }\n    }\n  ]\n}\n\n\n\n\nPermissions\n\n\nTo use this endpoint, an application needs a permission on the type\n\nio.cozy.triggers\n for the verb \nGET\n. When used on a specific worker, the\npermission can be specified on the \nworker\n field.\n\n\nWorker pool\n\n\nThe consuming side of the job queue is handled by a worker pool.\n\n\nOn a monolithic cozy-stack, the worker pool has a configurable fixed size of\nworkers. The default value is not yet determined. Each time a worker has\nfinished a job, it check the queue and based on the priority and the queued date\nof the job, picks a new job to execute.\n\n\nPermissions\n\n\nIn order to prevent jobs from leaking informations between applications, we may\nneed to add filtering per applications: for instance one queue per applications.\n\n\nWe should also have an explicit check on the permissions of the applications\nbefore launching a job scheduled by an application. For more information, refer\nto our \npermission document\n.\n\n\nMulti-stack\n\n\nWhen some instances are served by several stacks, the scheduling and running of\njobs can be distributed on the stacks. The synchronization is done via redis.\n\n\nFor scheduling, there is one important key in redis: \ntriggers\n. It\ns a sorted\nset. The members are the identifiants of the triggers (with the domain name),\nand the score are the timestamp of the next time the trigger should occur.\nDuring the short period of time where a trigger is processed, its key is moved\nto \nscheduling\n (another sorted set). So, even if a stack crash during\nprocessing a trigger, this trigger won\nt be lost.\n\n\nFor \n@event\n triggers, we don\nt use the same mechanism. Each stack has all the\ntriggers in memory and is responsible to trigger them for the events generated\nby the HTTP requests of their API. They also publish them on redis: this pub/sub\nis used for the realtime API.", 
            "title": "/jobs Jobs"
        }, 
        {
            "location": "/cozy-stack/jobs/#jobs", 
            "text": "Jobs are designed to represent asynchronous tasks that your cozy can execute.\nThese tasks can be scheduled in advance, recurring or sudden and provide various\nservices.  At the time, we do not provide  generic  and programmable tasks. This list of\navailable workers is part of the defined API.  The job queue can be either local to the cozy-stack when used as a monolithic\ninstance (self-hosted for instance) or distributed via a redis server for\ndistributed infrastructures.  This doc introduces two cozy types:   io.cozy.jobs  for jobs  io.cozy.triggers  for triggers", 
            "title": "Jobs"
        }, 
        {
            "location": "/cozy-stack/jobs/#triggers", 
            "text": "Jobs can be launched by five different types of triggers:   @at  to schedule a one-time job executed after at a specific time in the\n  future  @in  to schedule a one-time job executed after a specific amount of time  @every  to schedule periodic jobs executed at a given fix interval  @cron  to schedule recurring jobs scheduled at specific times  @event  to launch a job after a change in the cozy   These five triggers have specific syntaxes to describe when jobs should be\nscheduled. See below for more informations.  Jobs can also be queued up programatically, without the help of a specific\ntrigger directly via the  /jobs/queue  API. In this case the  trigger  name is\nempty.", 
            "title": "Triggers"
        }, 
        {
            "location": "/cozy-stack/jobs/#at-syntax", 
            "text": "The  @at  trigger takes a ISO-8601 formatted string indicating a UTC time in the\nfuture. The date is of this form:  YYYY-MM-DDTHH:mm:ss.sssZ  Examples  @at 2018-12-12T15:36:25.507Z", 
            "title": "@at syntax"
        }, 
        {
            "location": "/cozy-stack/jobs/#in-syntax", 
            "text": "The  @in  trigger takes the same duration syntax as  @every  Examples  @in 10m\n@in 1h30m", 
            "title": "@in syntax"
        }, 
        {
            "location": "/cozy-stack/jobs/#every-syntax", 
            "text": "The  @every  trigger uses the same syntax as golang s  time.ParseDuration  (but\nonly support time units above seconds):  A duration string is a possibly signed sequence of decimal numbers, each with\noptional fraction and a unit suffix, such as  300ms ,  1.5h  or  2h45m . Valid\ntime units are  s ,  m ,  h .  Examples  @every 1.5h   # schedules every 1 and a half hours\n@every 30m10s # schedules every 30 minutes and 10 seconds", 
            "title": "@every syntax"
        }, 
        {
            "location": "/cozy-stack/jobs/#cron-syntax", 
            "text": "In order to schedule recurring jobs, the  @cron  trigger has the syntax using\nsix fields:     Field name  Mandatory?  Allowed values  Allowed special characters      Seconds  Yes  0-59  * / , -    Minutes  Yes  0-59  * / , -    Hours  Yes  0-23  * / , -    Day of month  Yes  1-31  * / , - ?    Month  Yes  1-12 or JAN-DEC  * / , -    Day of week  Yes  0-6 or SUN-SAT  * / , - ?     Asterisk (  *  )  The asterisk indicates that the cron expression will match for all values of the\nfield; e.g., using an asterisk in the 5th field (month) would indicate every\nmonth.  Slash (  /  )  Slashes are used to describe increments of ranges. For example 3-59/15 in the\n1st field (minutes) would indicate the 3rd minute of the hour and every 15\nminutes thereafter. The form  \"*\\/...\"  is equivalent to the form \"first-last/...\" , that is, an increment over the largest possible range of the\nfield. The form  \"N-/...\"  is accepted as meaning  \"N-MAX/...\" , that is,\nstarting at N, use the increment until the end of that specific range. It does\nnot wrap around.  Comma (  ,  )  Commas are used to separate items of a list. For example, using  \"MON,WED,FRI\" \nin the 5th field (day of week) would mean Mondays, Wednesdays and Fridays.  Hyphen (  -  )  Hyphens are used to define ranges. For example, 9-17 would indicate every hour\nbetween 9am and 5pm inclusive.  Question mark (  ?  )  Question mark may be used instead of  *  for leaving either day-of-month or\nday-of-week blank.  To schedule jobs given an interval:  Examples:  @cron 0 0 0 1 1 *  # Run once a year, midnight, Jan. 1st\n@cron 0 0 0 1 1 *  # Run once a year, midnight, Jan. 1st\n@cron 0 0 0 1 * *  # Run once a month, midnight, first of month\n@cron 0 0 0 * * 0  # Run once a week, midnight on Sunday\n@cron 0 0 0 * * *  # Run once a day, midnight\n@cron 0 0 * * * *  # Run once an hour, beginning of hour", 
            "title": "@cron syntax"
        }, 
        {
            "location": "/cozy-stack/jobs/#event-syntax", 
            "text": "The  @event  syntax allows to trigger a job when something occurs in the stack.\nIt follow the same syntax than permissions scope string :  type[:verb][:values][:selector]  Unlike for permissions string, the verb should be one of  CREATED ,  DELETED , UPDATED .  It is a work in progress, for now only events on couchdb package triggers it.  The job worker will receive a compound message including original trigger_infos\nmessages and the event which has triggered it.  Examples  @event io.cozy.files // anything happens on files\n@event io.cozy.files:CREATED // a file was created\n@event io.cozy.files:DELETED:image/jpg:mime // an image was deleted", 
            "title": "@event syntax"
        }, 
        {
            "location": "/cozy-stack/jobs/#error-handling", 
            "text": "Jobs can fail to execute their task. We have two ways to parameterize such\ncases.", 
            "title": "Error Handling"
        }, 
        {
            "location": "/cozy-stack/jobs/#retry", 
            "text": "A retry count can be optionally specified to ask the worker to re-execute the\ntask if it has failed.  Each retry is executed after a configurable delay. The try count is part of the\nattributes of the job. Also, each occurring error is kept in the  errors  field\ncontaining all the errors that may have happened.", 
            "title": "Retry"
        }, 
        {
            "location": "/cozy-stack/jobs/#timeout", 
            "text": "A worker may never end. To prevent this, a configurable timeout value is\nspecified with the job.  If a job does not end after the specified amount of time, it will be aborted. A\ntimeout is just like another error from the worker and can provoke a retry if\nspecified.", 
            "title": "Timeout"
        }, 
        {
            "location": "/cozy-stack/jobs/#defaults", 
            "text": "By default, jobs are parameterized with a maximum of 3 tries with 1 minute\ntimeout.  These defaults may vary given the workload of the workers.", 
            "title": "Defaults"
        }, 
        {
            "location": "/cozy-stack/jobs/#jobs-api", 
            "text": "Example and description of the attributes of a  io.cozy.jobs :  {\n   domain :  me.cozy.tools ,\n   worker :  sendmail ,    // worker type name\n   options : {\n     priority : 3,         // priority from 1 to 100, higher number is higher priority\n     timeout : 60,         // timeout value in seconds\n     max_exec_count : 3,   // maximum number of time the job should be executed (including retries)\n  },\n   state :  running ,      // queued, running, errored\n   queued_at :  2016-09-19T12:35:08Z ,  // time of the queuing\n   started_at :  2016-09-19T12:35:08Z , // time of first execution\n   error :               // error message if any\n}  Example and description of a job creation options \u2014 as you can see, the options\nare replicated in the  io.cozy.jobs  attributes:  {\n   priority : 3,         // priority from 1 to 100\n   timeout : 60,         // timeout value in seconds\n   max_exec_count : 3,   // maximum number of retry\n}", 
            "title": "Jobs API"
        }, 
        {
            "location": "/cozy-stack/jobs/#get-jobsjob-id", 
            "text": "Get a job informations given its ID.", 
            "title": "GET /jobs/:job-id"
        }, 
        {
            "location": "/cozy-stack/jobs/#request", 
            "text": "GET /jobs/123123 HTTP/1.1\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/jobs/#response", 
            "text": "{\n   data : {\n     type :  io.cozy.jobs ,\n     id :  123123 ,\n     attributes : {\n       domain :  me.cozy.tools ,\n       worker :  sendmail ,\n       options : {\n         priority : 3,\n         timeout : 60,\n         max_exec_count : 3\n      },\n       state :  running ,\n       queued_at :  2016-09-19T12:35:08Z ,\n       started_at :  2016-09-19T12:35:08Z ,\n       error :  \n    },\n     links : {\n       self :  /jobs/123123 \n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/jobs/#post-jobsqueueworker-type", 
            "text": "Enqueue programmatically a new job.  This route requires a specific permission on the worker-type. A global\npermission on the global  io.cozy.jobs  doctype is not allowed.", 
            "title": "POST /jobs/queue/:worker-type"
        }, 
        {
            "location": "/cozy-stack/jobs/#request_1", 
            "text": "POST /jobs/queue/sendmail HTTP/1.1\nAccept: application/vnd.api+json  {\n   data : {\n     attributes : {\n       options : {\n         priority : 3,\n         timeout : 60,\n         max_exec_count : 3\n      },\n       arguments : {} // any json value used as arguments for the job\n    }\n  }\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/jobs/#response_1", 
            "text": "{\n   data : {\n     type :  io.cozy.jobs ,\n     id :  123123 ,\n     attributes : {\n       domain :  me.cozy.tools ,\n       worker :  sendmail ,\n       options : {\n         priority : 3,\n         timeout : 60,\n         max_exec_count : 3\n      },\n       state :  running ,\n       queued_at :  2016-09-19T12:35:08Z ,\n       started_at :  2016-09-19T12:35:08Z ,\n       error :  \n    },\n     links : {\n       self :  /jobs/123123 \n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/jobs/#permissions", 
            "text": "To use this endpoint, an application needs a permission on the type io.cozy.jobs  for the verb  POST . The is required to restrict its permission\nto specific worker(s), like this (a global permission on the doctype is not\nallowed):  {\n   permissions : {\n     mail-from-the-user : {\n       description :  Required to send mails from the user to his/her friends ,\n       type :  io.cozy.jobs ,\n       verbs : [ POST ],\n       selector :  worker ,\n       values : [ sendmail ]\n    }\n  }\n}", 
            "title": "Permissions"
        }, 
        {
            "location": "/cozy-stack/jobs/#get-jobsqueueworker-type", 
            "text": "List the jobs in the queue.", 
            "title": "GET /jobs/queue/:worker-type"
        }, 
        {
            "location": "/cozy-stack/jobs/#request_2", 
            "text": "GET /jobs/queue/sendmail HTTP/1.1\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/jobs/#response_2", 
            "text": "{\n   data : [\n    {\n       attributes : {\n         domain :  cozy.tools:8080 ,\n         options : null,\n         queued_at :  2017-09-29T15:32:31.953878568+02:00 ,\n         started_at :  0001-01-01T00:00:00Z ,\n         state :  queued ,\n         worker :  log \n      },\n       id :  77689bca9634b4fb08d6ca3d1643de5f ,\n       links : {\n         self :  /jobs/log/77689bca9634b4fb08d6ca3d1643de5f \n      },\n       meta : {\n         rev :  1-f823bcd2759103a5ad1a98f4bf083b36 \n      },\n       type :  io.cozy.jobs \n    }\n  ],\n   meta : {\n     count : 0\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/jobs/#permissions_1", 
            "text": "To use this endpoint, an application needs a permission on the type io.cozy.jobs  for the verb  GET . In most cases, the application will restrict\nits permission to only one worker, like this:  {\n   permissions : {\n     mail-from-the-user : {\n       description :\n         Required to know the number of jobs in the sendmail queues ,\n       type :  io.cozy.jobs ,\n       verbs : [ GET ],\n       selector :  worker ,\n       values : [ sendmail ]\n    }\n  }\n}", 
            "title": "Permissions"
        }, 
        {
            "location": "/cozy-stack/jobs/#post-jobstriggers", 
            "text": "Add a trigger of the worker. See  triggers  descriptions  to see the\ntypes of trigger and their arguments syntax.  This route requires a specific permission on the worker type. A global\npermission on the global  io.cozy.triggers  doctype is not allowed.  The  debounce  parameter can be used to limit the number of jobs created in a\nburst. It delays the creation of the job on the first input by the given time\nargument, and if the trigger has its condition matched again during this period,\nit won t create another job. It can be useful to combine it with the changes\nfeed of couchdb with a last sequence number persisted by the worker, as it\nallows to have a nice diff between two executions of the worker.", 
            "title": "POST /jobs/triggers"
        }, 
        {
            "location": "/cozy-stack/jobs/#request_3", 
            "text": "POST /jobs/triggers HTTP/1.1\nAccept: application/vnd.api+json  {\n   data : {\n     attributes : {\n       type :  @event ,\n       arguments :  io.cozy.invitations ,\n       debounce :  10m ,\n       worker :  sendmail ,\n       worker_arguments : {},\n       options : {\n         priority : 3,\n         timeout : 60,\n         max_exec_count : 3\n      }\n    }\n  }\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/jobs/#response_3", 
            "text": "{\n   data : {\n     type :  io.cozy.triggers ,\n     id :  123123 ,\n     attributes : {\n       type :  @every ,\n       arguments :  30m10s ,\n       debounce :  10m ,\n       worker :  sendmail ,\n       options : {\n         priority : 3,\n         timeout : 60,\n         max_exec_count : 3\n      }\n    },\n     links : {\n       self :  /jobs/triggers/123123 \n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/jobs/#permissions_2", 
            "text": "To use this endpoint, an application needs a permission on the type io.cozy.triggers  for the verb  POST . In most cases, the application will\nrestrict its permission to only one worker, like this:  {\n   permissions : {\n     mail-from-the-user : {\n       description :\n         Required to send regularly mails from the user to his/her friends ,\n       type :  io.cozy.triggers ,\n       verbs : [ POST ],\n       selector :  worker ,\n       values : [ sendmail ]\n    }\n  }\n}", 
            "title": "Permissions"
        }, 
        {
            "location": "/cozy-stack/jobs/#get-jobstriggerstrigger-id", 
            "text": "Get a trigger informations given its ID.", 
            "title": "GET /jobs/triggers/:trigger-id"
        }, 
        {
            "location": "/cozy-stack/jobs/#request_4", 
            "text": "GET /jobs/triggers/123123 HTTP/1.1\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/jobs/#response_4", 
            "text": "{\n   data : {\n     type :  io.cozy.triggers ,\n     id :  123123 ,\n     attributes : {\n       type :  @every ,\n       arguments :  30m10s ,\n       worker :  sendmail ,\n       options : {\n         priority : 3,\n         timeout : 60,\n         max_exec_count : 3\n      },\n       current_state : {\n         status :  done ,\n         last_success :  2017-11-20T13:31:09.01641731 ,\n         last_successful_job_id :  abcde ,\n         last_execution :  2017-11-20T13:31:09.01641731 ,\n         last_executed_job_id :  abcde ,\n         last_failure :  2017-11-20T13:31:09.01641731 ,\n         last_failed_job_id :  abcde ,\n         last_error :  error value ,\n         last_manual_execution :  2017-11-20T13:31:09.01641731 ,\n         last_manual_job_id :  abcde \n      }\n    },\n     links : {\n       self :  /jobs/triggers/123123 \n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/jobs/#permissions_3", 
            "text": "To use this endpoint, an application needs a permission on the type io.cozy.triggers  for the verb  GET .", 
            "title": "Permissions"
        }, 
        {
            "location": "/cozy-stack/jobs/#get-jobstriggerstrigger-idstate", 
            "text": "Get the trigger current state, to give a big picture of the health of the\ntrigger.   last executed job status ( done ,  errored ,  queued  or  running )  last executed job that resulted in a successful executoin  last executed job that resulted in an error  last executed job from a manual execution (not executed by the trigger\n  directly)", 
            "title": "GET /jobs/triggers/:trigger-id/state"
        }, 
        {
            "location": "/cozy-stack/jobs/#request_5", 
            "text": "GET /jobs/triggers/123123/state HTTP/1.1\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/jobs/#response_5", 
            "text": "{\n   data : {\n     type :  io.cozy.jobs.state ,\n     id :  123123 ,\n     attributes : {\n       status :  done ,\n       last_success :  2017-11-20T13:31:09.01641731 ,\n       last_successful_job_id :  abcde ,\n       last_execution :  2017-11-20T13:31:09.01641731 ,\n       last_executed_job_id :  abcde ,\n       last_failure :  2017-11-20T13:31:09.01641731 ,\n       last_failed_job_id :  abcde ,\n       last_error :  error value ,\n       last_manual_execution :  2017-11-20T13:31:09.01641731 ,\n       last_manual_job_id :  abcde \n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/jobs/#permissions_4", 
            "text": "To use this endpoint, an application needs a permission on the type io.cozy.triggers  for the verb  GET .", 
            "title": "Permissions"
        }, 
        {
            "location": "/cozy-stack/jobs/#get-jobstriggerstrigger-idjobs", 
            "text": "Get the jobs launched by the trigger with the specified ID.  Query parameters:   Limit : to specify the number of jobs to get out", 
            "title": "GET /jobs/triggers/:trigger-id/jobs"
        }, 
        {
            "location": "/cozy-stack/jobs/#request_6", 
            "text": "GET /jobs/triggers/123123/jobs?Limit=1 HTTP/1.1\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/jobs/#response_6", 
            "text": "{\n   data : [\n    {\n       type :  io.cozy.jobs ,\n       id :  123123 ,\n       attributes : {},\n       links : {\n         self :  /jobs/123123 \n      }\n    }\n  ]\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/jobs/#post-jobstriggerstrigger-idlaunch", 
            "text": "Launch a trigger manually given its ID and return the created job.", 
            "title": "POST /jobs/triggers/:trigger-id/launch"
        }, 
        {
            "location": "/cozy-stack/jobs/#request_7", 
            "text": "POST /jobs/triggers/123123/launch HTTP/1.1\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/jobs/#response_7", 
            "text": "{\n   data : {\n     type :  io.cozy.jobs ,\n     id :  123123 ,\n     attributes : {\n       domain :  me.cozy.tools ,\n       worker :  sendmail ,\n       options : {},\n       state :  running ,\n       queued_at :  2016-09-19T12:35:08Z ,\n       started_at :  2016-09-19T12:35:08Z ,\n       error :  \n    },\n     links : {\n       self :  /jobs/123123 \n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/jobs/#permissions_5", 
            "text": "To use this endpoint, an application needs a permission on the type io.cozy.triggers  for the verb  POST .", 
            "title": "Permissions"
        }, 
        {
            "location": "/cozy-stack/jobs/#delete-jobstriggerstrigger-id", 
            "text": "Delete a trigger given its ID.", 
            "title": "DELETE /jobs/triggers/:trigger-id"
        }, 
        {
            "location": "/cozy-stack/jobs/#request_8", 
            "text": "DELETE /jobs/triggers/123123 HTTP/1.1\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/jobs/#permissions_6", 
            "text": "To use this endpoint, an application needs a permission on the type io.cozy.triggers  for the verb  DELETE .", 
            "title": "Permissions"
        }, 
        {
            "location": "/cozy-stack/jobs/#get-jobstriggers", 
            "text": "Get the list of triggers.  Query parameters:   Worker : to filter only triggers associated with a specific worker.", 
            "title": "GET /jobs/triggers"
        }, 
        {
            "location": "/cozy-stack/jobs/#request_9", 
            "text": "GET /jobs/triggers?Worker=konnector HTTP/1.1\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/jobs/#response_8", 
            "text": "{\n   data : [\n    {\n       type :  io.cozy.triggers ,\n       id :  123123 ,\n       attributes : {},\n       links : {\n         self :  /jobs/triggers/123123 \n      }\n    }\n  ]\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/jobs/#permissions_7", 
            "text": "To use this endpoint, an application needs a permission on the type io.cozy.triggers  for the verb  GET . When used on a specific worker, the\npermission can be specified on the  worker  field.", 
            "title": "Permissions"
        }, 
        {
            "location": "/cozy-stack/jobs/#worker-pool", 
            "text": "The consuming side of the job queue is handled by a worker pool.  On a monolithic cozy-stack, the worker pool has a configurable fixed size of\nworkers. The default value is not yet determined. Each time a worker has\nfinished a job, it check the queue and based on the priority and the queued date\nof the job, picks a new job to execute.", 
            "title": "Worker pool"
        }, 
        {
            "location": "/cozy-stack/jobs/#permissions_8", 
            "text": "In order to prevent jobs from leaking informations between applications, we may\nneed to add filtering per applications: for instance one queue per applications.  We should also have an explicit check on the permissions of the applications\nbefore launching a job scheduled by an application. For more information, refer\nto our  permission document .", 
            "title": "Permissions"
        }, 
        {
            "location": "/cozy-stack/jobs/#multi-stack", 
            "text": "When some instances are served by several stacks, the scheduling and running of\njobs can be distributed on the stacks. The synchronization is done via redis.  For scheduling, there is one important key in redis:  triggers . It s a sorted\nset. The members are the identifiants of the triggers (with the domain name),\nand the score are the timestamp of the next time the trigger should occur.\nDuring the short period of time where a trigger is processed, its key is moved\nto  scheduling  (another sorted set). So, even if a stack crash during\nprocessing a trigger, this trigger won t be lost.  For  @event  triggers, we don t use the same mechanism. Each stack has all the\ntriggers in memory and is responsible to trigger them for the events generated\nby the HTTP requests of their API. They also publish them on redis: this pub/sub\nis used for the realtime API.", 
            "title": "Multi-stack"
        }, 
        {
            "location": "/cozy-stack/konnectors/", 
            "text": "Table of contents\n\n\nKonnectors\n\n\nIt is possible to manage konnectors applications from the stack. The source-code\nof the konnector is installed on the cozy and the user can manage its execution\n\nvia\n our \njob system\n and the \nkonnector worker\n.\n\n\nInstall a konnector\n\n\nThe manifest\n\n\n\n\n\n\n\n\nField\n\n\nDescription\n\n\n\n\n\n\n\n\n\n\nname\n\n\nthe name to display on the home\n\n\n\n\n\n\nslug\n\n\nthe default slug (it can be changed at install time)\n\n\n\n\n\n\neditor\n\n\nthe editor\ns name to display on the cozy-bar of the app\n\n\n\n\n\n\ntype\n\n\nthe type of the konnector source (\nnode\n is the only supported for now)\n\n\n\n\n\n\nicon\n\n\nan icon for the home\n\n\n\n\n\n\nscreenshots\n\n\nan array of path to the screenshots of the application\n\n\n\n\n\n\ncategory\n\n\nthe category of the application\n\n\n\n\n\n\nshort_description\n\n\na short description of the application\n\n\n\n\n\n\nlong_description\n\n\na long description of the application\n\n\n\n\n\n\nsource\n\n\nwhere the files of the app can be downloaded\n\n\n\n\n\n\ndeveloper\n\n\nname\n and \nurl\n for the developer\n\n\n\n\n\n\ndefault_locale\n\n\nthe locale used for the name and description fields\n\n\n\n\n\n\nlocales\n\n\ntranslations of the name and description fields in other locales\n\n\n\n\n\n\nlangs\n\n\nlist of languages tags supported by the application\n\n\n\n\n\n\nversion\n\n\nthe current version number\n\n\n\n\n\n\nparameters\n\n\nany json object that will be passed to the konnector on execution in the \nCOZY_PARAMETERS\n environment variable\n\n\n\n\n\n\nlicense\n\n\nthe SPDX license identifier\n\n\n\n\n\n\npermissions\n\n\na map of permissions needed by the app (see \nhere\n for more details)\n\n\n\n\n\n\n\n\nPOST /konnectors/:slug\n\n\nInstall a konnector, ie download the files and put them in \n/konnectors/:slug\n\nin the virtual file system of the user, create an \nio.cozy.konnectors\n document,\nregister the permissions, etc.\n\n\nThis endpoint is asynchronous and returns a successful return as soon as the\nkonnector installation has started, meaning we have successfully reached the\nmanifest and started to fetch konnector source code.\n\n\nTo make this endpoint synchronous, use the header \nAccept: text/event-stream\n.\nThis will make a eventsource stream sending the manifest and returning when the\nkonnector has been installed or failed.\n\n\nStatus codes\n\n\n\n\n202 Accepted, when the konnector installation has been accepted.\n\n\n400 Bad-Request, when the manifest of the konnector could not be processed\n  (for instance, it is not valid JSON).\n\n\n404 Not Found, when the manifest or the source of the konnector is not\n  reachable.\n\n\n422 Unprocessable Entity, when the sent data is invalid (for example, the slug\n  is invalid or the Source parameter is not a proper or supported url)\n\n\n\n\nQuery-String\n\n\n\n\n\n\n\n\nParameter\n\n\nDescription\n\n\n\n\n\n\n\n\n\n\nSource\n\n\nURL from where the app can be downloaded (only for install)\n\n\n\n\n\n\n\n\nRequest\n\n\nPOST /konnectors/bank101?Source=git://github.com/cozy/cozy-bank101.git HTTP/1.1\nAccept: application/vnd.api+json\n\n\n\n\nResponse\n\n\nHTTP/1.1 202 Accepted\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: [{\n    \nid\n: \n4cfbd8be-8968-11e6-9708-ef55b7c20863\n,\n    \ntype\n: \nio.cozy.konnectors\n,\n    \nmeta\n: {\n      \nrev\n: \n1-7a1f918147df94580c92b47275e4604a\n\n    },\n    \nattributes\n: {\n      \nname\n: \nbank101\n,\n      \nstate\n: \ninstalling\n,\n      \nslug\n: \nbank101\n,\n      ...\n    },\n    \nlinks\n: {\n      \nself\n: \n/konnectors/bank101\n\n    }\n  }]\n}\n\n\n\n\nNote\n: it\ns possible to choose a git branch by passing it in the fragment\nlike this:\n\n\nPOST /konnectors/bank101-dev?Source=git://github.com/cozy/cozy-bank101.git%23dev HTTP/1.1\n\n\n\n\nPUT /konnectors/:slug\n\n\nUpdate a konnector source code with the specified slug name.\n\n\nThis endpoint is asynchronous and returns a successful return as soon as the\nkonnector installation has started, meaning we have successfully reached the\nmanifest and started to fetch konnector source code.\n\n\nTo make this endpoint synchronous, use the header \nAccept: text/event-stream\n.\nThis will make a eventsource stream sending the manifest and returning when the\nkonnector has been updated or failed.\n\n\nRequest\n\n\nPUT /konnectors/bank101 HTTP/1.1\nAccept: application/vnd.api+json\n\n\n\n\nResponse\n\n\nHTTP/1.1 202 Accepted\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: [{\n    \nid\n: \n4cfbd8be-8968-11e6-9708-ef55b7c20863\n,\n    \ntype\n: \nio.cozy.konnectors\n,\n    \nmeta\n: {\n      \nrev\n: \n1-7a1f918147df94580c92b47275e4604a\n\n    },\n    \nattributes\n: {\n      \nname\n: \nbank101\n,\n      \nstate\n: \ninstalling\n,\n      \nslug\n: \nbank101\n,\n      ...\n    },\n    \nlinks\n: {\n      \nself\n: \n/konnectors/bank101\n\n    }\n  }]\n}\n\n\n\n\nStatus codes\n\n\n\n\n202 Accepted, when the konnector installation has been accepted.\n\n\n400 Bad-Request, when the manifest of the konnector could not be processed\n  (for instance, it is not valid JSON).\n\n\n404 Not Found, when the konnector with the specified slug was not found or\n  when the manifest or the source of the konnector is not reachable.\n\n\n422 Unprocessable Entity, when the sent data is invalid (for example, the slug\n  is invalid or the Source parameter is not a proper or supported url)\n\n\n\n\nList installed konnectors\n\n\nGET /konnectors/\n\n\nRequest\n\n\nGET /konnectors/ HTTP/1.1\nAccept: application/vnd.api+json\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: [{\n    \nid\n: \n4cfbd8be-8968-11e6-9708-ef55b7c20863\n,\n    \ntype\n: \nio.cozy.konnectors\n,\n    \nmeta\n: {\n      \nrev\n: \n1-7a1f918147df94580c92b47275e4604a\n\n    },\n    \nattributes\n: {\n      \nname\n: \nbank101\n,\n      \nstate\n: \ninstalling\n,\n      \nslug\n: \nbank101\n,\n      ...\n    },\n    \nlinks\n: {\n      \nself\n: \n/konnectors/bank101\n\n    }\n  }]\n}\n\n\n\n\nGet informations about a konnector\n\n\nGET /konnectors/:slug\n\n\nUninstall a konnector\n\n\nDELETE /apps/:slug\n\n\nRequest\n\n\nDELETE /konnectors/bank101 HTTP/1.1\n\n\n\n\nResponse\n\n\nHTTP/1.1 204 No Content", 
            "title": "Konnectors"
        }, 
        {
            "location": "/cozy-stack/konnectors/#konnectors", 
            "text": "It is possible to manage konnectors applications from the stack. The source-code\nof the konnector is installed on the cozy and the user can manage its execution via  our  job system  and the  konnector worker .", 
            "title": "Konnectors"
        }, 
        {
            "location": "/cozy-stack/konnectors/#install-a-konnector", 
            "text": "", 
            "title": "Install a konnector"
        }, 
        {
            "location": "/cozy-stack/konnectors/#the-manifest", 
            "text": "Field  Description      name  the name to display on the home    slug  the default slug (it can be changed at install time)    editor  the editor s name to display on the cozy-bar of the app    type  the type of the konnector source ( node  is the only supported for now)    icon  an icon for the home    screenshots  an array of path to the screenshots of the application    category  the category of the application    short_description  a short description of the application    long_description  a long description of the application    source  where the files of the app can be downloaded    developer  name  and  url  for the developer    default_locale  the locale used for the name and description fields    locales  translations of the name and description fields in other locales    langs  list of languages tags supported by the application    version  the current version number    parameters  any json object that will be passed to the konnector on execution in the  COZY_PARAMETERS  environment variable    license  the SPDX license identifier    permissions  a map of permissions needed by the app (see  here  for more details)", 
            "title": "The manifest"
        }, 
        {
            "location": "/cozy-stack/konnectors/#post-konnectorsslug", 
            "text": "Install a konnector, ie download the files and put them in  /konnectors/:slug \nin the virtual file system of the user, create an  io.cozy.konnectors  document,\nregister the permissions, etc.  This endpoint is asynchronous and returns a successful return as soon as the\nkonnector installation has started, meaning we have successfully reached the\nmanifest and started to fetch konnector source code.  To make this endpoint synchronous, use the header  Accept: text/event-stream .\nThis will make a eventsource stream sending the manifest and returning when the\nkonnector has been installed or failed.", 
            "title": "POST /konnectors/:slug"
        }, 
        {
            "location": "/cozy-stack/konnectors/#status-codes", 
            "text": "202 Accepted, when the konnector installation has been accepted.  400 Bad-Request, when the manifest of the konnector could not be processed\n  (for instance, it is not valid JSON).  404 Not Found, when the manifest or the source of the konnector is not\n  reachable.  422 Unprocessable Entity, when the sent data is invalid (for example, the slug\n  is invalid or the Source parameter is not a proper or supported url)", 
            "title": "Status codes"
        }, 
        {
            "location": "/cozy-stack/konnectors/#query-string", 
            "text": "Parameter  Description      Source  URL from where the app can be downloaded (only for install)", 
            "title": "Query-String"
        }, 
        {
            "location": "/cozy-stack/konnectors/#request", 
            "text": "POST /konnectors/bank101?Source=git://github.com/cozy/cozy-bank101.git HTTP/1.1\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/konnectors/#response", 
            "text": "HTTP/1.1 202 Accepted\nContent-Type: application/vnd.api+json  {\n   data : [{\n     id :  4cfbd8be-8968-11e6-9708-ef55b7c20863 ,\n     type :  io.cozy.konnectors ,\n     meta : {\n       rev :  1-7a1f918147df94580c92b47275e4604a \n    },\n     attributes : {\n       name :  bank101 ,\n       state :  installing ,\n       slug :  bank101 ,\n      ...\n    },\n     links : {\n       self :  /konnectors/bank101 \n    }\n  }]\n}  Note : it s possible to choose a git branch by passing it in the fragment\nlike this:  POST /konnectors/bank101-dev?Source=git://github.com/cozy/cozy-bank101.git%23dev HTTP/1.1", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/konnectors/#put-konnectorsslug", 
            "text": "Update a konnector source code with the specified slug name.  This endpoint is asynchronous and returns a successful return as soon as the\nkonnector installation has started, meaning we have successfully reached the\nmanifest and started to fetch konnector source code.  To make this endpoint synchronous, use the header  Accept: text/event-stream .\nThis will make a eventsource stream sending the manifest and returning when the\nkonnector has been updated or failed.", 
            "title": "PUT /konnectors/:slug"
        }, 
        {
            "location": "/cozy-stack/konnectors/#request_1", 
            "text": "PUT /konnectors/bank101 HTTP/1.1\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/konnectors/#response_1", 
            "text": "HTTP/1.1 202 Accepted\nContent-Type: application/vnd.api+json  {\n   data : [{\n     id :  4cfbd8be-8968-11e6-9708-ef55b7c20863 ,\n     type :  io.cozy.konnectors ,\n     meta : {\n       rev :  1-7a1f918147df94580c92b47275e4604a \n    },\n     attributes : {\n       name :  bank101 ,\n       state :  installing ,\n       slug :  bank101 ,\n      ...\n    },\n     links : {\n       self :  /konnectors/bank101 \n    }\n  }]\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/konnectors/#status-codes_1", 
            "text": "202 Accepted, when the konnector installation has been accepted.  400 Bad-Request, when the manifest of the konnector could not be processed\n  (for instance, it is not valid JSON).  404 Not Found, when the konnector with the specified slug was not found or\n  when the manifest or the source of the konnector is not reachable.  422 Unprocessable Entity, when the sent data is invalid (for example, the slug\n  is invalid or the Source parameter is not a proper or supported url)", 
            "title": "Status codes"
        }, 
        {
            "location": "/cozy-stack/konnectors/#list-installed-konnectors", 
            "text": "", 
            "title": "List installed konnectors"
        }, 
        {
            "location": "/cozy-stack/konnectors/#get-konnectors", 
            "text": "", 
            "title": "GET /konnectors/"
        }, 
        {
            "location": "/cozy-stack/konnectors/#request_2", 
            "text": "GET /konnectors/ HTTP/1.1\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/konnectors/#response_2", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json  {\n   data : [{\n     id :  4cfbd8be-8968-11e6-9708-ef55b7c20863 ,\n     type :  io.cozy.konnectors ,\n     meta : {\n       rev :  1-7a1f918147df94580c92b47275e4604a \n    },\n     attributes : {\n       name :  bank101 ,\n       state :  installing ,\n       slug :  bank101 ,\n      ...\n    },\n     links : {\n       self :  /konnectors/bank101 \n    }\n  }]\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/konnectors/#get-informations-about-a-konnector", 
            "text": "", 
            "title": "Get informations about a konnector"
        }, 
        {
            "location": "/cozy-stack/konnectors/#get-konnectorsslug", 
            "text": "", 
            "title": "GET /konnectors/:slug"
        }, 
        {
            "location": "/cozy-stack/konnectors/#uninstall-a-konnector", 
            "text": "", 
            "title": "Uninstall a konnector"
        }, 
        {
            "location": "/cozy-stack/konnectors/#delete-appsslug", 
            "text": "", 
            "title": "DELETE /apps/:slug"
        }, 
        {
            "location": "/cozy-stack/konnectors/#request_3", 
            "text": "DELETE /konnectors/bank101 HTTP/1.1", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/konnectors/#response_3", 
            "text": "HTTP/1.1 204 No Content", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/workers/", 
            "text": "Table of contents\n\n\nWorkers\n\n\nThis page list all the currently available workers on the cozy-stack. It\ndescribes their input arguments object. See the \njobs document\n to\nknow more about the API context in which you can see how to use these\narguments.\n\n\nlog worker\n\n\nThe \nlog\n worker will just print in the log file the job sent to it. It can\nuseful for debugging for example.\n\n\npush worker\n\n\nThe \npush\n worker can be used to send push-notifications to a user\ns device.\nThe options are:\n\n\n\n\nclient_id\n: the ID of the oauth client to push a notification to.\n\n\ntitle\n: the title of the notification\n\n\nmessage\n: the content of the notification\n\n\ndata\n: key-value string map for additional metadata (optional)\n\n\npriority\n: the notification priority: \nhigh\n or \nnormal\n (optional)\n\n\ntopic\n: the topic identifier of the notification (optional)\n\n\nsound\n: a sound associated with the notification (optional)\n\n\n\n\nExample\n\n\n{\n  \nclient_id\n: \nabcdef123123123\n,\n  \ntitle\n: \nMy Notification\n,\n  \nmessage\n: \nMy notification content.\n,\n  \npriority\n: \nhigh\n\n}\n\n\n\n\nPermissions\n\n\nTo use this worker from a client-side application, you will need to ask the\npermission. It is done by adding this to the manifest:\n\n\n{\n  \npermissions\n: {\n    \npush-notification\n: {\n      \ndescription\n: \nRequired to send notifications\n,\n      \ntype\n: \nio.cozy.jobs\n,\n      \nverbs\n: [\nPOST\n],\n      \nselector\n: \nworker\n,\n      \nvalues\n: [\npush\n]\n    }\n  }\n}\n\n\n\n\nunzip worker\n\n\nThe \nunzip\n worker can take a zip archive from the VFS, and will unzip the\nfiles inside it to a directory of the VFS. The options are:\n\n\n\n\nzip\n: the ID of the zip file\n\n\ndestination\n: the ID of the directory where the files will be unzipped.\n\n\n\n\nExample\n\n\n{\n  \nzip\n: \n8737b5d6-51b6-11e7-9194-bf5b64b3bc9e\n,\n  \ndestination\n: \n88750a84-51b6-11e7-ba90-4f0b1cb62b7b\n\n}\n\n\n\n\nPermissions\n\n\nTo use this worker from a client-side application, you will need to ask the\npermission. It is done by adding this to the manifest:\n\n\n{\n  \npermissions\n: {\n    \nunzip-to-a-directory\n: {\n      \ndescription\n: \nRequired to unzip a file inside the cozy\n,\n      \ntype\n: \nio.cozy.jobs\n,\n      \nverbs\n: [\nPOST\n],\n      \nselector\n: \nworker\n,\n      \nvalues\n: [\nunzip\n]\n    }\n  }\n}\n\n\n\n\nsendmail worker\n\n\nThe \nsendmail\n worker can be used to send mail from the stack. It implies that\nthe stack has properly configured an access to an SMTP server. You can see an\nexample of configuration in the \ncozy.example.yaml\n file\nat the root of this repository.\n\n\nsendmail\n options fields are the following:\n\n\n\n\nmode\n: string specifying the mode of the send:\n\n\nnoreply\n to send a notification mail to the user\n\n\nfrom\n to send a mail from the user\n\n\nto\n: list of object \n{name, email}\n representing the addresses of the\n  recipients. (should not be used in \nnoreply\n mode)\n\n\nsubject\n: string specifying the subject of the mail\n\n\nparts\n: list of part objects \n{type, body}\n listing representing the content\n  parts of the\n\n\ntype\n string of the content type: either \ntext/html\n or \ntext/plain\n\n\nbody\n string of the actual body content of the part\n\n\nattachments\n: list of objects \n{filename, content}\n that represent the files\n  attached to the email\n\n\n\n\nExamples\n\n\n// from mode sending mail from the user to a list of recipients\n{\n    \nmode\n: \nfrom\n,\n    \nto\n: [\n        {\nname\n: \nJohn Doe 1\n, \nemail\n:\njohn1@doe\n},\n        {\nname\n: \nJohn Doe 2\n, \nemail\n:\njohn2@doe\n}\n    ],\n    \nsubject\n: \nHey !\n,\n    \nparts\n: [\n        {\ntype\n:\ntext/html\n, \nbody\n: \nh1\nHey !\n/h1\n},\n        {\ntype\n:\ntext/plain\n, \nbody\n: \nHey !\n}\n    ]\n}\n\n// noreply mode, sending a notification mail to the user\n{\n    \nmode\n: \nnoreply\n,\n    \nsubject\n: \nYou've got a new file !\n,\n    \nparts\n: [\n        {\ntype\n:\ntext/html\n, \nbody\n: \nh1\nHey !\n/h1\n},\n        {\ntype\n:\ntext/plain\n, \nbody\n: \nHey !\n}\n    ]\n}\n\n\n\n\nPermissions\n\n\nTo use this worker from a client-side application, you will need to ask the\npermission. It is done by adding this to the manifest:\n\n\n{\n  \npermissions\n: {\n    \nmail-from-the-user\n: {\n      \ndescription\n: \nRequired to send mails from the user to his/her friends\n,\n      \ntype\n: \nio.cozy.jobs\n,\n      \nverbs\n: [\nPOST\n],\n      \nselector\n: \nworker\n,\n      \nvalues\n: [\nsendmail\n]\n    }\n  }\n}", 
            "title": "Workers"
        }, 
        {
            "location": "/cozy-stack/workers/#workers", 
            "text": "This page list all the currently available workers on the cozy-stack. It\ndescribes their input arguments object. See the  jobs document  to\nknow more about the API context in which you can see how to use these\narguments.", 
            "title": "Workers"
        }, 
        {
            "location": "/cozy-stack/workers/#log-worker", 
            "text": "The  log  worker will just print in the log file the job sent to it. It can\nuseful for debugging for example.", 
            "title": "log worker"
        }, 
        {
            "location": "/cozy-stack/workers/#push-worker", 
            "text": "The  push  worker can be used to send push-notifications to a user s device.\nThe options are:   client_id : the ID of the oauth client to push a notification to.  title : the title of the notification  message : the content of the notification  data : key-value string map for additional metadata (optional)  priority : the notification priority:  high  or  normal  (optional)  topic : the topic identifier of the notification (optional)  sound : a sound associated with the notification (optional)", 
            "title": "push worker"
        }, 
        {
            "location": "/cozy-stack/workers/#example", 
            "text": "{\n   client_id :  abcdef123123123 ,\n   title :  My Notification ,\n   message :  My notification content. ,\n   priority :  high \n}", 
            "title": "Example"
        }, 
        {
            "location": "/cozy-stack/workers/#permissions", 
            "text": "To use this worker from a client-side application, you will need to ask the\npermission. It is done by adding this to the manifest:  {\n   permissions : {\n     push-notification : {\n       description :  Required to send notifications ,\n       type :  io.cozy.jobs ,\n       verbs : [ POST ],\n       selector :  worker ,\n       values : [ push ]\n    }\n  }\n}", 
            "title": "Permissions"
        }, 
        {
            "location": "/cozy-stack/workers/#unzip-worker", 
            "text": "The  unzip  worker can take a zip archive from the VFS, and will unzip the\nfiles inside it to a directory of the VFS. The options are:   zip : the ID of the zip file  destination : the ID of the directory where the files will be unzipped.", 
            "title": "unzip worker"
        }, 
        {
            "location": "/cozy-stack/workers/#example_1", 
            "text": "{\n   zip :  8737b5d6-51b6-11e7-9194-bf5b64b3bc9e ,\n   destination :  88750a84-51b6-11e7-ba90-4f0b1cb62b7b \n}", 
            "title": "Example"
        }, 
        {
            "location": "/cozy-stack/workers/#permissions_1", 
            "text": "To use this worker from a client-side application, you will need to ask the\npermission. It is done by adding this to the manifest:  {\n   permissions : {\n     unzip-to-a-directory : {\n       description :  Required to unzip a file inside the cozy ,\n       type :  io.cozy.jobs ,\n       verbs : [ POST ],\n       selector :  worker ,\n       values : [ unzip ]\n    }\n  }\n}", 
            "title": "Permissions"
        }, 
        {
            "location": "/cozy-stack/workers/#sendmail-worker", 
            "text": "The  sendmail  worker can be used to send mail from the stack. It implies that\nthe stack has properly configured an access to an SMTP server. You can see an\nexample of configuration in the  cozy.example.yaml  file\nat the root of this repository.  sendmail  options fields are the following:   mode : string specifying the mode of the send:  noreply  to send a notification mail to the user  from  to send a mail from the user  to : list of object  {name, email}  representing the addresses of the\n  recipients. (should not be used in  noreply  mode)  subject : string specifying the subject of the mail  parts : list of part objects  {type, body}  listing representing the content\n  parts of the  type  string of the content type: either  text/html  or  text/plain  body  string of the actual body content of the part  attachments : list of objects  {filename, content}  that represent the files\n  attached to the email", 
            "title": "sendmail worker"
        }, 
        {
            "location": "/cozy-stack/workers/#examples", 
            "text": "// from mode sending mail from the user to a list of recipients\n{\n     mode :  from ,\n     to : [\n        { name :  John Doe 1 ,  email : john1@doe },\n        { name :  John Doe 2 ,  email : john2@doe }\n    ],\n     subject :  Hey ! ,\n     parts : [\n        { type : text/html ,  body :  h1 Hey ! /h1 },\n        { type : text/plain ,  body :  Hey ! }\n    ]\n}\n\n// noreply mode, sending a notification mail to the user\n{\n     mode :  noreply ,\n     subject :  You've got a new file ! ,\n     parts : [\n        { type : text/html ,  body :  h1 Hey ! /h1 },\n        { type : text/plain ,  body :  Hey ! }\n    ]\n}", 
            "title": "Examples"
        }, 
        {
            "location": "/cozy-stack/workers/#permissions_2", 
            "text": "To use this worker from a client-side application, you will need to ask the\npermission. It is done by adding this to the manifest:  {\n   permissions : {\n     mail-from-the-user : {\n       description :  Required to send mails from the user to his/her friends ,\n       type :  io.cozy.jobs ,\n       verbs : [ POST ],\n       selector :  worker ,\n       values : [ sendmail ]\n    }\n  }\n}", 
            "title": "Permissions"
        }, 
        {
            "location": "/cozy-stack/notifications/", 
            "text": "Table of contents\n\n\nNotifications\n\n\nCozy applications can send notifications to the user, in order to alert or\nnotify for services message or state change that could be of interest to the\nuser, in an asynchronous manner.\n\n\nThese notifications are part of a \nNotification Center\n where the user can\nconfigure the behavior of these notifications and the channel in which they\nare sent.\n\n\nDeclare application\ns notifications\n\n\nEach application have to declare in its manifest the notifications it needs to\nsend. The \nnotifications\n fields of the manifest can be used to define all\nthese notifications, with the following properties:\n\n\n\n\ncollapsible\n (boolean): defines a notification category for which only\n  the last value is of interest to the user. For instance, a account-balance\n  quota for a user\ns bank account: such notification is only useful as its\n  last value.\n\n\nstateful\n (boolean): defines a notification storing a piece of state: for\n  each new notification, the stack will check that the last sent\n  notification has a different state.\n\n\nmultiple\n (boolean): specify the possibility for a notification to have\n  different sub-categories, defined by a programmable/dynamic identifier.\n  \ncollapsible\n and \nstateful\n properties are inherited for each sub-\n  categories.\n\n\ndefault_priority\n: default priority to use, with values \nhigh\n or\n  \nnormal\n. This is propagated to the underlying mobile notifications\n  system.\n\n\ntemplates\n: a link list to templates file contained in the application folder that can be used to write the content of the notification, depending on the communication channel.\n\n\n\n\nIn this documentation, we take the example of an application with the following notification:\n\n\n{\n  \nnotifications\n: {\n    \naccount-balance\n: {\n      \ndescription\n: \nAlert the user when its account balance is negative\n,\n      \ncollapsible\n: true, // only interested in the last value of the notification\n      \nmultiple\n: true, // require sub-categories for each account\n      \nstateful\n: true, // piece of state to distinguish notifications\n      \ndefault_priority\n: \nhigh\n, // high priority for this notification\n      \ntemplates\n: {\n        \nmail\n: \nfile:./notifications/account-balance-mail.tpl\n\n      }\n    }\n  }\n}\n\n\n\n\nCreating a notification\n\n\nPOST /notifications\n\n\nThis endpoint can be used to push a new notification to the user.\n\n\nNotifications fields are:\n\n\n\n\ncategory\n (string): name of the notification category\n\n\ncategory_id\n (string): category name if the category is multiple\n\n\ntitle\n (string): title of the notification (optionnal)\n\n\nmessage\n (string): message of of the notification (optionnal)\n\n\npriority\n (string): priority of the notification (\nhigh\n or \nnormal\n),\n  sent to the underlying channel to prioritize the notification\n\n\nstate\n (string): state of the notification, used for \nstateful\n\n  notification categories, to distinguish notifications\n\n\npreferred_channels\n (array of string): to select a list of preferred\n  channels for this notification: either \n\"mobile\"\n or \n\"mail\"\n. The stack\n  may chose another channels.\n\n\ndata\n (map): key/value map used to create the notification from its\n  template, or sent in the notification payload for mobiles\n\n\n\n\nRequest\n\n\nPOST /notifications HTTP/1.1\nHost: alice.cozy.tools\nAuthorization: Bearer ...\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \nattributes\n: {\n      \ncategory\n: \naccount-balance\n,\n      \ncategory_id\n: \nmy-bank\n,\n      \ntitle\n: \nYour account balance is not OK\n,\n      \nmessage\n: \nWarning: we have detected a negative balance in your my-bank\n,\n      \npriority\n: \nhigh\n,\n      \nstate\n: \n-1\n,\n      \npreferred_channels\n: [\nmobile\n],\n      \ndata\n: {\n        \nkey1\n: \nvalue1\n,\n        \nkey2\n: \nvalue2\n\n      }\n    }\n  }\n}\n\n\n\n\nResponse\n\n\nHTTP/1.1 201 Created\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.notifications\n,\n    \nid\n: \nc57a548c-7602-11e7-933b-6f27603d27da\n,\n    \nmeta\n: {\n      \nrev\n: \n1-1f2903f9a867\n\n    },\n    \nattributes\n: {\n      \nsource_id\n: \ncozy/app/bank/account-balance/my-bank\n,\n      \noriginator\n: \napp\n,\n      \nslug\n: \nbank\n,\n      \ncategory\n: \naccount-balance\n,\n      \ncategory_id\n: \nmy-bank\n,\n      \ntitle\n: \nYour account balance is not OK\n,\n      \nmessage\n: \nWarning: we have detected a negative balance in your my-bank\n,\n      \npriority\n: \nhigh\n,\n      \nstate\n: \n-1\n,\n      \ndata\n: {\n        \nkey1\n: \nvalue1\n,\n        \nkey2\n: \nvalue2\n\n      }\n    }\n  }\n}", 
            "title": "/notifications - Notifications"
        }, 
        {
            "location": "/cozy-stack/notifications/#notifications", 
            "text": "Cozy applications can send notifications to the user, in order to alert or\nnotify for services message or state change that could be of interest to the\nuser, in an asynchronous manner.  These notifications are part of a  Notification Center  where the user can\nconfigure the behavior of these notifications and the channel in which they\nare sent.", 
            "title": "Notifications"
        }, 
        {
            "location": "/cozy-stack/notifications/#declare-applications-notifications", 
            "text": "Each application have to declare in its manifest the notifications it needs to\nsend. The  notifications  fields of the manifest can be used to define all\nthese notifications, with the following properties:   collapsible  (boolean): defines a notification category for which only\n  the last value is of interest to the user. For instance, a account-balance\n  quota for a user s bank account: such notification is only useful as its\n  last value.  stateful  (boolean): defines a notification storing a piece of state: for\n  each new notification, the stack will check that the last sent\n  notification has a different state.  multiple  (boolean): specify the possibility for a notification to have\n  different sub-categories, defined by a programmable/dynamic identifier.\n   collapsible  and  stateful  properties are inherited for each sub-\n  categories.  default_priority : default priority to use, with values  high  or\n   normal . This is propagated to the underlying mobile notifications\n  system.  templates : a link list to templates file contained in the application folder that can be used to write the content of the notification, depending on the communication channel.   In this documentation, we take the example of an application with the following notification:  {\n   notifications : {\n     account-balance : {\n       description :  Alert the user when its account balance is negative ,\n       collapsible : true, // only interested in the last value of the notification\n       multiple : true, // require sub-categories for each account\n       stateful : true, // piece of state to distinguish notifications\n       default_priority :  high , // high priority for this notification\n       templates : {\n         mail :  file:./notifications/account-balance-mail.tpl \n      }\n    }\n  }\n}", 
            "title": "Declare application's notifications"
        }, 
        {
            "location": "/cozy-stack/notifications/#creating-a-notification", 
            "text": "", 
            "title": "Creating a notification"
        }, 
        {
            "location": "/cozy-stack/notifications/#post-notifications", 
            "text": "This endpoint can be used to push a new notification to the user.  Notifications fields are:   category  (string): name of the notification category  category_id  (string): category name if the category is multiple  title  (string): title of the notification (optionnal)  message  (string): message of of the notification (optionnal)  priority  (string): priority of the notification ( high  or  normal ),\n  sent to the underlying channel to prioritize the notification  state  (string): state of the notification, used for  stateful \n  notification categories, to distinguish notifications  preferred_channels  (array of string): to select a list of preferred\n  channels for this notification: either  \"mobile\"  or  \"mail\" . The stack\n  may chose another channels.  data  (map): key/value map used to create the notification from its\n  template, or sent in the notification payload for mobiles", 
            "title": "POST /notifications"
        }, 
        {
            "location": "/cozy-stack/notifications/#request", 
            "text": "POST /notifications HTTP/1.1\nHost: alice.cozy.tools\nAuthorization: Bearer ...\nContent-Type: application/vnd.api+json  {\n   data : {\n     attributes : {\n       category :  account-balance ,\n       category_id :  my-bank ,\n       title :  Your account balance is not OK ,\n       message :  Warning: we have detected a negative balance in your my-bank ,\n       priority :  high ,\n       state :  -1 ,\n       preferred_channels : [ mobile ],\n       data : {\n         key1 :  value1 ,\n         key2 :  value2 \n      }\n    }\n  }\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/notifications/#response", 
            "text": "HTTP/1.1 201 Created\nContent-Type: application/vnd.api+json  {\n   data : {\n     type :  io.cozy.notifications ,\n     id :  c57a548c-7602-11e7-933b-6f27603d27da ,\n     meta : {\n       rev :  1-1f2903f9a867 \n    },\n     attributes : {\n       source_id :  cozy/app/bank/account-balance/my-bank ,\n       originator :  app ,\n       slug :  bank ,\n       category :  account-balance ,\n       category_id :  my-bank ,\n       title :  Your account balance is not OK ,\n       message :  Warning: we have detected a negative balance in your my-bank ,\n       priority :  high ,\n       state :  -1 ,\n       data : {\n         key1 :  value1 ,\n         key2 :  value2 \n      }\n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/permissions/", 
            "text": "Table of contents\n\n\nPermissions\n\n\nWhen the permissions are used?\n\n\nThe permissions are used when a request is made to cozy stack. It allows to let\nthe owner of the cozy instance controls the access to her data, files and\nactions on them. The permissions are given in several contexts. Let\ns see them!\n\n\nClient-side apps\n\n\nWhen the user installs a new client-side app, she is asked to accept an initial\nset of permissions for this app. This set of permissions is described in the\nmanifest of the app.\n\n\nLater, the application can gain more permissions via the \nintents\n\nand optional permissions. See below for more details.\n\n\nWhen the authentified user access a client-side app, the app receives a token\nfrom the stack that can be used in later requests to the stack as a proof of the\npermissions it owns.\n\n\nExternal apps via OAuth2\n\n\nAn external application can ask for permissions via the OAuth2 dance, and use\nthem later with the access token. The permissions are in the \nscope\n parameter.\n\n\nSharing with other users\n\n\nThe owner of a cozy instance can share some documents and files with other\nusers. It can be done in two ways:\n\n\n\n\nIf the other user also has a cozy, it can be a cozy-to-cozy sharing.\n\n\nElse, the owner can give to him a link with a code.\n\n\n\n\nWhat is a permission?\n\n\nA permission gives the right for a request having it to do something on the\nstack. It is defined by four components.\n\n\nType\n\n\ntype\n is the attribute used in JSON-API or the \ndocType\n for the Data System.\n\n\nIt is the only mandatory component. If just the \ntype\n is specified, it gives\naccess to all the operations on this \ntype\n. For example, a permission on type\n\nio.cozy.contacts\n gives the right to create, read, update and delete any\ncontact, and to fetch all the contacts. A permission on type \nio.cozy.files\n\nallow to access and modify any file or directory.\n\n\nSome known types:\n\n\n\n\nio.cozy.files\n, for files and folder in the \nVFS\n\n\nio.cozy.apps\n, for \napps\n\n\nio.cozy.settings\n, for the \nsettings\n\n\nio.cozy.jobs\n and \nio.cozy.triggers\n, for \njobs\n\n\nio.cozy.oauth.clients\n, to list and revoke \nOAuth 2 clients\n\n\n\n\nVerbs\n\n\nIt says which HTTP verbs can be used for requests to the cozy-stack. \nGET\n will\ngive read-only access, \nDELETE\n can be used for deletions, etc. Verbs should be\ndeclared in a list, like \n[\"GET\", \"POST\", \"DELETE\"]\n, and use \n[\"ALL\"]\n as a\nshortcut for \n[\"GET\", \"POST\", \"PUT\", \"PATCH\", \"DELETE\"]\n (it is the default).\n\n\nNote\n: \nHEAD\n is implicitely implied when \nGET\n is allowed. \nOPTIONS\n for\nCross-Origin Resources Sharing is always allowed, the stack does not have the\ninformations about the permission when it answers the request.\n\n\nValues\n\n\nIt\ns possible to restrict the permissions to only some documents of a docType,\nor to just some files and folders. You can give a list of ids in \nvalues\n.\n\n\nNote\n: a permission for a folder also gives permissions with same verbs for\nfiles and folders inside it.\n\n\nSelector\n\n\nBy default, the \nvalues\n are checked with the \nid\n. But it\ns possible to use a\n\nselector\n to filter on another \nfield\n. In particular, it can be used for\nsharing. A user may share a calendar and all the events inside it. It will be\ndone with two permissions. The first one is for the calendar:\n\n\n{\n  \ntype\n: \nio.cozy.calendars\n,\n  \nverbs\n: [\nGET\n],\n  \nvalues\n: [\n1355812c-d41e-11e6-8467-53be4648e3ad\n]\n}\n\n\n\n\nAnd the other is for the events inside the calendar:\n\n\n{\n  \ntype\n: \nio.cozy.events\n,\n  \nverbs\n: [\nGET\n],\n  \nselector\n: \ncalendar-id\n,\n  \nvalues\n: [\n1355812c-d41e-11e6-8467-53be4648e3ad\n]\n}\n\n\n\n\nWhat format for a permission?\n\n\nJSON\n\n\nThe prefered format for permissions is JSON. Each permission is a map with the\n\ntype\n, \nverbs\n, \nvalues\n and \nselector\n see above, plus a \ndescription\n that\ncan be used to give more informations to the user. Only the \ntype\n field is\nmandatory.\n\n\nIn the manifest, the permissions are regrouped in a map. The key is not very\nrelevant, it\ns just here for localization. The same key is used in the \nlocales\n\nfield to identify the permission.\n\n\nExample:\n\n\n{\n  \npermissions\n: {\n    \ncontacts\n: {\n      \ndescription\n: \nRequired for autocompletion on @name\n,\n      \ntype\n: \nio.cozy.contacts\n,\n      \nverbs\n: [\nGET\n]\n    },\n    \nimages\n: {\n      \ndescription\n: \nRequired for the background\n,\n      \ntype\n: \nio.cozy.files\n,\n      \nverbs\n: [\nGET\n, \nPOST\n],\n      \nvalues\n: [\nio.cozy.files.music-dir\n]\n    },\n    \nmail\n: {\n      \ndescription\n: \nRequired to send a congratulations email to your friends\n,\n      \ntype\n: \nio.cozy.jobs\n,\n      \nselector\n: \nworker\n,\n      \nvalues\n: [\nsendmail\n]\n    }\n  }\n}\n\n\n\n\nInline\n\n\nOAuth2 as a \nscope\n parameter for defining the permissions given to the\napplication. But it\ns only a string, not a JSON. In that case, we use a space\ndelimited list of permissions, each permission is written compactly with \n:\n\nbetween the components.\n\n\nExample:\n\n\nio.cozy.contacts io.cozy.files:GET:io.cozy.files.music-dir io.cozy.jobs:POST:sendmail:worker\n\n\n\n\nNote\n: the \nverbs\n component can\nt be omitted when the \nvalues\n and\n\nselector\n are used.\n\n\nInspiration\n\n\n\n\nAccess control on other similar platforms\n\n\n\n\nRoutes\n\n\nGET /permissions/self\n\n\nList the permissions for a given token\n\n\nRequest\n\n\nGET /permissions/self HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ\nAccept: application/vnd.api+json\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.permissions\n,\n    \nid\n: \n5a9c1844-d427-11e6-ab36-2b684d437b0d\n,\n    \nattributes\n: {\n      \ntype\n: \napp\n,\n      \nsource_id\n: \nio.cozy.apps/my-awesome-game\n,\n      \npermissions\n: {\n        \ncontacts\n: {\n          \ndescription\n: \nRequired for autocompletion on @name\n,\n          \ntype\n: \nio.cozy.contacts\n,\n          \nverbs\n: [\nGET\n]\n        },\n        \nimages\n: {\n          \ndescription\n: \nRequired for the background\n,\n          \ntype\n: \nio.cozy.files\n,\n          \nverbs\n: [\nGET\n],\n          \nvalues\n: [\nio.cozy.files.music-dir\n]\n        },\n        \nmail\n: {\n          \ndescription\n:\n            \nRequired to send a congratulations email to your friends\n,\n          \ntype\n: \nio.cozy.jobs\n,\n          \nselector\n: \nworker\n,\n          \nvalues\n: [\nsendmail\n]\n        }\n      }\n    }\n  }\n}\n\n\n\n\nPOST /permissions\n\n\nCreate a new set of permissions. It can also associates one or more codes to it,\nvia the \ncodes\n parameter in the query string. These codes can then be sent to\nother people as a way to give these permissions (sharing by links). The\nparameter is comma separed list of values. The role of these values is to\nidentify the codes if you want to revoke some of them later. A \nttl\n parameter\ncan also be given to make the codes expires after a delay (\nbigduration\nformat\n).\n\n\nNote\n: it is only possible to create a strict subset of the permissions\nassociated to the sent token.\n\n\nRequest\n\n\nPOST /permissions?codes=bob,jane\nttl=1D HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.permissions\n,\n    \nattributes\n: {\n      \nsource_id\n: \nio.cozy.apps/my-awesome-game\n,\n      \npermissions\n: {\n        \nimages\n: {\n          \ntype\n: \nio.cozy.files\n,\n          \nverbs\n: [\nGET\n],\n          \nvalues\n: [\nio.cozy.files.music-dir\n]\n        }\n      }\n    }\n  }\n}\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \nid\n: \na340d5e0-d647-11e6-b66c-5fc9ce1e17c6\n,\n    \ntype\n: \nio.cozy.permissions\n,\n    \nattributes\n: {\n      \ntype\n: \nshare\n,\n      \nsource_id\n: \nio.cozy.apps/my-awesome-game\n,\n      \ncodes\n: {\n        \nbob\n: \nyuot7NaiaeGugh8T\n,\n        \njane\n: \nYohyoo8BHahh1lie\n\n      },\n      \nexpires_at\n: 1483951978,\n      \npermissions\n: {\n        \nimages\n: {\n          \ntype\n: \nio.cozy.files\n,\n          \nverbs\n: [\nGET\n],\n          \nvalues\n: [\nio.cozy.files.music-dir\n]\n        }\n      }\n    }\n  }\n}\n\n\n\n\nGET /permissions/:id\n\n\nReturn the informations about a set of permissions\n\n\nRequest\n\n\nGET /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ\nAccept: application/vnd.api+json\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \nid\n: \na340d5e0-d647-11e6-b66c-5fc9ce1e17c6\n,\n    \ntype\n: \nio.cozy.permissions\n,\n    \nattributes\n: {\n      \ntype\n: \nshare\n,\n      \nsource_id\n: \nio.cozy.apps/my-awesome-game\n,\n      \ncodes\n: {\n        \nbob\n: \nyuot7NaiaeGugh8T\n,\n        \njane\n: \nYohyoo8BHahh1lie\n\n      },\n      \nexpires_at\n: 1483951978,\n      \npermissions\n: {\n        \nimages\n: {\n          \ntype\n: \nio.cozy.files\n,\n          \nverbs\n: [\nGET\n],\n          \nvalues\n: [\nio.cozy.files.music-dir\n]\n        }\n      }\n    }\n  }\n}\n\n\n\n\nPATCH /permissions/:id\n\n\nAdd permissions in this permissions set. It can be used in inter-apps context as\na way to give another app the permission for some data. For example, the contact\napplication can send a \npick a photo\n intent to the photos application with\nits permission id, and the photos app can then let the user choose a photo and\ngive the contacts application the permissions to use it.\n\n\nIt can also be used to add or remove codes.\n\n\nRequest to add / remove codes\n\n\nPATCH /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \nid\n: \na340d5e0-d647-11e6-b66c-5fc9ce1e17c6\n,\n    \ntype\n: \nio.cozy.permissions\n,\n    \nattributes\n: {\n      \ncodes\n: {\n        \njane\n: \nYohyoo8BHahh1lie\n\n      }\n    }\n  }\n}\n\n\n\n\nRequest to add permissions\n\n\nPATCH /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \nid\n: \na340d5e0-d647-11e6-b66c-5fc9ce1e17c6\n,\n    \ntype\n: \nio.cozy.permissions\n,\n    \npermissions\n: {\n      \nadd-this\n: {\n        \ntype\n: \nio.cozy.files\n,\n        \nverbs\n: [\nGET\n],\n        \nvalues\n: [\nsome-picture-id\n]\n      }\n    }\n  }\n}\n\n\n\n\nRequest to remove permissions\n\n\nPATCH /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \nid\n: \na340d5e0-d647-11e6-b66c-5fc9ce1e17c6\n,\n    \ntype\n: \nio.cozy.permissions\n,\n    \npermissions\n: {\n      \nremove-this\n: {}\n    }\n  }\n}\n\n\n\n\nReponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \nid\n: \na340d5e0-d647-11e6-b66c-5fc9ce1e17c6\n,\n    \ntype\n: \nio.cozy.permissions\n,\n    \nattributes\n: {\n      \ntype\n: \nshare\n,\n      \nsource_id\n: \nio.cozy.apps/my-awesome-game\n,\n      \ncodes\n: {\n        \nbob\n: \nyuot7NaiaeGugh8T\n\n      },\n      \nexpires_at\n: 1483951978,\n      \npermissions\n: {\n        \nimages\n: {\n          \ntype\n: \nio.cozy.files\n,\n          \nverbs\n: [\nGET\n],\n          \nvalues\n: [\nio.cozy.files.music-dir\n]\n        }\n      }\n    }\n  }\n}\n\n\n\n\nDELETE /permissions/:id\n\n\nDelete a set of permissions. For example, some permissions were used by a user\nto share a photo album with her friends, and then she changed her mind and\ncancel the sharing.\n\n\nRequest\n\n\nDELETE /permissions/fa11561c-d645-11e6-83df-cbf577804d55 HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ\n\n\n\n\nReponse\n\n\nHTTP/1.1 204 No Content\n\n\n\n\nPOST /permissions/exists\n\n\nList permissions for some documents\n\n\nRequest\n\n\nPOST /permissions/exists HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: [\n    { \ntype\n: \nio.cozy.files\n, \nid\n: \n94375086-e2e2-11e6-81b9-5bc0b9dd4aa4\n }\n    { \ntype\n: \nio.cozy.files\n, \nid\n: \n4cfbd8be-8968-11e6-9708-ef55b7c20863\n }\n    { \ntype\n: \nio.cozy.files\n, \nid\n: \na340d5e0-d647-11e6-b66c-5fc9ce1e17c6\n }\n    { \ntype\n: \nio.cozy.files\n, \nid\n: \n94375086-e2e2-11e6-81b9-5bc0b9dd4aa4\n }\n  ]\n}\n\n\n\n\nReponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: [\n    { \ntype\n: \nio.cozy.files\n, \nid\n: \n94375086-e2e2-11e6-81b9-5bc0b9dd4aa4\n,\n      \nverbs\n:[\nGET\n] }\n    { \ntype\n: \nio.cozy.files\n, \nid\n: \na340d5e0-d647-11e6-b66c-5fc9ce1e17c6\n,\n      \nverbs\n:[\nGET\n, \nPOST\n] }\n  ]\n}\n\n\n\n\nPATCH /permissions/apps/:slug\n\n\nAdd permissions or remove permissions to the web application with specified\nslug. It behaves like the \nPATCH /permissions/:id\n route. See this route for\nmore examples.\n\n\nPATCH /permissions/konnectors/:slug\n\n\nAdd permissions or remove permissions to the konnector with specified slug. It\nbehaves like the \nPATCH /permissions/:id\n route. See this route for more\nexamples.\n\n\nGET /permissions/doctype/:doctype/shared-by-link\n\n\nList permissions for a doctype that are used for a \nshare by links\n\n\nRequest\n\n\nGET /permissions/doctype/io.cozy.events/shared-by-link HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json\n\n\n\n\nReponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: [\n    {\n      \ntype\n: \nio.cozy.permissions\n,\n      \nid\n: \nc47f82396d09bfcd270343c5855b30a0\n,\n      \nattributes\n: {\n        \ntype\n: \nshare\n,\n        \npermissions\n: {\n          \nrule0\n: {\n            \ntype\n: \nio.cozy.events\n,\n            \nverbs\n: [\nPATCH\n, \nDELETE\n],\n            \nvalues\n: [\nc47f82396d09bfcd270343c5855b0eea\n]\n          }\n        },\n        \ncodes\n: { \nbob\n: \nsecret\n }\n      },\n      \nmeta\n: { \nrev\n: \n1-d46b6358683b80c8d59fc55d6de54127\n },\n      \nlinks\n: { \nself\n: \n/permissions/c47f82396d09bfcd270343c5855b30a0\n }\n    },\n    {\n      \ntype\n: \nio.cozy.permissions\n,\n      \nid\n: \nc47f82396d09bfcd270343c5855b351a\n,\n      \nattributes\n: {\n        \ntype\n: \nshare\n,\n        \npermissions\n: {\n          \nrule0\n: {\n            \ntype\n: \nio.cozy.events\n,\n            \nverbs\n: [\nGET\n],\n            \nvalues\n: [\nc47f82396d09bfcd270343c5855b169b\n]\n          }\n        },\n        \ncodes\n: { \nbob\n: \nsecret\n }\n      },\n      \nmeta\n: { \nrev\n: \n1-920af658575a56e9e84685f1b09e5c23\n },\n      \nlinks\n: { \nself\n: \n/permissions/c47f82396d09bfcd270343c5855b351a\n }\n    }\n  ]\n}\n\n\n\n\nPermissions required : GET on the whole doctype", 
            "title": "/permissions - Permissions"
        }, 
        {
            "location": "/cozy-stack/permissions/#permissions", 
            "text": "", 
            "title": "Permissions"
        }, 
        {
            "location": "/cozy-stack/permissions/#when-the-permissions-are-used", 
            "text": "The permissions are used when a request is made to cozy stack. It allows to let\nthe owner of the cozy instance controls the access to her data, files and\nactions on them. The permissions are given in several contexts. Let s see them!", 
            "title": "When the permissions are used?"
        }, 
        {
            "location": "/cozy-stack/permissions/#client-side-apps", 
            "text": "When the user installs a new client-side app, she is asked to accept an initial\nset of permissions for this app. This set of permissions is described in the\nmanifest of the app.  Later, the application can gain more permissions via the  intents \nand optional permissions. See below for more details.  When the authentified user access a client-side app, the app receives a token\nfrom the stack that can be used in later requests to the stack as a proof of the\npermissions it owns.", 
            "title": "Client-side apps"
        }, 
        {
            "location": "/cozy-stack/permissions/#external-apps-via-oauth2", 
            "text": "An external application can ask for permissions via the OAuth2 dance, and use\nthem later with the access token. The permissions are in the  scope  parameter.", 
            "title": "External apps via OAuth2"
        }, 
        {
            "location": "/cozy-stack/permissions/#sharing-with-other-users", 
            "text": "The owner of a cozy instance can share some documents and files with other\nusers. It can be done in two ways:   If the other user also has a cozy, it can be a cozy-to-cozy sharing.  Else, the owner can give to him a link with a code.", 
            "title": "Sharing with other users"
        }, 
        {
            "location": "/cozy-stack/permissions/#what-is-a-permission", 
            "text": "A permission gives the right for a request having it to do something on the\nstack. It is defined by four components.", 
            "title": "What is a permission?"
        }, 
        {
            "location": "/cozy-stack/permissions/#type", 
            "text": "type  is the attribute used in JSON-API or the  docType  for the Data System.  It is the only mandatory component. If just the  type  is specified, it gives\naccess to all the operations on this  type . For example, a permission on type io.cozy.contacts  gives the right to create, read, update and delete any\ncontact, and to fetch all the contacts. A permission on type  io.cozy.files \nallow to access and modify any file or directory.  Some known types:   io.cozy.files , for files and folder in the  VFS  io.cozy.apps , for  apps  io.cozy.settings , for the  settings  io.cozy.jobs  and  io.cozy.triggers , for  jobs  io.cozy.oauth.clients , to list and revoke  OAuth 2 clients", 
            "title": "Type"
        }, 
        {
            "location": "/cozy-stack/permissions/#verbs", 
            "text": "It says which HTTP verbs can be used for requests to the cozy-stack.  GET  will\ngive read-only access,  DELETE  can be used for deletions, etc. Verbs should be\ndeclared in a list, like  [\"GET\", \"POST\", \"DELETE\"] , and use  [\"ALL\"]  as a\nshortcut for  [\"GET\", \"POST\", \"PUT\", \"PATCH\", \"DELETE\"]  (it is the default).  Note :  HEAD  is implicitely implied when  GET  is allowed.  OPTIONS  for\nCross-Origin Resources Sharing is always allowed, the stack does not have the\ninformations about the permission when it answers the request.", 
            "title": "Verbs"
        }, 
        {
            "location": "/cozy-stack/permissions/#values", 
            "text": "It s possible to restrict the permissions to only some documents of a docType,\nor to just some files and folders. You can give a list of ids in  values .  Note : a permission for a folder also gives permissions with same verbs for\nfiles and folders inside it.", 
            "title": "Values"
        }, 
        {
            "location": "/cozy-stack/permissions/#selector", 
            "text": "By default, the  values  are checked with the  id . But it s possible to use a selector  to filter on another  field . In particular, it can be used for\nsharing. A user may share a calendar and all the events inside it. It will be\ndone with two permissions. The first one is for the calendar:  {\n   type :  io.cozy.calendars ,\n   verbs : [ GET ],\n   values : [ 1355812c-d41e-11e6-8467-53be4648e3ad ]\n}  And the other is for the events inside the calendar:  {\n   type :  io.cozy.events ,\n   verbs : [ GET ],\n   selector :  calendar-id ,\n   values : [ 1355812c-d41e-11e6-8467-53be4648e3ad ]\n}", 
            "title": "Selector"
        }, 
        {
            "location": "/cozy-stack/permissions/#what-format-for-a-permission", 
            "text": "", 
            "title": "What format for a permission?"
        }, 
        {
            "location": "/cozy-stack/permissions/#json", 
            "text": "The prefered format for permissions is JSON. Each permission is a map with the type ,  verbs ,  values  and  selector  see above, plus a  description  that\ncan be used to give more informations to the user. Only the  type  field is\nmandatory.  In the manifest, the permissions are regrouped in a map. The key is not very\nrelevant, it s just here for localization. The same key is used in the  locales \nfield to identify the permission.  Example:  {\n   permissions : {\n     contacts : {\n       description :  Required for autocompletion on @name ,\n       type :  io.cozy.contacts ,\n       verbs : [ GET ]\n    },\n     images : {\n       description :  Required for the background ,\n       type :  io.cozy.files ,\n       verbs : [ GET ,  POST ],\n       values : [ io.cozy.files.music-dir ]\n    },\n     mail : {\n       description :  Required to send a congratulations email to your friends ,\n       type :  io.cozy.jobs ,\n       selector :  worker ,\n       values : [ sendmail ]\n    }\n  }\n}", 
            "title": "JSON"
        }, 
        {
            "location": "/cozy-stack/permissions/#inline", 
            "text": "OAuth2 as a  scope  parameter for defining the permissions given to the\napplication. But it s only a string, not a JSON. In that case, we use a space\ndelimited list of permissions, each permission is written compactly with  : \nbetween the components.  Example:  io.cozy.contacts io.cozy.files:GET:io.cozy.files.music-dir io.cozy.jobs:POST:sendmail:worker  Note : the  verbs  component can t be omitted when the  values  and selector  are used.", 
            "title": "Inline"
        }, 
        {
            "location": "/cozy-stack/permissions/#inspiration", 
            "text": "Access control on other similar platforms", 
            "title": "Inspiration"
        }, 
        {
            "location": "/cozy-stack/permissions/#routes", 
            "text": "", 
            "title": "Routes"
        }, 
        {
            "location": "/cozy-stack/permissions/#get-permissionsself", 
            "text": "List the permissions for a given token", 
            "title": "GET /permissions/self"
        }, 
        {
            "location": "/cozy-stack/permissions/#request", 
            "text": "GET /permissions/self HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/permissions/#response", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json  {\n   data : {\n     type :  io.cozy.permissions ,\n     id :  5a9c1844-d427-11e6-ab36-2b684d437b0d ,\n     attributes : {\n       type :  app ,\n       source_id :  io.cozy.apps/my-awesome-game ,\n       permissions : {\n         contacts : {\n           description :  Required for autocompletion on @name ,\n           type :  io.cozy.contacts ,\n           verbs : [ GET ]\n        },\n         images : {\n           description :  Required for the background ,\n           type :  io.cozy.files ,\n           verbs : [ GET ],\n           values : [ io.cozy.files.music-dir ]\n        },\n         mail : {\n           description :\n             Required to send a congratulations email to your friends ,\n           type :  io.cozy.jobs ,\n           selector :  worker ,\n           values : [ sendmail ]\n        }\n      }\n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/permissions/#post-permissions", 
            "text": "Create a new set of permissions. It can also associates one or more codes to it,\nvia the  codes  parameter in the query string. These codes can then be sent to\nother people as a way to give these permissions (sharing by links). The\nparameter is comma separed list of values. The role of these values is to\nidentify the codes if you want to revoke some of them later. A  ttl  parameter\ncan also be given to make the codes expires after a delay ( bigduration\nformat ).  Note : it is only possible to create a strict subset of the permissions\nassociated to the sent token.", 
            "title": "POST /permissions"
        }, 
        {
            "location": "/cozy-stack/permissions/#request_1", 
            "text": "POST /permissions?codes=bob,jane ttl=1D HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json  {\n   data : {\n     type :  io.cozy.permissions ,\n     attributes : {\n       source_id :  io.cozy.apps/my-awesome-game ,\n       permissions : {\n         images : {\n           type :  io.cozy.files ,\n           verbs : [ GET ],\n           values : [ io.cozy.files.music-dir ]\n        }\n      }\n    }\n  }\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/permissions/#response_1", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json  {\n   data : {\n     id :  a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 ,\n     type :  io.cozy.permissions ,\n     attributes : {\n       type :  share ,\n       source_id :  io.cozy.apps/my-awesome-game ,\n       codes : {\n         bob :  yuot7NaiaeGugh8T ,\n         jane :  Yohyoo8BHahh1lie \n      },\n       expires_at : 1483951978,\n       permissions : {\n         images : {\n           type :  io.cozy.files ,\n           verbs : [ GET ],\n           values : [ io.cozy.files.music-dir ]\n        }\n      }\n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/permissions/#get-permissionsid", 
            "text": "Return the informations about a set of permissions", 
            "title": "GET /permissions/:id"
        }, 
        {
            "location": "/cozy-stack/permissions/#request_2", 
            "text": "GET /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/permissions/#response_2", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json  {\n   data : {\n     id :  a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 ,\n     type :  io.cozy.permissions ,\n     attributes : {\n       type :  share ,\n       source_id :  io.cozy.apps/my-awesome-game ,\n       codes : {\n         bob :  yuot7NaiaeGugh8T ,\n         jane :  Yohyoo8BHahh1lie \n      },\n       expires_at : 1483951978,\n       permissions : {\n         images : {\n           type :  io.cozy.files ,\n           verbs : [ GET ],\n           values : [ io.cozy.files.music-dir ]\n        }\n      }\n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/permissions/#patch-permissionsid", 
            "text": "Add permissions in this permissions set. It can be used in inter-apps context as\na way to give another app the permission for some data. For example, the contact\napplication can send a  pick a photo  intent to the photos application with\nits permission id, and the photos app can then let the user choose a photo and\ngive the contacts application the permissions to use it.  It can also be used to add or remove codes.", 
            "title": "PATCH /permissions/:id"
        }, 
        {
            "location": "/cozy-stack/permissions/#request-to-add-remove-codes", 
            "text": "PATCH /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json  {\n   data : {\n     id :  a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 ,\n     type :  io.cozy.permissions ,\n     attributes : {\n       codes : {\n         jane :  Yohyoo8BHahh1lie \n      }\n    }\n  }\n}", 
            "title": "Request to add / remove codes"
        }, 
        {
            "location": "/cozy-stack/permissions/#request-to-add-permissions", 
            "text": "PATCH /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json  {\n   data : {\n     id :  a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 ,\n     type :  io.cozy.permissions ,\n     permissions : {\n       add-this : {\n         type :  io.cozy.files ,\n         verbs : [ GET ],\n         values : [ some-picture-id ]\n      }\n    }\n  }\n}", 
            "title": "Request to add permissions"
        }, 
        {
            "location": "/cozy-stack/permissions/#request-to-remove-permissions", 
            "text": "PATCH /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json  {\n   data : {\n     id :  a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 ,\n     type :  io.cozy.permissions ,\n     permissions : {\n       remove-this : {}\n    }\n  }\n}", 
            "title": "Request to remove permissions"
        }, 
        {
            "location": "/cozy-stack/permissions/#reponse", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json  {\n   data : {\n     id :  a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 ,\n     type :  io.cozy.permissions ,\n     attributes : {\n       type :  share ,\n       source_id :  io.cozy.apps/my-awesome-game ,\n       codes : {\n         bob :  yuot7NaiaeGugh8T \n      },\n       expires_at : 1483951978,\n       permissions : {\n         images : {\n           type :  io.cozy.files ,\n           verbs : [ GET ],\n           values : [ io.cozy.files.music-dir ]\n        }\n      }\n    }\n  }\n}", 
            "title": "Reponse"
        }, 
        {
            "location": "/cozy-stack/permissions/#delete-permissionsid", 
            "text": "Delete a set of permissions. For example, some permissions were used by a user\nto share a photo album with her friends, and then she changed her mind and\ncancel the sharing.", 
            "title": "DELETE /permissions/:id"
        }, 
        {
            "location": "/cozy-stack/permissions/#request_3", 
            "text": "DELETE /permissions/fa11561c-d645-11e6-83df-cbf577804d55 HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/permissions/#reponse_1", 
            "text": "HTTP/1.1 204 No Content", 
            "title": "Reponse"
        }, 
        {
            "location": "/cozy-stack/permissions/#post-permissionsexists", 
            "text": "List permissions for some documents", 
            "title": "POST /permissions/exists"
        }, 
        {
            "location": "/cozy-stack/permissions/#request_4", 
            "text": "POST /permissions/exists HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json  {\n   data : [\n    {  type :  io.cozy.files ,  id :  94375086-e2e2-11e6-81b9-5bc0b9dd4aa4  }\n    {  type :  io.cozy.files ,  id :  4cfbd8be-8968-11e6-9708-ef55b7c20863  }\n    {  type :  io.cozy.files ,  id :  a340d5e0-d647-11e6-b66c-5fc9ce1e17c6  }\n    {  type :  io.cozy.files ,  id :  94375086-e2e2-11e6-81b9-5bc0b9dd4aa4  }\n  ]\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/permissions/#reponse_2", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json  {\n   data : [\n    {  type :  io.cozy.files ,  id :  94375086-e2e2-11e6-81b9-5bc0b9dd4aa4 ,\n       verbs :[ GET ] }\n    {  type :  io.cozy.files ,  id :  a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 ,\n       verbs :[ GET ,  POST ] }\n  ]\n}", 
            "title": "Reponse"
        }, 
        {
            "location": "/cozy-stack/permissions/#patch-permissionsappsslug", 
            "text": "Add permissions or remove permissions to the web application with specified\nslug. It behaves like the  PATCH /permissions/:id  route. See this route for\nmore examples.", 
            "title": "PATCH /permissions/apps/:slug"
        }, 
        {
            "location": "/cozy-stack/permissions/#patch-permissionskonnectorsslug", 
            "text": "Add permissions or remove permissions to the konnector with specified slug. It\nbehaves like the  PATCH /permissions/:id  route. See this route for more\nexamples.", 
            "title": "PATCH /permissions/konnectors/:slug"
        }, 
        {
            "location": "/cozy-stack/permissions/#get-permissionsdoctypedoctypeshared-by-link", 
            "text": "List permissions for a doctype that are used for a  share by links", 
            "title": "GET /permissions/doctype/:doctype/shared-by-link"
        }, 
        {
            "location": "/cozy-stack/permissions/#request_5", 
            "text": "GET /permissions/doctype/io.cozy.events/shared-by-link HTTP/1.1\nHost: cozy.example.net\nAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ\nContent-Type: application/vnd.api+json\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/permissions/#reponse_3", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json  {\n   data : [\n    {\n       type :  io.cozy.permissions ,\n       id :  c47f82396d09bfcd270343c5855b30a0 ,\n       attributes : {\n         type :  share ,\n         permissions : {\n           rule0 : {\n             type :  io.cozy.events ,\n             verbs : [ PATCH ,  DELETE ],\n             values : [ c47f82396d09bfcd270343c5855b0eea ]\n          }\n        },\n         codes : {  bob :  secret  }\n      },\n       meta : {  rev :  1-d46b6358683b80c8d59fc55d6de54127  },\n       links : {  self :  /permissions/c47f82396d09bfcd270343c5855b30a0  }\n    },\n    {\n       type :  io.cozy.permissions ,\n       id :  c47f82396d09bfcd270343c5855b351a ,\n       attributes : {\n         type :  share ,\n         permissions : {\n           rule0 : {\n             type :  io.cozy.events ,\n             verbs : [ GET ],\n             values : [ c47f82396d09bfcd270343c5855b169b ]\n          }\n        },\n         codes : {  bob :  secret  }\n      },\n       meta : {  rev :  1-920af658575a56e9e84685f1b09e5c23  },\n       links : {  self :  /permissions/c47f82396d09bfcd270343c5855b351a  }\n    }\n  ]\n}  Permissions required : GET on the whole doctype", 
            "title": "Reponse"
        }, 
        {
            "location": "/cozy-stack/realtime/", 
            "text": "Realtime docs\n\n\nContext\n\n\nDefinitions\n\n\n\n\nEvent:\n Something happening in the stack. Most of them will come from\n  couchdb, some jobs and user actions might also trigger them.\n\n\nEvents feed:\n the feed of occurring events. There is two types of feeds:\n\n\ncontinuous\n allows to follow events as they occurs\n\n\ninterval\n allow the see the history of the feed from any given time\n\n\nRealtime:\n user experienced updates of the interface from change happening\n  from another source. \nIe, I have a folder opened in cozy-files on the browser,\n  I take some pictures from my smartphone, the pictures appears in the folder\n  without me needing to refresh the browser tab.\n\n\n\n\nWhat couchdb offers\n\n\nCouchdb supports with its \n_changes\n API both events feeds types:\n\n\n\n\nusing \nsince=now\ncontinuous=true\n we get all events \ncontinuous\nly as they\n  happen (SSE)\n\n\nusing \nsince=(last known seq_number)\n we get all changes in the \ninterval\n\n  between last known \nseq_number\n and now.\n\n\n\n\nCouchdb also offers a \n_db_updates\n route, which give us \ncontinuous\n changes\nat the database level. This routes does not support a since parameter, as there\nis no global \nseq_number\n.\n\n\nOther events will be generated from the stack itself, such as session close or\njobs activity.\n\n\nPerformance limitation\n\n\nWe cannot have a continuous \n_changes\n feed open to every databases\n\n\nUse cases for interval events feeds\n\n\nReplication\n\n\nCouchdb replication algorithm can work in one-shot mode, where it replicates\nchanges since last sync up until now, or in continuous mode where it replicates\nchanges as they happens.\n\n\n\n\nThe stack will not allow continuous mode for replication.\n\n\nThis is already supported with the \n_changes\n route\n\n\n\n\nSharing\n\n\nOur sharing is based on couchdb replication rules, so also depends on \n_changes\n\nfeed to ensure all changes have been applied.\n\n\nConsidering these use cases, there is no need for non-couchdb event to be part\nof the interval events feed.\n\n\nUse cases for continuous events feeds\n\n\nRealtime\n\n\nSome events should be send to the client to update views as data change.\n\n\n@event\n jobs trigger\n\n\nSome event will trigger the activation of a job (ie. When a photo has been\nuploaded, generate thumbnails and extract EXIF metadatas). This should be done\nas soon as possible after the events\n\n\nSharing ?\n\n\nWhile not absolutely necessary, having cozy A notify cozy B when a shared\ndocument is changed allows for both better user experience (faster propagation)\nand better performance (no need to poll every X minutes, the N cozy we are\nsharing from).\n\n\nClient realtime tech choice\n\n\nOptions\n\n\n\n\nPolling:\n regularly ask the server what happened since last time.\n\n\nCOMET:\n Leaving a normal HTTP connection open sending data and heartbeets\n  regularly to keep it open, reading xhr.responseText at intervals without\n  waiting for readyState == 4. Restart the connection when it breaks.\n\n\nSSE:\n Normalized \n standardized version of COMET with\n  \nhalf-decent browser support (86% users)\n\n  but easily polyfillable (it\ns just COMET). It is simpler and easier to debug.\n  It has some limitations (no HTTP headers in JS api, counts toward the maximum\n  number of http connection per domain).\n\n\nWebsocket:\n keep a socket open, it allows 2 way data communication which we\n  do not need, has\n  \nbetter server support (92% users)\n but\n  is impossible to polyfill client side, more popular, there is a better\n  \ngolang package\n\n\nSockJS \n cie\n they are \na lot\n of packages which imitate Websocket API\n  while using complicated client\nserver polyfill to allow support of older\n  browser. \nSockJS\n is a drop-in websocket\n  replacement with a go package and javascript client.\n\n\n\n\nChoice = Websocket\n\n\nWhile SSE appears at first glance like a better fit for our use case, its\nlimitation and lack of browser priority makes us choose websocket. In the event\nolder browser supports becomes necessary we can use SockJS.\n\n\noptimization paths (future)\n\n\n\n\nbandwidth\n Limiting the number of events sent by allowing the client to\n  specified it is only interested in events matching a selector \n(files app only\n  care about changes in the files of the current folder view)\n\n\nnumber of connections\n Instead of 1 socket / tab, we can probably make 1\n  socket / browser using some hackish combination of SharedWorker /\n  iframe.postMessage and a client-side demultiplexer.\n\n\nboth\n No need for realtime if the user is not using the tab (for most\n  usecases), we could cut the realtime feed depending on\n  \nPage Visibility API\n\n\n\n\nGo/Stack architecture\n\n\n\n\nWe assume all couchdb changes will originate from the stack\n\n\nEvents are generated at the stack level\n\n\nWe do \nNOT\n rely on couchdb \n_changes?continuous\n nor \n_db_udpates\n\n\n\n\nWe create a realtime.Event interface, which we call in other packages. We accept\nwebsocket connection and bind them to a realtime.Dispatcher object.\n\n\nSmall cozy version\n\n\nIt all happens in RAM, realtime.Event are immediately transmited to the\ndispatcher.\n\n\nBig cozy version (ie. multiple stack instance)\n\n\nRedis pub/sub\n\n\nWebsocket API\n\n\nWe start with a normal websocket handshake.\n\n\nWebsockets include a protocol description in handshake, the protocol described\nbelow is hereby named \nio.cozy.websocket\n.\n\n\nChanges to the websocket protocol should be given versions, support for older\nversion should be maintained when reasonable.\n\n\nGET /realtime/ HTTP/1.1\nHost: mycozy.example.com\nUpgrade: websocket\nConnection: Upgrade\nOrigin: http://calendar.mycozy.example.com\nSec-WebSocket-Key: x3JrandomLkh9GBhXDw==\nSec-WebSocket-Protocol: io.cozy.websocket\nSec-WebSocket-Version: 13\n\n\n\n\nThen messages are sent using json\n\n\nclient \n {\nmethod\n: \nAUTH\n,\n          \npayload\n: \nxxAppOrAuthTokenxx=\n\nclient \n {\nmethod\n: \nSUBSCRIBE\n,\n          \npayload\n: {\ntype\n: \nio.cozy.files\n}\nclient \n {\nmethod\n: \nSUBSCRIBE\n,\n          \npayload\n: {\ntype\n: \nio.cozy.contacts\n}\nserver \n {\nevent\n: \nUPDATED\n,\n          \npayload\n: {\nid\n: \nidA\n, \nrev\n: \n2-705...\n, \ntype\n: \nio.cozy.contacts\n, \ndoc\n: {embeded doc ...}}}\nserver \n {\nevent\n: \nDELETED\n,\n          \npayload\n: {\nid\n: \nidA\n, \nrev\n: \n3-541...\n, \ntype\n: \nio.cozy.contacts\n}}\nserver \n {\nevent\n: \nUPDATED\n,\n          \npayload\n: {\nid\n: \nidB\n, \nrev\n: \n6-457...\n, \ntype\n: \nio.cozy.files\n, \ndoc\n: {embeded doc ...}}}\n\n\n\n\nAUTH\n\n\nIt must be the first command to be sent. The client gives its token with this\ncommand, and the stack will use it to know which are the permissions of the app.\n\n\n{\nmethod\n: \nAUTH\n, \npayload\n: \neyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhcHAiLCJpYXQiOjE0OTg4MTY1OTEsImlzcyI6ImNvenkudG9vbHM6ODA4MCIsInN1YiI6Im1pbmkifQ.eH9DhoHz7rg8gR7noAiKfeo8eL3Q_PzyuskO_x3T8Hlh9q_IV-4zqoGtjTiO7luD6_VcLboEU-6o3XBek84VTg\n}\n\n\n\n\nSUBSCRIBE\n\n\nA client can send a SUBSCRIBE request to be notified of changes. The payload is\na selector for the events it wishes to receive For now the only possible\nselector is on type \n optionaly id\n\n\n{\nmethod\n: \nSUBSCRIBE\n, \npayload\n: {\ntype\n: \n[desired doctype]\n}}\n{\nmethod\n: \nSUBSCRIBE\n, \npayload\n: {\ntype\n: \n[desired doctype]\n, \nid\n: \nidA\n}}\n\n\n\n\nIn order to subscribe, a client must have permission \nGET\n on the passed\nselector. Otherwise an error is passed in the message feed.\n\n\nserver \n {\nevent\n: \nerror\n,\n          \npayload\n: {\n            \nstatus\n: \n403 Forbidden\n\n            \ncode\n: \nforbidden\n\n            \ntitle\n:\nThe Application can't subscribe to io.cozy.files\n\n            \nsource\n: {\nmethod\n: \nSUBSCRIBE\n, \npayload\n: {\ntype\n:\nio.cozy.files\n} }\n          }}", 
            "title": "/realtime - Realtime"
        }, 
        {
            "location": "/cozy-stack/realtime/#realtime-docs", 
            "text": "", 
            "title": "Realtime docs"
        }, 
        {
            "location": "/cozy-stack/realtime/#context", 
            "text": "", 
            "title": "Context"
        }, 
        {
            "location": "/cozy-stack/realtime/#definitions", 
            "text": "Event:  Something happening in the stack. Most of them will come from\n  couchdb, some jobs and user actions might also trigger them.  Events feed:  the feed of occurring events. There is two types of feeds:  continuous  allows to follow events as they occurs  interval  allow the see the history of the feed from any given time  Realtime:  user experienced updates of the interface from change happening\n  from another source.  Ie, I have a folder opened in cozy-files on the browser,\n  I take some pictures from my smartphone, the pictures appears in the folder\n  without me needing to refresh the browser tab.", 
            "title": "Definitions"
        }, 
        {
            "location": "/cozy-stack/realtime/#what-couchdb-offers", 
            "text": "Couchdb supports with its  _changes  API both events feeds types:   using  since=now continuous=true  we get all events  continuous ly as they\n  happen (SSE)  using  since=(last known seq_number)  we get all changes in the  interval \n  between last known  seq_number  and now.   Couchdb also offers a  _db_updates  route, which give us  continuous  changes\nat the database level. This routes does not support a since parameter, as there\nis no global  seq_number .  Other events will be generated from the stack itself, such as session close or\njobs activity.", 
            "title": "What couchdb offers"
        }, 
        {
            "location": "/cozy-stack/realtime/#performance-limitation", 
            "text": "We cannot have a continuous  _changes  feed open to every databases", 
            "title": "Performance limitation"
        }, 
        {
            "location": "/cozy-stack/realtime/#use-cases-for-interval-events-feeds", 
            "text": "", 
            "title": "Use cases for interval events feeds"
        }, 
        {
            "location": "/cozy-stack/realtime/#replication", 
            "text": "Couchdb replication algorithm can work in one-shot mode, where it replicates\nchanges since last sync up until now, or in continuous mode where it replicates\nchanges as they happens.   The stack will not allow continuous mode for replication.  This is already supported with the  _changes  route", 
            "title": "Replication"
        }, 
        {
            "location": "/cozy-stack/realtime/#sharing", 
            "text": "Our sharing is based on couchdb replication rules, so also depends on  _changes \nfeed to ensure all changes have been applied.  Considering these use cases, there is no need for non-couchdb event to be part\nof the interval events feed.", 
            "title": "Sharing"
        }, 
        {
            "location": "/cozy-stack/realtime/#use-cases-for-continuous-events-feeds", 
            "text": "", 
            "title": "Use cases for continuous events feeds"
        }, 
        {
            "location": "/cozy-stack/realtime/#realtime", 
            "text": "Some events should be send to the client to update views as data change.", 
            "title": "Realtime"
        }, 
        {
            "location": "/cozy-stack/realtime/#event-jobs-trigger", 
            "text": "Some event will trigger the activation of a job (ie. When a photo has been\nuploaded, generate thumbnails and extract EXIF metadatas). This should be done\nas soon as possible after the events", 
            "title": "@event jobs trigger"
        }, 
        {
            "location": "/cozy-stack/realtime/#sharing_1", 
            "text": "While not absolutely necessary, having cozy A notify cozy B when a shared\ndocument is changed allows for both better user experience (faster propagation)\nand better performance (no need to poll every X minutes, the N cozy we are\nsharing from).", 
            "title": "Sharing ?"
        }, 
        {
            "location": "/cozy-stack/realtime/#client-realtime-tech-choice", 
            "text": "", 
            "title": "Client realtime tech choice"
        }, 
        {
            "location": "/cozy-stack/realtime/#options", 
            "text": "Polling:  regularly ask the server what happened since last time.  COMET:  Leaving a normal HTTP connection open sending data and heartbeets\n  regularly to keep it open, reading xhr.responseText at intervals without\n  waiting for readyState == 4. Restart the connection when it breaks.  SSE:  Normalized   standardized version of COMET with\n   half-decent browser support (86% users) \n  but easily polyfillable (it s just COMET). It is simpler and easier to debug.\n  It has some limitations (no HTTP headers in JS api, counts toward the maximum\n  number of http connection per domain).  Websocket:  keep a socket open, it allows 2 way data communication which we\n  do not need, has\n   better server support (92% users)  but\n  is impossible to polyfill client side, more popular, there is a better\n   golang package  SockJS   cie  they are  a lot  of packages which imitate Websocket API\n  while using complicated client server polyfill to allow support of older\n  browser.  SockJS  is a drop-in websocket\n  replacement with a go package and javascript client.", 
            "title": "Options"
        }, 
        {
            "location": "/cozy-stack/realtime/#choice-websocket", 
            "text": "While SSE appears at first glance like a better fit for our use case, its\nlimitation and lack of browser priority makes us choose websocket. In the event\nolder browser supports becomes necessary we can use SockJS.", 
            "title": "Choice = Websocket"
        }, 
        {
            "location": "/cozy-stack/realtime/#optimization-paths-future", 
            "text": "bandwidth  Limiting the number of events sent by allowing the client to\n  specified it is only interested in events matching a selector  (files app only\n  care about changes in the files of the current folder view)  number of connections  Instead of 1 socket / tab, we can probably make 1\n  socket / browser using some hackish combination of SharedWorker /\n  iframe.postMessage and a client-side demultiplexer.  both  No need for realtime if the user is not using the tab (for most\n  usecases), we could cut the realtime feed depending on\n   Page Visibility API", 
            "title": "optimization paths (future)"
        }, 
        {
            "location": "/cozy-stack/realtime/#gostack-architecture", 
            "text": "We assume all couchdb changes will originate from the stack  Events are generated at the stack level  We do  NOT  rely on couchdb  _changes?continuous  nor  _db_udpates   We create a realtime.Event interface, which we call in other packages. We accept\nwebsocket connection and bind them to a realtime.Dispatcher object.", 
            "title": "Go/Stack architecture"
        }, 
        {
            "location": "/cozy-stack/realtime/#small-cozy-version", 
            "text": "It all happens in RAM, realtime.Event are immediately transmited to the\ndispatcher.", 
            "title": "Small cozy version"
        }, 
        {
            "location": "/cozy-stack/realtime/#big-cozy-version-ie-multiple-stack-instance", 
            "text": "Redis pub/sub", 
            "title": "Big cozy version (ie. multiple stack instance)"
        }, 
        {
            "location": "/cozy-stack/realtime/#websocket-api", 
            "text": "We start with a normal websocket handshake.  Websockets include a protocol description in handshake, the protocol described\nbelow is hereby named  io.cozy.websocket .  Changes to the websocket protocol should be given versions, support for older\nversion should be maintained when reasonable.  GET /realtime/ HTTP/1.1\nHost: mycozy.example.com\nUpgrade: websocket\nConnection: Upgrade\nOrigin: http://calendar.mycozy.example.com\nSec-WebSocket-Key: x3JrandomLkh9GBhXDw==\nSec-WebSocket-Protocol: io.cozy.websocket\nSec-WebSocket-Version: 13  Then messages are sent using json  client   { method :  AUTH ,\n           payload :  xxAppOrAuthTokenxx= \nclient   { method :  SUBSCRIBE ,\n           payload : { type :  io.cozy.files }\nclient   { method :  SUBSCRIBE ,\n           payload : { type :  io.cozy.contacts }\nserver   { event :  UPDATED ,\n           payload : { id :  idA ,  rev :  2-705... ,  type :  io.cozy.contacts ,  doc : {embeded doc ...}}}\nserver   { event :  DELETED ,\n           payload : { id :  idA ,  rev :  3-541... ,  type :  io.cozy.contacts }}\nserver   { event :  UPDATED ,\n           payload : { id :  idB ,  rev :  6-457... ,  type :  io.cozy.files ,  doc : {embeded doc ...}}}", 
            "title": "Websocket API"
        }, 
        {
            "location": "/cozy-stack/realtime/#auth", 
            "text": "It must be the first command to be sent. The client gives its token with this\ncommand, and the stack will use it to know which are the permissions of the app.  { method :  AUTH ,  payload :  eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhcHAiLCJpYXQiOjE0OTg4MTY1OTEsImlzcyI6ImNvenkudG9vbHM6ODA4MCIsInN1YiI6Im1pbmkifQ.eH9DhoHz7rg8gR7noAiKfeo8eL3Q_PzyuskO_x3T8Hlh9q_IV-4zqoGtjTiO7luD6_VcLboEU-6o3XBek84VTg }", 
            "title": "AUTH"
        }, 
        {
            "location": "/cozy-stack/realtime/#subscribe", 
            "text": "A client can send a SUBSCRIBE request to be notified of changes. The payload is\na selector for the events it wishes to receive For now the only possible\nselector is on type   optionaly id  { method :  SUBSCRIBE ,  payload : { type :  [desired doctype] }}\n{ method :  SUBSCRIBE ,  payload : { type :  [desired doctype] ,  id :  idA }}  In order to subscribe, a client must have permission  GET  on the passed\nselector. Otherwise an error is passed in the message feed.  server   { event :  error ,\n           payload : {\n             status :  403 Forbidden \n             code :  forbidden \n             title : The Application can't subscribe to io.cozy.files \n             source : { method :  SUBSCRIBE ,  payload : { type : io.cozy.files } }\n          }}", 
            "title": "SUBSCRIBE"
        }, 
        {
            "location": "/cozy-stack/remote/", 
            "text": "Table of contents\n\n\n{% raw %}\n\n\nProxy for remote data/API\n\n\nThe client side applications in Cozy are constrained and cannot speak with\nexternal websites to avoid leaking personal data. Technically, it is made with\nthe Content Security Policy. These rules are very strict and it would be a pity\nto now allow a client side app to load public informations from a source like\nWikipedia. Our proposal is to make client side apps able to query external\nwebsites of their choices, but these requests will be made via the cozy-stack\n(as a proxy) and will be logged to check later that no personal data was leaked\nunintentionally. We can see the data loaded from the external website as a\ndocument with a doctype: it\ns just not a doctype local to our cozy, but a remote\none.\n\n\nA client side app can request data from external websites by doing these three\nsteps:\n\n\n\n\nDeclaring a remote doctype and its requests\n\n\nDeclaring permissions on these doctypes in the manifest\n\n\nCalling the \n/remote\n API of cozy-stack\n\n\n\n\nDeclaring a remote doctype\n\n\nDoctypes are formalized in this repository:\n\ngithub.com/cozy/cozy-doctypes\n. Each\ndoctype has its own directory inside the repository. For a remote doctype, it\nwill include a file called \nrequest\n that will describe how the cozy-stack will\nrequest the external website.\n\n\nLet\ns take an example:\n\n\n$ tree cozy-doctypes\ncozy-doctypes\n\u251c\u2500\u2500 [...]\n\u251c\u2500\u2500 org.wikidata.entity\n\u2502   \u2514\u2500\u2500 request\n\u2514\u2500\u2500 org.wikidata.search\n    \u2514\u2500\u2500 request\n\n$ cat cozy-doctypes/org.wikidata.entity/request\nGET https://www.wikidata.org/wiki/Special:EntityData/{{entity}}.json\nAccept: application/json\n\n$ cat cozy-doctypes/org.wikidata.search/request\nGET https://www.wikidata.org/w/api.php?action=wbsearchentities\nsearch={{q}}\nlanguage=en\nformat=json\n\n\n\n\nHere, we have two remote doctypes. Each one has a request defined for it.\n\n\nThe format for the request file is:\n\n\n\n\nthe verb and the URL on the first line\n\n\nthen some lines that describe the HTTP headers\n\n\nthen a blank line and the body if the request is a POST\n\n\n\n\nFor the path, the query-string, the headers, and the body, it\ns possible to have\nsome dynamic part by using \n{{\n, a variable name, and \n}}\n.\n\n\nSome templating helpers are available to escape specific variables using \n{{\n\nfunction name - space - variable name \n}}\n. These helpers are only available for\nthe body part of the template.\n\n\nAvailable helpers:\n\n\n\n\njson\n: for json parts (\n{ \"key\": \"{{json val}}\" }\n)\n\n\nhtml\n: for html parts (\np\n{{html val}}\n/p\n)\n\n\nquery\n: for query parameter of a url (\nhttp://foobar.com?q={{query q}}\n)\n\n\npath\n: for path component of a url (\nhttp://foobar.com/{{path p}}\n)\n\n\n\n\nValues injected in the URL are automatically URI-escaped based on the part they\nare included in: namely as a query parameter or as a path component.\n\n\nNote\n: by default, the User-Agent is set to a default value (\ncozy-stack\n and\na version number). It can be overriden in the request description.\n\n\nExample:\n\n\nGET https://foobar.com/{{path}}?q={{query}}\nContent-Type: {{contentType}}\n\n{\n  \nkey\n: \n{{json value}}\n,\n  \nurl\n: \nhttp://anotherurl.com/{{path anotherPath}}?q={{query anotherQuery}}\n,\n}\n\n\n\n\nDeclaring permissions\n\n\nNothing special here. The client side app must declare that it will use these\ndoctypes in its manifest, like for other doctypes:\n\n\n{\n  \n...\n: \n...\n,\n  \npermissions\n: {\n    \nsearch\n: {\n      \ndescription\n: \nRequired for searching on wikidata\n,\n      \ntype\n: \norg.wikidata.search\n\n    },\n    \nentity\n: {\n      \ndescription\n:\n        \nRequired for getting more informations about an entity on wikidata\n,\n      \ntype\n: \norg.wikidata.entity\n\n    }\n  }\n}\n\n\n\n\nCalling the remote API\n\n\nGET/POST \n/remote/:doctype\n\n\nThe client side app must use the same verb as the defined request (\nGET\n in our\ntwo previous examples). It can use the query-string for GET, and a JSON body for\nPOST, to give values for the variables.\n\n\nExample:\n\n\nGET /remote/org.wikidata.search?q=Douglas+Adams HTTP/1.1\nHost: alice.cozy.tools\n\n\n\n\nIt is possible to send some extra informations, to make it easier to understand\nthe request. If no variable in the request matches it, it won\nt be send to the\nremote website.\n\n\nExample:\n\n\nPOST /remote/org.example HTTP/1.1\nHost: alice.cozy.tools\nContent-Type: application/json\n\n\n\n\n{\n  \nquery\n: \nQbhtynf Nqnzf\n,\n  \ncomment\n: \nquery is rot13 for Douglas Adams\n\n}\n\n\n\n\nNote\n: currently, only the response with a content-type that is an image,\nJSON or XML are accepted. Other content-types are blocked the time to evaluate\nif they are useful and their security implication (javascript is probably not\nsomething we want to allow).\n\n\nGET \n/remote/assets/:asset-name\n\n\nThe client application can fetch a list of predefined assets via this route.\nThe resources available are defined in the configuration file.\n\n\nExample:\n\n\nGET /remote/assets/bank HTTP/1.1\nHost: alice.cozy.tools\n\n\n\n\nLogs\n\n\nThe requests are logged as the \nio.cozy.remote.requests\n doctype, with the\ndoctype asked, the parameter (even those that have not been used, like \ncomment\n\nin the previous example), and the application that has made the request.\n\n\nFor developers\n\n\nIf you are a developer and you want to use a new remote doctype, it can be\ndifficult to first make it available in the github.com/cozy/cozy-doctypes\nrepository and only then test it. So, the cozy-stack serve command will have a\n\n--doctypes\n option to gives a local directory with the doctypes. You can fork\nthe repository, clone it, work on a new doctype inside, test it locally, and\nwhen OK, make a pull request for it.\n\n\n{% endraw %}", 
            "title": "/remote - Proxy for remote data/API"
        }, 
        {
            "location": "/cozy-stack/remote/#proxy-for-remote-dataapi", 
            "text": "The client side applications in Cozy are constrained and cannot speak with\nexternal websites to avoid leaking personal data. Technically, it is made with\nthe Content Security Policy. These rules are very strict and it would be a pity\nto now allow a client side app to load public informations from a source like\nWikipedia. Our proposal is to make client side apps able to query external\nwebsites of their choices, but these requests will be made via the cozy-stack\n(as a proxy) and will be logged to check later that no personal data was leaked\nunintentionally. We can see the data loaded from the external website as a\ndocument with a doctype: it s just not a doctype local to our cozy, but a remote\none.  A client side app can request data from external websites by doing these three\nsteps:   Declaring a remote doctype and its requests  Declaring permissions on these doctypes in the manifest  Calling the  /remote  API of cozy-stack", 
            "title": "Proxy for remote data/API"
        }, 
        {
            "location": "/cozy-stack/remote/#declaring-a-remote-doctype", 
            "text": "Doctypes are formalized in this repository: github.com/cozy/cozy-doctypes . Each\ndoctype has its own directory inside the repository. For a remote doctype, it\nwill include a file called  request  that will describe how the cozy-stack will\nrequest the external website.  Let s take an example:  $ tree cozy-doctypes\ncozy-doctypes\n\u251c\u2500\u2500 [...]\n\u251c\u2500\u2500 org.wikidata.entity\n\u2502   \u2514\u2500\u2500 request\n\u2514\u2500\u2500 org.wikidata.search\n    \u2514\u2500\u2500 request\n\n$ cat cozy-doctypes/org.wikidata.entity/request\nGET https://www.wikidata.org/wiki/Special:EntityData/{{entity}}.json\nAccept: application/json\n\n$ cat cozy-doctypes/org.wikidata.search/request\nGET https://www.wikidata.org/w/api.php?action=wbsearchentities search={{q}} language=en format=json  Here, we have two remote doctypes. Each one has a request defined for it.  The format for the request file is:   the verb and the URL on the first line  then some lines that describe the HTTP headers  then a blank line and the body if the request is a POST   For the path, the query-string, the headers, and the body, it s possible to have\nsome dynamic part by using  {{ , a variable name, and  }} .  Some templating helpers are available to escape specific variables using  {{ \nfunction name - space - variable name  }} . These helpers are only available for\nthe body part of the template.  Available helpers:   json : for json parts ( { \"key\": \"{{json val}}\" } )  html : for html parts ( p {{html val}} /p )  query : for query parameter of a url ( http://foobar.com?q={{query q}} )  path : for path component of a url ( http://foobar.com/{{path p}} )   Values injected in the URL are automatically URI-escaped based on the part they\nare included in: namely as a query parameter or as a path component.  Note : by default, the User-Agent is set to a default value ( cozy-stack  and\na version number). It can be overriden in the request description.  Example:  GET https://foobar.com/{{path}}?q={{query}}\nContent-Type: {{contentType}}\n\n{\n   key :  {{json value}} ,\n   url :  http://anotherurl.com/{{path anotherPath}}?q={{query anotherQuery}} ,\n}", 
            "title": "Declaring a remote doctype"
        }, 
        {
            "location": "/cozy-stack/remote/#declaring-permissions", 
            "text": "Nothing special here. The client side app must declare that it will use these\ndoctypes in its manifest, like for other doctypes:  {\n   ... :  ... ,\n   permissions : {\n     search : {\n       description :  Required for searching on wikidata ,\n       type :  org.wikidata.search \n    },\n     entity : {\n       description :\n         Required for getting more informations about an entity on wikidata ,\n       type :  org.wikidata.entity \n    }\n  }\n}", 
            "title": "Declaring permissions"
        }, 
        {
            "location": "/cozy-stack/remote/#calling-the-remote-api", 
            "text": "", 
            "title": "Calling the remote API"
        }, 
        {
            "location": "/cozy-stack/remote/#getpost-remotedoctype", 
            "text": "The client side app must use the same verb as the defined request ( GET  in our\ntwo previous examples). It can use the query-string for GET, and a JSON body for\nPOST, to give values for the variables.  Example:  GET /remote/org.wikidata.search?q=Douglas+Adams HTTP/1.1\nHost: alice.cozy.tools  It is possible to send some extra informations, to make it easier to understand\nthe request. If no variable in the request matches it, it won t be send to the\nremote website.  Example:  POST /remote/org.example HTTP/1.1\nHost: alice.cozy.tools\nContent-Type: application/json  {\n   query :  Qbhtynf Nqnzf ,\n   comment :  query is rot13 for Douglas Adams \n}  Note : currently, only the response with a content-type that is an image,\nJSON or XML are accepted. Other content-types are blocked the time to evaluate\nif they are useful and their security implication (javascript is probably not\nsomething we want to allow).", 
            "title": "GET/POST /remote/:doctype"
        }, 
        {
            "location": "/cozy-stack/remote/#get-remoteassetsasset-name", 
            "text": "The client application can fetch a list of predefined assets via this route.\nThe resources available are defined in the configuration file.  Example:  GET /remote/assets/bank HTTP/1.1\nHost: alice.cozy.tools", 
            "title": "GET /remote/assets/:asset-name"
        }, 
        {
            "location": "/cozy-stack/remote/#logs", 
            "text": "The requests are logged as the  io.cozy.remote.requests  doctype, with the\ndoctype asked, the parameter (even those that have not been used, like  comment \nin the previous example), and the application that has made the request.", 
            "title": "Logs"
        }, 
        {
            "location": "/cozy-stack/remote/#for-developers", 
            "text": "If you are a developer and you want to use a new remote doctype, it can be\ndifficult to first make it available in the github.com/cozy/cozy-doctypes\nrepository and only then test it. So, the cozy-stack serve command will have a --doctypes  option to gives a local directory with the doctypes. You can fork\nthe repository, clone it, work on a new doctype inside, test it locally, and\nwhen OK, make a pull request for it.  {% endraw %}", 
            "title": "For developers"
        }, 
        {
            "location": "/cozy-stack/settings/", 
            "text": "Table of contents\n\n\nSettings\n\n\nDisk usage\n\n\nGET /settings/disk-usage\n\n\nSays how many bytes are available and used to store files. When not limited the\n\nquota\n field is omitted.\n\n\nRequest\n\n\nGET /settings/disk-usage HTTP/1.1\nHost: alice.example.com\nAccept: application/vnd.api+json\nAuthorization: Bearer ...\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.settings\n,\n    \nid\n: \nio.cozy.settings.disk-usage\n,\n    \nattributes\n: {\n      \nis_limited\n: true,\n      \nquota\n: \n123456789\n,\n      \nused\n: \n12345678\n\n    }\n  }\n}\n\n\n\n\nPassphrase\n\n\nPOST /settings/passphrase\n\n\nThe onboarding application can send a request to this endpoint to register the\npassphrase of the user. The registration token can only be used once.\n\n\nRequest\n\n\nPOST /settings/passphrase HTTP/1.1\nHost: alice.example.com\nContent-Type: application/json\n\n\n\n\n{\n  \nregister_token\n: \n37cddf40d7724988860fa0e03efd30fe\n,\n  \npassphrase\n: \nThisIsTheNewShinnyPassphraseChoosedByAlice\n\n}\n\n\n\n\nResponse\n\n\nHTTP/1.1 204 No Content\nSet-Cookie: cozysessid=AAAAAFhSXT81MWU0ZTBiMzllMmI1OGUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa; Path=/; Domain=alice.example.com; Max-Age=604800; HttpOnly; Secure\n\n\n\n\nPUT /settings/passphrase (without two-factor authentication)\n\n\nThe user can change its passphrase with this route.\n\n\nFor users with two-factor authentication activated, a second step on the same\nroute is necessary to actually update the passphrase. See below.\n\n\nRequest\n\n\nPUT /settings/passphrase HTTP/1.1\nHost: alice.example.com\nContent-Type: application/json\nCookie: cozysessid=AAAAAFhSXT81MWU0ZTBiMzllMmI1OGUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa\n\n\n\n\n{\n  \ncurrent_passphrase\n: \nThisIsTheNewShinnyPassphraseChoosedByAlice\n,\n  \nnew_passphrase\n: \nAliceHasChangedHerPassphraseAndThisIsTheNewPassphrase\n\n}\n\n\n\n\nResponse\n\n\nHTTP/1.1 204 No Content\nSet-Cookie: cozysessid=AAAAShoo3uo1Maic4VibuGohlik2eKUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa; Path=/; Domain=alice.example.com; Max-Age=604800; HttpOnly; Secure\n\n\n\n\nPUT /settings/passphrase (with two-factor authentication)\n\n\nThe user can change its passphrase with this route, with two-factor\nauthentication to verify the user with more than its passphrase.\n\n\nRequest (first step)\n\n\nPUT /settings/passphrase HTTP/1.1\nHost: alice.example.com\nContent-Type: application/json\nCookie: cozysessid=AAAAAFhSXT81MWU0ZTBiMzllMmI1OGUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa\n\n\n\n\n{\n  \ncurrent_passphrase\n: \nThisIsTheNewShinnyPassphraseChoosedByAlice\n\n}\n\n\n\n\nResponse (first step)\n\n\nHTTP/1.1 200 OK\nSet-Cookie: cozysessid=AAAAShoo3uo1Maic4VibuGohlik2eKUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa; Path=/; Domain=alice.example.com; Max-Age=604800; HttpOnly; Secure\n\n\n\n\n{\n  \ntwo_factor_token\n: \nYxOSUjxd0SNmuwEEDRHXfw==\n\n}\n\n\n\n\nAt this point, the current passphrase has been exchanged against a token, and\na passcode should have been sent to the user to authenticate on the second\nstep.\n\n\nThe token/passcode pair can be used on the second step to update the\npassphrase.\n\n\nRequest (second step)\n\n\nPUT /settings/passphrase HTTP/1.1\nHost: alice.example.com\nContent-Type: application/json\nCookie: cozysessid=AAAAAFhSXT81MWU0ZTBiMzllMmI1OGUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa\n\n\n\n\n{\n  \nnew_passphrase\n: \nAliceHasChangedHerPassphraseAndThisIsTheNewPassphrase\n,\n  \ntwo_factor_token\n: \nYxOSUjxd0SNmuwEEDRHXfw==\n,\n  \ntwo_factor_passcode\n: \n4947178\n\n}\n\n\n\n\nResponse (second step)\n\n\nHTTP/1.1 204 No Content\nSet-Cookie: cozysessid=AAAAShoo3uo1Maic4VibuGohlik2eKUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa; Path=/; Domain=alice.example.com; Max-Age=604800; HttpOnly; Secure\n\n\n\n\nResponse\n\n\nHTTP/1.1 204 No Content\n\n\n\n\nInstance\n\n\nGET /settings/instance\n\n\nIf the user is logged in, display all instance settings. If the user is not\nlogged in, the register token can be used to read the informations.\n\n\nRequest\n\n\nGET /settings/instance HTTP/1.1\nHost: alice.example.com\nAccept: application/vnd.api+json\nCookie: sessionid=xxxx\n\n\n\n\nResponse\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.settings\n,\n    \nid\n: \nio.cozy.settings.instance\n,\n    \nmeta\n: {\n      \nrev\n: \n3-56521545485448482\n\n    },\n    \nattributes\n: {\n      \nlocale\n: \nfr\n,\n      \nauto_update\n: true,\n      \nemail\n: \nalice@example.com\n,\n      \npublic_name\n: \nAlice Martin\n,\n      \nauth_mode\n: \nbasic\n\n    }\n  }\n}\n\n\n\n\nPermissions\n\n\nTo use this endpoint, an application needs a permission on the type\n\nio.cozy.settings\n for the verb \nGET\n.\n\n\nPUT /settings/instance\n\n\nIf the user is logged in, allow to set the instance fields\n\n\nRequest\n\n\nPOST /settings/instance HTTP/1.1\nHost: alice.example.com\nAccept: application/vnd.api+json\nContent-type: application/vnd.api+json\nCookie: sessionid=xxxxx\nAuthorization: Bearer settings-token\n\n\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.settings\n,\n    \nid\n: \nio.cozy.settings.instance\n,\n    \nmeta\n: {\n      \nrev\n: \n3-56521545485448482\n\n    },\n    \nattributes\n: {\n      \nlocale\n: \nfr\n,\n      \nemail\n: \nalice@example.com\n,\n      \npublic_name\n: \nAlice Martin\n,\n      \ntimezone\n: \nEurope/Berlin\n,\n      \nauth_mode\n: \ntwo_factor_mail\n\n    }\n  }\n}\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-type: application/json\n\n\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.settings\n,\n    \nid\n: \nio.cozy.settings.instance\n,\n    \nmeta\n: {\n      \nrev\n: \n4-5a3e315e\n\n    },\n    \nattributes\n: {\n      \nlocale\n: \nfr\n,\n      \nemail\n: \nalice@example.com\n,\n      \npublic_name\n: \nAlice Martin\n,\n      \ntimezone\n: \nEurope/Berlin\n,\n      \nauth_mode\n: \ntwo_factor_mail\n\n    }\n  }\n}\n\n\n\n\nPermissions\n\n\nTo use this endpoint, an application needs a permission on the type\n\nio.cozy.settings\n for the verb \nPUT\n.\n\n\nPUT /settings/instance/auth_mode\n\n\nWith this route, the user can ask for the activation of different\nauthentication modes, like two-factor authentication.\n\n\nAvailable authentication modes:\n\n\n\n\nbasic\n: basic authentication only with passphrase\n\n\ntwo_factor_mail\n: authentication with passphrase and validation with a\n  code sent via email to the user.\n\n\n\n\nWhen asking for activation of the two-factor authentication, a side-effect can\nbe triggered to send the user its code (via email for instance), and the\nactivation not being effective. This side-effect should provide the user with\na code that can be used to finalize the activation of the two-factor\nauthentication.\n\n\nHence, this route has two behaviors:\n\n\n\n\nthe code is not provided: the route is a side effect to ask for the\n  activation of 2FA, and a code is sent\n\n\nthe code is provided, and valid: the two-factor authentication is actually\n  activated.\n\n\n\n\nStatus codes:\n\n\n\n\n204 No Content\n: when the mail has been confirmed and two-factor authentication is activated\n\n\n422 Unprocessable Entity\n: when the given confirmation code is not good.\n\n\n\n\nRequest\n\n\nPUT /settings/instance/auth_mode HTTP/1.1\nHost: alice.example.com\nContent-Type: application/json\nCookie: cozysessid=AAAAAFhSXT81MWU0ZTBiMzllMmI1OGUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa\n\n\n\n\n{\n  \nauth_mode\n: \ntwo_factor_mail\n,\n  \ntwo_factor_activation_code\n: \n12345678\n\n}\n\n\n\n\nGET /settings/sessions\n\n\nThis route allows to get all the currently active sessions.\n\n\nGET /settings/sessions HTTP/1.1\nHost: cozy.example.org\nCookie: ...\nAuthorization: Bearer ...\n\n\n\n\nHTTP/1.1 200 OK\nContent-Type: application/json\n\n\n\n\n{\n  \ndata\n: [\n    {\n      \nid\n: \n...\n,\n      \nattributes\n: {\n        \nlast_seen\n: \n\n      },\n      \nmeta\n: {\n        \nrev\n: \n...\n\n      }\n    }\n  ]\n}\n\n\n\n\nPermissions\n\n\nThis route requires the application to have permissions on the\n\nio.cozy.sessions\n doctype with the \nGET\n verb.\n\n\nOAuth 2 clients\n\n\nGET /settings/clients\n\n\nGet the list of the registered clients\n\n\nRequest\n\n\nGET /settings/clients HTTP/1.1\nHost: alice.example.com\nAccept: application/vnd.api+json\nCookie: sessionid=xxxxx\nAuthorization: Bearer oauth2-clients-token\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-type: application/json\n\n\n\n\n{\n  \ndata\n: [\n    {\n      \ntype\n: \nio.cozy.oauth.clients\n,\n      \nid\n: \n30e84c10-e6cf-11e6-9bfd-a7106972de51\n,\n      \nattributes\n: {\n        \nredirect_uris\n: [\nhttp://localhost:4000/oauth/callback\n],\n        \nclient_name\n: \nCozy-Desktop on my-new-laptop\n,\n        \nclient_kind\n: \ndesktop\n,\n        \nclient_uri\n: \nhttps://docs.cozy.io/en/mobile/desktop.html\n,\n        \nlogo_uri\n: \nhttps://docs.cozy.io/assets/images/cozy-logo-docs.svg\n,\n        \npolicy_uri\n: \nhttps://cozy.io/policy\n,\n        \nsoftware_id\n: \n/github.com/cozy-labs/cozy-desktop\n,\n        \nsoftware_version\n: \n0.16.0\n,\n        \nsynchronized_at\n: \n2017-09-05T16:23:04Z\n\n      },\n      \nlinks\n: {\n        \nself\n: \n/settings/clients/30e84c10-e6cf-11e6-9bfd-a7106972de51\n\n      }\n    }\n  ]\n}\n\n\n\n\nPermissions\n\n\nTo use this endpoint, an application needs a permission on the type\n\nio.cozy.oauth.clients\n for the verb \nGET\n (only client-side apps).\n\n\nDELETE /settings/clients/:client-id\n\n\nRequest\n\n\nDELETE /settings/clients/30e84c10-e6cf-11e6-9bfd-a7106972de51 HTTP/1.1\nHost: alice.example.com\nAuthorization: Bearer oauth2-clients-token\n\n\n\n\nResponse\n\n\nHTTP/1.1 204 No Content\n\n\n\n\nPermissions\n\n\nTo use this endpoint, an application needs a permission on the type\n\nio.cozy.oauth.clients\n for the verb \nDELETE\n (only client-side apps).\n\n\nPOST /settings/synchronized\n\n\nAny OAuth2 client can make a request to this endpoint with its token, no\npermission is needed. It will update the date of last synchronization for this\ndevice.\n\n\nRequest\n\n\nPOST /settings/synchronized HTTP/1.1\nHost: alice.example.com\nAuthorization: Bearer oauth2-access-token\n\n\n\n\nResponse\n\n\nHTTP/1.1 204 No Content\n\n\n\n\nContext\n\n\nGET /settings/onboarded\n\n\nIt redirects the user to an application after the onboarding. The application is\nselected according to the context of the instance and the configuration of the\nstack.\n\n\nGET /settings/context\n\n\nIt gives the keys/values from the config for the context of the instance.\n\n\nRequest\n\n\nGET /settings/context HTTP/1.1\nHost: alice.example.com\nAccept: application/vnd.api+json\nCookie: sessionid=xxxx\n\n\n\n\nResponse\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.settings\n,\n    \nid\n: \nio.cozy.settings.context\n,\n    \nattributes\n: {\n      \ndefault_redirection\n: \ndrive/#/files\n,\n      \nhelp_link\n: \nhttps://forum.cozy.io/\n,\n      \nonboarded_redirection\n: \ncollect/#/discovery/?intro\n\n    },\n    \nlinks\n: {\n      \nself\n: \n/settings/context\n\n    }\n  }\n}\n\n\n\n\nPermissions\n\n\nTo use this endpoint, an application needs a valid token, but no explicit\npermission is required.", 
            "title": "/settings - Settings"
        }, 
        {
            "location": "/cozy-stack/settings/#settings", 
            "text": "", 
            "title": "Settings"
        }, 
        {
            "location": "/cozy-stack/settings/#disk-usage", 
            "text": "", 
            "title": "Disk usage"
        }, 
        {
            "location": "/cozy-stack/settings/#get-settingsdisk-usage", 
            "text": "Says how many bytes are available and used to store files. When not limited the quota  field is omitted.", 
            "title": "GET /settings/disk-usage"
        }, 
        {
            "location": "/cozy-stack/settings/#request", 
            "text": "GET /settings/disk-usage HTTP/1.1\nHost: alice.example.com\nAccept: application/vnd.api+json\nAuthorization: Bearer ...", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/settings/#response", 
            "text": "HTTP/1.1 200 OK\nContent-type: application/vnd.api+json  {\n   data : {\n     type :  io.cozy.settings ,\n     id :  io.cozy.settings.disk-usage ,\n     attributes : {\n       is_limited : true,\n       quota :  123456789 ,\n       used :  12345678 \n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/settings/#passphrase", 
            "text": "", 
            "title": "Passphrase"
        }, 
        {
            "location": "/cozy-stack/settings/#post-settingspassphrase", 
            "text": "The onboarding application can send a request to this endpoint to register the\npassphrase of the user. The registration token can only be used once.", 
            "title": "POST /settings/passphrase"
        }, 
        {
            "location": "/cozy-stack/settings/#request_1", 
            "text": "POST /settings/passphrase HTTP/1.1\nHost: alice.example.com\nContent-Type: application/json  {\n   register_token :  37cddf40d7724988860fa0e03efd30fe ,\n   passphrase :  ThisIsTheNewShinnyPassphraseChoosedByAlice \n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/settings/#response_1", 
            "text": "HTTP/1.1 204 No Content\nSet-Cookie: cozysessid=AAAAAFhSXT81MWU0ZTBiMzllMmI1OGUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa; Path=/; Domain=alice.example.com; Max-Age=604800; HttpOnly; Secure", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/settings/#put-settingspassphrase-without-two-factor-authentication", 
            "text": "The user can change its passphrase with this route.  For users with two-factor authentication activated, a second step on the same\nroute is necessary to actually update the passphrase. See below.", 
            "title": "PUT /settings/passphrase (without two-factor authentication)"
        }, 
        {
            "location": "/cozy-stack/settings/#request_2", 
            "text": "PUT /settings/passphrase HTTP/1.1\nHost: alice.example.com\nContent-Type: application/json\nCookie: cozysessid=AAAAAFhSXT81MWU0ZTBiMzllMmI1OGUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa  {\n   current_passphrase :  ThisIsTheNewShinnyPassphraseChoosedByAlice ,\n   new_passphrase :  AliceHasChangedHerPassphraseAndThisIsTheNewPassphrase \n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/settings/#response_2", 
            "text": "HTTP/1.1 204 No Content\nSet-Cookie: cozysessid=AAAAShoo3uo1Maic4VibuGohlik2eKUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa; Path=/; Domain=alice.example.com; Max-Age=604800; HttpOnly; Secure", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/settings/#put-settingspassphrase-with-two-factor-authentication", 
            "text": "The user can change its passphrase with this route, with two-factor\nauthentication to verify the user with more than its passphrase.", 
            "title": "PUT /settings/passphrase (with two-factor authentication)"
        }, 
        {
            "location": "/cozy-stack/settings/#request-first-step", 
            "text": "PUT /settings/passphrase HTTP/1.1\nHost: alice.example.com\nContent-Type: application/json\nCookie: cozysessid=AAAAAFhSXT81MWU0ZTBiMzllMmI1OGUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa  {\n   current_passphrase :  ThisIsTheNewShinnyPassphraseChoosedByAlice \n}", 
            "title": "Request (first step)"
        }, 
        {
            "location": "/cozy-stack/settings/#response-first-step", 
            "text": "HTTP/1.1 200 OK\nSet-Cookie: cozysessid=AAAAShoo3uo1Maic4VibuGohlik2eKUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa; Path=/; Domain=alice.example.com; Max-Age=604800; HttpOnly; Secure  {\n   two_factor_token :  YxOSUjxd0SNmuwEEDRHXfw== \n}  At this point, the current passphrase has been exchanged against a token, and\na passcode should have been sent to the user to authenticate on the second\nstep.  The token/passcode pair can be used on the second step to update the\npassphrase.", 
            "title": "Response (first step)"
        }, 
        {
            "location": "/cozy-stack/settings/#request-second-step", 
            "text": "PUT /settings/passphrase HTTP/1.1\nHost: alice.example.com\nContent-Type: application/json\nCookie: cozysessid=AAAAAFhSXT81MWU0ZTBiMzllMmI1OGUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa  {\n   new_passphrase :  AliceHasChangedHerPassphraseAndThisIsTheNewPassphrase ,\n   two_factor_token :  YxOSUjxd0SNmuwEEDRHXfw== ,\n   two_factor_passcode :  4947178 \n}", 
            "title": "Request (second step)"
        }, 
        {
            "location": "/cozy-stack/settings/#response-second-step", 
            "text": "HTTP/1.1 204 No Content\nSet-Cookie: cozysessid=AAAAShoo3uo1Maic4VibuGohlik2eKUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa; Path=/; Domain=alice.example.com; Max-Age=604800; HttpOnly; Secure", 
            "title": "Response (second step)"
        }, 
        {
            "location": "/cozy-stack/settings/#response_3", 
            "text": "HTTP/1.1 204 No Content", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/settings/#instance", 
            "text": "", 
            "title": "Instance"
        }, 
        {
            "location": "/cozy-stack/settings/#get-settingsinstance", 
            "text": "If the user is logged in, display all instance settings. If the user is not\nlogged in, the register token can be used to read the informations.", 
            "title": "GET /settings/instance"
        }, 
        {
            "location": "/cozy-stack/settings/#request_3", 
            "text": "GET /settings/instance HTTP/1.1\nHost: alice.example.com\nAccept: application/vnd.api+json\nCookie: sessionid=xxxx", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/settings/#response_4", 
            "text": "{\n   data : {\n     type :  io.cozy.settings ,\n     id :  io.cozy.settings.instance ,\n     meta : {\n       rev :  3-56521545485448482 \n    },\n     attributes : {\n       locale :  fr ,\n       auto_update : true,\n       email :  alice@example.com ,\n       public_name :  Alice Martin ,\n       auth_mode :  basic \n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/settings/#permissions", 
            "text": "To use this endpoint, an application needs a permission on the type io.cozy.settings  for the verb  GET .", 
            "title": "Permissions"
        }, 
        {
            "location": "/cozy-stack/settings/#put-settingsinstance", 
            "text": "If the user is logged in, allow to set the instance fields", 
            "title": "PUT /settings/instance"
        }, 
        {
            "location": "/cozy-stack/settings/#request_4", 
            "text": "POST /settings/instance HTTP/1.1\nHost: alice.example.com\nAccept: application/vnd.api+json\nContent-type: application/vnd.api+json\nCookie: sessionid=xxxxx\nAuthorization: Bearer settings-token  {\n   data : {\n     type :  io.cozy.settings ,\n     id :  io.cozy.settings.instance ,\n     meta : {\n       rev :  3-56521545485448482 \n    },\n     attributes : {\n       locale :  fr ,\n       email :  alice@example.com ,\n       public_name :  Alice Martin ,\n       timezone :  Europe/Berlin ,\n       auth_mode :  two_factor_mail \n    }\n  }\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/settings/#response_5", 
            "text": "HTTP/1.1 200 OK\nContent-type: application/json  {\n   data : {\n     type :  io.cozy.settings ,\n     id :  io.cozy.settings.instance ,\n     meta : {\n       rev :  4-5a3e315e \n    },\n     attributes : {\n       locale :  fr ,\n       email :  alice@example.com ,\n       public_name :  Alice Martin ,\n       timezone :  Europe/Berlin ,\n       auth_mode :  two_factor_mail \n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/settings/#permissions_1", 
            "text": "To use this endpoint, an application needs a permission on the type io.cozy.settings  for the verb  PUT .", 
            "title": "Permissions"
        }, 
        {
            "location": "/cozy-stack/settings/#put-settingsinstanceauth_mode", 
            "text": "With this route, the user can ask for the activation of different\nauthentication modes, like two-factor authentication.  Available authentication modes:   basic : basic authentication only with passphrase  two_factor_mail : authentication with passphrase and validation with a\n  code sent via email to the user.   When asking for activation of the two-factor authentication, a side-effect can\nbe triggered to send the user its code (via email for instance), and the\nactivation not being effective. This side-effect should provide the user with\na code that can be used to finalize the activation of the two-factor\nauthentication.  Hence, this route has two behaviors:   the code is not provided: the route is a side effect to ask for the\n  activation of 2FA, and a code is sent  the code is provided, and valid: the two-factor authentication is actually\n  activated.   Status codes:   204 No Content : when the mail has been confirmed and two-factor authentication is activated  422 Unprocessable Entity : when the given confirmation code is not good.", 
            "title": "PUT /settings/instance/auth_mode"
        }, 
        {
            "location": "/cozy-stack/settings/#request_5", 
            "text": "PUT /settings/instance/auth_mode HTTP/1.1\nHost: alice.example.com\nContent-Type: application/json\nCookie: cozysessid=AAAAAFhSXT81MWU0ZTBiMzllMmI1OGUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa  {\n   auth_mode :  two_factor_mail ,\n   two_factor_activation_code :  12345678 \n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/settings/#get-settingssessions", 
            "text": "This route allows to get all the currently active sessions.  GET /settings/sessions HTTP/1.1\nHost: cozy.example.org\nCookie: ...\nAuthorization: Bearer ...  HTTP/1.1 200 OK\nContent-Type: application/json  {\n   data : [\n    {\n       id :  ... ,\n       attributes : {\n         last_seen :  \n      },\n       meta : {\n         rev :  ... \n      }\n    }\n  ]\n}", 
            "title": "GET /settings/sessions"
        }, 
        {
            "location": "/cozy-stack/settings/#permissions_2", 
            "text": "This route requires the application to have permissions on the io.cozy.sessions  doctype with the  GET  verb.", 
            "title": "Permissions"
        }, 
        {
            "location": "/cozy-stack/settings/#oauth-2-clients", 
            "text": "", 
            "title": "OAuth 2 clients"
        }, 
        {
            "location": "/cozy-stack/settings/#get-settingsclients", 
            "text": "Get the list of the registered clients", 
            "title": "GET /settings/clients"
        }, 
        {
            "location": "/cozy-stack/settings/#request_6", 
            "text": "GET /settings/clients HTTP/1.1\nHost: alice.example.com\nAccept: application/vnd.api+json\nCookie: sessionid=xxxxx\nAuthorization: Bearer oauth2-clients-token", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/settings/#response_6", 
            "text": "HTTP/1.1 200 OK\nContent-type: application/json  {\n   data : [\n    {\n       type :  io.cozy.oauth.clients ,\n       id :  30e84c10-e6cf-11e6-9bfd-a7106972de51 ,\n       attributes : {\n         redirect_uris : [ http://localhost:4000/oauth/callback ],\n         client_name :  Cozy-Desktop on my-new-laptop ,\n         client_kind :  desktop ,\n         client_uri :  https://docs.cozy.io/en/mobile/desktop.html ,\n         logo_uri :  https://docs.cozy.io/assets/images/cozy-logo-docs.svg ,\n         policy_uri :  https://cozy.io/policy ,\n         software_id :  /github.com/cozy-labs/cozy-desktop ,\n         software_version :  0.16.0 ,\n         synchronized_at :  2017-09-05T16:23:04Z \n      },\n       links : {\n         self :  /settings/clients/30e84c10-e6cf-11e6-9bfd-a7106972de51 \n      }\n    }\n  ]\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/settings/#permissions_3", 
            "text": "To use this endpoint, an application needs a permission on the type io.cozy.oauth.clients  for the verb  GET  (only client-side apps).", 
            "title": "Permissions"
        }, 
        {
            "location": "/cozy-stack/settings/#delete-settingsclientsclient-id", 
            "text": "", 
            "title": "DELETE /settings/clients/:client-id"
        }, 
        {
            "location": "/cozy-stack/settings/#request_7", 
            "text": "DELETE /settings/clients/30e84c10-e6cf-11e6-9bfd-a7106972de51 HTTP/1.1\nHost: alice.example.com\nAuthorization: Bearer oauth2-clients-token", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/settings/#response_7", 
            "text": "HTTP/1.1 204 No Content", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/settings/#permissions_4", 
            "text": "To use this endpoint, an application needs a permission on the type io.cozy.oauth.clients  for the verb  DELETE  (only client-side apps).", 
            "title": "Permissions"
        }, 
        {
            "location": "/cozy-stack/settings/#post-settingssynchronized", 
            "text": "Any OAuth2 client can make a request to this endpoint with its token, no\npermission is needed. It will update the date of last synchronization for this\ndevice.", 
            "title": "POST /settings/synchronized"
        }, 
        {
            "location": "/cozy-stack/settings/#request_8", 
            "text": "POST /settings/synchronized HTTP/1.1\nHost: alice.example.com\nAuthorization: Bearer oauth2-access-token", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/settings/#response_8", 
            "text": "HTTP/1.1 204 No Content", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/settings/#context", 
            "text": "", 
            "title": "Context"
        }, 
        {
            "location": "/cozy-stack/settings/#get-settingsonboarded", 
            "text": "It redirects the user to an application after the onboarding. The application is\nselected according to the context of the instance and the configuration of the\nstack.", 
            "title": "GET /settings/onboarded"
        }, 
        {
            "location": "/cozy-stack/settings/#get-settingscontext", 
            "text": "It gives the keys/values from the config for the context of the instance.", 
            "title": "GET /settings/context"
        }, 
        {
            "location": "/cozy-stack/settings/#request_9", 
            "text": "GET /settings/context HTTP/1.1\nHost: alice.example.com\nAccept: application/vnd.api+json\nCookie: sessionid=xxxx", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/settings/#response_9", 
            "text": "{\n   data : {\n     type :  io.cozy.settings ,\n     id :  io.cozy.settings.context ,\n     attributes : {\n       default_redirection :  drive/#/files ,\n       help_link :  https://forum.cozy.io/ ,\n       onboarded_redirection :  collect/#/discovery/?intro \n    },\n     links : {\n       self :  /settings/context \n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/settings/#permissions_5", 
            "text": "To use this endpoint, an application needs a valid token, but no explicit\npermission is required.", 
            "title": "Permissions"
        }, 
        {
            "location": "/cozy-stack/sharing/", 
            "text": "Table of contents\n\n\n{% raw %}\n\n\nSharing\n\n\nThe owner of a cozy instance can share access to her documents to other users.\n\n\nSharing by links\n\n\nA client-side application can propose sharing by links:\n\n\n\n\nThe application must have a public route in its manifest. See\n   \nApps documentation\n for how to do that.\n\n\nThe application can create a set of permissions for the shared documents,\n   with codes. See \npermissions documentation\n for the details.\n\n\nThe application can then create a shareable link (e.g.\n   \nhttps://calendar.cozy.example.net/public?sharecode=eiJ3iepoaihohz1Y\n) by\n   putting together the app sub-domain, the public route path, and a code for\n   the permissions set.\n\n\nThe app can then send this link by mail, via the \njobs system\n, or\n   just give it to the user, so he can transmit it to her friends via chat or\n   other ways.\n\n\n\n\nWhen someone opens the shared link, the stack will load the public route, find\nthe corresponding \nindex.html\n file, and replace \n{{.Token}}\n inside it by a\ntoken with the same set of permissions that \nsharecode\n offers. This token can\nthen be used as a \nBearer\n token in the \nAuthorization\n header for requests to\nthe stack (or via cozy-client-js).\n\n\nIf necessary, the application can list the permissions for the token by calling\n\n/permissions/self\n with this token.\n\n\nCozy to cozy sharing\n\n\nThe owner of a cozy instance can send and synchronize documents to others cozy\nusers.\n\n\nRoutes\n\n\nPOST /sharings/\n\n\nCreate a new sharing. The sharing rules and recipients must be specified. The\n\ndescription\n, \npreview_path\n, and \nopen_sharing\n fields are optional. The\n\napp_slug\n field is optional and is the slug of the web app by default.\n\n\nRequest\n\n\nPOST /sharings/ HTTP/1.1\nHost: alice.example.net\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.sharings\n,\n    \nattributes\n: {\n      \ndescription\n: \nsharing test\n,\n      \npreview_path\n: \n/preview-sharing\n,\n      \nrules\n: [\n        {\n          \ntitle\n: \nHawaii\n,\n          \ndoctype\n: \nio.cozy.files\n,\n          \nvalues\n: [\n612acf1c-1d72-11e8-b043-ef239d3074dd\n],\n          \nadd\n: \nsync\n,\n          \nupdate\n: \nsync\n,\n          \nremove\n: \nsync\n\n        }\n      ]\n    },\n    \nrelationships\n: {\n      \nrecipients\n: {\n        \ndata\n: [\n          {\n            \nid\n: \n2a31ce0128b5f89e40fd90da3f014087\n,\n            \ntype\n: \nio.cozy.contacts\n\n          }\n        ]\n      }\n    }\n  }\n}\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.sharings\n,\n    \nid\n: \nce8835a061d0ef68947afe69a0046722\n,\n    \nmeta\n: {\n      \nrev\n: \n1-4859c6c755143adf0838d225c5e97882\n\n    },\n    \nattributes\n: {\n      \ndescription\n: \nsharing test\n,\n      \npreview_path\n: \n/preview-sharing\n,\n      \napp_slug\n: \ndrive\n,\n      \nowner\n: true,\n      \ncreated_at\n: \n2018-01-04T12:35:08Z\n,\n      \nupdated_at\n: \n2018-01-04T13:45:43Z\n,\n      \nmembers\n: [\n        {\n          \nstatus\n: \nowner\n,\n          \nname\n: \nAlice\n,\n          \nemail\n: \nalice@example.net\n,\n          \ninstance\n: \nalice.example.net\n\n        },\n        {\n          \nstatus\n: \nmail-not-sent\n,\n          \nname\n: \nBob\n,\n          \nemail\n: \nbob@example.net\n\n        }\n      ],\n      \nrules\n: [\n        {\n          \ntitle\n: \nHawaii\n,\n          \ndoctype\n: \nio.cozy.files\n,\n          \nvalues\n: [\n612acf1c-1d72-11e8-b043-ef239d3074dd\n],\n          \nadd\n: \nsync\n,\n          \nupdate\n: \nsync\n,\n          \nremove\n: \nsync\n\n        }\n      ]\n    },\n    \nlinks\n: {\n      \nself\n: \n/sharings/ce8835a061d0ef68947afe69a0046722\n\n    }\n  }\n}\n\n\n\n\nGET /sharings/:sharing-id/discovery\n\n\nIf no preview_path is set, it\ns an URL to this route that will be sent to the\nusers to notify them that someone wants to share something with them. On this\npage, they can fill the URL of their Cozy (if the user has already filled its\nCozy URL in a previous sharing, the form will be pre-filled and the user will\njust have to click OK).\n\n\nQuery-String\n\n\n\n\n\n\n\n\nParameter\n\n\nDescription\n\n\n\n\n\n\n\n\n\n\nstate\n\n\na code that identify the recipient\n\n\n\n\n\n\n\n\nExample\n\n\nGET /sharings/ce8835a061d0ef68947afe69a0046722/discovery?state=eiJ3iepoaihohz1Y HTTP/1.1\nHost: alice.example.net\n\n\n\n\nPOST /sharings/:sharing-id/discovery\n\n\nGive to the cozy of the sharer the URL of the Cozy of one recipient. The sharer\nwill register its-self as an OAuth client on the recipient cozy, and then will\nask the recipient to accept the permissions on its instance.\n\n\nThis route exists in two versions, the version is selected by the HTTP header\n\nAccept\n\n\nClassical (\nx-www-url-encoded\n)\n\n\n\n\n\n\n\n\nParameter\n\n\nDescription\n\n\n\n\n\n\n\n\n\n\nstate\n\n\na code that identify the recipient\n\n\n\n\n\n\nurl\n\n\nthe URL of the Cozy for the recipient\n\n\n\n\n\n\n\n\nExample\n\n\nPOST /sharings/ce8835a061d0ef68947afe69a0046722/discovery HTTP/1.1\nHost: alice.example.org\nContent-Type: application/x-www-form-urlencoded\nAccept: text/html\n\nstate=eiJ3iepoaihohz1Y\nurl=https://bob.example.net/\n\n\n\n\nHTTP/1.1 302 Moved Temporarily\nLocation: https://bob.example.net/auth/sharing?...\n\n\n\n\nJSON\n\n\nThis version can be more convenient for applications that implement the\npreview page. To do that, an application must give a \npreview_path\n when\ncreating the sharing. This path must be a public route of this application.\nThe recipients will receive a link to the application subdomain, on this page,\nand with a \nsharecode\n in the query string (like for a share by link).\n\n\nTo know the \nsharing-id\n, it\ns possible to ask \nGET /permissions/self\n, with\nthe \nsharecode\n in the \nAuthorization\n header (it\ns a JWT token). In the\nresponse, the \nsource_id\n field will be \nio.cozy.sharings/\nsharing-id\n.\n\n\nParameters\n\n\n\n\n\n\n\n\nParameter\n\n\nDescription\n\n\n\n\n\n\n\n\n\n\nsharecode\n\n\na code that identify the recipient\n\n\n\n\n\n\nurl\n\n\nthe URL of the Cozy for the recipient\n\n\n\n\n\n\n\n\nExample\n\n\nPOST /sharings/ce8835a061d0ef68947afe69a0046722/discovery HTTP/1.1\nHost: alice.example.org\nContent-Type: application/x-www-form-urlencoded\nAccept: application/json\n\nsharecode=eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhcHAiLCJpYXQiOjE1MjAzNDM4NTc\nurl=https://bob.example.net/\n\n\n\n\nHTTP/1.1 200 OK\nContent-Type: application/json\n\n\n\n\n{\n  \nredirect\n: \nhttps://bob.example.net/auth/sharing?...\n\n}\n\n\n\n\nGET /sharings/:sharing-id\n\n\nGet the information about a sharing. This includes the content of the rules, the members, as well as the already shared documents for this sharing.\n\n\nRequest\n\n\nGET /sharings/ce8835a061d0ef68947afe69a0046722 HTTP/1.1\nHost: alice.example.net\nAccept: application/vnd.api+json\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.sharings\n,\n    \nid\n: \nce8835a061d0ef68947afe69a0046722\n,\n    \nmeta\n: {\n      \nrev\n: \n1-4859c6c755143adf0838d225c5e97882\n\n    },\n    \nattributes\n: {\n      \ndescription\n: \nsharing test\n,\n      \npreview_path\n: \n/preview-sharing\n,\n      \napp_slug\n: \ndrive\n,\n      \nowner\n: true,\n      \ncreated_at\n: \n2018-01-04T12:35:08Z\n,\n      \nupdated_at\n: \n2018-01-04T13:45:43Z\n,\n      \nmembers\n: [\n        {\n          \nstatus\n: \nowner\n,\n          \nname\n: \nAlice\n,\n          \nemail\n: \nalice@example.net\n,\n          \ninstance\n: \nalice.example.net\n\n        },\n        {\n          \nstatus\n: \nready\n,\n          \nname\n: \nBob\n,\n          \nemail\n: \nbob@example.net\n\n        }\n      ],\n      \nrules\n: [\n        {\n          \ntitle\n: \nHawaii\n,\n          \ndoctype\n: \nio.cozy.files\n,\n          \nvalues\n: [\n612acf1c-1d72-11e8-b043-ef239d3074dd\n],\n          \nadd\n: \nsync\n,\n          \nupdate\n: \nsync\n,\n          \nremove\n: \nsync\n\n        }\n      ]\n    },\n    \nrelationships\n: {\n      \nshared_docs\n: {\n        \ndata\n: [\n          {\n            \nid\n: \n612acf1c-1d72-11e8-b043-ef239d3074dd\n,\n            \ntype\n: \nio.cozy.files\n\n          },\n          {\n            \nid\n: \na34528d2-13fb-9482-8d20-bf1972531225\n,\n            \ntype\n: \nio.cozy.files\n\n          }\n        ]\n      }\n    },\n    \nlinks\n: {\n      \nself\n: \n/sharings/ce8835a061d0ef68947afe69a0046722\n\n    }\n  }\n}\n\n\n\n\nGET /sharings/doctype/:doctype\n\n\nGet information about all the sharings that have a rule for the given doctype. This includes the content of the rules, the members, as well as the already shared documents for this sharing.\n\n\nRequest\n\n\nGET /sharings/doctype/io.cozy.files HTTP/1.1\nHost: alice.example.net\nAccept: application/vnd.api+json\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: [\n    {\n      \ntype\n: \nio.cozy.sharings\n,\n      \nid\n: \nce8835a061d0ef68947afe69a0046722\n,\n      \nattributes\n: {\n        \ndescription\n: \nsharing test\n,\n        \npreview_path\n: \n/preview-sharing\n,\n        \napp_slug\n: \ndrive\n,\n        \nowner\n: true,\n        \ncreated_at\n: \n2018-01-04T12:35:08Z\n,\n        \nupdated_at\n: \n2018-01-04T13:45:43Z\n,\n        \nmembers\n: [\n          {\n            \nstatus\n: \nowner\n,\n            \nname\n: \nAlice\n,\n            \nemail\n: \nalice@example.net\n,\n            \ninstance\n: \nalice.example.net\n\n          },\n          {\n            \nstatus\n: \nready\n,\n            \nname\n: \nBob\n,\n            \nemail\n: \nbob@example.net\n\n          }\n        ],\n        \nrules\n: [\n          {\n            \ntitle\n: \nHawaii\n,\n            \ndoctype\n: \nio.cozy.files\n,\n            \nvalues\n: [\n612acf1c-1d72-11e8-b043-ef239d3074dd\n],\n            \nadd\n: \nsync\n,\n            \nupdate\n: \nsync\n,\n            \nremove\n: \nsync\n\n          }\n        ]\n      },\n      \nmeta\n: {\n        \nrev\n: \n1-4859c6c755143adf0838d225c5e97882\n\n      },\n      \nlinks\n: {\n        \nself\n: \n/sharings/ce8835a061d0ef68947afe69a0046722\n\n      },\n      \nrelationships\n: {\n        \nshared_docs\n: {\n          \ndata\n: [\n            {\n              \nid\n: \n612acf1c-1d72-11e8-b043-ef239d3074dd\n,\n              \ntype\n: \nio.cozy.files\n\n            },\n            {\n              \nid\n: \na34528d2-13fb-9482-8d20-bf1972531225\n,\n              \ntype\n: \nio.cozy.files\n\n            }\n          ]\n        }\n      }\n    },\n    {\n      \ntype\n: \nio.cozy.sharings\n,\n      \nid\n: \nb4e58d039c03d01742085de5e505284e\n,\n      \nattributes\n: {\n        \ndescription\n: \nanother sharing test\n,\n        \npreview_path\n: \n/preview-sharing\n,\n        \napp_slug\n: \ndrive\n,\n        \nowner\n: true,\n        \ncreated_at\n: \n2018-02-04T12:35:08Z\n,\n        \nupdated_at\n: \n2018-02-04T13:45:43Z\n,\n        \nmembers\n: [\n          {\n            \nstatus\n: \nowner\n,\n            \nname\n: \nAlice\n,\n            \nemail\n: \nalice@example.net\n,\n            \ninstance\n: \nalice.example.net\n\n          },\n          {\n            \nstatus\n: \nready\n,\n            \nname\n: \nBob\n,\n            \nemail\n: \nbob@example.net\n\n          }\n        ],\n        \nrules\n: [\n          {\n            \ntitle\n: \nSingapore\n,\n            \ndoctype\n: \nio.cozy.files\n,\n            \nvalues\n: [\ne18e30e2-8eda-1bde-afce-edafc6b1a91b\n],\n            \nadd\n: \nsync\n,\n            \nupdate\n: \nsync\n,\n            \nremove\n: \nsync\n\n          }\n        ]\n      },\n      \nmeta\n: {\n        \nrev\n: \n1-7ac5f1252a0c513186a5d35b1a6fd350\n\n      },\n      \nlinks\n: {\n        \nself\n: \n/sharings/b4e58d039c03d01742085de5e505284e\n\n      },\n      \nrelationships\n: {\n        \nshared_docs\n: {\n          \ndata\n: [\n            {\n              \nid\n: \ndcc52bee-1277-a6b3-b36f-369ffd81a4ee\n,\n              \ntype\n: \nio.cozy.files\n\n            }\n          ]\n        }\n      }\n    }\n  ],\n  \nmeta\n: {\n    \ncount\n: 3\n  }\n}\n\n\n\n\nPUT /sharings/:sharing-id\n\n\nThe sharer\ns cozy sends a request to this route on the recipient\ns cozy to\ncreate a sharing request, with most of the informations about the sharing.\nThese informations will be displayed to the recipient just before its final\nacceptation of the sharing, to be sure he/she knows what will be shared.\n\n\nRequest\n\n\nPUT /sharings/ce8835a061d0ef68947afe69a0046722 HTTP/1.1\nHost: bob.example.net\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.sharings\n,\n    \nid\n: \nce8835a061d0ef68947afe69a0046722\n,\n    \nattributes\n: {\n      \ndescription\n: \nsharing test\n,\n      \npreview_path\n: \n/preview-sharing\n,\n      \napp_slug\n: \ndrive\n,\n      \nowner\n: true,\n      \ncreated_at\n: \n2018-01-04T12:35:08Z\n,\n      \nupdated_at\n: \n2018-01-04T13:45:43Z\n,\n      \nmembers\n: [\n        {\n          \nstatus\n: \nowner\n,\n          \nname\n: \nAlice\n,\n          \nemail\n: \nalice@example.net\n,\n          \ninstance\n: \nalice.example.net\n\n        },\n        {\n          \nstatus\n: \nmail-not-sent\n,\n          \nname\n: \nBob\n,\n          \nemail\n: \nbob@example.net\n,\n          \ninstance\n: \nbob.example.net\n\n        }\n      ],\n      \nrules\n: [\n        {\n          \ntitle\n: \nHawaii\n,\n          \ndoctype\n: \nio.cozy.files\n,\n          \nvalues\n: [\n612acf1c-1d72-11e8-b043-ef239d3074dd\n],\n          \nadd\n: \nsync\n,\n          \nupdate\n: \nsync\n,\n          \nremove\n: \nsync\n\n        }\n      ]\n    }\n  }\n}\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.sharings\n,\n    \nid\n: \nce8835a061d0ef68947afe69a0046722\n,\n    \nmeta\n: {\n      \nrev\n: \n1-f579a69a9fa5dd720010a1dbb82320be\n\n    },\n    \nattributes\n: {\n      \ndescription\n: \nsharing test\n,\n      \npreview_path\n: \n/preview-sharing\n,\n      \napp_slug\n: \ndrive\n,\n      \nowner\n: true,\n      \ncreated_at\n: \n2018-01-04T12:35:08Z\n,\n      \nupdated_at\n: \n2018-01-04T13:45:43Z\n,\n      \nmembers\n: [\n        {\n          \nstatus\n: \nowner\n,\n          \nname\n: \nAlice\n,\n          \nemail\n: \nalice@example.net\n,\n          \ninstance\n: \nalice.example.net\n\n        },\n        {\n          \nstatus\n: \nmail-not-sent\n,\n          \nname\n: \nBob\n,\n          \nemail\n: \nbob@example.net\n,\n          \ninstance\n: \nbob.example.net\n\n        }\n      ],\n      \nrules\n: [\n        {\n          \ntitle\n: \nHawaii\n,\n          \ndoctype\n: \nio.cozy.files\n,\n          \nvalues\n: [\n612acf1c-1d72-11e8-b043-ef239d3074dd\n],\n          \nadd\n: \nsync\n,\n          \nupdate\n: \nsync\n,\n          \nremove\n: \nsync\n\n        }\n      ]\n    },\n    \nlinks\n: {\n      \nself\n: \n/sharings/ce8835a061d0ef68947afe69a0046722\n\n    }\n  }\n}\n\n\n\n\nPOST /sharings/:sharing-id/answer\n\n\nThis route is used by the Cozy of a recipient to exchange credentials with the\nCozy of the sharer, after the recipient has accepted a sharing.\n\n\nRequest\n\n\nPOST /sharings/ce8835a061d0ef68947afe69a0046722/answer HTTP/1.1\nHost: alice.example.net\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.sharings.answer\n,\n    \nid\n: \nce8835a061d0ef68947afe69a0046722\n,\n    \nattributes\n: {\n      \nstate\n: \neiJ3iepoaihohz1Y\n,\n      \nclient\n: {...},\n      \naccess_token\n: \nuia7b85928e5cf\n\n    }\n  }\n}\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/vnd.api+json\n\n\n\n\n{\n  \ndata\n: {\n    \ntype\n: \nio.cozy.sharings.answer\n,\n    \nid\n: \nce8835a061d0ef68947afe69a0046722\n,\n    \nattributes\n: {\n      \nclient\n: {...},\n      \naccess_token\n: \nui77bd4670fbd3\n\n    }\n  }\n}\n\n\n\n\nPOST /sharings/:sharing-id/_revs_diff\n\n\nThis endpoint is used by the sharing replicator of the stack to know which\ndocuments must be sent to the other cozy. It is inspired by\nhttp://docs.couchdb.org/en/2.1.1/api/database/misc.html#db-revs-diff.\n\n\nRequest\n\n\nPOST /sharings/ce8835a061d0ef68947afe69a0046722/_revs_diff HTTP/1.1\nHost: bob.example.net\nAccept: application/json\nContent-Type: application/json\nAuthorization: Bearer ...\n\n\n\n\n{\n  \nio.cozy.files/29631902-2cec-11e8-860d-435b24c2cc58\n: [\n    \n2-4a7e4ae49c4366eaed8edeaea8f784ad\n\n  ],\n  \nio.cozy.files/44f5752a-2cec-11e8-b227-abfc3cfd4b6e\n: [\n    \n4-2ee767305024673cfb3f5af037cd2729\n,\n    \n4-efc54218773c6acd910e2e97fea2a608\n\n  ]\n}\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/json\n\n\n\n\n{\n  \nio.cozy.files/44f5752a-2cec-11e8-b227-abfc3cfd4b6e\n: {\n    \nmissing\n: [\n4-2ee767305024673cfb3f5af037cd2729\n],\n    \npossible_ancestors\n: [\n3-753875d51501a6b1883a9d62b4d33f91\n]\n  }\n}\n\n\n\n\nPOST /sharings/:sharing-id/_bulk_docs\n\n\nThis endpoint is used by the sharing replicator of the stack to send\ndocuments in a bulk to the other cozy. It is inspired by\nhttp://docs.couchdb.org/en/2.1.1/api/database/bulk-api.html#db-bulk-docs.\n\n\nNote\n: we force \nnew_edits\n to \nfalse\n.\n\n\nRequest\n\n\nPOST /sharings/ce8835a061d0ef68947afe69a0046722/_bulk_docs HTTP/1.1\nHost: bob.example.net\nAccept: application/json\nContent-Type: application/json\nAuthorization: Bearer ...\n\n\n\n\n{\n  \nio.cozy.files\n: [\n    {\n      \n_id\n: \n44f5752a-2cec-11e8-b227-abfc3cfd4b6e\n,\n      \n_rev\n: \n4-2ee767305024673cfb3f5af037cd2729\n,\n      \n_revisions\n: {\n        \nstart\n: 4,\n        \nids\n: [\n          \n2ee767305024673cfb3f5af037cd2729\n,\n          \n753875d51501a6b1883a9d62b4d33f91\n\n        ]\n      }\n    }\n  ]\n}\n\n\n\n\nResponse\n\n\nHTTP/1.1 200 OK\nContent-Type: application/json\n\n\n\n\n[]\n\n\n\n\nPUT /sharings/:sharing-id/io.cozy.files/:file-id/metadata\n\n\nThis is an internal endpoint used by a stack to send the new metadata about a\nfile that has changed.\n\n\nRequest\n\n\nPUT /sharings/ce8835a061d0ef68947afe69a0046722/io.cozy.files/0c1116b028c6ae6f5cdafb949c088265/metadata HTTP/1.1\nHost: bob.example.net\nAccept: application/json\nContent-Type: application/json\nAuthorization: Bearer ...\n\n\n\n\n{\n  \n_id\n: \n4b24ab130b2538b7b444fc65430198ad\n,\n  \n_rev\n: \n1-356bf77c03baa1da851a2be1f06aba81\n,\n  \ntype\n: \nfile\n,\n  \nname\n: \ncloudy.jpg\n,\n  \ndir_id\n: \n4b24ab130b2538b7b444fc65430188cd\n,\n  \ncreated_at\n: \n2018-01-03T16:10:36.885807013+01:00\n,\n  \nupdated_at\n: \n2018-01-03T16:10:36.885807013+01:00\n,\n  \nsize\n: \n84980\n,\n  \nmd5sum\n: \nSuRJOiD/QPwDUpKpQujcVA==\n,\n  \nmime\n: \nimage/jpeg\n,\n  \nclass\n: \nimage\n,\n  \nexecutable\n: false,\n  \ntrashed\n: false,\n  \ntags\n: [],\n  \nmetadata\n: {\n    \ndatetime\n: \n2018-01-03T16:10:36.89118949+01:00\n,\n    \nextractor_version\n: 2,\n    \nheight\n: 1200,\n    \nwidth\n: 1600\n  }\n}\n\n\n\n\nResponse\n\n\nIf only the metadata has changed (not the content), the response will be a\n204:\n\n\nHTTP/1.1 204 No Content\n\n\n\n\nElse, the content will need to be uploaded:\n\n\nHTTP/1.1 200 OK\nContent-Type: application/json\n\n\n\n\n{\n  \nkey\n: \ndcd478c6-46cf-11e8-9c3f-535468cbce7b\n\n}\n\n\n\n\nPUT /sharings/:sharing-id/io.cozy.files/:key\n\n\nUpload the content of a file (new file or its content has changed since the\nlast synchronization).\n\n\nRequest\n\n\nPUT /sharings/ce8835a061d0ef68947afe69a0046722/io.cozy.files/dcd478c6-46cf-11e8-9c3f-535468cbce7b HTTP/1.1\nHost: bob.example.net\nContent-Type: image/jpeg\nAuthorization: Bearer ...\n\n\n\n\nResponse\n\n\nHTTP/1.1 204 No Content\n\n\n\n\n{% endraw %}", 
            "title": "/sharings - Sharing"
        }, 
        {
            "location": "/cozy-stack/sharing/#sharing", 
            "text": "The owner of a cozy instance can share access to her documents to other users.", 
            "title": "Sharing"
        }, 
        {
            "location": "/cozy-stack/sharing/#sharing-by-links", 
            "text": "A client-side application can propose sharing by links:   The application must have a public route in its manifest. See\n    Apps documentation  for how to do that.  The application can create a set of permissions for the shared documents,\n   with codes. See  permissions documentation  for the details.  The application can then create a shareable link (e.g.\n    https://calendar.cozy.example.net/public?sharecode=eiJ3iepoaihohz1Y ) by\n   putting together the app sub-domain, the public route path, and a code for\n   the permissions set.  The app can then send this link by mail, via the  jobs system , or\n   just give it to the user, so he can transmit it to her friends via chat or\n   other ways.   When someone opens the shared link, the stack will load the public route, find\nthe corresponding  index.html  file, and replace  {{.Token}}  inside it by a\ntoken with the same set of permissions that  sharecode  offers. This token can\nthen be used as a  Bearer  token in the  Authorization  header for requests to\nthe stack (or via cozy-client-js).  If necessary, the application can list the permissions for the token by calling /permissions/self  with this token.", 
            "title": "Sharing by links"
        }, 
        {
            "location": "/cozy-stack/sharing/#cozy-to-cozy-sharing", 
            "text": "The owner of a cozy instance can send and synchronize documents to others cozy\nusers.", 
            "title": "Cozy to cozy sharing"
        }, 
        {
            "location": "/cozy-stack/sharing/#routes", 
            "text": "", 
            "title": "Routes"
        }, 
        {
            "location": "/cozy-stack/sharing/#post-sharings", 
            "text": "Create a new sharing. The sharing rules and recipients must be specified. The description ,  preview_path , and  open_sharing  fields are optional. The app_slug  field is optional and is the slug of the web app by default.", 
            "title": "POST /sharings/"
        }, 
        {
            "location": "/cozy-stack/sharing/#request", 
            "text": "POST /sharings/ HTTP/1.1\nHost: alice.example.net\nContent-Type: application/vnd.api+json  {\n   data : {\n     type :  io.cozy.sharings ,\n     attributes : {\n       description :  sharing test ,\n       preview_path :  /preview-sharing ,\n       rules : [\n        {\n           title :  Hawaii ,\n           doctype :  io.cozy.files ,\n           values : [ 612acf1c-1d72-11e8-b043-ef239d3074dd ],\n           add :  sync ,\n           update :  sync ,\n           remove :  sync \n        }\n      ]\n    },\n     relationships : {\n       recipients : {\n         data : [\n          {\n             id :  2a31ce0128b5f89e40fd90da3f014087 ,\n             type :  io.cozy.contacts \n          }\n        ]\n      }\n    }\n  }\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/sharing/#response", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json  {\n   data : {\n     type :  io.cozy.sharings ,\n     id :  ce8835a061d0ef68947afe69a0046722 ,\n     meta : {\n       rev :  1-4859c6c755143adf0838d225c5e97882 \n    },\n     attributes : {\n       description :  sharing test ,\n       preview_path :  /preview-sharing ,\n       app_slug :  drive ,\n       owner : true,\n       created_at :  2018-01-04T12:35:08Z ,\n       updated_at :  2018-01-04T13:45:43Z ,\n       members : [\n        {\n           status :  owner ,\n           name :  Alice ,\n           email :  alice@example.net ,\n           instance :  alice.example.net \n        },\n        {\n           status :  mail-not-sent ,\n           name :  Bob ,\n           email :  bob@example.net \n        }\n      ],\n       rules : [\n        {\n           title :  Hawaii ,\n           doctype :  io.cozy.files ,\n           values : [ 612acf1c-1d72-11e8-b043-ef239d3074dd ],\n           add :  sync ,\n           update :  sync ,\n           remove :  sync \n        }\n      ]\n    },\n     links : {\n       self :  /sharings/ce8835a061d0ef68947afe69a0046722 \n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/sharing/#get-sharingssharing-iddiscovery", 
            "text": "If no preview_path is set, it s an URL to this route that will be sent to the\nusers to notify them that someone wants to share something with them. On this\npage, they can fill the URL of their Cozy (if the user has already filled its\nCozy URL in a previous sharing, the form will be pre-filled and the user will\njust have to click OK).", 
            "title": "GET /sharings/:sharing-id/discovery"
        }, 
        {
            "location": "/cozy-stack/sharing/#query-string", 
            "text": "Parameter  Description      state  a code that identify the recipient", 
            "title": "Query-String"
        }, 
        {
            "location": "/cozy-stack/sharing/#example", 
            "text": "GET /sharings/ce8835a061d0ef68947afe69a0046722/discovery?state=eiJ3iepoaihohz1Y HTTP/1.1\nHost: alice.example.net", 
            "title": "Example"
        }, 
        {
            "location": "/cozy-stack/sharing/#post-sharingssharing-iddiscovery", 
            "text": "Give to the cozy of the sharer the URL of the Cozy of one recipient. The sharer\nwill register its-self as an OAuth client on the recipient cozy, and then will\nask the recipient to accept the permissions on its instance.  This route exists in two versions, the version is selected by the HTTP header Accept", 
            "title": "POST /sharings/:sharing-id/discovery"
        }, 
        {
            "location": "/cozy-stack/sharing/#classical-x-www-url-encoded", 
            "text": "Parameter  Description      state  a code that identify the recipient    url  the URL of the Cozy for the recipient", 
            "title": "Classical (x-www-url-encoded)"
        }, 
        {
            "location": "/cozy-stack/sharing/#example_1", 
            "text": "POST /sharings/ce8835a061d0ef68947afe69a0046722/discovery HTTP/1.1\nHost: alice.example.org\nContent-Type: application/x-www-form-urlencoded\nAccept: text/html\n\nstate=eiJ3iepoaihohz1Y url=https://bob.example.net/  HTTP/1.1 302 Moved Temporarily\nLocation: https://bob.example.net/auth/sharing?...", 
            "title": "Example"
        }, 
        {
            "location": "/cozy-stack/sharing/#json", 
            "text": "This version can be more convenient for applications that implement the\npreview page. To do that, an application must give a  preview_path  when\ncreating the sharing. This path must be a public route of this application.\nThe recipients will receive a link to the application subdomain, on this page,\nand with a  sharecode  in the query string (like for a share by link).  To know the  sharing-id , it s possible to ask  GET /permissions/self , with\nthe  sharecode  in the  Authorization  header (it s a JWT token). In the\nresponse, the  source_id  field will be  io.cozy.sharings/ sharing-id .", 
            "title": "JSON"
        }, 
        {
            "location": "/cozy-stack/sharing/#parameters", 
            "text": "Parameter  Description      sharecode  a code that identify the recipient    url  the URL of the Cozy for the recipient", 
            "title": "Parameters"
        }, 
        {
            "location": "/cozy-stack/sharing/#example_2", 
            "text": "POST /sharings/ce8835a061d0ef68947afe69a0046722/discovery HTTP/1.1\nHost: alice.example.org\nContent-Type: application/x-www-form-urlencoded\nAccept: application/json\n\nsharecode=eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhcHAiLCJpYXQiOjE1MjAzNDM4NTc url=https://bob.example.net/  HTTP/1.1 200 OK\nContent-Type: application/json  {\n   redirect :  https://bob.example.net/auth/sharing?... \n}", 
            "title": "Example"
        }, 
        {
            "location": "/cozy-stack/sharing/#get-sharingssharing-id", 
            "text": "Get the information about a sharing. This includes the content of the rules, the members, as well as the already shared documents for this sharing.", 
            "title": "GET /sharings/:sharing-id"
        }, 
        {
            "location": "/cozy-stack/sharing/#request_1", 
            "text": "GET /sharings/ce8835a061d0ef68947afe69a0046722 HTTP/1.1\nHost: alice.example.net\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/sharing/#response_1", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json  {\n   data : {\n     type :  io.cozy.sharings ,\n     id :  ce8835a061d0ef68947afe69a0046722 ,\n     meta : {\n       rev :  1-4859c6c755143adf0838d225c5e97882 \n    },\n     attributes : {\n       description :  sharing test ,\n       preview_path :  /preview-sharing ,\n       app_slug :  drive ,\n       owner : true,\n       created_at :  2018-01-04T12:35:08Z ,\n       updated_at :  2018-01-04T13:45:43Z ,\n       members : [\n        {\n           status :  owner ,\n           name :  Alice ,\n           email :  alice@example.net ,\n           instance :  alice.example.net \n        },\n        {\n           status :  ready ,\n           name :  Bob ,\n           email :  bob@example.net \n        }\n      ],\n       rules : [\n        {\n           title :  Hawaii ,\n           doctype :  io.cozy.files ,\n           values : [ 612acf1c-1d72-11e8-b043-ef239d3074dd ],\n           add :  sync ,\n           update :  sync ,\n           remove :  sync \n        }\n      ]\n    },\n     relationships : {\n       shared_docs : {\n         data : [\n          {\n             id :  612acf1c-1d72-11e8-b043-ef239d3074dd ,\n             type :  io.cozy.files \n          },\n          {\n             id :  a34528d2-13fb-9482-8d20-bf1972531225 ,\n             type :  io.cozy.files \n          }\n        ]\n      }\n    },\n     links : {\n       self :  /sharings/ce8835a061d0ef68947afe69a0046722 \n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/sharing/#get-sharingsdoctypedoctype", 
            "text": "Get information about all the sharings that have a rule for the given doctype. This includes the content of the rules, the members, as well as the already shared documents for this sharing.", 
            "title": "GET /sharings/doctype/:doctype"
        }, 
        {
            "location": "/cozy-stack/sharing/#request_2", 
            "text": "GET /sharings/doctype/io.cozy.files HTTP/1.1\nHost: alice.example.net\nAccept: application/vnd.api+json", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/sharing/#response_2", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json  {\n   data : [\n    {\n       type :  io.cozy.sharings ,\n       id :  ce8835a061d0ef68947afe69a0046722 ,\n       attributes : {\n         description :  sharing test ,\n         preview_path :  /preview-sharing ,\n         app_slug :  drive ,\n         owner : true,\n         created_at :  2018-01-04T12:35:08Z ,\n         updated_at :  2018-01-04T13:45:43Z ,\n         members : [\n          {\n             status :  owner ,\n             name :  Alice ,\n             email :  alice@example.net ,\n             instance :  alice.example.net \n          },\n          {\n             status :  ready ,\n             name :  Bob ,\n             email :  bob@example.net \n          }\n        ],\n         rules : [\n          {\n             title :  Hawaii ,\n             doctype :  io.cozy.files ,\n             values : [ 612acf1c-1d72-11e8-b043-ef239d3074dd ],\n             add :  sync ,\n             update :  sync ,\n             remove :  sync \n          }\n        ]\n      },\n       meta : {\n         rev :  1-4859c6c755143adf0838d225c5e97882 \n      },\n       links : {\n         self :  /sharings/ce8835a061d0ef68947afe69a0046722 \n      },\n       relationships : {\n         shared_docs : {\n           data : [\n            {\n               id :  612acf1c-1d72-11e8-b043-ef239d3074dd ,\n               type :  io.cozy.files \n            },\n            {\n               id :  a34528d2-13fb-9482-8d20-bf1972531225 ,\n               type :  io.cozy.files \n            }\n          ]\n        }\n      }\n    },\n    {\n       type :  io.cozy.sharings ,\n       id :  b4e58d039c03d01742085de5e505284e ,\n       attributes : {\n         description :  another sharing test ,\n         preview_path :  /preview-sharing ,\n         app_slug :  drive ,\n         owner : true,\n         created_at :  2018-02-04T12:35:08Z ,\n         updated_at :  2018-02-04T13:45:43Z ,\n         members : [\n          {\n             status :  owner ,\n             name :  Alice ,\n             email :  alice@example.net ,\n             instance :  alice.example.net \n          },\n          {\n             status :  ready ,\n             name :  Bob ,\n             email :  bob@example.net \n          }\n        ],\n         rules : [\n          {\n             title :  Singapore ,\n             doctype :  io.cozy.files ,\n             values : [ e18e30e2-8eda-1bde-afce-edafc6b1a91b ],\n             add :  sync ,\n             update :  sync ,\n             remove :  sync \n          }\n        ]\n      },\n       meta : {\n         rev :  1-7ac5f1252a0c513186a5d35b1a6fd350 \n      },\n       links : {\n         self :  /sharings/b4e58d039c03d01742085de5e505284e \n      },\n       relationships : {\n         shared_docs : {\n           data : [\n            {\n               id :  dcc52bee-1277-a6b3-b36f-369ffd81a4ee ,\n               type :  io.cozy.files \n            }\n          ]\n        }\n      }\n    }\n  ],\n   meta : {\n     count : 3\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/sharing/#put-sharingssharing-id", 
            "text": "The sharer s cozy sends a request to this route on the recipient s cozy to\ncreate a sharing request, with most of the informations about the sharing.\nThese informations will be displayed to the recipient just before its final\nacceptation of the sharing, to be sure he/she knows what will be shared.", 
            "title": "PUT /sharings/:sharing-id"
        }, 
        {
            "location": "/cozy-stack/sharing/#request_3", 
            "text": "PUT /sharings/ce8835a061d0ef68947afe69a0046722 HTTP/1.1\nHost: bob.example.net\nContent-Type: application/vnd.api+json  {\n   data : {\n     type :  io.cozy.sharings ,\n     id :  ce8835a061d0ef68947afe69a0046722 ,\n     attributes : {\n       description :  sharing test ,\n       preview_path :  /preview-sharing ,\n       app_slug :  drive ,\n       owner : true,\n       created_at :  2018-01-04T12:35:08Z ,\n       updated_at :  2018-01-04T13:45:43Z ,\n       members : [\n        {\n           status :  owner ,\n           name :  Alice ,\n           email :  alice@example.net ,\n           instance :  alice.example.net \n        },\n        {\n           status :  mail-not-sent ,\n           name :  Bob ,\n           email :  bob@example.net ,\n           instance :  bob.example.net \n        }\n      ],\n       rules : [\n        {\n           title :  Hawaii ,\n           doctype :  io.cozy.files ,\n           values : [ 612acf1c-1d72-11e8-b043-ef239d3074dd ],\n           add :  sync ,\n           update :  sync ,\n           remove :  sync \n        }\n      ]\n    }\n  }\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/sharing/#response_3", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json  {\n   data : {\n     type :  io.cozy.sharings ,\n     id :  ce8835a061d0ef68947afe69a0046722 ,\n     meta : {\n       rev :  1-f579a69a9fa5dd720010a1dbb82320be \n    },\n     attributes : {\n       description :  sharing test ,\n       preview_path :  /preview-sharing ,\n       app_slug :  drive ,\n       owner : true,\n       created_at :  2018-01-04T12:35:08Z ,\n       updated_at :  2018-01-04T13:45:43Z ,\n       members : [\n        {\n           status :  owner ,\n           name :  Alice ,\n           email :  alice@example.net ,\n           instance :  alice.example.net \n        },\n        {\n           status :  mail-not-sent ,\n           name :  Bob ,\n           email :  bob@example.net ,\n           instance :  bob.example.net \n        }\n      ],\n       rules : [\n        {\n           title :  Hawaii ,\n           doctype :  io.cozy.files ,\n           values : [ 612acf1c-1d72-11e8-b043-ef239d3074dd ],\n           add :  sync ,\n           update :  sync ,\n           remove :  sync \n        }\n      ]\n    },\n     links : {\n       self :  /sharings/ce8835a061d0ef68947afe69a0046722 \n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/sharing/#post-sharingssharing-idanswer", 
            "text": "This route is used by the Cozy of a recipient to exchange credentials with the\nCozy of the sharer, after the recipient has accepted a sharing.", 
            "title": "POST /sharings/:sharing-id/answer"
        }, 
        {
            "location": "/cozy-stack/sharing/#request_4", 
            "text": "POST /sharings/ce8835a061d0ef68947afe69a0046722/answer HTTP/1.1\nHost: alice.example.net\nContent-Type: application/vnd.api+json  {\n   data : {\n     type :  io.cozy.sharings.answer ,\n     id :  ce8835a061d0ef68947afe69a0046722 ,\n     attributes : {\n       state :  eiJ3iepoaihohz1Y ,\n       client : {...},\n       access_token :  uia7b85928e5cf \n    }\n  }\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/sharing/#response_4", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/vnd.api+json  {\n   data : {\n     type :  io.cozy.sharings.answer ,\n     id :  ce8835a061d0ef68947afe69a0046722 ,\n     attributes : {\n       client : {...},\n       access_token :  ui77bd4670fbd3 \n    }\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/sharing/#post-sharingssharing-id95revs_diff", 
            "text": "This endpoint is used by the sharing replicator of the stack to know which\ndocuments must be sent to the other cozy. It is inspired by\nhttp://docs.couchdb.org/en/2.1.1/api/database/misc.html#db-revs-diff.", 
            "title": "POST /sharings/:sharing-id/_revs_diff"
        }, 
        {
            "location": "/cozy-stack/sharing/#request_5", 
            "text": "POST /sharings/ce8835a061d0ef68947afe69a0046722/_revs_diff HTTP/1.1\nHost: bob.example.net\nAccept: application/json\nContent-Type: application/json\nAuthorization: Bearer ...  {\n   io.cozy.files/29631902-2cec-11e8-860d-435b24c2cc58 : [\n     2-4a7e4ae49c4366eaed8edeaea8f784ad \n  ],\n   io.cozy.files/44f5752a-2cec-11e8-b227-abfc3cfd4b6e : [\n     4-2ee767305024673cfb3f5af037cd2729 ,\n     4-efc54218773c6acd910e2e97fea2a608 \n  ]\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/sharing/#response_5", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/json  {\n   io.cozy.files/44f5752a-2cec-11e8-b227-abfc3cfd4b6e : {\n     missing : [ 4-2ee767305024673cfb3f5af037cd2729 ],\n     possible_ancestors : [ 3-753875d51501a6b1883a9d62b4d33f91 ]\n  }\n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/sharing/#post-sharingssharing-id95bulk_docs", 
            "text": "This endpoint is used by the sharing replicator of the stack to send\ndocuments in a bulk to the other cozy. It is inspired by\nhttp://docs.couchdb.org/en/2.1.1/api/database/bulk-api.html#db-bulk-docs.  Note : we force  new_edits  to  false .", 
            "title": "POST /sharings/:sharing-id/_bulk_docs"
        }, 
        {
            "location": "/cozy-stack/sharing/#request_6", 
            "text": "POST /sharings/ce8835a061d0ef68947afe69a0046722/_bulk_docs HTTP/1.1\nHost: bob.example.net\nAccept: application/json\nContent-Type: application/json\nAuthorization: Bearer ...  {\n   io.cozy.files : [\n    {\n       _id :  44f5752a-2cec-11e8-b227-abfc3cfd4b6e ,\n       _rev :  4-2ee767305024673cfb3f5af037cd2729 ,\n       _revisions : {\n         start : 4,\n         ids : [\n           2ee767305024673cfb3f5af037cd2729 ,\n           753875d51501a6b1883a9d62b4d33f91 \n        ]\n      }\n    }\n  ]\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/sharing/#response_6", 
            "text": "HTTP/1.1 200 OK\nContent-Type: application/json  []", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/sharing/#put-sharingssharing-idiocozyfilesfile-idmetadata", 
            "text": "This is an internal endpoint used by a stack to send the new metadata about a\nfile that has changed.", 
            "title": "PUT /sharings/:sharing-id/io.cozy.files/:file-id/metadata"
        }, 
        {
            "location": "/cozy-stack/sharing/#request_7", 
            "text": "PUT /sharings/ce8835a061d0ef68947afe69a0046722/io.cozy.files/0c1116b028c6ae6f5cdafb949c088265/metadata HTTP/1.1\nHost: bob.example.net\nAccept: application/json\nContent-Type: application/json\nAuthorization: Bearer ...  {\n   _id :  4b24ab130b2538b7b444fc65430198ad ,\n   _rev :  1-356bf77c03baa1da851a2be1f06aba81 ,\n   type :  file ,\n   name :  cloudy.jpg ,\n   dir_id :  4b24ab130b2538b7b444fc65430188cd ,\n   created_at :  2018-01-03T16:10:36.885807013+01:00 ,\n   updated_at :  2018-01-03T16:10:36.885807013+01:00 ,\n   size :  84980 ,\n   md5sum :  SuRJOiD/QPwDUpKpQujcVA== ,\n   mime :  image/jpeg ,\n   class :  image ,\n   executable : false,\n   trashed : false,\n   tags : [],\n   metadata : {\n     datetime :  2018-01-03T16:10:36.89118949+01:00 ,\n     extractor_version : 2,\n     height : 1200,\n     width : 1600\n  }\n}", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/sharing/#response_7", 
            "text": "If only the metadata has changed (not the content), the response will be a\n204:  HTTP/1.1 204 No Content  Else, the content will need to be uploaded:  HTTP/1.1 200 OK\nContent-Type: application/json  {\n   key :  dcd478c6-46cf-11e8-9c3f-535468cbce7b \n}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/sharing/#put-sharingssharing-idiocozyfileskey", 
            "text": "Upload the content of a file (new file or its content has changed since the\nlast synchronization).", 
            "title": "PUT /sharings/:sharing-id/io.cozy.files/:key"
        }, 
        {
            "location": "/cozy-stack/sharing/#request_8", 
            "text": "PUT /sharings/ce8835a061d0ef68947afe69a0046722/io.cozy.files/dcd478c6-46cf-11e8-9c3f-535468cbce7b HTTP/1.1\nHost: bob.example.net\nContent-Type: image/jpeg\nAuthorization: Bearer ...", 
            "title": "Request"
        }, 
        {
            "location": "/cozy-stack/sharing/#response_8", 
            "text": "HTTP/1.1 204 No Content  {% endraw %}", 
            "title": "Response"
        }, 
        {
            "location": "/cozy-stack/sharing-design/", 
            "text": "Request for comments about the sharings\n\n\nHypothesis\n\n\n\n\nA sharer may not know the adresses of the recipients\n cozy instances, but\n   he/she has a way to send them an URL on his/her cozy to start the process.\n\n\nA user can preview a sharing before accepting it if the application\n   supports this option. Else, he/she will have only the description and rules to\n   make his/her mind about accepting or refusing the sharing.\n\n\nThe data is duplicated: it is both on the owner\ns cozy, and on the\n   recipients\n cozy (no cloud federation like NextCloud).\n\n\nThe applications say what is shared, the stack synchronizes that. The stack\n   does the low-level stuff and gives primitives to the applications. The\n   applications must use them in a responsible manner, and in particular, to\n   avoid transitivity issues.\n\n\nThe CouchDB replication will be used to synchronize the documents. It means\n   that the documents will be same on the owner and on the recipients (\nsymetric\n   sharing\n).\n\n\nFor files and folders, the replicator will be customized to handle the\n   specificities of the \nio.cozy.files\n doctype.\n\n\nThe applications must be able to work with broken relationships between\n   documents.\n\n\nThe applications should know how to deal with CouchDB conflicts. At least,\n   the default choice of a winner for conflicts by CouchDB should be acceptable\n   if the applications don\nt do anything to detect and resolve conflicts.\n\n\nFirst safety principle: when a user B accepts a sharing from user A, the\n   documents that were on the user B\ns cozy before the sharing are not sent to\n   user A without an explicit action of user B (like moving a file to a shared\n   directory).\n\n\nSecond safety principle: when two users, A and B, are sharing documents,\n    a change of a document on the user A\ns cozy can\nt make an exiting document of\n    user B enter in the sharing.\n\n\n\n\nSetup of a sharing\n\n\nStep 1: the owner creates the sharing\n\n\nOne person decides to share something with other people from an application on\nher cozy. In our example, Alice wants to share a todo list with her friends, Bob\nand Charlie, and it is done from the \nTodo\n application. The application calls\nthe stack with the rules for this sharing and the identifiers of the contacts\nwith whom to share. The stack persists an \nio.cozy.sharings\n document and sends\nan email to the recipients (Bob an Charlie).\n\n\nStep 2: a recipient accepts the sharing\n\n\nA recipient, let\u2019s say Bob, receives the email and clicks on the link. His\nbrowser shows him the \nTodo\n application on Alice\u2019s Cozy so that he can preview\nthe todo list, and a modal asks him if he wants to continue the sharing\nacceptation workflow. If he does, a form will ask him what is the address of his\nCozy (the form can be pre-filled if he has already accepted another sharing in\nthe past). After he has filled the form and submitted it, he is redirected on\nhis Cozy. If he is not logged in, he has to login first. Then, a page describes\nhim how the sharing will work and what technical permissions it implies. It also\nasks him to confirm the sharing. If he accepts, his instance will send to\nAlice\u2019s instance the answer.\n\n\nStep 3: the initial replication starts\n\n\nAlice\u2019s Cozy instance creates token and sends them with other informations as the\nresponse of the answer request from Bob\u2019s instance. At this moment, both\ninstances are ready to start to replicate data to the other instances. So, let\u2019s\ndo the initial replication.\n\n\nAlice\u2019s instance starts to fill the \nio.cozy.shared\n database with all the\ndocuments that match a rule of the sharing (except the rules with \nlocal: true\n), and create triggers for the future documents to be also added in this\ndatabase (the exact triggers depend of the parameters of the rules). And, when\ndone, it creates a job for the replicator, and setups a trigger for future\nchanges in the \nio.cozy.shared\n start a replicator job.\n\n\nBob\u2019s instance also checks if any document matches a sharing rule. In most\ncases, it won\u2019t. But in some very special cases (e.g. a previous revoked sharing\non the same documents), there are some documents that match a rule. They are\nadded to the \nio.cozy.shared\n database, but with a \nconflict\n flag. They won\u2019t\nbe replicated unless Bob accepts to in his \nTodo\n application. Triggers are also\nadded on Bob\u2019s instance for filling the \nio.cozy.shared\n database, and to call\nthe replicator after that.\n\n\nNote:\n there will be a lock around the initial filling of the\n\nio.cozy.shared\n database to avoid concurrency issues if two recipients accept\nthe sharing at the same time.\n\n\nWorkflow\n\n\n\n\nStep 1:\n a todo item is added on Bob\u2019s Cozy, a trigger is fired and it adds\nthe new document to the \nio.cozy.shared\n database\n\n\nStep 2:\n a debounced trigger on the \nio.cozy.shared\n database is used to\nstart a replicator\n\n\nStep 3:\n the replicator does the following steps\n\n\n\n\nit queries a local document of the \nio.cozy.shared\n database to get the last\n  sequence number of a successful replication\n\n\nwith this sequence number, it requests the changes feed of \nio.cozy.shared\n\n  with a filter on the sharing id\n\n\nthe results is a list of document doctype + id + rev that is sent to Alice\u2019s\n  Cozy\n\n\nAlice\u2019s Cozy checks which revisions are known, and send a response with the\n  list of those that are not\n\n\nfor each not known revision, Bob\u2019s Cozy send the document to Alice\u2019s Cozy (in\n  bulk)\n\n\nand, if it\u2019s all good, it persists the new sequence number in the local\n  document, as a start point for the next replication\n\n\n\n\nStep 4:\n the changes are put in the \nio.cozy.shared\n database on Alice\u2019s Cozy\n\n\nStep 5:\n it starts a replicator on Alice\u2019s Cozy\n\n\nStep 6:\n the replicator send the changes to Charlie\u2019s Cozy, all the cozy\ninstances are synchronized again!\n\n\nNote:\n when a todo item is moved fron a shared todo list to a not shared todo\nlist, the document in \nio.cozy.shared\n for the todo item is kept, and the\nsharing id is associated to the keyword \nremoved\n inside it. The \nremove\n\nbehavior of the sharing rule is then applied.\n\n\nFiles and folders\n\n\nWhy are they special?\n\n\nFiles are special for several reasons. First and foremost, they have a binary\nattached to them that can be quite heavy. The stack also enforces some rules on\nthem (e.g. a file can\u2019t be added to a deleted folder) and has some specific code\nfor the tree nature of files and folders (e.g. a permission on a folder is\ninherited on all the files and folders inside it, even if they are several\nlevels below). Thus, the workflow explained just before is not compatible with\nthe files.\n\n\nAs we need to introduce some code specific to the files, we have also wanted to\nimprove the sharing of files. First, we don\u2019t want to force the recipients to\nput the shared folder at exactly the same place as the owner. In fact, we think\nthat putting the shared folder in a folder called \nShared with me\n is more\nfriendly. We also think that a file that has been shared in the past but is no\nlonger (the sharing has been revoked) can evolve on both the owner\u2019s cozy and on\nthe recipients\u2019 cozy in different ways, and in such a case, it\u2019s more logical to\nconsider them as different files. These two reasons implies, on a technical\nlevel, that the identifiers for files and folders are not the same on the owner\nand the recipients of a sharing. The replicator will translate the identifiers\nfrom one system to another during the replications. Of course, it will also\ntranslate the \nid\n in the sharing rules, and the \ndir_id\n to preserve the\nrelationship between a file and its parent folder. The \npath\n attribute will be\nseen as a cache, and recomputed when a cozy instance receives a folder document\nfrom a sharing replication.\n\n\nWe will continue to have a replication as close to the CouchDB replication as\npossible. It means we synchronize a state, and not looking for the history of\noperations like cozy-desktop does. It is less accurate and can lead more often\nto conflicts. The cozy instances are expected to be online most of the time and\nhave a short delay for replications: we think that the conflicts will happen\nonly on rares occasions. This make acceptable to take this shortcut. And, in\ncase of conflicts, we will preserve the content of the files (no data loss),\neven if it means duplicating the files.\n\n\nHow a sharing involving files works?\n\n\nWhen a sharing involves a rule on the \nio.cozy.files\n doctype, a folder is\ncreated on the recipients cozy where the files will be put. It is created inside\nthe \nShared with me\n folder by default, but can be moved somewhere else after\nthat. The folder won\u2019t be synchronized its-self later, and if the folder is\ntrashed, the sharing is automatically revoked. As it is not a reversible action,\na confirmation is asked before doing that.\n\n\nNote:\n we will forbid the sharing of the root of the virtual file system, of\nthe trash and trashed files/folders, and of the \nShared with me\n folder.\n\n\nThe step 3 described above, aka the replicator, will be more complicated for\nfolders and files. First change, it will work on two phases: 1. what can be\nsynchronized without transfering the binaries first, and 2. the synchronization\nof files with a binary attached. Second change, the replicator will acquire the\nVirtual File System lock on the cozy instance where it will write things to\nensure the consistency of what it writes. Third change, before inserting a\nfolder or file in the database, the replicator checks that its parent exists,\nand if it\u2019s not the case, it creates it. Last change, we will avoid CouchDB\nconflicts for files and folder by using a special conflict resolution process.\n\n\nConflict resolution\n\n\nWe have several cases of conflicts:\n\n\n\n\nWhen two cozy instances have modified the same file concurrently\n\n\nSame for a folder\n\n\nWhen two files or folders are renamed concurrently to the same name inside\n   the same directory\n\n\nWhen a file or folder is created or updated on cozy instance while the parent\n   directory is trashed concurrently on another cozy instance.\n\n\n\n\nFor 1. and 2., we will reconciliate the changes except for a file with two\nversions having a distinct binary (we rely on \nsize\n and \nchecksum\n to detect\nthat). In such a case, we create a copy of the file with one version, while\nkeeping the other version in the original file. Else, the reconciliation rules\nare:\n\n\n\n\nname\n, \ndir_id\n and \nmetadata\n: we keep those of the CouchDB winner\n\n\ntrashed\n and \nexecutable\n: false wins\n\n\nupdated_at\n: the most recent date wins\n\n\nmime\n and \nclass\n: the last in alphabetical order wins (to avoid the default\n  \napplication/octet-steam\n)\n\n\ntags\n and \nreferenced_by\n: a union of the two versions is made\n\n\n\n\nFor 3., we rename the file or folder with the later \nupdated_at\n.\n\n\nFor 4., if a new directory with the same path that the trashed parent has been\ncreated, we will use it as the new parent for the created/updated files/folders.\nElse, we restore the trashed parent.\n\n\nSchema\n\n\nDescription of a sharing\n\n\n\n\nAn identifier (the same for all members of the sharing)\n\n\nA list of \nmembers\n. The first one is the owner. For each member,\n  we have the URL of the cozy, a public name, an email, a status and some\n  credentials to authorize the transfer of data between the owner and the\n  recipients\n\n\nA \ndescription\n (one sentence that will help people understand what is shared\n  and why)\n\n\na flag \nopen_sharing\n:\n\n\ntrue\n if any member of the sharing can add a new recipient\n\n\nfalse\n if only the owner can add a new recipient\n\n\nSome technical data (\ncreated_at\n, \nupdated_at\n, \napp_slug\n, \npreview_path\n)\n\n\nA list of sharing \nrules\n, each rule being composed of:\n\n\na \ntitle\n, that will be displayed to the recipients before they accept the\n    sharing\n\n\na \ndoctype\n\n\na \nselector\n (by default, it\u2019s the \nid\n) and \nvalues\n (one identifier, a\n    list of identifiers, files and folders inside a folder, files that are\n    referenced by the same document, documents bound to a previous sharing rule)\n\n\nlocal\n: by default \nfalse\n, but it can false \ntrue\n for documents that are\n    useful for the preview page but doesn\u2019t need to be send to the recipients\n    (e.g. a setting document of the application)\n\n\nadd\n: a behavior when a new document matches this rule (the document is\n    created, or it was a document that didn\u2019t match the rule and is modified and\n    the new version matches the rule):\n\n\nnone\n: the updates are never propagated (the default)\n\n\npush\n: the updates made on the owner are sent to the recipients\n\n\nsync\n: the updates on any member are propagated to the other members\n\n\n\n\n\n\nupdate\n: a behavior when a document matched by this rule is modified. Can be:\n\n\nnone\n: the updates are never propagated (the default)\n\n\npush\n: the updates made on the owner are sent to the recipients\n\n\nsync\n: the updates on any member are propagated to the other members\n\n\n\n\n\n\nremove\n: a behavior when a document no longer matches this rule (the\n    document is deleted, or it was a document that matched the rule, and is\n    modified and the new version doesn\u2019t match the rule):\n\n\nnone\n: the updates are never propagated (the default)\n\n\npush\n: the updates made on the owner are sent to the recipients\n\n\nsync\n: the updates on any member are propagated to the other members\n\n\nrevoke\n: the sharing is revoked.\n\n\n\n\n\n\n\n\nExample: I want to share a folder in read/write mode\n\n\n\n\nrule 1\n\n\ntitle: \nfolder\n\n\ndoctype: \nio.cozy.files\n\n\nvalues: \n\"ca527016-0d83-11e8-a580-3b965c80c7f7\"\n\n\nadd: \nsync\n\n\nupdate: \nsync\n\n\nremove: \nsync\n\n\n\n\nExample: I want to share a playlist where I\u2019m the only one that can add and remove items\n\n\n\n\nrule 1\n\n\ntitle: \nplaylist\n\n\ndoctype: \nio.cozy.music.playlists\n\n\nvalues: \n\"99445b14-0d84-11e8-ae72-4b96fcbf0552\"\n\n\nupdate: \nnone\n\n\nremove: \nrevoke\n\n\nrule 2\n\n\ntitle: \nitems\n\n\ndoctype: \nio.cozy.files\n\n\nselector: \nreferenced_by\n\n\nvalues: \n\"io.cozy.files/ca527016-0d83-11e8-a580-3b965c80c7f7\"\n\n\nadd: \npush\n\n\nupdate: \nnone\n\n\nremove: \npush\n\n\n\n\nio.cozy.shared\n\n\n\n\n_id\n: its identifier is the doctype and id of the referenced objet, separated by\n  a \n/\n (e.g. \nio.cozy.contacts/c1f5dae4-0d87-11e8-b91b-1f41c005768b\n)\n\n\n_rev\n: the CouchDB default revision for this document (not very meaningful,\n  it\u2019s here to avoid concurrency issues)\n\n\nrevisions\n: an array with the last known \n_rev\ns of the referenced object (for\n  conflicts, we put\n  \nthe winner\n)\n\n\ninfos\n, a map of sharing ids \u2192 \n{rule, removed, binary}\n\n\nrule\n says which rule from the sharing must be applied for this document\n\n\nremoved\n will be true for a deleted document, a trashed file, or if the\n    document does no longer match the sharing rule\n\n\nbinary\n is a boolean flag that is true only for files (and not even\n    folders) with \nremoved: false", 
            "title": "Request for comments"
        }, 
        {
            "location": "/cozy-stack/sharing-design/#request-for-comments-about-the-sharings", 
            "text": "", 
            "title": "Request for comments about the sharings"
        }, 
        {
            "location": "/cozy-stack/sharing-design/#hypothesis", 
            "text": "A sharer may not know the adresses of the recipients  cozy instances, but\n   he/she has a way to send them an URL on his/her cozy to start the process.  A user can preview a sharing before accepting it if the application\n   supports this option. Else, he/she will have only the description and rules to\n   make his/her mind about accepting or refusing the sharing.  The data is duplicated: it is both on the owner s cozy, and on the\n   recipients  cozy (no cloud federation like NextCloud).  The applications say what is shared, the stack synchronizes that. The stack\n   does the low-level stuff and gives primitives to the applications. The\n   applications must use them in a responsible manner, and in particular, to\n   avoid transitivity issues.  The CouchDB replication will be used to synchronize the documents. It means\n   that the documents will be same on the owner and on the recipients ( symetric\n   sharing ).  For files and folders, the replicator will be customized to handle the\n   specificities of the  io.cozy.files  doctype.  The applications must be able to work with broken relationships between\n   documents.  The applications should know how to deal with CouchDB conflicts. At least,\n   the default choice of a winner for conflicts by CouchDB should be acceptable\n   if the applications don t do anything to detect and resolve conflicts.  First safety principle: when a user B accepts a sharing from user A, the\n   documents that were on the user B s cozy before the sharing are not sent to\n   user A without an explicit action of user B (like moving a file to a shared\n   directory).  Second safety principle: when two users, A and B, are sharing documents,\n    a change of a document on the user A s cozy can t make an exiting document of\n    user B enter in the sharing.", 
            "title": "Hypothesis"
        }, 
        {
            "location": "/cozy-stack/sharing-design/#setup-of-a-sharing", 
            "text": "", 
            "title": "Setup of a sharing"
        }, 
        {
            "location": "/cozy-stack/sharing-design/#step-1-the-owner-creates-the-sharing", 
            "text": "One person decides to share something with other people from an application on\nher cozy. In our example, Alice wants to share a todo list with her friends, Bob\nand Charlie, and it is done from the  Todo  application. The application calls\nthe stack with the rules for this sharing and the identifiers of the contacts\nwith whom to share. The stack persists an  io.cozy.sharings  document and sends\nan email to the recipients (Bob an Charlie).", 
            "title": "Step 1: the owner creates the sharing"
        }, 
        {
            "location": "/cozy-stack/sharing-design/#step-2-a-recipient-accepts-the-sharing", 
            "text": "A recipient, let\u2019s say Bob, receives the email and clicks on the link. His\nbrowser shows him the  Todo  application on Alice\u2019s Cozy so that he can preview\nthe todo list, and a modal asks him if he wants to continue the sharing\nacceptation workflow. If he does, a form will ask him what is the address of his\nCozy (the form can be pre-filled if he has already accepted another sharing in\nthe past). After he has filled the form and submitted it, he is redirected on\nhis Cozy. If he is not logged in, he has to login first. Then, a page describes\nhim how the sharing will work and what technical permissions it implies. It also\nasks him to confirm the sharing. If he accepts, his instance will send to\nAlice\u2019s instance the answer.", 
            "title": "Step 2: a recipient accepts the sharing"
        }, 
        {
            "location": "/cozy-stack/sharing-design/#step-3-the-initial-replication-starts", 
            "text": "Alice\u2019s Cozy instance creates token and sends them with other informations as the\nresponse of the answer request from Bob\u2019s instance. At this moment, both\ninstances are ready to start to replicate data to the other instances. So, let\u2019s\ndo the initial replication.  Alice\u2019s instance starts to fill the  io.cozy.shared  database with all the\ndocuments that match a rule of the sharing (except the rules with  local: true ), and create triggers for the future documents to be also added in this\ndatabase (the exact triggers depend of the parameters of the rules). And, when\ndone, it creates a job for the replicator, and setups a trigger for future\nchanges in the  io.cozy.shared  start a replicator job.  Bob\u2019s instance also checks if any document matches a sharing rule. In most\ncases, it won\u2019t. But in some very special cases (e.g. a previous revoked sharing\non the same documents), there are some documents that match a rule. They are\nadded to the  io.cozy.shared  database, but with a  conflict  flag. They won\u2019t\nbe replicated unless Bob accepts to in his  Todo  application. Triggers are also\nadded on Bob\u2019s instance for filling the  io.cozy.shared  database, and to call\nthe replicator after that.  Note:  there will be a lock around the initial filling of the io.cozy.shared  database to avoid concurrency issues if two recipients accept\nthe sharing at the same time.", 
            "title": "Step 3: the initial replication starts"
        }, 
        {
            "location": "/cozy-stack/sharing-design/#workflow", 
            "text": "Step 1:  a todo item is added on Bob\u2019s Cozy, a trigger is fired and it adds\nthe new document to the  io.cozy.shared  database  Step 2:  a debounced trigger on the  io.cozy.shared  database is used to\nstart a replicator  Step 3:  the replicator does the following steps   it queries a local document of the  io.cozy.shared  database to get the last\n  sequence number of a successful replication  with this sequence number, it requests the changes feed of  io.cozy.shared \n  with a filter on the sharing id  the results is a list of document doctype + id + rev that is sent to Alice\u2019s\n  Cozy  Alice\u2019s Cozy checks which revisions are known, and send a response with the\n  list of those that are not  for each not known revision, Bob\u2019s Cozy send the document to Alice\u2019s Cozy (in\n  bulk)  and, if it\u2019s all good, it persists the new sequence number in the local\n  document, as a start point for the next replication   Step 4:  the changes are put in the  io.cozy.shared  database on Alice\u2019s Cozy  Step 5:  it starts a replicator on Alice\u2019s Cozy  Step 6:  the replicator send the changes to Charlie\u2019s Cozy, all the cozy\ninstances are synchronized again!  Note:  when a todo item is moved fron a shared todo list to a not shared todo\nlist, the document in  io.cozy.shared  for the todo item is kept, and the\nsharing id is associated to the keyword  removed  inside it. The  remove \nbehavior of the sharing rule is then applied.", 
            "title": "Workflow"
        }, 
        {
            "location": "/cozy-stack/sharing-design/#files-and-folders", 
            "text": "", 
            "title": "Files and folders"
        }, 
        {
            "location": "/cozy-stack/sharing-design/#why-are-they-special", 
            "text": "Files are special for several reasons. First and foremost, they have a binary\nattached to them that can be quite heavy. The stack also enforces some rules on\nthem (e.g. a file can\u2019t be added to a deleted folder) and has some specific code\nfor the tree nature of files and folders (e.g. a permission on a folder is\ninherited on all the files and folders inside it, even if they are several\nlevels below). Thus, the workflow explained just before is not compatible with\nthe files.  As we need to introduce some code specific to the files, we have also wanted to\nimprove the sharing of files. First, we don\u2019t want to force the recipients to\nput the shared folder at exactly the same place as the owner. In fact, we think\nthat putting the shared folder in a folder called  Shared with me  is more\nfriendly. We also think that a file that has been shared in the past but is no\nlonger (the sharing has been revoked) can evolve on both the owner\u2019s cozy and on\nthe recipients\u2019 cozy in different ways, and in such a case, it\u2019s more logical to\nconsider them as different files. These two reasons implies, on a technical\nlevel, that the identifiers for files and folders are not the same on the owner\nand the recipients of a sharing. The replicator will translate the identifiers\nfrom one system to another during the replications. Of course, it will also\ntranslate the  id  in the sharing rules, and the  dir_id  to preserve the\nrelationship between a file and its parent folder. The  path  attribute will be\nseen as a cache, and recomputed when a cozy instance receives a folder document\nfrom a sharing replication.  We will continue to have a replication as close to the CouchDB replication as\npossible. It means we synchronize a state, and not looking for the history of\noperations like cozy-desktop does. It is less accurate and can lead more often\nto conflicts. The cozy instances are expected to be online most of the time and\nhave a short delay for replications: we think that the conflicts will happen\nonly on rares occasions. This make acceptable to take this shortcut. And, in\ncase of conflicts, we will preserve the content of the files (no data loss),\neven if it means duplicating the files.", 
            "title": "Why are they special?"
        }, 
        {
            "location": "/cozy-stack/sharing-design/#how-a-sharing-involving-files-works", 
            "text": "When a sharing involves a rule on the  io.cozy.files  doctype, a folder is\ncreated on the recipients cozy where the files will be put. It is created inside\nthe  Shared with me  folder by default, but can be moved somewhere else after\nthat. The folder won\u2019t be synchronized its-self later, and if the folder is\ntrashed, the sharing is automatically revoked. As it is not a reversible action,\na confirmation is asked before doing that.  Note:  we will forbid the sharing of the root of the virtual file system, of\nthe trash and trashed files/folders, and of the  Shared with me  folder.  The step 3 described above, aka the replicator, will be more complicated for\nfolders and files. First change, it will work on two phases: 1. what can be\nsynchronized without transfering the binaries first, and 2. the synchronization\nof files with a binary attached. Second change, the replicator will acquire the\nVirtual File System lock on the cozy instance where it will write things to\nensure the consistency of what it writes. Third change, before inserting a\nfolder or file in the database, the replicator checks that its parent exists,\nand if it\u2019s not the case, it creates it. Last change, we will avoid CouchDB\nconflicts for files and folder by using a special conflict resolution process.", 
            "title": "How a sharing involving files works?"
        }, 
        {
            "location": "/cozy-stack/sharing-design/#conflict-resolution", 
            "text": "We have several cases of conflicts:   When two cozy instances have modified the same file concurrently  Same for a folder  When two files or folders are renamed concurrently to the same name inside\n   the same directory  When a file or folder is created or updated on cozy instance while the parent\n   directory is trashed concurrently on another cozy instance.   For 1. and 2., we will reconciliate the changes except for a file with two\nversions having a distinct binary (we rely on  size  and  checksum  to detect\nthat). In such a case, we create a copy of the file with one version, while\nkeeping the other version in the original file. Else, the reconciliation rules\nare:   name ,  dir_id  and  metadata : we keep those of the CouchDB winner  trashed  and  executable : false wins  updated_at : the most recent date wins  mime  and  class : the last in alphabetical order wins (to avoid the default\n   application/octet-steam )  tags  and  referenced_by : a union of the two versions is made   For 3., we rename the file or folder with the later  updated_at .  For 4., if a new directory with the same path that the trashed parent has been\ncreated, we will use it as the new parent for the created/updated files/folders.\nElse, we restore the trashed parent.", 
            "title": "Conflict resolution"
        }, 
        {
            "location": "/cozy-stack/sharing-design/#schema", 
            "text": "", 
            "title": "Schema"
        }, 
        {
            "location": "/cozy-stack/sharing-design/#description-of-a-sharing", 
            "text": "An identifier (the same for all members of the sharing)  A list of  members . The first one is the owner. For each member,\n  we have the URL of the cozy, a public name, an email, a status and some\n  credentials to authorize the transfer of data between the owner and the\n  recipients  A  description  (one sentence that will help people understand what is shared\n  and why)  a flag  open_sharing :  true  if any member of the sharing can add a new recipient  false  if only the owner can add a new recipient  Some technical data ( created_at ,  updated_at ,  app_slug ,  preview_path )  A list of sharing  rules , each rule being composed of:  a  title , that will be displayed to the recipients before they accept the\n    sharing  a  doctype  a  selector  (by default, it\u2019s the  id ) and  values  (one identifier, a\n    list of identifiers, files and folders inside a folder, files that are\n    referenced by the same document, documents bound to a previous sharing rule)  local : by default  false , but it can false  true  for documents that are\n    useful for the preview page but doesn\u2019t need to be send to the recipients\n    (e.g. a setting document of the application)  add : a behavior when a new document matches this rule (the document is\n    created, or it was a document that didn\u2019t match the rule and is modified and\n    the new version matches the rule):  none : the updates are never propagated (the default)  push : the updates made on the owner are sent to the recipients  sync : the updates on any member are propagated to the other members    update : a behavior when a document matched by this rule is modified. Can be:  none : the updates are never propagated (the default)  push : the updates made on the owner are sent to the recipients  sync : the updates on any member are propagated to the other members    remove : a behavior when a document no longer matches this rule (the\n    document is deleted, or it was a document that matched the rule, and is\n    modified and the new version doesn\u2019t match the rule):  none : the updates are never propagated (the default)  push : the updates made on the owner are sent to the recipients  sync : the updates on any member are propagated to the other members  revoke : the sharing is revoked.", 
            "title": "Description of a sharing"
        }, 
        {
            "location": "/cozy-stack/sharing-design/#example-i-want-to-share-a-folder-in-readwrite-mode", 
            "text": "rule 1  title:  folder  doctype:  io.cozy.files  values:  \"ca527016-0d83-11e8-a580-3b965c80c7f7\"  add:  sync  update:  sync  remove:  sync", 
            "title": "Example: I want to share a folder in read/write mode"
        }, 
        {
            "location": "/cozy-stack/sharing-design/#example-i-want-to-share-a-playlist-where-im-the-only-one-that-can-add-and-remove-items", 
            "text": "rule 1  title:  playlist  doctype:  io.cozy.music.playlists  values:  \"99445b14-0d84-11e8-ae72-4b96fcbf0552\"  update:  none  remove:  revoke  rule 2  title:  items  doctype:  io.cozy.files  selector:  referenced_by  values:  \"io.cozy.files/ca527016-0d83-11e8-a580-3b965c80c7f7\"  add:  push  update:  none  remove:  push", 
            "title": "Example: I want to share a playlist where I\u2019m the only one that can add and remove items"
        }, 
        {
            "location": "/cozy-stack/sharing-design/#iocozyshared", 
            "text": "_id : its identifier is the doctype and id of the referenced objet, separated by\n  a  /  (e.g.  io.cozy.contacts/c1f5dae4-0d87-11e8-b91b-1f41c005768b )  _rev : the CouchDB default revision for this document (not very meaningful,\n  it\u2019s here to avoid concurrency issues)  revisions : an array with the last known  _rev s of the referenced object (for\n  conflicts, we put\n   the winner )  infos , a map of sharing ids \u2192  {rule, removed, binary}  rule  says which rule from the sharing must be applied for this document  removed  will be true for a deleted document, a trashed file, or if the\n    document does no longer match the sharing rule  binary  is a boolean flag that is true only for files (and not even\n    folders) with  removed: false", 
            "title": "io.cozy.shared"
        }, 
        {
            "location": "/konitor/cli/", 
            "text": "Manpages of the command-line tool\n\n\nTable of Contents\n\n\n\n\nkonitor\n or \nkonitor interactive\n\n\nkonitor pulls\n\n\nkonitor test trainline\n\n\nkonitor testit ../trainline\n\n\n\n\n\n\nInteractive\n\n\n\n\nTo launch konitor with interactive mode, so it ask you what do you want to do.\n\n\n\n\nHelp\n\n\n$ konitor interactive --help\n\n _                      _   _\n| | __   ___    _ __   (_) | |_    ___    _ __\n| |/ /  / _ \\  | '_ \\  | | | __|  / _ \\  | '__|\n|   \n  | (_) | | | | | | | | |_  | (_) | | |\n|_|\\_\\  \\___/  |_| |_| |_|  \\__|  \\___/  |_|\n\nvX.X.X\n\nkonitor interactive\n\nLaunch interactive mode\n\nOptions:\n--help     Show help                                                 [boolean]\n--version  Show version number                                       [boolean]\n\n\n\n\nExample\n\n\n _                      _   _\n| | __   ___    _ __   (_) | |_    ___    _ __\n| |/ /  / _ \\  | '_ \\  | | | __|  / _ \\  | '__|\n|   \n  | (_) | | | | | | | | |_  | (_) | | |\n|_|\\_\\  \\___/  |_| |_| |_|  \\__|  \\___/  |_|\n\nvX.X.X\n\n? What do you want to do? (Use arrow keys)\n\u276f Test a konnector\nPull all konnectors\nQuit\n\n\n\n\n\n\nPulls\n\n\n\n\nPulls all konnectors into ${XDG_CONFIG_HOME:-~/.config}/configstore/konitor/ \n\n\n\n\nHelp\n\n\n$ konitor pulls --help\n\n _                      _   _\n| | __   ___    _ __   (_) | |_    ___    _ __\n| |/ /  / _ \\  | '_ \\  | | | __|  / _ \\  | '__|\n|   \n  | (_) | | | | | | | | |_  | (_) | | |\n|_|\\_\\  \\___/  |_| |_| |_|  \\__|  \\___/  |_|\n\nvX.X.X\n\nkonitor pulls\n\nPull all konnectors\n\nOptions:\n--help     Show help                                                 [boolean]\n--version  Show version number                                       [boolean]\n\n\n\n\nExample\n\n\n$ konitor pulls\n\n  _                      _   _\n | | __   ___    _ __   (_) | |_    ___    _ __\n | |/ /  / _ \\  | '_ \\  | | | __|  / _ \\  | '__|\n |   \n  | (_) | | | | | | | | |_  | (_) | | |\n |_|\\_\\  \\___/  |_| |_| |_|  \\__|  \\___/  |_|\n\n vX.X.X\n\nPull all konnectors:\n\n - \u2705  cozy-konnector-ameli: {\nchanges\n:0,\ninsertions\n:0,\ndeletions\n:0}\n - \u2705  cozy-konnector-bouyguesbox: {\nchanges\n:0,\ninsertions\n:0,\ndeletions\n:0}\n - \u2705  cozy-konnector-bouyguestelecom: {\nchanges\n:0,\ninsertions\n:0,\ndeletions\n:0}\n - \u2705  cozy-konnector-digiposte: {\nchanges\n:0,\ninsertions\n:0,\ndeletions\n:0}\n - \u2705  cozy-konnector-free: {\nchanges\n:0,\ninsertions\n:0,\ndeletions\n:0}\n - \u2705  cozy-konnector-free-mobile: {\nchanges\n:2,\ninsertions\n:53,\ndeletions\n:5}\n - \u2705  cozy-konnector-harmonie: {\nchanges\n:0,\ninsertions\n:0,\ndeletions\n:0}\n - \u2705  cozy-konnector-maif: {\nchanges\n:0,\ninsertions\n:0,\ndeletions\n:0}\n - \u2705  cozy-konnector-malakoffmederic: {\nchanges\n:0,\ninsertions\n:0,\ndeletions\n:0}\n - \u2705  cozy-konnector-materielnet: {\nchanges\n:0,\ninsertions\n:0,\ndeletions\n:0}\n - \u2705  cozy-konnector-mgen: {\nchanges\n:1,\ninsertions\n:13,\ndeletions\n:9}\n - \u2705  cozy-konnector-numericable: {\nchanges\n:0,\ninsertions\n:0,\ndeletions\n:0}\n - \u2705  cozy-konnector-orange: {\nchanges\n:0,\ninsertions\n:0,\ndeletions\n:0}\n - \u2705  cozy-konnector-orangevod: {\nchanges\n:0,\ninsertions\n:0,\ndeletions\n:0}\n - \u2705  cozy-konnector-sosh: {\nchanges\n:0,\ninsertions\n:0,\ndeletions\n:0}\n - \u2705  cozy-konnector-sfrbox: {\nchanges\n:0,\ninsertions\n:0,\ndeletions\n:0}\n - \u2705  cozy-konnector-sfrmobile: {\nchanges\n:0,\ninsertions\n:0,\ndeletions\n:0}\n - \u2705  cozy-konnector-redbox: {\nchanges\n:0,\ninsertions\n:0,\ndeletions\n:0}\n - \u2705  cozy-konnector-redmobile: {\nchanges\n:0,\ninsertions\n:0,\ndeletions\n:0}\n - \u2705  cozy-konnector-trainline: {\nchanges\n:4,\ninsertions\n:59,\ndeletions\n:6}\n - \u2705  cozy-konnector-uber: {\nchanges\n:0,\ninsertions\n:0,\ndeletions\n:0}\n - \u2705  cozy-konnector-sncf: {\nchanges\n:0,\ninsertions\n:0,\ndeletions\n:0}\n - \u2705  cozy-konnector-virgin-mobile: {\nchanges\n:0,\ninsertions\n:0,\ndeletions\n:0}\n\n\n\n\n\n\nTest\n\n\n\n\nYou can test a konnector with slug or repository name:\n\n\n\n\nkonitor test trainline\n\n\nkonitor test cozy-konnector-trainline\n\n\n\n\n\n\nHelp\n\n\n$ konitor test --help\n\n_                      _   _\n| | __   ___    _ __   (_) | |_    ___    _ __\n| |/ /  / _ \\  | '_ \\  | | | __|  / _ \\  | '__|\n|   \n  | (_) | | | | | | | | |_  | (_) | | |\n|_|\\_\\  \\___/  |_| |_| |_|  \\__|  \\___/  |_|\n\nvX.X.X\n\nkonitor test \nname\n [options]\n\nTest a konnector\n\nOptions:\n--help             Show help                                         [boolean]\n--version          Show version number                               [boolean]\n--config, -c       Path to a config file                      [default: false]\n--interactive, -i  Launch interactive mode                     [default: true]\n\n\n\n\nExample\n\n\n$ konitor test trainline\n\n _                      _   _\n| | __   ___    _ __   (_) | |_    ___    _ __\n| |/ /  / _ \\  | '_ \\  | | | __|  / _ \\  | '__|\n|   \n  | (_) | | | | | | | | |_  | (_) | | |\n|_|\\_\\  \\___/  |_| |_| |_|  \\__|  \\___/  |_|\n\nvX.X.X\n\nTest konnector trainline:\n\n- \u2705  repository is up to date.\n- \u2705  dependencies is installed.\n- \u2705  repository is clean.\n- \u2705  Correctly executed.\n- \u2705  Correctly logged in.\n- \u2705  PDF is imported.\n- \u2705  repository is clean.\n\n\n\n\n\n\ntestit\n\n\n\n\nYou can test a konnector with path\n\n\n\n\nHelp\n\n\n$ konitor testit --help\n\n  _                      _   _\n | | __   ___    _ __   (_) | |_    ___    _ __\n | |/ /  / _ \\  | '_ \\  | | | __|  / _ \\  | '__|\n |   \n  | (_) | | | | | | | | |_  | (_) | | |\n |_|\\_\\  \\___/  |_| |_| |_|  \\__|  \\___/  |_|\n\n vX.X.X\n\nkonitor testit \npath\n [options]\n\nTest from a konnector\n\nOptions:\n  --help             Show help                                         [boolean]\n  --version          Show version number                               [boolean]\n  --config, -c       Path to a config file                      [default: false]\n  --interactive, -i  Launch interactive mode                     [default: true]\n\n\n\n\nExample\n\n\n$ konitor testit ../trainline\n\n _                      _   _\n| | __   ___    _ __   (_) | |_    ___    _ __\n| |/ /  / _ \\  | '_ \\  | | | __|  / _ \\  | '__|\n|   \n  | (_) | | | | | | | | |_  | (_) | | |\n|_|\\_\\  \\___/  |_| |_| |_|  \\__|  \\___/  |_|\n\nvX.X.X\n\nTest konnector trainline:\n\n- \u2705  dependencies is installed.\n- \u2705  repository is clean.\n- \u2705  Correctly executed.\n- \u2705  Correctly logged in.\n- \u2705  PDF is imported.\n- \u2705  repository is clean.\n\n\n\n\ncheck \ud83e\udd13\n\n\nCheck is used to programmatically check our guidelines against a repository. Use it before publishing your konnector for it to be production ready \ud83d\ude80\n\n\nHere is a sample output :\n\n\n$ konitor check ./cozy-konnector-ameli/\n\n## Checking ../cozy-konnector-ameli/\n\n* Eslint with prettier is used to lint the code (check for eslintConfig in package.json) \u274c\n  - eslintConfig should extend from prettier \u274c\n  Check the documentation:  https://github.com/konnectors/docs/blob/master/status.md#linting\n\n* Fields (necessary for login) are defined in manifest.konnector \u274c\n  - The fields should not be in old format \u274c\n\n* Travis is correctly configured to deploy master/prod. \u2705\n\n* Renovate should be correctly configured. \u274c\n  - Renovate config should extend from the cozy-konnector config \u274c\n  Check the documentation:  https://github.com/konnectors/docs/blob/master/status.md#renovate\n\n* Repository should have 4 branches. \u2705\n\n\n\n\nYou can check multiple repositories :\n\n\n$ konitor check ./cozy-konnector-ameli/ ./cozy-konnector-orange/\n...", 
            "title": "CLI"
        }, 
        {
            "location": "/konitor/cli/#manpages-of-the-command-line-tool", 
            "text": "", 
            "title": "Manpages of the command-line tool"
        }, 
        {
            "location": "/konitor/cli/#table-of-contents", 
            "text": "konitor  or  konitor interactive  konitor pulls  konitor test trainline  konitor testit ../trainline", 
            "title": "Table of Contents"
        }, 
        {
            "location": "/konitor/cli/#interactive", 
            "text": "To launch konitor with interactive mode, so it ask you what do you want to do.", 
            "title": "Interactive"
        }, 
        {
            "location": "/konitor/cli/#help", 
            "text": "$ konitor interactive --help\n\n _                      _   _\n| | __   ___    _ __   (_) | |_    ___    _ __\n| |/ /  / _ \\  | '_ \\  | | | __|  / _ \\  | '__|\n|      | (_) | | | | | | | | |_  | (_) | | |\n|_|\\_\\  \\___/  |_| |_| |_|  \\__|  \\___/  |_|\n\nvX.X.X\n\nkonitor interactive\n\nLaunch interactive mode\n\nOptions:\n--help     Show help                                                 [boolean]\n--version  Show version number                                       [boolean]", 
            "title": "Help"
        }, 
        {
            "location": "/konitor/cli/#example", 
            "text": "_                      _   _\n| | __   ___    _ __   (_) | |_    ___    _ __\n| |/ /  / _ \\  | '_ \\  | | | __|  / _ \\  | '__|\n|      | (_) | | | | | | | | |_  | (_) | | |\n|_|\\_\\  \\___/  |_| |_| |_|  \\__|  \\___/  |_|\n\nvX.X.X\n\n? What do you want to do? (Use arrow keys)\n\u276f Test a konnector\nPull all konnectors\nQuit", 
            "title": "Example"
        }, 
        {
            "location": "/konitor/cli/#pulls", 
            "text": "Pulls all konnectors into ${XDG_CONFIG_HOME:-~/.config}/configstore/konitor/", 
            "title": "Pulls"
        }, 
        {
            "location": "/konitor/cli/#help_1", 
            "text": "$ konitor pulls --help\n\n _                      _   _\n| | __   ___    _ __   (_) | |_    ___    _ __\n| |/ /  / _ \\  | '_ \\  | | | __|  / _ \\  | '__|\n|      | (_) | | | | | | | | |_  | (_) | | |\n|_|\\_\\  \\___/  |_| |_| |_|  \\__|  \\___/  |_|\n\nvX.X.X\n\nkonitor pulls\n\nPull all konnectors\n\nOptions:\n--help     Show help                                                 [boolean]\n--version  Show version number                                       [boolean]", 
            "title": "Help"
        }, 
        {
            "location": "/konitor/cli/#example_1", 
            "text": "$ konitor pulls\n\n  _                      _   _\n | | __   ___    _ __   (_) | |_    ___    _ __\n | |/ /  / _ \\  | '_ \\  | | | __|  / _ \\  | '__|\n |      | (_) | | | | | | | | |_  | (_) | | |\n |_|\\_\\  \\___/  |_| |_| |_|  \\__|  \\___/  |_|\n\n vX.X.X\n\nPull all konnectors:\n\n - \u2705  cozy-konnector-ameli: { changes :0, insertions :0, deletions :0}\n - \u2705  cozy-konnector-bouyguesbox: { changes :0, insertions :0, deletions :0}\n - \u2705  cozy-konnector-bouyguestelecom: { changes :0, insertions :0, deletions :0}\n - \u2705  cozy-konnector-digiposte: { changes :0, insertions :0, deletions :0}\n - \u2705  cozy-konnector-free: { changes :0, insertions :0, deletions :0}\n - \u2705  cozy-konnector-free-mobile: { changes :2, insertions :53, deletions :5}\n - \u2705  cozy-konnector-harmonie: { changes :0, insertions :0, deletions :0}\n - \u2705  cozy-konnector-maif: { changes :0, insertions :0, deletions :0}\n - \u2705  cozy-konnector-malakoffmederic: { changes :0, insertions :0, deletions :0}\n - \u2705  cozy-konnector-materielnet: { changes :0, insertions :0, deletions :0}\n - \u2705  cozy-konnector-mgen: { changes :1, insertions :13, deletions :9}\n - \u2705  cozy-konnector-numericable: { changes :0, insertions :0, deletions :0}\n - \u2705  cozy-konnector-orange: { changes :0, insertions :0, deletions :0}\n - \u2705  cozy-konnector-orangevod: { changes :0, insertions :0, deletions :0}\n - \u2705  cozy-konnector-sosh: { changes :0, insertions :0, deletions :0}\n - \u2705  cozy-konnector-sfrbox: { changes :0, insertions :0, deletions :0}\n - \u2705  cozy-konnector-sfrmobile: { changes :0, insertions :0, deletions :0}\n - \u2705  cozy-konnector-redbox: { changes :0, insertions :0, deletions :0}\n - \u2705  cozy-konnector-redmobile: { changes :0, insertions :0, deletions :0}\n - \u2705  cozy-konnector-trainline: { changes :4, insertions :59, deletions :6}\n - \u2705  cozy-konnector-uber: { changes :0, insertions :0, deletions :0}\n - \u2705  cozy-konnector-sncf: { changes :0, insertions :0, deletions :0}\n - \u2705  cozy-konnector-virgin-mobile: { changes :0, insertions :0, deletions :0}", 
            "title": "Example"
        }, 
        {
            "location": "/konitor/cli/#test", 
            "text": "You can test a konnector with slug or repository name:   konitor test trainline  konitor test cozy-konnector-trainline", 
            "title": "Test"
        }, 
        {
            "location": "/konitor/cli/#help_2", 
            "text": "$ konitor test --help\n\n_                      _   _\n| | __   ___    _ __   (_) | |_    ___    _ __\n| |/ /  / _ \\  | '_ \\  | | | __|  / _ \\  | '__|\n|      | (_) | | | | | | | | |_  | (_) | | |\n|_|\\_\\  \\___/  |_| |_| |_|  \\__|  \\___/  |_|\n\nvX.X.X\n\nkonitor test  name  [options]\n\nTest a konnector\n\nOptions:\n--help             Show help                                         [boolean]\n--version          Show version number                               [boolean]\n--config, -c       Path to a config file                      [default: false]\n--interactive, -i  Launch interactive mode                     [default: true]", 
            "title": "Help"
        }, 
        {
            "location": "/konitor/cli/#example_2", 
            "text": "$ konitor test trainline\n\n _                      _   _\n| | __   ___    _ __   (_) | |_    ___    _ __\n| |/ /  / _ \\  | '_ \\  | | | __|  / _ \\  | '__|\n|      | (_) | | | | | | | | |_  | (_) | | |\n|_|\\_\\  \\___/  |_| |_| |_|  \\__|  \\___/  |_|\n\nvX.X.X\n\nTest konnector trainline:\n\n- \u2705  repository is up to date.\n- \u2705  dependencies is installed.\n- \u2705  repository is clean.\n- \u2705  Correctly executed.\n- \u2705  Correctly logged in.\n- \u2705  PDF is imported.\n- \u2705  repository is clean.", 
            "title": "Example"
        }, 
        {
            "location": "/konitor/cli/#testit", 
            "text": "You can test a konnector with path", 
            "title": "testit"
        }, 
        {
            "location": "/konitor/cli/#help_3", 
            "text": "$ konitor testit --help\n\n  _                      _   _\n | | __   ___    _ __   (_) | |_    ___    _ __\n | |/ /  / _ \\  | '_ \\  | | | __|  / _ \\  | '__|\n |      | (_) | | | | | | | | |_  | (_) | | |\n |_|\\_\\  \\___/  |_| |_| |_|  \\__|  \\___/  |_|\n\n vX.X.X\n\nkonitor testit  path  [options]\n\nTest from a konnector\n\nOptions:\n  --help             Show help                                         [boolean]\n  --version          Show version number                               [boolean]\n  --config, -c       Path to a config file                      [default: false]\n  --interactive, -i  Launch interactive mode                     [default: true]", 
            "title": "Help"
        }, 
        {
            "location": "/konitor/cli/#example_3", 
            "text": "$ konitor testit ../trainline\n\n _                      _   _\n| | __   ___    _ __   (_) | |_    ___    _ __\n| |/ /  / _ \\  | '_ \\  | | | __|  / _ \\  | '__|\n|      | (_) | | | | | | | | |_  | (_) | | |\n|_|\\_\\  \\___/  |_| |_| |_|  \\__|  \\___/  |_|\n\nvX.X.X\n\nTest konnector trainline:\n\n- \u2705  dependencies is installed.\n- \u2705  repository is clean.\n- \u2705  Correctly executed.\n- \u2705  Correctly logged in.\n- \u2705  PDF is imported.\n- \u2705  repository is clean.", 
            "title": "Example"
        }, 
        {
            "location": "/konitor/cli/#check", 
            "text": "Check is used to programmatically check our guidelines against a repository. Use it before publishing your konnector for it to be production ready \ud83d\ude80  Here is a sample output :  $ konitor check ./cozy-konnector-ameli/\n\n## Checking ../cozy-konnector-ameli/\n\n* Eslint with prettier is used to lint the code (check for eslintConfig in package.json) \u274c\n  - eslintConfig should extend from prettier \u274c\n  Check the documentation:  https://github.com/konnectors/docs/blob/master/status.md#linting\n\n* Fields (necessary for login) are defined in manifest.konnector \u274c\n  - The fields should not be in old format \u274c\n\n* Travis is correctly configured to deploy master/prod. \u2705\n\n* Renovate should be correctly configured. \u274c\n  - Renovate config should extend from the cozy-konnector config \u274c\n  Check the documentation:  https://github.com/konnectors/docs/blob/master/status.md#renovate\n\n* Repository should have 4 branches. \u2705  You can check multiple repositories :  $ konitor check ./cozy-konnector-ameli/ ./cozy-konnector-orange/\n...", 
            "title": "check \ud83e\udd13"
        }
    ]
}