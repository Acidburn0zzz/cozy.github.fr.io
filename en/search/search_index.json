{"config":{"lang":["en"],"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"/","text":"Cozy Documentation The go-to website about Cozy configuration and setup. Keep your devices in sync Install your own server Develop applications Learn how to develop applications and connectors. Get in touch If you have any questions, you can contact us via these 3 medias: Write an email to our Support team: contact at cozy.io Post on the forum Chat with us on IRC","title":"Home"},{"location":"/#cozy-documentation","text":"The go-to website about Cozy configuration and setup. Keep your devices in sync Install your own server Develop applications Learn how to develop applications and connectors.","title":"Cozy Documentation"},{"location":"/#get-in-touch","text":"If you have any questions, you can contact us via these 3 medias: Write an email to our Support team: contact at cozy.io Post on the forum Chat with us on IRC","title":"Get in touch"},{"location":"/sync/desktop/","text":"Sync your desktop computer with your server Cozy Drive for desktop allows you to synchronize your files and folders between your Cozy and your desktop. Thus, you can work on your files offline. Your modifications will be synchronized as soon as network will be available. Installation Before installing Cozy Drive, make sure your Cozy should be up-to-date. Windows You can download Cozy Drive for Windows on this page . List of known to work versions MacOS You can download Cozy Drive for macOS on this page . List of known to work versions Linux Learn how to download and use the GNU/linux client on this page . Configuration At the end of the installation, application will start and ask you for a few informations: Your Cozy URL. In other words, the address used to access to your Cozy. Your Cozy password. We don\u2019t save your password, we only use it to create a new device login which it uses to synchronize your files. The folder where you want to synchronize your files. Once done, you will be redirected to the dashboard. First synchronization can now start. The dashboard is composed of : An information panel about synchronizations and available disk space on your Cozy. A settings panel to configure autostart. An account panel with information on your Cozy and possibility to unlink your Cozy. A help panel in case of problem Troubleshooting When you hit a problem with the application, you can send us a message with the application logs, so we can try to understand and fix the problem. Open help panel, then click on Send us a message in Official support . Don\u2019t forget to describe your problem by adding as many details as you can.","title":"Synchronize your computer"},{"location":"/sync/desktop/#sync-your-desktop-computer-with-your-server","text":"Cozy Drive for desktop allows you to synchronize your files and folders between your Cozy and your desktop. Thus, you can work on your files offline. Your modifications will be synchronized as soon as network will be available.","title":"Sync your desktop computer with your server"},{"location":"/sync/desktop/#installation","text":"Before installing Cozy Drive, make sure your Cozy should be up-to-date.","title":"Installation"},{"location":"/sync/desktop/#windows","text":"You can download Cozy Drive for Windows on this page . List of known to work versions","title":"Windows"},{"location":"/sync/desktop/#macos","text":"You can download Cozy Drive for macOS on this page . List of known to work versions","title":"MacOS"},{"location":"/sync/desktop/#linux","text":"Learn how to download and use the GNU/linux client on this page .","title":"Linux"},{"location":"/sync/desktop/#configuration","text":"At the end of the installation, application will start and ask you for a few informations: Your Cozy URL. In other words, the address used to access to your Cozy. Your Cozy password. We don\u2019t save your password, we only use it to create a new device login which it uses to synchronize your files. The folder where you want to synchronize your files. Once done, you will be redirected to the dashboard. First synchronization can now start. The dashboard is composed of : An information panel about synchronizations and available disk space on your Cozy. A settings panel to configure autostart. An account panel with information on your Cozy and possibility to unlink your Cozy. A help panel in case of problem","title":"Configuration"},{"location":"/sync/desktop/#troubleshooting","text":"When you hit a problem with the application, you can send us a message with the application logs, so we can try to understand and fix the problem. Open help panel, then click on Send us a message in Official support . Don\u2019t forget to describe your problem by adding as many details as you can.","title":"Troubleshooting"},{"location":"/sync/linux/","text":"Install the desktop client on your GNU/Linux system To ease the use of Cozy Drive on any distribution, we distribute the application using the AppImage format. This way, you have nothing to install, just download the application and run it. We provide packages for both 32 bits and 64 bits systems. All you have to do is download the file, move it to some dedicated folder, make it executable and run it. List of known to work distributions Detailed instructions on Gnome Click on one of these links to download Cozy Drive for your OS: Cozy Drive for GNU/Linux 32 bits ; Cozy Drive for GNU/Linux 64 bits ; Once the binary file downloaded, go to the folder where your browser has stored it. For example, if you use Firefox, click on the folder icon in the download list. To be able to run the application, you have to edit its properties to make it executable. Just right click on the application and select Properties inside the context menu: Then go to the Permissions tab and check the box to make the application executable: There\u2019s no need to install the application, you can just run it from the folder you have downloaded it, but we recommend to move it to a dedicated folder to be able to find it easily. You can create an Applications folder inside your home directory and move the application there: Tip: you can add this folder to your bookmarks to find it easily: From 3.26 onwards, GNOME removed the systray (that little bar with some icons) which is the interface for Cozy Drive . You will need to install an extension such as TopIcons in order to see the cozy-desktop application and launch it. That\u2019s all. You can now double-click on the application to launch it and connect it to your server. Have fun! More More in deep insights on the GNU/Linux client . If your distribution is not supported, you can try the manual build guide .","title":"Install on GNU/Linux"},{"location":"/sync/linux/#install-the-desktop-client-on-your-gnulinux-system","text":"To ease the use of Cozy Drive on any distribution, we distribute the application using the AppImage format. This way, you have nothing to install, just download the application and run it. We provide packages for both 32 bits and 64 bits systems. All you have to do is download the file, move it to some dedicated folder, make it executable and run it. List of known to work distributions","title":"Install the desktop client on your GNU/Linux system"},{"location":"/sync/linux/#detailed-instructions-on-gnome","text":"Click on one of these links to download Cozy Drive for your OS: Cozy Drive for GNU/Linux 32 bits ; Cozy Drive for GNU/Linux 64 bits ; Once the binary file downloaded, go to the folder where your browser has stored it. For example, if you use Firefox, click on the folder icon in the download list. To be able to run the application, you have to edit its properties to make it executable. Just right click on the application and select Properties inside the context menu: Then go to the Permissions tab and check the box to make the application executable: There\u2019s no need to install the application, you can just run it from the folder you have downloaded it, but we recommend to move it to a dedicated folder to be able to find it easily. You can create an Applications folder inside your home directory and move the application there: Tip: you can add this folder to your bookmarks to find it easily: From 3.26 onwards, GNOME removed the systray (that little bar with some icons) which is the interface for Cozy Drive . You will need to install an extension such as TopIcons in order to see the cozy-desktop application and launch it. That\u2019s all. You can now double-click on the application to launch it and connect it to your server. Have fun!","title":"Detailed instructions on Gnome"},{"location":"/sync/linux/#more","text":"More in deep insights on the GNU/Linux client . If your distribution is not supported, you can try the manual build guide .","title":"More"},{"location":"/download/","text":"Download Cozy Drive for all your devices Cozy Drive on your phone Cozy Drive for iOS Requires iOS 8.0 or later Cozy Drive for Android Requires Android 5.0.0 (Advanced users that don\u2019t want to connect to Google Play can use the APK ) Cozy Banks on your phone Cozy Banks for iOS Requires iOS 8.0 or later Cozy Drive for Android Requires Android 5.0.0 or later (Advanced users that don\u2019t want to connect to Google Play can use the APK ) Cozy Drive on your computer Cozy Drive for Mac OS Download for MacOS Actively tested on MacOS 10.12.x Sierra and higher, should work on older versions Cozy Drive for Windows Download for Microsoft Windows Actively tested on Windows 10, should work on older versions Cozy Drive for GNU/Linux Full documentation on how to install Cozy Drive for GNU/Linux. List of known to work distributions","title":"Download"},{"location":"/download/#download-cozy-drive-for-all-your-devices","text":"","title":"Download Cozy Drive for all your devices"},{"location":"/download/#cozy-drive-on-your-phone","text":"","title":"Cozy Drive on your phone"},{"location":"/download/#cozy-drive-for-ios","text":"Requires iOS 8.0 or later","title":"Cozy Drive for iOS"},{"location":"/download/#cozy-drive-for-android","text":"Requires Android 5.0.0 (Advanced users that don\u2019t want to connect to Google Play can use the APK )","title":"Cozy Drive for Android"},{"location":"/download/#cozy-banks-on-your-phone","text":"","title":"Cozy Banks on your phone"},{"location":"/download/#cozy-banks-for-ios","text":"Requires iOS 8.0 or later","title":"Cozy Banks for iOS"},{"location":"/download/#cozy-drive-for-android_1","text":"Requires Android 5.0.0 or later (Advanced users that don\u2019t want to connect to Google Play can use the APK )","title":"Cozy Drive for Android"},{"location":"/download/#cozy-drive-on-your-computer","text":"","title":"Cozy Drive on your computer"},{"location":"/download/#cozy-drive-for-mac-os","text":"Download for MacOS Actively tested on MacOS 10.12.x Sierra and higher, should work on older versions","title":"Cozy Drive for Mac OS"},{"location":"/download/#cozy-drive-for-windows","text":"Download for Microsoft Windows Actively tested on Windows 10, should work on older versions","title":"Cozy Drive for Windows"},{"location":"/download/#cozy-drive-for-gnulinux","text":"Full documentation on how to install Cozy Drive for GNU/Linux. List of known to work distributions","title":"Cozy Drive for GNU/Linux"},{"location":"/install/","text":"Install Cozy on your own server Learn how to install Cozy on Debian Stretch, Ubuntu Xenial or Raspbian Stretch ;","title":"Install Cozy on your own server"},{"location":"/install/#install-cozy-on-your-own-server","text":"Learn how to install Cozy on Debian Stretch, Ubuntu Xenial or Raspbian Stretch ;","title":"Install Cozy on your own server"},{"location":"/install/debian/","text":"Install Cozy on a Debian server A Debian repository serves packages to setup a Cozy self-hosted environment. It provides: cozy-couchdb : CouchDB database engine used by cozy cozy-nsjail : NSJail isolation tool used by konnectors cozy-stack : Cozy core cozy-coclyco : CLI to manage vhosts and certificates cozy : metapackage installing everything to setup a self-hosted environment This repository currently supports: Debian Stretch (9.x): amd64 Ubuntu Xenial (16.04 LTS): amd64 Raspbian Stretch (9.x): armhf Available channels are: stable : official and supported releases testing : future official releases, for testing purposes. Updated \u00b1 twice a month. unstable : nightly builds, to be use with caution cozy-couchdb and cozy-nsjail are temporary packages. They will be removed when official couchdb and nsjail will be available You can choose to install cozy-couchdb on the same host as cozy-stack , or use a remote CouchDB server. Cozy only needs a 2.x CouchDB (1.x not supported). Like CouchDB, you can choose to install your reverse proxy on the same host, or use a remote one. Right now cozy-coclyco supports only local nginx . If you want to use apache2 or remote reverse proxy, you need to manually configure it for vhost or TLS certificate issuances. Prerequisites Third party repositories Let s Encrypt official packages require to use unofficial/third party repositories to have recent and supported version of ACME libraries. Packages provided by standard Debian or Ubuntu repositories are quite old and not compatible with cozy-coclyco . For Debian/Raspbian, you need to enable backports repository . For Ubuntu, you need to activate a third party ppa repository . Refer to the certbot documentation to activate needed repositories. (You don t need to install packages like certbot or python-certbot-xxx , only to activate repositories.) You may change your APT preferences to allow APT to install from backports/ppa by default instead of from official repositories. For example: /etc/apt/preferences.d/cozy Package: python3-acme Pin: release n=stretch-backports Pin-Priority: 510 EOF Cozy repositories First, install the packages required to install cozy apt install ca-certificates apt-transport-https curl Then, fetch the GPG Cozy signing key: curl https://apt.cozy.io/cozy.gpg | \\ apt-key --keyring /etc/apt/trusted.gpg.d/cozy.gpg add - curl https://apt.cozy.io/nightly/cozy.gpg | \\ apt-key --keyring /etc/apt/trusted.gpg.d/cozy.gpg add - Finally, setup your repository. Select the channel that best fit your needs: For now, we recommend to use testing repositories, or nightly/unstable channels. stable packages are quite old and currently provide deprecated and unsecured CouchDB version (2.0.x). Adapt your sources.list accordingly. Supported repositories are: Debian Stretch (9.x) deb https://apt.cozy.io/debian/ stretch stable deb https://apt.cozy.io/debian/ stretch testing deb https://apt.cozy.io/nightly/debian/ stretch unstable Ubuntu Xenial (16.04 LTS) deb https://apt.cozy.io/ubuntu/ xenial stable deb https://apt.cozy.io/ubuntu/ xenial testing deb https://apt.cozy.io/nightly/ubuntu/ xenial unstable Raspbian Stretch (9.x) deb https://apt.cozy.io/raspbian/ stretch stable deb https://apt.cozy.io/raspbian/ stretch testing deb https://apt.cozy.io/nightly/raspbian/ stretch unstable echo deb https://apt.cozy.io/debian/ stretch testing /etc/apt/sources.list.d/cozy.list apt update If you want to use unstable/nightly builds, you have to accept another key (weaker and passwordless on our side because of unattended automated builds) curl https://apt.cozy.io/nightly/cozy.gpg | \\ apt-key --keyring /etc/apt/trusted.gpg.d/cozy.gpg add - Setup For the rest of this document, we assume you install components one by one to allow intermediate verification For a full local environment ( couchdb + nginx + cozy ), just install the cozy package which can install all needed packages in one shot. CouchDB apt install cozy-couchdb Install CouchDB in standalone mode Configure CouchDB to listen on 127.0.0.1 Pick an administrator password (This password is used by shell scripts, so currently avoid to use one with simple or double quotes or others shell meaningfull symbols. We advice you to choose one with only alphanumeric digits to avoid troubles.) At this point, you must have a working CouchDB instance curl http://localhost:5984/ { couchdb : Welcome , version : 2.1.0 , features :[ scheduler ], vendor :{ name : The Apache Software Foundation }} If you want to use unstable/nightly builds, you might get another version of the database. Cozy stack apt install cozy-stack Cozy need to create a CouchDB administrator and so to connect as admin to the CouchDB. Fill those mandatory parameters to allow this creation: Address: by default, it s localhost:5984 Node name: by default, it s couchdb@localhost Admin user: by default, it s admin Admin password: put the one you choose during CouchDB setup Cozy user: by default, it s cozy Cozy password: pick a password (Those passwords are used by shell scripts, so currently avoid to use ones with simple or double quotes or others shell meaningfull symbols. We advice you to choose ones with only alphanumeric digits to avoid troubles.) For stack management (create instances, install applications ), Cozy need an administrator password . So pick a new one. When invoking cozy-stack (or cozy-coclyco which use it under the hood), you need to set the COZY_ADMIN_PASSWORD environment variable with this password. You can put it on your .bashrc for simplier life if you want. If you don t, cozy-stack will simply ask for it. At this point, you must have a working Cozy stack, depending on the branch you ve chosen you can get a different version displayed. curl http://localhost:8080/version { build_mode : production , build_time : 2017-09-28T10:26:03Z , runtime_version : go1.8.1 , version : 0.1.0 }# If you want to use konnectors, you need to initialize the NodeJS chroot (Currently this script only works for Debian and will be adapted for Ubuntu and Raspbian soon) /usr/share/cozy/konnector-create-chroot.sh If you use a self-signed certificate or a not official certificate authority, you need to deploy the corresponding root certificate in /usr/share/cozy/chroot/etc/ssl/certs/custom.crt . For example, if you use Let s Encrypt staging environment for testing purpose : wget -q https://letsencrypt.org/certs/fakelerootx1.pem \\ -O /usr/share/cozy/chroot/etc/ssl/certs/custom.crt Finally apt install cozy Cozy instance setup DNS Cozy relies on sub-domains for each applications you installed on your instance. For an instance cozy.example.org , app .cozy.example.org must be available too. Currently, you need at least: onboarding.cozy.example.org settings.cozy.example.org drive.cozy.example.org photos.cozy.example.org collect.cozy.example.org store.cozy.example.org app .cozy.example.org for each application you use Follow your usual way to create those entries on your domain zone. The simpliest way to handle this is to use a wildcard entry if supported by your domain hosting. cozy 1h IN A x.x.x.x *.cozy 1h IN CNAME cozy ACME (Let s Encrypt) Like DNS, each application will use a different sub-domain and so request a certificate which include all needed domains. cozy-coclyco use Let s Encrypt and it ACME protocol to prove your ownership over the domain you try to issue a certificate. This protocol requires your reverse proxy to be able to serve http:// app .cozy.example.org/.well-known/acme-challenge/ requests correctly. The simplest way to achieve this is to configure your reverse proxy with a generic rule to forward any /.well-known/acme-challenge/ request to the corresponding /etc /ssl/private/acme-challenge/ folder. For nginx , this can be done with /etc/nginx/sites-available/default server { listen 80 default_server; listen [::]:80 default_server; root /var/www/html; server_name _; location /.well-known/acme-challenge/ { alias /etc/ssl/private/acme-challenge/; } location / { return 301 https://$host$request_uri; } } apt install ssl-cert adduser www-data ssl-cert systemctl restart nginx Create instances Once you ve got a stack, your DNS and your reverse proxy correctly configured, you can create instances on your Cozy stack. Remember to set the COZY_ADMIN_PASSWORD environment variable. export COZY_ADMIN_PASSWORD= your-admin-password cozy-coclyco create cozy.example.org me@example.org For complete reference of Coclyco, refer to the documentation of cozy-coclyco .","title":"Debian"},{"location":"/install/debian/#install-cozy-on-a-debian-server","text":"A Debian repository serves packages to setup a Cozy self-hosted environment. It provides: cozy-couchdb : CouchDB database engine used by cozy cozy-nsjail : NSJail isolation tool used by konnectors cozy-stack : Cozy core cozy-coclyco : CLI to manage vhosts and certificates cozy : metapackage installing everything to setup a self-hosted environment This repository currently supports: Debian Stretch (9.x): amd64 Ubuntu Xenial (16.04 LTS): amd64 Raspbian Stretch (9.x): armhf Available channels are: stable : official and supported releases testing : future official releases, for testing purposes. Updated \u00b1 twice a month. unstable : nightly builds, to be use with caution cozy-couchdb and cozy-nsjail are temporary packages. They will be removed when official couchdb and nsjail will be available You can choose to install cozy-couchdb on the same host as cozy-stack , or use a remote CouchDB server. Cozy only needs a 2.x CouchDB (1.x not supported). Like CouchDB, you can choose to install your reverse proxy on the same host, or use a remote one. Right now cozy-coclyco supports only local nginx . If you want to use apache2 or remote reverse proxy, you need to manually configure it for vhost or TLS certificate issuances.","title":"Install Cozy on a Debian server"},{"location":"/install/debian/#prerequisites","text":"","title":"Prerequisites"},{"location":"/install/debian/#third-party-repositories","text":"Let s Encrypt official packages require to use unofficial/third party repositories to have recent and supported version of ACME libraries. Packages provided by standard Debian or Ubuntu repositories are quite old and not compatible with cozy-coclyco . For Debian/Raspbian, you need to enable backports repository . For Ubuntu, you need to activate a third party ppa repository . Refer to the certbot documentation to activate needed repositories. (You don t need to install packages like certbot or python-certbot-xxx , only to activate repositories.) You may change your APT preferences to allow APT to install from backports/ppa by default instead of from official repositories. For example: /etc/apt/preferences.d/cozy Package: python3-acme Pin: release n=stretch-backports Pin-Priority: 510 EOF","title":"Third party repositories"},{"location":"/install/debian/#cozy-repositories","text":"First, install the packages required to install cozy apt install ca-certificates apt-transport-https curl Then, fetch the GPG Cozy signing key: curl https://apt.cozy.io/cozy.gpg | \\ apt-key --keyring /etc/apt/trusted.gpg.d/cozy.gpg add - curl https://apt.cozy.io/nightly/cozy.gpg | \\ apt-key --keyring /etc/apt/trusted.gpg.d/cozy.gpg add - Finally, setup your repository. Select the channel that best fit your needs: For now, we recommend to use testing repositories, or nightly/unstable channels. stable packages are quite old and currently provide deprecated and unsecured CouchDB version (2.0.x). Adapt your sources.list accordingly. Supported repositories are: Debian Stretch (9.x) deb https://apt.cozy.io/debian/ stretch stable deb https://apt.cozy.io/debian/ stretch testing deb https://apt.cozy.io/nightly/debian/ stretch unstable Ubuntu Xenial (16.04 LTS) deb https://apt.cozy.io/ubuntu/ xenial stable deb https://apt.cozy.io/ubuntu/ xenial testing deb https://apt.cozy.io/nightly/ubuntu/ xenial unstable Raspbian Stretch (9.x) deb https://apt.cozy.io/raspbian/ stretch stable deb https://apt.cozy.io/raspbian/ stretch testing deb https://apt.cozy.io/nightly/raspbian/ stretch unstable echo deb https://apt.cozy.io/debian/ stretch testing /etc/apt/sources.list.d/cozy.list apt update If you want to use unstable/nightly builds, you have to accept another key (weaker and passwordless on our side because of unattended automated builds) curl https://apt.cozy.io/nightly/cozy.gpg | \\ apt-key --keyring /etc/apt/trusted.gpg.d/cozy.gpg add -","title":"Cozy repositories"},{"location":"/install/debian/#setup","text":"For the rest of this document, we assume you install components one by one to allow intermediate verification For a full local environment ( couchdb + nginx + cozy ), just install the cozy package which can install all needed packages in one shot.","title":"Setup"},{"location":"/install/debian/#couchdb","text":"apt install cozy-couchdb Install CouchDB in standalone mode Configure CouchDB to listen on 127.0.0.1 Pick an administrator password (This password is used by shell scripts, so currently avoid to use one with simple or double quotes or others shell meaningfull symbols. We advice you to choose one with only alphanumeric digits to avoid troubles.) At this point, you must have a working CouchDB instance curl http://localhost:5984/ { couchdb : Welcome , version : 2.1.0 , features :[ scheduler ], vendor :{ name : The Apache Software Foundation }} If you want to use unstable/nightly builds, you might get another version of the database.","title":"CouchDB"},{"location":"/install/debian/#cozy-stack","text":"apt install cozy-stack Cozy need to create a CouchDB administrator and so to connect as admin to the CouchDB. Fill those mandatory parameters to allow this creation: Address: by default, it s localhost:5984 Node name: by default, it s couchdb@localhost Admin user: by default, it s admin Admin password: put the one you choose during CouchDB setup Cozy user: by default, it s cozy Cozy password: pick a password (Those passwords are used by shell scripts, so currently avoid to use ones with simple or double quotes or others shell meaningfull symbols. We advice you to choose ones with only alphanumeric digits to avoid troubles.) For stack management (create instances, install applications ), Cozy need an administrator password . So pick a new one. When invoking cozy-stack (or cozy-coclyco which use it under the hood), you need to set the COZY_ADMIN_PASSWORD environment variable with this password. You can put it on your .bashrc for simplier life if you want. If you don t, cozy-stack will simply ask for it. At this point, you must have a working Cozy stack, depending on the branch you ve chosen you can get a different version displayed. curl http://localhost:8080/version { build_mode : production , build_time : 2017-09-28T10:26:03Z , runtime_version : go1.8.1 , version : 0.1.0 }# If you want to use konnectors, you need to initialize the NodeJS chroot (Currently this script only works for Debian and will be adapted for Ubuntu and Raspbian soon) /usr/share/cozy/konnector-create-chroot.sh If you use a self-signed certificate or a not official certificate authority, you need to deploy the corresponding root certificate in /usr/share/cozy/chroot/etc/ssl/certs/custom.crt . For example, if you use Let s Encrypt staging environment for testing purpose : wget -q https://letsencrypt.org/certs/fakelerootx1.pem \\ -O /usr/share/cozy/chroot/etc/ssl/certs/custom.crt","title":"Cozy stack"},{"location":"/install/debian/#finally","text":"apt install cozy","title":"Finally"},{"location":"/install/debian/#cozy-instance-setup","text":"","title":"Cozy instance setup"},{"location":"/install/debian/#dns","text":"Cozy relies on sub-domains for each applications you installed on your instance. For an instance cozy.example.org , app .cozy.example.org must be available too. Currently, you need at least: onboarding.cozy.example.org settings.cozy.example.org drive.cozy.example.org photos.cozy.example.org collect.cozy.example.org store.cozy.example.org app .cozy.example.org for each application you use Follow your usual way to create those entries on your domain zone. The simpliest way to handle this is to use a wildcard entry if supported by your domain hosting. cozy 1h IN A x.x.x.x *.cozy 1h IN CNAME cozy","title":"DNS"},{"location":"/install/debian/#acme-lets-encrypt","text":"Like DNS, each application will use a different sub-domain and so request a certificate which include all needed domains. cozy-coclyco use Let s Encrypt and it ACME protocol to prove your ownership over the domain you try to issue a certificate. This protocol requires your reverse proxy to be able to serve http:// app .cozy.example.org/.well-known/acme-challenge/ requests correctly. The simplest way to achieve this is to configure your reverse proxy with a generic rule to forward any /.well-known/acme-challenge/ request to the corresponding /etc /ssl/private/acme-challenge/ folder. For nginx , this can be done with /etc/nginx/sites-available/default server { listen 80 default_server; listen [::]:80 default_server; root /var/www/html; server_name _; location /.well-known/acme-challenge/ { alias /etc/ssl/private/acme-challenge/; } location / { return 301 https://$host$request_uri; } } apt install ssl-cert adduser www-data ssl-cert systemctl restart nginx","title":"ACME (Let's Encrypt)"},{"location":"/install/debian/#create-instances","text":"Once you ve got a stack, your DNS and your reverse proxy correctly configured, you can create instances on your Cozy stack. Remember to set the COZY_ADMIN_PASSWORD environment variable. export COZY_ADMIN_PASSWORD= your-admin-password cozy-coclyco create cozy.example.org me@example.org For complete reference of Coclyco, refer to the documentation of cozy-coclyco .","title":"Create instances"},{"location":"/install/manual/","text":"How to install Cozy on Debian Stable \u26a0\ufe0f This is a work in progress. For now, there\u2019s no easy and officially supported way to install Cozy. You have to install it and all this dependencies by hand. This tutorial is intended for tech savvy people wanting to give Cozy a first try without waiting for the official documentation and images. For now, this documentation don\u2019t explain how to install the technology stack required for connector, as the technology we use may evolve. So you won\u2019t be able to run the connectors. Most of the following commands require root privileges. You can either open a root shell or use sudo when needed; Pre-requisites Cozy requires a CouchDB 2 database server, a reverse proxy and an SMTP server. We\u2019ll use Nginx in this tutorial but feel free to use your reverse proxy of choice. You ll also need a domain name and know how to associate all of its subdomains to the IP address of your server. Install dependencies On a fresh new Debian Stretch, here are the packages that may be useful to install and manage your server: apt-get update apt-get --no-install-recommends -y install \\ ca-certificates \\ curl \\ net-tools \\ nginx \\ sudo \\ vim-tiny \\ build-essential \\ pkg-config \\ erlang \\ libicu-dev \\ libmozjs185-dev \\ libcurl4-openssl-dev Install CouchDB Download the source code on CouchDB 2 and install it . cd /tmp curl -LO https://dist.apache.org/repos/dist/release/couchdb/source/2.1.1/apache-couchdb-2.1.1.tar.gz tar xf apache-couchdb-2.1.1.tar.gz cd apache-couchdb-2.1.1 ./configure make release adduser --system \\ --no-create-home \\ --shell /bin/bash \\ --group --gecos \\ CouchDB Administrator couchdb We\u2019ll install CouchDB inside /home/couchdb : cp -R rel/couchdb /home/couchdb chown -R couchdb:couchdb /home/couchdb find /home/couchdb -type d -exec chmod 0770 {} \\; chmod -R 0644 /home/couchdb/etc/* mkdir /var/log/couchdb chown couchdb: /var/log/couchdb For now, we\u2019ll just run the database as a background job, but it is highly recommended to use some supervisor software. sudo -b -i -u couchdb sh -c '/home/couchdb/bin/couchdb /var/log/couchdb/couch.log 2 /var/log/couchdb/couch-err.log' Alternatively, you can setup a service script, and use systemd to run couchdb as a service : cat EOT /etc/systemd/system/couchdb.service [Unit] Description=Couchdb service After=network.target [Service] Type=simple User=couchdb ExecStart=/home/couchdb/bin/couchdb -o /dev/stdout -e /dev/stderr Restart=always [Install] WantedBy=multi-user.target EOT Then to start and enable (start at boot) the service : systemctl daemon-reload systemctl start couchdb.service systemctl enable couchdb.service Last but not least, let\u2019s create the default databases: curl -X PUT http://127.0.0.1:5984/_users curl -X PUT http://127.0.0.1:5984/_replicator curl -X PUT http://127.0.0.1:5984/_global_changes \u26a0\ufe0f The default CouchDB installation has no admin user. Everybody can query the server. So, in production environment, make sure to create en admin user and update the CouchDB connexion URL inside the configuration file of Cozy. Install the Cozy Stack The Cozy server is just a single binary. You can fetch one of its releases from Github: curl -o /usr/local/bin/cozy-stack \\ -L https://github.com/cozy/cozy-stack/releases/download/2017M2-alpha/cozy-stack-linux-amd64-2017M2-alpha chmod +x /usr/local/bin/cozy-stack adduser --system \\ --no-create-home \\ --shell /bin/bash \\ --group --gecos \\ Cozy cozy mkdir /var/log/cozy chown cozy: /var/log/cozy mkdir /var/lib/cozy chown -R cozy: /var/lib/cozy You can configure your server using a JSON or YAML file. Let\u2019s fetch the sample configuration file: mkdir /etc/cozy curl -o /etc/cozy/cozy.yaml \\ https://raw.githubusercontent.com/cozy/cozy-stack/master/cozy.example.yaml chown -R cozy: /etc/cozy Edit this file to adapt it to your configuration. You should setup a directory to store the files. For example: fs: url: file://localhost/var/lib/cozy Don\u2019t forget to allow Cozy user to write inside this folder. Compile a recent stack The released build may not contain the latest fixes. If you want an up to date version of the stack, you can compile it from the sources. This requires to install the Go compiler, fetch the sources and compile them: apt-get --no-install-recommends -y install \\ ca-certificates \\ curl \\ net-tools \\ nginx \\ sudo \\ vim-tiny \\ build-essential \\ pkg-config \\ erlang \\ libicu-dev \\ libmozjs185-dev \\ libcurl4-openssl-dev \\ git cd /tmp curl -LO https://storage.googleapis.com/golang/go1.8.3.linux-amd64.tar.gz tar -C /usr/local -xzf go1.8.3.linux-amd64.tar.gz PATH=$PATH:/usr/local/go/bin go get -u github.com/cozy/cozy-stack cp /root/go/bin/cozy-stack /usr/local/bin/cozy-stack chmod +x /usr/local/bin/cozy-stack Configuration NGinx Let\u2019s assume you want to host a server on mycozy.tld with a self-signed certificate. Generate the certificate. We need a wild-card certificate, as every application inside Cozy will have it\u2019s own sub-domain: sudo openssl req -x509 -nodes -newkey rsa:4096 \\ -keyout /etc/cozy/mycozy.tld.key \\ -out /etc/cozy/mycozy.tld.crt \\ -days 365 -subj /CN={*.mycozy.tld} Then create a virtual host for your server by creating a file at /etc/cozy/sites-available/mycozy.tld.conf with the following configuration template . And enable it by creating a symbolic link: sudo ln -s /etc/nginx/sites-available/mycozy.tld.conf \\ /etc/nginx/sites-enabled/ You can check that your configuration is valid by running sudo nginx -t -c /etc/nginx/nginx.conf And start NGinx: sudo service nginx start Or, if you use systemd: sudo systemctl start nginx sudo systemctl enable nginx # enable the nginx service at startup, if need to Cozy The Cozy server requires a main password: sudo /usr/local/bin/cozy-stack config passwd /etc/cozy/ This password will be asked every time you use the cozy-stack command line. To prevent this, you can set the COZY_ADMIN_PASSWORD environment variable. DNS Make sure to associate *.mycozy.tld with the IP address of your server. For example, add the following records to your DNS (replacing mycozy.tld with your domain of choice): mycozy.tld A your IP *.mycozy.tld CNAME mycozy.tld Running For now, we\u2019ll just run the server as a background job, but it is highly recommended to use some supervisor software. First, start the server: sudo -b -u cozy sh -c '/usr/local/bin/cozy-stack serve \\ --log-level info \\ --host 0.0.0.0 /var/log/cozy/cozy.log 2 /var/log/cozy/cozy-err.log' Then, create your instance and install the applications: cozy-stack instances add \\ --host 0.0.0.0 \\ --apps drive,photos,collect,settings \\ --passphrase XXX \\ mycozy.tld --passphrase \"XXX\" allows to set the initial password of the instance. You can add other instances by just running this commands again. The url of your cozy determines the name of your instance. If you choose another public port than the default public port for SSL (443), say 1443 , then you should reflect this when creating your cozy instance with the ${instance_domain} as mycozy.tld:1443 . Sample configuration files Nginx Put this file into /etc/nginx/sites-available and enable it by creating a symlink in /etc/nginx/sites-enabled . In this template, you need to replace the following placeholders: %PORT% with the public port nginx will listen to (default should be 443) %SERVER_PORT% with the private port cozy will listen to (default should be 8080) %DOMAIN% with your domain of choice: mycozy.tld in this example server { listen %PORT%; server_name *.%DOMAIN%; ssl_certificate /etc/cozy/%DOMAIN%.crt; ssl_certificate_key /etc/cozy/%DOMAIN%.key; ssl_session_cache shared:SSL:10m; ssl_session_timeout 10m; ssl_protocols TLSv1 TLSv1.1 TLSv1.2; ssl_ciphers EECDH+AES; ssl_prefer_server_ciphers on; ssl on; gzip_vary on; client_max_body_size 1024M; add_header Strict-Transport-Security max-age=31536000; location / { proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header Host $http_host; proxy_redirect http:// https://; proxy_pass http://127.0.0.1:8080; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection upgrade ; } access_log /var/log/nginx/cozy.log; } TODO Cozy also requires a SMTP server (or relay).","title":"Manual installation"},{"location":"/install/manual/#how-to-install-cozy-on-debian-stable","text":"\u26a0\ufe0f This is a work in progress. For now, there\u2019s no easy and officially supported way to install Cozy. You have to install it and all this dependencies by hand. This tutorial is intended for tech savvy people wanting to give Cozy a first try without waiting for the official documentation and images. For now, this documentation don\u2019t explain how to install the technology stack required for connector, as the technology we use may evolve. So you won\u2019t be able to run the connectors. Most of the following commands require root privileges. You can either open a root shell or use sudo when needed;","title":"How to install Cozy on Debian Stable"},{"location":"/install/manual/#pre-requisites","text":"Cozy requires a CouchDB 2 database server, a reverse proxy and an SMTP server. We\u2019ll use Nginx in this tutorial but feel free to use your reverse proxy of choice. You ll also need a domain name and know how to associate all of its subdomains to the IP address of your server.","title":"Pre-requisites"},{"location":"/install/manual/#install-dependencies","text":"On a fresh new Debian Stretch, here are the packages that may be useful to install and manage your server: apt-get update apt-get --no-install-recommends -y install \\ ca-certificates \\ curl \\ net-tools \\ nginx \\ sudo \\ vim-tiny \\ build-essential \\ pkg-config \\ erlang \\ libicu-dev \\ libmozjs185-dev \\ libcurl4-openssl-dev","title":"Install dependencies"},{"location":"/install/manual/#install-couchdb","text":"Download the source code on CouchDB 2 and install it . cd /tmp curl -LO https://dist.apache.org/repos/dist/release/couchdb/source/2.1.1/apache-couchdb-2.1.1.tar.gz tar xf apache-couchdb-2.1.1.tar.gz cd apache-couchdb-2.1.1 ./configure make release adduser --system \\ --no-create-home \\ --shell /bin/bash \\ --group --gecos \\ CouchDB Administrator couchdb We\u2019ll install CouchDB inside /home/couchdb : cp -R rel/couchdb /home/couchdb chown -R couchdb:couchdb /home/couchdb find /home/couchdb -type d -exec chmod 0770 {} \\; chmod -R 0644 /home/couchdb/etc/* mkdir /var/log/couchdb chown couchdb: /var/log/couchdb For now, we\u2019ll just run the database as a background job, but it is highly recommended to use some supervisor software. sudo -b -i -u couchdb sh -c '/home/couchdb/bin/couchdb /var/log/couchdb/couch.log 2 /var/log/couchdb/couch-err.log' Alternatively, you can setup a service script, and use systemd to run couchdb as a service : cat EOT /etc/systemd/system/couchdb.service [Unit] Description=Couchdb service After=network.target [Service] Type=simple User=couchdb ExecStart=/home/couchdb/bin/couchdb -o /dev/stdout -e /dev/stderr Restart=always [Install] WantedBy=multi-user.target EOT Then to start and enable (start at boot) the service : systemctl daemon-reload systemctl start couchdb.service systemctl enable couchdb.service Last but not least, let\u2019s create the default databases: curl -X PUT http://127.0.0.1:5984/_users curl -X PUT http://127.0.0.1:5984/_replicator curl -X PUT http://127.0.0.1:5984/_global_changes \u26a0\ufe0f The default CouchDB installation has no admin user. Everybody can query the server. So, in production environment, make sure to create en admin user and update the CouchDB connexion URL inside the configuration file of Cozy.","title":"Install CouchDB"},{"location":"/install/manual/#install-the-cozy-stack","text":"The Cozy server is just a single binary. You can fetch one of its releases from Github: curl -o /usr/local/bin/cozy-stack \\ -L https://github.com/cozy/cozy-stack/releases/download/2017M2-alpha/cozy-stack-linux-amd64-2017M2-alpha chmod +x /usr/local/bin/cozy-stack adduser --system \\ --no-create-home \\ --shell /bin/bash \\ --group --gecos \\ Cozy cozy mkdir /var/log/cozy chown cozy: /var/log/cozy mkdir /var/lib/cozy chown -R cozy: /var/lib/cozy You can configure your server using a JSON or YAML file. Let\u2019s fetch the sample configuration file: mkdir /etc/cozy curl -o /etc/cozy/cozy.yaml \\ https://raw.githubusercontent.com/cozy/cozy-stack/master/cozy.example.yaml chown -R cozy: /etc/cozy Edit this file to adapt it to your configuration. You should setup a directory to store the files. For example: fs: url: file://localhost/var/lib/cozy Don\u2019t forget to allow Cozy user to write inside this folder.","title":"Install the Cozy Stack"},{"location":"/install/manual/#compile-a-recent-stack","text":"The released build may not contain the latest fixes. If you want an up to date version of the stack, you can compile it from the sources. This requires to install the Go compiler, fetch the sources and compile them: apt-get --no-install-recommends -y install \\ ca-certificates \\ curl \\ net-tools \\ nginx \\ sudo \\ vim-tiny \\ build-essential \\ pkg-config \\ erlang \\ libicu-dev \\ libmozjs185-dev \\ libcurl4-openssl-dev \\ git cd /tmp curl -LO https://storage.googleapis.com/golang/go1.8.3.linux-amd64.tar.gz tar -C /usr/local -xzf go1.8.3.linux-amd64.tar.gz PATH=$PATH:/usr/local/go/bin go get -u github.com/cozy/cozy-stack cp /root/go/bin/cozy-stack /usr/local/bin/cozy-stack chmod +x /usr/local/bin/cozy-stack","title":"Compile a recent stack"},{"location":"/install/manual/#configuration","text":"","title":"Configuration"},{"location":"/install/manual/#nginx","text":"Let\u2019s assume you want to host a server on mycozy.tld with a self-signed certificate. Generate the certificate. We need a wild-card certificate, as every application inside Cozy will have it\u2019s own sub-domain: sudo openssl req -x509 -nodes -newkey rsa:4096 \\ -keyout /etc/cozy/mycozy.tld.key \\ -out /etc/cozy/mycozy.tld.crt \\ -days 365 -subj /CN={*.mycozy.tld} Then create a virtual host for your server by creating a file at /etc/cozy/sites-available/mycozy.tld.conf with the following configuration template . And enable it by creating a symbolic link: sudo ln -s /etc/nginx/sites-available/mycozy.tld.conf \\ /etc/nginx/sites-enabled/ You can check that your configuration is valid by running sudo nginx -t -c /etc/nginx/nginx.conf And start NGinx: sudo service nginx start Or, if you use systemd: sudo systemctl start nginx sudo systemctl enable nginx # enable the nginx service at startup, if need to","title":"NGinx"},{"location":"/install/manual/#cozy","text":"The Cozy server requires a main password: sudo /usr/local/bin/cozy-stack config passwd /etc/cozy/ This password will be asked every time you use the cozy-stack command line. To prevent this, you can set the COZY_ADMIN_PASSWORD environment variable.","title":"Cozy"},{"location":"/install/manual/#dns","text":"Make sure to associate *.mycozy.tld with the IP address of your server. For example, add the following records to your DNS (replacing mycozy.tld with your domain of choice): mycozy.tld A your IP *.mycozy.tld CNAME mycozy.tld","title":"DNS"},{"location":"/install/manual/#running","text":"For now, we\u2019ll just run the server as a background job, but it is highly recommended to use some supervisor software. First, start the server: sudo -b -u cozy sh -c '/usr/local/bin/cozy-stack serve \\ --log-level info \\ --host 0.0.0.0 /var/log/cozy/cozy.log 2 /var/log/cozy/cozy-err.log' Then, create your instance and install the applications: cozy-stack instances add \\ --host 0.0.0.0 \\ --apps drive,photos,collect,settings \\ --passphrase XXX \\ mycozy.tld --passphrase \"XXX\" allows to set the initial password of the instance. You can add other instances by just running this commands again. The url of your cozy determines the name of your instance. If you choose another public port than the default public port for SSL (443), say 1443 , then you should reflect this when creating your cozy instance with the ${instance_domain} as mycozy.tld:1443 .","title":"Running"},{"location":"/install/manual/#sample-configuration-files","text":"","title":"Sample configuration files"},{"location":"/install/manual/#nginx_1","text":"Put this file into /etc/nginx/sites-available and enable it by creating a symlink in /etc/nginx/sites-enabled . In this template, you need to replace the following placeholders: %PORT% with the public port nginx will listen to (default should be 443) %SERVER_PORT% with the private port cozy will listen to (default should be 8080) %DOMAIN% with your domain of choice: mycozy.tld in this example server { listen %PORT%; server_name *.%DOMAIN%; ssl_certificate /etc/cozy/%DOMAIN%.crt; ssl_certificate_key /etc/cozy/%DOMAIN%.key; ssl_session_cache shared:SSL:10m; ssl_session_timeout 10m; ssl_protocols TLSv1 TLSv1.1 TLSv1.2; ssl_ciphers EECDH+AES; ssl_prefer_server_ciphers on; ssl on; gzip_vary on; client_max_body_size 1024M; add_header Strict-Transport-Security max-age=31536000; location / { proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header Host $http_host; proxy_redirect http:// https://; proxy_pass http://127.0.0.1:8080; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection upgrade ; } access_log /var/log/nginx/cozy.log; }","title":"Nginx"},{"location":"/install/manual/#todo","text":"Cozy also requires a SMTP server (or relay).","title":"TODO"},{"location":"/dev/","text":"Let s hack some code Tutorials introduction to Cozy architecture how to develop your first application how to develop a connector how to create a mobile application with cordova how to send mail in development How to Coming soon! API References Cozy Client JS Reference Iintroduction documents files authentification authentication with OAuth2 settings inter-app communication jobs and triggers offline Cozy Bar Cozy UI introduction styleguide react components in storybook Raw Server API introduction: API architecture conventions JSON-API applications : install, update, list applications marketplace permissions notifications settings auth documents query the database files link files to documents jobs workers architecture and API inter-application communication sharing connectors realtime Proxy for remote data/API Available doctypes We maintain an index of all the currently available doctypes . To make your own doctypes available to other applications, please send a pull request to this repository.","title":"Let's hack some code"},{"location":"/dev/#lets-hack-some-code","text":"","title":"Let's hack some code"},{"location":"/dev/#tutorials","text":"introduction to Cozy architecture how to develop your first application how to develop a connector how to create a mobile application with cordova how to send mail in development","title":"Tutorials"},{"location":"/dev/#how-to","text":"Coming soon!","title":"How to"},{"location":"/dev/#api-references","text":"","title":"API References"},{"location":"/dev/#cozy-client-js-reference","text":"Iintroduction documents files authentification authentication with OAuth2 settings inter-app communication jobs and triggers offline Cozy Bar","title":"Cozy Client JS Reference"},{"location":"/dev/#cozy-ui","text":"introduction styleguide react components in storybook","title":"Cozy UI"},{"location":"/dev/#raw-server-api","text":"introduction: API architecture conventions JSON-API applications : install, update, list applications marketplace permissions notifications settings auth documents query the database files link files to documents jobs workers architecture and API inter-application communication sharing connectors realtime Proxy for remote data/API","title":"Raw Server API"},{"location":"/dev/#available-doctypes","text":"We maintain an index of all the currently available doctypes . To make your own doctypes available to other applications, please send a pull request to this repository.","title":"Available doctypes"},{"location":"/dev/connect-mobile-app-local-stack/","text":"How to connect a mobile app to your local stack Sometimes we need to test a feature on a mobile app by connecting it to our locally installed stack. For this to work, we need to achieve some things. Prerequisite Have a local stack installed Have an Android emulator created Start the emulator with the ability to remount its file system as writable Since we will need to edit the hosts of the emulator, we need to be able to remount its file system as writable. For that, we need to start our emulator with the following command : ./emulator -writable-system -avd Pixel_API_27 The emulator binary is located at /home/user/Android/Sdk/emulator/ on Linux systems by default. Pixel_API_27 is the name of the emulator I want to start. If you don t know the name of your emulator, you can get it with : ./emulator -list-avds Root the emulator Now that the emulator is started, we need to gain root access on it. Run the following command : adb root This restarts the adb daemon with root privileges. Remount the file sytem as writable By default, the file system is read-only. We need it to be writable, so we run this command : adb remount Pull the emulator s hosts file To edit the hosts file, we need to pull it on our system : adb pull /etc/hosts hosts This creates a hosts file in your current directory. Edit the hosts For the emulator to be able to connect to our stack, we need to add the IP address of our machine to the hosts. Actually, we don t really need it since in an Android emulator 10.0.2.2 is automatically pointing to our machine. So we just need to add this to the hosts file : 10.0.2.2 cozy.tools Push the new file to the emulator Now that we have added what s necessary in the file, we have to push it to the emulator : adb push hosts /system/etc/hosts Then try to ping cozy.tools to see if everything is working well : adb shell ping api.dev.local You can now enter http://cozy.tools in the login page of your mobile app and you will not get an error anymore.","title":"Connect a mobile app to your local stack"},{"location":"/dev/connect-mobile-app-local-stack/#how-to-connect-a-mobile-app-to-your-local-stack","text":"Sometimes we need to test a feature on a mobile app by connecting it to our locally installed stack. For this to work, we need to achieve some things.","title":"How to connect a mobile app to your local stack"},{"location":"/dev/connect-mobile-app-local-stack/#prerequisite","text":"Have a local stack installed Have an Android emulator created","title":"Prerequisite"},{"location":"/dev/connect-mobile-app-local-stack/#start-the-emulator-with-the-ability-to-remount-its-file-system-as-writable","text":"Since we will need to edit the hosts of the emulator, we need to be able to remount its file system as writable. For that, we need to start our emulator with the following command : ./emulator -writable-system -avd Pixel_API_27 The emulator binary is located at /home/user/Android/Sdk/emulator/ on Linux systems by default. Pixel_API_27 is the name of the emulator I want to start. If you don t know the name of your emulator, you can get it with : ./emulator -list-avds","title":"Start the emulator with the ability to remount its file system as writable"},{"location":"/dev/connect-mobile-app-local-stack/#root-the-emulator","text":"Now that the emulator is started, we need to gain root access on it. Run the following command : adb root This restarts the adb daemon with root privileges.","title":"Root the emulator"},{"location":"/dev/connect-mobile-app-local-stack/#remount-the-file-sytem-as-writable","text":"By default, the file system is read-only. We need it to be writable, so we run this command : adb remount","title":"Remount the file sytem as writable"},{"location":"/dev/connect-mobile-app-local-stack/#pull-the-emulators-hosts-file","text":"To edit the hosts file, we need to pull it on our system : adb pull /etc/hosts hosts This creates a hosts file in your current directory.","title":"Pull the emulator's hosts file"},{"location":"/dev/connect-mobile-app-local-stack/#edit-the-hosts","text":"For the emulator to be able to connect to our stack, we need to add the IP address of our machine to the hosts. Actually, we don t really need it since in an Android emulator 10.0.2.2 is automatically pointing to our machine. So we just need to add this to the hosts file : 10.0.2.2 cozy.tools","title":"Edit the hosts"},{"location":"/dev/connect-mobile-app-local-stack/#push-the-new-file-to-the-emulator","text":"Now that we have added what s necessary in the file, we have to push it to the emulator : adb push hosts /system/etc/hosts Then try to ping cozy.tools to see if everything is working well : adb shell ping api.dev.local You can now enter http://cozy.tools in the login page of your mobile app and you will not get an error anymore.","title":"Push the new file to the emulator"},{"location":"/dev/intro/","text":"Introduction Cozy is a personal server hosting applications that allow collect and manipulate all your personal data. There are two kind of applications: web applications : that s Single Page Applications (SPA) written in HTML and JavaScript that run inside the user s browser. They interact with the server through its API. This API allows to manipulate data and files and to perform miscellaneous tasks, like send emails connectors : that s small application written in JavaScript, running on the server side, that import your data from remote sources. In this tutorial, you ll learn how to write a client application and a connector . Architecture Several layers can be distinguished. From inside to outside: the core is a database that store all user data; the database is accessible through a layer that control accesses and expose a REST API; Web applications and other clients offer nice user interfaces to interact with the data. One of our motto is \u00ab Cozy is Simple, Versatile, Yours \u00bb. This applies to our architecture: simple and easy to understand and deploy. Cozy doesn\u2019t require to setup and manage a lot of micro-services; versatile : our server is comfortable anywhere. You can host a single instance on a small Raspberry \u03c0 at home, or a cluster of thousands instances on dedicated servers inside a datacenter; yours : the users are the owners of their data, they keep the control. They can migrate their data from one server to another, and are not dependant from a single hosting provider. As we say: \u201cyou will stay because you can leave\u201d; The server The server consist of a single process. We call it the Cozy stack . It provides services through a REST API that allow to: create, update, delete documents inside the database; send emails; launch jobs on the server. Connectors that import data from remote websites are some sort of jobs. Jobs can be one time tasks (sending a message) or periodic tasks. Some jobs, like the connectors, that require executing third party code on the server side, are sandboxed (we user nsjail for now). \u2026 The server also allow to access the database replication API, allowing to sync documents between the server and local databases, for example in mobile clients. Two authentication methods are available: Web applications running on the server get a session token when the user log in; OAuth2 for other applications. The server is in charge of serving the Web applications users have installed from the application store. The database CouchDB is a document database. Everything, from user data to server settings, is stored inside typed documents, identified by an unique id. Two request methods are allowed: map-reduce or Mango , a specific query language. Every document has a doctype , and we keep an index of the definition of every doctype. Binary data are stored outside the database. Depending on the server configuration, they may be stored on a file system or a dedicated object storage like swift . The datasystem layer inside the Cozy stack is in charge of controlling access rights on documents and binaries. It allows fine gained access control, on a whole doctype or on a set of documents. The applications The server provide services to applications: real time notifications of events; methods allowing applications to communicate and share data; methods allowing sharing of documents between servers. Application store An application registry lists every available applications, and their characteristics. Each application can: create its own doctypes; request permission to access documents; offer services to other applications; register publics routes; create jobs that will be run on server side. Security Each application uses its own sub-domain name, so it gets sandboxed inside the browser: other application are not able to steal it access token and access its data. We use Content Security Policy to control what the application is allowed to do. For example, Web applications running inside Cozy are not allowed to send requests to other websites. This allow a strict control over applications, preventing them to leak your data.","title":"Architecture"},{"location":"/dev/intro/#introduction","text":"Cozy is a personal server hosting applications that allow collect and manipulate all your personal data. There are two kind of applications: web applications : that s Single Page Applications (SPA) written in HTML and JavaScript that run inside the user s browser. They interact with the server through its API. This API allows to manipulate data and files and to perform miscellaneous tasks, like send emails connectors : that s small application written in JavaScript, running on the server side, that import your data from remote sources. In this tutorial, you ll learn how to write a client application and a connector .","title":"Introduction"},{"location":"/dev/intro/#architecture","text":"Several layers can be distinguished. From inside to outside: the core is a database that store all user data; the database is accessible through a layer that control accesses and expose a REST API; Web applications and other clients offer nice user interfaces to interact with the data. One of our motto is \u00ab Cozy is Simple, Versatile, Yours \u00bb. This applies to our architecture: simple and easy to understand and deploy. Cozy doesn\u2019t require to setup and manage a lot of micro-services; versatile : our server is comfortable anywhere. You can host a single instance on a small Raspberry \u03c0 at home, or a cluster of thousands instances on dedicated servers inside a datacenter; yours : the users are the owners of their data, they keep the control. They can migrate their data from one server to another, and are not dependant from a single hosting provider. As we say: \u201cyou will stay because you can leave\u201d;","title":"Architecture"},{"location":"/dev/intro/#the-server","text":"The server consist of a single process. We call it the Cozy stack . It provides services through a REST API that allow to: create, update, delete documents inside the database; send emails; launch jobs on the server. Connectors that import data from remote websites are some sort of jobs. Jobs can be one time tasks (sending a message) or periodic tasks. Some jobs, like the connectors, that require executing third party code on the server side, are sandboxed (we user nsjail for now). \u2026 The server also allow to access the database replication API, allowing to sync documents between the server and local databases, for example in mobile clients. Two authentication methods are available: Web applications running on the server get a session token when the user log in; OAuth2 for other applications. The server is in charge of serving the Web applications users have installed from the application store.","title":"The server"},{"location":"/dev/intro/#the-database","text":"CouchDB is a document database. Everything, from user data to server settings, is stored inside typed documents, identified by an unique id. Two request methods are allowed: map-reduce or Mango , a specific query language. Every document has a doctype , and we keep an index of the definition of every doctype. Binary data are stored outside the database. Depending on the server configuration, they may be stored on a file system or a dedicated object storage like swift . The datasystem layer inside the Cozy stack is in charge of controlling access rights on documents and binaries. It allows fine gained access control, on a whole doctype or on a set of documents.","title":"The database"},{"location":"/dev/intro/#the-applications","text":"The server provide services to applications: real time notifications of events; methods allowing applications to communicate and share data; methods allowing sharing of documents between servers.","title":"The applications"},{"location":"/dev/intro/#application-store","text":"An application registry lists every available applications, and their characteristics. Each application can: create its own doctypes; request permission to access documents; offer services to other applications; register publics routes; create jobs that will be run on server side.","title":"Application store"},{"location":"/dev/intro/#security","text":"Each application uses its own sub-domain name, so it gets sandboxed inside the browser: other application are not able to steal it access token and access its data. We use Content Security Policy to control what the application is allowed to do. For example, Web applications running inside Cozy are not allowed to send requests to other websites. This allow a strict control over applications, preventing them to leak your data.","title":"Security"},{"location":"/dev/app/","text":"How to create your first Cozy application Prerequisite Developing an application for Cozy is quite easy. All you need to have is: NodeJS 8+ Yarn : a NodeJS package manager, like npm Docker to have a Cozy for dev Some basics about developing a single page application in HTML/JS or you just want to learn :) The only tool required to have a Cozy for development is Docker. We have been told that installing Docker on some familial flavours of Windows may be a bit difficult. If you use Windows, please check if Docker is available on your system. Install the development environment On GNU/Linux, according to the documentation : \u00ab The docker daemon binds to a Unix socket instead of a TCP port. By default that Unix socket is owned by the user root and other users can only access it using sudo. If you don\u2019t want to use sudo when you use the docker command, create a Unix group called docker and add users to it. Be warned that the docker group grants privileges equivalent to the root user. You should have a look at Docker\u2019s documentation on security . Every application running inside Cozy is a client-side HTML5 application interacting with your data through the API of the server. To develop an application, you\u2019ll require a running Cozy server. The easiest way is to use the Docker image for developers we provide. Just install it: docker pull cozy/cozy-app-dev (We update this image on a regular basis with the latest version of the server and our library. Don\u2019t forget to update the image by running docker pull cozy/cozy-app-dev from time to time). Create your application You can boostrap your application from scratch if you want, but we recommand to use our new community tool create-cozy-app to bootstrap very easily a Cozy application for you. This tool will generate an application using (P)React, the framework we internally use in the Cozy Front team. But options are available if you want to use other frameworks. For now the new cozy-client is used only in the (P)React template (it doesn t use the previous cozy-client-js anymore). This library is at an early stage but you can use it, it will be our next Cozy client for application development. First of all, run directly create-cozy-app without installing it globally by using the yarn create cozy-app command to bootstrap your application: yarn create cozy-app mycozyapp The script will download some dependencies (may take a while) and ask you a few questions, then create an application skeleton inside mycozyapp . That s all! You can start hacking: cd mycozyapp yarn watch:standalone After the webpack build, your app should be available at http://localhost:8888 You can change the host and the port of your application server here by using respectively the environment variables HOST and PORT Run it inside a Cozy using Docker You can run your application (here mycozyapp ) inside a Cozy thanks to the [cozy-stack docker image][cozy-stack-docker]: # in a terminal, run your app in watch mode $ cd mycozyapp $ yarn watch:browser Then, in another terminal: # in another terminal, run the docker container $ yarn stack:docker # or if you want the complete command (see more documentation below) $ docker run --rm -it -p 8080:8080 -v $(pwd)/build :/data/cozy-app/mycozyapp cozy/cozy-app-dev Your app is now available at http://mycozyapp.cozy.tools:8080. Extra documentation about application development How is the application working? The minimal application consist of only two files: an HTML file, index.html , with the markup and the code of your application a manifest describing the application. It\u2019s a JSON file named manifest.webapp with the name of the application, the permissions it requires\u2026 We\u2019ll have a deeper look to it content later. Your application requires some informations to interact with the server API, for example the URL of its entrypoint, and an auth token. This data will be dynamically injected into index.html when it serves the page. So the index.html file has to contain some string that will be replaced by the server. The general syntax of this variables is {{\u2026}} , so don\u2019t use this syntax for other purpose in the page, for example inside comments. You can use the following variables: {{.Domain}} will be substituted by the URL of the API entrypoint {{.Token}} will be replaced by a token that authenticate your application when accessing the API {{.Locale}} : the lang f the instance {{.AppName}} : the name of the application {{.IconPath}} will be replaced by HTML code to display the favicon {{.CozyClientJS}} will be replaced with HTML code to inject the Cozy client library {{.CozyBar}} will be replaced with HTML code to inject the upper menu bar. Use the API with cozy-client-js We are currently working on a new cozy-client library which will be more updated and used in the future than cozy-client-js . But the two libraries ( cozy-client and cozy-client-js ) don t rely on each other so you can still use the one you want to handle Cozy data for now. If you added {{.CozyClientJS}} to your page, interacting with the server will be as easy as using the Cozy Client JS library. All you have to do is to initiate the library with the server parameters (the URL of the API and the auth token of your application): window.cozy.client.init({cozyURL: \u2026 , token: \u2026 }); You can then interact with the server by using methods of the window.cozy.client properties. For example, to get current disk usage: cozy.client.settings.diskUsage() .then(function (usage) {console.log( Usage (promise) , usage);}); .catch(function(err){ console.log( fail , err); }); This library embeds most of the available server APIs: manipulate documents and files, manage applications and server settings\u2026 It also provides some some methods to help application keep working while being offline. Some server APIs may not be available right now through the library. If you want to use one of this method, you\u2019ll have to call it manually. See below. #TODO - add inner link. Behind the magic Some server APIs may not be available right now through the library. If you want to use one of this method, you\u2019ll have to call it manually. We\u2019ll describe here how to access the API without using the Cozy Client JS library. Connecting to the API requires three things: its URL, injected into the page through the {{.Domain}} variable the application auth token, injected into the page through the {{.Token}} variable. Each request sent to the server must include this token in the Authorization header the session cookie, created when you connect to your server. This is an HttpOnly cookie , meaning that JavaScript applications can\u2019t read it. This prevent a malicious script to stole the cookie. Here\u2019s a sample code that get API informations provided by the server and query the API: div data-cozy-token= {{.Token}} data-cozy-domain= {{.Domain}} / document.addEventListener('DOMContentLoaded', () = { use strict ; const app = document.querySelector('[data-cozy-token]'); fetch(`//${app.dataset.cozyDomain}/apps`, { method: 'GET', headers: { Authorization: `Bearer ${app.dataset.cozyToken}` // Here we use the auth token }, credentials: 'include' // don\u2019t forget to include the session cookie }) .then(function (response) { if (response.ok) { response.json().then((result) = { console.log(result); }); } else { throw new Error('Network response was not ok.'); } }) .catch(function (error) { console.log('There has been a problem with your fetch operation: ' + error.message); }); }); The manifest Each application must have a \u201cmanifest\u201d. It\u2019s a JSON file named manifest.webapp stored at the root of the application directory. It describes the application, the type of documents it uses, the permissions it require\u2026 Here\u2019s a sample manifest: { name : My Awesome application , permissions : { apps : { type : io.cozy.apps }, permissions : { type : io.cozy.permissions }, settings : { type : io.cozy.settings }, sample : { type : io.cozy.dev.sample , verbs : [ GET , POST , PUT , PATCH , DELETE ] }, jobs : { type : io.cozy.jobs } }, routes : { / : { folder : / , index : index.html , public : false }, /public : { folder : /public , index : index.html , public : true } } } Permissions Applications require permissions to use most of the APIs. Permissions can be described inside the manifest, so the server can ask the user to grant them during installation. Applications can also request permissions at run time. A permission must at type contain a target, the type of objects the application want to interact with. Can be a document type, or an action on the server. By default, all grant on this object are granted, but we can also request fine grained permissions, for example limiting to read access. We can also limit the scope to a subset of the documents. In the manifest, each permission is an object, with a random name and some properties: type : mandatory the document type or action name description : a text that will be displayed to the user to explain why the application require this permission verbs : an array of HTTP verbs. For example, to limit permissions to read access, use [\"GET\"] selector : a document attribute to limit access to a subset of documents values : array of allowed values for this attribute. An application can request a token that grant access to a subset of its own permissions. For example if the application has full access to the files, it can obtain a token that give only read access on a file. Thus, the application can make some documents publicly available. The public page of the application will use this token as authentication token when accessing the API. Samples Application require full access to files: { permissions : { files : { description : \u2026 , type : io.cozy.files }, } } Application want to be able to read the contact informations of cozy@cozycloud.cc { permissions : { contact : { type : io.cozy.contacts , verbs : [ GET ], selector : email , values : [ cozy@cozycloud.cc ] } } } Routing The application must declare all of its URLs (routes) inside the manifest. A route is an object associating an URL to an HTML file. Each route has the following properties: folder : the base folder of the route index : the name of the file inside this folder public : a boolean specifying whether the route is public or private (default). Sample: routes : { /admin : { folder : / , index : admin.html , public : false }, /public : { folder : /public , index : index.html , public : true }, /assets : { folder : /assets , public : true } } cozy-client-js This library embeds most of the available server APIs: manipulate documents and files, manage applications and server settings\u2026 It also provides some some methods to help application keep working while being offline. The library expose a client API under the window.cozy.client namespace. Before using it, you have to initiate the library with the server parameters (the URL of the API and the auth token of your application): window.cozy.client.init({cozyURL: \u2026 , token: \u2026 }); The library supports two programming paradigms: callback and Promises, so you can use your favorite one. If you prefer using callbacks rather than Promises, just add disablePromises to the options when initializing the library: window.cozy.client.init({cozyURL: \u2026 , token: \u2026 , disablePromises: true}); window.client.settings.diskUsage(function (err, res) { (\u2026) }); Raw API documentation In this tutorial, we\u2019ll only see a few samples of how to use the library. For a complete description of all available methods, please refer to its own documentation: documents files authentification authentication with OAuth2 settings inter-app communication jobs and triggers sharing offline Cozy Bar Manipulating documents Inside cozy data system, all documents are typed. To prevent applications to create document types with the same name but different description, the naming of the doctypes use the Java specification . Every document type name must be prefixed by the reverted domain name of its creator. If you don\u2019t own a domain name, you can also use your email address. For example, doctypes created by Cozy are prefixed by io.cozy or io.cozy.labs . If you don\u2019t own a domain name, and your email address is foo@bar.cloud , prefix your doctype names with cloud.bar.foo . We maintain an index of all the currently available doctypes . To make your own doctypes available to other applications, please send a pull request to this repository. Before manipulating documents, you have to request permission to access their doctype, either in the manifest or dynamically. Every method allowing to handle document are available under the cozy.client.data namespace. For example: cozy.client.data.create(doctype, attributes) , cozy.client.data.update(doctype, doc, newdoc) cozy.client.data.delete(doctype, doc) to create, update and delete documents cozy.client.data.updateAttributes(doctype, id, changes) to only update some attributes of a document cozy.client.data.find(doctype, id) return a document using its ident cozy.client.data.changesFeed(doctype, options) get the latests updates of documents of a doctype you can attach files to a document using cozy.client.data.addReferencedFiles(doc, fileIds) and list attachments with cozy.client.data.listReferencedFiles(doc) Querying To search documents inside the database, you first need to create an index on some attributes of the documents, then perform a query on this index. The library offers the following methods: cozy.client.data.defineIndex(doctype, fields) to create the index cozy.client.data.query(indexReference, query) to query an index. The query parameter uses the syntax of the Mango API from CouchDB 2. For example, to search contacts by their email address, you could use: cozy.client.data.defineIndex( io.cozy.contacts , [ email ]) .then((index) = { return cozy.data.query(index, { selector : {email: cozy@cozycloud.cc }}) }) .then( (result) = { console.log(result[0].name); }); Manipulating files The metadata of the files are stored inside the server database, allowing to perform advanced queries, and the files themselves on a virtual file system. The library offer a lot of methods under cozy.client.files namespace to manipulate files. Most of the methods allows to manipulate a file or folder either by its id or by its full path. Here are the most commons ones, but a lot of other methods are available in the raw API documentation : create() and updateById() to create and update a file createDirectory() to create a folder updateAttributesById() et updateAttributesByPath() allow to update some metadata use destroyById to remove a file a virtual trash is available. You can put files into the trash ( trashById() ) and restore them ( restoreById() ). You can also list the content of the trash ( listTrash() ) and purge all trashed files ( clearTrash() ) statById(id) et statByPath(path) return the metadata and, or folders, their content Folders When using statById() or statByPath() to get metadata of of folder, you can than call relations() on the resulting object to access their content. For example, to list content of the root folder, use: cozy.client.files.statByPath( / ) .then((dir) = { console.log(dir.relations( contents )); }) Some special folder have a pre-defined id that will never change: io.cozy.files.root-dir is the root of the filesystem io.cozy.files.trash-dir is the trash. The Cozy Bar The Cozy Bar is a component that display the Cozy menu on the top of your application and allow inter-apps features like content sharing. Your application interacts with this component through cozy-bar.js , a library injected into your pages by the server when you add {{.CozyBar}} in the header. It exposes an API behind the window.cozy.bar namespace. Before using it, you have to initialize the library: window.cozy.bar.init({appName: \"Mon application\"}) . Styling If you plan to build a webapp to run on Cozy, you\u2019ll probably want to use a simple and elegant solution to build your interfaces without the mess of dealing with complex markup and CSS. Then Cozy UI is here for you! It relies on Stylus as preprocessor. You can add it as a library in your project to use it out-of-the-box. The development server using Docker (remember what we previously said about the permissions required to run Docker: if your user doesn\u2019t belong to the docker group, you\u2019ll have to use sudo to run each of this commands.) To run your application inside the development server, just run the following command from the folder where your index.html and manifest.webapp files leave: docker run --rm -it -p 8080:8080 -p 5984:5984 -p 8025:8025 -v $(pwd):/data/cozy-app --name cozydev cozy/cozy-app-dev Let\u2019s have a quick look at this command, so you can adapt it to your needs: --rm will delete the server when you stop it. This prevent Docker from keeping a lot of unused stopped images -it allow to attach an interactive terminal, so you\u2019ll be able to use the command line inside the server -p 8080:8080 : the server listens on port 8080 on the virtual machine. We forward this port to the same port on your local machine. To use another local port, for example 9090, use -p 9090:8080 -p 5984:5984 : this is just a convenient way to access the CouchDB database running inside the server. Point your browser to http://cozy.tools:5984/_utils/ to access its administrative interface -p 8025:8025 : Cozy requires a mail server. In the development image, we don\u2019t use a real email server, but a software that can display the sent messages. Just point your browser to http://cozy.tools:8025/ to display the messages sent by the server -v $(pwd):/data/cozy-app this mount the current folder, where your application leaves, inside the server. This is what make the application available on the server --name cozydev name the running virtual machine cozydev , so you can easily refer to it from other Docker commands. For example, if you want to connect to a shell inside the server, you can use docker exec -ti /bin/bash With this syntax, there is no data persistance: all your test data will be lost every time you stop the server. This is a good way to prevent side effects and start on a clean base, with an empty database. However, if you want to persist data, you have to mount two folders from the virtual server to local folders: /usr/local/couchdb/data (database) and /data/cozy-storage (the virtual filesystem). This can be achieved by adding to the command line -v ~/cozy/data/db:/usr/local/couchdb/data -v ~/cozy/data/storage:/data/cozy-storage which will store the server\u2019s data into ~/cozy/data . Once the server started, go to http://app.cozy.tools:8080/# , connect to the server with the default password cozy and you should be able to start testing your application. You can also access the following URLs: http://cozy.tools:5984/_utils to get the database administrative panel http://cozy.tools:8025/ to display the emails sent by the server. Test multiple applications You can install more than one application into the development server, for example to test communication between applications. In order to achieve this, you have to mount the folder where your application leaves into subfolders of /data/cozy-apps . For example, if the code of Cozy Drive and Cozy Photos is on your local filesystem in ~/cozy/drive and ~/cozy/photos , start the development server with: docker run --rm -it -p 8080:8080 -p 5984:5984 -p 8025:8025 -v ~/cozy/drive:/data/cozy-app/drive -v ~/cozy/photos:/data-cozy-app/photos --name=cozydev cozy/cozy-app-dev You\u2019ll access the applications by connecting to http://drive.cozy.tools:8080/ and http://photos.cozy.tools:8080 . What is cozy.tools ? This development server use the domain names *.cozy.tools . We have parameterized this domain to always redirect to 127.0.0.1 , your local computer address. With that, no need to configure your environment to set extra local hosts for development anymore.","title":"Create your first app"},{"location":"/dev/app/#how-to-create-your-first-cozy-application","text":"","title":"How to create your first Cozy application"},{"location":"/dev/app/#prerequisite","text":"Developing an application for Cozy is quite easy. All you need to have is: NodeJS 8+ Yarn : a NodeJS package manager, like npm Docker to have a Cozy for dev Some basics about developing a single page application in HTML/JS or you just want to learn :) The only tool required to have a Cozy for development is Docker. We have been told that installing Docker on some familial flavours of Windows may be a bit difficult. If you use Windows, please check if Docker is available on your system.","title":"Prerequisite"},{"location":"/dev/app/#install-the-development-environment","text":"On GNU/Linux, according to the documentation : \u00ab The docker daemon binds to a Unix socket instead of a TCP port. By default that Unix socket is owned by the user root and other users can only access it using sudo. If you don\u2019t want to use sudo when you use the docker command, create a Unix group called docker and add users to it. Be warned that the docker group grants privileges equivalent to the root user. You should have a look at Docker\u2019s documentation on security . Every application running inside Cozy is a client-side HTML5 application interacting with your data through the API of the server. To develop an application, you\u2019ll require a running Cozy server. The easiest way is to use the Docker image for developers we provide. Just install it: docker pull cozy/cozy-app-dev (We update this image on a regular basis with the latest version of the server and our library. Don\u2019t forget to update the image by running docker pull cozy/cozy-app-dev from time to time).","title":"Install the development environment"},{"location":"/dev/app/#create-your-application","text":"You can boostrap your application from scratch if you want, but we recommand to use our new community tool create-cozy-app to bootstrap very easily a Cozy application for you. This tool will generate an application using (P)React, the framework we internally use in the Cozy Front team. But options are available if you want to use other frameworks. For now the new cozy-client is used only in the (P)React template (it doesn t use the previous cozy-client-js anymore). This library is at an early stage but you can use it, it will be our next Cozy client for application development. First of all, run directly create-cozy-app without installing it globally by using the yarn create cozy-app command to bootstrap your application: yarn create cozy-app mycozyapp The script will download some dependencies (may take a while) and ask you a few questions, then create an application skeleton inside mycozyapp . That s all! You can start hacking: cd mycozyapp yarn watch:standalone After the webpack build, your app should be available at http://localhost:8888 You can change the host and the port of your application server here by using respectively the environment variables HOST and PORT","title":"Create your application"},{"location":"/dev/app/#run-it-inside-a-cozy-using-docker","text":"You can run your application (here mycozyapp ) inside a Cozy thanks to the [cozy-stack docker image][cozy-stack-docker]: # in a terminal, run your app in watch mode $ cd mycozyapp $ yarn watch:browser Then, in another terminal: # in another terminal, run the docker container $ yarn stack:docker # or if you want the complete command (see more documentation below) $ docker run --rm -it -p 8080:8080 -v $(pwd)/build :/data/cozy-app/mycozyapp cozy/cozy-app-dev Your app is now available at http://mycozyapp.cozy.tools:8080.","title":"Run it inside a Cozy using Docker"},{"location":"/dev/app/#extra-documentation-about-application-development","text":"","title":"Extra documentation about application development"},{"location":"/dev/app/#how-is-the-application-working","text":"The minimal application consist of only two files: an HTML file, index.html , with the markup and the code of your application a manifest describing the application. It\u2019s a JSON file named manifest.webapp with the name of the application, the permissions it requires\u2026 We\u2019ll have a deeper look to it content later. Your application requires some informations to interact with the server API, for example the URL of its entrypoint, and an auth token. This data will be dynamically injected into index.html when it serves the page. So the index.html file has to contain some string that will be replaced by the server. The general syntax of this variables is {{\u2026}} , so don\u2019t use this syntax for other purpose in the page, for example inside comments. You can use the following variables: {{.Domain}} will be substituted by the URL of the API entrypoint {{.Token}} will be replaced by a token that authenticate your application when accessing the API {{.Locale}} : the lang f the instance {{.AppName}} : the name of the application {{.IconPath}} will be replaced by HTML code to display the favicon {{.CozyClientJS}} will be replaced with HTML code to inject the Cozy client library {{.CozyBar}} will be replaced with HTML code to inject the upper menu bar.","title":"How is the application working?"},{"location":"/dev/app/#use-the-api-with-cozy-client-js","text":"We are currently working on a new cozy-client library which will be more updated and used in the future than cozy-client-js . But the two libraries ( cozy-client and cozy-client-js ) don t rely on each other so you can still use the one you want to handle Cozy data for now. If you added {{.CozyClientJS}} to your page, interacting with the server will be as easy as using the Cozy Client JS library. All you have to do is to initiate the library with the server parameters (the URL of the API and the auth token of your application): window.cozy.client.init({cozyURL: \u2026 , token: \u2026 }); You can then interact with the server by using methods of the window.cozy.client properties. For example, to get current disk usage: cozy.client.settings.diskUsage() .then(function (usage) {console.log( Usage (promise) , usage);}); .catch(function(err){ console.log( fail , err); }); This library embeds most of the available server APIs: manipulate documents and files, manage applications and server settings\u2026 It also provides some some methods to help application keep working while being offline. Some server APIs may not be available right now through the library. If you want to use one of this method, you\u2019ll have to call it manually. See below. #TODO - add inner link.","title":"Use the API with cozy-client-js"},{"location":"/dev/app/#behind-the-magic","text":"Some server APIs may not be available right now through the library. If you want to use one of this method, you\u2019ll have to call it manually. We\u2019ll describe here how to access the API without using the Cozy Client JS library. Connecting to the API requires three things: its URL, injected into the page through the {{.Domain}} variable the application auth token, injected into the page through the {{.Token}} variable. Each request sent to the server must include this token in the Authorization header the session cookie, created when you connect to your server. This is an HttpOnly cookie , meaning that JavaScript applications can\u2019t read it. This prevent a malicious script to stole the cookie. Here\u2019s a sample code that get API informations provided by the server and query the API: div data-cozy-token= {{.Token}} data-cozy-domain= {{.Domain}} / document.addEventListener('DOMContentLoaded', () = { use strict ; const app = document.querySelector('[data-cozy-token]'); fetch(`//${app.dataset.cozyDomain}/apps`, { method: 'GET', headers: { Authorization: `Bearer ${app.dataset.cozyToken}` // Here we use the auth token }, credentials: 'include' // don\u2019t forget to include the session cookie }) .then(function (response) { if (response.ok) { response.json().then((result) = { console.log(result); }); } else { throw new Error('Network response was not ok.'); } }) .catch(function (error) { console.log('There has been a problem with your fetch operation: ' + error.message); }); });","title":"Behind the magic"},{"location":"/dev/app/#the-manifest","text":"Each application must have a \u201cmanifest\u201d. It\u2019s a JSON file named manifest.webapp stored at the root of the application directory. It describes the application, the type of documents it uses, the permissions it require\u2026 Here\u2019s a sample manifest: { name : My Awesome application , permissions : { apps : { type : io.cozy.apps }, permissions : { type : io.cozy.permissions }, settings : { type : io.cozy.settings }, sample : { type : io.cozy.dev.sample , verbs : [ GET , POST , PUT , PATCH , DELETE ] }, jobs : { type : io.cozy.jobs } }, routes : { / : { folder : / , index : index.html , public : false }, /public : { folder : /public , index : index.html , public : true } } }","title":"The manifest"},{"location":"/dev/app/#permissions","text":"Applications require permissions to use most of the APIs. Permissions can be described inside the manifest, so the server can ask the user to grant them during installation. Applications can also request permissions at run time. A permission must at type contain a target, the type of objects the application want to interact with. Can be a document type, or an action on the server. By default, all grant on this object are granted, but we can also request fine grained permissions, for example limiting to read access. We can also limit the scope to a subset of the documents. In the manifest, each permission is an object, with a random name and some properties: type : mandatory the document type or action name description : a text that will be displayed to the user to explain why the application require this permission verbs : an array of HTTP verbs. For example, to limit permissions to read access, use [\"GET\"] selector : a document attribute to limit access to a subset of documents values : array of allowed values for this attribute. An application can request a token that grant access to a subset of its own permissions. For example if the application has full access to the files, it can obtain a token that give only read access on a file. Thus, the application can make some documents publicly available. The public page of the application will use this token as authentication token when accessing the API.","title":"Permissions"},{"location":"/dev/app/#samples","text":"Application require full access to files: { permissions : { files : { description : \u2026 , type : io.cozy.files }, } } Application want to be able to read the contact informations of cozy@cozycloud.cc { permissions : { contact : { type : io.cozy.contacts , verbs : [ GET ], selector : email , values : [ cozy@cozycloud.cc ] } } }","title":"Samples"},{"location":"/dev/app/#routing","text":"The application must declare all of its URLs (routes) inside the manifest. A route is an object associating an URL to an HTML file. Each route has the following properties: folder : the base folder of the route index : the name of the file inside this folder public : a boolean specifying whether the route is public or private (default). Sample: routes : { /admin : { folder : / , index : admin.html , public : false }, /public : { folder : /public , index : index.html , public : true }, /assets : { folder : /assets , public : true } }","title":"Routing"},{"location":"/dev/app/#cozy-client-js","text":"This library embeds most of the available server APIs: manipulate documents and files, manage applications and server settings\u2026 It also provides some some methods to help application keep working while being offline. The library expose a client API under the window.cozy.client namespace. Before using it, you have to initiate the library with the server parameters (the URL of the API and the auth token of your application): window.cozy.client.init({cozyURL: \u2026 , token: \u2026 }); The library supports two programming paradigms: callback and Promises, so you can use your favorite one. If you prefer using callbacks rather than Promises, just add disablePromises to the options when initializing the library: window.cozy.client.init({cozyURL: \u2026 , token: \u2026 , disablePromises: true}); window.client.settings.diskUsage(function (err, res) { (\u2026) });","title":"cozy-client-js"},{"location":"/dev/app/#raw-api-documentation","text":"In this tutorial, we\u2019ll only see a few samples of how to use the library. For a complete description of all available methods, please refer to its own documentation: documents files authentification authentication with OAuth2 settings inter-app communication jobs and triggers sharing offline Cozy Bar","title":"Raw API documentation"},{"location":"/dev/app/#manipulating-documents","text":"Inside cozy data system, all documents are typed. To prevent applications to create document types with the same name but different description, the naming of the doctypes use the Java specification . Every document type name must be prefixed by the reverted domain name of its creator. If you don\u2019t own a domain name, you can also use your email address. For example, doctypes created by Cozy are prefixed by io.cozy or io.cozy.labs . If you don\u2019t own a domain name, and your email address is foo@bar.cloud , prefix your doctype names with cloud.bar.foo . We maintain an index of all the currently available doctypes . To make your own doctypes available to other applications, please send a pull request to this repository. Before manipulating documents, you have to request permission to access their doctype, either in the manifest or dynamically. Every method allowing to handle document are available under the cozy.client.data namespace. For example: cozy.client.data.create(doctype, attributes) , cozy.client.data.update(doctype, doc, newdoc) cozy.client.data.delete(doctype, doc) to create, update and delete documents cozy.client.data.updateAttributes(doctype, id, changes) to only update some attributes of a document cozy.client.data.find(doctype, id) return a document using its ident cozy.client.data.changesFeed(doctype, options) get the latests updates of documents of a doctype you can attach files to a document using cozy.client.data.addReferencedFiles(doc, fileIds) and list attachments with cozy.client.data.listReferencedFiles(doc)","title":"Manipulating documents"},{"location":"/dev/app/#querying","text":"To search documents inside the database, you first need to create an index on some attributes of the documents, then perform a query on this index. The library offers the following methods: cozy.client.data.defineIndex(doctype, fields) to create the index cozy.client.data.query(indexReference, query) to query an index. The query parameter uses the syntax of the Mango API from CouchDB 2. For example, to search contacts by their email address, you could use: cozy.client.data.defineIndex( io.cozy.contacts , [ email ]) .then((index) = { return cozy.data.query(index, { selector : {email: cozy@cozycloud.cc }}) }) .then( (result) = { console.log(result[0].name); });","title":"Querying"},{"location":"/dev/app/#manipulating-files","text":"The metadata of the files are stored inside the server database, allowing to perform advanced queries, and the files themselves on a virtual file system. The library offer a lot of methods under cozy.client.files namespace to manipulate files. Most of the methods allows to manipulate a file or folder either by its id or by its full path. Here are the most commons ones, but a lot of other methods are available in the raw API documentation : create() and updateById() to create and update a file createDirectory() to create a folder updateAttributesById() et updateAttributesByPath() allow to update some metadata use destroyById to remove a file a virtual trash is available. You can put files into the trash ( trashById() ) and restore them ( restoreById() ). You can also list the content of the trash ( listTrash() ) and purge all trashed files ( clearTrash() ) statById(id) et statByPath(path) return the metadata and, or folders, their content","title":"Manipulating files"},{"location":"/dev/app/#folders","text":"When using statById() or statByPath() to get metadata of of folder, you can than call relations() on the resulting object to access their content. For example, to list content of the root folder, use: cozy.client.files.statByPath( / ) .then((dir) = { console.log(dir.relations( contents )); }) Some special folder have a pre-defined id that will never change: io.cozy.files.root-dir is the root of the filesystem io.cozy.files.trash-dir is the trash.","title":"Folders"},{"location":"/dev/app/#the-cozy-bar","text":"The Cozy Bar is a component that display the Cozy menu on the top of your application and allow inter-apps features like content sharing. Your application interacts with this component through cozy-bar.js , a library injected into your pages by the server when you add {{.CozyBar}} in the header. It exposes an API behind the window.cozy.bar namespace. Before using it, you have to initialize the library: window.cozy.bar.init({appName: \"Mon application\"}) .","title":"The Cozy Bar"},{"location":"/dev/app/#styling","text":"If you plan to build a webapp to run on Cozy, you\u2019ll probably want to use a simple and elegant solution to build your interfaces without the mess of dealing with complex markup and CSS. Then Cozy UI is here for you! It relies on Stylus as preprocessor. You can add it as a library in your project to use it out-of-the-box.","title":"Styling"},{"location":"/dev/app/#the-development-server-using-docker","text":"(remember what we previously said about the permissions required to run Docker: if your user doesn\u2019t belong to the docker group, you\u2019ll have to use sudo to run each of this commands.) To run your application inside the development server, just run the following command from the folder where your index.html and manifest.webapp files leave: docker run --rm -it -p 8080:8080 -p 5984:5984 -p 8025:8025 -v $(pwd):/data/cozy-app --name cozydev cozy/cozy-app-dev Let\u2019s have a quick look at this command, so you can adapt it to your needs: --rm will delete the server when you stop it. This prevent Docker from keeping a lot of unused stopped images -it allow to attach an interactive terminal, so you\u2019ll be able to use the command line inside the server -p 8080:8080 : the server listens on port 8080 on the virtual machine. We forward this port to the same port on your local machine. To use another local port, for example 9090, use -p 9090:8080 -p 5984:5984 : this is just a convenient way to access the CouchDB database running inside the server. Point your browser to http://cozy.tools:5984/_utils/ to access its administrative interface -p 8025:8025 : Cozy requires a mail server. In the development image, we don\u2019t use a real email server, but a software that can display the sent messages. Just point your browser to http://cozy.tools:8025/ to display the messages sent by the server -v $(pwd):/data/cozy-app this mount the current folder, where your application leaves, inside the server. This is what make the application available on the server --name cozydev name the running virtual machine cozydev , so you can easily refer to it from other Docker commands. For example, if you want to connect to a shell inside the server, you can use docker exec -ti /bin/bash With this syntax, there is no data persistance: all your test data will be lost every time you stop the server. This is a good way to prevent side effects and start on a clean base, with an empty database. However, if you want to persist data, you have to mount two folders from the virtual server to local folders: /usr/local/couchdb/data (database) and /data/cozy-storage (the virtual filesystem). This can be achieved by adding to the command line -v ~/cozy/data/db:/usr/local/couchdb/data -v ~/cozy/data/storage:/data/cozy-storage which will store the server\u2019s data into ~/cozy/data . Once the server started, go to http://app.cozy.tools:8080/# , connect to the server with the default password cozy and you should be able to start testing your application. You can also access the following URLs: http://cozy.tools:5984/_utils to get the database administrative panel http://cozy.tools:8025/ to display the emails sent by the server.","title":"The development server using Docker"},{"location":"/dev/app/#test-multiple-applications","text":"You can install more than one application into the development server, for example to test communication between applications. In order to achieve this, you have to mount the folder where your application leaves into subfolders of /data/cozy-apps . For example, if the code of Cozy Drive and Cozy Photos is on your local filesystem in ~/cozy/drive and ~/cozy/photos , start the development server with: docker run --rm -it -p 8080:8080 -p 5984:5984 -p 8025:8025 -v ~/cozy/drive:/data/cozy-app/drive -v ~/cozy/photos:/data-cozy-app/photos --name=cozydev cozy/cozy-app-dev You\u2019ll access the applications by connecting to http://drive.cozy.tools:8080/ and http://photos.cozy.tools:8080 .","title":"Test multiple applications"},{"location":"/dev/app/#what-is-cozytools","text":"This development server use the domain names *.cozy.tools . We have parameterized this domain to always redirect to 127.0.0.1 , your local computer address. With that, no need to configure your environment to set extra local hosts for development anymore.","title":"What is cozy.tools ?"},{"location":"/dev/konnector/","text":"How to write a connector Introduction A connector (also known as konnector ) is a script that imports data from another web service and put those data into your cozy. Each connector is an independant application, managed by the Cozy Collect application. To protect your data, each connector runs inside a container in order to sandbox all their interactions with your data. How does it work? A connector is a NodeJS script. The target node version used to run your connector is the current LTS version (8 at the time this doc was written). Like client side apps, connectors communicate with the Cozy Stack using its HTTP API, and get an unique auth token every time they start. They need to register with a manifest, and ask the user for permissions. To facilitate connector development, a npm package, [konnectors/libs], provides some shared libraries that are adapted to be used for a connector: cheerio to easily query a HTML page request-promise : request with Promise support request-debug that displays all the requests and responses in the standard output. Toggle debug option in requestFactory options Besides, you ll probably need some other npm packages to help you run your connector: momentjs or date-fns to manage dates bluebird to get enhanced promises When the connector is started, it also receives some data via environment variables: COZY_CREDENTIALS : an auth token used by cozy-client-js to communicate with the server COZY_URL : the Cozy Stack API entry point COZY_FIELDS : settings coming from Cozy Collect and filled by the user (login, password, directory path). These variables are used by the connector and the cozy-client to configure the connection to the Cozy Stack with the right permissions as defined in the connector manifest. They are simulated in standalone mode so that you do not need a real Cozy Stack to develop a connector. [ More about BaseKonnector ] From the server point of view, each connector is a job which is executed periodically via a trigger . [ More about Cozy Stack jobs ] Let\u2019s create our first connector The easiest way to create a new connector is to use cozy-konnector-template : Run the sample First of all, download or clone the repository: git clone https://github.com/konnectors/cozy-konnector-template cozy-konnector-newservice cd cozy-konnector-newservice rm -rf .git git init yarn install # or npm install note: we use yarn , but if you prefer npm , keep using it, everything should work. The connector is ready to run with sample code. As a demo we will scrape a fictional website: books.toscrape.com , for which you do not need credentials . As indicated in the README.md file, just run: yarn standalone # or npm run standalone The very first run will create a konnector-dev-config.json file that allows you to configure the connector input when executing it with the CLI. This configuration comes from Cozy Collect when deployed. { COZY_URL : http://cozy.tools:8080 , fields : { // configuration injected to the start function } } The fields property allow you to set credentials for the targeted web service, such as login and password as if they come from Cozy Stack . The COZY_URL property will be used later. As explained earlier, the demo website books.toscrape.com does not need any credentials. But for the code to run without error, you need to register a fake login and a fake password: { COZY_URL : http://cozy.tools:8080 , fields : { login : zuck.m@rk.fb , password : 123456 } } In cozy-konnector-template, this configuration file is already added to .gitignore file to be sure your credentials stay private. Now you can run the connector again in standalone mode to see how jpg and related data are downloaded. In this mode, [ cozy-client-js ] is stubbed and all data meant to be saved in a cozy are displayed in the standard output and files are saved in the root directory of the connector. This is useful to start developing your connector without handling the state of a real Cozy Stack . Please check CLI section of the documentation for more information. Implement your connector There are four steps for a connector to save data to Cozy Stack : authentication request data parse and format data save data to cozy stack You can see these steps in the src/index.js in the konnectors/cozy-konnector-template : async function start(fields) { // step 1. log('info', 'Authenticating ...') await authenticate(fields.login, fields.password) log('info', 'Successfully logged in') // step 2. // The BaseKonnector instance expects a Promise as return of the function log('info', 'Fetching the list of documents') const $ = await request(`${baseUrl}/index.html`) // step 3. log('info', 'Parsing list of documents') const documents = await parseDocuments($) // step 4. // here we use the saveBills function even if what we fetch are not bills, but this is the most // common case in connectors log('info', 'Saving data to Cozy') await saveBills(documents, fields.folderPath, { // this is a bank identifier which will be used to link bills to bank operations. These // identifiers should be at least a word found in the title of a bank operation related to this // bill. It is not case sensitive. identifiers: ['books'] }) } Authentication Open the src/index.js file, there are comments to guide you through it. The very first step is to be able to authenticate to the remote service, this is done with the line: await authenticate(fields.login, fields.password) There are many obstacles at this level: is there a captcha? is there a 2FA? how is the form ? note: if the remote service exposes an API, you should use classical request call. Let s say the remote service exposes a simple classical form like https://www.trainline.eu/signin: form id= signin-form novalidate= class= signin__form data-ember-action= data-ember-action-680= 680 input name= email autocomplete= on placeholder= Email Address id= ember691 class= ember-text-field textfield ember-view data-enpass.usermodified= yes type= email input name= password autocomplete= on placeholder= Password id= ember696 class= ember-text-field textfield ember-view data-enpass.usermodified= yes type= password div class= signin__forgot span data-ember-action= data-ember-action-697= 697 a href= /password id= ember698 class= ember-view Forgot your password? /a /span /div div class= signin__buttons div class= signin__buttons-block button type= submit class= signin__button Sign In /button /div /div /form Find a CSS selector for the form tag: form#signin-form . Find the name of the input tags used to host user s credentials: email and password . You are ready to complete the signin(options) object called in the authenticate(username, password) function: function authenticate(username, password) { return signin({ url: `https://www.trainline.eu/signin`, formSelector: 'form#signin-form', formData: { email: username, password }, validate: (statusCode, $) = { // write some code to validate the form submission } }) } To implement the validate function, you need to check what is happening on a successful login and on an unsuccessful login. With the https://www.trainline.eu/signin example, fill the form with wrong credentials, open your browser s devtools (and check the network tab) and submit the form. Here it is clear, on incorrect credentials, the response have a status code 422 : HTTP/2.0 422 No Reason Phrase Do the same with valid crendentials. HTTP/2.0 200 OK Then you can write a simple and straight forward validate code: function authenticate(username, password) { return signin({ url: `https://www.trainline.eu/signin`, formSelector: 'form#signin-form', formData: { email: username, password }, validate: (statusCode, $) = { return statusCode === 200 || log('error', 'Invalid credentials') } }) } Request data Once the konnector is able to be authenticated by the online service, the next step is to fetch data. The most common case is that the invoices we want to fetch are listed in a HTML page. So to request data, we fetch the target webpage that contains invoices list. But sometimes, the webpage is a JavaScript page that uses a JSON API url. JSON is easier to parse than full HTML webpages. For the purpose of this guide, let s consider we are in the case of a full HTML webpage, like the service given as an example in the template: http://books.toscrape.com This is the easiest part, juste fetch the webpage: const $ = await request('http://books.toscrape.com/index.html') The $ variable is set to a cheerio object with useful API to crawl the webpage . That object will be very useful for the next step. Parse the document We want to get every article / of the page in a JavaScript Array: const articles = [].map.call($('article', node = node)) For every book, we want to catch the title attribute of this tag article h3 a . This is a CSS Selector that cheerio understands to select some part of the tree. In order to crawl a list of items to create an Array of json object, we can use the function scrape from the konnector libs : const docs = scrape( $, { title: { sel: 'h3 a', attr: 'title' }, amount: { sel: '.price_color', parse: normalizePrice }, url: { sel: 'h3 a', attr: 'href', parse: url = `${baseUrl}/${url}` }, fileurl: { sel: 'img', attr: 'src', parse: src = `${baseUrl}/${src}` }, filename: { sel: 'h3 a', attr: 'title', parse: title = `${title}.jpg` } }, 'article' ) This code will loop on article / and for each item will create a JSON object with the selector sel and the value of attribute attr if specified, otherwise it takes the value of the child node, this value can be edited with the parse function. Here is a sample for the following markup from http://books.toscrape.com: article class= product_pod div class= image_container a href= catalogue/a-light-in-the-attic_1000/index.html img src= media/cache/2c/da/2cdad67c44b002e7ead0cc35693c0e8b.jpg alt= A Light in the Attic class= thumbnail /a /div p class= star-rating Three i class= icon-star /i i class= icon-star /i i class= icon-star /i i class= icon-star /i i class= icon-star /i /p h3 a href= catalogue/a-light-in-the-attic_1000/index.html title= A Light in the Attic A Light in the ... /a /h3 div class= product_price p class= price_color \u00a351.77 /p p class= instock availability i class= icon-ok /i In stock /p form button type= submit class= btn btn-primary btn-block data-loading-text= Adding... Add to basket /button /form /div /article And we will get the following JSON object: { title : A Light in the Attic , amount : 51.77, url : http://books.toscrape.com/catalogue/a-light-in-the-attic_1000/index.html , fileurl : http://books.toscrape.com/media/cache/2c/da/2cdad67c44b002e7ead0cc35693c0e8b.jpg , filename : A Light in the Attic.jpg } The code sample includes some other function to manipulate the result object, but we have the idea. Once we build a correct object, we can save it to Cozy Stack. Save data to Cozy Stack In the example we use some built-in function to save a bill to the Cozy Stack. But there is a bunch of functions available depending on what you want: addData filterData saveBills saveFiles and so on\u2026 We can find more information in the libs repository . Now that we pass on every steps, it is time to test the connector with yarn standalone . We will see in the following how to connect it effectively to a Cozy Stack. Going further Connector structure Basically, a connector is just a function passed to the BaseKonnector constructor, and which eventually returns a promise: To create the connector, just create a new instance of BaseKonnector with a function as argument: const {BaseKonnector} = require('cozy-konnector-libs') module.exports = new BaseKonnector(fields = { // use fields to get user credentials and choices console.log(fields, 'fields') }) Typical workflow Everytime the connector is run, it will call the function and wait for the resolution of the returned promise. This function can then: log into the target website, fetch data, and save them as an array of objects with specific attributes expected by the save function ( saveFiles , addData , filterData , saveBills ). A basic connector workflow involves: authenticate on the website or API. Might be tricky, but that s the fun :-) getting data from the online service. You can get the data by calling an API or scraping the webpage. Check if the webpage itself is not using an API to retrieve data, might speed up our job. Mobile phones applications usually connects to an API that might be a reliable source of data. A quick exemple of a scraper here . filtering data to remove the ones already present inside the database using filterData save the filtered data into the database ( addData ) save the related files using ( saveFiles ) Error handling If your connector hits an issue fetching or saving the data, it can return an error code by throwing it as an error. The error codes are defined inside the Cozy Collect application and will display an explicit error to the user: LOGIN_FAILED : the konnector could not login NOT_EXISTING_DIRECTORY : the folder specified as folder_to_save does not exist (checked automatically by the BaseKonnector) UNKNOWN_ERROR : there was an unexpected error, please take a look at the logs to know what appened VENDOR_DOWN : the target web site is down now USER_ACTION_NEEDED : The user needs to login to the service to do manual actions (could be Terms Of Service to validate) You can get the list of error codes in require('cozy-konnector-libs').errors ( source ) const {BaseKonnector, errors} = require('cozy-konnector-libs') module.exports = new BaseKonnector(fields = { // Here, the following message will be displayed in cozy-collect : Bad credentials. Check the konnector fields and run the connection again. throw new Error(errors.LOGIN_FAILED) }) cozy-konnector-libs The Cozy Konnector Libs provide several useful methods for common tasks: BaseKonnector : creates the connector and fetches from the stack the connector s parameters (COZY_FIELDS ) cozyClient gives an instance of cozy-client-js already initialized according to COZY_URL , and COZY_CREDENTIALS . Your code can immediately interact with the server thanks to this client. requestFactory a function which returns an instance of request-promise initialized with defaults often used in connector development. log allows to log messages with different levels filterData to filter data addData to store the retrieved data into the cozy linkBankOperations to link a bill to a bank operation saveBills which uses filterData, addData, saveFiles and linkBankOperations and which is specific to bills updateOrCreate create or update documents inside database Linking your connector to a cozy : dev mode After several yarn standalone , your connector is able to automaticaly gather data from the targeted web service. It s time now to put this data in a real cozy. Here comes the dev mode . For that your connector needs more setup : a manifest.konnector file a COZY_URL section in konnector-dev-config.json The manifest Each connector is described by a manifest. This is a JSON file named manifest.konnector at the root of your code folder. It should include the following minimal information: { name : konnector name , type : node , slug : konnectorslug , description : description , source : git://github.com/cozy/cozy-konnector-thename.git , permissions : { accounts : { description : Required to get the account's data , type : io.cozy.accounts , verbs : [ GET ] } } } cozy-konnector-template already has a manifest which you can customize. You may add some permissions for your own doctype. Here is the detailed list of fields for a connector manifest file. You can also get more information on permissions in the official cozy-stack documentation konnector-dev-config.json If you want to put data from your connector to a real cozy, your must define where to find this cozy, and this must be a cozy for which you have the credentials. Here comes the COZY_URL in konnector-dev-config.json which defines just that. Run the dev mode Then you just have to run: yarn dev For the first run, the CLI will open a tab in your browser asking you to grant permissions to the connector. The connector will then save data directly into your cozy. This will validate that your manifest has the needed permissions on the data you want to save. This is the dev mode Integration in the store for all the users To run a connector, we do not want the cozy to install all dependencies of the connector each time it installs it. To avoid this, the connectors need to be compiled into one file in a dedicated branch of the repository and the repository needs to be a public git repository. The package.json file from cozy-konnector-template gives you the commands to do this : yarn build and yarn deploy but the last one needs to be configured in package.json Once your public git repository is configured, you only have to declare it. Cozy will soon have a store for connectors and you will be able to publish connectors yourself. But at the moment, you need to declare your new connector on the cozy forum . The Cozy team will review your code and add your connector to the Cozy Collect application. To make the connector available more quickly for all cozys, you can follow this few steps of packaging: Icon You need to push an icon in assets/ . Please respect this rules : Square icon, possibly a png or svg Try the Apple app store icon if needed Package.json Edit the name to be cozy-konnector- slug> Edit the repository URL Edit the command deploy with the correct repository URL Manifest.konnector Edit the name with a nice name (Capitals and spaces allowed here) Edit icon as needed Edit slug Edit source with the correct repository URL Add a correct vendor link Choose one or more categories in this list : banking, shopping, insurance, isp, telecom, energy, public_service, other If needed, change the input type the target website use to login the user: text , email or phone for instance, this will enforce pre-checking Edit for both locales en and fr the short description and long description FAQ When I run my connector, a ghost node process eats all my memory Cozy-konnector-libs uses cheerio which is great but causes some problems when you try to console.log a cheerio object. In standalone or dev mode, the BaseKonnector tries to catch errors and display a maximum of details about them. But when the error contains a cheerio object, the problem happens. If you get this problem, catch the error yourself and only display the message : .catch(err) { console.log(err.message) // good console.log(err) // bad } How do I scrap a website Use the request function from cozy-konnector-libs with the proper options. Here\u2019s a sample code that will fetch the login page to get the value of the anti-CSRF token, submit the login form, browse to the bills page and fetch a bill: const {BaseKonnector, requestFactory} = require('cozy-konnector-libs') const rq = requestFactory({ jar: true, // handle the cookies like a browser json: false, // do not try to parse the result as a json document cheerio: true // automatically parse the result with [cheerio](https://github.com/cheeriojs/cheerio) }) const moment = require('moment') module.exports = new BaseKonnector(function fetch (fields) { return rq( https://login.remote.web ) .then($ = { // the result is automatically wrapped with cheerio and you can use it like jQuery const form = { form: { login: fields.login, password: fields.password, csrf_token: $('[name= csrf_token ]').val(), } } return rq({ method: 'POST', form }) }) .then($ = rq( https://admin.remote.web/bills )) .then($ = { return [{date: moment($( #bill_date )), value: $( #bill_value )}] }) .then(entries = addData(entries, 'io.cozy.bills')) })","title":"Develop a connector"},{"location":"/dev/konnector/#how-to-write-a-connector","text":"","title":"How to write a connector"},{"location":"/dev/konnector/#introduction","text":"A connector (also known as konnector ) is a script that imports data from another web service and put those data into your cozy. Each connector is an independant application, managed by the Cozy Collect application. To protect your data, each connector runs inside a container in order to sandbox all their interactions with your data.","title":"Introduction"},{"location":"/dev/konnector/#how-does-it-work","text":"A connector is a NodeJS script. The target node version used to run your connector is the current LTS version (8 at the time this doc was written). Like client side apps, connectors communicate with the Cozy Stack using its HTTP API, and get an unique auth token every time they start. They need to register with a manifest, and ask the user for permissions. To facilitate connector development, a npm package, [konnectors/libs], provides some shared libraries that are adapted to be used for a connector: cheerio to easily query a HTML page request-promise : request with Promise support request-debug that displays all the requests and responses in the standard output. Toggle debug option in requestFactory options Besides, you ll probably need some other npm packages to help you run your connector: momentjs or date-fns to manage dates bluebird to get enhanced promises When the connector is started, it also receives some data via environment variables: COZY_CREDENTIALS : an auth token used by cozy-client-js to communicate with the server COZY_URL : the Cozy Stack API entry point COZY_FIELDS : settings coming from Cozy Collect and filled by the user (login, password, directory path). These variables are used by the connector and the cozy-client to configure the connection to the Cozy Stack with the right permissions as defined in the connector manifest. They are simulated in standalone mode so that you do not need a real Cozy Stack to develop a connector. [ More about BaseKonnector ] From the server point of view, each connector is a job which is executed periodically via a trigger . [ More about Cozy Stack jobs ]","title":"How does it work?"},{"location":"/dev/konnector/#lets-create-our-first-connector","text":"The easiest way to create a new connector is to use cozy-konnector-template :","title":"Let\u2019s create our first connector"},{"location":"/dev/konnector/#run-the-sample","text":"First of all, download or clone the repository: git clone https://github.com/konnectors/cozy-konnector-template cozy-konnector-newservice cd cozy-konnector-newservice rm -rf .git git init yarn install # or npm install note: we use yarn , but if you prefer npm , keep using it, everything should work. The connector is ready to run with sample code. As a demo we will scrape a fictional website: books.toscrape.com , for which you do not need credentials . As indicated in the README.md file, just run: yarn standalone # or npm run standalone The very first run will create a konnector-dev-config.json file that allows you to configure the connector input when executing it with the CLI. This configuration comes from Cozy Collect when deployed. { COZY_URL : http://cozy.tools:8080 , fields : { // configuration injected to the start function } } The fields property allow you to set credentials for the targeted web service, such as login and password as if they come from Cozy Stack . The COZY_URL property will be used later. As explained earlier, the demo website books.toscrape.com does not need any credentials. But for the code to run without error, you need to register a fake login and a fake password: { COZY_URL : http://cozy.tools:8080 , fields : { login : zuck.m@rk.fb , password : 123456 } } In cozy-konnector-template, this configuration file is already added to .gitignore file to be sure your credentials stay private. Now you can run the connector again in standalone mode to see how jpg and related data are downloaded. In this mode, [ cozy-client-js ] is stubbed and all data meant to be saved in a cozy are displayed in the standard output and files are saved in the root directory of the connector. This is useful to start developing your connector without handling the state of a real Cozy Stack . Please check CLI section of the documentation for more information.","title":"Run the sample"},{"location":"/dev/konnector/#implement-your-connector","text":"There are four steps for a connector to save data to Cozy Stack : authentication request data parse and format data save data to cozy stack You can see these steps in the src/index.js in the konnectors/cozy-konnector-template : async function start(fields) { // step 1. log('info', 'Authenticating ...') await authenticate(fields.login, fields.password) log('info', 'Successfully logged in') // step 2. // The BaseKonnector instance expects a Promise as return of the function log('info', 'Fetching the list of documents') const $ = await request(`${baseUrl}/index.html`) // step 3. log('info', 'Parsing list of documents') const documents = await parseDocuments($) // step 4. // here we use the saveBills function even if what we fetch are not bills, but this is the most // common case in connectors log('info', 'Saving data to Cozy') await saveBills(documents, fields.folderPath, { // this is a bank identifier which will be used to link bills to bank operations. These // identifiers should be at least a word found in the title of a bank operation related to this // bill. It is not case sensitive. identifiers: ['books'] }) }","title":"Implement your connector"},{"location":"/dev/konnector/#authentication","text":"Open the src/index.js file, there are comments to guide you through it. The very first step is to be able to authenticate to the remote service, this is done with the line: await authenticate(fields.login, fields.password) There are many obstacles at this level: is there a captcha? is there a 2FA? how is the form ? note: if the remote service exposes an API, you should use classical request call. Let s say the remote service exposes a simple classical form like https://www.trainline.eu/signin: form id= signin-form novalidate= class= signin__form data-ember-action= data-ember-action-680= 680 input name= email autocomplete= on placeholder= Email Address id= ember691 class= ember-text-field textfield ember-view data-enpass.usermodified= yes type= email input name= password autocomplete= on placeholder= Password id= ember696 class= ember-text-field textfield ember-view data-enpass.usermodified= yes type= password div class= signin__forgot span data-ember-action= data-ember-action-697= 697 a href= /password id= ember698 class= ember-view Forgot your password? /a /span /div div class= signin__buttons div class= signin__buttons-block button type= submit class= signin__button Sign In /button /div /div /form Find a CSS selector for the form tag: form#signin-form . Find the name of the input tags used to host user s credentials: email and password . You are ready to complete the signin(options) object called in the authenticate(username, password) function: function authenticate(username, password) { return signin({ url: `https://www.trainline.eu/signin`, formSelector: 'form#signin-form', formData: { email: username, password }, validate: (statusCode, $) = { // write some code to validate the form submission } }) } To implement the validate function, you need to check what is happening on a successful login and on an unsuccessful login. With the https://www.trainline.eu/signin example, fill the form with wrong credentials, open your browser s devtools (and check the network tab) and submit the form. Here it is clear, on incorrect credentials, the response have a status code 422 : HTTP/2.0 422 No Reason Phrase Do the same with valid crendentials. HTTP/2.0 200 OK Then you can write a simple and straight forward validate code: function authenticate(username, password) { return signin({ url: `https://www.trainline.eu/signin`, formSelector: 'form#signin-form', formData: { email: username, password }, validate: (statusCode, $) = { return statusCode === 200 || log('error', 'Invalid credentials') } }) }","title":"Authentication"},{"location":"/dev/konnector/#request-data","text":"Once the konnector is able to be authenticated by the online service, the next step is to fetch data. The most common case is that the invoices we want to fetch are listed in a HTML page. So to request data, we fetch the target webpage that contains invoices list. But sometimes, the webpage is a JavaScript page that uses a JSON API url. JSON is easier to parse than full HTML webpages. For the purpose of this guide, let s consider we are in the case of a full HTML webpage, like the service given as an example in the template: http://books.toscrape.com This is the easiest part, juste fetch the webpage: const $ = await request('http://books.toscrape.com/index.html') The $ variable is set to a cheerio object with useful API to crawl the webpage . That object will be very useful for the next step.","title":"Request data"},{"location":"/dev/konnector/#parse-the-document","text":"We want to get every article / of the page in a JavaScript Array: const articles = [].map.call($('article', node = node)) For every book, we want to catch the title attribute of this tag article h3 a . This is a CSS Selector that cheerio understands to select some part of the tree. In order to crawl a list of items to create an Array of json object, we can use the function scrape from the konnector libs : const docs = scrape( $, { title: { sel: 'h3 a', attr: 'title' }, amount: { sel: '.price_color', parse: normalizePrice }, url: { sel: 'h3 a', attr: 'href', parse: url = `${baseUrl}/${url}` }, fileurl: { sel: 'img', attr: 'src', parse: src = `${baseUrl}/${src}` }, filename: { sel: 'h3 a', attr: 'title', parse: title = `${title}.jpg` } }, 'article' ) This code will loop on article / and for each item will create a JSON object with the selector sel and the value of attribute attr if specified, otherwise it takes the value of the child node, this value can be edited with the parse function. Here is a sample for the following markup from http://books.toscrape.com: article class= product_pod div class= image_container a href= catalogue/a-light-in-the-attic_1000/index.html img src= media/cache/2c/da/2cdad67c44b002e7ead0cc35693c0e8b.jpg alt= A Light in the Attic class= thumbnail /a /div p class= star-rating Three i class= icon-star /i i class= icon-star /i i class= icon-star /i i class= icon-star /i i class= icon-star /i /p h3 a href= catalogue/a-light-in-the-attic_1000/index.html title= A Light in the Attic A Light in the ... /a /h3 div class= product_price p class= price_color \u00a351.77 /p p class= instock availability i class= icon-ok /i In stock /p form button type= submit class= btn btn-primary btn-block data-loading-text= Adding... Add to basket /button /form /div /article And we will get the following JSON object: { title : A Light in the Attic , amount : 51.77, url : http://books.toscrape.com/catalogue/a-light-in-the-attic_1000/index.html , fileurl : http://books.toscrape.com/media/cache/2c/da/2cdad67c44b002e7ead0cc35693c0e8b.jpg , filename : A Light in the Attic.jpg } The code sample includes some other function to manipulate the result object, but we have the idea. Once we build a correct object, we can save it to Cozy Stack.","title":"Parse the document"},{"location":"/dev/konnector/#save-data-to-cozy-stack","text":"In the example we use some built-in function to save a bill to the Cozy Stack. But there is a bunch of functions available depending on what you want: addData filterData saveBills saveFiles and so on\u2026 We can find more information in the libs repository . Now that we pass on every steps, it is time to test the connector with yarn standalone . We will see in the following how to connect it effectively to a Cozy Stack.","title":"Save data to Cozy Stack"},{"location":"/dev/konnector/#going-further","text":"","title":"Going further"},{"location":"/dev/konnector/#connector-structure","text":"Basically, a connector is just a function passed to the BaseKonnector constructor, and which eventually returns a promise: To create the connector, just create a new instance of BaseKonnector with a function as argument: const {BaseKonnector} = require('cozy-konnector-libs') module.exports = new BaseKonnector(fields = { // use fields to get user credentials and choices console.log(fields, 'fields') })","title":"Connector structure"},{"location":"/dev/konnector/#typical-workflow","text":"Everytime the connector is run, it will call the function and wait for the resolution of the returned promise. This function can then: log into the target website, fetch data, and save them as an array of objects with specific attributes expected by the save function ( saveFiles , addData , filterData , saveBills ). A basic connector workflow involves: authenticate on the website or API. Might be tricky, but that s the fun :-) getting data from the online service. You can get the data by calling an API or scraping the webpage. Check if the webpage itself is not using an API to retrieve data, might speed up our job. Mobile phones applications usually connects to an API that might be a reliable source of data. A quick exemple of a scraper here . filtering data to remove the ones already present inside the database using filterData save the filtered data into the database ( addData ) save the related files using ( saveFiles )","title":"Typical workflow"},{"location":"/dev/konnector/#error-handling","text":"If your connector hits an issue fetching or saving the data, it can return an error code by throwing it as an error. The error codes are defined inside the Cozy Collect application and will display an explicit error to the user: LOGIN_FAILED : the konnector could not login NOT_EXISTING_DIRECTORY : the folder specified as folder_to_save does not exist (checked automatically by the BaseKonnector) UNKNOWN_ERROR : there was an unexpected error, please take a look at the logs to know what appened VENDOR_DOWN : the target web site is down now USER_ACTION_NEEDED : The user needs to login to the service to do manual actions (could be Terms Of Service to validate) You can get the list of error codes in require('cozy-konnector-libs').errors ( source ) const {BaseKonnector, errors} = require('cozy-konnector-libs') module.exports = new BaseKonnector(fields = { // Here, the following message will be displayed in cozy-collect : Bad credentials. Check the konnector fields and run the connection again. throw new Error(errors.LOGIN_FAILED) })","title":"Error handling"},{"location":"/dev/konnector/#cozy-konnector-libs","text":"The Cozy Konnector Libs provide several useful methods for common tasks: BaseKonnector : creates the connector and fetches from the stack the connector s parameters (COZY_FIELDS ) cozyClient gives an instance of cozy-client-js already initialized according to COZY_URL , and COZY_CREDENTIALS . Your code can immediately interact with the server thanks to this client. requestFactory a function which returns an instance of request-promise initialized with defaults often used in connector development. log allows to log messages with different levels filterData to filter data addData to store the retrieved data into the cozy linkBankOperations to link a bill to a bank operation saveBills which uses filterData, addData, saveFiles and linkBankOperations and which is specific to bills updateOrCreate create or update documents inside database","title":"cozy-konnector-libs"},{"location":"/dev/konnector/#linking-your-connector-to-a-cozy-dev-mode","text":"After several yarn standalone , your connector is able to automaticaly gather data from the targeted web service. It s time now to put this data in a real cozy. Here comes the dev mode . For that your connector needs more setup : a manifest.konnector file a COZY_URL section in konnector-dev-config.json","title":"Linking your connector to a cozy : dev mode"},{"location":"/dev/konnector/#the-manifest","text":"Each connector is described by a manifest. This is a JSON file named manifest.konnector at the root of your code folder. It should include the following minimal information: { name : konnector name , type : node , slug : konnectorslug , description : description , source : git://github.com/cozy/cozy-konnector-thename.git , permissions : { accounts : { description : Required to get the account's data , type : io.cozy.accounts , verbs : [ GET ] } } } cozy-konnector-template already has a manifest which you can customize. You may add some permissions for your own doctype. Here is the detailed list of fields for a connector manifest file. You can also get more information on permissions in the official cozy-stack documentation","title":"The manifest"},{"location":"/dev/konnector/#konnector-dev-configjson","text":"If you want to put data from your connector to a real cozy, your must define where to find this cozy, and this must be a cozy for which you have the credentials. Here comes the COZY_URL in konnector-dev-config.json which defines just that.","title":"konnector-dev-config.json"},{"location":"/dev/konnector/#run-the-dev-mode","text":"Then you just have to run: yarn dev For the first run, the CLI will open a tab in your browser asking you to grant permissions to the connector. The connector will then save data directly into your cozy. This will validate that your manifest has the needed permissions on the data you want to save. This is the dev mode","title":"Run the dev mode"},{"location":"/dev/konnector/#integration-in-the-store-for-all-the-users","text":"To run a connector, we do not want the cozy to install all dependencies of the connector each time it installs it. To avoid this, the connectors need to be compiled into one file in a dedicated branch of the repository and the repository needs to be a public git repository. The package.json file from cozy-konnector-template gives you the commands to do this : yarn build and yarn deploy but the last one needs to be configured in package.json Once your public git repository is configured, you only have to declare it. Cozy will soon have a store for connectors and you will be able to publish connectors yourself. But at the moment, you need to declare your new connector on the cozy forum . The Cozy team will review your code and add your connector to the Cozy Collect application. To make the connector available more quickly for all cozys, you can follow this few steps of packaging:","title":"Integration in the store for all the users"},{"location":"/dev/konnector/#icon","text":"You need to push an icon in assets/ . Please respect this rules : Square icon, possibly a png or svg Try the Apple app store icon if needed","title":"Icon"},{"location":"/dev/konnector/#packagejson","text":"Edit the name to be cozy-konnector- slug> Edit the repository URL Edit the command deploy with the correct repository URL","title":"Package.json"},{"location":"/dev/konnector/#manifestkonnector","text":"Edit the name with a nice name (Capitals and spaces allowed here) Edit icon as needed Edit slug Edit source with the correct repository URL Add a correct vendor link Choose one or more categories in this list : banking, shopping, insurance, isp, telecom, energy, public_service, other If needed, change the input type the target website use to login the user: text , email or phone for instance, this will enforce pre-checking Edit for both locales en and fr the short description and long description","title":"Manifest.konnector"},{"location":"/dev/konnector/#faq","text":"","title":"FAQ"},{"location":"/dev/konnector/#when-i-run-my-connector-a-ghost-node-process-eats-all-my-memory","text":"Cozy-konnector-libs uses cheerio which is great but causes some problems when you try to console.log a cheerio object. In standalone or dev mode, the BaseKonnector tries to catch errors and display a maximum of details about them. But when the error contains a cheerio object, the problem happens. If you get this problem, catch the error yourself and only display the message : .catch(err) { console.log(err.message) // good console.log(err) // bad }","title":"When I run my connector, a ghost node process eats all my memory"},{"location":"/dev/konnector/#how-do-i-scrap-a-website","text":"Use the request function from cozy-konnector-libs with the proper options. Here\u2019s a sample code that will fetch the login page to get the value of the anti-CSRF token, submit the login form, browse to the bills page and fetch a bill: const {BaseKonnector, requestFactory} = require('cozy-konnector-libs') const rq = requestFactory({ jar: true, // handle the cookies like a browser json: false, // do not try to parse the result as a json document cheerio: true // automatically parse the result with [cheerio](https://github.com/cheeriojs/cheerio) }) const moment = require('moment') module.exports = new BaseKonnector(function fetch (fields) { return rq( https://login.remote.web ) .then($ = { // the result is automatically wrapped with cheerio and you can use it like jQuery const form = { form: { login: fields.login, password: fields.password, csrf_token: $('[name= csrf_token ]').val(), } } return rq({ method: 'POST', form }) }) .then($ = rq( https://admin.remote.web/bills )) .then($ = { return [{date: moment($( #bill_date )), value: $( #bill_value )}] }) .then(entries = addData(entries, 'io.cozy.bills')) })","title":"How do I scrap a website"},{"location":"/dev/cordova/","text":"How to create a mobile Cozy application The simplest way to create a mobile Cozy application is to use JavaScript as there already are JavaScript libraries to connect to the Cozy server, as known as cozy-stack. Therefore we will use the classical stack: a JavaScript web application and cordova At the end of this documentation , you will find how-tos to help you with cordova configuration , webpack builds and cordova deployments for Android and iOS . To create your first Cozy application , just follow the guide. As you can read there, Cozy applications are served by the Cozy server, this is the way that Cozy applications retrieve a token to query data. In the case of a mobile application, you need to retrieve a token differently. Hopefully we provide everything you need to do it easily. You ll need two libraries: cozy-client ( source ) cozy-bar ( source ) In the case of Cozy web applications served by the Cozy server, these two libraries are injected in the html file with variables {{.CozyClientJS}} and {{.CozyBar}} . Setup index.html First thing first, add JavaScript libraries files into your index.html : !DOCTYPE html html lang= en head meta charset= utf-8 title mobile Cozy application with Cordova /title script src= cozy-client.js /script script src= cozy-bar.js /script /head body !-- page content -- /body /html Connect to Cozy server When an user will start your mobile Cozy application, she/he will need to point to her/his server url to ask for permissions for her/his device. This is done by our library cozy-client , you just need to add a HTML form: form id= form label What is your cozy server url? input name= url id= url type= text / /label button type= submit Submit /button /form const urlInput = document.getElementById( url ); const form = document.getElementById( form ); form.addEventListener( submit , registerClient); function registerClient (event) { event.preventDefault(); const url = urlInput.value; const { client, token } = await cozyClient.register(url); // do whatever you need with client and token like persist } JS Bin on jsbin.com When cozyClient.register(url) is called, the cordova inapp browser plugin is used to display a password request and a permission acceptation page to let the end-user to register her/his device. That s all! Then you can use the cozy-client library as you would within a classic Cozy application . Initialize the Cozy bar The Cozy bar needs some information to be initialized and its initialization must be done in your front-end code: cozy.bar.init({ appName: App Name , appEditor: Editor Name , iconPath: require( ./assets/app-icon.svg ), lang: en-US , replaceTitleOnMobile: true }) Use Cordova Install and setup cordova Cordova is a tool to build Android and iOS applications from a web app. It works with a CLI that needs node . Look at the cordova documentation to install everything needed . Once cordova is installed, just run cordova create cozy-app com.example.cozyapp CozyApp and you get the following structure: ./ \u251c\u2500\u2500 config.xml \u251c\u2500\u2500 hooks \u2502 \u2514\u2500\u2500 README.md \u251c\u2500\u2500 platforms \u251c\u2500\u2500 plugins \u2514\u2500\u2500 www \u251c\u2500\u2500 css \u2502 \u2514\u2500\u2500 index.css \u251c\u2500\u2500 img \u2502 \u2514\u2500\u2500 logo.png \u251c\u2500\u2500 index.html \u2514\u2500\u2500 js \u2514\u2500\u2500 index.js 7 directories, 6 files Note: everything you put in www/ will be served as your application content. Configure your build tool If you use a build tool to transpile your JavaScript code, you need to configure your tool to output the build into www/ . webpack configuration As Webpack is the most used build tool we will show you how to configure it with cordova: Create a webpack.config.js on the root folder of your project with: const path = require('path'); module.exports = { entry: './src/app.js', output: { filename: 'bundle.js', path.resolve(__dirname, 'www') } } And add the output bundle in the www/index.html file: html head ... /head body ... script src= bundle.js /script /body /html See the official webpack documentation for more details. Cordova Android Platform Use cordova platform add android and check your environment with cordova requirements : A bad requirements check: Requirements check results for android: Java JDK: installed . Android SDK: installed Android target: not installed Android SDK not found. Make sure that it is installed. If it is not at the default location, set the ANDROID_HOME environment variable. Gradle: installed Error: Some of requirements check failed A good requirements check: Requirements check results for android: Java JDK: installed . Android SDK: installed Android target: installed android-19,android-21,android-22,android-23,Google Inc.:Google APIs:19,Google Inc.:Google APIs (x86 System Image):19,Google Inc.:Google APIs:23 Gradle: installed See cordova, android and ios documentation to customize your development environment for your special needs. Once everything is right, you could run cordova build and cordova run android to create an APK and push the APK on a device. Note: The device should be connected with usb. See official android documentation for more details . iOS development For building an iOS app, you need xcode . [[more to come]] See further details on the cordova official documentation about iOS .","title":"Create a mobile app with cordova"},{"location":"/dev/cordova/#how-to-create-a-mobile-cozy-application","text":"The simplest way to create a mobile Cozy application is to use JavaScript as there already are JavaScript libraries to connect to the Cozy server, as known as cozy-stack. Therefore we will use the classical stack: a JavaScript web application and cordova At the end of this documentation , you will find how-tos to help you with cordova configuration , webpack builds and cordova deployments for Android and iOS . To create your first Cozy application , just follow the guide. As you can read there, Cozy applications are served by the Cozy server, this is the way that Cozy applications retrieve a token to query data. In the case of a mobile application, you need to retrieve a token differently. Hopefully we provide everything you need to do it easily. You ll need two libraries: cozy-client ( source ) cozy-bar ( source ) In the case of Cozy web applications served by the Cozy server, these two libraries are injected in the html file with variables {{.CozyClientJS}} and {{.CozyBar}} .","title":"How to create a mobile Cozy application"},{"location":"/dev/cordova/#setup-indexhtml","text":"First thing first, add JavaScript libraries files into your index.html : !DOCTYPE html html lang= en head meta charset= utf-8 title mobile Cozy application with Cordova /title script src= cozy-client.js /script script src= cozy-bar.js /script /head body !-- page content -- /body /html","title":"Setup index.html"},{"location":"/dev/cordova/#connect-to-cozy-server","text":"When an user will start your mobile Cozy application, she/he will need to point to her/his server url to ask for permissions for her/his device. This is done by our library cozy-client , you just need to add a HTML form: form id= form label What is your cozy server url? input name= url id= url type= text / /label button type= submit Submit /button /form const urlInput = document.getElementById( url ); const form = document.getElementById( form ); form.addEventListener( submit , registerClient); function registerClient (event) { event.preventDefault(); const url = urlInput.value; const { client, token } = await cozyClient.register(url); // do whatever you need with client and token like persist } JS Bin on jsbin.com When cozyClient.register(url) is called, the cordova inapp browser plugin is used to display a password request and a permission acceptation page to let the end-user to register her/his device. That s all! Then you can use the cozy-client library as you would within a classic Cozy application .","title":"Connect to Cozy server"},{"location":"/dev/cordova/#initialize-the-cozy-bar","text":"The Cozy bar needs some information to be initialized and its initialization must be done in your front-end code: cozy.bar.init({ appName: App Name , appEditor: Editor Name , iconPath: require( ./assets/app-icon.svg ), lang: en-US , replaceTitleOnMobile: true })","title":"Initialize the Cozy bar"},{"location":"/dev/cordova/#use-cordova","text":"","title":"Use Cordova"},{"location":"/dev/cordova/#install-and-setup-cordova","text":"Cordova is a tool to build Android and iOS applications from a web app. It works with a CLI that needs node . Look at the cordova documentation to install everything needed . Once cordova is installed, just run cordova create cozy-app com.example.cozyapp CozyApp and you get the following structure: ./ \u251c\u2500\u2500 config.xml \u251c\u2500\u2500 hooks \u2502 \u2514\u2500\u2500 README.md \u251c\u2500\u2500 platforms \u251c\u2500\u2500 plugins \u2514\u2500\u2500 www \u251c\u2500\u2500 css \u2502 \u2514\u2500\u2500 index.css \u251c\u2500\u2500 img \u2502 \u2514\u2500\u2500 logo.png \u251c\u2500\u2500 index.html \u2514\u2500\u2500 js \u2514\u2500\u2500 index.js 7 directories, 6 files Note: everything you put in www/ will be served as your application content.","title":"Install and setup cordova"},{"location":"/dev/cordova/#configure-your-build-tool","text":"If you use a build tool to transpile your JavaScript code, you need to configure your tool to output the build into www/ .","title":"Configure your build tool"},{"location":"/dev/cordova/#webpack-configuration","text":"As Webpack is the most used build tool we will show you how to configure it with cordova: Create a webpack.config.js on the root folder of your project with: const path = require('path'); module.exports = { entry: './src/app.js', output: { filename: 'bundle.js', path.resolve(__dirname, 'www') } } And add the output bundle in the www/index.html file: html head ... /head body ... script src= bundle.js /script /body /html See the official webpack documentation for more details.","title":"webpack configuration"},{"location":"/dev/cordova/#cordova","text":"","title":"Cordova"},{"location":"/dev/cordova/#android-platform","text":"Use cordova platform add android and check your environment with cordova requirements : A bad requirements check: Requirements check results for android: Java JDK: installed . Android SDK: installed Android target: not installed Android SDK not found. Make sure that it is installed. If it is not at the default location, set the ANDROID_HOME environment variable. Gradle: installed Error: Some of requirements check failed A good requirements check: Requirements check results for android: Java JDK: installed . Android SDK: installed Android target: installed android-19,android-21,android-22,android-23,Google Inc.:Google APIs:19,Google Inc.:Google APIs (x86 System Image):19,Google Inc.:Google APIs:23 Gradle: installed See cordova, android and ios documentation to customize your development environment for your special needs. Once everything is right, you could run cordova build and cordova run android to create an APK and push the APK on a device. Note: The device should be connected with usb. See official android documentation for more details .","title":"Android Platform"},{"location":"/dev/cordova/#ios-development","text":"For building an iOS app, you need xcode . [[more to come]] See further details on the cordova official documentation about iOS .","title":"iOS development"},{"location":"/dev/sendmail/","text":"Share and send mail in development Cozy apps let users share documents from cozy to cozy . Meet Alice and Bob. Alice wants to share a folder with Bob. Alice clicks on the share button and fills in the email input with Bob s email address. Bob receives an email with a \u00ab Accept the sharing \u00bb button. Bob clicks on that button and is redirected to Alice s cozy to enter his own cozy url to link both cozys. Bob sees Alice s shared folder in his own cozy. \ud83e\udd14 But how could we do this scenario on development environment? With the docker image If you develop with the cozy-app-dev docker image , MailHog is running inside it to catch emails. If cozy-stack has to send an email, MailHog catches it and exposes it on its web interface on http://cozy.tools:8025/. With the binary cozy-stack If you develop with the cozy-stack CLI , you have to run MailHog on your computer and tell cozy-stack serve where to find the mail server with some options : ./cozy-stack serve --appdir drive:../cozy-drive/build,settings:../cozy-settings/build --mail-disable-tls --mail-port 1025 This commands assumes you git clone cozy-drive and cozy-settings in the same folder than you git clone cozy-stack . Then simply run MailHog and open http://cozy.tools:8025/. Retrieve sent emails With MailHog, every email sent by cozy-stack is caught. That means the email address does not have to be a real one , ie. bob@cozy , bob@cozy.tools are perfectly fine. It could be a real one , but the email will not reach the real recipient s inbox, say contact@cozycloud.cc .","title":"How to send mail in development"},{"location":"/dev/sendmail/#share-and-send-mail-in-development","text":"Cozy apps let users share documents from cozy to cozy . Meet Alice and Bob. Alice wants to share a folder with Bob. Alice clicks on the share button and fills in the email input with Bob s email address. Bob receives an email with a \u00ab Accept the sharing \u00bb button. Bob clicks on that button and is redirected to Alice s cozy to enter his own cozy url to link both cozys. Bob sees Alice s shared folder in his own cozy. \ud83e\udd14 But how could we do this scenario on development environment?","title":"Share and send mail in development"},{"location":"/dev/sendmail/#with-the-docker-image","text":"If you develop with the cozy-app-dev docker image , MailHog is running inside it to catch emails. If cozy-stack has to send an email, MailHog catches it and exposes it on its web interface on http://cozy.tools:8025/.","title":"With the docker image"},{"location":"/dev/sendmail/#with-the-binary-cozy-stack","text":"If you develop with the cozy-stack CLI , you have to run MailHog on your computer and tell cozy-stack serve where to find the mail server with some options : ./cozy-stack serve --appdir drive:../cozy-drive/build,settings:../cozy-settings/build --mail-disable-tls --mail-port 1025 This commands assumes you git clone cozy-drive and cozy-settings in the same folder than you git clone cozy-stack . Then simply run MailHog and open http://cozy.tools:8025/.","title":"With the binary cozy-stack"},{"location":"/dev/sendmail/#retrieve-sent-emails","text":"With MailHog, every email sent by cozy-stack is caught. That means the email address does not have to be a real one , ie. bob@cozy , bob@cozy.tools are perfectly fine. It could be a real one , but the email will not reach the real recipient s inbox, say contact@cozycloud.cc .","title":"Retrieve sent emails"},{"location":"/cozy-client-js/intro/","text":"Introduction to cozy-client-js Reminder about cozy architectures There is two actives cozy architectures: The first, thereafter named v2 is the existing cozy structure. It s based on 1 container / user with many node.js processes in each container (cozy-data-system, cozy-proxy, cozy-home, 1 process per app). The second, thereafter named v3 is the new cozy-stack ( repository ). It s based on go and aim to support multiple user on a single process. v2 supported both server-side applications with their own node.js process and client-side applications which run in the user browser. v3 will not support server-side applications. We will support server side modules managed by server administrator, but the applications themselves will all be client-side application. This repository provides a library which allows you to build a client-side application compatible with both version. The former javascript library for making client-side application was cozy-browser-sdk . We aim to deprecate it once cozy-client-js reaches feature-parity. If you already have an application using cozy-browser-sdk , you can see what will change in the transition document . If you have any doubt, please open an issue! Include the library in your application You can import / require cozy-client-js using npm webpack. You can also copy-paste the dist/cozy-client.js bundle file into your application, and include it in your application index.html with script src=\"./cozy-client.js\" . If you are developing a client-side app for Cozy V3, you can import the lib directly from the stack, by using {{.CozyClientJS}} . If you are developing a nodejs app, you will need some polyfills. You can add them to your project with this command: $ yarn add isomorphic-fetch core-js regenerator-runtime btoa Doctypes Permissions A doctype is a simple javascript string identifying a type of document. Some basic doctypes are provided by cozy, but you can pick your own. Cozy v3 expects doctypes to be qualified to ensure uniqueness. All doctypes designed by the cozy s team will be prefixed with io.cozy. , or io.cozy.labs. Any doctype you introduce is expected to be prefixed with the reverse notation of a domain you own (JLS#7.7). If you do not own a domain, you can also use a reverse notation of your email address. You are free to reuse another applications documents by using their doctypes but you SHOULD discuss with the domain owner if you want to add fields or format them differently. To ensure retrocompatibility, when used on stack v2, all known doctypes will be auto-prefixed, but a warning will be written to the console. Unknown doctype will cause a fatal error. DO NOT rely on this behaviour in new applications, use qualified doctypes. // contacts is a doctype defined by cozy cozyContactsDoctype = io.cozy.contacts // your application handle books, let's create a doctype myBooksDoctype = com.mydomain.book When you use a doctype, even one created by your application, you need to ask for its permission in your manifest. How to do it depends on which stack you are developping for. TODO Have some docs about v2 package.json vs v3 manifest.webapp Promises Callbacks All cozy-client-js functions support callback or promise. If no callback is provided, a promise is returned. cozy.client.data.create(myBooksDoctype, doc) .then(function(result){ console.log('done', result); }); .catch(function(err){ console.log('fail', err); }); If your build pipeline supports it, use async/await for sweet sweet async try { result = await cozy.client.data.create(myBooksDoctype, doc) console.log('done', result) } catch(err) { console.log('fail', err) } If for some reason you do not want to use promises, you can pass the disablePromises flag to the init function. This way, you will be able to use the functions with a classic callback. cozy.client.init({ disablePromises: true }) cozy.client.data.create(myBooksDoctype, doc, function(err, result) { if (err) { console.log('fail', err); } else { console.log('done', result); } }); undefined Constructor new cozy.Client(options) new cozy.Client(options) returns a new cozy client. It does return a Cozy instance. It takes the same options object as the cozy.client.init(options) function. cozy.client.init(options) cozy.client.init(options) setups initialize the global cozy instance. It does not return a value. options is an object with the following fields: cozyURL : absolute url of the cozy stack disablePromises : boolean to make function that returns promise used with a classical callback as last argument (default value is false ) oauth : an object with the OAuth parameters, see OAuth for details version : the version of Cozy (2 or 3), it s optional, by default with a request to the server it can deduce automatically the version. (Must be specified for an offline mode) cozy.client.init({ cozyURL: 'http://cozy.tools:8080', disablePromises: false, version: 3, oauth: { clientParams: {/*...*/}, scopes: [ io.cozy.files:GET ], onRegistered: (client, url) = { /* */ }, storage: new cozy.auth.LocalStorage(window.localStorage) } }) Future APIs This is the end of what we already have implemented, if you want to do something else (manipulating binary file, sharing, ), you will have to wait a bit :smile:. Feel free to open an issue if you see something missing, or if you disagree with the API design !","title":"Introduction"},{"location":"/cozy-client-js/intro/#introduction-to-cozy-client-js","text":"","title":"Introduction to cozy-client-js"},{"location":"/cozy-client-js/intro/#reminder-about-cozy-architectures","text":"There is two actives cozy architectures: The first, thereafter named v2 is the existing cozy structure. It s based on 1 container / user with many node.js processes in each container (cozy-data-system, cozy-proxy, cozy-home, 1 process per app). The second, thereafter named v3 is the new cozy-stack ( repository ). It s based on go and aim to support multiple user on a single process. v2 supported both server-side applications with their own node.js process and client-side applications which run in the user browser. v3 will not support server-side applications. We will support server side modules managed by server administrator, but the applications themselves will all be client-side application. This repository provides a library which allows you to build a client-side application compatible with both version. The former javascript library for making client-side application was cozy-browser-sdk . We aim to deprecate it once cozy-client-js reaches feature-parity. If you already have an application using cozy-browser-sdk , you can see what will change in the transition document . If you have any doubt, please open an issue!","title":"Reminder about cozy architectures"},{"location":"/cozy-client-js/intro/#include-the-library-in-your-application","text":"You can import / require cozy-client-js using npm webpack. You can also copy-paste the dist/cozy-client.js bundle file into your application, and include it in your application index.html with script src=\"./cozy-client.js\" . If you are developing a client-side app for Cozy V3, you can import the lib directly from the stack, by using {{.CozyClientJS}} . If you are developing a nodejs app, you will need some polyfills. You can add them to your project with this command: $ yarn add isomorphic-fetch core-js regenerator-runtime btoa","title":"Include the library in your application"},{"location":"/cozy-client-js/intro/#doctypes-permissions","text":"A doctype is a simple javascript string identifying a type of document. Some basic doctypes are provided by cozy, but you can pick your own. Cozy v3 expects doctypes to be qualified to ensure uniqueness. All doctypes designed by the cozy s team will be prefixed with io.cozy. , or io.cozy.labs. Any doctype you introduce is expected to be prefixed with the reverse notation of a domain you own (JLS#7.7). If you do not own a domain, you can also use a reverse notation of your email address. You are free to reuse another applications documents by using their doctypes but you SHOULD discuss with the domain owner if you want to add fields or format them differently. To ensure retrocompatibility, when used on stack v2, all known doctypes will be auto-prefixed, but a warning will be written to the console. Unknown doctype will cause a fatal error. DO NOT rely on this behaviour in new applications, use qualified doctypes. // contacts is a doctype defined by cozy cozyContactsDoctype = io.cozy.contacts // your application handle books, let's create a doctype myBooksDoctype = com.mydomain.book When you use a doctype, even one created by your application, you need to ask for its permission in your manifest. How to do it depends on which stack you are developping for. TODO Have some docs about v2 package.json vs v3 manifest.webapp","title":"Doctypes &amp; Permissions"},{"location":"/cozy-client-js/intro/#promises-callbacks","text":"All cozy-client-js functions support callback or promise. If no callback is provided, a promise is returned. cozy.client.data.create(myBooksDoctype, doc) .then(function(result){ console.log('done', result); }); .catch(function(err){ console.log('fail', err); }); If your build pipeline supports it, use async/await for sweet sweet async try { result = await cozy.client.data.create(myBooksDoctype, doc) console.log('done', result) } catch(err) { console.log('fail', err) } If for some reason you do not want to use promises, you can pass the disablePromises flag to the init function. This way, you will be able to use the functions with a classic callback. cozy.client.init({ disablePromises: true }) cozy.client.data.create(myBooksDoctype, doc, function(err, result) { if (err) { console.log('fail', err); } else { console.log('done', result); } }); undefined","title":"Promises &amp; Callbacks"},{"location":"/cozy-client-js/intro/#constructor","text":"","title":"Constructor"},{"location":"/cozy-client-js/intro/#new-cozyclientoptions","text":"new cozy.Client(options) returns a new cozy client. It does return a Cozy instance. It takes the same options object as the cozy.client.init(options) function.","title":"new cozy.Client(options)"},{"location":"/cozy-client-js/intro/#cozyclientinitoptions","text":"cozy.client.init(options) setups initialize the global cozy instance. It does not return a value. options is an object with the following fields: cozyURL : absolute url of the cozy stack disablePromises : boolean to make function that returns promise used with a classical callback as last argument (default value is false ) oauth : an object with the OAuth parameters, see OAuth for details version : the version of Cozy (2 or 3), it s optional, by default with a request to the server it can deduce automatically the version. (Must be specified for an offline mode) cozy.client.init({ cozyURL: 'http://cozy.tools:8080', disablePromises: false, version: 3, oauth: { clientParams: {/*...*/}, scopes: [ io.cozy.files:GET ], onRegistered: (client, url) = { /* */ }, storage: new cozy.auth.LocalStorage(window.localStorage) } })","title":"cozy.client.init(options)"},{"location":"/cozy-client-js/intro/#future-apis","text":"This is the end of what we already have implemented, if you want to do something else (manipulating binary file, sharing, ), you will have to wait a bit :smile:. Feel free to open an issue if you see something missing, or if you disagree with the API design !","title":"Future APIs"},{"location":"/cozy-client-js/browser-sdk-transition/","text":"How to transition your app from cozy-browser-sdk to cozy-client-js Full doctype qualification Cozy v3 expects doctypes to be qualified to ensure uniqueness. All doctypes designed by the cozy s team will be prefixed with io.cozy. Any doctype you introduce is expected to be prefixed with the reverse notation of a domain you own (JLS#7.7). You are free to reuse another applications documents by using their doctypes but you SHOULD discuss with the domain owner if you want to add fields or format them differently. To ensure retrocompatibility, when used on stack v2, all known doctypes will be auto-prefixed by io.cozy. or io.cozy.labs. , but a warning will be written to the console. Unknown doctype will cause a fatal error. DO NOT rely on this behaviour in new applications, use qualified doctypes. // old version, using cozy-browser-sdk cozysdk.create( Contact , {}) cozysdk.create( Book , {}) // new version, with cozy-client-js cozy.data.create( io.cozy.contacts , {}) cozy.data.create( com.mydomain.book , {}) MapReduce Views vs Mango queries Cozy v3 recommends using Couchdb 2 indexes mango queries instead of Couchdb 1.X map-reduce views. We feel they are simpler to understand and explain and avoid useless overindexing. When used on a v2 cozy, the defineIndex and query calls will be translated to MapReduce views. If you need the full power of MapReduce, please open a issue on cozy-stack with your usecase. // cozy-browser-sdk cozysdk.defineMapReduceView('Event', 'all', function(doc) { emit(doc.year); }) cozysdk.queryView('Event', 'all', {key: 2016, limit: 10}) // cozy-client-js index = cozy.data.defineIndex('Event', ['year']) cozy.data.query(index, {selector: {year: 2016}, limit: 10}) Binaries We do not yet have a plan for binaries attachments to documents. They will be probably placed in the VFS under a special path. Crud is fully compatible The following functions have the same signature than the cozy-browser-sdk created = await cozy.data.create(myType, book) doc = await cozy.data.find(myType, id) doc2 = await cozy.data.updateAttributes(myType, id, {year: 1851}) await cozy.data.destroy( my.domain.book , id)","title":"Transition from cozy-browser-sdk"},{"location":"/cozy-client-js/browser-sdk-transition/#how-to-transition-your-app-from-cozy-browser-sdk-to-cozy-client-js","text":"","title":"How to transition your app from cozy-browser-sdk to cozy-client-js"},{"location":"/cozy-client-js/browser-sdk-transition/#full-doctype-qualification","text":"Cozy v3 expects doctypes to be qualified to ensure uniqueness. All doctypes designed by the cozy s team will be prefixed with io.cozy. Any doctype you introduce is expected to be prefixed with the reverse notation of a domain you own (JLS#7.7). You are free to reuse another applications documents by using their doctypes but you SHOULD discuss with the domain owner if you want to add fields or format them differently. To ensure retrocompatibility, when used on stack v2, all known doctypes will be auto-prefixed by io.cozy. or io.cozy.labs. , but a warning will be written to the console. Unknown doctype will cause a fatal error. DO NOT rely on this behaviour in new applications, use qualified doctypes. // old version, using cozy-browser-sdk cozysdk.create( Contact , {}) cozysdk.create( Book , {}) // new version, with cozy-client-js cozy.data.create( io.cozy.contacts , {}) cozy.data.create( com.mydomain.book , {})","title":"Full doctype qualification"},{"location":"/cozy-client-js/browser-sdk-transition/#mapreduce-views-vs-mango-queries","text":"Cozy v3 recommends using Couchdb 2 indexes mango queries instead of Couchdb 1.X map-reduce views. We feel they are simpler to understand and explain and avoid useless overindexing. When used on a v2 cozy, the defineIndex and query calls will be translated to MapReduce views. If you need the full power of MapReduce, please open a issue on cozy-stack with your usecase. // cozy-browser-sdk cozysdk.defineMapReduceView('Event', 'all', function(doc) { emit(doc.year); }) cozysdk.queryView('Event', 'all', {key: 2016, limit: 10}) // cozy-client-js index = cozy.data.defineIndex('Event', ['year']) cozy.data.query(index, {selector: {year: 2016}, limit: 10})","title":"MapReduce Views vs Mango queries"},{"location":"/cozy-client-js/browser-sdk-transition/#binaries","text":"We do not yet have a plan for binaries attachments to documents. They will be probably placed in the VFS under a special path.","title":"Binaries"},{"location":"/cozy-client-js/browser-sdk-transition/#crud-is-fully-compatible","text":"The following functions have the same signature than the cozy-browser-sdk created = await cozy.data.create(myType, book) doc = await cozy.data.find(myType, id) doc2 = await cozy.data.updateAttributes(myType, id, {year: 1851}) await cozy.data.destroy( my.domain.book , id)","title":"Crud is fully compatible"},{"location":"/cozy-client-js/offline/","text":"Offline support This document describes in more details how to use this library in offline mode. All applications do not require offline mode, and offline mode needs two dependencies : pouchdb and pouchdb-find . As both are very large, we decide not to provide them by default, since v0.2.0. So if your app needs to use offline mode, you have to add those dependencies by yourself. It means you just need to do: $/your-app yarn add pouchdb $/your-app yarn add pouchdb-find Then they will have to import pouchdb and pouchdbfind globally, as they are not imported in codebase anymore. This means adding the following configuration in all concerned webpack target files (for example webpack.target.mobile.js ) : module.exports = { ... plugins: [ new webpack.ProvidePlugin({ 'PouchDB': 'pouchdb', 'pouchdbFind': 'pouchdb-find' }) ] } This same configuration has to be added in file wepback.config.prod.js , to make the build possible. In prod, since cozy-client-js is injected by the stack, it has not been processed by wepback and the ProvidePlugin . Thus you need to bind PouchDB to window . /* global PouchDB, pouchdbFind */ // Bind PouchDB to window for cozy-client-js to find it // PouchDB is provided by webpack through ProvidedPlugin window.PouchDB = PouchDB window.pouchdbFind = pouchdbFind","title":"How to support offline"},{"location":"/cozy-client-js/offline/#offline-support","text":"This document describes in more details how to use this library in offline mode. All applications do not require offline mode, and offline mode needs two dependencies : pouchdb and pouchdb-find . As both are very large, we decide not to provide them by default, since v0.2.0. So if your app needs to use offline mode, you have to add those dependencies by yourself. It means you just need to do: $/your-app yarn add pouchdb $/your-app yarn add pouchdb-find Then they will have to import pouchdb and pouchdbfind globally, as they are not imported in codebase anymore. This means adding the following configuration in all concerned webpack target files (for example webpack.target.mobile.js ) : module.exports = { ... plugins: [ new webpack.ProvidePlugin({ 'PouchDB': 'pouchdb', 'pouchdbFind': 'pouchdb-find' }) ] } This same configuration has to be added in file wepback.config.prod.js , to make the build possible. In prod, since cozy-client-js is injected by the stack, it has not been processed by wepback and the ProvidePlugin . Thus you need to bind PouchDB to window . /* global PouchDB, pouchdbFind */ // Bind PouchDB to window for cozy-client-js to find it // PouchDB is provided by webpack through ProvidedPlugin window.PouchDB = PouchDB window.pouchdbFind = pouchdbFind","title":"Offline support"},{"location":"/cozy-client-js/oauth/","text":"This document describes in more details how to use this library along with OAuth. Before reading this document, to better understand how authentication and OAuth work on the cozy-stack, you should read this document . The library exposes internal methods to access the OAuth endpoints of the cozy-stack. See cozy.auth.* methods . However, the library also provides a more automated way to perform de OAuth flow by implementing many details of the OAuth registration and authorization flow for you. Here we describe the automated and stateful method. Storage To handle the workflow automatically, the user of the library shoud pass a storage object that will be used to store the OAuth client and tokens informations. This storage should implement the following interface : interface Storage { load(key: string) : Promise any save(key: string, value: any) : Promise any delete(key: string) : Promise boolean clear() : Promise } The library provides two implementation of such storage: - cozy.auth.MemoryStorage storing data in-memory - cozy.auth.LocalStorage storage data in a html5 localStorage The library constructor (on init method) should be passed the storage in the storage field of the oauth options. Registration parameters In order to handle the registration of the client, two callbacks should be provided to the cozy-client-js instance. clientParams an object with the following parameters: redirectURI : the URI on which the user is redirected after accepting the client (mandatory) softwareID : identifier of the software (by default github.com/cozy/cozy-client-js ) softwareVersion : version of the software (optional) clientName : string (optional) clientKind : string (optional) clientURI : string (optional) logoURI : string (optional) policyURI : string (optional) scopes : array of key:value elements representing the permission scopes required by the application that the user should accept (mandatory) onRegistered(client, url) which should provide the wanted side effect after the client registration and return a promise containing the request URL provided by the user containing the access code and state. The onRegistered callback is called with the registered client and the URL on which the user should go to give access to the application. Complete example for Node.JS Here is a complete example running on Node.JS with a local http server receiving as redirect URI receiving the call of the user to complete the authorization of the client. const http = require('http'); const {Cozy,MemoryStorage} = require('./dist/cozy-client.node.js') function onRegistered(client, url) { let server return new Promise((resolve) = { server = http.createServer((request, response) = { if (request.url.indexOf('/do_access') === 0) { console.log('Received access from user with url', request.url) resolve(request.url) response.end() } }) server.listen(3333, () = { console.log('Please visit the following url to authorize the application: ', url) }) }) .then( (url) = { server.close(); return url; }, (err) = { server.close(); throw err; } ) } const cozy = new Cozy({ cozyURL: 'http://cozy.tools:8080', oauth: { storage: new MemoryStorage(), clientParams: { redirectURI: 'http://localhost:3333/do_access', softwareID: 'foobar', clientName: 'client', scopes: ['files/images:read'] }, onRegistered: onRegistered, } }) cozy.authorize().then((creds) = console.log(creds))","title":"OAuth guide"},{"location":"/cozy-client-js/oauth/#storage","text":"To handle the workflow automatically, the user of the library shoud pass a storage object that will be used to store the OAuth client and tokens informations. This storage should implement the following interface : interface Storage { load(key: string) : Promise any save(key: string, value: any) : Promise any delete(key: string) : Promise boolean clear() : Promise } The library provides two implementation of such storage: - cozy.auth.MemoryStorage storing data in-memory - cozy.auth.LocalStorage storage data in a html5 localStorage The library constructor (on init method) should be passed the storage in the storage field of the oauth options.","title":"Storage"},{"location":"/cozy-client-js/oauth/#registration-parameters","text":"In order to handle the registration of the client, two callbacks should be provided to the cozy-client-js instance. clientParams an object with the following parameters: redirectURI : the URI on which the user is redirected after accepting the client (mandatory) softwareID : identifier of the software (by default github.com/cozy/cozy-client-js ) softwareVersion : version of the software (optional) clientName : string (optional) clientKind : string (optional) clientURI : string (optional) logoURI : string (optional) policyURI : string (optional) scopes : array of key:value elements representing the permission scopes required by the application that the user should accept (mandatory) onRegistered(client, url) which should provide the wanted side effect after the client registration and return a promise containing the request URL provided by the user containing the access code and state. The onRegistered callback is called with the registered client and the URL on which the user should go to give access to the application.","title":"Registration parameters"},{"location":"/cozy-client-js/oauth/#complete-example-for-nodejs","text":"Here is a complete example running on Node.JS with a local http server receiving as redirect URI receiving the call of the user to complete the authorization of the client. const http = require('http'); const {Cozy,MemoryStorage} = require('./dist/cozy-client.node.js') function onRegistered(client, url) { let server return new Promise((resolve) = { server = http.createServer((request, response) = { if (request.url.indexOf('/do_access') === 0) { console.log('Received access from user with url', request.url) resolve(request.url) response.end() } }) server.listen(3333, () = { console.log('Please visit the following url to authorize the application: ', url) }) }) .then( (url) = { server.close(); return url; }, (err) = { server.close(); throw err; } ) } const cozy = new Cozy({ cozyURL: 'http://cozy.tools:8080', oauth: { storage: new MemoryStorage(), clientParams: { redirectURI: 'http://localhost:3333/do_access', softwareID: 'foobar', clientName: 'client', scopes: ['files/images:read'] }, onRegistered: onRegistered, } }) cozy.authorize().then((creds) = console.log(creds))","title":"Complete example for Node.JS"},{"location":"/cozy-client-js/auth-api/","text":"Authentication and OAuth (internal) cozy.client.auth.registerClient(clientParams) This method is for internal or advanced usages. Please see OAuth document to see how to use OAuth with this library cozy.client.auth.registerClient is used to register a new client with the specified informations. It returns a promise of the newly registered Client, along with a client secret and identifier. clientParams are client parameters: a non registered instance of cozy.client.auth.Client const clientParams = new cozy.client.auth.Client({ redirectURI: 'http://localhost:3000/', softwareID: 'mysoftware', clientName: 'Great mobile App' }) const client = await cozy.client.auth.registerClient(clientParams) const clientID = client.clientID const clientSecret = client.clientSecret cozy.client.auth.updateClient(client, resetSecret = false) This method is for internal or advanced usages. Please see OAuth document to see how to use OAuth with this library cozy.client.auth.updateClient is used to update informations about the oauth client. It returns a promise for the updated Client. client a registered instance of cozy.client.auth.Client resetSecret by setting resetSecret to true , a new Secret is generated. const client = await cozy.client.auth.registerClient(clientParams) // change the client's version client.softwareVersion = v1.2.3 const client = await cozy.client.auth.updateClient(client) // change the client secret const client = await cozy.client.auth.updateClient(client, true) cozy.client.auth.unregisterClient(client) This method is for internal or advanced usages. Please see OAuth document to see how to use OAuth with this library cozy.client.auth.unregisterClient is used to unregister a client. It returns a promise for completion client a registered instance of cozy.client.auth.Client const client = await cozy.client.auth.registerClient(clientParams) await cozy.auth.client.unregisterClient(client) cozy.auth.client.getClient(client) This method is for internal or advanced usages. Please see OAuth document to see how to use OAuth with this library cozy.client.auth.getClient is used to fetch a registered client with the specified clientID and token. It returns a promise of the client returned by the server. client is a registered cozy.client.auth.Client const client = await cozy.client.auth.getClient(new cozy.client.auth.Client({ clientID: '1235' })) cozy.client.auth.getAuthCodeURL(client, scopes) This method is for internal or advanced usages. Please see OAuth document to see how to use OAuth with this library cozy.client.auth.getAuthCodeURL is used to generate the URL on which the user should go to give access to the application with the specified scopes. It returns an object with the url and a generated random state that should be stored to be matched again for the token exchange phase. client is a registered cozy.client.auth.Client scopes is an array of permission strings formatted as key:access (like files/images:read ) const {url, state} = cozy.client.auth.getAuthCodeURL(client, ['files/images:read']) // save state and redirect to url localStorage.setItem( oauthstate , state) window.location.replace(url) cozy.client.auth.getAccessToken(client, state, pageURL) This method is for internal or advanced usages. Please see OAuth document to see how to use OAuth with this library cozy.client.auth.getAccessToken is used from the page on which the user should have redirected after authorizing the application. It returns a promise of an cozy.client.auth.AccessToken . The method verifies that the specified state and the extracted one match. It then ask the server for a new access token and returns it. client is a registered cozy.client.auth.Client state is the previously stored state that is matched against to prevent CSRF attacks pageURL is the url of the current page from the which a code and state will be extracted. If empty, window.location.href is used const client = cozy.client.auth.getClient(/* ... */) const state = localStorage.getItem( oauthstate ) const pageURL = window.location.href const token = cozy.client.auth.getAccessToken(client, state, pageURL) cozy.client.auth.refreshToken This method is for internal or advanced usages. Please see OAuth document to see how to use OAuth with this library cozy.client.auth.refreshToken is used to refresh a token that is expired or no more valid. client is a registered cozy.client.auth.Client token is a valid cozy.client.auth.AccessToken const newtoken = cozy.client.auth.refreshToken(client, oldtoken) cozy.client.auth.Client This class is for internal or advanced usages. Please see OAuth document to see how to use OAuth with this library cozy.client.auth.Client is a class representing an OAuth client. It can be registered, in which case it is known by the server and has a clientID and clientSecret . type Client { clientID: string; // informed by server clientSecret: string; // informed by server registrationAccessToken: string; // informed by server redirectURI: string; // mandatory softwareID: string; // mandatory softwareVersion: string; clientName: string; // mandatory clientKind: string; clientURI: string; logoURI: string; policyURI: string; notificationPlatform: string; notificationDeviceToken: string; } The constructor type is as follow: url is a string of the url of the cozy options is an object with the same fields as a client object, or is an instance of client new Client(url, options) cozy.client.auth.AccessToken This class is for internal or advanced usages. Please see OAuth document to see how to use OAuth with this library cozy.client.auth.AccessToken is a class representing an OAuth access token. type Token { tokenType: string; accessToken: string; refreshToken: string; scope: string } The constructor takes an object with the same fields as a Token object.","title":"Authentication API"},{"location":"/cozy-client-js/auth-api/#authentication-and-oauth-internal","text":"","title":"Authentication and OAuth (internal)"},{"location":"/cozy-client-js/auth-api/#cozyclientauthregisterclientclientparams","text":"This method is for internal or advanced usages. Please see OAuth document to see how to use OAuth with this library cozy.client.auth.registerClient is used to register a new client with the specified informations. It returns a promise of the newly registered Client, along with a client secret and identifier. clientParams are client parameters: a non registered instance of cozy.client.auth.Client const clientParams = new cozy.client.auth.Client({ redirectURI: 'http://localhost:3000/', softwareID: 'mysoftware', clientName: 'Great mobile App' }) const client = await cozy.client.auth.registerClient(clientParams) const clientID = client.clientID const clientSecret = client.clientSecret","title":"cozy.client.auth.registerClient(clientParams)"},{"location":"/cozy-client-js/auth-api/#cozyclientauthupdateclientclient-resetsecret-false","text":"This method is for internal or advanced usages. Please see OAuth document to see how to use OAuth with this library cozy.client.auth.updateClient is used to update informations about the oauth client. It returns a promise for the updated Client. client a registered instance of cozy.client.auth.Client resetSecret by setting resetSecret to true , a new Secret is generated. const client = await cozy.client.auth.registerClient(clientParams) // change the client's version client.softwareVersion = v1.2.3 const client = await cozy.client.auth.updateClient(client) // change the client secret const client = await cozy.client.auth.updateClient(client, true)","title":"cozy.client.auth.updateClient(client, resetSecret = false)"},{"location":"/cozy-client-js/auth-api/#cozyclientauthunregisterclientclient","text":"This method is for internal or advanced usages. Please see OAuth document to see how to use OAuth with this library cozy.client.auth.unregisterClient is used to unregister a client. It returns a promise for completion client a registered instance of cozy.client.auth.Client const client = await cozy.client.auth.registerClient(clientParams) await cozy.auth.client.unregisterClient(client)","title":"cozy.client.auth.unregisterClient(client)"},{"location":"/cozy-client-js/auth-api/#cozyauthclientgetclientclient","text":"This method is for internal or advanced usages. Please see OAuth document to see how to use OAuth with this library cozy.client.auth.getClient is used to fetch a registered client with the specified clientID and token. It returns a promise of the client returned by the server. client is a registered cozy.client.auth.Client const client = await cozy.client.auth.getClient(new cozy.client.auth.Client({ clientID: '1235' }))","title":"cozy.auth.client.getClient(client)"},{"location":"/cozy-client-js/auth-api/#cozyclientauthgetauthcodeurlclient-scopes","text":"This method is for internal or advanced usages. Please see OAuth document to see how to use OAuth with this library cozy.client.auth.getAuthCodeURL is used to generate the URL on which the user should go to give access to the application with the specified scopes. It returns an object with the url and a generated random state that should be stored to be matched again for the token exchange phase. client is a registered cozy.client.auth.Client scopes is an array of permission strings formatted as key:access (like files/images:read ) const {url, state} = cozy.client.auth.getAuthCodeURL(client, ['files/images:read']) // save state and redirect to url localStorage.setItem( oauthstate , state) window.location.replace(url)","title":"cozy.client.auth.getAuthCodeURL(client, scopes)"},{"location":"/cozy-client-js/auth-api/#cozyclientauthgetaccesstokenclient-state-pageurl","text":"This method is for internal or advanced usages. Please see OAuth document to see how to use OAuth with this library cozy.client.auth.getAccessToken is used from the page on which the user should have redirected after authorizing the application. It returns a promise of an cozy.client.auth.AccessToken . The method verifies that the specified state and the extracted one match. It then ask the server for a new access token and returns it. client is a registered cozy.client.auth.Client state is the previously stored state that is matched against to prevent CSRF attacks pageURL is the url of the current page from the which a code and state will be extracted. If empty, window.location.href is used const client = cozy.client.auth.getClient(/* ... */) const state = localStorage.getItem( oauthstate ) const pageURL = window.location.href const token = cozy.client.auth.getAccessToken(client, state, pageURL)","title":"cozy.client.auth.getAccessToken(client, state, pageURL)"},{"location":"/cozy-client-js/auth-api/#cozyclientauthrefreshtoken","text":"This method is for internal or advanced usages. Please see OAuth document to see how to use OAuth with this library cozy.client.auth.refreshToken is used to refresh a token that is expired or no more valid. client is a registered cozy.client.auth.Client token is a valid cozy.client.auth.AccessToken const newtoken = cozy.client.auth.refreshToken(client, oldtoken)","title":"cozy.client.auth.refreshToken"},{"location":"/cozy-client-js/auth-api/#cozyclientauthclient","text":"This class is for internal or advanced usages. Please see OAuth document to see how to use OAuth with this library cozy.client.auth.Client is a class representing an OAuth client. It can be registered, in which case it is known by the server and has a clientID and clientSecret . type Client { clientID: string; // informed by server clientSecret: string; // informed by server registrationAccessToken: string; // informed by server redirectURI: string; // mandatory softwareID: string; // mandatory softwareVersion: string; clientName: string; // mandatory clientKind: string; clientURI: string; logoURI: string; policyURI: string; notificationPlatform: string; notificationDeviceToken: string; } The constructor type is as follow: url is a string of the url of the cozy options is an object with the same fields as a client object, or is an instance of client new Client(url, options)","title":"cozy.client.auth.Client"},{"location":"/cozy-client-js/auth-api/#cozyclientauthaccesstoken","text":"This class is for internal or advanced usages. Please see OAuth document to see how to use OAuth with this library cozy.client.auth.AccessToken is a class representing an OAuth access token. type Token { tokenType: string; accessToken: string; refreshToken: string; scope: string } The constructor takes an object with the same fields as a Token object.","title":"cozy.client.auth.AccessToken"},{"location":"/cozy-client-js/data-api/","text":"Data API cozy.client.data.create(doctype, attributes) cozy.client.data.create(doctype, attributes) adds a document to the database. It returns a promise for the created object. The created object has the same attributes than thoses passed, with an added _id . It s the unique identifier for the created document. If you use an existing doctype, you should follow its expected format. v2 does not enforce this, but we plan to on v3 . Anyway, do you want to be the app that creates empty contacts in the native app ? doctype is a string specifying the doctype attributes is an object that can be stringified using JSON.stringify : if it is a complex or cyclic object, add a toJSON method to it (native behaviour of JSON.stringify ). Warning : on v3 , an extra field _rev is added, it is the unique identifier for the document revision, after creation, it will be of the shape 1-xxxxxxxxx for first revision. // simple object const book = { title: Moby Dick , author: Herman Melville , isbn: 42 } const created = await cozy.client.data.create(myBooksDoctype, book) // same fields console.log(created.title, created.author, created.isbn) // _id, _rev are added console.log(created._id, created._rev) // let's keep it for later createdBookId = created._id cozy.client.data.find(doctype, id) cozy.client.data.find(doctype, id) returns the document associated to the given ID. It returns a promise for the document. It will have the same fields than the returned value of create , including _id and _rev . If the document does not exist, the promise will be rejected or the callback will be passed an error. doctype is a string specifying the doctype id is a string specifying the identifier of the document you look for const doc = await cozy.client.data.find(myBooksDoctype, createdBookId) console.log(doc._id, doc._rev, doc.title, doc.author, doc.isbn) cozy.client.data.findMany(doctype, [ids]) cozy.client.data.findMany(doctype, [ids]) returns the documents associated to the given IDs. It returns a promise for a map, with the given IDs as keys. When a document is found, the corresponding value will be an object with a single doc key containing the document. Documents will have the same fields than the returned values of create , including _id and _rev . When a document is missing, the corresponding value will be an object with a single error key containing the error message. Even when some document is missing, the promise will still be fulfilled or the callback will be passed the resulting map, so you can still access the other documents found and identify the missing ones. doctype is a string specifying the doctype ids is an array of strings specifying the identifiers of the documents you look for Warning : Not available on v2 . A fallback implementation could be provided at some point. const ids = [createdBookId, ...] const resultsById = await cozy.client.data.findMany(myBooksDoctype, ids) for (const id of ids) { const {doc, error} = resultsById[id] if (error) { console.error(`Error while fetching book ${id}: ${error}`) } else { console.log(doc._id, doc._rev, doc.title, doc.author, doc.isbn) } } cozy.client.data.findAll(doctype) cozy.client.data.findAll(doctype) returns the all documents associated to the given doctype. It returns a promise for a map, with the given IDs as keys. When a document is found, the corresponding value will be an object with a single doc key containing the document. Documents will have the same fields than the returned values of create , including _id and _rev . doctype is a string specifying the doctype look for Warning : Not available on v2 . A fallback implementation could be provided at some point. const result = await cozy.client.data.findAll(myBooksDoctype) if (result.error) { console.error('Error while fetching books') } for (const id of result.keys) { const doc = result.docs[id] console.log(doc._id, doc._rev, doc.title, doc.author, doc.isbn) } cozy.client.data.changesFeed(doctype, options) cozy.client.data.changesFeed(doctype, options) returns the last changes from CouchDB for the given doctype It returns a promise for the changes. doctype is a string specifying the doctype options is an object, only its since parameter is supported currently const changes = await.cozy.client.data.changesFeed(myBooksDoctype, { since: 0 }) console.log(changes.last_seq, changes.results) cozy.client.data.update(doctype, doc, newdoc) cozy.client.data.update(doctype, doc, newdoc) replaces the document by a new version. It returns a promise for the updated document. The updated document will have the same fields and values than provided in newdoc, the same _id than doc, and a _rev incremented from doc s number. If the document does not exist, the promise will reject with an error. If the document current _rev does not match the passed one, it means there is a conflict and the promise is rejected with an error. doctype is a string specifying the doctype doc is an object with at least the fields _id and _rev containing the identifier and revision of the file you want to update. newdoc is an object, specifying the new content of the document const updates = { title: Moby Dick ! , author: THE Herman Melville } const updated = await cozy.client.data.update(myBooksDoctype, doc, updates) console.log(updated._id === doc._id) // _id does not change console.log(updated._rev) // 2-xxxxxx console.log(updated.title, updated.year) // fields are changed console.log(updated.isbn === undefined) // update erase fields cozy.client.data.updateAttributes(doctype, id, changes) cozy.client.data.updateAttributes(doctype, id, changes) applies change to the document. It returns a promise for the updated document. The updated document will be the result of merging changes into the document with given _id and a incremented _rev . If the document does not exist, the promise will be rejected or the callback will be passed an error. This function gives 3 attempts not to conflict. doctype is a string specifying the doctype id is a string specifying the identifier of the document to update changes is an object const updates = { year: 1852} const updated = await cozy.client.data.updateAttributes(myBooksDoctype, id, updates) console.log(updated._id === doc._id) // _id does not change console.log(updated._rev) // 3-xxxxxx console.log(updated.year) // fields are changed console.log(updated.isbn) // updateAttributes preserve other fields cozy.client.data.delete(doctype, doc) cozy.client.data.delete(doctype, doc ) will erase the document from the database. It returns a promise which will be resolved when the document has been deleted. If the document does not exist, the promise will be rejected with an error. If the document current _rev does not match the passed one, it means there is a conflict and the promise is rejected with an error. doctype is a string specifying the doctype doc is an object with at least the fields _id and _rev containing the identifier and revision of the file you want to destroy. await cozy.client.data.delete(myBooksDoctype, updated) cozy.client.data.defineIndex(doctype, fields) cozy.client.data.defineIndex(doctype, fields) creates an index for a document type. It is idempotent, it can be called several time with no bad effect. It returns a promise for an indexReference , which can be passed to cozy.data.query . doctype is a string specifying the doctype fields is an array of the fields name to index Warning : when used on v2 , a map-reduce view is created internally, when used on v3 , we use couchdb built-in mango queries. const booksByYearRef = await cozy.client.data.defineIndex(myType, ['year', 'rating']) cozy.client.data.query(indexReference, query) cozy.client.data.query(indexReference, query) find documents using an index. It returns a promise with a list of documents matching the query. Results will be returned in the order defined for the index. query is an object with the following fields: selector : a mango selector limit : maximum number of results skip : ignore the first x results (pagination) wholeResponse : when set to true, the whole query response will be returned instead of just the docs. This is useful when paginating, because you ll get the next property in the response object. Warning : complex mango queries are not compatible with v2 const results = await cozy.client.data.query(booksByYearRef, { selector : {year: 1851}, limit : 3, skip : 1 }) results.length == 3 // we limited to 3 results resuts[0]._id === doc._id resuts[0].title === Moby Dick resuts[0].rating 2 // lowest rating first","title":"Data System API"},{"location":"/cozy-client-js/data-api/#data-api","text":"","title":"Data API"},{"location":"/cozy-client-js/data-api/#cozyclientdatacreatedoctype-attributes","text":"cozy.client.data.create(doctype, attributes) adds a document to the database. It returns a promise for the created object. The created object has the same attributes than thoses passed, with an added _id . It s the unique identifier for the created document. If you use an existing doctype, you should follow its expected format. v2 does not enforce this, but we plan to on v3 . Anyway, do you want to be the app that creates empty contacts in the native app ? doctype is a string specifying the doctype attributes is an object that can be stringified using JSON.stringify : if it is a complex or cyclic object, add a toJSON method to it (native behaviour of JSON.stringify ). Warning : on v3 , an extra field _rev is added, it is the unique identifier for the document revision, after creation, it will be of the shape 1-xxxxxxxxx for first revision. // simple object const book = { title: Moby Dick , author: Herman Melville , isbn: 42 } const created = await cozy.client.data.create(myBooksDoctype, book) // same fields console.log(created.title, created.author, created.isbn) // _id, _rev are added console.log(created._id, created._rev) // let's keep it for later createdBookId = created._id","title":"cozy.client.data.create(doctype, attributes)"},{"location":"/cozy-client-js/data-api/#cozyclientdatafinddoctype-id","text":"cozy.client.data.find(doctype, id) returns the document associated to the given ID. It returns a promise for the document. It will have the same fields than the returned value of create , including _id and _rev . If the document does not exist, the promise will be rejected or the callback will be passed an error. doctype is a string specifying the doctype id is a string specifying the identifier of the document you look for const doc = await cozy.client.data.find(myBooksDoctype, createdBookId) console.log(doc._id, doc._rev, doc.title, doc.author, doc.isbn)","title":"cozy.client.data.find(doctype, id)"},{"location":"/cozy-client-js/data-api/#cozyclientdatafindmanydoctype-ids","text":"cozy.client.data.findMany(doctype, [ids]) returns the documents associated to the given IDs. It returns a promise for a map, with the given IDs as keys. When a document is found, the corresponding value will be an object with a single doc key containing the document. Documents will have the same fields than the returned values of create , including _id and _rev . When a document is missing, the corresponding value will be an object with a single error key containing the error message. Even when some document is missing, the promise will still be fulfilled or the callback will be passed the resulting map, so you can still access the other documents found and identify the missing ones. doctype is a string specifying the doctype ids is an array of strings specifying the identifiers of the documents you look for Warning : Not available on v2 . A fallback implementation could be provided at some point. const ids = [createdBookId, ...] const resultsById = await cozy.client.data.findMany(myBooksDoctype, ids) for (const id of ids) { const {doc, error} = resultsById[id] if (error) { console.error(`Error while fetching book ${id}: ${error}`) } else { console.log(doc._id, doc._rev, doc.title, doc.author, doc.isbn) } }","title":"cozy.client.data.findMany(doctype, [ids])"},{"location":"/cozy-client-js/data-api/#cozyclientdatafindalldoctype","text":"cozy.client.data.findAll(doctype) returns the all documents associated to the given doctype. It returns a promise for a map, with the given IDs as keys. When a document is found, the corresponding value will be an object with a single doc key containing the document. Documents will have the same fields than the returned values of create , including _id and _rev . doctype is a string specifying the doctype look for Warning : Not available on v2 . A fallback implementation could be provided at some point. const result = await cozy.client.data.findAll(myBooksDoctype) if (result.error) { console.error('Error while fetching books') } for (const id of result.keys) { const doc = result.docs[id] console.log(doc._id, doc._rev, doc.title, doc.author, doc.isbn) }","title":"cozy.client.data.findAll(doctype)"},{"location":"/cozy-client-js/data-api/#cozyclientdatachangesfeeddoctype-options","text":"cozy.client.data.changesFeed(doctype, options) returns the last changes from CouchDB for the given doctype It returns a promise for the changes. doctype is a string specifying the doctype options is an object, only its since parameter is supported currently const changes = await.cozy.client.data.changesFeed(myBooksDoctype, { since: 0 }) console.log(changes.last_seq, changes.results)","title":"cozy.client.data.changesFeed(doctype, options)"},{"location":"/cozy-client-js/data-api/#cozyclientdataupdatedoctype-doc-newdoc","text":"cozy.client.data.update(doctype, doc, newdoc) replaces the document by a new version. It returns a promise for the updated document. The updated document will have the same fields and values than provided in newdoc, the same _id than doc, and a _rev incremented from doc s number. If the document does not exist, the promise will reject with an error. If the document current _rev does not match the passed one, it means there is a conflict and the promise is rejected with an error. doctype is a string specifying the doctype doc is an object with at least the fields _id and _rev containing the identifier and revision of the file you want to update. newdoc is an object, specifying the new content of the document const updates = { title: Moby Dick ! , author: THE Herman Melville } const updated = await cozy.client.data.update(myBooksDoctype, doc, updates) console.log(updated._id === doc._id) // _id does not change console.log(updated._rev) // 2-xxxxxx console.log(updated.title, updated.year) // fields are changed console.log(updated.isbn === undefined) // update erase fields","title":"cozy.client.data.update(doctype, doc, newdoc)"},{"location":"/cozy-client-js/data-api/#cozyclientdataupdateattributesdoctype-id-changes","text":"cozy.client.data.updateAttributes(doctype, id, changes) applies change to the document. It returns a promise for the updated document. The updated document will be the result of merging changes into the document with given _id and a incremented _rev . If the document does not exist, the promise will be rejected or the callback will be passed an error. This function gives 3 attempts not to conflict. doctype is a string specifying the doctype id is a string specifying the identifier of the document to update changes is an object const updates = { year: 1852} const updated = await cozy.client.data.updateAttributes(myBooksDoctype, id, updates) console.log(updated._id === doc._id) // _id does not change console.log(updated._rev) // 3-xxxxxx console.log(updated.year) // fields are changed console.log(updated.isbn) // updateAttributes preserve other fields","title":"cozy.client.data.updateAttributes(doctype, id, changes)"},{"location":"/cozy-client-js/data-api/#cozyclientdatadeletedoctype-doc","text":"cozy.client.data.delete(doctype, doc ) will erase the document from the database. It returns a promise which will be resolved when the document has been deleted. If the document does not exist, the promise will be rejected with an error. If the document current _rev does not match the passed one, it means there is a conflict and the promise is rejected with an error. doctype is a string specifying the doctype doc is an object with at least the fields _id and _rev containing the identifier and revision of the file you want to destroy. await cozy.client.data.delete(myBooksDoctype, updated)","title":"cozy.client.data.delete(doctype, doc)"},{"location":"/cozy-client-js/data-api/#cozyclientdatadefineindexdoctype-fields","text":"cozy.client.data.defineIndex(doctype, fields) creates an index for a document type. It is idempotent, it can be called several time with no bad effect. It returns a promise for an indexReference , which can be passed to cozy.data.query . doctype is a string specifying the doctype fields is an array of the fields name to index Warning : when used on v2 , a map-reduce view is created internally, when used on v3 , we use couchdb built-in mango queries. const booksByYearRef = await cozy.client.data.defineIndex(myType, ['year', 'rating'])","title":"cozy.client.data.defineIndex(doctype, fields)"},{"location":"/cozy-client-js/data-api/#cozyclientdataqueryindexreference-query","text":"cozy.client.data.query(indexReference, query) find documents using an index. It returns a promise with a list of documents matching the query. Results will be returned in the order defined for the index. query is an object with the following fields: selector : a mango selector limit : maximum number of results skip : ignore the first x results (pagination) wholeResponse : when set to true, the whole query response will be returned instead of just the docs. This is useful when paginating, because you ll get the next property in the response object. Warning : complex mango queries are not compatible with v2 const results = await cozy.client.data.query(booksByYearRef, { selector : {year: 1851}, limit : 3, skip : 1 }) results.length == 3 // we limited to 3 results resuts[0]._id === doc._id resuts[0].title === Moby Dick resuts[0].rating 2 // lowest rating first","title":"cozy.client.data.query(indexReference, query)"},{"location":"/cozy-client-js/files-api/","text":"Files API cozy.client.files.create(data, options) cozy.client.files.create(data, options) is used to upload a new file onto your cozy It returns a promise for the document of the file created. data can be of the following type: Blob , File , ArrayBuffer , ArrayBufferView , stream.Readable (node) or string . options is an object with the following fields: name : specify the name of the file. optional for a data of type File , type, mandatory otherwise. dirID : specify identifier of the file s directory. if empty, it is the root directory. contentType : specify the content type of the uploaded data. For a File type, it is handled automatically in browsers (default: application/octet-stream ). For nodejs, you can rely on an external module like mime checksum : the base64-encoded (with padding) MD5 digest of the file (optional). lastModifiedDate : a date to specify the last modification time to use for the uploaded file. If the given data is a File instance, the lastModifiedDate is automatically used (not overridden). Warning : this API is not v2 compatible. const created = await cozy.client.files.create(blob, { name: filename , dirID: 123456 , }) const fileCreated = await cozy.client.files.create(fileInput.files[0], { dirID: , checksum: rL0Y20zC+Fzt72VPzMSk2A== , lastModifiedDate: new Date() }) cozy.client.files.createDirectory(options) cozy.client.files.createDirectory(options) is used to create a new directory. It returns a promise for the document of the directory created. options is an object with the following fields: name : specify the name of the directory dirID : specify identifier of the file s directory. if empty, it is the root directory. lastModifiedDate : a date to specify the last modification time to use for the directory. const created = await cozy.client.files.createDirectory({ name: mydir , dirID: 123456 , lastModifiedDate: new Date() }) cozy.client.files.createDirectoryByPath(path) cozy.client.files.createDirectoryByPath(path) is used to create one or more directories for a given path. It returns a promise for the document of the last directory created. path is a string const barDirectory = await cozy.client.files.createDirectoryByPath('/Foo/Bar') cozy.client.files.updateById(id, data, options) cozy.client.files.updateById(id, data, options) is used to update the content of an already existing file. It returns a promise for the document of the file updated. id is a string specifying the identifier of the file to modify. data can be of the following type: Blob , File , ArrayBuffer , ArrayBufferView or string . options is an object with the following fields: contentType : specify the content type of the uploaded data. For a File type, it is be handled automatically. default: application/octet-stream . checksum : the base64-encoded (with padding) MD5 digest of the file (optional). lastModifiedDate : a date to specify the last modification time to use for the uploaded file. If the given data is a File instance, the lastModifiedDate is automatically used (not overridden). ifMatch : the previous revision of the file (optional). The update will be rejected if the remote revision doesn t match the given one. const updated = await cozy.client.files.updateById( 654321 , blob, { contentType: text/plain , checksum: rL0Y20zC+Fzt72VPzMSk2A== , lastModifiedDate: new Date(), ifMatch: 1-0e6d5b72 }) cozy.client.files.updateAttributesById(id, attrs, options) cozy.client.files.updateAttributesById(id, attrs, options) is used to update the attributes associated to a file or directory specified by its id. It returns a promise for the document of the updated directory or file. id is a string specifying the identifier of the file or directory to update attrs is an object containing the changes options is an object with the following fields: ifMatch : the previous revision of the file (optional). The update will be rejected if the remote revision doesn t match the given one. const updated = await cozy.client.files.updateAttributesById( 12345 , { tags: [ foo ] }, { ifMatch: 1-0e6d5b72 }) cozy.client.files.updateAttributesByPath(path, attrs, options) cozy.client.files.updateAttributesByPath(path, attrs, options) is used to update the attributes associated to a file or directory specified by the given path. It returns a promise for the document of the updated directory or file. path : string specifying the path of the file or directory to update attrs is an object containing the changes options is an object with the following fields: ifMatch : the previous revision of the file (optional). The update will be rejected if the remote revision doesn t match the given one. const updated = await cozy.client.files.updateAttributes( /foo/bar , { executable: true }, { ifMatch: 1-0e6d5b72 }) cozy.client.files.statById(id, offline, options) cozy.client.files.statById(id, offline, options) is used to get the metadata of a file specified by its id. It returns a promise for the information of the file or directory. In the case of a directory, it contains the list of files and sub-directories inside it. This list is limited to 30 items by default, but the options argument allows you to fetch more items. id is a string specifying the file\u2019s or directory\u2019s identifier offline is a boolean (default to true ) options is an object with the following fields: skip : number of items to skip (optional) limit : maximum number of items to return (optional). By default, statById will fetch the metadata from the local database, if it is available. Set the second parameter to false to query the server. Returned directory have a relations() method that allow to access to their content: const dir = await cozy.client.files.statById( io.cozy.files.root-dir ); dir.relations('contents').forEach( (file) = \u2026 ) cozy.client.files.statByPath(path) cozy.client.files.statByPath(path) is used to get the metadata of a file specified by its path. path : string specifying the path of the file or directory; cozy.client.files.trashById(id, options) cozy.client.files.trashById(id, options) is used to move the file or directory identified by the given id to trash. It returns a promise for the document of the file or directory moved to trash. id is a string specifying the identifier of the file or directory options is an object with the following fields: ifMatch : the previous revision of the file (optional). The update will be rejected if the remote revision doesn t match the given one. const trashed = await cozy.client.files.trashById( 1234567 ) cozy.client.files.destroyById(id, options) cozy.client.files.destroyById(id, options) is used to shred (destroy definitively) a file or directory identified by the given id. The file must be in the trash folder first. It returns a promise for completion id is a string specifying the identifier of the file or directory options is an object with the following fields: ifMatch : the previous revision of the file (optional). The update will be rejected if the remote revision doesn t match the given one. const trashed = await cozy.client.files.trashById( 1234567 ) await cozy.client.files.destroyById( 1234567 ) cozy.client.files.restoreById(id) cozy.client.files.restoreById(id) is used to restore a file or directory identified by the given id. The file must be in the trash folder. It returns a promise for the restored doc. (with updated parent) id is a string specifying the identifier of the file or directory const trashed = await cozy.client.files.trashById( 1234567 ) const restored = await cozy.client.files.restoreById( 1234567 ) cozy.client.files.listTrash() cozy.client.files.listTrash() returns a promise for the list of all files in the trash. const trashedFilesAndFolders = await cozy.client.files.listTrash() cozy.client.files.clearTrash() cozy.client.files.clearTrash() destroys definitively all trash content. await cozy.client.files.clearTrash() cozy.client.files.downloadById(id) cozy.client.files.downloadById(id) is used to download a file identified by the given id. The file is downloaded through the browser fetch method, use this if you plan to use the file in javascript after. It returns a promise of a fetch Response object. This response object can be used to extract the information in the wanted form. id is a string specifying the identifier of the file const response = await cozy.client.files.downloadById( 1234567 ) const blob = await response.blob() const text = await response.text() const buff = await response.arrayBuffer() response.pipe(fs.createWriteStream('/some/file')) cozy.client.files.downloadByPath(path) cozy.client.files.downloadByPath(path) is used to download a file identified by the given path. The file is downloaded through the browser fetch method, use this if you plan to use the file in javascript after. It returns a promise of a fetch Response object. This response object can be used to extract the information in the wanted form. path is a string specifying the path of the file const response = await cozy.client.files.downloadByPath( /foo/hello.txt ) const blob = await response.blob() const text = await response.text() const buff = await response.arrayBuffer() response.pipe(fs.createWriteStream('/some/file')) cozy.client.files.getDownloadLinkById(id) cozy.client.files.getDownloadLinkById(id) is used to get a download link for the file identified by the given id. It returns a promise for the download link. Download link are only valid for a short while (default 1 hour) You can use this link to start a browser download like this: const href = await cozy.client.files.getDownloadLinkById( id424242 ) const link = document.createElement('a') link.href = href link.download = fileName document.body.appendChild(link) link.click() id is a string specifying the id of the file cozy.client.files.getDownloadLinkByPath(path) cozy.client.files.getDownloadLinkByPath(path) is used to get a download link for the file identified by the given path. It returns a promise for the download link. Download link are only valid for a short while (default 1 hour) You can use this link to start a browser download like this: const href = await cozy.client.files.getDownloadLinkByPath( /foo/hello.txt ) const link = document.createElement('a') link.href = href link.download = fileName document.body.appendChild(link) link.click() path is a string specifying the path of the file cozy.client.files.getArchiveLinkByPaths(paths, name) cozy.client.files.getArchiveLinkByPaths(paths, name) is used to get a download link for a zip file containing all the files identified by the given paths. It returns a promise for the download link. Download link are only valid for a short while (default 1 hour) You can use this link to start a browser download (see code in getDownloadLinkById) const href = await cozy.client.files.getArchiveLinkByPaths([ /foo/hello.txt , /bar/test.txt ]) // href === /files/archive/b1c127c25d99f0b37ac2c2a907f36069/files.zip const href = await cozy.client.files.getArchiveLinkByPaths([ /foo/hello.txt ], secretproject ) // href === /files/archive/bc2a901c127c25d99f0b37a36069c27f/secretproject.zip paths is an array of paths name is the optional name for the generated archive file (default files ). cozy.client.files.getArchiveLinkByIds(ids, name) cozy.client.files.getArchiveLinkByIds(ids, name) is used to get a download link for a zip file containing all the files identified by the given ids. It returns a promise for the download link. Download link are only valid for a short while (default 1 hour) You can use this link to start a browser download (see code in getDownloadLinkById) const href = await cozy.client.files.getArchiveLinkByIds([ 1234567 , 9876543 ]) // href === /files/archive/b1c127c25d99f0b37ac2c2a907f36069/files.zip const href = await cozy.client.files.getArchiveLinkByIds([ 1592673 ], secretproject ) // href === /files/archive/bc2a901c127c25d99f0b37a36069c27f/secretproject.zip ids is an array of ids name is the optional name for the generated archive file (default files ). cozy.client.files.getFilePath(file, folder) cozy.client.files.getFilePath(file, folder) is a helper that generates the file path from root directory. It may be used to specify the path parameter for functions like cozy.client.files.downloadByPath , cozy.client.files.getDownloadLinkByPath or cozy.client.files.getArchiveLinkByPaths . cozy.client.data.addReferencedFiles(doc, fileIds) cozy.client.data.addReferencedFiles(doc, fileIds) binds the files to the document. (see cozy-stack documentation for more details) cozy.client.data.removeReferencedFiles(doc, fileIds) cozy.client.data.removeReferencedFiles(doc, fileIds) unbinds the files to the document. (see cozy-stack documentation for more details) cozy.client.data.listReferencedFiles(doc) cozy.client.data.listReferencedFiles(doc) list the files bound to the document. (see cozy-stack documentation for more details). It returns a promise for a list of filesIds. Files must then be fetched separately. cozy.client.data.fetchReferencedFiles(doc) cozy.client.data.fetchReferencedFiles(doc) fetches the files bound to the document. (see cozy-stack documentation for more details). It returns a promise for a list of files. cozy.client.files.query(indexReference, query) cozy.client.files.query(indexReference, query) find files using an index. It returns a promise with a list of files matching the query. Results will be returned in the order defined for the index. query is an object with the following fields: selector : a mango selector limit : maximum number of results skip : ignore the first x results (pagination) wholeResponse : when set to true, the whole query response will be returned instead of just the docs. This is useful when paginating, because you ll get the next property in the response object. const results = await cozy.client.files.query(photosByDate, { selector : { class : image }, limit : 3, skip : 1 })","title":"Files API"},{"location":"/cozy-client-js/files-api/#files-api","text":"","title":"Files API"},{"location":"/cozy-client-js/files-api/#cozyclientfilescreatedata-options","text":"cozy.client.files.create(data, options) is used to upload a new file onto your cozy It returns a promise for the document of the file created. data can be of the following type: Blob , File , ArrayBuffer , ArrayBufferView , stream.Readable (node) or string . options is an object with the following fields: name : specify the name of the file. optional for a data of type File , type, mandatory otherwise. dirID : specify identifier of the file s directory. if empty, it is the root directory. contentType : specify the content type of the uploaded data. For a File type, it is handled automatically in browsers (default: application/octet-stream ). For nodejs, you can rely on an external module like mime checksum : the base64-encoded (with padding) MD5 digest of the file (optional). lastModifiedDate : a date to specify the last modification time to use for the uploaded file. If the given data is a File instance, the lastModifiedDate is automatically used (not overridden). Warning : this API is not v2 compatible. const created = await cozy.client.files.create(blob, { name: filename , dirID: 123456 , }) const fileCreated = await cozy.client.files.create(fileInput.files[0], { dirID: , checksum: rL0Y20zC+Fzt72VPzMSk2A== , lastModifiedDate: new Date() })","title":"cozy.client.files.create(data, options)"},{"location":"/cozy-client-js/files-api/#cozyclientfilescreatedirectoryoptions","text":"cozy.client.files.createDirectory(options) is used to create a new directory. It returns a promise for the document of the directory created. options is an object with the following fields: name : specify the name of the directory dirID : specify identifier of the file s directory. if empty, it is the root directory. lastModifiedDate : a date to specify the last modification time to use for the directory. const created = await cozy.client.files.createDirectory({ name: mydir , dirID: 123456 , lastModifiedDate: new Date() })","title":"cozy.client.files.createDirectory(options)"},{"location":"/cozy-client-js/files-api/#cozyclientfilescreatedirectorybypathpath","text":"cozy.client.files.createDirectoryByPath(path) is used to create one or more directories for a given path. It returns a promise for the document of the last directory created. path is a string const barDirectory = await cozy.client.files.createDirectoryByPath('/Foo/Bar')","title":"cozy.client.files.createDirectoryByPath(path)"},{"location":"/cozy-client-js/files-api/#cozyclientfilesupdatebyidid-data-options","text":"cozy.client.files.updateById(id, data, options) is used to update the content of an already existing file. It returns a promise for the document of the file updated. id is a string specifying the identifier of the file to modify. data can be of the following type: Blob , File , ArrayBuffer , ArrayBufferView or string . options is an object with the following fields: contentType : specify the content type of the uploaded data. For a File type, it is be handled automatically. default: application/octet-stream . checksum : the base64-encoded (with padding) MD5 digest of the file (optional). lastModifiedDate : a date to specify the last modification time to use for the uploaded file. If the given data is a File instance, the lastModifiedDate is automatically used (not overridden). ifMatch : the previous revision of the file (optional). The update will be rejected if the remote revision doesn t match the given one. const updated = await cozy.client.files.updateById( 654321 , blob, { contentType: text/plain , checksum: rL0Y20zC+Fzt72VPzMSk2A== , lastModifiedDate: new Date(), ifMatch: 1-0e6d5b72 })","title":"cozy.client.files.updateById(id, data, options)"},{"location":"/cozy-client-js/files-api/#cozyclientfilesupdateattributesbyidid-attrs-options","text":"cozy.client.files.updateAttributesById(id, attrs, options) is used to update the attributes associated to a file or directory specified by its id. It returns a promise for the document of the updated directory or file. id is a string specifying the identifier of the file or directory to update attrs is an object containing the changes options is an object with the following fields: ifMatch : the previous revision of the file (optional). The update will be rejected if the remote revision doesn t match the given one. const updated = await cozy.client.files.updateAttributesById( 12345 , { tags: [ foo ] }, { ifMatch: 1-0e6d5b72 })","title":"cozy.client.files.updateAttributesById(id, attrs, options)"},{"location":"/cozy-client-js/files-api/#cozyclientfilesupdateattributesbypathpath-attrs-options","text":"cozy.client.files.updateAttributesByPath(path, attrs, options) is used to update the attributes associated to a file or directory specified by the given path. It returns a promise for the document of the updated directory or file. path : string specifying the path of the file or directory to update attrs is an object containing the changes options is an object with the following fields: ifMatch : the previous revision of the file (optional). The update will be rejected if the remote revision doesn t match the given one. const updated = await cozy.client.files.updateAttributes( /foo/bar , { executable: true }, { ifMatch: 1-0e6d5b72 })","title":"cozy.client.files.updateAttributesByPath(path, attrs, options)"},{"location":"/cozy-client-js/files-api/#cozyclientfilesstatbyidid-offline-options","text":"cozy.client.files.statById(id, offline, options) is used to get the metadata of a file specified by its id. It returns a promise for the information of the file or directory. In the case of a directory, it contains the list of files and sub-directories inside it. This list is limited to 30 items by default, but the options argument allows you to fetch more items. id is a string specifying the file\u2019s or directory\u2019s identifier offline is a boolean (default to true ) options is an object with the following fields: skip : number of items to skip (optional) limit : maximum number of items to return (optional). By default, statById will fetch the metadata from the local database, if it is available. Set the second parameter to false to query the server. Returned directory have a relations() method that allow to access to their content: const dir = await cozy.client.files.statById( io.cozy.files.root-dir ); dir.relations('contents').forEach( (file) = \u2026 )","title":"cozy.client.files.statById(id, offline, options)"},{"location":"/cozy-client-js/files-api/#cozyclientfilesstatbypathpath","text":"cozy.client.files.statByPath(path) is used to get the metadata of a file specified by its path. path : string specifying the path of the file or directory;","title":"cozy.client.files.statByPath(path)"},{"location":"/cozy-client-js/files-api/#cozyclientfilestrashbyidid-options","text":"cozy.client.files.trashById(id, options) is used to move the file or directory identified by the given id to trash. It returns a promise for the document of the file or directory moved to trash. id is a string specifying the identifier of the file or directory options is an object with the following fields: ifMatch : the previous revision of the file (optional). The update will be rejected if the remote revision doesn t match the given one. const trashed = await cozy.client.files.trashById( 1234567 )","title":"cozy.client.files.trashById(id, options)"},{"location":"/cozy-client-js/files-api/#cozyclientfilesdestroybyidid-options","text":"cozy.client.files.destroyById(id, options) is used to shred (destroy definitively) a file or directory identified by the given id. The file must be in the trash folder first. It returns a promise for completion id is a string specifying the identifier of the file or directory options is an object with the following fields: ifMatch : the previous revision of the file (optional). The update will be rejected if the remote revision doesn t match the given one. const trashed = await cozy.client.files.trashById( 1234567 ) await cozy.client.files.destroyById( 1234567 )","title":"cozy.client.files.destroyById(id, options)"},{"location":"/cozy-client-js/files-api/#cozyclientfilesrestorebyidid","text":"cozy.client.files.restoreById(id) is used to restore a file or directory identified by the given id. The file must be in the trash folder. It returns a promise for the restored doc. (with updated parent) id is a string specifying the identifier of the file or directory const trashed = await cozy.client.files.trashById( 1234567 ) const restored = await cozy.client.files.restoreById( 1234567 )","title":"cozy.client.files.restoreById(id)"},{"location":"/cozy-client-js/files-api/#cozyclientfileslisttrash","text":"cozy.client.files.listTrash() returns a promise for the list of all files in the trash. const trashedFilesAndFolders = await cozy.client.files.listTrash()","title":"cozy.client.files.listTrash()"},{"location":"/cozy-client-js/files-api/#cozyclientfilescleartrash","text":"cozy.client.files.clearTrash() destroys definitively all trash content. await cozy.client.files.clearTrash()","title":"cozy.client.files.clearTrash()"},{"location":"/cozy-client-js/files-api/#cozyclientfilesdownloadbyidid","text":"cozy.client.files.downloadById(id) is used to download a file identified by the given id. The file is downloaded through the browser fetch method, use this if you plan to use the file in javascript after. It returns a promise of a fetch Response object. This response object can be used to extract the information in the wanted form. id is a string specifying the identifier of the file const response = await cozy.client.files.downloadById( 1234567 ) const blob = await response.blob() const text = await response.text() const buff = await response.arrayBuffer() response.pipe(fs.createWriteStream('/some/file'))","title":"cozy.client.files.downloadById(id)"},{"location":"/cozy-client-js/files-api/#cozyclientfilesdownloadbypathpath","text":"cozy.client.files.downloadByPath(path) is used to download a file identified by the given path. The file is downloaded through the browser fetch method, use this if you plan to use the file in javascript after. It returns a promise of a fetch Response object. This response object can be used to extract the information in the wanted form. path is a string specifying the path of the file const response = await cozy.client.files.downloadByPath( /foo/hello.txt ) const blob = await response.blob() const text = await response.text() const buff = await response.arrayBuffer() response.pipe(fs.createWriteStream('/some/file'))","title":"cozy.client.files.downloadByPath(path)"},{"location":"/cozy-client-js/files-api/#cozyclientfilesgetdownloadlinkbyidid","text":"cozy.client.files.getDownloadLinkById(id) is used to get a download link for the file identified by the given id. It returns a promise for the download link. Download link are only valid for a short while (default 1 hour) You can use this link to start a browser download like this: const href = await cozy.client.files.getDownloadLinkById( id424242 ) const link = document.createElement('a') link.href = href link.download = fileName document.body.appendChild(link) link.click() id is a string specifying the id of the file","title":"cozy.client.files.getDownloadLinkById(id)"},{"location":"/cozy-client-js/files-api/#cozyclientfilesgetdownloadlinkbypathpath","text":"cozy.client.files.getDownloadLinkByPath(path) is used to get a download link for the file identified by the given path. It returns a promise for the download link. Download link are only valid for a short while (default 1 hour) You can use this link to start a browser download like this: const href = await cozy.client.files.getDownloadLinkByPath( /foo/hello.txt ) const link = document.createElement('a') link.href = href link.download = fileName document.body.appendChild(link) link.click() path is a string specifying the path of the file","title":"cozy.client.files.getDownloadLinkByPath(path)"},{"location":"/cozy-client-js/files-api/#cozyclientfilesgetarchivelinkbypathspaths-name","text":"cozy.client.files.getArchiveLinkByPaths(paths, name) is used to get a download link for a zip file containing all the files identified by the given paths. It returns a promise for the download link. Download link are only valid for a short while (default 1 hour) You can use this link to start a browser download (see code in getDownloadLinkById) const href = await cozy.client.files.getArchiveLinkByPaths([ /foo/hello.txt , /bar/test.txt ]) // href === /files/archive/b1c127c25d99f0b37ac2c2a907f36069/files.zip const href = await cozy.client.files.getArchiveLinkByPaths([ /foo/hello.txt ], secretproject ) // href === /files/archive/bc2a901c127c25d99f0b37a36069c27f/secretproject.zip paths is an array of paths name is the optional name for the generated archive file (default files ).","title":"cozy.client.files.getArchiveLinkByPaths(paths, name)"},{"location":"/cozy-client-js/files-api/#cozyclientfilesgetarchivelinkbyidsids-name","text":"cozy.client.files.getArchiveLinkByIds(ids, name) is used to get a download link for a zip file containing all the files identified by the given ids. It returns a promise for the download link. Download link are only valid for a short while (default 1 hour) You can use this link to start a browser download (see code in getDownloadLinkById) const href = await cozy.client.files.getArchiveLinkByIds([ 1234567 , 9876543 ]) // href === /files/archive/b1c127c25d99f0b37ac2c2a907f36069/files.zip const href = await cozy.client.files.getArchiveLinkByIds([ 1592673 ], secretproject ) // href === /files/archive/bc2a901c127c25d99f0b37a36069c27f/secretproject.zip ids is an array of ids name is the optional name for the generated archive file (default files ).","title":"cozy.client.files.getArchiveLinkByIds(ids, name)"},{"location":"/cozy-client-js/files-api/#cozyclientfilesgetfilepathfile-folder","text":"cozy.client.files.getFilePath(file, folder) is a helper that generates the file path from root directory. It may be used to specify the path parameter for functions like cozy.client.files.downloadByPath , cozy.client.files.getDownloadLinkByPath or cozy.client.files.getArchiveLinkByPaths .","title":"cozy.client.files.getFilePath(file, folder)"},{"location":"/cozy-client-js/files-api/#cozyclientdataaddreferencedfilesdoc-fileids","text":"cozy.client.data.addReferencedFiles(doc, fileIds) binds the files to the document. (see cozy-stack documentation for more details)","title":"cozy.client.data.addReferencedFiles(doc, fileIds)"},{"location":"/cozy-client-js/files-api/#cozyclientdataremovereferencedfilesdoc-fileids","text":"cozy.client.data.removeReferencedFiles(doc, fileIds) unbinds the files to the document. (see cozy-stack documentation for more details)","title":"cozy.client.data.removeReferencedFiles(doc, fileIds)"},{"location":"/cozy-client-js/files-api/#cozyclientdatalistreferencedfilesdoc","text":"cozy.client.data.listReferencedFiles(doc) list the files bound to the document. (see cozy-stack documentation for more details). It returns a promise for a list of filesIds. Files must then be fetched separately.","title":"cozy.client.data.listReferencedFiles(doc)"},{"location":"/cozy-client-js/files-api/#cozyclientdatafetchreferencedfilesdoc","text":"cozy.client.data.fetchReferencedFiles(doc) fetches the files bound to the document. (see cozy-stack documentation for more details). It returns a promise for a list of files.","title":"cozy.client.data.fetchReferencedFiles(doc)"},{"location":"/cozy-client-js/files-api/#cozyclientfilesqueryindexreference-query","text":"cozy.client.files.query(indexReference, query) find files using an index. It returns a promise with a list of files matching the query. Results will be returned in the order defined for the index. query is an object with the following fields: selector : a mango selector limit : maximum number of results skip : ignore the first x results (pagination) wholeResponse : when set to true, the whole query response will be returned instead of just the docs. This is useful when paginating, because you ll get the next property in the response object. const results = await cozy.client.files.query(photosByDate, { selector : { class : image }, limit : 3, skip : 1 })","title":"cozy.client.files.query(indexReference, query)"},{"location":"/cozy-client-js/jobs-api/","text":"Jobs cozy.clients.jobs.count(workerType) cozy.clients.jobs.count returns the number of jobs in the queue for workerType . const nb = cozy.client.jobs.count('sendmail') console.log(`There are ${count} mails waiting to be sent`) cozy.clients.jobs.create(workerType, arguments, options) cozy.clients.jobs.create enqueues a job in the queue for workerType . const job = cozy.client.jobs.create('sendmail', { mode: 'from', to: [ { name: 'Support', email: 'contact@cozycloud.cc' } ], subject: 'Ask support for cozy-desktop', parts: [ { type: 'text/plain', body: 'Hello, I would like some help' } ] }) See the cozy-stack documentation for more informations","title":"Jobs API"},{"location":"/cozy-client-js/jobs-api/#jobs","text":"","title":"Jobs"},{"location":"/cozy-client-js/jobs-api/#cozyclientsjobscountworkertype","text":"cozy.clients.jobs.count returns the number of jobs in the queue for workerType . const nb = cozy.client.jobs.count('sendmail') console.log(`There are ${count} mails waiting to be sent`)","title":"cozy.clients.jobs.count(workerType)"},{"location":"/cozy-client-js/jobs-api/#cozyclientsjobscreateworkertype-arguments-options","text":"cozy.clients.jobs.create enqueues a job in the queue for workerType . const job = cozy.client.jobs.create('sendmail', { mode: 'from', to: [ { name: 'Support', email: 'contact@cozycloud.cc' } ], subject: 'Ask support for cozy-desktop', parts: [ { type: 'text/plain', body: 'Hello, I would like some help' } ] }) See the cozy-stack documentation for more informations","title":"cozy.clients.jobs.create(workerType, arguments, options)"},{"location":"/cozy-client-js/intents-api/","text":"Intents cozy.client.intents.create() cozy.client.intents.create(action, doctype [, data, permissions]) create an intent. It returns a modified Promise for the intent document, having a custom start(element) method. This method interacts with the DOM to append an iframe to the given HTML element. This iframe will provide an access to an app, which will serve a service page able to manage the intent action for the intent doctype. The start(element) method returns a promise for the result document provided by intent service. On Intent ready callback: This start method also takes a second optional argument which is a callback function ( start(element, onReadyCallback) ). When provided, this function will be run when the intent iframe will be completely loaded (using the onload iframe listener). This callback could be useful to run a client code only when the intent iframe is ready and loaded. An intent has to be created everytime an app need to perform an action over a doctype for wich it does not have permission. For example, the Cozy Drive app should create an intent to pick a io.cozy.contacts document. The cozy-stack will determines which app can offer a service to resolve the intent. It s this service s URL that will be passed to the iframe src property. Once the intent process is terminated by service, the iframe is removed from DOM. Example cozy.client.intents.create('EDIT', 'io.cozy.photos', {action: 'crop', width: 100, height: 100}) .start(document.getElementById('intent-service-wrapper')) See cozy-stack documentation for more details. You can also use .then to run some code after the intents is terminated like following: cozy.client.intents.create('EDIT', 'io.cozy.photos', {action: 'crop', width: 100, height: 100}) .start(document.getElementById('intent-service-wrapper')) .then(doc = { // after service.terminate(doc) // code to use the doc }) Example to use removeIntentFrame() method (by passing the flag exposeIntentFrameRemoval flag): cozy.client.intents.create('EDIT', 'io.cozy.photos', {action: 'crop', width: 100, height: 100, exposeIntentFrameRemoval: true}) .start(document.getElementById('intent-service-wrapper')) .then({removeIntentFrame, doc} = { // after service.terminate(doc) // Code to be run before removing the terminated intent iframe removeIntentFrame() // Other code, use doc }) cozy.client.intents.createService() cozy.client.intents.createService([intentId, window]) has to be used in the intent service page. It initializes communication with the parent window (remember: the service is supposed to be in an iframe). If intentId and window parameters are not provided the method will try to retrieve them automatically. It returns a service object, which provides the following methods : * compose(action, doctype, data) : request the client to make a second intent. This returns a promise fulfilled with the second intent result. js // ... const app = await service.compose('INSTALL', 'io.cozy.apps', { slug: 'drive' }) * getData() : returns the data passed to the service by the client. * getIntent() : returns the intent * resizeClient(doc, transitionProperty) : forces the size of the intent modale to a given width, maxWidth, height, maxHeight, or dimensions of a given element. The second optional argument transitionProperty can be used to add a CSS transition property on the intent in order to animate the resizing. js // resize the client ot 300 pixels max height service.resizeClient({ maxHeight: 300 }, '.2s linear') // will be in css - transition: .2s linear; // or service.resizeClient({ element: document.querySelector('.class') }) On intent size: If an intent is used by multiple applications, we don t use resizeClient(), since each application can have his own layout. You have to define the size of the intent in your application terminate(doc) : ends the intent process by passing to the client the resulting document doc . An intent service may only be terminated once. If a boolean exposeIntentFrameRemoval is found as true in the data sent by the client, the terminate() method will return an object with as properties a function named removeIntentFrame to remove the iframe DOM node (in order to be run by the client later on) and the resulting document doc . This could be useful to animate an intent closing and remove the iframe node at the animation ending. cancel() : ends the intent process by passing a null value to the client. This method terminate the intent service the same way that terminate() . throw(error) : throw an error to client and causes the intent promise rejection. Example cozy.client.intents.createService('77bcc42c-0fd8-11e7-ac95-8f605f6e8338', window) .then(intentService = { const data = intentService.getData() // [...] // Do stuff with data // [...] const resultingDoc = { type: 'io.cozy.photos', width: 100, height: 100 } intentService.terminate(resultingDoc) }) cozy.client.intents.getRedirectionURL() cozy.client.intents.getRedirectionURL(doctype, data) retrieves a redirection URL for a given doctype, with specified data. It relies internally on a regular intent mechanism, which creates an intent for the REDIRECT action. It then build the redirection URL from URL sent by the stack and returns it. This URL can be used as link href for example, to show the doctype or the document in an application able to handle it. Example const myFolder = { folder: '4bce4649-e7b7-4226-d82e-6b87dbb684e7' } const url = await cozy.client.getRedirectionURL('io.cozy.files', myFolder) // url is http://domain-app.cozy.rocks/#/files?folder=4bce4649-e7b7-4226-d82e-6b87dbb684e7 cozy.client.intents.redirect() cozy.client.intents.redirect(doctype, data) is based on cozy.client.intents.getRedirectionURL() and it redirects the browser to the retrieved URL.","title":"Intents API"},{"location":"/cozy-client-js/intents-api/#intents","text":"","title":"Intents"},{"location":"/cozy-client-js/intents-api/#cozyclientintentscreate","text":"cozy.client.intents.create(action, doctype [, data, permissions]) create an intent. It returns a modified Promise for the intent document, having a custom start(element) method. This method interacts with the DOM to append an iframe to the given HTML element. This iframe will provide an access to an app, which will serve a service page able to manage the intent action for the intent doctype. The start(element) method returns a promise for the result document provided by intent service. On Intent ready callback: This start method also takes a second optional argument which is a callback function ( start(element, onReadyCallback) ). When provided, this function will be run when the intent iframe will be completely loaded (using the onload iframe listener). This callback could be useful to run a client code only when the intent iframe is ready and loaded. An intent has to be created everytime an app need to perform an action over a doctype for wich it does not have permission. For example, the Cozy Drive app should create an intent to pick a io.cozy.contacts document. The cozy-stack will determines which app can offer a service to resolve the intent. It s this service s URL that will be passed to the iframe src property. Once the intent process is terminated by service, the iframe is removed from DOM.","title":"cozy.client.intents.create()"},{"location":"/cozy-client-js/intents-api/#example","text":"cozy.client.intents.create('EDIT', 'io.cozy.photos', {action: 'crop', width: 100, height: 100}) .start(document.getElementById('intent-service-wrapper')) See cozy-stack documentation for more details. You can also use .then to run some code after the intents is terminated like following: cozy.client.intents.create('EDIT', 'io.cozy.photos', {action: 'crop', width: 100, height: 100}) .start(document.getElementById('intent-service-wrapper')) .then(doc = { // after service.terminate(doc) // code to use the doc }) Example to use removeIntentFrame() method (by passing the flag exposeIntentFrameRemoval flag): cozy.client.intents.create('EDIT', 'io.cozy.photos', {action: 'crop', width: 100, height: 100, exposeIntentFrameRemoval: true}) .start(document.getElementById('intent-service-wrapper')) .then({removeIntentFrame, doc} = { // after service.terminate(doc) // Code to be run before removing the terminated intent iframe removeIntentFrame() // Other code, use doc })","title":"Example"},{"location":"/cozy-client-js/intents-api/#cozyclientintentscreateservice","text":"cozy.client.intents.createService([intentId, window]) has to be used in the intent service page. It initializes communication with the parent window (remember: the service is supposed to be in an iframe). If intentId and window parameters are not provided the method will try to retrieve them automatically. It returns a service object, which provides the following methods : * compose(action, doctype, data) : request the client to make a second intent. This returns a promise fulfilled with the second intent result. js // ... const app = await service.compose('INSTALL', 'io.cozy.apps', { slug: 'drive' }) * getData() : returns the data passed to the service by the client. * getIntent() : returns the intent * resizeClient(doc, transitionProperty) : forces the size of the intent modale to a given width, maxWidth, height, maxHeight, or dimensions of a given element. The second optional argument transitionProperty can be used to add a CSS transition property on the intent in order to animate the resizing. js // resize the client ot 300 pixels max height service.resizeClient({ maxHeight: 300 }, '.2s linear') // will be in css - transition: .2s linear; // or service.resizeClient({ element: document.querySelector('.class') }) On intent size: If an intent is used by multiple applications, we don t use resizeClient(), since each application can have his own layout. You have to define the size of the intent in your application terminate(doc) : ends the intent process by passing to the client the resulting document doc . An intent service may only be terminated once. If a boolean exposeIntentFrameRemoval is found as true in the data sent by the client, the terminate() method will return an object with as properties a function named removeIntentFrame to remove the iframe DOM node (in order to be run by the client later on) and the resulting document doc . This could be useful to animate an intent closing and remove the iframe node at the animation ending. cancel() : ends the intent process by passing a null value to the client. This method terminate the intent service the same way that terminate() . throw(error) : throw an error to client and causes the intent promise rejection.","title":"cozy.client.intents.createService()"},{"location":"/cozy-client-js/intents-api/#example_1","text":"cozy.client.intents.createService('77bcc42c-0fd8-11e7-ac95-8f605f6e8338', window) .then(intentService = { const data = intentService.getData() // [...] // Do stuff with data // [...] const resultingDoc = { type: 'io.cozy.photos', width: 100, height: 100 } intentService.terminate(resultingDoc) })","title":"Example"},{"location":"/cozy-client-js/intents-api/#cozyclientintentsgetredirectionurl","text":"cozy.client.intents.getRedirectionURL(doctype, data) retrieves a redirection URL for a given doctype, with specified data. It relies internally on a regular intent mechanism, which creates an intent for the REDIRECT action. It then build the redirection URL from URL sent by the stack and returns it. This URL can be used as link href for example, to show the doctype or the document in an application able to handle it.","title":"cozy.client.intents.getRedirectionURL()"},{"location":"/cozy-client-js/intents-api/#example_2","text":"const myFolder = { folder: '4bce4649-e7b7-4226-d82e-6b87dbb684e7' } const url = await cozy.client.getRedirectionURL('io.cozy.files', myFolder) // url is http://domain-app.cozy.rocks/#/files?folder=4bce4649-e7b7-4226-d82e-6b87dbb684e7","title":"Example"},{"location":"/cozy-client-js/intents-api/#cozyclientintentsredirect","text":"cozy.client.intents.redirect(doctype, data) is based on cozy.client.intents.getRedirectionURL() and it redirects the browser to the retrieved URL.","title":"cozy.client.intents.redirect()"},{"location":"/cozy-client-js/settings-api/","text":"Settings cozy.client.settings.diskUsage() cozy.client.settings.diskUsage is used to known informations about the total used space on the cozy disk. It returns a promise of the document of the disk-usage of id io.cozy.settings.disk-usage , with attributes containing a used field a string of how many bytes are used on the disk. The used field is a string since the underlying data is an int64 which may not be properly represented in javascript. const usage = await cozy.client.settings.diskUsage() console.log(usage.attributes.used) cozy.client.settings.changePassphrase(oldPassphrase, newPassphrase) cozy.client.settings.changePassphrase is used to change the passphrase of the current user. You must supply the currently used passphrase, as well as the new one. It simply returns a promise that will resolve if the change was successful. cozy.client.settings.getInstance() cozy.client.settings.getInstance returns a promise with informations about the current Cozy instance, such as the locale or the public name. See cozy-stack documentation for more details. cozy.client.settings.updateInstance(instance) cozy.client.settings.updateInstance is used to update informations about the current instance. instance is an object that should be based on to the one you receive from cozy.settings.getInstance() . It returns a promise with the updated instance information. cozy.client.settings.getClients() cozy.client.settings.getClients returns a promise for an array of registered clients. See the cozy-stack documentation for more details. cozy.client.settings.deleteClientById('123') cozy.client.settings.deleteClientById revokes the specified client from the instance. This method returns a promise that simply resolves if the revokation was successful.","title":"Settings API"},{"location":"/cozy-client-js/settings-api/#settings","text":"","title":"Settings"},{"location":"/cozy-client-js/settings-api/#cozyclientsettingsdiskusage","text":"cozy.client.settings.diskUsage is used to known informations about the total used space on the cozy disk. It returns a promise of the document of the disk-usage of id io.cozy.settings.disk-usage , with attributes containing a used field a string of how many bytes are used on the disk. The used field is a string since the underlying data is an int64 which may not be properly represented in javascript. const usage = await cozy.client.settings.diskUsage() console.log(usage.attributes.used)","title":"cozy.client.settings.diskUsage()"},{"location":"/cozy-client-js/settings-api/#cozyclientsettingschangepassphraseoldpassphrase-newpassphrase","text":"cozy.client.settings.changePassphrase is used to change the passphrase of the current user. You must supply the currently used passphrase, as well as the new one. It simply returns a promise that will resolve if the change was successful.","title":"cozy.client.settings.changePassphrase(oldPassphrase, newPassphrase)"},{"location":"/cozy-client-js/settings-api/#cozyclientsettingsgetinstance","text":"cozy.client.settings.getInstance returns a promise with informations about the current Cozy instance, such as the locale or the public name. See cozy-stack documentation for more details.","title":"cozy.client.settings.getInstance()"},{"location":"/cozy-client-js/settings-api/#cozyclientsettingsupdateinstanceinstance","text":"cozy.client.settings.updateInstance is used to update informations about the current instance. instance is an object that should be based on to the one you receive from cozy.settings.getInstance() . It returns a promise with the updated instance information.","title":"cozy.client.settings.updateInstance(instance)"},{"location":"/cozy-client-js/settings-api/#cozyclientsettingsgetclients","text":"cozy.client.settings.getClients returns a promise for an array of registered clients. See the cozy-stack documentation for more details.","title":"cozy.client.settings.getClients()"},{"location":"/cozy-client-js/settings-api/#cozyclientsettingsdeleteclientbyid123","text":"cozy.client.settings.deleteClientById revokes the specified client from the instance. This method returns a promise that simply resolves if the revokation was successful.","title":"cozy.client.settings.deleteClientById('123')"},{"location":"/cozy-client-js/sharing-api/","text":"Sharing cozy.client.files.getCollectionShareLink(id, collectionType) getCollectionShareLink creates codes that can be used to share a collection by links. See the stack documentation for more informations. const sharing = cozy.client.files.getCollectionShareLink(albumID, 'io.cozy.albums') console.log('Sharing id:', sharing.id) console.log('Sharing query-string with the sharecode:', sharing.sharecode)","title":"Sharing API"},{"location":"/cozy-client-js/sharing-api/#sharing","text":"","title":"Sharing"},{"location":"/cozy-client-js/sharing-api/#cozyclientfilesgetcollectionsharelinkid-collectiontype","text":"getCollectionShareLink creates codes that can be used to share a collection by links. See the stack documentation for more informations. const sharing = cozy.client.files.getCollectionShareLink(albumID, 'io.cozy.albums') console.log('Sharing id:', sharing.id) console.log('Sharing query-string with the sharecode:', sharing.sharecode)","title":"cozy.client.files.getCollectionShareLink(id, collectionType)"},{"location":"/cozy-konnector-libs/api/","text":"API Modules addData This function saves the data into the cozy blindly without check You need at least the POST permission for the given doctype in your manifest, to be able to use this function. Parameters: documents : an array of objects corresponding to the data you want to save in the cozy doctype (string): the doctype where you want to save data (ex: io.cozy.bills ) const documents = [ { name: toto , height: 1.8 }, { name: titi , height: 1.7 } ] return addData(documents, io.cozy.height ) cozyClient This is a cozy-client-js instance already initialized and ready to use If you want to access cozy-client-js directly, this method gives you directly an instance of it, initialized according to COZY_URL and COZY_CREDENTIALS environment variable given by cozy-stack You can refer to the cozy-client-js documentation for more information. Example : const {cozyClient} = require( cozy-konnector-libs ) cozyClient.data.defineIndex( my.doctype , [ _id ]) filterData This function filters the passed array from data already present in the cozy so that there is not duplicated data in the cozy. You need at least the GET permission for the given doctype in your manifest, to be able to use this function. Parameters: documents : an array of objects corresponding to the data you want to save in the cozy doctype (string): the doctype where you want to save data (ex: io.cozy.bills ) options : keys (array) : List of keys used to check that two items are the same. By default it is set to `[ id ] . index (optionnal) : Return value returned by cozy.data.defineIndex , the default will correspond to all documents of the selected doctype. selector (optionnal object) : Mango request to get records. Default is built from the keys {selector: {_id: { $gt : null}}} to get all the records. const documents = [ { name: toto , height: 1.8 }, { name: titi , height: 1.7 } ] return filterData(documents, io.cozy.height , { keys: [ name ] }).then(filteredDocuments = addData(filteredDocuments, io.cozy.height )) linkBankOperations linkBankOperations ( entries, doctype, fields, options = {} ) This function will soon move to a dedicated service. You should not use it. The goal of this function is to find links between bills and bank operations. mkdirp Creates a directory and its missing ancestors as needed. Options : ...pathComponents : one or many path components to be joined await mkdirp( /foo ) // Creates /foo await mkdirp( /foo ) // Does nothing as /foo already exists await mkdirp( /bar/baz ) // Creates /bar, then /bar/baz await mkdirp( /foo/bar/baz ) // Creates /foo/bar, then /foo/bar/baz, not /foo await mkdirp( / ) // Does nothing await mkdirp( /qux , qux2/qux3 , qux4 ) // Creates /qux, then /qux/qux2, // then /qux/qux2/qux3 and // finally /qux/qux2/qux3/qux4 The function will automatically add a leading slash when missing: await mkdirp( foo , bar ) // Creates /foo, then /foo/bar normalizeFilename Returns the given name, replacing characters that could be an issue when used in a filename with spaces. Replaced characters include: Those forbidden on one or many popular OS or filesystem: : /\\|?* Those forbidden by the cozy-stack \\0 , \\r and \\n Multiple spaces and/or tabs are replaced with a single space Leading trailing spaces and/or tabs are removed An exception will be thrown in case there is not any filename-compatible character in the given name. Parameters: basename is whatever string you want to generate the filename from ext is an optional file extension, with or without leading dot const { normalizeFilename } = require( cozy-konnector-libs ) const filename = normalizeFilename( *foo/bar: baz \\\\ qux \\t??? , .txt ) // `filename` === `foo bar baz qux.txt` requestFactory This is a function which returns an instance of request-promise initialized with defaults often used in connector development. // Showing defaults req = requestFactory({ cheerio: false, jar: true, json: true }) Options : cheerio : will parse automatically the response.body in a cheerio instance req = requestFactory({ cheerio: true }) req( http://github.com , $ = { const repos = $( #repo_listing .repo ) }) jar : is passed to request options. Remembers cookies for future use. json : will parse the response.body as JSON json : will parse the response.body as JSON resolveWithFullResponse : The full response will be return in the promise. It is compatible with cheerio and json options. req = requestFactory({ resolveWithFullResponse: true, cheerio: true }) req( http://github.com , response = { console.log(response.statusCode) const $ = response.body const repos = $( #repo_listing .repo ) }) You can find the full list of available options in request-promise and request documentations. saveBills Combines the features of saveFiles , filterData , addData and linkBankOperations for a common case: bills. Will create io.cozy.bills objects. The default deduplication keys are [ date , amount , vendor ] . You need the full permission on io.cozy.bills , full permission on io.cozy.files and also full permission on io.cozy.bank.operations in your manifest, to be able to * use this function. Parameters: documents is an array of objects with any attributes with some mandatory attributes : amount (Number): the amount of the bill used to match bank operations date (Date): the date of the bill also used to match bank operations vendor (String): the name of the vendor associated to the bill. Ex: trainline You can also pass attributes expected by saveFiles Please take a look at io.cozy.bills doctype documentation fields (object) this is the first parameter given to BaseKonnector s constructor options is passed directly to saveFiles , hydrateAndFilter , addData and linkBankOperations . const { BaseKonnector, saveBills } = require( cozy-konnector-libs ) module.exports = new BaseKonnector(function fetch (fields) { const documents = [] // some code which fills documents return saveBills(documents, fields, { identifiers: [ vendorj ] }) }) saveFiles The goal of this function is to save the given files in the given folder via the Cozy API. You need the full permission on io.cozy.files in your manifest to use this function. files is an array of { fileurl, filename } : fileurl: The url of the file. This attribute is mandatory or this item will be ignored filename : The file name of the item written on disk. This attribute is optional and as default value, the file name will be smartly guessed by the function. Use this attribute if the guess is not smart enough for you. folderPath (string) is relative to the main path given by the cozy-collect application to the connector. If the connector is run in standalone mode, the main path is the path of the connector. options (object) is optional. Possible options : timeout (timestamp) can be used if your connector needs to fetch a lot of files and if the stack does not give enough time to your connector to fetch it all. It could happen that the connector is stopped right in the middle of the download of the file and the file will be broken. With the timeout option, the saveFiles function will check if the timeout has passed right after downloading each file and then will be sure to be stopped cleanly if the timeout is not too long. And since it is really fast to check that a file has already been downloaded, on the next run of the connector, it will be able to download some more files, and so on. If you want the timeout to be in 10s, do Date.now() + 10*1000 . You can try it in the previous code. signin The goal of this function is to provide an handy method to log the user in, on html form pages. On success, it resolves a promise with a parsed body. Errors: LOGIN_FAILED if the validate predicate is false INVALID_FORM if the element matched by formSelector is not a form or has no action attribute UNKNOWN_PARSING_STRATEGY if parse is not one of the accepted values: raw , cheerio , json . VENDOR_DOWN if a request throws a RequestError, or StatusCodeError It does not submit values provided through select tags, except if populated by user with formData . url is the url to access the html form formSelector is used by cheerio to uniquely identify the form in which to log in formData is an object { name: value, \u2026 } . It is used to populate the form, in the proper inputs with the same name as the properties of this object, before submitting it. It can also be a function that returns this object. The page at url would be given as argument, right after having been parsed through cheerio . parse allow the user to resolve signin with a preparsed body. The choice of the strategy for the parsing is one of : raw , json or cheerio . cheerio being the default. validate is a predicate taking two arguments statusCode and parsedBody . If it is false, LOGIN_FAILED is thrown, otherwise the signin resolves with parsedBody value. requestOpts allows to pass eventual options to the signin s requestFactory . It could be useful for pages using latin1 encoding for instance. updateOrCreate The goal of this function is create or update the given entries according to if they already exist in the cozy or not You need the full permission for the given doctype in your manifest, to be able to use this function. Parameters: entries is an array of objects with any attributes : doctype (string) is the cozy doctype where the entries should be saved matchingAttributes (array of strings) is the list of attributes in each entry should be used to check if an entry is already saved in the cozy Classes BaseKonnector The class from which all the connectors must inherit. It takes a fetch function in parameter that must return a Promise . You need at least the GET permission on io.cozy.accounts in your manifest to allow it to fetch account information for your connector. Document Simple Model for Documents. Allows to specify shouldSave , shouldUpdate as methods. Has useful isEqual method Constants LOGIN_FAILED : String The konnector could not login NOT_EXISTING_DIRECTORY : String The folder specified as folder_to_save does not exist (checked by BaseKonnector) VENDOR_DOWN : String The vendor s website is down USER_ACTION_NEEDED : String There was an unexpected error, please take a look at the logs to know what happened FILE_DOWNLOAD_FAILED : String There was a problem while downloading a file SAVE_FILE_FAILED : String There was a problem while saving a file DISK_QUOTA_EXCEEDED : String Could not save a file to the cozy because of disk quota exceeded Functions mkSpec() Declarative scraping. Describe your items attributes and where to find/parse them instead of imperatively building them. Heavily inspired by artoo scraping method. scrape($, spec(s), [childSelector]) \u21d2 object | array Scrape a cheerio object for properties addData This function saves the data into the cozy blindly without check You need at least the POST permission for the given doctype in your manifest, to be able to use this function. Parameters: documents : an array of objects corresponding to the data you want to save in the cozy doctype (string): the doctype where you want to save data (ex: io.cozy.bills ) const documents = [ { name: 'toto', height: 1.8 }, { name: 'titi', height: 1.7 } ] return addData(documents, 'io.cozy.height') cozyClient This is a cozy-client-js instance already initialized and ready to use If you want to access cozy-client-js directly, this method gives you directly an instance of it, initialized according to COZY_URL and COZY_CREDENTIALS environment variable given by cozy-stack You can refer to the cozy-client-js documentation for more information. Example : const {cozyClient} = require('cozy-konnector-libs') cozyClient.data.defineIndex('my.doctype', ['_id']) filterData This function filters the passed array from data already present in the cozy so that there is not duplicated data in the cozy. You need at least the GET permission for the given doctype in your manifest, to be able to use this function. Parameters: documents : an array of objects corresponding to the data you want to save in the cozy doctype (string): the doctype where you want to save data (ex: io.cozy.bills ) options : keys (array) : List of keys used to check that two items are the same. By default it is set to `[ id ] . index (optionnal) : Return value returned by cozy.data.defineIndex , the default will correspond to all documents of the selected doctype. selector (optionnal object) : Mango request to get records. Default is built from the keys {selector: {_id: {\"$gt\": null}}} to get all the records. const documents = [ { name: 'toto', height: 1.8 }, { name: 'titi', height: 1.7 } ] return filterData(documents, 'io.cozy.height', { keys: ['name'] }).then(filteredDocuments = addData(filteredDocuments, 'io.cozy.height')) filterData~suitableCall() Since we can use methods or basic functions for shouldSave and shouldUpdate we pass the appropriate this and arguments . If funcOrMethod is a method, it will be called with args[0] as this and the rest as arguments Otherwise, this will be null and args will be passed as arguments . Kind : inner method of filterData linkBankOperations linkBankOperations ( entries, doctype, fields, options = {} ) This function will soon move to a dedicated service. You should not use it. The goal of this function is to find links between bills and bank operations. mkdirp Creates a directory and its missing ancestors as needed. Options : ...pathComponents : one or many path components to be joined await mkdirp('/foo') // Creates /foo await mkdirp('/foo') // Does nothing as /foo already exists await mkdirp('/bar/baz') // Creates /bar, then /bar/baz await mkdirp('/foo/bar/baz') // Creates /foo/bar, then /foo/bar/baz, not /foo await mkdirp('/') // Does nothing await mkdirp('/qux', 'qux2/qux3', 'qux4') // Creates /qux, then /qux/qux2, // then /qux/qux2/qux3 and // finally /qux/qux2/qux3/qux4 The function will automatically add a leading slash when missing: await mkdirp('foo', 'bar') // Creates /foo, then /foo/bar normalizeFilename Returns the given name, replacing characters that could be an issue when used in a filename with spaces. Replaced characters include: Those forbidden on one or many popular OS or filesystem: :\"/\\|?* Those forbidden by the cozy-stack \\0 , \\r and \\n Multiple spaces and/or tabs are replaced with a single space Leading trailing spaces and/or tabs are removed An exception will be thrown in case there is not any filename-compatible character in the given name. Parameters: basename is whatever string you want to generate the filename from ext is an optional file extension, with or without leading dot const { normalizeFilename } = require('cozy-konnector-libs') const filename = normalizeFilename('*foo/bar: baz \\\\ qux \\t???', '.txt') // `filename` === `foo bar baz qux.txt` requestFactory This is a function which returns an instance of request-promise initialized with defaults often used in connector development. // Showing defaults req = requestFactory({ cheerio: false, jar: true, json: true }) Options : cheerio : will parse automatically the response.body in a cheerio instance req = requestFactory({ cheerio: true }) req('http://github.com', $ = { const repos = $('#repo_listing .repo') }) jar : is passed to request options. Remembers cookies for future use. json : will parse the response.body as JSON json : will parse the response.body as JSON resolveWithFullResponse : The full response will be return in the promise. It is compatible with cheerio and json options. req = requestFactory({ resolveWithFullResponse: true, cheerio: true }) req('http://github.com', response = { console.log(response.statusCode) const $ = response.body const repos = $('#repo_listing .repo') }) You can find the full list of available options in request-promise and request documentations. saveBills Combines the features of saveFiles , filterData , addData and linkBankOperations for a common case: bills. Will create io.cozy.bills objects. The default deduplication keys are ['date', 'amount', 'vendor'] . You need the full permission on io.cozy.bills , full permission on io.cozy.files and also full permission on io.cozy.bank.operations in your manifest, to be able to * use this function. Parameters: documents is an array of objects with any attributes with some mandatory attributes : amount (Number): the amount of the bill used to match bank operations date (Date): the date of the bill also used to match bank operations vendor (String): the name of the vendor associated to the bill. Ex: trainline You can also pass attributes expected by saveFiles Please take a look at io.cozy.bills doctype documentation fields (object) this is the first parameter given to BaseKonnector s constructor options is passed directly to saveFiles , hydrateAndFilter , addData and linkBankOperations . const { BaseKonnector, saveBills } = require('cozy-konnector-libs') module.exports = new BaseKonnector(function fetch (fields) { const documents = [] // some code which fills documents return saveBills(documents, fields, { identifiers: ['vendorj'] }) }) saveFiles The goal of this function is to save the given files in the given folder via the Cozy API. You need the full permission on io.cozy.files in your manifest to use this function. files is an array of { fileurl, filename } : fileurl: The url of the file. This attribute is mandatory or this item will be ignored filename : The file name of the item written on disk. This attribute is optional and as default value, the file name will be smartly guessed by the function. Use this attribute if the guess is not smart enough for you. folderPath (string) is relative to the main path given by the cozy-collect application to the connector. If the connector is run in standalone mode, the main path is the path of the connector. options (object) is optional. Possible options : timeout (timestamp) can be used if your connector needs to fetch a lot of files and if the stack does not give enough time to your connector to fetch it all. It could happen that the connector is stopped right in the middle of the download of the file and the file will be broken. With the timeout option, the saveFiles function will check if the timeout has passed right after downloading each file and then will be sure to be stopped cleanly if the timeout is not too long. And since it is really fast to check that a file has already been downloaded, on the next run of the connector, it will be able to download some more files, and so on. If you want the timeout to be in 10s, do Date.now() + 10*1000 . You can try it in the previous code. signin The goal of this function is to provide an handy method to log the user in, on html form pages. On success, it resolves a promise with a parsed body. Errors: LOGIN_FAILED if the validate predicate is false INVALID_FORM if the element matched by formSelector is not a form or has no action attribute UNKNOWN_PARSING_STRATEGY if parse is not one of the accepted values: raw , cheerio , json . VENDOR_DOWN if a request throws a RequestError, or StatusCodeError It does not submit values provided through select tags, except if populated by user with formData . url is the url to access the html form formSelector is used by cheerio to uniquely identify the form in which to log in formData is an object { name: value, \u2026 } . It is used to populate the form, in the proper inputs with the same name as the properties of this object, before submitting it. It can also be a function that returns this object. The page at url would be given as argument, right after having been parsed through cheerio . parse allow the user to resolve signin with a preparsed body. The choice of the strategy for the parsing is one of : raw , json or cheerio . cheerio being the default. validate is a predicate taking two arguments statusCode and parsedBody . If it is false, LOGIN_FAILED is thrown, otherwise the signin resolves with parsedBody value. requestOpts allows to pass eventual options to the signin s requestFactory . It could be useful for pages using latin1 encoding for instance. updateOrCreate The goal of this function is create or update the given entries according to if they already exist in the cozy or not You need the full permission for the given doctype in your manifest, to be able to use this function. Parameters: entries is an array of objects with any attributes : doctype (string) is the cozy doctype where the entries should be saved matchingAttributes (array of strings) is the list of attributes in each entry should be used to check if an entry is already saved in the cozy BaseKonnector The class from which all the connectors must inherit. It takes a fetch function in parameter that must return a Promise . You need at least the GET permission on io.cozy.accounts in your manifest to allow it to fetch account information for your connector. Kind : global class BaseKonnector new BaseKonnector(fetch) .end() .fail() .init() \u21d2 Promise .saveAccountData(data, options) \u21d2 Promise .getAccountData() \u21d2 object .terminate(message) new BaseKonnector(fetch) Its role is twofold : Make the link between account data and konnector Handle errors \u26a0\ufe0f A promise should be returned from the fetch function otherwise the konnector cannot know that asynchronous code has been called. this.terminate('LOGIN_FAILED') Param Type Description fetch function Function to be run automatically after account data is fetched. This function will be binded to the current connector. If not fetch function is given. The connector will have to handle itself it s own exection and error handling Example const { BaseKonnector } = require('cozy-konnector-libs') module.exports = new BaseKonnector(function fetch () { // use this to access the instance of the konnector to // store any information that needs to be passed to // different stages of the konnector return request('http://ameli.fr') .then(computeReimbursements) .then(saveBills) }) baseKonnector.end() Hook called when the connector is ended Kind : instance method of BaseKonnector baseKonnector.fail() Hook called when the connector fails Kind : instance method of BaseKonnector baseKonnector.init() \u21d2 Promise Initializes the current connector with data comming from the associated account Kind : instance method of BaseKonnector Returns : Promise - with the fields as an object baseKonnector.saveAccountData(data, options) \u21d2 Promise Saves data to the account that is passed to the konnector. Use it to persist data that needs to be passed to each konnector run. By default, the data is merged to the remote data, use options.merge = false to overwrite the data. The data is saved under the .data attribute of the cozy account. Kind : instance method of BaseKonnector Param Type Description data object Attributes to be merged options object { merge: true baseKonnector.getAccountData() \u21d2 object Get the data saved by saveAccountData Kind : instance method of BaseKonnector baseKonnector.terminate(message) Send a special error code which is interpreted by the cozy stack to terminate the execution of the connector now Kind : instance method of BaseKonnector Param Type Description message string The error code to be saved as connector result see [docs/ERROR_CODES.md] Document Simple Model for Documents. Allows to specify shouldSave , shouldUpdate as methods. Has useful isEqual method Kind : global class document.isEqual() Compares to another document deeply. _id and _rev are by default ignored in the comparison. By default, will compare dates loosely since you often compare existing documents (dates in ISO string) with documents that just have been scraped where dates are Date s. Kind : instance method of Document LOGIN_FAILED : String The konnector could not login Kind : global constant NOT_EXISTING_DIRECTORY : String The folder specified as folder_to_save does not exist (checked by BaseKonnector) Kind : global constant VENDOR_DOWN : String The vendor s website is down Kind : global constant USER_ACTION_NEEDED : String There was an unexpected error, please take a look at the logs to know what happened Kind : global constant FILE_DOWNLOAD_FAILED : String There was a problem while downloading a file Kind : global constant SAVE_FILE_FAILED : String There was a problem while saving a file Kind : global constant DISK_QUOTA_EXCEEDED : String Could not save a file to the cozy because of disk quota exceeded Kind : global constant mkSpec() Declarative scraping. Describe your items attributes and where to find/parse them instead of imperatively building them. Heavily inspired by artoo scraping method. Kind : global function scrape($, spec(s), [childSelector]) \u21d2 object | array Scrape a cheerio object for properties Kind : global function Returns : object | array - - Item(s) scraped Param Type Description $ cheerio Cheerio node which will be scraped spec(s) object | string Options object describing what you want to scrape [childSelector] string If passed, scrape will return an array of items Example scrape can be used to declaratively extract data : For one object : const item = scrape($('#item'), { title: '.title', content: '.content' }) For a list of objects : const items = scrape($('#content'), { title: '.title', content: '.content' }, '.item') For more power, you can use object s for each retriever : const items = scrape($('#content'), { title: '.title', content: '.content', link: { sel: 'a', attr: 'href' }, }, '.item') Here the href attribute of the a inside .item s would have been put into the link attribute of the items returned by scrape . Available options : sel : the CSS selector used to target the HTML node from which data will be scraped attr : the HTML attribute from which to extract data parse : function applied to the value extracted ( { sel: '.price', parse: parseAmount } ) fn : if you need something more complicated than attr , you can use this function, it receives the complete DOM node. { sel: '.person', fn: $node = $node.attr('data-name') + $node.attr('data-firstname') } \u26a0 Permissions Please note that some classes require some permissions: io.cozy.accounts for the BaseKonnector class ( GET only) io.cozy.files to save files io.cozy.bills to save bills io.cozy.bank.operations for linkBankOperations","title":"API"},{"location":"/cozy-konnector-libs/api/#api","text":"","title":"API"},{"location":"/cozy-konnector-libs/api/#modules","text":"addData This function saves the data into the cozy blindly without check You need at least the POST permission for the given doctype in your manifest, to be able to use this function. Parameters: documents : an array of objects corresponding to the data you want to save in the cozy doctype (string): the doctype where you want to save data (ex: io.cozy.bills ) const documents = [ { name: toto , height: 1.8 }, { name: titi , height: 1.7 } ] return addData(documents, io.cozy.height ) cozyClient This is a cozy-client-js instance already initialized and ready to use If you want to access cozy-client-js directly, this method gives you directly an instance of it, initialized according to COZY_URL and COZY_CREDENTIALS environment variable given by cozy-stack You can refer to the cozy-client-js documentation for more information. Example : const {cozyClient} = require( cozy-konnector-libs ) cozyClient.data.defineIndex( my.doctype , [ _id ]) filterData This function filters the passed array from data already present in the cozy so that there is not duplicated data in the cozy. You need at least the GET permission for the given doctype in your manifest, to be able to use this function. Parameters: documents : an array of objects corresponding to the data you want to save in the cozy doctype (string): the doctype where you want to save data (ex: io.cozy.bills ) options : keys (array) : List of keys used to check that two items are the same. By default it is set to `[ id ] . index (optionnal) : Return value returned by cozy.data.defineIndex , the default will correspond to all documents of the selected doctype. selector (optionnal object) : Mango request to get records. Default is built from the keys {selector: {_id: { $gt : null}}} to get all the records. const documents = [ { name: toto , height: 1.8 }, { name: titi , height: 1.7 } ] return filterData(documents, io.cozy.height , { keys: [ name ] }).then(filteredDocuments = addData(filteredDocuments, io.cozy.height )) linkBankOperations","title":"Modules"},{"location":"/cozy-konnector-libs/api/#classes","text":"BaseKonnector The class from which all the connectors must inherit. It takes a fetch function in parameter that must return a Promise . You need at least the GET permission on io.cozy.accounts in your manifest to allow it to fetch account information for your connector. Document Simple Model for Documents. Allows to specify shouldSave , shouldUpdate as methods. Has useful isEqual method","title":"Classes"},{"location":"/cozy-konnector-libs/api/#constants","text":"LOGIN_FAILED : String The konnector could not login NOT_EXISTING_DIRECTORY : String The folder specified as folder_to_save does not exist (checked by BaseKonnector) VENDOR_DOWN : String The vendor s website is down USER_ACTION_NEEDED : String There was an unexpected error, please take a look at the logs to know what happened FILE_DOWNLOAD_FAILED : String There was a problem while downloading a file SAVE_FILE_FAILED : String There was a problem while saving a file DISK_QUOTA_EXCEEDED : String Could not save a file to the cozy because of disk quota exceeded","title":"Constants"},{"location":"/cozy-konnector-libs/api/#functions","text":"mkSpec() Declarative scraping. Describe your items attributes and where to find/parse them instead of imperatively building them. Heavily inspired by artoo scraping method. scrape($, spec(s), [childSelector]) \u21d2 object | array Scrape a cheerio object for properties","title":"Functions"},{"location":"/cozy-konnector-libs/api/#adddata","text":"This function saves the data into the cozy blindly without check You need at least the POST permission for the given doctype in your manifest, to be able to use this function. Parameters: documents : an array of objects corresponding to the data you want to save in the cozy doctype (string): the doctype where you want to save data (ex: io.cozy.bills ) const documents = [ { name: 'toto', height: 1.8 }, { name: 'titi', height: 1.7 } ] return addData(documents, 'io.cozy.height')","title":"addData"},{"location":"/cozy-konnector-libs/api/#cozyclient","text":"This is a cozy-client-js instance already initialized and ready to use If you want to access cozy-client-js directly, this method gives you directly an instance of it, initialized according to COZY_URL and COZY_CREDENTIALS environment variable given by cozy-stack You can refer to the cozy-client-js documentation for more information. Example : const {cozyClient} = require('cozy-konnector-libs') cozyClient.data.defineIndex('my.doctype', ['_id'])","title":"cozyClient"},{"location":"/cozy-konnector-libs/api/#filterdata","text":"This function filters the passed array from data already present in the cozy so that there is not duplicated data in the cozy. You need at least the GET permission for the given doctype in your manifest, to be able to use this function. Parameters: documents : an array of objects corresponding to the data you want to save in the cozy doctype (string): the doctype where you want to save data (ex: io.cozy.bills ) options : keys (array) : List of keys used to check that two items are the same. By default it is set to `[ id ] . index (optionnal) : Return value returned by cozy.data.defineIndex , the default will correspond to all documents of the selected doctype. selector (optionnal object) : Mango request to get records. Default is built from the keys {selector: {_id: {\"$gt\": null}}} to get all the records. const documents = [ { name: 'toto', height: 1.8 }, { name: 'titi', height: 1.7 } ] return filterData(documents, 'io.cozy.height', { keys: ['name'] }).then(filteredDocuments = addData(filteredDocuments, 'io.cozy.height'))","title":"filterData"},{"location":"/cozy-konnector-libs/api/#filterdatasuitablecall","text":"Since we can use methods or basic functions for shouldSave and shouldUpdate we pass the appropriate this and arguments . If funcOrMethod is a method, it will be called with args[0] as this and the rest as arguments Otherwise, this will be null and args will be passed as arguments . Kind : inner method of filterData","title":"filterData~suitableCall()"},{"location":"/cozy-konnector-libs/api/#linkbankoperations","text":"","title":"linkBankOperations"},{"location":"/cozy-konnector-libs/api/#linkbankoperations-entries-doctype-fields-options","text":"This function will soon move to a dedicated service. You should not use it. The goal of this function is to find links between bills and bank operations.","title":"linkBankOperations ( entries, doctype, fields, options = {} )"},{"location":"/cozy-konnector-libs/api/#mkdirp","text":"Creates a directory and its missing ancestors as needed. Options : ...pathComponents : one or many path components to be joined await mkdirp('/foo') // Creates /foo await mkdirp('/foo') // Does nothing as /foo already exists await mkdirp('/bar/baz') // Creates /bar, then /bar/baz await mkdirp('/foo/bar/baz') // Creates /foo/bar, then /foo/bar/baz, not /foo await mkdirp('/') // Does nothing await mkdirp('/qux', 'qux2/qux3', 'qux4') // Creates /qux, then /qux/qux2, // then /qux/qux2/qux3 and // finally /qux/qux2/qux3/qux4 The function will automatically add a leading slash when missing: await mkdirp('foo', 'bar') // Creates /foo, then /foo/bar","title":"mkdirp"},{"location":"/cozy-konnector-libs/api/#normalizefilename","text":"Returns the given name, replacing characters that could be an issue when used in a filename with spaces. Replaced characters include: Those forbidden on one or many popular OS or filesystem: :\"/\\|?* Those forbidden by the cozy-stack \\0 , \\r and \\n Multiple spaces and/or tabs are replaced with a single space Leading trailing spaces and/or tabs are removed An exception will be thrown in case there is not any filename-compatible character in the given name. Parameters: basename is whatever string you want to generate the filename from ext is an optional file extension, with or without leading dot const { normalizeFilename } = require('cozy-konnector-libs') const filename = normalizeFilename('*foo/bar: baz \\\\ qux \\t???', '.txt') // `filename` === `foo bar baz qux.txt`","title":"normalizeFilename"},{"location":"/cozy-konnector-libs/api/#requestfactory","text":"This is a function which returns an instance of request-promise initialized with defaults often used in connector development. // Showing defaults req = requestFactory({ cheerio: false, jar: true, json: true }) Options : cheerio : will parse automatically the response.body in a cheerio instance req = requestFactory({ cheerio: true }) req('http://github.com', $ = { const repos = $('#repo_listing .repo') }) jar : is passed to request options. Remembers cookies for future use. json : will parse the response.body as JSON json : will parse the response.body as JSON resolveWithFullResponse : The full response will be return in the promise. It is compatible with cheerio and json options. req = requestFactory({ resolveWithFullResponse: true, cheerio: true }) req('http://github.com', response = { console.log(response.statusCode) const $ = response.body const repos = $('#repo_listing .repo') }) You can find the full list of available options in request-promise and request documentations.","title":"requestFactory"},{"location":"/cozy-konnector-libs/api/#savebills","text":"Combines the features of saveFiles , filterData , addData and linkBankOperations for a common case: bills. Will create io.cozy.bills objects. The default deduplication keys are ['date', 'amount', 'vendor'] . You need the full permission on io.cozy.bills , full permission on io.cozy.files and also full permission on io.cozy.bank.operations in your manifest, to be able to * use this function. Parameters: documents is an array of objects with any attributes with some mandatory attributes : amount (Number): the amount of the bill used to match bank operations date (Date): the date of the bill also used to match bank operations vendor (String): the name of the vendor associated to the bill. Ex: trainline You can also pass attributes expected by saveFiles Please take a look at io.cozy.bills doctype documentation fields (object) this is the first parameter given to BaseKonnector s constructor options is passed directly to saveFiles , hydrateAndFilter , addData and linkBankOperations . const { BaseKonnector, saveBills } = require('cozy-konnector-libs') module.exports = new BaseKonnector(function fetch (fields) { const documents = [] // some code which fills documents return saveBills(documents, fields, { identifiers: ['vendorj'] }) })","title":"saveBills"},{"location":"/cozy-konnector-libs/api/#savefiles","text":"The goal of this function is to save the given files in the given folder via the Cozy API. You need the full permission on io.cozy.files in your manifest to use this function. files is an array of { fileurl, filename } : fileurl: The url of the file. This attribute is mandatory or this item will be ignored filename : The file name of the item written on disk. This attribute is optional and as default value, the file name will be smartly guessed by the function. Use this attribute if the guess is not smart enough for you. folderPath (string) is relative to the main path given by the cozy-collect application to the connector. If the connector is run in standalone mode, the main path is the path of the connector. options (object) is optional. Possible options : timeout (timestamp) can be used if your connector needs to fetch a lot of files and if the stack does not give enough time to your connector to fetch it all. It could happen that the connector is stopped right in the middle of the download of the file and the file will be broken. With the timeout option, the saveFiles function will check if the timeout has passed right after downloading each file and then will be sure to be stopped cleanly if the timeout is not too long. And since it is really fast to check that a file has already been downloaded, on the next run of the connector, it will be able to download some more files, and so on. If you want the timeout to be in 10s, do Date.now() + 10*1000 . You can try it in the previous code.","title":"saveFiles"},{"location":"/cozy-konnector-libs/api/#signin","text":"The goal of this function is to provide an handy method to log the user in, on html form pages. On success, it resolves a promise with a parsed body. Errors: LOGIN_FAILED if the validate predicate is false INVALID_FORM if the element matched by formSelector is not a form or has no action attribute UNKNOWN_PARSING_STRATEGY if parse is not one of the accepted values: raw , cheerio , json . VENDOR_DOWN if a request throws a RequestError, or StatusCodeError It does not submit values provided through select tags, except if populated by user with formData . url is the url to access the html form formSelector is used by cheerio to uniquely identify the form in which to log in formData is an object { name: value, \u2026 } . It is used to populate the form, in the proper inputs with the same name as the properties of this object, before submitting it. It can also be a function that returns this object. The page at url would be given as argument, right after having been parsed through cheerio . parse allow the user to resolve signin with a preparsed body. The choice of the strategy for the parsing is one of : raw , json or cheerio . cheerio being the default. validate is a predicate taking two arguments statusCode and parsedBody . If it is false, LOGIN_FAILED is thrown, otherwise the signin resolves with parsedBody value. requestOpts allows to pass eventual options to the signin s requestFactory . It could be useful for pages using latin1 encoding for instance.","title":"signin"},{"location":"/cozy-konnector-libs/api/#updateorcreate","text":"The goal of this function is create or update the given entries according to if they already exist in the cozy or not You need the full permission for the given doctype in your manifest, to be able to use this function. Parameters: entries is an array of objects with any attributes : doctype (string) is the cozy doctype where the entries should be saved matchingAttributes (array of strings) is the list of attributes in each entry should be used to check if an entry is already saved in the cozy","title":"updateOrCreate"},{"location":"/cozy-konnector-libs/api/#basekonnector","text":"The class from which all the connectors must inherit. It takes a fetch function in parameter that must return a Promise . You need at least the GET permission on io.cozy.accounts in your manifest to allow it to fetch account information for your connector. Kind : global class BaseKonnector new BaseKonnector(fetch) .end() .fail() .init() \u21d2 Promise .saveAccountData(data, options) \u21d2 Promise .getAccountData() \u21d2 object .terminate(message)","title":"BaseKonnector"},{"location":"/cozy-konnector-libs/api/#new-basekonnectorfetch","text":"Its role is twofold : Make the link between account data and konnector Handle errors \u26a0\ufe0f A promise should be returned from the fetch function otherwise the konnector cannot know that asynchronous code has been called. this.terminate('LOGIN_FAILED') Param Type Description fetch function Function to be run automatically after account data is fetched. This function will be binded to the current connector. If not fetch function is given. The connector will have to handle itself it s own exection and error handling Example const { BaseKonnector } = require('cozy-konnector-libs') module.exports = new BaseKonnector(function fetch () { // use this to access the instance of the konnector to // store any information that needs to be passed to // different stages of the konnector return request('http://ameli.fr') .then(computeReimbursements) .then(saveBills) })","title":"new BaseKonnector(fetch)"},{"location":"/cozy-konnector-libs/api/#basekonnectorend","text":"Hook called when the connector is ended Kind : instance method of BaseKonnector","title":"baseKonnector.end()"},{"location":"/cozy-konnector-libs/api/#basekonnectorfail","text":"Hook called when the connector fails Kind : instance method of BaseKonnector","title":"baseKonnector.fail()"},{"location":"/cozy-konnector-libs/api/#basekonnectorinit-promise","text":"Initializes the current connector with data comming from the associated account Kind : instance method of BaseKonnector Returns : Promise - with the fields as an object","title":"baseKonnector.init() \u21d2 Promise"},{"location":"/cozy-konnector-libs/api/#basekonnectorsaveaccountdatadata-options-promise","text":"Saves data to the account that is passed to the konnector. Use it to persist data that needs to be passed to each konnector run. By default, the data is merged to the remote data, use options.merge = false to overwrite the data. The data is saved under the .data attribute of the cozy account. Kind : instance method of BaseKonnector Param Type Description data object Attributes to be merged options object { merge: true","title":"baseKonnector.saveAccountData(data, options) \u21d2 Promise"},{"location":"/cozy-konnector-libs/api/#basekonnectorgetaccountdata-object","text":"Get the data saved by saveAccountData Kind : instance method of BaseKonnector","title":"baseKonnector.getAccountData() \u21d2 object"},{"location":"/cozy-konnector-libs/api/#basekonnectorterminatemessage","text":"Send a special error code which is interpreted by the cozy stack to terminate the execution of the connector now Kind : instance method of BaseKonnector Param Type Description message string The error code to be saved as connector result see [docs/ERROR_CODES.md]","title":"baseKonnector.terminate(message)"},{"location":"/cozy-konnector-libs/api/#document","text":"Simple Model for Documents. Allows to specify shouldSave , shouldUpdate as methods. Has useful isEqual method Kind : global class","title":"Document"},{"location":"/cozy-konnector-libs/api/#documentisequal","text":"Compares to another document deeply. _id and _rev are by default ignored in the comparison. By default, will compare dates loosely since you often compare existing documents (dates in ISO string) with documents that just have been scraped where dates are Date s. Kind : instance method of Document","title":"document.isEqual()"},{"location":"/cozy-konnector-libs/api/#login_failed-string","text":"The konnector could not login Kind : global constant","title":"LOGIN_FAILED : String"},{"location":"/cozy-konnector-libs/api/#not_existing_directory-string","text":"The folder specified as folder_to_save does not exist (checked by BaseKonnector) Kind : global constant","title":"NOT_EXISTING_DIRECTORY : String"},{"location":"/cozy-konnector-libs/api/#vendor_down-string","text":"The vendor s website is down Kind : global constant","title":"VENDOR_DOWN : String"},{"location":"/cozy-konnector-libs/api/#user_action_needed-string","text":"There was an unexpected error, please take a look at the logs to know what happened Kind : global constant","title":"USER_ACTION_NEEDED : String"},{"location":"/cozy-konnector-libs/api/#file_download_failed-string","text":"There was a problem while downloading a file Kind : global constant","title":"FILE_DOWNLOAD_FAILED : String"},{"location":"/cozy-konnector-libs/api/#save_file_failed-string","text":"There was a problem while saving a file Kind : global constant","title":"SAVE_FILE_FAILED : String"},{"location":"/cozy-konnector-libs/api/#disk_quota_exceeded-string","text":"Could not save a file to the cozy because of disk quota exceeded Kind : global constant","title":"DISK_QUOTA_EXCEEDED : String"},{"location":"/cozy-konnector-libs/api/#mkspec","text":"Declarative scraping. Describe your items attributes and where to find/parse them instead of imperatively building them. Heavily inspired by artoo scraping method. Kind : global function","title":"mkSpec()"},{"location":"/cozy-konnector-libs/api/#scrape-specs-childselector-object-124-array","text":"Scrape a cheerio object for properties Kind : global function Returns : object | array - - Item(s) scraped Param Type Description $ cheerio Cheerio node which will be scraped spec(s) object | string Options object describing what you want to scrape [childSelector] string If passed, scrape will return an array of items Example scrape can be used to declaratively extract data : For one object : const item = scrape($('#item'), { title: '.title', content: '.content' }) For a list of objects : const items = scrape($('#content'), { title: '.title', content: '.content' }, '.item') For more power, you can use object s for each retriever : const items = scrape($('#content'), { title: '.title', content: '.content', link: { sel: 'a', attr: 'href' }, }, '.item') Here the href attribute of the a inside .item s would have been put into the link attribute of the items returned by scrape . Available options : sel : the CSS selector used to target the HTML node from which data will be scraped attr : the HTML attribute from which to extract data parse : function applied to the value extracted ( { sel: '.price', parse: parseAmount } ) fn : if you need something more complicated than attr , you can use this function, it receives the complete DOM node. { sel: '.person', fn: $node = $node.attr('data-name') + $node.attr('data-firstname') }","title":"scrape($, spec(s), [childSelector]) \u21d2 object | array"},{"location":"/cozy-konnector-libs/api/#permissions","text":"Please note that some classes require some permissions: io.cozy.accounts for the BaseKonnector class ( GET only) io.cozy.files to save files io.cozy.bills to save bills io.cozy.bank.operations for linkBankOperations","title":"\u26a0 Permissions"},{"location":"/cozy-konnector-libs/cli/","text":"CLI There is a specific npm package which provides cli tools to allow to run your connector in standalone or development mode : cozy-jobs-cli. You can install it in your connector as a dev dependency. cozy-run-standalone If you just want to test your connector without any cozy available, add the following code in the scripts section of your package.json file scripts: { standalone: cozy-run-standalone } and run: yarn standalone The requests to the cozy-stack will be stubbed using the [./fixture.json] file as source of data and when cozy-client-js is asked to create or update data, the data will be output to the console. The bills (or any file) will be saved in the ./data directory. It is possible to add an argument to this command which tells which file to run. Default is defined in package.json main section or ./src/index.js It is possible to record and replay the requests done by the standalone command using the replay module. Arguments Usage: cozy-run-standalone [options] file Options: --record Record all the requests in the ./fixtures directory using the replay module --replay Replay all the recorded requests -h, --help output usage information cozy-run-dev If you want to run your connector linked to a cozy-stack, even remotely. Just add the follwing code in the scripts section of your package.json file: scripts: { dev: cozy-run-dev } and run: yarn dev This command will register your konnector as an OAuth application to the cozy-stack and then set the COZY_CREDENTIALS and COZY_FIELDS environment variable. By default, the cozy-stack is supposed to be located in http://cozy.tools:8080. If this is not your case, just update the COZY_URL field in [./konnector-dev-config.json]. After that, your connector is running but should not work since you did not specify any credentials to the target service. You can do this also in [./konnector-dev-config.json] in the fields section. The files are saved in the root directory of your cozy by default. It is also possible to add an argument to this command which tells which file to run. Default is defined in package.json main section or ./src/index.js Arguments $ cozy-run-dev file [-t token.json] [-m manifest.webapp] -t , --token : Specify where the token should be saved -m , --manifest : Specify the manifest.path that should be used for the permissions cozy-run-shell When you are developping a connector, it is possible to get a REPL with all the cozy-konnector-libs tools available and some enhancement. scripts: { dev: cozy-run-shell } and run: yarn shell In this REPL, all the cozy-konnector-libs tools are available as globals and a default global request instance initialized with cheerio and cookie handling is available. For example run : request('http://quotes.toscrape.com/') After running a request, a global $ object with a cheerio instance is available. Run : $ A full global request-promise response object is also available. If you always want the details of the request and the response to be displayed. Just run once: debug() And you get a syntax colored html representation of the result of the request. If you run : $('p') You get an array of elements with for each element: - the type of the element (p) - the html of the element - the cleaned text of the element It is also possible to load a html file into the shell. Run : yarn shell index.html The html file will load and $ will be correctly initialized. Arguments $ cozy-run-shell [ file ]","title":"CLI"},{"location":"/cozy-konnector-libs/cli/#cli","text":"There is a specific npm package which provides cli tools to allow to run your connector in standalone or development mode : cozy-jobs-cli. You can install it in your connector as a dev dependency.","title":"CLI"},{"location":"/cozy-konnector-libs/cli/#cozy-run-standalone","text":"If you just want to test your connector without any cozy available, add the following code in the scripts section of your package.json file scripts: { standalone: cozy-run-standalone } and run: yarn standalone The requests to the cozy-stack will be stubbed using the [./fixture.json] file as source of data and when cozy-client-js is asked to create or update data, the data will be output to the console. The bills (or any file) will be saved in the ./data directory. It is possible to add an argument to this command which tells which file to run. Default is defined in package.json main section or ./src/index.js It is possible to record and replay the requests done by the standalone command using the replay module.","title":"cozy-run-standalone"},{"location":"/cozy-konnector-libs/cli/#arguments","text":"Usage: cozy-run-standalone [options] file Options: --record Record all the requests in the ./fixtures directory using the replay module --replay Replay all the recorded requests -h, --help output usage information","title":"Arguments"},{"location":"/cozy-konnector-libs/cli/#cozy-run-dev","text":"If you want to run your connector linked to a cozy-stack, even remotely. Just add the follwing code in the scripts section of your package.json file: scripts: { dev: cozy-run-dev } and run: yarn dev This command will register your konnector as an OAuth application to the cozy-stack and then set the COZY_CREDENTIALS and COZY_FIELDS environment variable. By default, the cozy-stack is supposed to be located in http://cozy.tools:8080. If this is not your case, just update the COZY_URL field in [./konnector-dev-config.json]. After that, your connector is running but should not work since you did not specify any credentials to the target service. You can do this also in [./konnector-dev-config.json] in the fields section. The files are saved in the root directory of your cozy by default. It is also possible to add an argument to this command which tells which file to run. Default is defined in package.json main section or ./src/index.js","title":"cozy-run-dev"},{"location":"/cozy-konnector-libs/cli/#arguments_1","text":"$ cozy-run-dev file [-t token.json] [-m manifest.webapp] -t , --token : Specify where the token should be saved -m , --manifest : Specify the manifest.path that should be used for the permissions","title":"Arguments"},{"location":"/cozy-konnector-libs/cli/#cozy-run-shell","text":"When you are developping a connector, it is possible to get a REPL with all the cozy-konnector-libs tools available and some enhancement. scripts: { dev: cozy-run-shell } and run: yarn shell In this REPL, all the cozy-konnector-libs tools are available as globals and a default global request instance initialized with cheerio and cookie handling is available. For example run : request('http://quotes.toscrape.com/') After running a request, a global $ object with a cheerio instance is available. Run : $ A full global request-promise response object is also available. If you always want the details of the request and the response to be displayed. Just run once: debug() And you get a syntax colored html representation of the result of the request. If you run : $('p') You get an array of elements with for each element: - the type of the element (p) - the html of the element - the cleaned text of the element It is also possible to load a html file into the shell. Run : yarn shell index.html The html file will load and $ will be correctly initialized.","title":"cozy-run-shell"},{"location":"/cozy-konnector-libs/cli/#arguments_2","text":"$ cozy-run-shell [ file ]","title":"Arguments"},{"location":"/cozy-konnector-libs/dev/","text":"Developing a konnector Without an accessible cozy-stack If you just want to test this connector without any cozy available. You first need an installed [nodejs] (LTS version is fine). And the last version of yarn : npm install --global yarn Then just run : yarn yarn standalone The requests to the cozy-stack will be stubbed using the [./fixture.json] file as source of data and when cozy-client is asked to create or update data, the data will be output to the console. The bills (or any file) will be saved in the . directory. With the cozy-stack If you do not want to have to install the konnector on a cozy v3 to test it, you can register the konnector as an OAuth application with the following commands : yarn yarn dev This command will register your konnector as an OAuth application to the cozy-stack. By default, the cozy-stack is supposed to be located in http://cozy.tools:8080. If this is not your case, just update the COZY_URL field in [./konnector-dev-config.json]. After that, your konnector is running but should not work since you did not specify any credentials to the target service. You can do this also in [./konnector-dev-config.json] in the fields attribute. Now run yarn dev one more time, it should be ok. The files are saved in the root directory of your cozy by default. How does the cozy-stack run the connector ? The cozy-stack runs the connector in a nsjail container to be sure it does not affect the environment. The connector is run by calling yarn start with the following envrionment variables : COZY_CREDENTIALS needs to be the result of cozy-stack instances token-cli instance name scope COZY_URL is the full http or https url to your cozy COZY_FIELDS is something like : { data :{ attributes :{ arguments :{ account : cf31eaef5d899404a7e8c3737c1c2d1f , folder_to_save : folderPathId , slug : mykonnector } } } } The account field is the id of the record with doctype io.cozy.accounts which will be used as parameters for your konnector. Build (without Travis) To be able to run the connector, the cozy stack needs a connector which is built into only one file, without needing to install its dependencies, this will be a lot faster to install. There is a command in package.json to help you to do that : yarn build This command uses [webpack] to bundle all the code needed by your connector into one file. This will generate an index.js file in the build directory and add all files the connector will need. You can deploy this build by using the specific script : yarn deploy This command will commit and push your build in the branch build fo your project. And your konnector can now be installed using the following url : git://github.com/konnectors/cozy-konnector- .git#build Build using Travis CI This project contains a .travis.yml config file which allows you to build your connector automatically using [Travis-CI][travis]. You can follow these steps to enable building using Travis: On your [travis-ci.org][travis] account, find your project name (should be the same than your Github repository) and enable Travis by using the related checkbox. Once enabled, go to this project on Travis by clicking on it and go to the Settings menu by using the More options menu at the top right. Enable these three options: Build only if .travis.yml is present Build branch updates (run Travis after each branch update) Build pull request updates (run Travis after each Pull Request update) Then, you have to generate a Github token in your Github account settings . Here is the Github blog post about API token . Don t forget to authorize the access to the repo scope like following: Then, add an environment variable (still in your Travis project settings) named GITHUB_TOKEN and use your previous generated Github token as value (We highly recommand you to keep the checkbox Display value in build log to OFF value in order to keep your token value hidden in the Travis logs.) Now Travis is ready to build your project, it should build it each time your push a commit in your repository or create a pull request. Note: Travis will push your build to your build branch ONLY for commits made on your master branch (included PR merge commits). You can see the related Travis statement here . Add your new connector to Cozy Collect The Cozy Collect application will soon use an application store as source of connectors. But for now, if you want to add your new connector to Cozy Collect, you can submit a message in the forum in the collect section , and we will handle this for you.","title":"Develop"},{"location":"/cozy-konnector-libs/dev/#developing-a-konnector","text":"","title":"Developing a konnector"},{"location":"/cozy-konnector-libs/dev/#without-an-accessible-cozy-stack","text":"If you just want to test this connector without any cozy available. You first need an installed [nodejs] (LTS version is fine). And the last version of yarn : npm install --global yarn Then just run : yarn yarn standalone The requests to the cozy-stack will be stubbed using the [./fixture.json] file as source of data and when cozy-client is asked to create or update data, the data will be output to the console. The bills (or any file) will be saved in the . directory.","title":"Without an accessible cozy-stack"},{"location":"/cozy-konnector-libs/dev/#with-the-cozy-stack","text":"If you do not want to have to install the konnector on a cozy v3 to test it, you can register the konnector as an OAuth application with the following commands : yarn yarn dev This command will register your konnector as an OAuth application to the cozy-stack. By default, the cozy-stack is supposed to be located in http://cozy.tools:8080. If this is not your case, just update the COZY_URL field in [./konnector-dev-config.json]. After that, your konnector is running but should not work since you did not specify any credentials to the target service. You can do this also in [./konnector-dev-config.json] in the fields attribute. Now run yarn dev one more time, it should be ok. The files are saved in the root directory of your cozy by default.","title":"With the cozy-stack"},{"location":"/cozy-konnector-libs/dev/#how-does-the-cozy-stack-run-the-connector","text":"The cozy-stack runs the connector in a nsjail container to be sure it does not affect the environment. The connector is run by calling yarn start with the following envrionment variables : COZY_CREDENTIALS needs to be the result of cozy-stack instances token-cli instance name scope COZY_URL is the full http or https url to your cozy COZY_FIELDS is something like : { data :{ attributes :{ arguments :{ account : cf31eaef5d899404a7e8c3737c1c2d1f , folder_to_save : folderPathId , slug : mykonnector } } } } The account field is the id of the record with doctype io.cozy.accounts which will be used as parameters for your konnector.","title":"How does the cozy-stack run the connector ?"},{"location":"/cozy-konnector-libs/dev/#build-without-travis","text":"To be able to run the connector, the cozy stack needs a connector which is built into only one file, without needing to install its dependencies, this will be a lot faster to install. There is a command in package.json to help you to do that : yarn build This command uses [webpack] to bundle all the code needed by your connector into one file. This will generate an index.js file in the build directory and add all files the connector will need. You can deploy this build by using the specific script : yarn deploy This command will commit and push your build in the branch build fo your project. And your konnector can now be installed using the following url : git://github.com/konnectors/cozy-konnector- .git#build","title":"Build (without Travis)"},{"location":"/cozy-konnector-libs/dev/#build-using-travis-ci","text":"This project contains a .travis.yml config file which allows you to build your connector automatically using [Travis-CI][travis]. You can follow these steps to enable building using Travis: On your [travis-ci.org][travis] account, find your project name (should be the same than your Github repository) and enable Travis by using the related checkbox. Once enabled, go to this project on Travis by clicking on it and go to the Settings menu by using the More options menu at the top right. Enable these three options: Build only if .travis.yml is present Build branch updates (run Travis after each branch update) Build pull request updates (run Travis after each Pull Request update) Then, you have to generate a Github token in your Github account settings . Here is the Github blog post about API token . Don t forget to authorize the access to the repo scope like following: Then, add an environment variable (still in your Travis project settings) named GITHUB_TOKEN and use your previous generated Github token as value (We highly recommand you to keep the checkbox Display value in build log to OFF value in order to keep your token value hidden in the Travis logs.) Now Travis is ready to build your project, it should build it each time your push a commit in your repository or create a pull request. Note: Travis will push your build to your build branch ONLY for commits made on your master branch (included PR merge commits). You can see the related Travis statement here .","title":"Build using Travis CI"},{"location":"/cozy-konnector-libs/dev/#add-your-new-connector-to-cozy-collect","text":"The Cozy Collect application will soon use an application store as source of connectors. But for now, if you want to add your new connector to Cozy Collect, you can submit a message in the forum in the collect section , and we will handle this for you.","title":"Add your new connector to Cozy Collect"},{"location":"/cozy-konnector-libs/errors/","text":"Communication with the outside Konnectors communicate with the stack via its stdout. Each line is parsed by the stack as JSON. When an error is thrown by the konnector, it is catched and translated to JSON. Message types This is the list of error codes that your konnector can throw and which will be translated by the collect application. Example : const login = function () { throw new Error('LOGIN_FAILED') } Collect will then signal to the user that the credentials used are not correct. Error code Meaning LOGIN_OK The konnector has logged in LOGIN_FAILED The konnector could not login NOT_EXISTING_DIRECTORY The folder specified as folder_to_save does not exist (checked by BaseKonnector) VENDOR_DOWN The vendor s website is down USER_ACTION_NEEDED The user needs to go to the vendor s website to fix something UNKNOWN_ERROR There was an unexpected error, please take a look at the logs to know what happened Sentry If process.env.SENTRY_DSN is set : Raven will be configured to send exception to this address the BaseKonnector will have its run method wrapped into a Raven.context so that when it fails, it sends the exception to Raven before exiting. The idea being that the process.env.SENTRY_DSN is only set up for people having opted in for exception handling. Self-hosted instances of the cozy-stack will be free to use or not our SENTRY_DSN.","title":"Errors"},{"location":"/cozy-konnector-libs/errors/#communication-with-the-outside","text":"Konnectors communicate with the stack via its stdout. Each line is parsed by the stack as JSON. When an error is thrown by the konnector, it is catched and translated to JSON.","title":"Communication with the outside"},{"location":"/cozy-konnector-libs/errors/#message-types","text":"This is the list of error codes that your konnector can throw and which will be translated by the collect application. Example : const login = function () { throw new Error('LOGIN_FAILED') } Collect will then signal to the user that the credentials used are not correct. Error code Meaning LOGIN_OK The konnector has logged in LOGIN_FAILED The konnector could not login NOT_EXISTING_DIRECTORY The folder specified as folder_to_save does not exist (checked by BaseKonnector) VENDOR_DOWN The vendor s website is down USER_ACTION_NEEDED The user needs to go to the vendor s website to fix something UNKNOWN_ERROR There was an unexpected error, please take a look at the logs to know what happened","title":"Message types"},{"location":"/cozy-konnector-libs/errors/#sentry","text":"If process.env.SENTRY_DSN is set : Raven will be configured to send exception to this address the BaseKonnector will have its run method wrapped into a Raven.context so that when it fails, it sends the exception to Raven before exiting. The idea being that the process.env.SENTRY_DSN is only set up for people having opted in for exception handling. Self-hosted instances of the cozy-stack will be free to use or not our SENTRY_DSN.","title":"Sentry"},{"location":"/cozy-konnector-libs/operation-linking/","text":"Linking bank operations When bills are saved via saveBills, we try to find a bank operation that matches it. Criterias for matching : Label : the label of the operation must match an identifier provided in the konnector For example, for SFR mobile, the identifiers that we try to find in the label is sfr mobile . For SFR box, we try to find sfr fixe and sfr adsl . We try to find without the case. Date : the date of the banking operation must be +- 15 days of the bill Amount : the amount of the banking operation must be +-0.001 of the original bill amount Those criterias can be changed by the konnector themselves.","title":"Operation linking"},{"location":"/cozy-konnector-libs/operation-linking/#linking-bank-operations","text":"When bills are saved via saveBills, we try to find a bank operation that matches it. Criterias for matching : Label : the label of the operation must match an identifier provided in the konnector For example, for SFR mobile, the identifiers that we try to find in the label is sfr mobile . For SFR box, we try to find sfr fixe and sfr adsl . We try to find without the case. Date : the date of the banking operation must be +- 15 days of the bill Amount : the amount of the banking operation must be +-0.001 of the original bill amount Those criterias can be changed by the konnector themselves.","title":"Linking bank operations"},{"location":"/cozy-konnector-libs/synchronization/","text":"Table of contents Konnector synchronisation data and options Problems Current usage Objectives of this document Storing synchronization data in documents Simple case, by id By multiple attributes By custom method Saving document based on synchronization strategy Adding synchronization data Filtering entries Synchronization strategy findLegacyDocument getSyncData Array Example function Example konnector shouldSave shouldUpdate Whole example Konnector synchronisation data and options Problems Except bank konnectors which are already solving the addressed problem, all konnectors are currently processing data they are collecting in the same way: Get all data to synchronize Store it in CouchDB, even if it means overriding previously synchronized data. This process has at least two major flows : We are always synchronizing all the data provided by the external service. When something is modified (for example, the name of the stored file, it s almost sure that the previous one will be kept and that we ll have a duplicate) Another side effect could be that in a very large set of documents to synchronize, the whole process may take more than 3 minutes and never synchronize documents at the end of the list. Current usage When saving bills, cozy-konnector-libs provides a filtering and hydratation mechanism, to avoid overriding existing bills. It is done in function hydrateAndFilters . This method performs two actions : hydrate entries retrieved from service with usable data from couchDB (like existing bill id) filter entries retrieved from service and return only entries that need to be saved/synchronized. Objectives of this document The goals of this document are: Define a common way to store synchronization data for all konnector Propose a naive implementation for an abstract synchronisation data storing mechanism, provided by cozy-konnector-libs Propose a solution to synchronize every type of data or file, not only bills Taking the hydrateAndFilter function as basis, split it in three functions performing the following tasks : actual filtering, synchronization data hydratation and saving/updating current database document with correspondig external entries (the part done by the actual hydratation ) Storing synchronization data in documents Before saving any data or file, we will add in the relying document every synchronization data we will need. The added data will depend on how the service the konnector connects to retrieve entries and which information they gave us. Simple case, by id We suppose that in the most cases, we will face to entries provinding their own id attribute. The idea is to store it as synchronization data to be able to easily retrieve them later. To store synchronization data, we are using a sync attribute in document metadata attribute. Example: { metadata : { sync : { id : 7ee401e841c94159addb47f190903139 , konnector : trainline , last_sync : Mon, 12 Feb 2018 16:25:34 GMT } } } The expected information to be save is: field role id The id of the document, but given by the external service. If the external service does not provide any id or uuid, it could be interesting to generate one, with an hash of the file for example. konnector The slug of the konnector (Example: trainline , freemobile , cic ). This could be very useful to retrieve data synchronized with this konnector. last_sync Date of last synchronization, set to now() when storage is made. By multiple attributes If the external service does not provide any id attribute, we may need to use instead a list of attributes, for example firstname , lastname , dateofbirth . { metadata : { sync : { firstname : Claude , lastname : Causi , dateofbirth : 06/12/1980 } } } As we cannot be sure that we will have different data, it could be better to use a custom way of providing an unique identifier. By custom method When the external service does not provide any identifier, we have to use a custom method to generate one. It could be for example the filename or a hash generated with the document content. { metadata : { sync : { id: : customhash34FED5465645ABF54656FCB } } } Saving document based on synchronization strategy To solve the synchronization process weed need to: be able to add synchronization data on any type of document be able to compare external entries to current database state * provide a default implementation while letting the contributors to define their own ones Adding synchronization data We should provide an addSyncData function could, which look like this (naive implementation, this piece of code needs to be improved to handle cases where synchronizationStrategy.idAttribute is an array or a function): const addSyncData = (document, entry, synchronizationStrategy) = { return { ...document, metadata: { ...document.metadata, id: entry[synchronizationStrategy.idAttribute] } } ```` Where `document` is the future document to save, `entry` the corresponding external entry, and `synchronizationStrategy` and object defining the synchronization properties and methods (see below). ### Filtering entries Now we have saved our documents in database with consistent synchronization metadata, we need to provide a way to filter external entries. We should provide a `filterEntriesToSynchronize` which returns a list of entries with new data or data to update. As `addSyncData`, this method will receive a `synchronizationStrategy`. The filtering algorithm should be based on the returned value of `synchronizationStrategy.shouldSave` and `synchronizationStrategy.shouldUpdate`. \u26a0\ufe0f As the `synchronizationStrategy.shouldSave` and `synchronizationStrategy.shouldUpdate` will be asynchronous methods, `filterEntriesToSynchronize` should also be asynchronous. A naive example of `filterEntriesToSynchronize` implementation should be: ```js const filterEntriesToSynchronize = async (cozy, entries, synchronizationStrategy) = { const filtered = [] // getExistingSynchronizedDocument needs to be implemented, it should retrieve // existing document from database, based on synchronization data. const existingDocument = cozy.getExistingSynchronizedDocument(entry, synchronizationStrategy) entries.forEach(entry = { const toSave = await synchronizationStrategy.shouldSave(entry, existingDocument) const toUpdate = await synchronizationStrategy.shouldUpdate(entry, existingDocument) if (toSave || toUpdate) filtered.push(entry) }) return filtered } Synchronization strategy For our functions or methods dealing with synchronization, we pass a synchronizationStrategy object. Internally, we will use a default one but let the ability to contributors to pass their own ones. It is a simple object containing the following properties: Option Role disableSyncData (boolean) Disable storage of synchronization data. Default: false findLegacyDocument (function) Custom function which a konnector may use to look for a legacy document. Default is null . See below for more details. getSyncData (function) A mapping method returning additional synchronization data which have to be added to the document. idAttribute (string Array function) How the identifier attribute is named in the entry. Default value: id . See below for additional customization konnector Mandatory (string) The slug (or better, an uuid) of the current konnector. shouldSave (function) A method taking current entry and matching document in database to evaluate if an entry has to be saved in database. See below default method and customization. shouldUpdate (function) A method taking current entry and matching document in database to evaluate if a document must be updated with current entry. See below for default method and customization. findLegacyDocument If a document has not been saved yet with actual synchronization data, we will have no way to retrieve it, except by providing a findLegacyDocument function to saveEntry options. This signature of a findLegacyDocument function is: async function (entry, cozy) = { /* look for your document */ } ```` The `cozy` parameter is an instance of Cozy-Client. The idea is for example to retrive a document by its file path or any other accurate information. ### getSyncData This method returns any addtional synchronization data the konnector should need. Default method should be something returning an empty object or `null`. ```js (entry) = ({}) A konnector should provide its own method: { getSyncData: (entry) = ({ filename: entry.name }) }``` ### idAttribute #### String Name of the id attribute in entry. Default is `id`. If we want to use another name, we may use: ```js saveFiles(files, {idAttribute: 'uuid'}) Array This attribute may also be an array of string, defining each entry attribute which must be used for identifier. Example saveFiles(files, {idAttribute: ['name', 'author', 'date']}) In this case, all fields are used in synchronization data. function When an entry does not provide an unique identifer, it is possible to use a function as idAttribute to customize the way the unique identifer is generated. Example addData(file, {idAttribute: (entry) = hash(entry)}) // hash() is a custom method hashing the current file. konnector The konnector attribute is used as a key reference to retrieve all document synchronized by this konnector. For now, the konnector option will be needed for every call. But it could be interesting to initialize some kind of runner with it, which may encapsulate all the cozy-konnector-libs functions. shouldSave The shouldSave function returns a boolean which indicate if the entry should be saved. The default method should be: async function shouldSave (entry, existingDocument, cozy) = { return Promise.resolve(!existingDocument) } When calling this function, it is assumed that cozy-konnector-libs first queries the database for an exisring document, based on synchronization data and pass the document resulting the query to the shouldSave function, event if this document is null . We pass the whole document, and not only synchronization data, to let the contributors free on their way they are determining it a document should be saved. As a third parameter, a cozyClient instance is passed, it may be used by a konnector to perform another query. Because of this third parameter, the whole shouldSave method is asynchronous. shouldUpdate The shouldUpdate function acts exactly like shouldSave , except that it is used to determine if a document should be updated. By default, we make the choice to never update a document (except if it does not have synchronization data, see findLegacyDocument above). But some konnectors like Linxo related ones need to update existing documents. The default method is: async function shouldUpdate (entry, existingDocument, cozy) { // Update an existing document only if it does not have synchronization data const hasSyncData = !!existingDocument !!existingDocument.metadata !! existingDocument.metadata.sync return Promise.resolve(!hasSyncData) } ```` ## Whole example As the way data are saved from `cozy-konnector-libs` differs based on data type, we let the saving mechanism to others functions or methods. For example, in existing codebase, bills are saved in a specific way, resulting in two documents in database. However, we could provide top-level functions or methods, like `synchronizeBills` or a more generic `synchronizeData`. Here is a whole and naive example of how `synchronizeBills` could be implemebted: ```js const synchronizeBills = async (cozy, entries, synchronizationStrategy) = { return await filteredEntries = await filterEntriesToSynchronize(cozy, entries, synchronizationStrategy) .then(filteredEntries = filteredEntries.map(entry = addSyncData(entry, synchronizationStrategy))) // existing saveBills method (with maybe some little changes) .saveBills(synchronizedDocuments) } Usage could be: synchronizeBills(cozy, entries, { findLegacyDocument: (entry, cozy) = { return cozy.files.statByPath(getEntryPath(entry)) }, getSyncData: (file) = ({ fileName: file.name }), idAttribute: 'uuid', konnector: 'myservice', shouldSave: (file) = { // For whatever reason we only save files created after 2010 return Promise.resolve(moment(file.creationDate).year().isAfter(2010)) }, shouldUpdate: (file, existingDocument) = { const hasBeenModified = moment(file.modificationDate).isAfter(existingDocument.metadata.sync.last_sync) return Promise.resolve(hasBeenModified) } }) Every synchronized document will contain: { metadata : { sync : { konnector : myservice , id : entry_id , last_sync : now , fileName : fileName } } }","title":"Synchronization"},{"location":"/cozy-konnector-libs/synchronization/#table-of-contents","text":"Konnector synchronisation data and options Problems Current usage Objectives of this document Storing synchronization data in documents Simple case, by id By multiple attributes By custom method Saving document based on synchronization strategy Adding synchronization data Filtering entries Synchronization strategy findLegacyDocument getSyncData Array Example function Example konnector shouldSave shouldUpdate Whole example","title":"Table of contents"},{"location":"/cozy-konnector-libs/synchronization/#konnector-synchronisation-data-and-options","text":"","title":"Konnector synchronisation data and options"},{"location":"/cozy-konnector-libs/synchronization/#problems","text":"Except bank konnectors which are already solving the addressed problem, all konnectors are currently processing data they are collecting in the same way: Get all data to synchronize Store it in CouchDB, even if it means overriding previously synchronized data. This process has at least two major flows : We are always synchronizing all the data provided by the external service. When something is modified (for example, the name of the stored file, it s almost sure that the previous one will be kept and that we ll have a duplicate) Another side effect could be that in a very large set of documents to synchronize, the whole process may take more than 3 minutes and never synchronize documents at the end of the list.","title":"Problems"},{"location":"/cozy-konnector-libs/synchronization/#current-usage","text":"When saving bills, cozy-konnector-libs provides a filtering and hydratation mechanism, to avoid overriding existing bills. It is done in function hydrateAndFilters . This method performs two actions : hydrate entries retrieved from service with usable data from couchDB (like existing bill id) filter entries retrieved from service and return only entries that need to be saved/synchronized.","title":"Current usage"},{"location":"/cozy-konnector-libs/synchronization/#objectives-of-this-document","text":"The goals of this document are: Define a common way to store synchronization data for all konnector Propose a naive implementation for an abstract synchronisation data storing mechanism, provided by cozy-konnector-libs Propose a solution to synchronize every type of data or file, not only bills Taking the hydrateAndFilter function as basis, split it in three functions performing the following tasks : actual filtering, synchronization data hydratation and saving/updating current database document with correspondig external entries (the part done by the actual hydratation )","title":"Objectives of this document"},{"location":"/cozy-konnector-libs/synchronization/#storing-synchronization-data-in-documents","text":"Before saving any data or file, we will add in the relying document every synchronization data we will need. The added data will depend on how the service the konnector connects to retrieve entries and which information they gave us.","title":"Storing synchronization data in documents"},{"location":"/cozy-konnector-libs/synchronization/#simple-case-by-id","text":"We suppose that in the most cases, we will face to entries provinding their own id attribute. The idea is to store it as synchronization data to be able to easily retrieve them later. To store synchronization data, we are using a sync attribute in document metadata attribute. Example: { metadata : { sync : { id : 7ee401e841c94159addb47f190903139 , konnector : trainline , last_sync : Mon, 12 Feb 2018 16:25:34 GMT } } } The expected information to be save is: field role id The id of the document, but given by the external service. If the external service does not provide any id or uuid, it could be interesting to generate one, with an hash of the file for example. konnector The slug of the konnector (Example: trainline , freemobile , cic ). This could be very useful to retrieve data synchronized with this konnector. last_sync Date of last synchronization, set to now() when storage is made.","title":"Simple case, by id"},{"location":"/cozy-konnector-libs/synchronization/#by-multiple-attributes","text":"If the external service does not provide any id attribute, we may need to use instead a list of attributes, for example firstname , lastname , dateofbirth . { metadata : { sync : { firstname : Claude , lastname : Causi , dateofbirth : 06/12/1980 } } } As we cannot be sure that we will have different data, it could be better to use a custom way of providing an unique identifier.","title":"By multiple attributes"},{"location":"/cozy-konnector-libs/synchronization/#by-custom-method","text":"When the external service does not provide any identifier, we have to use a custom method to generate one. It could be for example the filename or a hash generated with the document content. { metadata : { sync : { id: : customhash34FED5465645ABF54656FCB } } }","title":"By custom method"},{"location":"/cozy-konnector-libs/synchronization/#saving-document-based-on-synchronization-strategy","text":"To solve the synchronization process weed need to: be able to add synchronization data on any type of document be able to compare external entries to current database state * provide a default implementation while letting the contributors to define their own ones","title":"Saving document based on synchronization strategy"},{"location":"/cozy-konnector-libs/synchronization/#adding-synchronization-data","text":"We should provide an addSyncData function could, which look like this (naive implementation, this piece of code needs to be improved to handle cases where synchronizationStrategy.idAttribute is an array or a function): const addSyncData = (document, entry, synchronizationStrategy) = { return { ...document, metadata: { ...document.metadata, id: entry[synchronizationStrategy.idAttribute] } } ```` Where `document` is the future document to save, `entry` the corresponding external entry, and `synchronizationStrategy` and object defining the synchronization properties and methods (see below). ### Filtering entries Now we have saved our documents in database with consistent synchronization metadata, we need to provide a way to filter external entries. We should provide a `filterEntriesToSynchronize` which returns a list of entries with new data or data to update. As `addSyncData`, this method will receive a `synchronizationStrategy`. The filtering algorithm should be based on the returned value of `synchronizationStrategy.shouldSave` and `synchronizationStrategy.shouldUpdate`. \u26a0\ufe0f As the `synchronizationStrategy.shouldSave` and `synchronizationStrategy.shouldUpdate` will be asynchronous methods, `filterEntriesToSynchronize` should also be asynchronous. A naive example of `filterEntriesToSynchronize` implementation should be: ```js const filterEntriesToSynchronize = async (cozy, entries, synchronizationStrategy) = { const filtered = [] // getExistingSynchronizedDocument needs to be implemented, it should retrieve // existing document from database, based on synchronization data. const existingDocument = cozy.getExistingSynchronizedDocument(entry, synchronizationStrategy) entries.forEach(entry = { const toSave = await synchronizationStrategy.shouldSave(entry, existingDocument) const toUpdate = await synchronizationStrategy.shouldUpdate(entry, existingDocument) if (toSave || toUpdate) filtered.push(entry) }) return filtered }","title":"Adding synchronization data"},{"location":"/cozy-konnector-libs/synchronization/#synchronization-strategy","text":"For our functions or methods dealing with synchronization, we pass a synchronizationStrategy object. Internally, we will use a default one but let the ability to contributors to pass their own ones. It is a simple object containing the following properties: Option Role disableSyncData (boolean) Disable storage of synchronization data. Default: false findLegacyDocument (function) Custom function which a konnector may use to look for a legacy document. Default is null . See below for more details. getSyncData (function) A mapping method returning additional synchronization data which have to be added to the document. idAttribute (string Array function) How the identifier attribute is named in the entry. Default value: id . See below for additional customization konnector Mandatory (string) The slug (or better, an uuid) of the current konnector. shouldSave (function) A method taking current entry and matching document in database to evaluate if an entry has to be saved in database. See below default method and customization. shouldUpdate (function) A method taking current entry and matching document in database to evaluate if a document must be updated with current entry. See below for default method and customization.","title":"Synchronization strategy"},{"location":"/cozy-konnector-libs/synchronization/#findlegacydocument","text":"If a document has not been saved yet with actual synchronization data, we will have no way to retrieve it, except by providing a findLegacyDocument function to saveEntry options. This signature of a findLegacyDocument function is: async function (entry, cozy) = { /* look for your document */ } ```` The `cozy` parameter is an instance of Cozy-Client. The idea is for example to retrive a document by its file path or any other accurate information. ### getSyncData This method returns any addtional synchronization data the konnector should need. Default method should be something returning an empty object or `null`. ```js (entry) = ({}) A konnector should provide its own method: { getSyncData: (entry) = ({ filename: entry.name }) }``` ### idAttribute #### String Name of the id attribute in entry. Default is `id`. If we want to use another name, we may use: ```js saveFiles(files, {idAttribute: 'uuid'})","title":"findLegacyDocument"},{"location":"/cozy-konnector-libs/synchronization/#array","text":"This attribute may also be an array of string, defining each entry attribute which must be used for identifier.","title":"Array"},{"location":"/cozy-konnector-libs/synchronization/#example","text":"saveFiles(files, {idAttribute: ['name', 'author', 'date']}) In this case, all fields are used in synchronization data.","title":"Example"},{"location":"/cozy-konnector-libs/synchronization/#function","text":"When an entry does not provide an unique identifer, it is possible to use a function as idAttribute to customize the way the unique identifer is generated.","title":"function"},{"location":"/cozy-konnector-libs/synchronization/#example_1","text":"addData(file, {idAttribute: (entry) = hash(entry)}) // hash() is a custom method hashing the current file.","title":"Example"},{"location":"/cozy-konnector-libs/synchronization/#konnector","text":"The konnector attribute is used as a key reference to retrieve all document synchronized by this konnector. For now, the konnector option will be needed for every call. But it could be interesting to initialize some kind of runner with it, which may encapsulate all the cozy-konnector-libs functions.","title":"konnector"},{"location":"/cozy-konnector-libs/synchronization/#shouldsave","text":"The shouldSave function returns a boolean which indicate if the entry should be saved. The default method should be: async function shouldSave (entry, existingDocument, cozy) = { return Promise.resolve(!existingDocument) } When calling this function, it is assumed that cozy-konnector-libs first queries the database for an exisring document, based on synchronization data and pass the document resulting the query to the shouldSave function, event if this document is null . We pass the whole document, and not only synchronization data, to let the contributors free on their way they are determining it a document should be saved. As a third parameter, a cozyClient instance is passed, it may be used by a konnector to perform another query. Because of this third parameter, the whole shouldSave method is asynchronous.","title":"shouldSave"},{"location":"/cozy-konnector-libs/synchronization/#shouldupdate","text":"The shouldUpdate function acts exactly like shouldSave , except that it is used to determine if a document should be updated. By default, we make the choice to never update a document (except if it does not have synchronization data, see findLegacyDocument above). But some konnectors like Linxo related ones need to update existing documents. The default method is: async function shouldUpdate (entry, existingDocument, cozy) { // Update an existing document only if it does not have synchronization data const hasSyncData = !!existingDocument !!existingDocument.metadata !! existingDocument.metadata.sync return Promise.resolve(!hasSyncData) } ```` ## Whole example As the way data are saved from `cozy-konnector-libs` differs based on data type, we let the saving mechanism to others functions or methods. For example, in existing codebase, bills are saved in a specific way, resulting in two documents in database. However, we could provide top-level functions or methods, like `synchronizeBills` or a more generic `synchronizeData`. Here is a whole and naive example of how `synchronizeBills` could be implemebted: ```js const synchronizeBills = async (cozy, entries, synchronizationStrategy) = { return await filteredEntries = await filterEntriesToSynchronize(cozy, entries, synchronizationStrategy) .then(filteredEntries = filteredEntries.map(entry = addSyncData(entry, synchronizationStrategy))) // existing saveBills method (with maybe some little changes) .saveBills(synchronizedDocuments) } Usage could be: synchronizeBills(cozy, entries, { findLegacyDocument: (entry, cozy) = { return cozy.files.statByPath(getEntryPath(entry)) }, getSyncData: (file) = ({ fileName: file.name }), idAttribute: 'uuid', konnector: 'myservice', shouldSave: (file) = { // For whatever reason we only save files created after 2010 return Promise.resolve(moment(file.creationDate).year().isAfter(2010)) }, shouldUpdate: (file, existingDocument) = { const hasBeenModified = moment(file.modificationDate).isAfter(existingDocument.metadata.sync.last_sync) return Promise.resolve(hasBeenModified) } }) Every synchronized document will contain: { metadata : { sync : { konnector : myservice , id : entry_id , last_sync : now , fileName : fileName } } }","title":"shouldUpdate"},{"location":"/cozy-doctypes/docs/io.cozy.accounts/","text":"Table of contents Cozy Accounts doctype The io.cozy.accounts doctype stores authentification informations used by konnectors to connect to external services or API. Accounts can be managed in Cozy-Collect . They are generally associated to a io.cozy.triggers document. io.cozy.accounts attributes are: account_type ( deprecated ) : {string} Slug of the konnector the account is related to. auth : {object} Contains authentification data, typically a couple with login / password . It could also contain an attribute token for OAuth konnectors. data : {object} Additional custom data. label : {string} Label given by user. auth The auth attribute may also contain other data, like accountName , folderPath or frequency . As auth should only be used for authentication mechanisms, those two values should disappear soon. folderPath should purely and simply disappear, the folder information is stored in io.cozy.trigger . accountName is in reality the label , change should be made soon to fix this mistake. frequency should move at the root of the account. About login Some konnectors does not use a login parameter, but identifier or email . The usage of anything except login is deprecated and should not be done. Examples Freemobile (regular connector, with current deprecation) { auth : { accountName : freemobile , credentials_encrypted : aaDtwWSWsdpbbbbbbbbbbbbbbOzp2pBEbXlZLWjiTzOGumGRomrF2LwlRn4Y8c= , folderPath : /Administratif/Free Mobile , login : 000000000 , namePath : Free Mobile , password : ******* } } What we aim: { auth : { credentials_encrypted : aaDtwWSWsdpbbbbbbbbbbbbbbOzp2pBEbXlZLWjiTzOGumGRomrF2LwlRn4Y8c= , login : 000000000 , password : ********** }, folderPath : /Administratif/Free Mobile , label : freemobile , namePath : Free Mobile } Caisse d \u00c9pargne (Linxo connector) The connectors based on Linxo API are storing specific informations into data attribute. { account_type : linxo , auth : { folderPath : null, frequency : week , identifier : 0000000000 , secret : ********* }, data : { auth : { login : 00000.00000000@cozyclaudy.red.cloud , password : ******************************** }, status : connected , token : f415e , uuid : deadbeef-912e-4ba8-9378-067c5c3e4f54 } }","title":"Accounts"},{"location":"/cozy-doctypes/docs/io.cozy.accounts/#cozy-accounts-doctype","text":"The io.cozy.accounts doctype stores authentification informations used by konnectors to connect to external services or API. Accounts can be managed in Cozy-Collect . They are generally associated to a io.cozy.triggers document. io.cozy.accounts attributes are: account_type ( deprecated ) : {string} Slug of the konnector the account is related to. auth : {object} Contains authentification data, typically a couple with login / password . It could also contain an attribute token for OAuth konnectors. data : {object} Additional custom data. label : {string} Label given by user.","title":"Cozy Accounts doctype"},{"location":"/cozy-doctypes/docs/io.cozy.accounts/#auth","text":"The auth attribute may also contain other data, like accountName , folderPath or frequency . As auth should only be used for authentication mechanisms, those two values should disappear soon. folderPath should purely and simply disappear, the folder information is stored in io.cozy.trigger . accountName is in reality the label , change should be made soon to fix this mistake. frequency should move at the root of the account.","title":"auth"},{"location":"/cozy-doctypes/docs/io.cozy.accounts/#about-login","text":"Some konnectors does not use a login parameter, but identifier or email . The usage of anything except login is deprecated and should not be done.","title":"About login"},{"location":"/cozy-doctypes/docs/io.cozy.accounts/#examples","text":"","title":"Examples"},{"location":"/cozy-doctypes/docs/io.cozy.accounts/#freemobile-regular-connector-with-current-deprecation","text":"{ auth : { accountName : freemobile , credentials_encrypted : aaDtwWSWsdpbbbbbbbbbbbbbbOzp2pBEbXlZLWjiTzOGumGRomrF2LwlRn4Y8c= , folderPath : /Administratif/Free Mobile , login : 000000000 , namePath : Free Mobile , password : ******* } } What we aim: { auth : { credentials_encrypted : aaDtwWSWsdpbbbbbbbbbbbbbbOzp2pBEbXlZLWjiTzOGumGRomrF2LwlRn4Y8c= , login : 000000000 , password : ********** }, folderPath : /Administratif/Free Mobile , label : freemobile , namePath : Free Mobile }","title":"Freemobile (regular connector, with current deprecation)"},{"location":"/cozy-doctypes/docs/io.cozy.accounts/#caisse-depargne-linxo-connector","text":"The connectors based on Linxo API are storing specific informations into data attribute. { account_type : linxo , auth : { folderPath : null, frequency : week , identifier : 0000000000 , secret : ********* }, data : { auth : { login : 00000.00000000@cozyclaudy.red.cloud , password : ******************************** }, status : connected , token : f415e , uuid : deadbeef-912e-4ba8-9378-067c5c3e4f54 } }","title":"Caisse d'\u00c9pargne (Linxo connector)"},{"location":"/cozy-doctypes/docs/io.cozy.photos.albums/","text":"Table of contents Photos Albums doctype io.cozy.photos.albums This doctype is really simple. It just has one attribute: name : {string} the name of the album The photos in an album are files (with the class image ) that are referenced by the album document.","title":"Albums"},{"location":"/cozy-doctypes/docs/io.cozy.photos.albums/#photos-albums-doctype","text":"","title":"Photos Albums doctype"},{"location":"/cozy-doctypes/docs/io.cozy.photos.albums/#iocozyphotosalbums","text":"This doctype is really simple. It just has one attribute: name : {string} the name of the album The photos in an album are files (with the class image ) that are referenced by the album document.","title":"io.cozy.photos.albums"},{"location":"/cozy-doctypes/docs/io.cozy.bank/","text":"Table of contents Cozy Bank doctypes Cozy can stores and manipulate bank related datas, distributed across several doctypes. io.cozy.bank.settings This doctype store informations about Bank application settings. There is only one document, by default: { notifications: { amountMax: { enable: false, value: 30 } } } io.cozy.bank.accounts This doctypes stores informations about a Bank account: label : {string} - The bank account label (e.g. John Doe Bank Account ) institutionLabel : {string} - The financial institution name the bank account belongs to balance : {number} - The current account balance type : {string} - The account type in the list ['none', 'bank', 'cash', 'asset', 'credit card', 'liability'] number : {string} - The bank account number in its institution iban : {string} - The bank account international identifier serviceID : {number} - In case of external service used to import transactions, this key can stores the service s account ID; can be undefined is the account isn t managed by any external service Example { _id : 2165d9a310deadbeeffc08d54c45102 , balance : 1337.73, institutionLabel : Soci\u00e9t\u00e9 G\u00e9n\u00e9rale (Particuliers) , label : Livret D\u00e9velop. Durable (x1337) , linxoId : 123456 , metadata : { version : 1 }, number : 03791 00048085818 , shortLabel : Livret D\u00e9velop. Durable , type : Savings } io.cozy.bank.operations This doctype stors informations about a bank transaction: label : {string} - The label describing the transaction type : {string} - A type in the list : ['none', 'credit card', 'cash', 'check', 'transfer', 'internal transfer', 'debit card', 'deposit', 'financial fee', 'direct debit'] date : {date} - The date the transaction is emmited dateOperation : {date} - The date the transaction is registered in the account dateImport : {date} - The date the transaction is imported (can differ of the date of creation of the document as the import can be done by an external service) amount : {number} - The amount of the transaction currency : {string} - A 3 uppercased chars defining the currecny used for the transaction as stated in ISO4217 manualCategoryId : {string} - A category that apply to the transaction and is manually selected by the user cozyCategoryId : {string} - A category found by Cozy cozyCategoryProba : {number} - The probability of Cozy category automaticCategoryId : {string} - A category that apply to the transaction and is automatically calculated account : {identifier} - The related account id the transaction belongs to bills : {array[ ]} - List of bills id. reimbursements : {array[ ]} - List of bills id. creditOperations : {array[ ]} - List of credit operations id debitOperations : {array[ ]} - List of debit operations id parent : {_id} - In case of a split transaction, the one refers the global transaction the split one belongs to For the dates, any string or integer which can be interpreted by new Date(date) is possible but the best the result of Date.toString() - like Fri Mar 09 2018 19:04:40 GMT+0100 (CET) which contains the time zones. Example { _id : f0426fdeadbeef55755ee7f4d6555 , account : 15fb6402426bcdeadbeeffd5f4587bb , amount : 10, automaticCategoryId : 400110 , currency : EUR , date : 2017-09-22 00:00:00+01:00 , dateOperation : null, label : M PIERRE RICHARD , linxoId : 845811337 , cozyCategoryId : 400110 , cozyCategoryProba : 0.9323, metadata : { dateImport : 2018-03-09T09:23:40.075Z , version : 1 }, originalBankLabel : VIR RECU 5383518660S DE: M PIERRE RICHARD J MOTIF: Cascade REF: NOT PROVIDED , type : transfer } io.cozy.bank.balancehistories This doctype stores a year of daily balances : year : {number} - The year of the balances balances : {object} - A day (YYYY-MM-DD format) / balance (number) map Relationships account : {object} - The associated account Example { _id : f1aacd3254509687c07e48279b42cd50 , year : 2018, balances : { 2018-01-01 : 8000, 2018-01-02 : 8000.42, 2018-01-03 : 1337 }, metadata : { version : 1 }, relationships : { account : { data : { _id : f1aacd3254509687c07e48279b42f3de , _type : io.cozy.bank.accounts } } } }","title":"Banking doctypes"},{"location":"/cozy-doctypes/docs/io.cozy.bank/#cozy-bank-doctypes","text":"Cozy can stores and manipulate bank related datas, distributed across several doctypes.","title":"Cozy Bank doctypes"},{"location":"/cozy-doctypes/docs/io.cozy.bank/#iocozybanksettings","text":"This doctype store informations about Bank application settings. There is only one document, by default: { notifications: { amountMax: { enable: false, value: 30 } } }","title":"io.cozy.bank.settings"},{"location":"/cozy-doctypes/docs/io.cozy.bank/#iocozybankaccounts","text":"This doctypes stores informations about a Bank account: label : {string} - The bank account label (e.g. John Doe Bank Account ) institutionLabel : {string} - The financial institution name the bank account belongs to balance : {number} - The current account balance type : {string} - The account type in the list ['none', 'bank', 'cash', 'asset', 'credit card', 'liability'] number : {string} - The bank account number in its institution iban : {string} - The bank account international identifier serviceID : {number} - In case of external service used to import transactions, this key can stores the service s account ID; can be undefined is the account isn t managed by any external service","title":"io.cozy.bank.accounts"},{"location":"/cozy-doctypes/docs/io.cozy.bank/#example","text":"{ _id : 2165d9a310deadbeeffc08d54c45102 , balance : 1337.73, institutionLabel : Soci\u00e9t\u00e9 G\u00e9n\u00e9rale (Particuliers) , label : Livret D\u00e9velop. Durable (x1337) , linxoId : 123456 , metadata : { version : 1 }, number : 03791 00048085818 , shortLabel : Livret D\u00e9velop. Durable , type : Savings }","title":"Example"},{"location":"/cozy-doctypes/docs/io.cozy.bank/#iocozybankoperations","text":"This doctype stors informations about a bank transaction: label : {string} - The label describing the transaction type : {string} - A type in the list : ['none', 'credit card', 'cash', 'check', 'transfer', 'internal transfer', 'debit card', 'deposit', 'financial fee', 'direct debit'] date : {date} - The date the transaction is emmited dateOperation : {date} - The date the transaction is registered in the account dateImport : {date} - The date the transaction is imported (can differ of the date of creation of the document as the import can be done by an external service) amount : {number} - The amount of the transaction currency : {string} - A 3 uppercased chars defining the currecny used for the transaction as stated in ISO4217 manualCategoryId : {string} - A category that apply to the transaction and is manually selected by the user cozyCategoryId : {string} - A category found by Cozy cozyCategoryProba : {number} - The probability of Cozy category automaticCategoryId : {string} - A category that apply to the transaction and is automatically calculated account : {identifier} - The related account id the transaction belongs to bills : {array[ ]} - List of bills id. reimbursements : {array[ ]} - List of bills id. creditOperations : {array[ ]} - List of credit operations id debitOperations : {array[ ]} - List of debit operations id parent : {_id} - In case of a split transaction, the one refers the global transaction the split one belongs to For the dates, any string or integer which can be interpreted by new Date(date) is possible but the best the result of Date.toString() - like Fri Mar 09 2018 19:04:40 GMT+0100 (CET) which contains the time zones.","title":"io.cozy.bank.operations"},{"location":"/cozy-doctypes/docs/io.cozy.bank/#example_1","text":"{ _id : f0426fdeadbeef55755ee7f4d6555 , account : 15fb6402426bcdeadbeeffd5f4587bb , amount : 10, automaticCategoryId : 400110 , currency : EUR , date : 2017-09-22 00:00:00+01:00 , dateOperation : null, label : M PIERRE RICHARD , linxoId : 845811337 , cozyCategoryId : 400110 , cozyCategoryProba : 0.9323, metadata : { dateImport : 2018-03-09T09:23:40.075Z , version : 1 }, originalBankLabel : VIR RECU 5383518660S DE: M PIERRE RICHARD J MOTIF: Cascade REF: NOT PROVIDED , type : transfer }","title":"Example"},{"location":"/cozy-doctypes/docs/io.cozy.bank/#iocozybankbalancehistories","text":"This doctype stores a year of daily balances : year : {number} - The year of the balances balances : {object} - A day (YYYY-MM-DD format) / balance (number) map","title":"io.cozy.bank.balancehistories"},{"location":"/cozy-doctypes/docs/io.cozy.bank/#relationships","text":"account : {object} - The associated account","title":"Relationships"},{"location":"/cozy-doctypes/docs/io.cozy.bank/#example_2","text":"{ _id : f1aacd3254509687c07e48279b42cd50 , year : 2018, balances : { 2018-01-01 : 8000, 2018-01-02 : 8000.42, 2018-01-03 : 1337 }, metadata : { version : 1 }, relationships : { account : { data : { _id : f1aacd3254509687c07e48279b42f3de , _type : io.cozy.bank.accounts } } } }","title":"Example"},{"location":"/cozy-doctypes/docs/io.cozy.bills/","text":"Table of contents Bills doctype io.cozy.bills Description Represents the a bill (invoice) or refund from a vendor. Mandatory attributes type : {string} - Type of the bill vendor : {string} - Vendor which issued the bill date : {date} - Date the bill was emitted, a string formated (what you get with a new Date().toString() ) amount : {number} - Amount of the bill, always positive even if it is a refund currency : the currency, must respects ISO standard : https://en.wikipedia.org/wiki/ISO_4217 Optionnal attributes (but some are important depending the context) isRefund : {boolean} - Indicate if the bill represents a refund/reimbursement subtype : {string} - Used for labelling the bill. ie: Ost\u00e9opathie originalDate - For health bills, represents the date of the health act (presumably the date the account was charged) originalAmount : {number} - Original amount in case of a partial refund groupAmount : Group amount in case this bill was part of a grouped refund thirdPartyRefund : {number} - Amount reimbursed to third parties socialSecurityRefund : {number} - Amount reimbursed to social security isThirdPartyPayer : {boolean} - Indicate if the bill has been already covered by a third party payer. This attribute can be useful when Cozy retrieves bills issued by french medical insurances. When this attribute is in true no associated debit is expected to be found in the client bank statements. invoice : {string} - The associated file. ex: io.cozy.files:c43645a93831827c7ec512eac3006e51 fileUrl : {string} - The url used to download the pdf from vendor. debitOperations : {array[io.cozy.bank.operations._id]} - List of debit operations id creditOperations : {array[io.cozy.bank.operations._id]} - List of credit operations id vendorRef : {string} - Vendor reference for this bill. Ex : 'INV-2018-09-12534'k Types health_costs : Health related bills phone : Phone related bills Some more attributes for reimbursement bills The are some more possible attributes for reimbursement bills. The original* attributes are there to help the connector to link this bills to their original debit operation. isRefund : {boolean} - Indicate if the bill represents a refund/reimbursement (defaults to false) subtype : {string} - Used for labelling the bill. ie: Ost\u00e9opathie (optionnal) originalAmount : {number} - Original amount in case of a partial refund originalDate - Represents the date of the associated spent (presumably the date the account was charged) Example { _id : 62e5d80d6e11d19992b7efce794263f0 , amount : 700, beneficiary : PIERRE RICHARD , date : 2018-02-07T23:00:00.000Z , groupAmount : 7.5, isRefund : true, metadata : { version : 1 }, originalAmount : 25, originalDate : 2018-03-11T23:00:00.000Z , socialSecurityRefund : 17.5, subtype : Consultation sp\u00e9cialiste , type : health_costs , vendor : Harmonie }","title":"Bills"},{"location":"/cozy-doctypes/docs/io.cozy.bills/#bills-doctype","text":"","title":"Bills doctype"},{"location":"/cozy-doctypes/docs/io.cozy.bills/#iocozybills","text":"","title":"io.cozy.bills"},{"location":"/cozy-doctypes/docs/io.cozy.bills/#description","text":"Represents the a bill (invoice) or refund from a vendor.","title":"Description"},{"location":"/cozy-doctypes/docs/io.cozy.bills/#mandatory-attributes","text":"type : {string} - Type of the bill vendor : {string} - Vendor which issued the bill date : {date} - Date the bill was emitted, a string formated (what you get with a new Date().toString() ) amount : {number} - Amount of the bill, always positive even if it is a refund currency : the currency, must respects ISO standard : https://en.wikipedia.org/wiki/ISO_4217","title":"Mandatory attributes"},{"location":"/cozy-doctypes/docs/io.cozy.bills/#optionnal-attributes-but-some-are-important-depending-the-context","text":"isRefund : {boolean} - Indicate if the bill represents a refund/reimbursement subtype : {string} - Used for labelling the bill. ie: Ost\u00e9opathie originalDate - For health bills, represents the date of the health act (presumably the date the account was charged) originalAmount : {number} - Original amount in case of a partial refund groupAmount : Group amount in case this bill was part of a grouped refund thirdPartyRefund : {number} - Amount reimbursed to third parties socialSecurityRefund : {number} - Amount reimbursed to social security isThirdPartyPayer : {boolean} - Indicate if the bill has been already covered by a third party payer. This attribute can be useful when Cozy retrieves bills issued by french medical insurances. When this attribute is in true no associated debit is expected to be found in the client bank statements. invoice : {string} - The associated file. ex: io.cozy.files:c43645a93831827c7ec512eac3006e51 fileUrl : {string} - The url used to download the pdf from vendor. debitOperations : {array[io.cozy.bank.operations._id]} - List of debit operations id creditOperations : {array[io.cozy.bank.operations._id]} - List of credit operations id vendorRef : {string} - Vendor reference for this bill. Ex : 'INV-2018-09-12534'k","title":"Optionnal attributes (but some are important depending the context)"},{"location":"/cozy-doctypes/docs/io.cozy.bills/#types","text":"health_costs : Health related bills phone : Phone related bills","title":"Types"},{"location":"/cozy-doctypes/docs/io.cozy.bills/#some-more-attributes-for-reimbursement-bills","text":"The are some more possible attributes for reimbursement bills. The original* attributes are there to help the connector to link this bills to their original debit operation. isRefund : {boolean} - Indicate if the bill represents a refund/reimbursement (defaults to false) subtype : {string} - Used for labelling the bill. ie: Ost\u00e9opathie (optionnal) originalAmount : {number} - Original amount in case of a partial refund originalDate - Represents the date of the associated spent (presumably the date the account was charged)","title":"Some more attributes for reimbursement bills"},{"location":"/cozy-doctypes/docs/io.cozy.bills/#example","text":"{ _id : 62e5d80d6e11d19992b7efce794263f0 , amount : 700, beneficiary : PIERRE RICHARD , date : 2018-02-07T23:00:00.000Z , groupAmount : 7.5, isRefund : true, metadata : { version : 1 }, originalAmount : 25, originalDate : 2018-03-11T23:00:00.000Z , socialSecurityRefund : 17.5, subtype : Consultation sp\u00e9cialiste , type : health_costs , vendor : Harmonie }","title":"Example"},{"location":"/cozy-doctypes/docs/io.cozy.konnectors/","text":"Table of contents Konnectors doctype The io.cozy.konnectors doctype is used to store installed connectors. Connectors are autonomous applications ran on the stack to connect to external services or API. When installing a konnector, the Cozy stack creates a new io.cozy.konnector document from the fields in the manifest.konnector . See the reference for more information on each attributes. io.cozy.konnectors are used by Cozy-Store to install and uninstall connectors, and by Cozy-Collect to manage accounts for connectors Attributes Retrieved from manifest.konnector The available attributes in a io.cozy.konnectors document are : categories data_types developer doctypes editor fields frequency icon langs language license locales messages name name_prefix notifications oauth parameters permissions platforms screenshots slug source state tags time_interval type vendor_link version Other Attributes Attribute Role state Store the installation state of the konnector. Value can be AVAILABLE , INSTALLING , UPGRADING , UNINSTALLING , INSTALLED , READY Example { name : Debug , editor : , slug : debug , developer : { name : cozy , url : cozy.io }, long_description : , short_description : , categories : [ other ], locales : null, langs : null, tags : null, icon : , license : , state : ready , source : git://github.com/cozy/cozy-konnector-debug.git#build , parameters : null, version : 1.0.0-edf48da7b2d959517aea59767c3d8d45b2ce7fa2 , permissions : { accounts : { type : io.cozy.accounts , description : Required to get the account's data , verbs : [ GET ] } } }","title":"Connectors"},{"location":"/cozy-doctypes/docs/io.cozy.konnectors/#konnectors-doctype","text":"The io.cozy.konnectors doctype is used to store installed connectors. Connectors are autonomous applications ran on the stack to connect to external services or API. When installing a konnector, the Cozy stack creates a new io.cozy.konnector document from the fields in the manifest.konnector . See the reference for more information on each attributes. io.cozy.konnectors are used by Cozy-Store to install and uninstall connectors, and by Cozy-Collect to manage accounts for connectors","title":"Konnectors doctype"},{"location":"/cozy-doctypes/docs/io.cozy.konnectors/#attributes","text":"","title":"Attributes"},{"location":"/cozy-doctypes/docs/io.cozy.konnectors/#retrieved-from-manifestkonnector","text":"The available attributes in a io.cozy.konnectors document are : categories data_types developer doctypes editor fields frequency icon langs language license locales messages name name_prefix notifications oauth parameters permissions platforms screenshots slug source state tags time_interval type vendor_link version","title":"Retrieved from manifest.konnector"},{"location":"/cozy-doctypes/docs/io.cozy.konnectors/#other-attributes","text":"Attribute Role state Store the installation state of the konnector. Value can be AVAILABLE , INSTALLING , UPGRADING , UNINSTALLING , INSTALLED , READY","title":"Other Attributes"},{"location":"/cozy-doctypes/docs/io.cozy.konnectors/#example","text":"{ name : Debug , editor : , slug : debug , developer : { name : cozy , url : cozy.io }, long_description : , short_description : , categories : [ other ], locales : null, langs : null, tags : null, icon : , license : , state : ready , source : git://github.com/cozy/cozy-konnector-debug.git#build , parameters : null, version : 1.0.0-edf48da7b2d959517aea59767c3d8d45b2ce7fa2 , permissions : { accounts : { type : io.cozy.accounts , description : Required to get the account's data , verbs : [ GET ] } } }","title":"Example"},{"location":"/cozy-doctypes/docs/io.cozy.contacts/","text":"Table of contents Cozy Contacts doctype io.cozy.contacts The io.cozy.contacts doctype is loosely based on the vCard RFC , in that some of the attributes have been renamed for clarity. The attributes with a ? are optional. fullname? : {string} Unstructured representation of the name (example: \"Dr. Gregory House, M.D.\" ) name? : {object} Optional structured representation of the name, with the following possible attributes: familyName? : {string} (example: \"House\" ) givenName? : {string} (example: \"Gregory\" ) additionalName? : {string} (example: \"J.\" ) namePrefix? : {string} (example: \"Dr.\" ) nameSuffix? : {string} (example: \"III\" ) birthday? : {date} (example: \"1959-05-15\" ) note? : {string} email? : {array} An array of email addresses objects with the following attributes: address : {string} Email adress type? : {string} Programmatic type of email ( \"work\" , \"home\" , \"other\" ) label? : {string} A user-provided localized type of email (example: \"Work\" ) primary? : {boolean} Indicates a preferred-use address address? : {array} An array of postal addresses objects with the following attributes: street? : {string} pobox? : {string} city? : {string} region? : {string} postcode? : {string} country? : {string} type? : {string} Programmatic type of email ( \"work\" , \"home\" , \"other\" ) primary? : {boolean} Indicates a preferred-use address label? : {string} formattedAddress? : {string} Unstructured version of the address phone? : {array} An array of phone number objects with the following attributes: number : {string} type? : {string} Programmatic type of phone number ( \"work\" , \"home\" , \"mobile\" , \"fax\" , \"other\" ) label? : {string} A user-provided localized type of phone number (example: \"Work\" ) primary? : {boolean} Indicates a preferred-use number cozy? : {array} An array of cozy instances with the following attributes: url : {string} label? : {string} A user-provided localized type of instance primary? : {boolean} Indicates a preferred-use instance groups : {array} An array containing a list of ids of io.cozy.contacts.groups documents that this contact is part of metadata : {object} - version : {integer} Used for migrations. Current version is 1 io.cozy.contacts.groups Used to group contacts together. A group can obviously have multiple contacts, but contacts can also be part of multiple groups. name : {string} is the group s public name metadata : {object} - version : {integer} Used for migrations. Current version is 1","title":"Contacts"},{"location":"/cozy-doctypes/docs/io.cozy.contacts/#cozy-contacts-doctype","text":"","title":"Cozy Contacts doctype"},{"location":"/cozy-doctypes/docs/io.cozy.contacts/#iocozycontacts","text":"The io.cozy.contacts doctype is loosely based on the vCard RFC , in that some of the attributes have been renamed for clarity. The attributes with a ? are optional. fullname? : {string} Unstructured representation of the name (example: \"Dr. Gregory House, M.D.\" ) name? : {object} Optional structured representation of the name, with the following possible attributes: familyName? : {string} (example: \"House\" ) givenName? : {string} (example: \"Gregory\" ) additionalName? : {string} (example: \"J.\" ) namePrefix? : {string} (example: \"Dr.\" ) nameSuffix? : {string} (example: \"III\" ) birthday? : {date} (example: \"1959-05-15\" ) note? : {string} email? : {array} An array of email addresses objects with the following attributes: address : {string} Email adress type? : {string} Programmatic type of email ( \"work\" , \"home\" , \"other\" ) label? : {string} A user-provided localized type of email (example: \"Work\" ) primary? : {boolean} Indicates a preferred-use address address? : {array} An array of postal addresses objects with the following attributes: street? : {string} pobox? : {string} city? : {string} region? : {string} postcode? : {string} country? : {string} type? : {string} Programmatic type of email ( \"work\" , \"home\" , \"other\" ) primary? : {boolean} Indicates a preferred-use address label? : {string} formattedAddress? : {string} Unstructured version of the address phone? : {array} An array of phone number objects with the following attributes: number : {string} type? : {string} Programmatic type of phone number ( \"work\" , \"home\" , \"mobile\" , \"fax\" , \"other\" ) label? : {string} A user-provided localized type of phone number (example: \"Work\" ) primary? : {boolean} Indicates a preferred-use number cozy? : {array} An array of cozy instances with the following attributes: url : {string} label? : {string} A user-provided localized type of instance primary? : {boolean} Indicates a preferred-use instance groups : {array} An array containing a list of ids of io.cozy.contacts.groups documents that this contact is part of metadata : {object} - version : {integer} Used for migrations. Current version is 1","title":"io.cozy.contacts"},{"location":"/cozy-doctypes/docs/io.cozy.contacts/#iocozycontactsgroups","text":"Used to group contacts together. A group can obviously have multiple contacts, but contacts can also be part of multiple groups. name : {string} is the group s public name metadata : {object} - version : {integer} Used for migrations. Current version is 1","title":"io.cozy.contacts.groups"},{"location":"/cozy-doctypes/docs/io.cozy.files/","text":"Table of contents Cozy Files doctype io.cozy.files The io.cozy.files doctype is used for both the files and directories. Folder For a folder, its attributes are: type : {string} always directory name : {string} the directory name path : {string} the path to this directory, which is the path of its parent, then / , then its name created_at : {timestamp} the date of the creation of this directory updated_at : {timestamp} the date of the last update of this directory tags : {array of strings} a list of tags It also has a relationship with its parent in the JSON-API representation, and another called data with the files and directory inside it. Files The attributes of a file are: type : {string} always file name : {string} the file name trashed : {bool} true if the file is in the trash md5sum : {string} the checksum of its content, computed with the MD5 algorithm created_at : {timestamp} the date of the creation of this directory updated_at : {timestamp} the date of the last update of this directory tags : {array of strings} a list of tags size : {number} the size of its content, in bytes executable : {bool} true is the file has the executable bit on UNIX ( chmod +x ) class : {string} a class in the list: ['image', 'document', 'audio', 'video', 'text', 'binary'] mime : {string} the full mime-type metadata : {map} an optional map of metadata (for example width , height , and datetime for an image) It also has a relationship with its parent in the JSON-API representation. For an image , there are 3 links to thumbnails: small , medium , and large . References It s possible to link a file or a folder to another document. It s called a reference . It appears in the JSON-API representation as a refererenced_by relationship.","title":"Files"},{"location":"/cozy-doctypes/docs/io.cozy.files/#cozy-files-doctype","text":"","title":"Cozy Files doctype"},{"location":"/cozy-doctypes/docs/io.cozy.files/#iocozyfiles","text":"The io.cozy.files doctype is used for both the files and directories.","title":"io.cozy.files"},{"location":"/cozy-doctypes/docs/io.cozy.files/#folder","text":"For a folder, its attributes are: type : {string} always directory name : {string} the directory name path : {string} the path to this directory, which is the path of its parent, then / , then its name created_at : {timestamp} the date of the creation of this directory updated_at : {timestamp} the date of the last update of this directory tags : {array of strings} a list of tags It also has a relationship with its parent in the JSON-API representation, and another called data with the files and directory inside it.","title":"Folder"},{"location":"/cozy-doctypes/docs/io.cozy.files/#files","text":"The attributes of a file are: type : {string} always file name : {string} the file name trashed : {bool} true if the file is in the trash md5sum : {string} the checksum of its content, computed with the MD5 algorithm created_at : {timestamp} the date of the creation of this directory updated_at : {timestamp} the date of the last update of this directory tags : {array of strings} a list of tags size : {number} the size of its content, in bytes executable : {bool} true is the file has the executable bit on UNIX ( chmod +x ) class : {string} a class in the list: ['image', 'document', 'audio', 'video', 'text', 'binary'] mime : {string} the full mime-type metadata : {map} an optional map of metadata (for example width , height , and datetime for an image) It also has a relationship with its parent in the JSON-API representation. For an image , there are 3 links to thumbnails: small , medium , and large .","title":"Files"},{"location":"/cozy-doctypes/docs/io.cozy.files/#references","text":"It s possible to link a file or a folder to another document. It s called a reference . It appears in the JSON-API representation as a refererenced_by relationship.","title":"References"},{"location":"/cozy-doctypes/docs/io.cozy.notifications/","text":"Table of contents Cozy Notifications doctype io.cozy.notifications Applications can notify the cozy owner. They will appear in the cozy-bar, the mobile app, and a summary can be sent by email. source : {id} the id of the application/konnector that has made the notification reference : {string} a reference for the application (it can be used to hide other notifications like this one, or to update a count in a notification) title : {string} a title to explain the notification content : {string} more context about the notification icon : {image} an icon to display with the notification actions : [{text, intent}] an array of objects with a text and an intent. Each action can be seen as a link, the text being what is shown and the intent what happens when clicking on the link. created_at : {timestamp} the date of the creation. See also the notification documentation for more informations.","title":"Notifications"},{"location":"/cozy-doctypes/docs/io.cozy.notifications/#cozy-notifications-doctype","text":"","title":"Cozy Notifications doctype"},{"location":"/cozy-doctypes/docs/io.cozy.notifications/#iocozynotifications","text":"Applications can notify the cozy owner. They will appear in the cozy-bar, the mobile app, and a summary can be sent by email. source : {id} the id of the application/konnector that has made the notification reference : {string} a reference for the application (it can be used to hide other notifications like this one, or to update a count in a notification) title : {string} a title to explain the notification content : {string} more context about the notification icon : {image} an icon to display with the notification actions : [{text, intent}] an array of objects with a text and an intent. Each action can be seen as a link, the text being what is shown and the intent what happens when clicking on the link. created_at : {timestamp} the date of the creation. See also the notification documentation for more informations.","title":"io.cozy.notifications"},{"location":"/cozy-doctypes/docs/io.cozy.payslips/","text":"Table of contents Payslips doctype io.cozy.payslips vendor : {string} - Vendor which issued the payslip date : {date} - Date the payslip was emitted amount : {number} - Amount of the payslip, always positive even if it is the payslip of an employee. This amount should always be the amount which will be found in the bank operations. Relationships The eventual related documents - document : {object} - The associated file. ex: { data: { _id: c43645a93831827c7ec512eac3006e51 , _type: io.cozy.files } } Some more attributes for employee s payslip The are some more possible attributes for employee payslips. isEmployee : {boolean} - Indicate if this payslip is paid to an employee of the owner of the cozy. If false, this is a payslip received by the owner. beneficiary : {string} - Indicate the name of the employee Example { _id : 62e5d80d6e11d19992b7efce794263f0 , amount : 2000, date : 2018-02-07T23:00:00.000Z , vendor : Payfit , metadata : { version : 1 }, $relationships: { document: { data: { _id: c43645a93831827c7ec512eac3006e51 , _type: io.cozy.files } } } } { _id : 62e5d83d6e11d19992b7efce794263f0 , amount : 100, date : 2018-04-07T03:00:00.000Z , vendor : CESU , isEmployee : true, beneficiary : Pierre Richard , metadata : { version : 1 }, $relationships: { payslip: { data: { _id: c43645a93831827c7ec512eac3006e51 , _type: io.cozy.files } } } }","title":"Payslips"},{"location":"/cozy-doctypes/docs/io.cozy.payslips/#payslips-doctype","text":"","title":"Payslips doctype"},{"location":"/cozy-doctypes/docs/io.cozy.payslips/#iocozypayslips","text":"vendor : {string} - Vendor which issued the payslip date : {date} - Date the payslip was emitted amount : {number} - Amount of the payslip, always positive even if it is the payslip of an employee. This amount should always be the amount which will be found in the bank operations.","title":"io.cozy.payslips"},{"location":"/cozy-doctypes/docs/io.cozy.payslips/#relationships","text":"The eventual related documents - document : {object} - The associated file. ex: { data: { _id: c43645a93831827c7ec512eac3006e51 , _type: io.cozy.files } }","title":"Relationships"},{"location":"/cozy-doctypes/docs/io.cozy.payslips/#some-more-attributes-for-employees-payslip","text":"The are some more possible attributes for employee payslips. isEmployee : {boolean} - Indicate if this payslip is paid to an employee of the owner of the cozy. If false, this is a payslip received by the owner. beneficiary : {string} - Indicate the name of the employee","title":"Some more attributes for employee's payslip"},{"location":"/cozy-doctypes/docs/io.cozy.payslips/#example","text":"{ _id : 62e5d80d6e11d19992b7efce794263f0 , amount : 2000, date : 2018-02-07T23:00:00.000Z , vendor : Payfit , metadata : { version : 1 }, $relationships: { document: { data: { _id: c43645a93831827c7ec512eac3006e51 , _type: io.cozy.files } } } } { _id : 62e5d83d6e11d19992b7efce794263f0 , amount : 100, date : 2018-04-07T03:00:00.000Z , vendor : CESU , isEmployee : true, beneficiary : Pierre Richard , metadata : { version : 1 }, $relationships: { payslip: { data: { _id: c43645a93831827c7ec512eac3006e51 , _type: io.cozy.files } } } }","title":"Example"},{"location":"/cozy-doctypes/docs/io.cozy.remote.requests/","text":"Table of contents Logs of the requests via the remote doctypes io.cozy.remote.requests doctype : the remote doctype used in the request (example: org.wikidata.entity ) verb : the HTTP verb used for the request ( GET or POST ) url : the URL of the remote website, with variables injected in it response_code : the HTTP response code, (often 200 ) content_type : the content-type of the response (example: application/json ) variables : the key- value map of the variables sent to the stack, including the comments (variables that are not sent to the remote website, but can be useful for the people reading the logs). created_at : the date/time of the request","title":"Remote requests"},{"location":"/cozy-doctypes/docs/io.cozy.remote.requests/#logs-of-the-requests-via-the-remote-doctypes","text":"","title":"Logs of the requests via the remote doctypes"},{"location":"/cozy-doctypes/docs/io.cozy.remote.requests/#iocozyremoterequests","text":"doctype : the remote doctype used in the request (example: org.wikidata.entity ) verb : the HTTP verb used for the request ( GET or POST ) url : the URL of the remote website, with variables injected in it response_code : the HTTP response code, (often 200 ) content_type : the content-type of the response (example: application/json ) variables : the key- value map of the variables sent to the stack, including the comments (variables that are not sent to the remote website, but can be useful for the people reading the logs). created_at : the date/time of the request","title":"io.cozy.remote.requests"},{"location":"/cozy-doctypes/docs/io.cozy.sessions.logins/","text":"Table of contents Session login entry io.cozy.sessions.logins This doctype represent an entry in the session history: ip : {string} the ip used to login city : {string} the city from where the user has logged in (estimated from IP) country : {string} the country from where the user has logged in (estimated from IP) user_agent : {string} the full useragent string used to login os : {string} the os used to login browser : {string} the browser used to login created_at : {string} the login date","title":"Session logins"},{"location":"/cozy-doctypes/docs/io.cozy.sessions.logins/#session-login-entry","text":"","title":"Session login entry"},{"location":"/cozy-doctypes/docs/io.cozy.sessions.logins/#iocozysessionslogins","text":"This doctype represent an entry in the session history: ip : {string} the ip used to login city : {string} the city from where the user has logged in (estimated from IP) country : {string} the country from where the user has logged in (estimated from IP) user_agent : {string} the full useragent string used to login os : {string} the os used to login browser : {string} the browser used to login created_at : {string} the login date","title":"io.cozy.sessions.logins"},{"location":"/cozy-doctypes/docs/io.cozy.sharings/","text":"Table of contents io.cozy.sharings This doctype describes a sharing, ie an action made by some user to share some documents and files from her cozy instance to other people. An identifier (the same for all members of the sharing) A list of members . The first one is the owner. For each member, we have the URL of the cozy, a public name, an email, a status and some credentials to authorize the transfer of data between the owner and the recipients A description (one sentence that will help people understand what is shared and why) a flag active that says if the sharing is currently active for at least one member a flag owner , true for the document on the cozy of the sharer, and false on the other cozy instance a flag open_sharing : true if any member of the sharing can add a new recipient false if only the owner can add a new recipient Some technical data ( created_at , updated_at , app_slug , preview_path , triggers , credentials ) A list of sharing rules , each rule being composed of: a title , that will be displayed to the recipients before they accept the sharing a doctype a selector (by default, it\u2019s the id ) and values (one identifier, a list of identifiers, files and folders inside a folder, files that are referenced by the same document, documents bound to a previous sharing rule) local : by default false , but it can false true for documents that are useful for the preview page but doesn\u2019t need to be send to the recipients (e.g. a setting document of the application) add : a behavior when a new document matches this rule (the document is created, or it was a document that didn\u2019t match the rule and is modified and the new version matches the rule): none : the updates are never propagated (the default) push : the updates made on the owner are sent to the recipients sync : the updates on any member are propagated to the other members update : a behavior when a document matched by this rule is modified. Can be: none : the updates are never propagated (the default) push : the updates made on the owner are sent to the recipients sync : the updates on any member are propagated to the other members remove : a behavior when a document no longer matches this rule (the document is deleted, or it was a document that matched the rule, and is modified and the new version doesn\u2019t match the rule): none : the updates are never propagated (the default) push : the updates made on the owner are sent to the recipients sync : the updates on any member are propagated to the other members revoke : the sharing is revoked. Example { _id : fffe04ebbec335405161f19133a0cd5c , _rev : 7-bb721ae29e74ff2d776d8cbabf1a0bf5 , triggers : { track_id : fffe04ebbec335405161f19133a0fab5 , replicate_id : fffe04ebbec335405161f19133a1172a , upload_id : fffe04ebbec335405161f19133a133bd }, active : true, owner : true, description : Let's work together! , app_slug : , created_at : 2018-06-01T16:54:32.677789079+02:00 , updated_at : 2018-06-01T16:54:32.677789079+02:00 , rules : [ { title : labore_adipisci , doctype : io.cozy.files , values : [ fffe04ebbec335405161f19133a0b7b1 ], add : sync , update : sync , remove : sync } ], members : [ { status : owner , name : Alice , email : alice+test@cozy.tools , instance : http://alice.test.cozy.tools:8081 }, { status : ready , name : Benjamin Denis , email : denis@borer.org , instance : http://bob.test.cozy.tools:8082 } ], credentials : [ { state : OyPayIajZQUUX_KsZY2yaQ , client : { client_id : fffe04ebbec335405161f19133a0e286 , client_secret : JeOuBosC329bnz1rFK3Yenw8_8TleOa2 , client_secret_expires_at : 0, registration_access_token : eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJyZWdpc3RyYXRpb24iLCJpYXQiOjE1Mjc4NjQ4ODQsImlzcyI6ImJvYi50ZXN0LmNvenkudG9vbHM6ODA4MiIsInN1YiI6ImZmZmUwNGViYmVjMzM1NDA1MTYxZjE5MTMzYTBlMjg2In0.WsNnnFnnf_vgf2OQyGSaj9XyK2elkaGHyl2vFpjzlCxEfj7ZoE7B2b6_GtRIdmhh42VSawoyGLAXsPh-ml10GQ , redirect_uris : [ http://alice.test.cozy.tools:8081/sharings/answer ], client_name : Sharing Alice , client_kind : sharing , client_uri : http://alice.test.cozy.tools:8081/ , software_id : github.com/cozy/cozy-stack }, access_token : { token_type : bearer , access_token : eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhY2Nlc3MiLCJpYXQiOjE1Mjc4NjQ4ODQsImlzcyI6ImJvYi50ZXN0LmNvenkudG9vbHM6ODA4MiIsInN1YiI6ImZmZmUwNGViYmVjMzM1NDA1MTYxZjE5MTMzYTBlMjg2Iiwic2NvcGUiOiJpby5jb3p5LnNoYXJpbmdzOkFMTDpmZmZlMDRlYmJlYzMzNTQwNTE2MWYxOTEzM2EwY2Q1YyJ9.ZS0r9KpjrctckigRIELJQryzHrFGo-1dQvRplSNj8N0jyJE1LPgnYuiDedQ8EQN5-1ffeLUf3h_Rygz2ozQvPA , refresh_token : eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJyZWZyZXNoIiwiaWF0IjoxNTI3ODY0ODg0LCJpc3MiOiJib2IudGVzdC5jb3p5LnRvb2xzOjgwODIiLCJzdWIiOiJmZmZlMDRlYmJlYzMzNTQwNTE2MWYxOTEzM2EwZTI4NiIsInNjb3BlIjoiaW8uY296eS5zaGFyaW5nczpBTEw6ZmZmZTA0ZWJiZWMzMzU0MDUxNjFmMTkxMzNhMGNkNWMifQ.cnH-COVwBIY8zOK51BBkLhb8vRbA96mRJ_W-i3Gg_qZoAISUjmzM3IH69DPQzD99OFnyeGWPhuIkCyWZX7ULQA , scope : io.cozy.sharings:ALL:fffe04ebbec335405161f19133a0cd5c }, xor_key : CAMHBgkAAgEMCAkMAgsIAw== , inbound_client_id : fffe04ebbec335405161f19133a0ecc2 } ] } io.cozy.shared This doctype is an internal one for the stack. It is used to track what documents are shared, and to replicate changes from one Cozy to the others. _id : its identifier is the doctype and id of the referenced objet, separated by a / (e.g. io.cozy.contacts/c1f5dae4-0d87-11e8-b91b-1f41c005768b ) _rev : the CouchDB default revision for this document (not very meaningful, it\u2019s here to avoid concurrency issues) revisions : a tree with the last known _rev s of the referenced object infos , a map of sharing ids \u2192 {rule, removed, binary} rule says which rule from the sharing must be applied for this document removed will be true for a deleted document, a trashed file, or if the document does no longer match the sharing rule binary is a boolean flag that is true only for files (and not even folders) with removed: false Example { _id : io.cozy.files/becbd072f742f5444f5d7837b2f4e323 , _rev : 1-af3192a67f2bf69e011aa1bda39e6c72 , revisions : { rev : 4-4135d4994981c0041e3c89a681542307 }, infos : { fffe04ebbec335405161f19133a0cd5c : { rule : 0, binary : true } } }","title":"Sharings"},{"location":"/cozy-doctypes/docs/io.cozy.sharings/#iocozysharings","text":"This doctype describes a sharing, ie an action made by some user to share some documents and files from her cozy instance to other people. An identifier (the same for all members of the sharing) A list of members . The first one is the owner. For each member, we have the URL of the cozy, a public name, an email, a status and some credentials to authorize the transfer of data between the owner and the recipients A description (one sentence that will help people understand what is shared and why) a flag active that says if the sharing is currently active for at least one member a flag owner , true for the document on the cozy of the sharer, and false on the other cozy instance a flag open_sharing : true if any member of the sharing can add a new recipient false if only the owner can add a new recipient Some technical data ( created_at , updated_at , app_slug , preview_path , triggers , credentials ) A list of sharing rules , each rule being composed of: a title , that will be displayed to the recipients before they accept the sharing a doctype a selector (by default, it\u2019s the id ) and values (one identifier, a list of identifiers, files and folders inside a folder, files that are referenced by the same document, documents bound to a previous sharing rule) local : by default false , but it can false true for documents that are useful for the preview page but doesn\u2019t need to be send to the recipients (e.g. a setting document of the application) add : a behavior when a new document matches this rule (the document is created, or it was a document that didn\u2019t match the rule and is modified and the new version matches the rule): none : the updates are never propagated (the default) push : the updates made on the owner are sent to the recipients sync : the updates on any member are propagated to the other members update : a behavior when a document matched by this rule is modified. Can be: none : the updates are never propagated (the default) push : the updates made on the owner are sent to the recipients sync : the updates on any member are propagated to the other members remove : a behavior when a document no longer matches this rule (the document is deleted, or it was a document that matched the rule, and is modified and the new version doesn\u2019t match the rule): none : the updates are never propagated (the default) push : the updates made on the owner are sent to the recipients sync : the updates on any member are propagated to the other members revoke : the sharing is revoked.","title":"io.cozy.sharings"},{"location":"/cozy-doctypes/docs/io.cozy.sharings/#example","text":"{ _id : fffe04ebbec335405161f19133a0cd5c , _rev : 7-bb721ae29e74ff2d776d8cbabf1a0bf5 , triggers : { track_id : fffe04ebbec335405161f19133a0fab5 , replicate_id : fffe04ebbec335405161f19133a1172a , upload_id : fffe04ebbec335405161f19133a133bd }, active : true, owner : true, description : Let's work together! , app_slug : , created_at : 2018-06-01T16:54:32.677789079+02:00 , updated_at : 2018-06-01T16:54:32.677789079+02:00 , rules : [ { title : labore_adipisci , doctype : io.cozy.files , values : [ fffe04ebbec335405161f19133a0b7b1 ], add : sync , update : sync , remove : sync } ], members : [ { status : owner , name : Alice , email : alice+test@cozy.tools , instance : http://alice.test.cozy.tools:8081 }, { status : ready , name : Benjamin Denis , email : denis@borer.org , instance : http://bob.test.cozy.tools:8082 } ], credentials : [ { state : OyPayIajZQUUX_KsZY2yaQ , client : { client_id : fffe04ebbec335405161f19133a0e286 , client_secret : JeOuBosC329bnz1rFK3Yenw8_8TleOa2 , client_secret_expires_at : 0, registration_access_token : eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJyZWdpc3RyYXRpb24iLCJpYXQiOjE1Mjc4NjQ4ODQsImlzcyI6ImJvYi50ZXN0LmNvenkudG9vbHM6ODA4MiIsInN1YiI6ImZmZmUwNGViYmVjMzM1NDA1MTYxZjE5MTMzYTBlMjg2In0.WsNnnFnnf_vgf2OQyGSaj9XyK2elkaGHyl2vFpjzlCxEfj7ZoE7B2b6_GtRIdmhh42VSawoyGLAXsPh-ml10GQ , redirect_uris : [ http://alice.test.cozy.tools:8081/sharings/answer ], client_name : Sharing Alice , client_kind : sharing , client_uri : http://alice.test.cozy.tools:8081/ , software_id : github.com/cozy/cozy-stack }, access_token : { token_type : bearer , access_token : eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhY2Nlc3MiLCJpYXQiOjE1Mjc4NjQ4ODQsImlzcyI6ImJvYi50ZXN0LmNvenkudG9vbHM6ODA4MiIsInN1YiI6ImZmZmUwNGViYmVjMzM1NDA1MTYxZjE5MTMzYTBlMjg2Iiwic2NvcGUiOiJpby5jb3p5LnNoYXJpbmdzOkFMTDpmZmZlMDRlYmJlYzMzNTQwNTE2MWYxOTEzM2EwY2Q1YyJ9.ZS0r9KpjrctckigRIELJQryzHrFGo-1dQvRplSNj8N0jyJE1LPgnYuiDedQ8EQN5-1ffeLUf3h_Rygz2ozQvPA , refresh_token : eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJyZWZyZXNoIiwiaWF0IjoxNTI3ODY0ODg0LCJpc3MiOiJib2IudGVzdC5jb3p5LnRvb2xzOjgwODIiLCJzdWIiOiJmZmZlMDRlYmJlYzMzNTQwNTE2MWYxOTEzM2EwZTI4NiIsInNjb3BlIjoiaW8uY296eS5zaGFyaW5nczpBTEw6ZmZmZTA0ZWJiZWMzMzU0MDUxNjFmMTkxMzNhMGNkNWMifQ.cnH-COVwBIY8zOK51BBkLhb8vRbA96mRJ_W-i3Gg_qZoAISUjmzM3IH69DPQzD99OFnyeGWPhuIkCyWZX7ULQA , scope : io.cozy.sharings:ALL:fffe04ebbec335405161f19133a0cd5c }, xor_key : CAMHBgkAAgEMCAkMAgsIAw== , inbound_client_id : fffe04ebbec335405161f19133a0ecc2 } ] }","title":"Example"},{"location":"/cozy-doctypes/docs/io.cozy.sharings/#iocozyshared","text":"This doctype is an internal one for the stack. It is used to track what documents are shared, and to replicate changes from one Cozy to the others. _id : its identifier is the doctype and id of the referenced objet, separated by a / (e.g. io.cozy.contacts/c1f5dae4-0d87-11e8-b91b-1f41c005768b ) _rev : the CouchDB default revision for this document (not very meaningful, it\u2019s here to avoid concurrency issues) revisions : a tree with the last known _rev s of the referenced object infos , a map of sharing ids \u2192 {rule, removed, binary} rule says which rule from the sharing must be applied for this document removed will be true for a deleted document, a trashed file, or if the document does no longer match the sharing rule binary is a boolean flag that is true only for files (and not even folders) with removed: false","title":"io.cozy.shared"},{"location":"/cozy-doctypes/docs/io.cozy.sharings/#example_1","text":"{ _id : io.cozy.files/becbd072f742f5444f5d7837b2f4e323 , _rev : 1-af3192a67f2bf69e011aa1bda39e6c72 , revisions : { rev : 4-4135d4994981c0041e3c89a681542307 }, infos : { fffe04ebbec335405161f19133a0cd5c : { rule : 0, binary : true } } }","title":"Example"},{"location":"/cozy-doctypes/docs/io.cozy.triggers/","text":"Table of contents Triggers doctype io.cozy.triggers documents are used by the stack to configure how and when a job should be runned . This is a special doctype which can only be created from an app. We are using it in Cozy-Collect to manage konnectors scheduling. Attributes Attribute Role arguments Arguments related to the type attribute. For example it s a cron configuration when the type is set to @cron . debounce Amount of time until the job cannot be run again. This attribute is used to limite the amount of jobs in a burst. message Parameters to pass to the the worker. For example, when the worker is set to konnector , message contains the related konnector and the related account. options Parameters related to the job. type Type of trigger. Can be @at , @cron , @event , @every , and @in . See the stack documentation for more informations. worker Type of worker. Can be konnector or sendmail . Example Trigger configured to run the konnector Debug with the io.cozy.accounts document having the id 53fe4d0e4f6d3be99ba7a5d2580081a8 . { type : @cron , worker : konnector , arguments : 0 45 4 * * 3 , debounce : , options : null, message : { konnector : debug , account : 53fe4d0e4f6d3be99ba7a5d2580081a8 } }","title":"Triggers"},{"location":"/cozy-doctypes/docs/io.cozy.triggers/#triggers-doctype","text":"io.cozy.triggers documents are used by the stack to configure how and when a job should be runned . This is a special doctype which can only be created from an app. We are using it in Cozy-Collect to manage konnectors scheduling.","title":"Triggers doctype"},{"location":"/cozy-doctypes/docs/io.cozy.triggers/#attributes","text":"Attribute Role arguments Arguments related to the type attribute. For example it s a cron configuration when the type is set to @cron . debounce Amount of time until the job cannot be run again. This attribute is used to limite the amount of jobs in a burst. message Parameters to pass to the the worker. For example, when the worker is set to konnector , message contains the related konnector and the related account. options Parameters related to the job. type Type of trigger. Can be @at , @cron , @event , @every , and @in . See the stack documentation for more informations. worker Type of worker. Can be konnector or sendmail .","title":"Attributes"},{"location":"/cozy-doctypes/docs/io.cozy.triggers/#example","text":"Trigger configured to run the konnector Debug with the io.cozy.accounts document having the id 53fe4d0e4f6d3be99ba7a5d2580081a8 . { type : @cron , worker : konnector , arguments : 0 45 4 * * 3 , debounce : , options : null, message : { konnector : debug , account : 53fe4d0e4f6d3be99ba7a5d2580081a8 } }","title":"Example"},{"location":"/cozy-stack/README/","text":"Table of contents Architecture General overview Security Usage Install the cozy-stack Manpages of the command-line tool Configuration file Managing Instances Onboarding For developpers Develop a client-side app Running and building Docker images Build a release The contributing guide Services /auth - Authentication OAuth /apps - Applications Management Apps registry /data - Data System Mango Replication CouchDB Quirks /files - Virtual File System References of documents in VFS /intents - Intents /jobs - Jobs Konnectors Workers /move - Move, export and import an instance /notifications - Notifications /permissions - Permissions /realtime - Realtime /remote - Proxy for remote data/API /settings - Settings Terms of Services /sharings - Sharing Request for comments Archives These pages are the results of studies we made: Moving Golang Couchdb Plugins Konnectors design","title":"README"},{"location":"/cozy-stack/README/#table-of-contents","text":"","title":"Table of contents"},{"location":"/cozy-stack/README/#architecture","text":"General overview Security","title":"Architecture"},{"location":"/cozy-stack/README/#usage","text":"Install the cozy-stack Manpages of the command-line tool Configuration file Managing Instances Onboarding","title":"Usage"},{"location":"/cozy-stack/README/#for-developpers","text":"Develop a client-side app Running and building Docker images Build a release The contributing guide","title":"For developpers"},{"location":"/cozy-stack/README/#services","text":"/auth - Authentication OAuth /apps - Applications Management Apps registry /data - Data System Mango Replication CouchDB Quirks /files - Virtual File System References of documents in VFS /intents - Intents /jobs - Jobs Konnectors Workers /move - Move, export and import an instance /notifications - Notifications /permissions - Permissions /realtime - Realtime /remote - Proxy for remote data/API /settings - Settings Terms of Services /sharings - Sharing Request for comments","title":"Services"},{"location":"/cozy-stack/README/#archives","text":"These pages are the results of studies we made: Moving Golang Couchdb Plugins Konnectors design","title":"Archives"},{"location":"/cozy-stack/architecture/","text":"Table of contents Cozy Architecture What is Cozy? Cozy is a personal platform as a service with a focus on data. Cozy can be seen as 4 layers, from inside to outside: A place to keep your personal data A core API to handle the data Your web apps, and also the mobile desktop clients A coherent User Experience. It s also a set of values: Simple, Versatile, Yours. These values mean a lot for Cozy in all aspects. From an architectural point of view, it declines to: Simple to deploy and understand, not built as a galaxy of optimized microservices managed by kubernetes that only experts can debug. Versatile, can be hosted on a Raspberry Pi for geeks to massive scale on multiple servers by specialized hosting. Users can install apps. Yours, you own your data and you control it. If you want to take back your data to go elsewhere, you can. Overview The architecture of Cozy is composed of: A reverse proxy The cozy stack A CouchDB instance to persist the JSON documents A space for storing files Optionally, Redis for caching and synchronization Optionally, a metrics server. All of this can run on a personal server, self-hosted at home, like a Raspberry Pi: But it s also possible to deploy a cozy on a more powerful server in order to host dozens of cozy instances (an association for example). It will looks like this: And even to scale to thousands of cozy instances on a server farm, with high availability: This elasticity comes with some constraints: Most applications are run in the browser, not in the server. What must run on the server is mutualized inside the cozy stack. The cozy stack is stateless. The data is stored in couchdb and a space for files. A couchdb database is specific to an instance (no mix of data from 2 users in the same database). Reverse proxy The reverse proxy is here to accept HTTPS connexions and forward the request to the cozy stack. It s here mainly to manage the TLS part and binding a port 1024 without needing to launch the cozy stack as root. And it s better if http/2 is supported, as it will make the web interface to load faster. The Cozy Stack The Cozy Stack is a single executable. It can do several things but its most important usage is starting an HTTP server to serve as an API for all the services of Cozy, from authentication to real-time events. This API can be used on several domains. Each domain is a cozy instance for a specific user ( multi-tenant ). Redis Redis is optional when there is a single cozy stack running. When available, it is used to synchronize the Cozy Stacks: distributed locks for special operations like installing an application, queues for recurrent jobs, etc. As a bonus, it can also be used to cache some frequently used documents. Databases The JSON documents that represent the users data are stored in CouchDB, but they are not mixed in a single database. We don t mix data from 2 users in the same database. It s easier and safer to control the access to the data by using different databases per user. But we think to go even further by splitting the data of a user in several databases, one per document type. For example, we can have a database for the emails of a user and one for her todo list. This can simplify the implementation of permissions (this app has access to these document types) and can improve performance. CouchDB queries work with views. A view is defined ahead of its usage and is built by CouchDB when it is requested and is stale, i.e. there were writes in the database since the last time it was updated. So, with a single database per user, it s possible to experience lag when the todolist view is requested after fetching a long list of emails. By splitting the databases per doctypes, we gain on two fronts: The views are updated less frequently, only when documents of the matching doctypes are written. Some views are no longer necessary: those to access documents of a specific doctypes. There are downsides, mostly: It can be harder to manage more databases. It s no longer possible to use a single view for documents from doctypes that are no longer in the same database. We think that we can work on that and the pros will outweigh the cons. Metrics The Cozy Stack can generate some metrics about its usage (the size of the files transfered, the number of opened connexions, the number of requests to redis, etc.) and export them to a metrics backend. It will help identify the bottlenecks when scaling to add more users. The Warp 10 Platform looks like a good candidate for this. Glossary Instance An instance is a logical space owned by a user and identified by a domain. For example, zoe.cozycloud.cc can be the cozy instance of Zo\u00e9. This instance has a space for storing files and some CouchDB databases for storing the documents of its owner. Environment When creating an instance, it s possible to give an environment, dev , test or prod . The default apps won t be the same on all environments. For example, in the dev environment, some devtools will be installed to help the front developers to create their own apps. Cozy Stack Build Mode The cozy stack can run in several modes, set by a UNIX environment variable: production , the default development , for coding on the cozy stack. This mode is set when compiling the cozy-stack. It is used to show more or less logs, and what is acceptable to be displayed in errors. Even if the Cozy Stack Build Mode and Environment have similar values, they are not the same. The Cozy Stack Mode will be used by core developers to hack on the cozy stack. The environment will be used by front developers to hack on cozy apps. Services The cozy stack came with several services. They run on the server, inside the golang process and have an HTTP interface. Authentication /auth The cozy stack can authenticate the owner of a cozy instance. This can happen in the classical web style, with a form and a cookie, but also with OAuth2 for remote interactions like cozy-mobile and cozy-desktop. Applications /apps It s possible to manage serverless applications from the cozy stack and serve them via cozy stack. The stack does the routing and serve the HTML and the assets for the applications. The assets of the applications are installed in the virtual file system. On the big instances, it means that even if it is the frontal 1 that installs the application, frontal 2 will still be able to serve the application by getting its assets from Swift. It will be possible to install applications from several sources (git, mercurial, npm or even just a tarball). Also, we want to offer two channels for our official apps: one with a stable and well tested release, and one with more frequent updates for our more adventurous users. More informations here . Data System /data CouchDB is used for persistence of JSON documents. The data service is a layer on top of it for routing the requests to the corresponding CouchDB database and checking the permissions. In particular, a serverless application can declare some contexts and access data in those contexts even if it s not the owner of the cozy instance that access it. For example, the owner of a cozy can create a photo album with a selection of photos. This album can then be associated to a context to be shared with friends of the owner. These friends can access the album and see the photos, but not anonymous people. More informations here . Virtual File System /files It s possible to store files on the cozy, including binary ones like photos and movies, thanks to the virtual file system. It s a facade, with several implementations, depending on where the files are effectively stored: In a directory of a local file system (easier for self-hosted users) Swift from Open Stack (convenient for massive hosting) And more storage providers, like minio , later. The range of possible operations with this endpoint goes from simple ones, like uploading a file, to more complex ones, like renaming a folder. It also ensure that an instance is not exceeding its quota, and keeps a trash to recover files recently deleted. More informations here . Sharing /sharings Users will want to share things like calendars. This service is there for sharing JSON documents between cozy instances, with respect to the access control. Jobs /jobs The cozy stack has queues where job descriptions can be put. For example, a job can be to fetch the latest bills from a specific provider. These queues can be consumed by external workers to complete the associated jobs. We can imagine having a media worker that extract thumbnails from photos and videos. It will fetch jobs from a media queue and each job description will contain the path to the photo or video from which the thumbnail will be extracted. There is also a scheduler that acts like a crontab. It can add jobs at recurrent time. For example, it can add a job for fetching github commits every hour. Later, we can dream about having more ways to create jobs (webhooks, on document creation) and make them communicate. With a web interface on that, it can become a simplified Ifttt . Sync /sync This endpoint will be for synchronizing your contacts and calendars by using standard methods like caldav and carddav. Later, we hope to support also Webdav and RemoteStorage. Settings /settings Each cozy instance has some settings, like its domain name, its language, the name of its owner, the background for the home, etc. Notifications /notifications The applications can put some notifications for the user. That goes from a reminder for a meeting in 10 minutes to a suggestion to update your app. Real-time /realtime This endpoint can be used to subscribe for real-time events. An application that shows items of a specific doctype can listen for this doctype to be notified of all the changes for this doctype. For example, the calendar app can listen for all the events and if a synchronization with the mobile adds a new event, the app will be notified and can show this new event. Error catcher /errors Client-side applications can have some JS errors. By sending the error, with its backtrace, to this endpoint, it will be kept in a logfile to help the developers debug the application later. We should look at the airbrake API and probably be compatible with it to avoid redeveloping JS code to send the errors. Proxy /proxy It can be useful for client-side apps to get data from public APIs. But, sometimes, these APIs don t have CORS enabled. A proxy endpoint can be a simple but effective solution for these cases. Status /status It s here just to say that the API is up and that it can access the CouchDB databases, for debugging and monitoring purposes. Workers The workers take jobs from the queues and process them. Fetch emails /jobs/mailbox It fetches a mailbox to synchronize it and see if there are some new emails. Payload: the mailbox Send email /jobs/sendmail It connects to the SMTP server to send an email. Payload: mail account, recipient, body, attachments Extract metadata /jobs/metadata When a file is added or updated, this worker will extract its metadata (EXIF for an image, id3 for a music, etc.) Payload: the filepath Konnectors /jobs/konnector It synchronizes an account on a remote service (fetch bills for example). Payload: the kind of konnector, the credentials of the account and some optional parameters (like the folder where to put the files) Registry /jobs/registry It updates the list of available applications. Payload: none Indexer /jobs/indexer When a JSON document is added, updated or deleted, this worker will update the index for full text search. Bleve looks like a good candidate for the indexing and full text search technology. Payload: the doctype and the document to index Serverless apps Home /apps/home It s where you land on your cozy and launch your apps. Having widgets to display informations would be nice too! Store (was marketplace) /apps/store You can install new apps here. Settings (was My apps) /apps/settings It s a list of your installed apps and devices, and you can configure some settings like your email address. Collect (was konnectors) /apps/collect You can configure new accounts, to fetch data from them, and see the already configured accounts. Devtools /apps/devtools Some tools for the developpers of applications only: an API console, documentation, logs of the permission checks, etc. Contacts /apps/contacts Manage your contact books. Calendar /apps/calendar Manage your events and alarms. Drive /apps/drive A web interface to browse your files. Photos /apps/photos Organize your photos and share them with friends. Todo list /apps/todo A task manager to never forgot what you should do. Onboarding /apps/onboarding Start your cozy and setup your accounts. Clients Mobile Cozy-mobile is an application for android and iOS for synchronizing files, contacts and calendars between the phone and the cozy instance. Desktop Cozy-desktop is a client for Linux, OSX and windows that allows to sync the files in a cozy instance with a laptop or desktop. Guidelines The Go Programming Language Go (often referred as golang) is an open source programming language created at Google in 2007. It has nice properties for our usage: Simplicity (the language can be learned in weeks, not years). A focus on productivity. Good performance. A good support of concurrency with channels and goroutines. Moreover, Go is used by a lot of companies , is in the Top 10 of the most used languages and has some known open source projects: docker, kubernetes, grafana, syncthing, influxdb, caddy, etc. And it works on the ARM platforms . Go has some tools to help the developers to format its code ( go fmt ), retrieve and install external packages ( go get ), display documentation ( godoc ), check for potential errors with static analysis ( go vet ), etc. Most of them can be used via gometalinter , which is nice for continuous integration. So, we think that writing the Cozy Stack in Go is the right choice. Repository organisation \u251c\u2500\u2500 assets The assets for the front-end \u2502 \u251c\u2500\u2500 images The images \u2502 \u251c\u2500\u2500 scripts The javascript files \u2502 \u251c\u2500\u2500 styles The CSS files \u2502 \u2514\u2500\u2500 templates The HTML templates \u251c\u2500\u2500 cmd One .go file for each command of the cozy executable \u251c\u2500\u2500 docs Documentation, including this file \u251c\u2500\u2500 pkg One sub-directory for each golang package \u251c\u2500\u2500 scripts Some shell scripts for developers and testing \u2514\u2500\u2500 web One sub-directory for each of the services listed above Rest API We follow the best practices about Rest API (using the right status codes, HTTP verbs, organise code by resources, use content-negociation, etc.). When known standards make sense (caldav carddav for example), use them. Else, JSON API is a good default. The golang web framework used for the cozy stack is Echo . HTTP status codes There are some HTTP status codes that are generally used in the API: 200 OK, when everything is OK 201 Created, when a resource was created 204 No Content, when a resource was deleted 400 Bad Request, when the request has some unknown parameters and the request body is not in the expected format 401 Unauthorized, when the user is not authenticated 403 Forbidden, when the permissions forbid this action 404 Not Found, when the resouce can t be found 500 Internal Server Error, when a bug occurs 503 Service Unavailable, when the stack, CouchDB, Redis or Swift is unavailable. DocTypes Each JSON document saved in CouchDB has a field docType that identify the kind of thing it is. For example, a contact will have the docType io.cozy.contacts , and in the cozy-doctypes repository, there will be a contacts JSON file inside it that describes this doctype: What are the mandatory and optional fields? What is the type (string, integer, date) of the fields? Is there a validation rule for a field? How the fields can be indexed for full text search? What is the role of each field (documentation)? This description can be used by any cozy client library (JS, Golang, etc.) to generate some models to simplify the use of documents of this doctype. When a docType has a lot of logic (calendar events for example), a JS class should be shared between the several client-side apps that use this docType, in order to avoid recoding this logic in each application. Import and export You will stay because you can leave. An important promise of Cozy is to give back to the users the control of their data. And this promise is not complete with a way to export the data to use it somewhere else. The Cozy Stack will offer an export button that gives a tarball to the user with the full data. She can then import it on another instance for example. It should also be possible to use the data outside of Cozy. So, the format for the tarball should be as simple as possible and be documented. Of course, when it s possible, we will use open formats. How to contribute? Cozy s DNA is fundamentally Open Source and we want our community to thrive. Having contributions (code, design, translations) is important for us and we will try to create the favorable conditions to support it. Adding a new konnector Adding a konnector is easy for someone who knows JavaScript. The repository has already a lot of pull requests by external contributors. The wiki has documentation to explain the first steps of creating a new konnector. 3 active contributors have been promoted to the maintainers team and can merge the pull requests. We have done workshops to help new developers code their first konnector and we will keep doing it. Creating a new application One of the goals of the new architecture is to make it easier for developers to write new apps. It means having a good documentation, but also some devtools to help: The cozy executable will have a command to setup a new project. The devtools on the cozy interface will give documentation about the doctypes, help explore the Rest API, and check if the permissions are OK. cozy-ui will make it easy to reuse some widgets and offer an application with a style coherent to the cozy identity. Some docTypes with heavy logic will be available as JS classes to be reused in the apps. Reporting a bug or suggesting a new feature We are listening to our users. The forum is here to discuss on many subjects, including how the applications are used. The issues on github are a good place for bug tracking. Translating to a new language We will keep having internationalization for our applications and the translations are maintained on transifex by the community. Translating to a new language, or reviewing an existing one, is really appreciated. FAQ Does the current konnectors in nodejs will be lost? No, they won t. The business logic to scrap data from the many sources will be kept and they will be adapted to fit in this new architecture. It is explained how we will do that here . So, it s not possible to have a custom application with a server part, like the lounge IRC client? We want to support this use case, just not on the short term. It s not clear how we can do that (while not weakening the security). One idea is to run the applications in a different server, or maybe in docker. How to install and update cozy? The Cozy Stack will have no auto-update mechanism. For installing and updating it, you can use the classical ways: Using a package manager, like apt for debian ubuntu. Using an official image for Raspberry Pi (and other embedded platforms). Using the image and services of an hosting company. Or compiling and installing it manually if you are really brave ;-) How to add a cozy instance to a farm? Choose a (sub-)domain and configure the DNS for this (sub-)domain. Configure the reverse-proxy to accept this (sub-)domain. Use the cozy executable to configure the cozy stack. How to migrate from the nodejs cozy to this new architecture for cozy? Export the data from the nodejs cozy (we need to add a button in the web interface for that in the coming months). Install the new cozy. Import the data. Please note that we don t support a continuous replication method that will enable to use both the nodejs and the new architecture at the same time. It looks too complicated for a temporary thing. How to backup the data? There are 2 sensitive places with data: In CouchDB. on the place used for the Virtual File System (a directory on the local filesystem, or in Swift). You can use the tools of your choice to backup these 2 locations. The good old rsync works fine (CouchDB files are append-only, except when compaction happens, so it s friendly to rsync). It s highly recommended to have an automated backup, but sometimes it can be useful to have a way to backup manually the data. The export data button in the web interface give a tarball that can be used to transfer your data from one instance to another, and so, it can be used as a backup. Aren t microservices better for scaling? Yes, it s often easier to scale by separating concerns, and microservices is a way to achieve that. But, it has some serious downsides: It takes more memory and it s probably a no-go for Raspberry Pi. It s more complicated for a developper to install the whole stack before coding its application. It s harder to deploy in production. For the scalability, we can also deploy some specialized instances of the Cozy Stack. For example, we can have some Cozy Stack processes dedicated for real-time. Even, if they have all the code, we can route only the relevant trafic from the load-balancer. What are the frameworks and tools used for the front-end apps? If you want to develop your own app, you can use the framework and the tools you like, nothing is mandatory. For the official apps, we will want to move to: es2017 (but converting the existing coffeescript code will take time) npm scripts and webpack preact JSX. More about this here When will this new architecture be available? The roadmap for Cozy v3 has been explained on our blog: https://blog.cozycloud.cc/post/2016/11/21/On-the-road-to-Cozy-version-3","title":"General overview"},{"location":"/cozy-stack/architecture/#cozy-architecture","text":"","title":"Cozy Architecture"},{"location":"/cozy-stack/architecture/#what-is-cozy","text":"Cozy is a personal platform as a service with a focus on data. Cozy can be seen as 4 layers, from inside to outside: A place to keep your personal data A core API to handle the data Your web apps, and also the mobile desktop clients A coherent User Experience. It s also a set of values: Simple, Versatile, Yours. These values mean a lot for Cozy in all aspects. From an architectural point of view, it declines to: Simple to deploy and understand, not built as a galaxy of optimized microservices managed by kubernetes that only experts can debug. Versatile, can be hosted on a Raspberry Pi for geeks to massive scale on multiple servers by specialized hosting. Users can install apps. Yours, you own your data and you control it. If you want to take back your data to go elsewhere, you can.","title":"What is Cozy?"},{"location":"/cozy-stack/architecture/#overview","text":"The architecture of Cozy is composed of: A reverse proxy The cozy stack A CouchDB instance to persist the JSON documents A space for storing files Optionally, Redis for caching and synchronization Optionally, a metrics server. All of this can run on a personal server, self-hosted at home, like a Raspberry Pi: But it s also possible to deploy a cozy on a more powerful server in order to host dozens of cozy instances (an association for example). It will looks like this: And even to scale to thousands of cozy instances on a server farm, with high availability: This elasticity comes with some constraints: Most applications are run in the browser, not in the server. What must run on the server is mutualized inside the cozy stack. The cozy stack is stateless. The data is stored in couchdb and a space for files. A couchdb database is specific to an instance (no mix of data from 2 users in the same database).","title":"Overview"},{"location":"/cozy-stack/architecture/#reverse-proxy","text":"The reverse proxy is here to accept HTTPS connexions and forward the request to the cozy stack. It s here mainly to manage the TLS part and binding a port 1024 without needing to launch the cozy stack as root. And it s better if http/2 is supported, as it will make the web interface to load faster.","title":"Reverse proxy"},{"location":"/cozy-stack/architecture/#the-cozy-stack","text":"The Cozy Stack is a single executable. It can do several things but its most important usage is starting an HTTP server to serve as an API for all the services of Cozy, from authentication to real-time events. This API can be used on several domains. Each domain is a cozy instance for a specific user ( multi-tenant ).","title":"The Cozy Stack"},{"location":"/cozy-stack/architecture/#redis","text":"Redis is optional when there is a single cozy stack running. When available, it is used to synchronize the Cozy Stacks: distributed locks for special operations like installing an application, queues for recurrent jobs, etc. As a bonus, it can also be used to cache some frequently used documents.","title":"Redis"},{"location":"/cozy-stack/architecture/#databases","text":"The JSON documents that represent the users data are stored in CouchDB, but they are not mixed in a single database. We don t mix data from 2 users in the same database. It s easier and safer to control the access to the data by using different databases per user. But we think to go even further by splitting the data of a user in several databases, one per document type. For example, we can have a database for the emails of a user and one for her todo list. This can simplify the implementation of permissions (this app has access to these document types) and can improve performance. CouchDB queries work with views. A view is defined ahead of its usage and is built by CouchDB when it is requested and is stale, i.e. there were writes in the database since the last time it was updated. So, with a single database per user, it s possible to experience lag when the todolist view is requested after fetching a long list of emails. By splitting the databases per doctypes, we gain on two fronts: The views are updated less frequently, only when documents of the matching doctypes are written. Some views are no longer necessary: those to access documents of a specific doctypes. There are downsides, mostly: It can be harder to manage more databases. It s no longer possible to use a single view for documents from doctypes that are no longer in the same database. We think that we can work on that and the pros will outweigh the cons.","title":"Databases"},{"location":"/cozy-stack/architecture/#metrics","text":"The Cozy Stack can generate some metrics about its usage (the size of the files transfered, the number of opened connexions, the number of requests to redis, etc.) and export them to a metrics backend. It will help identify the bottlenecks when scaling to add more users. The Warp 10 Platform looks like a good candidate for this.","title":"Metrics"},{"location":"/cozy-stack/architecture/#glossary","text":"","title":"Glossary"},{"location":"/cozy-stack/architecture/#instance","text":"An instance is a logical space owned by a user and identified by a domain. For example, zoe.cozycloud.cc can be the cozy instance of Zo\u00e9. This instance has a space for storing files and some CouchDB databases for storing the documents of its owner.","title":"Instance"},{"location":"/cozy-stack/architecture/#environment","text":"When creating an instance, it s possible to give an environment, dev , test or prod . The default apps won t be the same on all environments. For example, in the dev environment, some devtools will be installed to help the front developers to create their own apps.","title":"Environment"},{"location":"/cozy-stack/architecture/#cozy-stack-build-mode","text":"The cozy stack can run in several modes, set by a UNIX environment variable: production , the default development , for coding on the cozy stack. This mode is set when compiling the cozy-stack. It is used to show more or less logs, and what is acceptable to be displayed in errors. Even if the Cozy Stack Build Mode and Environment have similar values, they are not the same. The Cozy Stack Mode will be used by core developers to hack on the cozy stack. The environment will be used by front developers to hack on cozy apps.","title":"Cozy Stack Build Mode"},{"location":"/cozy-stack/architecture/#services","text":"The cozy stack came with several services. They run on the server, inside the golang process and have an HTTP interface.","title":"Services"},{"location":"/cozy-stack/architecture/#authentication-auth","text":"The cozy stack can authenticate the owner of a cozy instance. This can happen in the classical web style, with a form and a cookie, but also with OAuth2 for remote interactions like cozy-mobile and cozy-desktop.","title":"Authentication /auth"},{"location":"/cozy-stack/architecture/#applications-apps","text":"It s possible to manage serverless applications from the cozy stack and serve them via cozy stack. The stack does the routing and serve the HTML and the assets for the applications. The assets of the applications are installed in the virtual file system. On the big instances, it means that even if it is the frontal 1 that installs the application, frontal 2 will still be able to serve the application by getting its assets from Swift. It will be possible to install applications from several sources (git, mercurial, npm or even just a tarball). Also, we want to offer two channels for our official apps: one with a stable and well tested release, and one with more frequent updates for our more adventurous users. More informations here .","title":"Applications /apps"},{"location":"/cozy-stack/architecture/#data-system-data","text":"CouchDB is used for persistence of JSON documents. The data service is a layer on top of it for routing the requests to the corresponding CouchDB database and checking the permissions. In particular, a serverless application can declare some contexts and access data in those contexts even if it s not the owner of the cozy instance that access it. For example, the owner of a cozy can create a photo album with a selection of photos. This album can then be associated to a context to be shared with friends of the owner. These friends can access the album and see the photos, but not anonymous people. More informations here .","title":"Data System /data"},{"location":"/cozy-stack/architecture/#virtual-file-system-files","text":"It s possible to store files on the cozy, including binary ones like photos and movies, thanks to the virtual file system. It s a facade, with several implementations, depending on where the files are effectively stored: In a directory of a local file system (easier for self-hosted users) Swift from Open Stack (convenient for massive hosting) And more storage providers, like minio , later. The range of possible operations with this endpoint goes from simple ones, like uploading a file, to more complex ones, like renaming a folder. It also ensure that an instance is not exceeding its quota, and keeps a trash to recover files recently deleted. More informations here .","title":"Virtual File System /files"},{"location":"/cozy-stack/architecture/#sharing-sharings","text":"Users will want to share things like calendars. This service is there for sharing JSON documents between cozy instances, with respect to the access control.","title":"Sharing /sharings"},{"location":"/cozy-stack/architecture/#jobs-jobs","text":"The cozy stack has queues where job descriptions can be put. For example, a job can be to fetch the latest bills from a specific provider. These queues can be consumed by external workers to complete the associated jobs. We can imagine having a media worker that extract thumbnails from photos and videos. It will fetch jobs from a media queue and each job description will contain the path to the photo or video from which the thumbnail will be extracted. There is also a scheduler that acts like a crontab. It can add jobs at recurrent time. For example, it can add a job for fetching github commits every hour. Later, we can dream about having more ways to create jobs (webhooks, on document creation) and make them communicate. With a web interface on that, it can become a simplified Ifttt .","title":"Jobs /jobs"},{"location":"/cozy-stack/architecture/#sync-sync","text":"This endpoint will be for synchronizing your contacts and calendars by using standard methods like caldav and carddav. Later, we hope to support also Webdav and RemoteStorage.","title":"Sync /sync"},{"location":"/cozy-stack/architecture/#settings-settings","text":"Each cozy instance has some settings, like its domain name, its language, the name of its owner, the background for the home, etc.","title":"Settings /settings"},{"location":"/cozy-stack/architecture/#notifications-notifications","text":"The applications can put some notifications for the user. That goes from a reminder for a meeting in 10 minutes to a suggestion to update your app.","title":"Notifications /notifications"},{"location":"/cozy-stack/architecture/#real-time-realtime","text":"This endpoint can be used to subscribe for real-time events. An application that shows items of a specific doctype can listen for this doctype to be notified of all the changes for this doctype. For example, the calendar app can listen for all the events and if a synchronization with the mobile adds a new event, the app will be notified and can show this new event.","title":"Real-time /realtime"},{"location":"/cozy-stack/architecture/#error-catcher-errors","text":"Client-side applications can have some JS errors. By sending the error, with its backtrace, to this endpoint, it will be kept in a logfile to help the developers debug the application later. We should look at the airbrake API and probably be compatible with it to avoid redeveloping JS code to send the errors.","title":"Error catcher /errors"},{"location":"/cozy-stack/architecture/#proxy-proxy","text":"It can be useful for client-side apps to get data from public APIs. But, sometimes, these APIs don t have CORS enabled. A proxy endpoint can be a simple but effective solution for these cases.","title":"Proxy /proxy"},{"location":"/cozy-stack/architecture/#status-status","text":"It s here just to say that the API is up and that it can access the CouchDB databases, for debugging and monitoring purposes.","title":"Status /status"},{"location":"/cozy-stack/architecture/#workers","text":"The workers take jobs from the queues and process them.","title":"Workers"},{"location":"/cozy-stack/architecture/#fetch-emails-jobsmailbox","text":"It fetches a mailbox to synchronize it and see if there are some new emails. Payload: the mailbox","title":"Fetch emails /jobs/mailbox"},{"location":"/cozy-stack/architecture/#send-email-jobssendmail","text":"It connects to the SMTP server to send an email. Payload: mail account, recipient, body, attachments","title":"Send email /jobs/sendmail"},{"location":"/cozy-stack/architecture/#extract-metadata-jobsmetadata","text":"When a file is added or updated, this worker will extract its metadata (EXIF for an image, id3 for a music, etc.) Payload: the filepath","title":"Extract metadata /jobs/metadata"},{"location":"/cozy-stack/architecture/#konnectors-jobskonnector","text":"It synchronizes an account on a remote service (fetch bills for example). Payload: the kind of konnector, the credentials of the account and some optional parameters (like the folder where to put the files)","title":"Konnectors /jobs/konnector"},{"location":"/cozy-stack/architecture/#registry-jobsregistry","text":"It updates the list of available applications. Payload: none","title":"Registry /jobs/registry"},{"location":"/cozy-stack/architecture/#indexer-jobsindexer","text":"When a JSON document is added, updated or deleted, this worker will update the index for full text search. Bleve looks like a good candidate for the indexing and full text search technology. Payload: the doctype and the document to index","title":"Indexer /jobs/indexer"},{"location":"/cozy-stack/architecture/#serverless-apps","text":"","title":"Serverless apps"},{"location":"/cozy-stack/architecture/#home-appshome","text":"It s where you land on your cozy and launch your apps. Having widgets to display informations would be nice too!","title":"Home /apps/home"},{"location":"/cozy-stack/architecture/#store-was-marketplace-appsstore","text":"You can install new apps here.","title":"Store (was marketplace) /apps/store"},{"location":"/cozy-stack/architecture/#settings-was-my-apps-appssettings","text":"It s a list of your installed apps and devices, and you can configure some settings like your email address.","title":"Settings (was My apps) /apps/settings"},{"location":"/cozy-stack/architecture/#collect-was-konnectors-appscollect","text":"You can configure new accounts, to fetch data from them, and see the already configured accounts.","title":"Collect (was konnectors) /apps/collect"},{"location":"/cozy-stack/architecture/#devtools-appsdevtools","text":"Some tools for the developpers of applications only: an API console, documentation, logs of the permission checks, etc.","title":"Devtools /apps/devtools"},{"location":"/cozy-stack/architecture/#contacts-appscontacts","text":"Manage your contact books.","title":"Contacts /apps/contacts"},{"location":"/cozy-stack/architecture/#calendar-appscalendar","text":"Manage your events and alarms.","title":"Calendar /apps/calendar"},{"location":"/cozy-stack/architecture/#drive-appsdrive","text":"A web interface to browse your files.","title":"Drive /apps/drive"},{"location":"/cozy-stack/architecture/#photos-appsphotos","text":"Organize your photos and share them with friends.","title":"Photos /apps/photos"},{"location":"/cozy-stack/architecture/#todo-list-appstodo","text":"A task manager to never forgot what you should do.","title":"Todo list /apps/todo"},{"location":"/cozy-stack/architecture/#onboarding-appsonboarding","text":"Start your cozy and setup your accounts.","title":"Onboarding /apps/onboarding"},{"location":"/cozy-stack/architecture/#clients","text":"","title":"Clients"},{"location":"/cozy-stack/architecture/#mobile","text":"Cozy-mobile is an application for android and iOS for synchronizing files, contacts and calendars between the phone and the cozy instance.","title":"Mobile"},{"location":"/cozy-stack/architecture/#desktop","text":"Cozy-desktop is a client for Linux, OSX and windows that allows to sync the files in a cozy instance with a laptop or desktop.","title":"Desktop"},{"location":"/cozy-stack/architecture/#guidelines","text":"","title":"Guidelines"},{"location":"/cozy-stack/architecture/#the-go-programming-language","text":"Go (often referred as golang) is an open source programming language created at Google in 2007. It has nice properties for our usage: Simplicity (the language can be learned in weeks, not years). A focus on productivity. Good performance. A good support of concurrency with channels and goroutines. Moreover, Go is used by a lot of companies , is in the Top 10 of the most used languages and has some known open source projects: docker, kubernetes, grafana, syncthing, influxdb, caddy, etc. And it works on the ARM platforms . Go has some tools to help the developers to format its code ( go fmt ), retrieve and install external packages ( go get ), display documentation ( godoc ), check for potential errors with static analysis ( go vet ), etc. Most of them can be used via gometalinter , which is nice for continuous integration. So, we think that writing the Cozy Stack in Go is the right choice.","title":"The Go Programming Language"},{"location":"/cozy-stack/architecture/#repository-organisation","text":"\u251c\u2500\u2500 assets The assets for the front-end \u2502 \u251c\u2500\u2500 images The images \u2502 \u251c\u2500\u2500 scripts The javascript files \u2502 \u251c\u2500\u2500 styles The CSS files \u2502 \u2514\u2500\u2500 templates The HTML templates \u251c\u2500\u2500 cmd One .go file for each command of the cozy executable \u251c\u2500\u2500 docs Documentation, including this file \u251c\u2500\u2500 pkg One sub-directory for each golang package \u251c\u2500\u2500 scripts Some shell scripts for developers and testing \u2514\u2500\u2500 web One sub-directory for each of the services listed above","title":"Repository organisation"},{"location":"/cozy-stack/architecture/#rest-api","text":"We follow the best practices about Rest API (using the right status codes, HTTP verbs, organise code by resources, use content-negociation, etc.). When known standards make sense (caldav carddav for example), use them. Else, JSON API is a good default. The golang web framework used for the cozy stack is Echo .","title":"Rest API"},{"location":"/cozy-stack/architecture/#http-status-codes","text":"There are some HTTP status codes that are generally used in the API: 200 OK, when everything is OK 201 Created, when a resource was created 204 No Content, when a resource was deleted 400 Bad Request, when the request has some unknown parameters and the request body is not in the expected format 401 Unauthorized, when the user is not authenticated 403 Forbidden, when the permissions forbid this action 404 Not Found, when the resouce can t be found 500 Internal Server Error, when a bug occurs 503 Service Unavailable, when the stack, CouchDB, Redis or Swift is unavailable.","title":"HTTP status codes"},{"location":"/cozy-stack/architecture/#doctypes","text":"Each JSON document saved in CouchDB has a field docType that identify the kind of thing it is. For example, a contact will have the docType io.cozy.contacts , and in the cozy-doctypes repository, there will be a contacts JSON file inside it that describes this doctype: What are the mandatory and optional fields? What is the type (string, integer, date) of the fields? Is there a validation rule for a field? How the fields can be indexed for full text search? What is the role of each field (documentation)? This description can be used by any cozy client library (JS, Golang, etc.) to generate some models to simplify the use of documents of this doctype. When a docType has a lot of logic (calendar events for example), a JS class should be shared between the several client-side apps that use this docType, in order to avoid recoding this logic in each application.","title":"DocTypes"},{"location":"/cozy-stack/architecture/#import-and-export","text":"You will stay because you can leave. An important promise of Cozy is to give back to the users the control of their data. And this promise is not complete with a way to export the data to use it somewhere else. The Cozy Stack will offer an export button that gives a tarball to the user with the full data. She can then import it on another instance for example. It should also be possible to use the data outside of Cozy. So, the format for the tarball should be as simple as possible and be documented. Of course, when it s possible, we will use open formats.","title":"Import and export"},{"location":"/cozy-stack/architecture/#how-to-contribute","text":"Cozy s DNA is fundamentally Open Source and we want our community to thrive. Having contributions (code, design, translations) is important for us and we will try to create the favorable conditions to support it.","title":"How to contribute?"},{"location":"/cozy-stack/architecture/#adding-a-new-konnector","text":"Adding a konnector is easy for someone who knows JavaScript. The repository has already a lot of pull requests by external contributors. The wiki has documentation to explain the first steps of creating a new konnector. 3 active contributors have been promoted to the maintainers team and can merge the pull requests. We have done workshops to help new developers code their first konnector and we will keep doing it.","title":"Adding a new konnector"},{"location":"/cozy-stack/architecture/#creating-a-new-application","text":"One of the goals of the new architecture is to make it easier for developers to write new apps. It means having a good documentation, but also some devtools to help: The cozy executable will have a command to setup a new project. The devtools on the cozy interface will give documentation about the doctypes, help explore the Rest API, and check if the permissions are OK. cozy-ui will make it easy to reuse some widgets and offer an application with a style coherent to the cozy identity. Some docTypes with heavy logic will be available as JS classes to be reused in the apps.","title":"Creating a new application"},{"location":"/cozy-stack/architecture/#reporting-a-bug-or-suggesting-a-new-feature","text":"We are listening to our users. The forum is here to discuss on many subjects, including how the applications are used. The issues on github are a good place for bug tracking.","title":"Reporting a bug or suggesting a new feature"},{"location":"/cozy-stack/architecture/#translating-to-a-new-language","text":"We will keep having internationalization for our applications and the translations are maintained on transifex by the community. Translating to a new language, or reviewing an existing one, is really appreciated.","title":"Translating to a new language"},{"location":"/cozy-stack/architecture/#faq","text":"Does the current konnectors in nodejs will be lost? No, they won t. The business logic to scrap data from the many sources will be kept and they will be adapted to fit in this new architecture. It is explained how we will do that here . So, it s not possible to have a custom application with a server part, like the lounge IRC client? We want to support this use case, just not on the short term. It s not clear how we can do that (while not weakening the security). One idea is to run the applications in a different server, or maybe in docker. How to install and update cozy? The Cozy Stack will have no auto-update mechanism. For installing and updating it, you can use the classical ways: Using a package manager, like apt for debian ubuntu. Using an official image for Raspberry Pi (and other embedded platforms). Using the image and services of an hosting company. Or compiling and installing it manually if you are really brave ;-) How to add a cozy instance to a farm? Choose a (sub-)domain and configure the DNS for this (sub-)domain. Configure the reverse-proxy to accept this (sub-)domain. Use the cozy executable to configure the cozy stack. How to migrate from the nodejs cozy to this new architecture for cozy? Export the data from the nodejs cozy (we need to add a button in the web interface for that in the coming months). Install the new cozy. Import the data. Please note that we don t support a continuous replication method that will enable to use both the nodejs and the new architecture at the same time. It looks too complicated for a temporary thing. How to backup the data? There are 2 sensitive places with data: In CouchDB. on the place used for the Virtual File System (a directory on the local filesystem, or in Swift). You can use the tools of your choice to backup these 2 locations. The good old rsync works fine (CouchDB files are append-only, except when compaction happens, so it s friendly to rsync). It s highly recommended to have an automated backup, but sometimes it can be useful to have a way to backup manually the data. The export data button in the web interface give a tarball that can be used to transfer your data from one instance to another, and so, it can be used as a backup. Aren t microservices better for scaling? Yes, it s often easier to scale by separating concerns, and microservices is a way to achieve that. But, it has some serious downsides: It takes more memory and it s probably a no-go for Raspberry Pi. It s more complicated for a developper to install the whole stack before coding its application. It s harder to deploy in production. For the scalability, we can also deploy some specialized instances of the Cozy Stack. For example, we can have some Cozy Stack processes dedicated for real-time. Even, if they have all the code, we can route only the relevant trafic from the load-balancer. What are the frameworks and tools used for the front-end apps? If you want to develop your own app, you can use the framework and the tools you like, nothing is mandatory. For the official apps, we will want to move to: es2017 (but converting the existing coffeescript code will take time) npm scripts and webpack preact JSX. More about this here When will this new architecture be available? The roadmap for Cozy v3 has been explained on our blog: https://blog.cozycloud.cc/post/2016/11/21/On-the-road-to-Cozy-version-3","title":"FAQ"},{"location":"/cozy-stack/security/","text":"Table of contents Security Checklist Strong security is centered on the user Defense in depth is still worthy Have a strict control of all the accesses to the Cozy Protect client-side apps by default Don t trust inputs, always sanitize them Encryption is not the solution to all the problems, but it helps Use standards (https, OAuth2) Have a reliable way to deploy, with sane defaults No one is perfect, code must be reviewed Be open to external contributors Rationale Strong security is centered on the user For systems well designed, the user is often the weakest link in the security chain. Engineers have a tendancy to overestimate the technical risks and underestimate the human interactions. It doesn t mean that we can avoid technical measures. But it s very important to take in account the possible behaviour of the user. That means that adding a text to explain him/her the consequences of a click on a button can increase the security a lot much than forcing him/her to do things. For example, forcing users to change regulary their password makes them choose passwords that are a lot weaker (but easier for them to remember). Defense in depth is still worthy Also known as layered defense, defense in depth is a security principle where single points of complete compromise are eliminated or mitigated by the incorporation of a series or multiple layers of security safeguards and risk-mitigation countermeasures. Have diverse defensive strategies, so that if one layer of defense turns out to be inadequate, another layer of defense will hopefully prevent a full breach. Have a strict control of all the accesses to the Cozy All the requests to the cozy stack have a strict access control. It is based on several informations: Is the user connected? What is the application that makes this request? What are the permissions for this application? Which grant is used, in particular for applications with public pages? What are the permissions for this grant? More informations here . Protect client-side apps by default This is mostly applying the state of the art: Using HTTPS, with HSTS. Using secure, httpOnly, sameSite cookies to avoid cookies theft or misuse. Using a Content Security Policy (CSP). Using X-frame-options http header to protect against click-jacking. But we will use a CSP very restrictive by default (no access to other web domains for example). Don t trust inputs, always sanitize them If we take the OWASP top 10 vulnerabilities , we can see that a lot of them are related to trusting inputs. It starts with the first one, injections, but it goes also to XSS and unvalidated forwards (in OAuth2 notably). Always sanitizing inputs is a good pratice that improves security, but has also some nice effects like helping developers discover hidden bugs. Encryption is not the solution to all the problems, but it helps Some data are encrypted before being saved in CouchDB (passwords for the accounts for example). Encrypting everything has some downsides: It s not possible to index encryped documents or do computations on the encrypted fields in reasonable time ( homomorphic encryption is still an open subject). Having more encrypted data can globally weaken the encryption, if it s not handled properly. If the encryption key is lost or a bug happen, the data is lost with no way to recover them. So, we are more confortable to encrypt only some fields. And later, when we will have more experience and feedbacks from the user, extend the encryption to more fields. We are also working with SMIS , a research lab, to find a way to securely store and backup the encryption keys. Use standards (https, OAuth2) Standards like https and OAuth2 had a lot of eyes to look at them, and are therefore more robust. Reinventing the wheel can be valuable for some things. But for security, the cost is very high and only some very particular constraints can justify such an high cost. Cozy don t have these constraints, so we will stick to the standards. Have a reliable way to deploy, with sane defaults It s important that deploying a cozy is well documented, doesn t require too many steps and can be automatized. An error on the installation can have dramatic effects, like the database being leaked on internet. So, we need to really take care of the devops experience. In particular, having sane defaults for the configuration will help to minimize the number of things he/she has to do, and such the number of places where he/she can make faux pas. No one is perfect, code must be reviewed No code is directly pushed to the master branch in git. It has to be reviewed by at least one member of the core team (ideally the whole team), and this person can t be the author of the change. Even the best developers can make mistakes, and we don t pretend to be them. Our force is to work as team. Be open to external contributors Our code is Open Source, external contributors can review it. If they (you?) find a weakness, please contact us by sending an email to security AT cozycloud.cc. This is a mailing-list specially setup for responsible disclosure of security weaknesses in Cozy. We will respond in less than 72 hours. When a security flaw is found, the process is the following: Make a pull-request to fix (on our private git instance) and test it. Deploy the fix on cozycloud.cc Publish a new version, announce it on the forum as a security update and on the mailing-lists. 15 days later, add the details on the forum.","title":"Security"},{"location":"/cozy-stack/security/#security","text":"","title":"Security"},{"location":"/cozy-stack/security/#checklist","text":"Strong security is centered on the user Defense in depth is still worthy Have a strict control of all the accesses to the Cozy Protect client-side apps by default Don t trust inputs, always sanitize them Encryption is not the solution to all the problems, but it helps Use standards (https, OAuth2) Have a reliable way to deploy, with sane defaults No one is perfect, code must be reviewed Be open to external contributors","title":"Checklist"},{"location":"/cozy-stack/security/#rationale","text":"","title":"Rationale"},{"location":"/cozy-stack/security/#strong-security-is-centered-on-the-user","text":"For systems well designed, the user is often the weakest link in the security chain. Engineers have a tendancy to overestimate the technical risks and underestimate the human interactions. It doesn t mean that we can avoid technical measures. But it s very important to take in account the possible behaviour of the user. That means that adding a text to explain him/her the consequences of a click on a button can increase the security a lot much than forcing him/her to do things. For example, forcing users to change regulary their password makes them choose passwords that are a lot weaker (but easier for them to remember).","title":"Strong security is centered on the user"},{"location":"/cozy-stack/security/#defense-in-depth-is-still-worthy","text":"Also known as layered defense, defense in depth is a security principle where single points of complete compromise are eliminated or mitigated by the incorporation of a series or multiple layers of security safeguards and risk-mitigation countermeasures. Have diverse defensive strategies, so that if one layer of defense turns out to be inadequate, another layer of defense will hopefully prevent a full breach.","title":"Defense in depth is still worthy"},{"location":"/cozy-stack/security/#have-a-strict-control-of-all-the-accesses-to-the-cozy","text":"All the requests to the cozy stack have a strict access control. It is based on several informations: Is the user connected? What is the application that makes this request? What are the permissions for this application? Which grant is used, in particular for applications with public pages? What are the permissions for this grant? More informations here .","title":"Have a strict control of all the accesses to the Cozy"},{"location":"/cozy-stack/security/#protect-client-side-apps-by-default","text":"This is mostly applying the state of the art: Using HTTPS, with HSTS. Using secure, httpOnly, sameSite cookies to avoid cookies theft or misuse. Using a Content Security Policy (CSP). Using X-frame-options http header to protect against click-jacking. But we will use a CSP very restrictive by default (no access to other web domains for example).","title":"Protect client-side apps by default"},{"location":"/cozy-stack/security/#dont-trust-inputs-always-sanitize-them","text":"If we take the OWASP top 10 vulnerabilities , we can see that a lot of them are related to trusting inputs. It starts with the first one, injections, but it goes also to XSS and unvalidated forwards (in OAuth2 notably). Always sanitizing inputs is a good pratice that improves security, but has also some nice effects like helping developers discover hidden bugs.","title":"Don't trust inputs, always sanitize them"},{"location":"/cozy-stack/security/#encryption-is-not-the-solution-to-all-the-problems-but-it-helps","text":"Some data are encrypted before being saved in CouchDB (passwords for the accounts for example). Encrypting everything has some downsides: It s not possible to index encryped documents or do computations on the encrypted fields in reasonable time ( homomorphic encryption is still an open subject). Having more encrypted data can globally weaken the encryption, if it s not handled properly. If the encryption key is lost or a bug happen, the data is lost with no way to recover them. So, we are more confortable to encrypt only some fields. And later, when we will have more experience and feedbacks from the user, extend the encryption to more fields. We are also working with SMIS , a research lab, to find a way to securely store and backup the encryption keys.","title":"Encryption is not the solution to all the problems, but it helps"},{"location":"/cozy-stack/security/#use-standards-https-oauth2","text":"Standards like https and OAuth2 had a lot of eyes to look at them, and are therefore more robust. Reinventing the wheel can be valuable for some things. But for security, the cost is very high and only some very particular constraints can justify such an high cost. Cozy don t have these constraints, so we will stick to the standards.","title":"Use standards (https, OAuth2)"},{"location":"/cozy-stack/security/#have-a-reliable-way-to-deploy-with-sane-defaults","text":"It s important that deploying a cozy is well documented, doesn t require too many steps and can be automatized. An error on the installation can have dramatic effects, like the database being leaked on internet. So, we need to really take care of the devops experience. In particular, having sane defaults for the configuration will help to minimize the number of things he/she has to do, and such the number of places where he/she can make faux pas.","title":"Have a reliable way to deploy, with sane defaults"},{"location":"/cozy-stack/security/#no-one-is-perfect-code-must-be-reviewed","text":"No code is directly pushed to the master branch in git. It has to be reviewed by at least one member of the core team (ideally the whole team), and this person can t be the author of the change. Even the best developers can make mistakes, and we don t pretend to be them. Our force is to work as team.","title":"No one is perfect, code must be reviewed"},{"location":"/cozy-stack/security/#be-open-to-external-contributors","text":"Our code is Open Source, external contributors can review it. If they (you?) find a weakness, please contact us by sending an email to security AT cozycloud.cc. This is a mailing-list specially setup for responsible disclosure of security weaknesses in Cozy. We will respond in less than 72 hours. When a security flaw is found, the process is the following: Make a pull-request to fix (on our private git instance) and test it. Deploy the fix on cozycloud.cc Publish a new version, announce it on the forum as a security update and on the mailing-lists. 15 days later, add the details on the forum.","title":"Be open to external contributors"},{"location":"/cozy-stack/INSTALL/","text":"How to install Cozy-stack? Dependencies A reverse-proxy (nginx, caddy, haproxy, etc.) A SMTP server CouchDB 2 Git Image Magick To install CouchDB 2 through Docker, take a look at our Docker specific documentation . Note: to generate thumbnails for heic/heif images, the version 7.0.7-22 of Image Magick is required. Install for self-hosting We have started to write documentation on how to install cozy on your own server. The guide is still work in progress. So, don t hesitate to report issues with it. It will help us improve it. Install for development / local tests Install the binary You can either download the binary or compile it. Download an official release You can download a cozy-stack binary from our official releases: https://github.com/cozy/cozy-stack/releases. It is a just a single executable file (choose the one for your platform). Rename it to cozy-stack, give it the executable bit ( chmod +x cozy-stack ) and put it in your $PATH . cozy-stack version should show you the version if every thing is right. Using go Install go , version = 1.9. With go installed and configured, you can run the following command: go get -u github.com/cozy/cozy-stack This will fetch the sources in $GOPATH/src/github.com/cozy/cozy-stack and build a binary in $GOPATH/bin/cozy-stack . Don t forget to add your $GOPATH to your $PATH in your *rc file so that you can execute the binary without entering its full path. export PATH= $(go env GOPATH)/bin:$PATH Add an instance for testing You can configure your cozy-stack using a configuration file or different comand line arguments. Assuming CouchDB is installed and running on default port 5984 , you can start the server: cozy-stack serve And then create an instance for development: cozy-stack instances add --dev --apps drive,photos,settings --passphrase cozy cozy.tools:8080 The cozy-stack server listens on http://cozy.tools:8080/ by default. See cozy-stack --help for more informations. The above command will create an instance on http://cozy.tools:8080/ with the passphrase cozy . Make sure the full stack is up with: curl -H 'Accept: application/json' 'http://cozy.tools:8080/status/' You can then remove your test instance: cozy-stack instances rm cozy.tools:8080","title":"Install the cozy-stack"},{"location":"/cozy-stack/INSTALL/#how-to-install-cozy-stack","text":"","title":"How to install Cozy-stack?"},{"location":"/cozy-stack/INSTALL/#dependencies","text":"A reverse-proxy (nginx, caddy, haproxy, etc.) A SMTP server CouchDB 2 Git Image Magick To install CouchDB 2 through Docker, take a look at our Docker specific documentation . Note: to generate thumbnails for heic/heif images, the version 7.0.7-22 of Image Magick is required.","title":"Dependencies"},{"location":"/cozy-stack/INSTALL/#install-for-self-hosting","text":"We have started to write documentation on how to install cozy on your own server. The guide is still work in progress. So, don t hesitate to report issues with it. It will help us improve it.","title":"Install for self-hosting"},{"location":"/cozy-stack/INSTALL/#install-for-development-local-tests","text":"","title":"Install for development / local tests"},{"location":"/cozy-stack/INSTALL/#install-the-binary","text":"You can either download the binary or compile it.","title":"Install the binary"},{"location":"/cozy-stack/INSTALL/#download-an-official-release","text":"You can download a cozy-stack binary from our official releases: https://github.com/cozy/cozy-stack/releases. It is a just a single executable file (choose the one for your platform). Rename it to cozy-stack, give it the executable bit ( chmod +x cozy-stack ) and put it in your $PATH . cozy-stack version should show you the version if every thing is right.","title":"Download an official release"},{"location":"/cozy-stack/INSTALL/#using-go","text":"Install go , version = 1.9. With go installed and configured, you can run the following command: go get -u github.com/cozy/cozy-stack This will fetch the sources in $GOPATH/src/github.com/cozy/cozy-stack and build a binary in $GOPATH/bin/cozy-stack . Don t forget to add your $GOPATH to your $PATH in your *rc file so that you can execute the binary without entering its full path. export PATH= $(go env GOPATH)/bin:$PATH","title":"Using go"},{"location":"/cozy-stack/INSTALL/#add-an-instance-for-testing","text":"You can configure your cozy-stack using a configuration file or different comand line arguments. Assuming CouchDB is installed and running on default port 5984 , you can start the server: cozy-stack serve And then create an instance for development: cozy-stack instances add --dev --apps drive,photos,settings --passphrase cozy cozy.tools:8080 The cozy-stack server listens on http://cozy.tools:8080/ by default. See cozy-stack --help for more informations. The above command will create an instance on http://cozy.tools:8080/ with the passphrase cozy . Make sure the full stack is up with: curl -H 'Accept: application/json' 'http://cozy.tools:8080/status/' You can then remove your test instance: cozy-stack instances rm cozy.tools:8080","title":"Add an instance for testing"},{"location":"/cozy-stack/cli/cozy-stack/","text":"cozy-stack cozy-stack is the main command Synopsis Cozy is a platform that brings all your web services in the same private space. With it, your web apps and your devices can share data easily, providing you with a new experience. You can install Cozy on your own hardware where no one profiles you. cozy-stack [flags] Options --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) -h, --help help for cozy-stack --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack apps - Interact with the applications cozy-stack bug - start a bug report cozy-stack completion - Output shell completion code for the specified shell cozy-stack config - Show and manage configuration elements cozy-stack doc - Print the documentation cozy-stack files - Interact with the cozy filesystem cozy-stack fixer - A set of tools to fix issues or migrate content for retro-compatibility. cozy-stack instances - Manage instances of a stack cozy-stack konnectors - Interact with the konnectors cozy-stack serve - Starts the stack and listens for HTTP calls cozy-stack settings - Display and update settings cozy-stack status - Check if the HTTP server is running cozy-stack triggers - Interact with the triggers cozy-stack version - Print the version number","title":"Manpages of the command-line tool"},{"location":"/cozy-stack/cli/cozy-stack/#cozy-stack","text":"cozy-stack is the main command","title":"cozy-stack"},{"location":"/cozy-stack/cli/cozy-stack/#synopsis","text":"Cozy is a platform that brings all your web services in the same private space. With it, your web apps and your devices can share data easily, providing you with a new experience. You can install Cozy on your own hardware where no one profiles you. cozy-stack [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack/#options","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) -h, --help help for cozy-stack --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack/#see-also","text":"cozy-stack apps - Interact with the applications cozy-stack bug - start a bug report cozy-stack completion - Output shell completion code for the specified shell cozy-stack config - Show and manage configuration elements cozy-stack doc - Print the documentation cozy-stack files - Interact with the cozy filesystem cozy-stack fixer - A set of tools to fix issues or migrate content for retro-compatibility. cozy-stack instances - Manage instances of a stack cozy-stack konnectors - Interact with the konnectors cozy-stack serve - Starts the stack and listens for HTTP calls cozy-stack settings - Display and update settings cozy-stack status - Check if the HTTP server is running cozy-stack triggers - Interact with the triggers cozy-stack version - Print the version number","title":"SEE ALSO"},{"location":"/cozy-stack/config/","text":"Table of contents Configuration Main Configuration file You can configure your cozy-stack using a configuration file. This file should be named cozy.yaml or cozy.json depending on the format of your chosing, and should be present in one of these directories (ordered by priority): ./.cozy $HOME/.cozy /etc/cozy The path of the configuration file can also be define from an absolute path given by the --config (or -c ) flag of the cozy-stack command . Templating and Environment Variables It is possible to pass environnment variable to this configuration using the template language of golang , delimited by {{ and }} . The environment variables are available in the .Env variable. For instance the text {{.Env.COUCHDB_PASSPHRASE }} will be replaced by the value of the COUCHDB_PASSPHRASE environment variable. The template is evaluated at startup of the stack. Values and Example To see the detail of the available parameters available, you can see an example of configuration in the cozy.example.yaml file at the root of this repository. This file contains all the parameters and fields that can be used to configure the stack with some example values. Some fields can be overriden by the flags of the cozy-stack serve command . Stack endpoints By default, cozy-stack use plain-text local socket for client ( localhost:8080 ) and admin ( localhost:6060 ) communications. If you want to control a remote stack or using TLS to secure communications, you can configure your cozy-stack client with the following CLI arguments or environment variables. Argument Env variable Default value Usage --host / --admin-host COZY_HOST / COZY_ADMIN_HOST localhost `[http[s]://] [: ]` --port / --admin-port COZY_PORT / COZY_ADMIN_PORT 8080 / 6060 COZY_HOST_TIMEOUT / COZY_ADMIN_TIMOUT 15s HTTP timeout to use Must be [a valid golang duration](https://golang.org/pkg/time/#ParseDuration) like `10s` or `1m` COZY_HOST_VALIDATE / COZY_ADMIN_VALIDATE true Enable HTTPS certificate validation Can also be set via host URL query part, like `https://localhost:6060?validate=false` COZY_HOST_CA / COZY_ADMIN_CA none CA file to use for HTTPS certificate validation Can also be set via host URL query part, like `https://localhost:6060?ca= ` COZY_HOST_CERT / COZY_ADMIN_CERT none Client certificate to use Can also be set via host URL query part, like `https://localhost:6060?cert= ` COZY_HOST_KEY / COZY_ADMIN_KEY none Client certificate to use Can also be set via host URL query part, like `https://localhost:6060?key= ` COZY_HOST_FINGERPRINT / COZY_ADMIN_FINGERPRINT none Hex-encoded SHA-256 key pinning to use Can also be set via host URL query part, like `https://localhost:6060?fp= ` You can get the fingerprint of a given certificate with `openssl x509 -in -pubkey | openssl pkey -pubin -outform der | openssl dgst -sha256 -hex` Or directly from a private key with `openssl pkey -in -pubout -outform der | openssl dgst -sha256 -hex` Administration secret To access to the administration API (the /admin/* routes), a secret passphrase should be stored in a cozy-admin-passphrase . This file should be in one of the configuration directories, along with the main config file. The passphrase is stored in a salted-hashed representation using scrypt. To generate this file, you can use the cozy-stack config passwd [config directory] command. This command will ask you for a passphrase and will create the cozy-admin-passphrase in the specified directory. You can use the COZY_ADMIN_PASSWORD env variable if you do not want to type the passphrase each time you call cozy-stack . Example cozy-stack config passwd ~/.cozy # Hashed passphrase outputed in ~/.cozy/cozy-admin-passphrase cat ~/.cozy/cozy-admin-passphrase # scrypt$16384$8$1$936bd62faf633b5f946f653c21161a9b$4e0d11dfa5fc1676ed329938b11a6584d30e603e0d06b8a63a99e8cec392d682 Hooks Cozy-stack can run scripts on some events to customize it. The scripts must be in the hooks directory defined in the config, have a predefined name, and be executable. Then, they should be fired automatically. Let s the available hooks. The pre-add-instance hook is run just before creating an instance. It can prevent the command from running by exiting with non-zero status. It can be used to check the domain for example. It is called with the following parameter: the domain of the instance that will be created. The post-add-instance hook is run just after an instance has been created. installed. It can be used to setup DNS for this instance for example. It is called with the following parameter: the domain of the instance that has been created. The pre-remove-instance hook is run just before destroying an instance. It can prevent the command from running by exiting with non-zero status. It can be used to make a backup of the instance before destroying it. It is called with the following parameter: the domain of the instance that will be destroyed. The post-remove-instance hook is run just after an instance has been destroyed. It can be used to do some cleanup. It is called with the following parameter: the domain of the instance that has been destroyed. The pre-install-app hook is run just before installing an application, and can prevent the command from running by exiting with non-zero status. It is called with the following parameters: the instance on which the application will be installed the application name that will be installed. The post-install-app hook is run just after an application has been installed. It can be used for logging, notification, statistics, etc. It s also a good place to add a vhost for an application in the reverse-proxy configuration, with a TLS certificate. It is called with the following parameters: the instance on which the application has been installed the application name that has been installed. The pre-uninstall-app hook is run just before uninstalling an application, and can prevent the command from running by exiting with non-zero status. It is called with the following parameters: the instance on which the application will be uninstalled the application name that will be uninstalled. The post-uninstall-app hook is run just after an application has been uninstalled. It can be used for cleaning the configuration of the reverse- proxy for example. It is called with the following parameters: the instance on which the application has been uninstalled the application name that has been uninstalled.","title":"Configuration file"},{"location":"/cozy-stack/config/#configuration","text":"","title":"Configuration"},{"location":"/cozy-stack/config/#main-configuration-file","text":"You can configure your cozy-stack using a configuration file. This file should be named cozy.yaml or cozy.json depending on the format of your chosing, and should be present in one of these directories (ordered by priority): ./.cozy $HOME/.cozy /etc/cozy The path of the configuration file can also be define from an absolute path given by the --config (or -c ) flag of the cozy-stack command .","title":"Main Configuration file"},{"location":"/cozy-stack/config/#templating-and-environment-variables","text":"It is possible to pass environnment variable to this configuration using the template language of golang , delimited by {{ and }} . The environment variables are available in the .Env variable. For instance the text {{.Env.COUCHDB_PASSPHRASE }} will be replaced by the value of the COUCHDB_PASSPHRASE environment variable. The template is evaluated at startup of the stack.","title":"Templating and Environment Variables"},{"location":"/cozy-stack/config/#values-and-example","text":"To see the detail of the available parameters available, you can see an example of configuration in the cozy.example.yaml file at the root of this repository. This file contains all the parameters and fields that can be used to configure the stack with some example values. Some fields can be overriden by the flags of the cozy-stack serve command .","title":"Values and Example"},{"location":"/cozy-stack/config/#stack-endpoints","text":"By default, cozy-stack use plain-text local socket for client ( localhost:8080 ) and admin ( localhost:6060 ) communications. If you want to control a remote stack or using TLS to secure communications, you can configure your cozy-stack client with the following CLI arguments or environment variables. Argument Env variable Default value Usage --host / --admin-host COZY_HOST / COZY_ADMIN_HOST localhost `[http[s]://] [: ]` --port / --admin-port COZY_PORT / COZY_ADMIN_PORT 8080 / 6060 COZY_HOST_TIMEOUT / COZY_ADMIN_TIMOUT 15s HTTP timeout to use Must be [a valid golang duration](https://golang.org/pkg/time/#ParseDuration) like `10s` or `1m` COZY_HOST_VALIDATE / COZY_ADMIN_VALIDATE true Enable HTTPS certificate validation Can also be set via host URL query part, like `https://localhost:6060?validate=false` COZY_HOST_CA / COZY_ADMIN_CA none CA file to use for HTTPS certificate validation Can also be set via host URL query part, like `https://localhost:6060?ca= ` COZY_HOST_CERT / COZY_ADMIN_CERT none Client certificate to use Can also be set via host URL query part, like `https://localhost:6060?cert= ` COZY_HOST_KEY / COZY_ADMIN_KEY none Client certificate to use Can also be set via host URL query part, like `https://localhost:6060?key= ` COZY_HOST_FINGERPRINT / COZY_ADMIN_FINGERPRINT none Hex-encoded SHA-256 key pinning to use Can also be set via host URL query part, like `https://localhost:6060?fp= ` You can get the fingerprint of a given certificate with `openssl x509 -in -pubkey | openssl pkey -pubin -outform der | openssl dgst -sha256 -hex` Or directly from a private key with `openssl pkey -in -pubout -outform der | openssl dgst -sha256 -hex`","title":"Stack endpoints"},{"location":"/cozy-stack/config/#administration-secret","text":"To access to the administration API (the /admin/* routes), a secret passphrase should be stored in a cozy-admin-passphrase . This file should be in one of the configuration directories, along with the main config file. The passphrase is stored in a salted-hashed representation using scrypt. To generate this file, you can use the cozy-stack config passwd [config directory] command. This command will ask you for a passphrase and will create the cozy-admin-passphrase in the specified directory. You can use the COZY_ADMIN_PASSWORD env variable if you do not want to type the passphrase each time you call cozy-stack .","title":"Administration secret"},{"location":"/cozy-stack/config/#example","text":"cozy-stack config passwd ~/.cozy # Hashed passphrase outputed in ~/.cozy/cozy-admin-passphrase cat ~/.cozy/cozy-admin-passphrase # scrypt$16384$8$1$936bd62faf633b5f946f653c21161a9b$4e0d11dfa5fc1676ed329938b11a6584d30e603e0d06b8a63a99e8cec392d682","title":"Example"},{"location":"/cozy-stack/config/#hooks","text":"Cozy-stack can run scripts on some events to customize it. The scripts must be in the hooks directory defined in the config, have a predefined name, and be executable. Then, they should be fired automatically. Let s the available hooks. The pre-add-instance hook is run just before creating an instance. It can prevent the command from running by exiting with non-zero status. It can be used to check the domain for example. It is called with the following parameter: the domain of the instance that will be created. The post-add-instance hook is run just after an instance has been created. installed. It can be used to setup DNS for this instance for example. It is called with the following parameter: the domain of the instance that has been created. The pre-remove-instance hook is run just before destroying an instance. It can prevent the command from running by exiting with non-zero status. It can be used to make a backup of the instance before destroying it. It is called with the following parameter: the domain of the instance that will be destroyed. The post-remove-instance hook is run just after an instance has been destroyed. It can be used to do some cleanup. It is called with the following parameter: the domain of the instance that has been destroyed. The pre-install-app hook is run just before installing an application, and can prevent the command from running by exiting with non-zero status. It is called with the following parameters: the instance on which the application will be installed the application name that will be installed. The post-install-app hook is run just after an application has been installed. It can be used for logging, notification, statistics, etc. It s also a good place to add a vhost for an application in the reverse-proxy configuration, with a TLS certificate. It is called with the following parameters: the instance on which the application has been installed the application name that has been installed. The pre-uninstall-app hook is run just before uninstalling an application, and can prevent the command from running by exiting with non-zero status. It is called with the following parameters: the instance on which the application will be uninstalled the application name that will be uninstalled. The post-uninstall-app hook is run just after an application has been uninstalled. It can be used for cleaning the configuration of the reverse- proxy for example. It is called with the following parameters: the instance on which the application has been uninstalled the application name that has been uninstalled.","title":"Hooks"},{"location":"/cozy-stack/instance/","text":"Table of contents Instances TODO it s still a work in progress that needs to be completed. A single cozy-stack can manage several instances. Requests to different instances are identified through the Host HTTP Header, any reverse proxy placed in front of the cozy-stack should forward this header. To simplify development, a dev instance name is used when no Host Header is provided. This behaviour will be kept when the stack is started in dev mode but will be blocked in production environment. Exemple: curl -H \"Host: bob.cozycloud.cc\" localhost:8080 \u2192 localhost:5984/bob-cozycloud.cc curl -H \"Host: alice.cozycloud.cc\" localhost:8080 \u2192 localhost:5984/alice-cozycloud.cc curl localhost:8080 \u2192 localhost:5984/dev (in dev mode only) Creation An instance is created on the command line: $ cozy-stack instances add domain With some possible additional options --locale lang --tz timezone --email email --apps app1,app2,app3 It registers the instance in a global couchdb database global/instances { hostname : example.cozycloud.cc , dbprefix : example-clozycloud-cc/ , fsroot : /var/lib/cozy/example.cozycloud.cc/fs/ } and creates the proper databases ($PREFIX/$DOCTYPE) for these doctypes: io.cozy.apps io.cozy.files io.cozy.notifications io.cozy.settings Then, it creates the following indexes for these doctypes : TODO : complete this list of indexes Then, it creates some directories: / , with the id io.cozy.files.root-dir /Apps , with the id io.cozy.files.apps-dir /Documents , with the id io.cozy.files.documents-dir /Documents/Downloads , with the id io.cozy.files.downloads-dir /Documents/Pictures , with the id io.cozy.files.pictures-dir /Documents/Music , with the id io.cozy.files.music-dir /Documents/Videos , with the id io.cozy.files.videos-dir The ids are forced to known values: even if these directories are moved or renamed, they can still be found for the permissions. The names are localized: If a locale is provided through the CLI, the directories will be created with names in this locale. Otherwise, theses directories will be created in english and renamed to localized name the first time the locale is set (during onboarding). Then it creates the basic settings email if an email was provided through the CLI locale if a locale was provided through the CLI tz if a timezone was provided through the CLI Settings are created as named id in the $PREFIX/io.cozy.settings database. During onboarding, the fields will be prefilled with these value if they were provided. Finally, applications from the --apps CLI option are installed. Renaming An instance is renamed through the command line. $ cozy-stack instances rename olddomain newdomain Renaming an instance only change the HostName in global/instances base. Destroying An instance is destroyed through the command line. A confirmation is asked from the CLI user unless the yes flag is passed $ cozy-stack instances destroy domain","title":"Managing Instances"},{"location":"/cozy-stack/instance/#instances","text":"TODO it s still a work in progress that needs to be completed. A single cozy-stack can manage several instances. Requests to different instances are identified through the Host HTTP Header, any reverse proxy placed in front of the cozy-stack should forward this header. To simplify development, a dev instance name is used when no Host Header is provided. This behaviour will be kept when the stack is started in dev mode but will be blocked in production environment. Exemple: curl -H \"Host: bob.cozycloud.cc\" localhost:8080 \u2192 localhost:5984/bob-cozycloud.cc curl -H \"Host: alice.cozycloud.cc\" localhost:8080 \u2192 localhost:5984/alice-cozycloud.cc curl localhost:8080 \u2192 localhost:5984/dev (in dev mode only)","title":"Instances"},{"location":"/cozy-stack/instance/#creation","text":"An instance is created on the command line: $ cozy-stack instances add domain With some possible additional options --locale lang --tz timezone --email email --apps app1,app2,app3 It registers the instance in a global couchdb database global/instances { hostname : example.cozycloud.cc , dbprefix : example-clozycloud-cc/ , fsroot : /var/lib/cozy/example.cozycloud.cc/fs/ } and creates the proper databases ($PREFIX/$DOCTYPE) for these doctypes: io.cozy.apps io.cozy.files io.cozy.notifications io.cozy.settings Then, it creates the following indexes for these doctypes : TODO : complete this list of indexes Then, it creates some directories: / , with the id io.cozy.files.root-dir /Apps , with the id io.cozy.files.apps-dir /Documents , with the id io.cozy.files.documents-dir /Documents/Downloads , with the id io.cozy.files.downloads-dir /Documents/Pictures , with the id io.cozy.files.pictures-dir /Documents/Music , with the id io.cozy.files.music-dir /Documents/Videos , with the id io.cozy.files.videos-dir The ids are forced to known values: even if these directories are moved or renamed, they can still be found for the permissions. The names are localized: If a locale is provided through the CLI, the directories will be created with names in this locale. Otherwise, theses directories will be created in english and renamed to localized name the first time the locale is set (during onboarding). Then it creates the basic settings email if an email was provided through the CLI locale if a locale was provided through the CLI tz if a timezone was provided through the CLI Settings are created as named id in the $PREFIX/io.cozy.settings database. During onboarding, the fields will be prefilled with these value if they were provided. Finally, applications from the --apps CLI option are installed.","title":"Creation"},{"location":"/cozy-stack/instance/#renaming","text":"An instance is renamed through the command line. $ cozy-stack instances rename olddomain newdomain Renaming an instance only change the HostName in global/instances base.","title":"Renaming"},{"location":"/cozy-stack/instance/#destroying","text":"An instance is destroyed through the command line. A confirmation is asked from the CLI user unless the yes flag is passed $ cozy-stack instances destroy domain","title":"Destroying"},{"location":"/cozy-stack/onboarding/","text":"Table of contents Onboarding This document explains the architecture and process allowing a cozy instance owner to register to its cozy instance. Compatibility with the current developments on cozy onboarding is a goal : The following documents has been consulted for this proposal Instance creation Creating an instance is done through CLI or through the (future) partner farm manager system. Some settings can be pre-defined on instance creation. ( doc ). The CLI also allows to specify which source to use for onboarding and home applications. The defaults will be hosted on github.com/cozy . After creation, an instance has a registerToken generated randomly. Onboarding steps This document and the cozy-stack are only concerned with login and passphrase registering step which are important for security. All other steps are handled by the onboarding application. The onboarding application SHOULD therefore provide the following features When started with a registerToken , allow the user to create a passphrase When started with a contextToken ( see auth doc ) use it to retrieve instance document. If the instance document is complete according to the onboarding app , redirect to home application. Otherwise, performs whatever steps it deems necessary to fill out the instance (ask for user email, help set up myaccounts accounts, say thank you ) This makes cozy-stack simple and safer while allowing behaviour modification for several install types by picking the correct onboarding application / branch. This makes it easier to add more onboarding steps and have them run on already-installed cozy : On next login after onboarding application update, it will ask the user. Redirections When an user attempts to access the root of its instance ( https://example.cozycloud.cc ) or an application ( https://contacts.example.cozycloud.cc ), and she is not logged-in, she is redirected : If the instance has a passphrase set, to the /login page If the instance has a registerToken set, to the onboarding application. After login, the user is always redirected to the onboarding application. It is the onboarding application responsibility to check if registering is complete and reredirect to home. Routes See settings . Flow Example The server administrator Bob creates an instance through the CLI. He knows the instance should be in french for an user named alice . cozy-stack instances add alice.example.com --locale fr https://alice.cozycloud.cc?registerToken=42456565213125454842 The instance is created { domain : alice.example.com , locale : fr } Eve knows Alice just had an instance created, she goes to https://alice.cozycloud.cc . There is no registerToken , so she only see a message (in french) along the lines of This is the cozy for Alice Martin, this register link is incorrect, if you are Alice Martin please ask your sysadmin for a new link . Alice navigates to https://alice.cozycloud.cc?registerToken=42...42 She is redirected to the onboarding application The onboarding application receive the registerToken. It is the default onboarding application and therefore display the cozy cloud agreement and then ask for a Password. The onboarding application use its registerToken to register the passphrase. Registering the passphrase automatically log Alice in and redirect her back to the onboarding app. Afterward, the onboarding app receive its token normally through the data-cozy-token body attribute, as described in auth documentation . and can do whatever it needs to do : read from the instance document to prefill/bypass form fields add more informations to the instance document. create io.cozy.accounts documents for external accounts. When the onboarding application is satisfied, Alice is redirected to the home application","title":"Onboarding"},{"location":"/cozy-stack/onboarding/#onboarding","text":"This document explains the architecture and process allowing a cozy instance owner to register to its cozy instance. Compatibility with the current developments on cozy onboarding is a goal : The following documents has been consulted for this proposal","title":"Onboarding"},{"location":"/cozy-stack/onboarding/#instance-creation","text":"Creating an instance is done through CLI or through the (future) partner farm manager system. Some settings can be pre-defined on instance creation. ( doc ). The CLI also allows to specify which source to use for onboarding and home applications. The defaults will be hosted on github.com/cozy . After creation, an instance has a registerToken generated randomly.","title":"Instance creation"},{"location":"/cozy-stack/onboarding/#onboarding-steps","text":"This document and the cozy-stack are only concerned with login and passphrase registering step which are important for security. All other steps are handled by the onboarding application. The onboarding application SHOULD therefore provide the following features When started with a registerToken , allow the user to create a passphrase When started with a contextToken ( see auth doc ) use it to retrieve instance document. If the instance document is complete according to the onboarding app , redirect to home application. Otherwise, performs whatever steps it deems necessary to fill out the instance (ask for user email, help set up myaccounts accounts, say thank you ) This makes cozy-stack simple and safer while allowing behaviour modification for several install types by picking the correct onboarding application / branch. This makes it easier to add more onboarding steps and have them run on already-installed cozy : On next login after onboarding application update, it will ask the user.","title":"Onboarding steps"},{"location":"/cozy-stack/onboarding/#redirections","text":"When an user attempts to access the root of its instance ( https://example.cozycloud.cc ) or an application ( https://contacts.example.cozycloud.cc ), and she is not logged-in, she is redirected : If the instance has a passphrase set, to the /login page If the instance has a registerToken set, to the onboarding application. After login, the user is always redirected to the onboarding application. It is the onboarding application responsibility to check if registering is complete and reredirect to home.","title":"Redirections"},{"location":"/cozy-stack/onboarding/#routes","text":"See settings .","title":"Routes"},{"location":"/cozy-stack/onboarding/#flow-example","text":"The server administrator Bob creates an instance through the CLI. He knows the instance should be in french for an user named alice . cozy-stack instances add alice.example.com --locale fr https://alice.cozycloud.cc?registerToken=42456565213125454842 The instance is created { domain : alice.example.com , locale : fr } Eve knows Alice just had an instance created, she goes to https://alice.cozycloud.cc . There is no registerToken , so she only see a message (in french) along the lines of This is the cozy for Alice Martin, this register link is incorrect, if you are Alice Martin please ask your sysadmin for a new link . Alice navigates to https://alice.cozycloud.cc?registerToken=42...42 She is redirected to the onboarding application The onboarding application receive the registerToken. It is the default onboarding application and therefore display the cozy cloud agreement and then ask for a Password. The onboarding application use its registerToken to register the passphrase. Registering the passphrase automatically log Alice in and redirect her back to the onboarding app. Afterward, the onboarding app receive its token normally through the data-cozy-token body attribute, as described in auth documentation . and can do whatever it needs to do : read from the instance document to prefill/bypass form fields add more informations to the instance document. create io.cozy.accounts documents for external accounts. When the onboarding application is satisfied, Alice is redirected to the home application","title":"Flow Example"},{"location":"/cozy-stack/client-app-dev/","text":"Table of contents Develop a client-side application Using cozy-app-dev This document describe a tool to run an environment in order to develop client-side application on the cozy-stack. We provide two different ways to run this environment, either manually where you have to install part of the dependencies yourself or via a Docker image in which all dependencies are packed. This environment will provide a running instance a http server serving both a specified directory of your application on app.cozy.tools:8080 and the cozy-stack on cozy.tools:8080 (you can change the hostname and port if you want, see below). The default passphrase will be cozy Manually To run the scripts/cozy-app-dev.sh directly on you system, you ll need to following dependencies: go curl git couchdb2 : you need at least a running instance of CouchDB 2 Examples: $ ./scripts/cozy-app-dev.sh -d ~/code/myapp If your CouchDB 2 instance is not running on localhost:5984 , you can specify another host and port with the variable COUCHDB_URL like so: $ COUCHDB_URL=http://couchdb.local:1234/ ./scripts/cozy-app-dev.sh -d ~/code/myapp You can have more informations about the usage of this script with the following command: $ ./scripts/cozy-app-dev.sh -h With Docker If you do not want to install the required dependencies, we provide a Docker image which encapsulates the dev script and all its dependencies. To run a ephemeral instance, on the $HOME/myapp directory, use the following command (warning: all the data stored by your application in couchdb and the VFS won t remain after): $ docker run --rm -it \\ -p 8080:8080 \\ -p 8025:8025 \\ -v $HOME/myapp :/data/cozy-app \\ cozy/cozy-app-dev To keep your data even when stopping the container, run the following command: $ docker run --rm -it \\ -p 8080:8080 \\ -p 8025:8025 \\ -v $HOME/myapp :/data/cozy-app \\ -v $(pwd)/db :/usr/local/couchdb/data \\ -v $(pwd)/storage :/data/cozy-storage \\ cozy/cozy-app-dev You can mount your yaml config file, to change the log level for example: $ docker run --rm -it \\ -p 8080:8080 \\ -p 8025:8025 \\ -v $HOME/myapp :/data/cozy-app \\ -v $HOME/cozy.yaml :/etc/cozy/cozy.yaml \\ cozy/cozy-app-dev A MailHog is running inside docker to catch emails. You can view the emails sent by the stack in a web interface on http://cozy.tools:8025/ You can also expose the couchdb port (listening in the container on 5984) in order to access its admin page. For instance add -p 1234:5984 to access to the admin interface on http://localhost:1234/_utils . Make sure you application is built into $HOME/myapp (it should have an index.html and a manifest.webapp files), otherwise it will not work. As an example, for the Drive application , it should be $HOME/drive/build . If you want to use several applications (for testing the intents for example), you can mount several directories inside /data/cozy-app like this: $ docker run --rm -it \\ -p 8080:8080 \\ -p 8025:8025 \\ -v $HOME/appone :/data/cozy-app/appone \\ -v $HOME/apptwo :/data/cozy-app/apptwo \\ cozy/cozy-app-dev Good practices for your application When an application makes a request to the stack, like loading a list of contacts, it sends two informations that will be used by the stack to allow or deny the access: the user session cookie a token that identifies the application (only when the user is connected). So, the application needs such a token. It also needs to know where to send the requests for the stack (it can be guessed, but with the nested vs flat subdomains structures, it s better to get the information from the stack). To do that, when the application loads its HTML index file, the stack will parse it as a template and will insert the relevant values. {{.Token}} will be replaced by the token for the application. {{.Domain}} will be replaced by the stack hostname. {{.Locale}} will be replaced by the locale for the instance. {{.AppName}} : will be replaced by the application name. {{.AppNamePrefix}} : will be replaced by the application name prefix. {{.AppEditor}} : will be replaced by the application s editor. {{.IconPath}} : will be replaced by the application s icon path. {{.CozyBar}} will be replaced by the JavaScript to inject the cozy-bar. {{.CozyClientJS}} will be replaced by the JavaScript to inject the cozy-client-js. So, the index.html should probably looks like: !DOCTYPE html html lang= {{.Locale}} head meta charset= utf-8 title My Awesome App for Cozy /title link rel= stylesheet src= my-app.css {{.CozyClientJS}} {{.CozyBar}} script defer src= my-app.js /script meta name= viewport content= width=device-width, initial-scale=1 /head body div role= application data-cozy-token= {{.Token}} data-cozy-stack= {{.Domain}} /div /body /html And my-app.js : use strict ; document.addEventListener( DOMContentLoaded , () = { const app = document.querySelector( [role=application] ); cozy.client.init({ cozyURL: // + app.dataset.cozyStack, token: app.dataset.cozyToken }); }); // ...","title":"Develop a client-side app"},{"location":"/cozy-stack/client-app-dev/#develop-a-client-side-application","text":"","title":"Develop a client-side application"},{"location":"/cozy-stack/client-app-dev/#using-cozy-app-dev","text":"This document describe a tool to run an environment in order to develop client-side application on the cozy-stack. We provide two different ways to run this environment, either manually where you have to install part of the dependencies yourself or via a Docker image in which all dependencies are packed. This environment will provide a running instance a http server serving both a specified directory of your application on app.cozy.tools:8080 and the cozy-stack on cozy.tools:8080 (you can change the hostname and port if you want, see below). The default passphrase will be cozy","title":"Using cozy-app-dev"},{"location":"/cozy-stack/client-app-dev/#manually","text":"To run the scripts/cozy-app-dev.sh directly on you system, you ll need to following dependencies: go curl git couchdb2 : you need at least a running instance of CouchDB 2 Examples: $ ./scripts/cozy-app-dev.sh -d ~/code/myapp If your CouchDB 2 instance is not running on localhost:5984 , you can specify another host and port with the variable COUCHDB_URL like so: $ COUCHDB_URL=http://couchdb.local:1234/ ./scripts/cozy-app-dev.sh -d ~/code/myapp You can have more informations about the usage of this script with the following command: $ ./scripts/cozy-app-dev.sh -h","title":"Manually"},{"location":"/cozy-stack/client-app-dev/#with-docker","text":"If you do not want to install the required dependencies, we provide a Docker image which encapsulates the dev script and all its dependencies. To run a ephemeral instance, on the $HOME/myapp directory, use the following command (warning: all the data stored by your application in couchdb and the VFS won t remain after): $ docker run --rm -it \\ -p 8080:8080 \\ -p 8025:8025 \\ -v $HOME/myapp :/data/cozy-app \\ cozy/cozy-app-dev To keep your data even when stopping the container, run the following command: $ docker run --rm -it \\ -p 8080:8080 \\ -p 8025:8025 \\ -v $HOME/myapp :/data/cozy-app \\ -v $(pwd)/db :/usr/local/couchdb/data \\ -v $(pwd)/storage :/data/cozy-storage \\ cozy/cozy-app-dev You can mount your yaml config file, to change the log level for example: $ docker run --rm -it \\ -p 8080:8080 \\ -p 8025:8025 \\ -v $HOME/myapp :/data/cozy-app \\ -v $HOME/cozy.yaml :/etc/cozy/cozy.yaml \\ cozy/cozy-app-dev A MailHog is running inside docker to catch emails. You can view the emails sent by the stack in a web interface on http://cozy.tools:8025/ You can also expose the couchdb port (listening in the container on 5984) in order to access its admin page. For instance add -p 1234:5984 to access to the admin interface on http://localhost:1234/_utils . Make sure you application is built into $HOME/myapp (it should have an index.html and a manifest.webapp files), otherwise it will not work. As an example, for the Drive application , it should be $HOME/drive/build . If you want to use several applications (for testing the intents for example), you can mount several directories inside /data/cozy-app like this: $ docker run --rm -it \\ -p 8080:8080 \\ -p 8025:8025 \\ -v $HOME/appone :/data/cozy-app/appone \\ -v $HOME/apptwo :/data/cozy-app/apptwo \\ cozy/cozy-app-dev","title":"With Docker"},{"location":"/cozy-stack/client-app-dev/#good-practices-for-your-application","text":"When an application makes a request to the stack, like loading a list of contacts, it sends two informations that will be used by the stack to allow or deny the access: the user session cookie a token that identifies the application (only when the user is connected). So, the application needs such a token. It also needs to know where to send the requests for the stack (it can be guessed, but with the nested vs flat subdomains structures, it s better to get the information from the stack). To do that, when the application loads its HTML index file, the stack will parse it as a template and will insert the relevant values. {{.Token}} will be replaced by the token for the application. {{.Domain}} will be replaced by the stack hostname. {{.Locale}} will be replaced by the locale for the instance. {{.AppName}} : will be replaced by the application name. {{.AppNamePrefix}} : will be replaced by the application name prefix. {{.AppEditor}} : will be replaced by the application s editor. {{.IconPath}} : will be replaced by the application s icon path. {{.CozyBar}} will be replaced by the JavaScript to inject the cozy-bar. {{.CozyClientJS}} will be replaced by the JavaScript to inject the cozy-client-js. So, the index.html should probably looks like: !DOCTYPE html html lang= {{.Locale}} head meta charset= utf-8 title My Awesome App for Cozy /title link rel= stylesheet src= my-app.css {{.CozyClientJS}} {{.CozyBar}} script defer src= my-app.js /script meta name= viewport content= width=device-width, initial-scale=1 /head body div role= application data-cozy-token= {{.Token}} data-cozy-stack= {{.Domain}} /div /body /html And my-app.js : use strict ; document.addEventListener( DOMContentLoaded , () = { const app = document.querySelector( [role=application] ); cozy.client.init({ cozyURL: // + app.dataset.cozyStack, token: app.dataset.cozyToken }); }); // ...","title":"Good practices for your application"},{"location":"/cozy-stack/docker/","text":"Table of contents Docker This page list various operations that can be automated via Docker. Running a CouchDB instance This will run a new instance of CouchDB in single mode (no cluster) and in admin-party-mode (no user). This command exposes couchdb on the port 5984 . $ docker run -d \\ --name cozy-stack-couch \\ -p 5984:5984 \\ -v $HOME/.cozy-stack-couch:/opt/couchdb/data \\ apache/couchdb:2.1 $ curl -X PUT http://127.0.0.1:5984/{_users,_replicator,_global_changes} Verify your installation at: http://127.0.0.1:5984/_utils/#verifyinstall. Building a cozy-stack via Docker Warning, this command will build a linux binary. Use GOOS and GOARCH to adapt to your own system. # From your cozy-stack developement folder docker run -it --rm --name cozy-stack \\ -v $(pwd):/go/src/github.com/cozy/cozy-stack \\ -v $(pwd):/go/bin \\ golang:1.10 \\ go get -v github.com/cozy/cozy-stack Publishing a new cozy-app-dev image ./scripts/build.sh docker-dev docker push cozy/cozy-app-dev","title":"Running and building Docker images"},{"location":"/cozy-stack/docker/#docker","text":"This page list various operations that can be automated via Docker.","title":"Docker"},{"location":"/cozy-stack/docker/#running-a-couchdb-instance","text":"This will run a new instance of CouchDB in single mode (no cluster) and in admin-party-mode (no user). This command exposes couchdb on the port 5984 . $ docker run -d \\ --name cozy-stack-couch \\ -p 5984:5984 \\ -v $HOME/.cozy-stack-couch:/opt/couchdb/data \\ apache/couchdb:2.1 $ curl -X PUT http://127.0.0.1:5984/{_users,_replicator,_global_changes} Verify your installation at: http://127.0.0.1:5984/_utils/#verifyinstall.","title":"Running a CouchDB instance"},{"location":"/cozy-stack/docker/#building-a-cozy-stack-via-docker","text":"Warning, this command will build a linux binary. Use GOOS and GOARCH to adapt to your own system. # From your cozy-stack developement folder docker run -it --rm --name cozy-stack \\ -v $(pwd):/go/src/github.com/cozy/cozy-stack \\ -v $(pwd):/go/bin \\ golang:1.10 \\ go get -v github.com/cozy/cozy-stack","title":"Building a cozy-stack via Docker"},{"location":"/cozy-stack/docker/#publishing-a-new-cozy-app-dev-image","text":"./scripts/build.sh docker-dev docker push cozy/cozy-app-dev","title":"Publishing a new cozy-app-dev image"},{"location":"/cozy-stack/release/","text":"Table of contents Building a release To build a release of cozy-stack, a build.sh script can automate the work. The release option of this script will generate a binary with a name containing the version of the file, along with a SHA-256 sum of the binary. You can use a local.env at the root of the repository to add your default values for environment variables. See ./scripts/build.sh --help for more informations. COZY_ENV=development GOOS=linux GOARCH=amd64 ./scripts/build.sh release The version string is deterministic and reflects entirely the state of the working-directory from which the release is built from. It is generated using the following format: TAG [- NUMBER OF COMMITS AFTER TAG ][-dirty][-dev] Where: TAG : closest annotated tag of the current working directory. If no tag is present, is uses the string v0 . This is not allowed in a production release. NUMBER OF COMMITS AFTER TAG : number of commits after the closest tag if the current working directory does not point exactly to a tag dirty : added if the working if the working-directory is not clean (contains un-commited modifications). This is not allowed in production release. dev : added for a development mode release Sprint release At the end of a sprint, we release different versions of the stack: Naked stack, for GNU/Linux amd64/arm and FreeBSD amd64 Create a tag yyyyMmSs and push it Generate all binaries, checksums and signatures with ./scripts/release.sh Create a GitHub release and upload all previously generated assets with ./scripts/release.rb Docker development image Copy cozy-stack GNU/Linux amd64 binary to ./scripts Go into ./scripts Generate docker image with docker build -t cozy/cozy-app-dev: tag Push image to the Docker hub with docker push cozy/cozy-app-dev: tag Debian self-hosting packages Create a new version yyyyMmSs-1 on https://github.com/cozy/debian-cozy/blob/master/changelog Create and push a tag yyyyMmSs-1 on https://github.com/cozy/debian-cozy Build and publish packages on our internal build machine","title":"Build a release"},{"location":"/cozy-stack/release/#building-a-release","text":"To build a release of cozy-stack, a build.sh script can automate the work. The release option of this script will generate a binary with a name containing the version of the file, along with a SHA-256 sum of the binary. You can use a local.env at the root of the repository to add your default values for environment variables. See ./scripts/build.sh --help for more informations. COZY_ENV=development GOOS=linux GOARCH=amd64 ./scripts/build.sh release The version string is deterministic and reflects entirely the state of the working-directory from which the release is built from. It is generated using the following format: TAG [- NUMBER OF COMMITS AFTER TAG ][-dirty][-dev] Where: TAG : closest annotated tag of the current working directory. If no tag is present, is uses the string v0 . This is not allowed in a production release. NUMBER OF COMMITS AFTER TAG : number of commits after the closest tag if the current working directory does not point exactly to a tag dirty : added if the working if the working-directory is not clean (contains un-commited modifications). This is not allowed in production release. dev : added for a development mode release","title":"Building a release"},{"location":"/cozy-stack/release/#sprint-release","text":"At the end of a sprint, we release different versions of the stack: Naked stack, for GNU/Linux amd64/arm and FreeBSD amd64 Create a tag yyyyMmSs and push it Generate all binaries, checksums and signatures with ./scripts/release.sh Create a GitHub release and upload all previously generated assets with ./scripts/release.rb Docker development image Copy cozy-stack GNU/Linux amd64 binary to ./scripts Go into ./scripts Generate docker image with docker build -t cozy/cozy-app-dev: tag Push image to the Docker hub with docker push cozy/cozy-app-dev: tag Debian self-hosting packages Create a new version yyyyMmSs-1 on https://github.com/cozy/debian-cozy/blob/master/changelog Create and push a tag yyyyMmSs-1 on https://github.com/cozy/debian-cozy Build and publish packages on our internal build machine","title":"Sprint release"},{"location":"/cozy-stack/CONTRIBUTING/","text":"How to contribute to the Cozy Stack? Thank you for your interest in contributing to Cozy! There are many ways to contribute, and we appreciate all of them. Security Issues If you discover a security issue, please bring it to their attention right away! Please DO NOT file a public issue, instead send your report privately to security AT cozycloud DOT cc. Security reports are greatly appreciated and we will publicly thank you for it. We currently do not offer a paid security bounty program, but are not ruling it out in the future. Bug Reports While bugs are unfortunate, they re a reality in software. We can t fix what we don t know about, so please report liberally. If you re not sure if something is a bug or not, feel free to file a bug anyway. Opening an issue is as easy as following this link and filling out the fields. Here are some things you can write about your bug: A short summary What did you try, step by step? What did you expect? What did happen instead? What is the version of the Cozy Stack? You can also use the cozy-stack bug command to open the form to report issue prefilled with some useful system informations. Pull Requests Workflow Pull requests are the primary mechanism we use to change Cozy. GitHub itself has some great documentation on using the Pull Request feature. We use the fork and pull model described there. Step 1: Fork Fork the project on GitHub and check out your copy locally . $ go get -u github.com/cozy/cozy-stack $ cd $(go env GOPATH)/src/github.com/cozy/cozy-stack $ git remote add fork git://github.com/username/cozy-stack.git Step 2: Branch Create a branch and start hacking: $ git checkout -b my-branch -t origin/master Step 3: Code Well, I think you know how to do that. Just be sure to follow the coding guidelines from the Go community (gofmt, Effective Go , comment the code, etc.). We are using goimports to format code, and gometalinter to detect code smells. Step 4: Test Don t forget to add tests and be sure they are green: $ go test -v ./... If you want to play with the modified cozy-stack (for example, testing it with a webapp), you can build it locally and start it with this command: $ go build ./cozy-stack serve Step 5: Commit Writing good commit messages is important. A commit message should describe what changed and why. Step 6: Rebase Use git rebase (not git merge ) to sync your work from time to time. $ git fetch origin $ git rebase origin/master Step 7: Push $ git push fork my-branch Go to https://github.com/username/cozy-stack and select your branch. Click the Pull Request button and fill out the form. Pull requests are usually reviewed within a few days. If there are comments to address, apply your changes in a separate commit and push that to your branch. Post a comment in the pull request afterwards; GitHub does not send out notifications when you add commits. External assets The cozy-stack serve some assets for the client application. In particular, cozy-client-js and cozy-bar assets are listed in assets/external . To update them, you can open a pull request for this file. When a maintainer will accept this pull request, he will also run scripts/build.sh assets to transform them in go code (to make the repository go gettable). Useful commands There are some useful commands to know in order to develop with the go code of cozy-stack: go get -u github.com/cozy/cozy-stack cd $(go env GOPATH)/src/github.com/cozy/cozy-stack go get -t -u ./... # To install or update the go dependencies go test -v ./... # To launch the tests go run main.go serve # To start the API server godoc -http=:6060 # To start the documentation server # Open http://127.0.0.1:6060/pkg/github.com/cozy/cozy-stack/ Writing documentation Documentation improvements are very welcome. We try to keep a good documentation in the docs/ folder. But, you know, we are developers, we can forget to document important stuff that look obvious to us. And documentation can always be improved. Translations The Cozy Stack is translated on a platform called Transifex . This tutorial can help you to learn how to make your first steps here. If you have any question, don t hesitate to ask us! The translations are imported from transifex with tx pull -a in the assets/locales directory, and packed in the go code with scripts/build.sh assets . Community You can help us by making our community even more vibrant. For example, you can write a blog post, take some videos, answer the questions on the forum , organize new meetups, and speak about what you like in Cozy!","title":"The contributing guide"},{"location":"/cozy-stack/CONTRIBUTING/#how-to-contribute-to-the-cozy-stack","text":"Thank you for your interest in contributing to Cozy! There are many ways to contribute, and we appreciate all of them.","title":"How to contribute to the Cozy Stack?"},{"location":"/cozy-stack/CONTRIBUTING/#security-issues","text":"If you discover a security issue, please bring it to their attention right away! Please DO NOT file a public issue, instead send your report privately to security AT cozycloud DOT cc. Security reports are greatly appreciated and we will publicly thank you for it. We currently do not offer a paid security bounty program, but are not ruling it out in the future.","title":"Security Issues"},{"location":"/cozy-stack/CONTRIBUTING/#bug-reports","text":"While bugs are unfortunate, they re a reality in software. We can t fix what we don t know about, so please report liberally. If you re not sure if something is a bug or not, feel free to file a bug anyway. Opening an issue is as easy as following this link and filling out the fields. Here are some things you can write about your bug: A short summary What did you try, step by step? What did you expect? What did happen instead? What is the version of the Cozy Stack? You can also use the cozy-stack bug command to open the form to report issue prefilled with some useful system informations.","title":"Bug Reports"},{"location":"/cozy-stack/CONTRIBUTING/#pull-requests","text":"","title":"Pull Requests"},{"location":"/cozy-stack/CONTRIBUTING/#workflow","text":"Pull requests are the primary mechanism we use to change Cozy. GitHub itself has some great documentation on using the Pull Request feature. We use the fork and pull model described there.","title":"Workflow"},{"location":"/cozy-stack/CONTRIBUTING/#step-1-fork","text":"Fork the project on GitHub and check out your copy locally . $ go get -u github.com/cozy/cozy-stack $ cd $(go env GOPATH)/src/github.com/cozy/cozy-stack $ git remote add fork git://github.com/username/cozy-stack.git","title":"Step 1: Fork"},{"location":"/cozy-stack/CONTRIBUTING/#step-2-branch","text":"Create a branch and start hacking: $ git checkout -b my-branch -t origin/master","title":"Step 2: Branch"},{"location":"/cozy-stack/CONTRIBUTING/#step-3-code","text":"Well, I think you know how to do that. Just be sure to follow the coding guidelines from the Go community (gofmt, Effective Go , comment the code, etc.). We are using goimports to format code, and gometalinter to detect code smells.","title":"Step 3: Code"},{"location":"/cozy-stack/CONTRIBUTING/#step-4-test","text":"Don t forget to add tests and be sure they are green: $ go test -v ./... If you want to play with the modified cozy-stack (for example, testing it with a webapp), you can build it locally and start it with this command: $ go build ./cozy-stack serve","title":"Step 4: Test"},{"location":"/cozy-stack/CONTRIBUTING/#step-5-commit","text":"Writing good commit messages is important. A commit message should describe what changed and why.","title":"Step 5: Commit"},{"location":"/cozy-stack/CONTRIBUTING/#step-6-rebase","text":"Use git rebase (not git merge ) to sync your work from time to time. $ git fetch origin $ git rebase origin/master","title":"Step 6: Rebase"},{"location":"/cozy-stack/CONTRIBUTING/#step-7-push","text":"$ git push fork my-branch Go to https://github.com/username/cozy-stack and select your branch. Click the Pull Request button and fill out the form. Pull requests are usually reviewed within a few days. If there are comments to address, apply your changes in a separate commit and push that to your branch. Post a comment in the pull request afterwards; GitHub does not send out notifications when you add commits.","title":"Step 7: Push"},{"location":"/cozy-stack/CONTRIBUTING/#external-assets","text":"The cozy-stack serve some assets for the client application. In particular, cozy-client-js and cozy-bar assets are listed in assets/external . To update them, you can open a pull request for this file. When a maintainer will accept this pull request, he will also run scripts/build.sh assets to transform them in go code (to make the repository go gettable).","title":"External assets"},{"location":"/cozy-stack/CONTRIBUTING/#useful-commands","text":"There are some useful commands to know in order to develop with the go code of cozy-stack: go get -u github.com/cozy/cozy-stack cd $(go env GOPATH)/src/github.com/cozy/cozy-stack go get -t -u ./... # To install or update the go dependencies go test -v ./... # To launch the tests go run main.go serve # To start the API server godoc -http=:6060 # To start the documentation server # Open http://127.0.0.1:6060/pkg/github.com/cozy/cozy-stack/","title":"Useful commands"},{"location":"/cozy-stack/CONTRIBUTING/#writing-documentation","text":"Documentation improvements are very welcome. We try to keep a good documentation in the docs/ folder. But, you know, we are developers, we can forget to document important stuff that look obvious to us. And documentation can always be improved.","title":"Writing documentation"},{"location":"/cozy-stack/CONTRIBUTING/#translations","text":"The Cozy Stack is translated on a platform called Transifex . This tutorial can help you to learn how to make your first steps here. If you have any question, don t hesitate to ask us! The translations are imported from transifex with tx pull -a in the assets/locales directory, and packed in the go code with scripts/build.sh assets .","title":"Translations"},{"location":"/cozy-stack/CONTRIBUTING/#community","text":"You can help us by making our community even more vibrant. For example, you can write a blog post, take some videos, answer the questions on the forum , organize new meetups, and speak about what you like in Cozy!","title":"Community"},{"location":"/cozy-stack/auth/","text":"Table of contents Authentication and access delegations Introduction In this document, we will cover how to protect the usage of the cozy-stack. When the cozy-stack receives a request, it checks that the request is authorized, and if yes, it processes it and answers it. What about OAuth2? OAuth2 is about delegating an access to resources on a server to another party. It is a framework, not a strictly defined protocol, for organizing the interactions between these 4 actors: the resource owner, the user that can click on buttons the client, the website or application that would like to access the resources the authorization server, whose role is limited to give tokens but is central in OAuth2 interactions the resources server, the server that controls the resources. For cozy, both the authorization server and the resources server roles are played by the cozy-stack. The resource owner is the owner of a cozy instance. The client can be the cozy-desktop app, cozy-mobile, or many other applications. OAuth2, and its extensions, is a large world. At its core, there is 2 things: letting the client get a token issued by the authorization server, and using this token to access to the resources. OAuth2 describe 4 flows, called grant types, for the first part: Authorization code Implicit grant type Client credentials grant type Resource owner credentials grant type. On cozy, only the most typical one is used: authorization code. To start this flow, the client must have a client_id and client_secret . The Cozy stack implements the OAuth2 Dynamic Client Registration Protocol (an extension to OAuth2) to allow the clients to obtain them. OAuth2 has also 3 ways to use a token: in the query-string (even if the spec does not recommended it) in the POST body in the HTTP Authorization header. On cozy, only the HTTP header is supported. OAuth2 has a lot of assumptions. Let s see some of them and their consequences on Cozy: TLS is very important to secure the communications. in OAuth 1, there was a mechanism to sign the requests. But it was very difficult to get it right for the developers and was abandonned in OAuth2, in favor of using TLS. The Cozy instance are already accessible only in HTTPS, so there is nothing particular to do for that. There is a principle called TOFU, Trust On First Use. It said that if the user will give his permission for delegating access to its resources when the client will try to access them for the first time. Later, the client will be able to keep accessing them even if the user is no longer here to give his permissions. The client can t make the assumptions about when its tokens will work. The tokens have no meaning for him (like cookies in a browser), they are just something it got from the authorization server and can send with its request. The access token can expire, the user can revoke them, etc. OAuth 2.0 defines no cryptographic methods. But a developer that want to use it will have to put her hands in that. If you want to learn OAuth 2 in details, I recommend the OAuth 2 in Action book . The cozy stack as an authorization server GET /auth/login Display a form with a password field to let the user authenticates herself to the cozy stack. This endpoint accepts a redirect parameter. If the user is already logged in, she will be redirected immediately. Else, the parameter will be transfered in the POST. This parameter can only contain a link to an application installed on the cozy (thus to a subdomain of the cozy instance). To protect against stealing authorization code with redirection, the fragment is always overriden: GET /auth/login?redirect=https://contacts.cozy.example.org/foo?bar#baz HTTP/1.1 Host: cozy.example.org Cookie: ... Note : the redirect parameter should be URL-encoded. We haven t done that to make it clear what the path ( foo ), the query-string ( bar ), and the fragment ( baz ) are. HTTP/1.1 302 Moved Temporarily Location: https://contacts.cozy.example.org/foo?bar# If the redirect parameter is invalid, the response will be 400 Bad Request . Same for other parameters, the redirection will happen only on success (even if OAuth2 says the authorization server can redirect on errors, it s very complicated to do it safely, and it is better to avoid this trap). POST /auth/login After the user has typed her passphrase and clicked on Login , a request is made to this endpoint. The redirect parameter is passed inside the body. If it is missing, the redirection will be made against the default target: the home application of this cozy instance. POST /auth/login HTTP/1.1 Host: cozy.example.org Content-Type: application/x-www-form-urlencoded passphrase=p4ssw0rd redirect=https%3A%2F%2Fcontacts.cozy.example.org HTTP/1.1 302 Moved Temporarily Set-Cookie: ... Location: https://contacts.cozy.example.org/foo When two-factor authentication (2FA) authentication is activated, this endpoint will not directly sent a redirection after this first passphrase step. In such case, a 200 OK response is sent along with a token value in the response (either in JSON if requested or directly in a new HTML form). Along with this token, on 2FA passcode is sent to the user via another transport (email for instance, depending on the user s preferences). Another request should be sent to the same endpoint with a valid pair (token, passcode) , ensuring that the user correctly entered its passphrase and received a fresh passcode by another mean. POST /auth/login HTTP/1.1 Host: cozy.example.org Content-Type: application/x-www-form-urlencoded two-factor-token=123123123123 passcode=678678 redirect=https%3A%2F%2Fcontacts.cozy.example.org HTTP/1.1 302 Moved Temporarily Set-Cookie: ... Location: https://contacts.cozy.example.org/foo DELETE /auth/login This can be used to log-out the user. An app token must be passed in the Authorization header, to protect against CSRF attack on this (this can part of bigger attacks like session fixation). DELETE /auth/login HTTP/1.1 Host: cozy.example.org Cookie: seesioncookie.... Authorization: Bearer app-token DELETE /auth/login/others This can be used to log-out all active sessions except the one used by the request. This allow to disconnect any other users currenctly authenticated on the system. An app token must be passed in the Authorization header, to protect against CSRF attack on this (this can part of bigger attacks like session fixation). DELETE /auth/login/others HTTP/1.1 Host: cozy.example.org Cookie: seesioncookie.... Authorization: Bearer app-token GET /auth/passphrase_reset Display a form for the user to reset its password, in case he has forgotten it for example. If the user is connected, he won t be shown this form and he will be directly redirected to his cozy. GET /auth/passphrase_reset HTTP/1.1 Host: cozy.example.org Content-Type: text/html Cookie: ... POST /auth/passphrase_reset After the user has clicked on the reset button of the passphrase reset form, it will execute a request to this endpoint. This endpoint will create a token for the user to actually renew his passphrase. The token has a short-live duration of about 15 minutes. After the token is created, it is sent to the user on its mailbox. This endpoint will redirect the user on the login form page. POST /auth/passphrase_reset HTTP/1.1 Host: cozy.example.org Content-Type: application/x-www-form-urlencoded csrf_token=123456890 GET /auth/passphrase_renew Display a form for the user to enter a new password. This endpoint should be used with a token query parameter. This token makes sure that the user has actually reset its passphrase and should have been sent via its mailbox. GET /auth/passphrase_renew?token=123456789 HTTP/1.1 Host: cozy.example.org Content-Type: text/html Cookie: ... POST /auth/passphrase_renew After the user has entered its new passphrase in the renew passphrase form, a request is made to this endpoint to renew the passphrase. This endpoint requires a valid token to actually work. In case of a success, the user is redirected to the login form. POST /auth/passphrase_reset HTTP/1.1 Host: cozy.example.org Content-Type: application/x-www-form-urlencoded csrf_token=123456890 passphrase_reset_token=123456789 passphrase=mynewpassphrase POST /auth/register This route is used by OAuth2 clients to dynamically register them-selves. See OAuth 2.0 Dynamic Client Registration Protocol for the details. The client must send a JSON request, with at least: redirect_uris , an array of strings with the redirect URIs that the client will use in the authorization flow client_name , human-readable string name of the client to be presented to the end-user during authorization software_id , an identifier of the software used by the client (it should remain the same for all instances of the client software, whereas client_id varies between instances). It can also send the optional fields: client_kind (possible values: web, desktop, mobile, browser, etc.) client_uri , URL string of a web page providing information about the client logo_uri , to display an icon to the user in the authorization flow policy_uri , URL string that points to a human-readable privacy policy document that describes how the deployment organization collects, uses, retains, and discloses personal data software_version , a version identifier string for the client software. notification_platform , to activate notifications on the associated device, this field specify the platform used to send notifications: \"android\" : for Android devices with notifications via Firebase Cloud Messageing \"ios\" : for iOS devices with notifications via APNS/2. notification_device_token , the token used to identify the mobile device for notifications The server gives to the client the previous fields and these informations: client_id client_secret registration_access_token Example: POST /auth/register HTTP/1.1 Host: cozy.example.org Content-Type: application/json Accept: application/json { redirect_uris : [ https://client.example.org/oauth/callback ], client_name : Client , software_id : github.com/example/client , software_version : 2.0.1 , client_kind : web , client_uri : https://client.example.org/ , logo_uri : https://client.example.org/logo.svg , policy_uri : https://client/example.org/policy } HTTP/1.1 201 Created Content-Type: application/json { client_id : 64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 , client_secret : eyJpc3Mi[...omitted for brevity...] , client_secret_expires_at : 0, registration_access_token : J9l-ZhwP[...omitted for brevity...] , grant_types : [ authorization_code , refresh_token ], response_types : [ code ], redirect_uris : [ https://client.example.org/oauth/callback ], client_name : Client , software_id : github.com/example/client , software_version : 2.0.1 , client_kind : web , client_uri : https://client.example.org/ , logo_uri : https://client.example.org/logo.svg , policy_uri : https://client/example.org/policy } GET /auth/register/:client-id This route is used by the clients to get informations about them-selves. The client has to send its registration access token to be able to use this endpoint. See OAuth 2.0 Dynamic Client Registration Management Protocol for more details. GET /auth/register/64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 HTTP/1.1 Host: cozy.example.org Accept: application/json Authorization: Bearer J9l-ZhwP... HTTP/1.1 201 Created Content-Type: application/json { client_id : 64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 , client_secret : eyJpc3Mi[...omitted for brevity...] , client_secret_expires_at : 0, grant_types : [ authorization_code , refresh_token ], response_types : [ code ], redirect_uris : [ https://client.example.org/oauth/callback ], client_name : Client , software_id : github.com/example/client , software_version : 2.0.1 , client_kind : web , client_uri : https://client.example.org/ , logo_uri : https://client.example.org/logo.svg , policy_uri : https://client/example.org/policy } PUT /auth/register/:client-id This route is used by the clients to update informations about them-selves. The client has to send its registration access token to be able to use this endpoint. Note: the client can ask to change its client_secret . To do that, it must send the current client_secret , and the server will respond with the new client_secret . PUT /auth/register/64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 HTTP/1.1 Host: cozy.example.org Accept: application/json Content-Type: application/json Authorization: Bearer J9l-ZhwP... { client_id : 64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 , client_secret : eyJpc3Mi[...omitted for brevity...] , redirect_uris : [ https://client.example.org/oauth/callback ], client_name : Client , software_id : github.com/example/client , software_version : 2.0.2 , client_kind : web , client_uri : https://client.example.org/ , logo_uri : https://client.example.org/client-logo.svg , policy_uri : https://client/example.org/policy , notification_platform : android , notification_device_token : XXXXxxxx... } HTTP/1.1 200 OK Content-Type: application/json { client_id : 64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 , client_secret : IFais2Ah[...omitted for brevity...] , client_secret_expires_at : 0, grant_types : [ authorization_code , refresh_token ], response_types : [ code ], redirect_uris : [ https://client.example.org/oauth/callback ], client_name : Client , software_id : github.com/example/client , software_version : 2.0.2 , client_kind : web , client_uri : https://client.example.org/ , logo_uri : https://client.example.org/client-logo.svg , policy_uri : https://client/example.org/policy } DELETE /auth/register/:client-id This route is used by the clients to unregister them-selves. The client has to send its registration access token to be able to use this endpoint. DELETE /auth/register/64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 HTTP/1.1 Host: cozy.example.org Authorization: Bearer J9l-ZhwP... HTTP/1.1 204 No Content Content-Type: application/json GET /auth/authorize When an OAuth2 client wants to get access to the data of the cozy owner, it starts the OAuth2 dance with this step. The user is shown what the client asks and has an accept button if she is OK with that. The parameters are: client_id , that identify the client redirect_uri , it has to be exactly the same as the one used in registration state , it s a protection against CSRF on the client (a random string generated by the client, that it can check when the user will be redirected with the authorization code. It can be used as a key in local storage for storing a state in a SPA). response_type , only code is supported scope , a space separated list of the permissions asked (like io.cozy.files:GET for read-only access to files). GET /auth/authorize?client_id=oauth-client-1 response_type=code scope=io.cozy.files:GET%20io.cozy.contacts state=Eh6ahshepei5Oojo redirect_uri=https%3A%2F%2Fclient.org%2F HTTP/1.1 Host: cozy.example.org Note we warn the user that he is about to share his data with an application which only the callback URI is guaranteed. POST /auth/authorize When the user accepts, her browser send a request to this endpoint: POST /auth/authorize HTTP/1.1 Host: cozy.example.org Content-Type: application/x-www-form-urlencoded state=Eh6ahshepei5Oojo client_id=oauth-client-1 scope=io.cozy.files:GET%20io.cozy.contacts csrf_token=johw6Sho Note : this endpoint is protected against CSRF attacks. The user is then redirected to the original client, with an access code in the URL: HTTP/1.1 302 Moved Temporarily Location: https://client.org/?state=Eh6ahshepei5Oojo access_code=Aih7ohth# GET /auth/authorize/sharing POST /auth/authorize/sharing They are similar to /auth/authorize : they also make the user accept an OAuth thing, but it is specialized for sharing. They are a few differences, like the scope format (sharing rules, not permissions) and the redirection after the POST. POST /auth/access_token Now, the client can check that the state is correct, and if it is the case, ask for an access_token . It can use this route with the code (ie access_code) given above. This endpoint is also used to refresh the access token, by sending the refresh_token instead of the access_code . The parameters are: grant_type , with authorization_code or refresh_token as value code or refresh_token , depending on which grant type is used client_id client_secret Example: POST /auth/access_token HTTP/1.1 Host: cozy.example.org Content-Type: application/x-www-form-urlencoded Accept: application/json grant_type=authorization_code code=Aih7ohth client_id=oauth-client-1 client_secret=Oung7oi5 HTTP/1.1 200 OK Content-type: application/json { access_token : ooch1Yei , token_type : bearer , refresh_token : ui0Ohch8 , scope : io.cozy.files:GET io.cozy.contacts } FAQ What format is used for tokens? The access tokens are formatted as JSON Web Tokens (JWT) , like this: Claim Fullname What it identifies aud Audience Identify the recipient where the token can be used (like access ) iss Issuer Identify the Cozy instance (its domain in fact) iat Issued At Identify when the token was issued (Unix timestamp) sub Subject Identify the client that can use the token scope Scope Identify the scope of actions that the client can accomplish The scope is used for permissions . Other tokens can be JWT with a similar formalism, or be a simple random value (when we want to have a clear revocation process). What happens when the user has lost her passphrase? She can reset it from the command-line, like this: $ cozy-stack instances reset-passphrase cozy.example.org ek0Jah1R A new password is generated and print in the console. Is two-factor authentication (2FA) possible? Yes, it s possible. Via the cozy-settings application, the two-factor authentication can be activated. Here is how it works in more details: On each connection, when the 2FA is activated, the user is asked for its passphrase first. When entering correct passphrase, the user is then asked for: a TOTP (Timebased One-Time password, RFC 6238) derived from a secret associated with the instance. a short term timestamped MAC with the same validity time-range and also derived from the same secret. The TOTP is valid for a time range of about 5 minutes. When sending a correct and still-valid pair (passcode, token) , the user is granted with authentication cookie. The passcode can be sent to the instance s owner via email \u2014 more transport shall be added later. Client-side apps Important : OAuth2 is not used here! The steps looks similar (like obtaining a token), but when going in the details, it doesn t match. How to register the application? The application is registered at install. See app management for details. How to get a token? When a user access an application, she first loads the HTML page. Inside this page, a token specific to this app is injected (only for private routes), via a templating method. We have prefered our custom solution to the implicit grant type of OAuth2 for 2 reasons: It has a better User Experience. The implicit grant type works with 2 redirections (the application to the stack, and then the stack to the application), and the first one needs JS to detect if the token is present or not in the fragment hash. It has a strong impact on the time to load the application. The implicit grant type of OAuth2 has a severe drawback on security: the token appears in the URL and is shown by the browser. It can also be leaked with the HTTP Referer header. The token will be given only for the authenticated user. For nested subdomains (like calendar.joe.example.net ), the session cookie from the stack is enough (it is for .joe.example.net ). But for flat subdomains (like joe-calendar.example.net ), it s more complicated. On the first try of the user, she will be redirected to the stack. As she is already logged-in, she will be redirected to the app with a session code (else she can login). This session code can be exchanged to a session cookie. A redirection will still happen to remove the code from the URL (it helps to avoid the code being saved in the browser history). For security reasons, the session code have the following properties: It can only be used once. It is tied to an application ( calendar in our example). It has a very short time span of validity (1 minute). How to use a token? The token can be sent to the cozy-stack as a Bearer token in the Authorization header, like this: GET /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee HTTP/1.1 Host: cozy.example.org Authorization: Bearer application-token If the user is authenticated, her cookies will be sent automatically. The cookies are needed for a token to be valid. How to refresh a token? The token is valid only for 24 hours. If the application is opened for more than that, it will need to get a new token. But most applications won t be kept open for so long and it s okay if they don t try to refresh tokens. At worst, the user just had to reload its page and it will work again. The app can know it s time to get a new token when the stack starts sending 401 Unauthorized responses. In that case, it can fetches the same html page that it was loaded initially, parses it and extracts the new token. Third-party websites How to register the application? If a third-party websites would like to access a cozy, it had to register first. For example, a big company can have data about a user and may want to offer her a way to get her data back in her cozy. When the user is connected on the website of this company, she can give her cozy address. The website will then register on this cozy, using the OAuth2 Dynamic Client Registration Protocol, as explained above . How to get a token? To get an access token, it s enough to follow the authorization code flow of OAuth2: sending the user to the cozy, on the authorize page if the user approves, she is then redirected back to the client the client gets the access code and can exchange it to an access token. How to use a token? The access token can be sent as a bearer token, in the Authorization header of HTTP: GET /data/io.cozy.contacts/6494e0ac-dfcb-11e5-88c1-472e84a9cbee HTTP/1.1 Host: cozy.example.org Accept: application/json Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ How to refresh a token? The access token will be valid only for 24 hours. After that, a new access token must be asked. To do that, just follow the refresh token flow, as explained above . Devices and browser extensions For devices and browser extensions, it is nearly the same than for third-party websites. The main difficulty is the redirect_uri. In OAuth2, the access code is given to the client by redirecting the user to an URL controlled by the client. But devices and browser extensions don t have an obvious URL for that. The IETF has published an RFC called OAuth 2.0 for Native Apps . Native apps on desktop A desktop native application can start an embedded webserver on localhost. The redirect_uri will be something like http://127.0.0.1:19856/callback . Native apps on mobile On mobile, the native apps can often register a custom URI scheme, like com.example.oauthclient:/ . Just be sure that no other app has registered itself with the same URI. Chrome extensions Chrome extensions can use URL like https:// extension-id .chromiumapp.org/ anything-here for their usage. See https://developer.chrome.com/apps/app_identity#non for more details. It has also a method to simplify the creation of such an URL: chrome.identity.getRedirectURL . Firefox extensions It is possible to use an out of band URN: urn:ietf:wg:oauth:2.0:oob:auto . The token is then extracted from the title of the page. See this addon for google oauth2 as an example. Security considerations The password will be stored in a secure fashion, with a password hashing function. The hashing function and its parameter will be stored with the hash, in order to make it possible to change the algorithm and/or the parameters later if we had any suspicion that it became too weak. The initial algorithm is scrypt . The access code is valid only once, and will expire after 5 minutes Dynamically registered applications won t have access to all possible scopes. For example, an application that has been dynamically registered can t ask the cozy owner to give it the right to install other applications. This limitation should improve security, as avoiding too powerful scopes to be used with unknown applications. The cozy stack will apply rate limiting to avoid brute-force attacks. The cozy stack offers CORS for most of its services. But it s disabled for /auth (it doesn t make sense here) and for the client-side applications (to avoid leaking their tokens). The client should really use HTTPS for its redirect_uri parameter, but it s allowed to use HTTP for localhost, as in the native desktop app example. OAuth2 says that the state parameter is optional in the authorization code flow. But it is mandatory to use it with Cozy. For more on this subject, here is a list of links: https://www.owasp.org/index.php/Authentication_Cheat_Sheet https://tools.ietf.org/html/rfc6749#page-53 https://tools.ietf.org/html/rfc6819 https://tools.ietf.org/html/draft-ietf-oauth-closing-redirectors-00 http://www.oauthsecurity.com/ Conclusion Security is hard. If you want to share some concerns with us, do not hesitate to send us an email to security AT cozycloud.cc.","title":"/auth - Authentication & OAuth"},{"location":"/cozy-stack/auth/#authentication-and-access-delegations","text":"","title":"Authentication and access delegations"},{"location":"/cozy-stack/auth/#introduction","text":"In this document, we will cover how to protect the usage of the cozy-stack. When the cozy-stack receives a request, it checks that the request is authorized, and if yes, it processes it and answers it.","title":"Introduction"},{"location":"/cozy-stack/auth/#what-about-oauth2","text":"OAuth2 is about delegating an access to resources on a server to another party. It is a framework, not a strictly defined protocol, for organizing the interactions between these 4 actors: the resource owner, the user that can click on buttons the client, the website or application that would like to access the resources the authorization server, whose role is limited to give tokens but is central in OAuth2 interactions the resources server, the server that controls the resources. For cozy, both the authorization server and the resources server roles are played by the cozy-stack. The resource owner is the owner of a cozy instance. The client can be the cozy-desktop app, cozy-mobile, or many other applications. OAuth2, and its extensions, is a large world. At its core, there is 2 things: letting the client get a token issued by the authorization server, and using this token to access to the resources. OAuth2 describe 4 flows, called grant types, for the first part: Authorization code Implicit grant type Client credentials grant type Resource owner credentials grant type. On cozy, only the most typical one is used: authorization code. To start this flow, the client must have a client_id and client_secret . The Cozy stack implements the OAuth2 Dynamic Client Registration Protocol (an extension to OAuth2) to allow the clients to obtain them. OAuth2 has also 3 ways to use a token: in the query-string (even if the spec does not recommended it) in the POST body in the HTTP Authorization header. On cozy, only the HTTP header is supported. OAuth2 has a lot of assumptions. Let s see some of them and their consequences on Cozy: TLS is very important to secure the communications. in OAuth 1, there was a mechanism to sign the requests. But it was very difficult to get it right for the developers and was abandonned in OAuth2, in favor of using TLS. The Cozy instance are already accessible only in HTTPS, so there is nothing particular to do for that. There is a principle called TOFU, Trust On First Use. It said that if the user will give his permission for delegating access to its resources when the client will try to access them for the first time. Later, the client will be able to keep accessing them even if the user is no longer here to give his permissions. The client can t make the assumptions about when its tokens will work. The tokens have no meaning for him (like cookies in a browser), they are just something it got from the authorization server and can send with its request. The access token can expire, the user can revoke them, etc. OAuth 2.0 defines no cryptographic methods. But a developer that want to use it will have to put her hands in that. If you want to learn OAuth 2 in details, I recommend the OAuth 2 in Action book .","title":"What about OAuth2?"},{"location":"/cozy-stack/auth/#the-cozy-stack-as-an-authorization-server","text":"","title":"The cozy stack as an authorization server"},{"location":"/cozy-stack/auth/#get-authlogin","text":"Display a form with a password field to let the user authenticates herself to the cozy stack. This endpoint accepts a redirect parameter. If the user is already logged in, she will be redirected immediately. Else, the parameter will be transfered in the POST. This parameter can only contain a link to an application installed on the cozy (thus to a subdomain of the cozy instance). To protect against stealing authorization code with redirection, the fragment is always overriden: GET /auth/login?redirect=https://contacts.cozy.example.org/foo?bar#baz HTTP/1.1 Host: cozy.example.org Cookie: ... Note : the redirect parameter should be URL-encoded. We haven t done that to make it clear what the path ( foo ), the query-string ( bar ), and the fragment ( baz ) are. HTTP/1.1 302 Moved Temporarily Location: https://contacts.cozy.example.org/foo?bar# If the redirect parameter is invalid, the response will be 400 Bad Request . Same for other parameters, the redirection will happen only on success (even if OAuth2 says the authorization server can redirect on errors, it s very complicated to do it safely, and it is better to avoid this trap).","title":"GET /auth/login"},{"location":"/cozy-stack/auth/#post-authlogin","text":"After the user has typed her passphrase and clicked on Login , a request is made to this endpoint. The redirect parameter is passed inside the body. If it is missing, the redirection will be made against the default target: the home application of this cozy instance. POST /auth/login HTTP/1.1 Host: cozy.example.org Content-Type: application/x-www-form-urlencoded passphrase=p4ssw0rd redirect=https%3A%2F%2Fcontacts.cozy.example.org HTTP/1.1 302 Moved Temporarily Set-Cookie: ... Location: https://contacts.cozy.example.org/foo When two-factor authentication (2FA) authentication is activated, this endpoint will not directly sent a redirection after this first passphrase step. In such case, a 200 OK response is sent along with a token value in the response (either in JSON if requested or directly in a new HTML form). Along with this token, on 2FA passcode is sent to the user via another transport (email for instance, depending on the user s preferences). Another request should be sent to the same endpoint with a valid pair (token, passcode) , ensuring that the user correctly entered its passphrase and received a fresh passcode by another mean. POST /auth/login HTTP/1.1 Host: cozy.example.org Content-Type: application/x-www-form-urlencoded two-factor-token=123123123123 passcode=678678 redirect=https%3A%2F%2Fcontacts.cozy.example.org HTTP/1.1 302 Moved Temporarily Set-Cookie: ... Location: https://contacts.cozy.example.org/foo","title":"POST /auth/login"},{"location":"/cozy-stack/auth/#delete-authlogin","text":"This can be used to log-out the user. An app token must be passed in the Authorization header, to protect against CSRF attack on this (this can part of bigger attacks like session fixation). DELETE /auth/login HTTP/1.1 Host: cozy.example.org Cookie: seesioncookie.... Authorization: Bearer app-token","title":"DELETE /auth/login"},{"location":"/cozy-stack/auth/#delete-authloginothers","text":"This can be used to log-out all active sessions except the one used by the request. This allow to disconnect any other users currenctly authenticated on the system. An app token must be passed in the Authorization header, to protect against CSRF attack on this (this can part of bigger attacks like session fixation). DELETE /auth/login/others HTTP/1.1 Host: cozy.example.org Cookie: seesioncookie.... Authorization: Bearer app-token","title":"DELETE /auth/login/others"},{"location":"/cozy-stack/auth/#get-authpassphrase_reset","text":"Display a form for the user to reset its password, in case he has forgotten it for example. If the user is connected, he won t be shown this form and he will be directly redirected to his cozy. GET /auth/passphrase_reset HTTP/1.1 Host: cozy.example.org Content-Type: text/html Cookie: ...","title":"GET /auth/passphrase_reset"},{"location":"/cozy-stack/auth/#post-authpassphrase_reset","text":"After the user has clicked on the reset button of the passphrase reset form, it will execute a request to this endpoint. This endpoint will create a token for the user to actually renew his passphrase. The token has a short-live duration of about 15 minutes. After the token is created, it is sent to the user on its mailbox. This endpoint will redirect the user on the login form page. POST /auth/passphrase_reset HTTP/1.1 Host: cozy.example.org Content-Type: application/x-www-form-urlencoded csrf_token=123456890","title":"POST /auth/passphrase_reset"},{"location":"/cozy-stack/auth/#get-authpassphrase_renew","text":"Display a form for the user to enter a new password. This endpoint should be used with a token query parameter. This token makes sure that the user has actually reset its passphrase and should have been sent via its mailbox. GET /auth/passphrase_renew?token=123456789 HTTP/1.1 Host: cozy.example.org Content-Type: text/html Cookie: ...","title":"GET /auth/passphrase_renew"},{"location":"/cozy-stack/auth/#post-authpassphrase_renew","text":"After the user has entered its new passphrase in the renew passphrase form, a request is made to this endpoint to renew the passphrase. This endpoint requires a valid token to actually work. In case of a success, the user is redirected to the login form. POST /auth/passphrase_reset HTTP/1.1 Host: cozy.example.org Content-Type: application/x-www-form-urlencoded csrf_token=123456890 passphrase_reset_token=123456789 passphrase=mynewpassphrase","title":"POST /auth/passphrase_renew"},{"location":"/cozy-stack/auth/#post-authregister","text":"This route is used by OAuth2 clients to dynamically register them-selves. See OAuth 2.0 Dynamic Client Registration Protocol for the details. The client must send a JSON request, with at least: redirect_uris , an array of strings with the redirect URIs that the client will use in the authorization flow client_name , human-readable string name of the client to be presented to the end-user during authorization software_id , an identifier of the software used by the client (it should remain the same for all instances of the client software, whereas client_id varies between instances). It can also send the optional fields: client_kind (possible values: web, desktop, mobile, browser, etc.) client_uri , URL string of a web page providing information about the client logo_uri , to display an icon to the user in the authorization flow policy_uri , URL string that points to a human-readable privacy policy document that describes how the deployment organization collects, uses, retains, and discloses personal data software_version , a version identifier string for the client software. notification_platform , to activate notifications on the associated device, this field specify the platform used to send notifications: \"android\" : for Android devices with notifications via Firebase Cloud Messageing \"ios\" : for iOS devices with notifications via APNS/2. notification_device_token , the token used to identify the mobile device for notifications The server gives to the client the previous fields and these informations: client_id client_secret registration_access_token Example: POST /auth/register HTTP/1.1 Host: cozy.example.org Content-Type: application/json Accept: application/json { redirect_uris : [ https://client.example.org/oauth/callback ], client_name : Client , software_id : github.com/example/client , software_version : 2.0.1 , client_kind : web , client_uri : https://client.example.org/ , logo_uri : https://client.example.org/logo.svg , policy_uri : https://client/example.org/policy } HTTP/1.1 201 Created Content-Type: application/json { client_id : 64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 , client_secret : eyJpc3Mi[...omitted for brevity...] , client_secret_expires_at : 0, registration_access_token : J9l-ZhwP[...omitted for brevity...] , grant_types : [ authorization_code , refresh_token ], response_types : [ code ], redirect_uris : [ https://client.example.org/oauth/callback ], client_name : Client , software_id : github.com/example/client , software_version : 2.0.1 , client_kind : web , client_uri : https://client.example.org/ , logo_uri : https://client.example.org/logo.svg , policy_uri : https://client/example.org/policy }","title":"POST /auth/register"},{"location":"/cozy-stack/auth/#get-authregisterclient-id","text":"This route is used by the clients to get informations about them-selves. The client has to send its registration access token to be able to use this endpoint. See OAuth 2.0 Dynamic Client Registration Management Protocol for more details. GET /auth/register/64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 HTTP/1.1 Host: cozy.example.org Accept: application/json Authorization: Bearer J9l-ZhwP... HTTP/1.1 201 Created Content-Type: application/json { client_id : 64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 , client_secret : eyJpc3Mi[...omitted for brevity...] , client_secret_expires_at : 0, grant_types : [ authorization_code , refresh_token ], response_types : [ code ], redirect_uris : [ https://client.example.org/oauth/callback ], client_name : Client , software_id : github.com/example/client , software_version : 2.0.1 , client_kind : web , client_uri : https://client.example.org/ , logo_uri : https://client.example.org/logo.svg , policy_uri : https://client/example.org/policy }","title":"GET /auth/register/:client-id"},{"location":"/cozy-stack/auth/#put-authregisterclient-id","text":"This route is used by the clients to update informations about them-selves. The client has to send its registration access token to be able to use this endpoint. Note: the client can ask to change its client_secret . To do that, it must send the current client_secret , and the server will respond with the new client_secret . PUT /auth/register/64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 HTTP/1.1 Host: cozy.example.org Accept: application/json Content-Type: application/json Authorization: Bearer J9l-ZhwP... { client_id : 64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 , client_secret : eyJpc3Mi[...omitted for brevity...] , redirect_uris : [ https://client.example.org/oauth/callback ], client_name : Client , software_id : github.com/example/client , software_version : 2.0.2 , client_kind : web , client_uri : https://client.example.org/ , logo_uri : https://client.example.org/client-logo.svg , policy_uri : https://client/example.org/policy , notification_platform : android , notification_device_token : XXXXxxxx... } HTTP/1.1 200 OK Content-Type: application/json { client_id : 64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 , client_secret : IFais2Ah[...omitted for brevity...] , client_secret_expires_at : 0, grant_types : [ authorization_code , refresh_token ], response_types : [ code ], redirect_uris : [ https://client.example.org/oauth/callback ], client_name : Client , software_id : github.com/example/client , software_version : 2.0.2 , client_kind : web , client_uri : https://client.example.org/ , logo_uri : https://client.example.org/client-logo.svg , policy_uri : https://client/example.org/policy }","title":"PUT /auth/register/:client-id"},{"location":"/cozy-stack/auth/#delete-authregisterclient-id","text":"This route is used by the clients to unregister them-selves. The client has to send its registration access token to be able to use this endpoint. DELETE /auth/register/64ce5cb0-bd4c-11e6-880e-b3b7dfda89d3 HTTP/1.1 Host: cozy.example.org Authorization: Bearer J9l-ZhwP... HTTP/1.1 204 No Content Content-Type: application/json","title":"DELETE /auth/register/:client-id"},{"location":"/cozy-stack/auth/#get-authauthorize","text":"When an OAuth2 client wants to get access to the data of the cozy owner, it starts the OAuth2 dance with this step. The user is shown what the client asks and has an accept button if she is OK with that. The parameters are: client_id , that identify the client redirect_uri , it has to be exactly the same as the one used in registration state , it s a protection against CSRF on the client (a random string generated by the client, that it can check when the user will be redirected with the authorization code. It can be used as a key in local storage for storing a state in a SPA). response_type , only code is supported scope , a space separated list of the permissions asked (like io.cozy.files:GET for read-only access to files). GET /auth/authorize?client_id=oauth-client-1 response_type=code scope=io.cozy.files:GET%20io.cozy.contacts state=Eh6ahshepei5Oojo redirect_uri=https%3A%2F%2Fclient.org%2F HTTP/1.1 Host: cozy.example.org Note we warn the user that he is about to share his data with an application which only the callback URI is guaranteed.","title":"GET /auth/authorize"},{"location":"/cozy-stack/auth/#post-authauthorize","text":"When the user accepts, her browser send a request to this endpoint: POST /auth/authorize HTTP/1.1 Host: cozy.example.org Content-Type: application/x-www-form-urlencoded state=Eh6ahshepei5Oojo client_id=oauth-client-1 scope=io.cozy.files:GET%20io.cozy.contacts csrf_token=johw6Sho Note : this endpoint is protected against CSRF attacks. The user is then redirected to the original client, with an access code in the URL: HTTP/1.1 302 Moved Temporarily Location: https://client.org/?state=Eh6ahshepei5Oojo access_code=Aih7ohth#","title":"POST /auth/authorize"},{"location":"/cozy-stack/auth/#get-authauthorizesharing-post-authauthorizesharing","text":"They are similar to /auth/authorize : they also make the user accept an OAuth thing, but it is specialized for sharing. They are a few differences, like the scope format (sharing rules, not permissions) and the redirection after the POST.","title":"GET /auth/authorize/sharing &amp; POST /auth/authorize/sharing"},{"location":"/cozy-stack/auth/#post-authaccess_token","text":"Now, the client can check that the state is correct, and if it is the case, ask for an access_token . It can use this route with the code (ie access_code) given above. This endpoint is also used to refresh the access token, by sending the refresh_token instead of the access_code . The parameters are: grant_type , with authorization_code or refresh_token as value code or refresh_token , depending on which grant type is used client_id client_secret Example: POST /auth/access_token HTTP/1.1 Host: cozy.example.org Content-Type: application/x-www-form-urlencoded Accept: application/json grant_type=authorization_code code=Aih7ohth client_id=oauth-client-1 client_secret=Oung7oi5 HTTP/1.1 200 OK Content-type: application/json { access_token : ooch1Yei , token_type : bearer , refresh_token : ui0Ohch8 , scope : io.cozy.files:GET io.cozy.contacts }","title":"POST /auth/access_token"},{"location":"/cozy-stack/auth/#faq","text":"What format is used for tokens? The access tokens are formatted as JSON Web Tokens (JWT) , like this: Claim Fullname What it identifies aud Audience Identify the recipient where the token can be used (like access ) iss Issuer Identify the Cozy instance (its domain in fact) iat Issued At Identify when the token was issued (Unix timestamp) sub Subject Identify the client that can use the token scope Scope Identify the scope of actions that the client can accomplish The scope is used for permissions . Other tokens can be JWT with a similar formalism, or be a simple random value (when we want to have a clear revocation process). What happens when the user has lost her passphrase? She can reset it from the command-line, like this: $ cozy-stack instances reset-passphrase cozy.example.org ek0Jah1R A new password is generated and print in the console. Is two-factor authentication (2FA) possible? Yes, it s possible. Via the cozy-settings application, the two-factor authentication can be activated. Here is how it works in more details: On each connection, when the 2FA is activated, the user is asked for its passphrase first. When entering correct passphrase, the user is then asked for: a TOTP (Timebased One-Time password, RFC 6238) derived from a secret associated with the instance. a short term timestamped MAC with the same validity time-range and also derived from the same secret. The TOTP is valid for a time range of about 5 minutes. When sending a correct and still-valid pair (passcode, token) , the user is granted with authentication cookie. The passcode can be sent to the instance s owner via email \u2014 more transport shall be added later.","title":"FAQ"},{"location":"/cozy-stack/auth/#client-side-apps","text":"Important : OAuth2 is not used here! The steps looks similar (like obtaining a token), but when going in the details, it doesn t match.","title":"Client-side apps"},{"location":"/cozy-stack/auth/#how-to-register-the-application","text":"The application is registered at install. See app management for details.","title":"How to register the application?"},{"location":"/cozy-stack/auth/#how-to-get-a-token","text":"When a user access an application, she first loads the HTML page. Inside this page, a token specific to this app is injected (only for private routes), via a templating method. We have prefered our custom solution to the implicit grant type of OAuth2 for 2 reasons: It has a better User Experience. The implicit grant type works with 2 redirections (the application to the stack, and then the stack to the application), and the first one needs JS to detect if the token is present or not in the fragment hash. It has a strong impact on the time to load the application. The implicit grant type of OAuth2 has a severe drawback on security: the token appears in the URL and is shown by the browser. It can also be leaked with the HTTP Referer header. The token will be given only for the authenticated user. For nested subdomains (like calendar.joe.example.net ), the session cookie from the stack is enough (it is for .joe.example.net ). But for flat subdomains (like joe-calendar.example.net ), it s more complicated. On the first try of the user, she will be redirected to the stack. As she is already logged-in, she will be redirected to the app with a session code (else she can login). This session code can be exchanged to a session cookie. A redirection will still happen to remove the code from the URL (it helps to avoid the code being saved in the browser history). For security reasons, the session code have the following properties: It can only be used once. It is tied to an application ( calendar in our example). It has a very short time span of validity (1 minute).","title":"How to get a token?"},{"location":"/cozy-stack/auth/#how-to-use-a-token","text":"The token can be sent to the cozy-stack as a Bearer token in the Authorization header, like this: GET /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee HTTP/1.1 Host: cozy.example.org Authorization: Bearer application-token If the user is authenticated, her cookies will be sent automatically. The cookies are needed for a token to be valid.","title":"How to use a token?"},{"location":"/cozy-stack/auth/#how-to-refresh-a-token","text":"The token is valid only for 24 hours. If the application is opened for more than that, it will need to get a new token. But most applications won t be kept open for so long and it s okay if they don t try to refresh tokens. At worst, the user just had to reload its page and it will work again. The app can know it s time to get a new token when the stack starts sending 401 Unauthorized responses. In that case, it can fetches the same html page that it was loaded initially, parses it and extracts the new token.","title":"How to refresh a token?"},{"location":"/cozy-stack/auth/#third-party-websites","text":"","title":"Third-party websites"},{"location":"/cozy-stack/auth/#how-to-register-the-application_1","text":"If a third-party websites would like to access a cozy, it had to register first. For example, a big company can have data about a user and may want to offer her a way to get her data back in her cozy. When the user is connected on the website of this company, she can give her cozy address. The website will then register on this cozy, using the OAuth2 Dynamic Client Registration Protocol, as explained above .","title":"How to register the application?"},{"location":"/cozy-stack/auth/#how-to-get-a-token_1","text":"To get an access token, it s enough to follow the authorization code flow of OAuth2: sending the user to the cozy, on the authorize page if the user approves, she is then redirected back to the client the client gets the access code and can exchange it to an access token.","title":"How to get a token?"},{"location":"/cozy-stack/auth/#how-to-use-a-token_1","text":"The access token can be sent as a bearer token, in the Authorization header of HTTP: GET /data/io.cozy.contacts/6494e0ac-dfcb-11e5-88c1-472e84a9cbee HTTP/1.1 Host: cozy.example.org Accept: application/json Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ","title":"How to use a token?"},{"location":"/cozy-stack/auth/#how-to-refresh-a-token_1","text":"The access token will be valid only for 24 hours. After that, a new access token must be asked. To do that, just follow the refresh token flow, as explained above .","title":"How to refresh a token?"},{"location":"/cozy-stack/auth/#devices-and-browser-extensions","text":"For devices and browser extensions, it is nearly the same than for third-party websites. The main difficulty is the redirect_uri. In OAuth2, the access code is given to the client by redirecting the user to an URL controlled by the client. But devices and browser extensions don t have an obvious URL for that. The IETF has published an RFC called OAuth 2.0 for Native Apps .","title":"Devices and browser extensions"},{"location":"/cozy-stack/auth/#native-apps-on-desktop","text":"A desktop native application can start an embedded webserver on localhost. The redirect_uri will be something like http://127.0.0.1:19856/callback .","title":"Native apps on desktop"},{"location":"/cozy-stack/auth/#native-apps-on-mobile","text":"On mobile, the native apps can often register a custom URI scheme, like com.example.oauthclient:/ . Just be sure that no other app has registered itself with the same URI.","title":"Native apps on mobile"},{"location":"/cozy-stack/auth/#chrome-extensions","text":"Chrome extensions can use URL like https:// extension-id .chromiumapp.org/ anything-here for their usage. See https://developer.chrome.com/apps/app_identity#non for more details. It has also a method to simplify the creation of such an URL: chrome.identity.getRedirectURL .","title":"Chrome extensions"},{"location":"/cozy-stack/auth/#firefox-extensions","text":"It is possible to use an out of band URN: urn:ietf:wg:oauth:2.0:oob:auto . The token is then extracted from the title of the page. See this addon for google oauth2 as an example.","title":"Firefox extensions"},{"location":"/cozy-stack/auth/#security-considerations","text":"The password will be stored in a secure fashion, with a password hashing function. The hashing function and its parameter will be stored with the hash, in order to make it possible to change the algorithm and/or the parameters later if we had any suspicion that it became too weak. The initial algorithm is scrypt . The access code is valid only once, and will expire after 5 minutes Dynamically registered applications won t have access to all possible scopes. For example, an application that has been dynamically registered can t ask the cozy owner to give it the right to install other applications. This limitation should improve security, as avoiding too powerful scopes to be used with unknown applications. The cozy stack will apply rate limiting to avoid brute-force attacks. The cozy stack offers CORS for most of its services. But it s disabled for /auth (it doesn t make sense here) and for the client-side applications (to avoid leaking their tokens). The client should really use HTTPS for its redirect_uri parameter, but it s allowed to use HTTP for localhost, as in the native desktop app example. OAuth2 says that the state parameter is optional in the authorization code flow. But it is mandatory to use it with Cozy. For more on this subject, here is a list of links: https://www.owasp.org/index.php/Authentication_Cheat_Sheet https://tools.ietf.org/html/rfc6749#page-53 https://tools.ietf.org/html/rfc6819 https://tools.ietf.org/html/draft-ietf-oauth-closing-redirectors-00 http://www.oauthsecurity.com/","title":"Security considerations"},{"location":"/cozy-stack/auth/#conclusion","text":"Security is hard. If you want to share some concerns with us, do not hesitate to send us an email to security AT cozycloud.cc.","title":"Conclusion"},{"location":"/cozy-stack/apps/","text":"Table of contents Applications It s possible to manage serverless applications from the cozy stack and serve them via cozy stack. The stack does the routing and serve the HTML and the assets for the applications. The assets of the applications are installed in the virtual file system. Install an application The manifest To install an application, cozy needs a manifest. It s a JSON document that describes the application (its name and icon for example), how to install it and what it needs for its usage (the permissions in particular). While we have considered to use the same manifest format as the W3C for PWAs , it didn t match our expectations. The manifest format for FirefoxOS is a better fit. We took a lot of inspirations from it, starting with the filename for this file: manifest.webapp . Field Description name the name to display on the home name_prefix the prefix to display with the name slug the default slug (it can be changed at install time) editor the editor s name to display on the cozy-bar of the app icon an icon for the home screenshots an array of path to the screenshots of the application category the category of the application short_description a short description of the application long_description a long description of the application source where the files of the app can be downloaded developer name and url for the developer locales translations of the name and description fields in other locales langs list of languages tags supported by the application version the current version number license the SPDX license identifier platforms a list of type , url values for derivate of the application for other devices intents a list of intents provided by this app (see here for more details) permissions a map of permissions needed by the app (see here for more details) notifications a map of notifications needed by the app (see here for more details) services a map of the services associated with the app (see below for more details) routes a map of routes for the app (see below for more details) Routes A route make the mapping between the requested paths and the files. It can have an index, which is an HTML file, with a token injected on it that identify both the application. This token must be used with the user cookies to use the services of the cozy-stack. By default, a route can be only visited by the authenticated owner of the instance where the app is installed. But a route can be marked as public. In that case, anybody can visit the route. For example, an application can offer an administration interface on /admin , a public page on /public , and shared assets in /assets : { /admin : { folder : / , index : admin.html , public : false }, /public : { folder : /public , index : index.html , public : true }, /assets : { folder : /assets , public : true } } If an application has no routes in its manifest, the stack will create one route, this default one: { / : { folder : / , index : index.html , public : false } } Note : if you have a public route, it s probably better to put the app icon in it. So, the cozy-bar can display it for the users that go on the public part of the app. Services Application may require background and offline process to analyse the user s data and emit some notification or warning even without the user being on the application. These part of the application are called services and can be declared as part of the application in its manifest. In contrast to konnectors , services have the same permissions as the web application and are not intended to collect outside informations but rather analyse the current set of collected information inside the cozy. However they share the same mechanisms as the konnectors to describe how and when they should be executed: via our trigger system. To define a service, first the code needs to be stored with the application content, as single (packaged) javascript files. In the manifest, declare the service and its parameters following this example: { services : { low-budget-notification : { type : node , file : /services/low-budget-notification.js , trigger : @cron 0 0 0 * * * } // ... } } The trigger field should follow the available triggers described in the jobs documentation . The file field should specify the service code run and the type field describe the code type (only \"node\" for now). Notifications For more informations on how te declare notifications in the manifest, see the notifications documentation . Here is an example: { notifications : { account-balance : { description : Alert the user when its account balance is negative , collapsible : true, // only interested in the last value of the notification multiple : true, // require sub-categories for each account stateful : false, default_priority : high , // high priority for this notification templates : { mail : file:./notifications/account-balance-mail.tpl } } } } Resource caching To help caching of applications assets, we detect the presence of a unique identifier in the name of assets: a unique identifier is matched when the file base name contains a long hexadecimal subpart between . , of at least 10 characters. For instance app.badf00dbadf00d.js or icon.badbeefbadbeef.1.png . With such a unique identifier, the asset is considered immutable, and a long cache-control is added on corresponding HTTP responses. We recommend the use of bundling tools like webpack which offer the possibility to add such identifier on the building step of the application packages for all assets. Sources Here is the available sources, defined by the scheme of the source URL: registry:// : to install an application from the instance registries git:// or git+ssh:// : to install an application from a git repository http:// or https:// : to install an application from an http server (via a tarball) file:// : to install an application from a local directory (for instance: file:///home/user/code/cozy-app ) The registry scheme expect the following elements: scheme: registry host: the name of the application path: /:channel the channel of the application (see the registry doc) Examples: registry://drive/stable , registry://drive/beta , and registry://drive/dev . For the git scheme, the fragment in the URL can be used to specify which branch to install. For the http and https schemes, the fragment can be used to give the expected sha256sum. POST /apps/:slug Install an application, ie download the files and put them in /apps/:slug in the virtual file system of the user, create an io.cozy.apps document, register the permissions, etc. This endpoint is asynchronous and returns a successful return as soon as the application installation has started, meaning we have successfully reached the manifest and started to fetch application data. To make this endpoint synchronous, use the header Accept: text/event-stream . This will make a eventsource stream sending the manifest and returning when the application has been installed or failed. Status codes 202 Accepted, when the application installation has been accepted. 400 Bad-Request, when the manifest of the application could not be processed (for instance, it is not valid JSON). 404 Not Found, when the manifest or the source of the application is not reachable. 422 Unprocessable Entity, when the sent data is invalid (for example, the slug is invalid or the Source parameter is not a proper or supported url) Query-String Parameter Description Source URL from where the app can be downloaded (only for install) Request POST /apps/emails?Source=git://github.com/cozy/cozy-emails.git HTTP/1.1 Accept: application/vnd.api+json Response HTTP/1.1 202 Accepted Content-Type: application/vnd.api+json { data : [{ id : 4cfbd8be-8968-11e6-9708-ef55b7c20863 , type : io.cozy.apps , meta : { rev : 1-7a1f918147df94580c92b47275e4604a }, attributes : { name : calendar , state : installing , slug : calendar , ... }, links : { self : /apps/calendar } }] } Note : it s possible to choose a git branch by passing it in the fragment like this: POST /apps/emails-dev?Source=git://github.com/cozy/cozy-emails.git%23dev HTTP/1.1 PUT /apps/:slug Update an application with the specified slug name. This endpoint is asynchronous and returns a successful return as soon as the application installation has started, meaning we have successfully reached the manifest and started to fetch application data. To make this endpoint synchronous, use the header Accept: text/event-stream . This will make a eventsource stream sending the manifest and returning when the application has been updated or failed. Request PUT /apps/emails HTTP/1.1 Accept: application/vnd.api+json Response HTTP/1.1 202 Accepted Content-Type: application/vnd.api+json { data : [{ id : 4cfbd8be-8968-11e6-9708-ef55b7c20863 , type : io.cozy.apps , meta : { rev : 1-7a1f918147df94580c92b47275e4604a }, attributes : { name : calendar , state : installing , slug : calendar , ... }, links : { self : /apps/calendar } }] } Status codes 202 Accepted, when the application installation has been accepted. 400 Bad-Request, when the manifest of the application could not be processed (for instance, it is not valid JSON). 404 Not Found, when the application with the specified slug was not found or when the manifest or the source of the application is not reachable. 422 Unprocessable Entity, when the sent data is invalid (for example, the slug is invalid or the Source parameter is not a proper or supported url) List installed applications GET /apps/ An application can be in one of these states: installed , the application is installed but still require some user interaction to accept its permissions ready , the user can use it installing , the installation is running and the app will soon be usable upgrading , a new version is being installed errored , the app is in an error state and can not be used. Request GET /apps/ HTTP/1.1 Accept: application/vnd.api+json Response HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : [{ id : 4cfbd8be-8968-11e6-9708-ef55b7c20863 , type : io.cozy.apps , meta : { rev : 2-bbfb0fc32dfcdb5333b28934f195b96a }, attributes : { name : calendar , state : ready , slug : calendar , ... }, links : { self : /apps/calendar , icon : /apps/calendar/icon , related : https://calendar.alice.example.com/ } }] } Get informations about an application GET /apps/:slug Get the icon of an application GET /apps/:slug/icon Request GET /apps/calendar/icon HTTP/1.1 Response HTTP/1.1 200 OK Content-Type: image/svg+xml svg xmlns= http://www.w3.org/2000/svg width= 60 height= 60 viewBox= 0 0 60 60 title Calendar /title path fill= #fff fill-opacity= .011 d= M30 58.75c15.878 0 28.75-12.872 28.75-28.75s-12.872-28.75-28.75-28.75-28.75 12.872-28.75 28.75 12.872 28.75 28.75 28.75zm0 1.25c-16.569 0-30-13.432-30-30 0-16.569 13.431-30 30-30 16.568 0 30 13.431 30 30 0 16.568-13.432 30-30 30z / path d= M47.997 9h-35.993c-1.654 0-3.004 1.345-3.004 3.004v35.993c0 1.653 1.345 3.004 3.004 3.004h35.993c1.653 0 3.004-1.345 3.004-3.004v-35.993c0-1.654-1.345-3.004-3.004-3.004zm-35.997 3.035h4.148v2.257c0 .856.7 1.556 1.556 1.556s1.556-.7 1.556-1.556v-2.257h5.136v2.257c0 .856.7 1.556 1.556 1.556s1.556-.7 1.556-1.556v-2.257h5.137v2.257c0 .856.699 1.556 1.556 1.556s1.556-.7 1.556-1.556v-2.257h5.137v2.257c0 .856.699 1.556 1.556 1.556s1.556-.7 1.556-1.556v-2.257h3.992v6.965h-35.998v-6.965zm36 35.965h-36v-27h36v27zm-21.71-10.15c-.433.34-.997.51-1.69.51-.64 0-1.207-.137-1.7-.409-.493-.273-.933-.603-1.32-.99l-1.1 1.479c.453.508 1.027.934 1.72 1.28.693.347 1.56.521 2.6.521.613 0 1.19-.083 1.73-.25.54-.167 1.013-.407 1.42-.721.407-.312.727-.696.96-1.149.233-.453.35-.974.35-1.56 0-.841-.25-1.527-.75-2.061s-1.13-.9-1.89-1.1v-.08c.693-.268 1.237-.641 1.63-1.12.393-.48.59-1.08.59-1.8 0-.533-.1-1.01-.3-1.43-.2-.42-.48-.772-.84-1.06-.36-.287-.793-.503-1.3-.65-.507-.147-1.067-.22-1.68-.22-.76 0-1.45.147-2.07.44s-1.203.68-1.75 1.16l1.18 1.42c.387-.36.783-.65 1.19-.87.407-.22.863-.33 1.37-.33.587 0 1.047.15 1.38.45.333.3.5.717.5 1.25 0 .293-.057.566-.17.819-.113.253-.3.47-.56.65-.26.18-.6.319-1.02.42-.42.1-.943.149-1.57.149v1.681c.72 0 1.32.05 1.8.149.48.101.863.243 1.15.43.287.188.49.414.61.681.12.267.18.567.18.899 0 .602-.217 1.072-.65 1.412zm13.71.15h-3v-11h-2c-.4.24-.65.723-1.109.89-.461.167-1.25.49-1.891.61v1.5h3v8h-3v2h8v-2z / /svg Uninstall an application DELETE /apps/:slug Request DELETE /apps/tasky HTTP/1.1 Response HTTP/1.1 204 No Content Access an application Each application will run on its sub-domain. The sub-domain is the slug used when installing the application ( calendar.cozy.example.org if it was installed via a POST on /apps/calendar). On the main domain ( cozy.example.org ), there will be the registration process, the login form, and it will redirect to home.cozy.example.org for logged-in users. Rationale The applications have different roles and permissions. An application is identified when talking to the stack via a token. The token has to be injected in the application, one way or another, and it have to be unaccessible from other apps. If the applications run on the same domain (for example https://cozy.example.org/apps/calendar ), it s nearly impossible to protect an application to take the token of another application. The security model of the web is based too heavily on Same Origin Policy for that. If the token is put in the html of the index.html page of an app, another app can use the fetch API to get the html page, parse its content and extract the token. We can think of other ways to inject the token (indexeddb, URL, cookies) but none will provide a better isolation. Maybe in a couple years, when the origin spec will be more advanced. So, if having the apps on the same origin is not possible, we have to put them on several origins. One interesting way to do that is using sandboxed iframes. An iframe with the sandbox attribute , and not allow-same-origin in it, will be assigned to a unique origin. The W3C warns: Potentially hostile files should not be served from the same server as the file containing the iframe element. Sandboxing hostile content is of minimal help if an attacker can convince the user to just visit the hostile content directly, rather than in the iframe. To limit the damage that can be caused by hostile HTML content, it should be served from a separate dedicated domain. Using a different domain ensures that scripts in the files are unable to attack the site, even if the user is tricked into visiting those pages directly, without the protection of the sandbox attribute. It may be possible to disable all html pages to have an html content-type, except the home, and having the home loading the apps in a sandboxed iframe, via the srcdoc attribute. But, it will mean that we will have to reinvent nearly everything. Even showing an image can no longer be done via an img tag, it will need to use post-message with the home. Such a solution is difficult to implement, is a very fragile (both for the apps developer than for security) and is an hell to debug when it breaks. Clearly, it s not an acceptable solution. Thus, the only choice is to have several origins, and sub-domains is the best way for that. Of course, it has the downside to be more complicated to deploy (DNS and TLS certificates). But, in the tradeoff between security and ease of administration, we definetively take the security first. Routes Should we be concerned that all the routes are on the same sub-domain? No, it s not an issue. There are two types of routes: the ones that are publics and those reserved to the authenticated user. Public routes have no token Private routes are private, they can be accessed only with a valid session cookie, ie by the owner of the instance. Another application can t use the user cookies to read the token, because of the restrictions of the same origin policy (they are on different domains). And the application can t use an open proxy to read the private route, because it doesn t have the user cookies for that (the cookie is marked as httpOnly ).","title":"/apps - Applications Management"},{"location":"/cozy-stack/apps/#applications","text":"It s possible to manage serverless applications from the cozy stack and serve them via cozy stack. The stack does the routing and serve the HTML and the assets for the applications. The assets of the applications are installed in the virtual file system.","title":"Applications"},{"location":"/cozy-stack/apps/#install-an-application","text":"","title":"Install an application"},{"location":"/cozy-stack/apps/#the-manifest","text":"To install an application, cozy needs a manifest. It s a JSON document that describes the application (its name and icon for example), how to install it and what it needs for its usage (the permissions in particular). While we have considered to use the same manifest format as the W3C for PWAs , it didn t match our expectations. The manifest format for FirefoxOS is a better fit. We took a lot of inspirations from it, starting with the filename for this file: manifest.webapp . Field Description name the name to display on the home name_prefix the prefix to display with the name slug the default slug (it can be changed at install time) editor the editor s name to display on the cozy-bar of the app icon an icon for the home screenshots an array of path to the screenshots of the application category the category of the application short_description a short description of the application long_description a long description of the application source where the files of the app can be downloaded developer name and url for the developer locales translations of the name and description fields in other locales langs list of languages tags supported by the application version the current version number license the SPDX license identifier platforms a list of type , url values for derivate of the application for other devices intents a list of intents provided by this app (see here for more details) permissions a map of permissions needed by the app (see here for more details) notifications a map of notifications needed by the app (see here for more details) services a map of the services associated with the app (see below for more details) routes a map of routes for the app (see below for more details)","title":"The manifest"},{"location":"/cozy-stack/apps/#routes","text":"A route make the mapping between the requested paths and the files. It can have an index, which is an HTML file, with a token injected on it that identify both the application. This token must be used with the user cookies to use the services of the cozy-stack. By default, a route can be only visited by the authenticated owner of the instance where the app is installed. But a route can be marked as public. In that case, anybody can visit the route. For example, an application can offer an administration interface on /admin , a public page on /public , and shared assets in /assets : { /admin : { folder : / , index : admin.html , public : false }, /public : { folder : /public , index : index.html , public : true }, /assets : { folder : /assets , public : true } } If an application has no routes in its manifest, the stack will create one route, this default one: { / : { folder : / , index : index.html , public : false } } Note : if you have a public route, it s probably better to put the app icon in it. So, the cozy-bar can display it for the users that go on the public part of the app.","title":"Routes"},{"location":"/cozy-stack/apps/#services","text":"Application may require background and offline process to analyse the user s data and emit some notification or warning even without the user being on the application. These part of the application are called services and can be declared as part of the application in its manifest. In contrast to konnectors , services have the same permissions as the web application and are not intended to collect outside informations but rather analyse the current set of collected information inside the cozy. However they share the same mechanisms as the konnectors to describe how and when they should be executed: via our trigger system. To define a service, first the code needs to be stored with the application content, as single (packaged) javascript files. In the manifest, declare the service and its parameters following this example: { services : { low-budget-notification : { type : node , file : /services/low-budget-notification.js , trigger : @cron 0 0 0 * * * } // ... } } The trigger field should follow the available triggers described in the jobs documentation . The file field should specify the service code run and the type field describe the code type (only \"node\" for now).","title":"Services"},{"location":"/cozy-stack/apps/#notifications","text":"For more informations on how te declare notifications in the manifest, see the notifications documentation . Here is an example: { notifications : { account-balance : { description : Alert the user when its account balance is negative , collapsible : true, // only interested in the last value of the notification multiple : true, // require sub-categories for each account stateful : false, default_priority : high , // high priority for this notification templates : { mail : file:./notifications/account-balance-mail.tpl } } } }","title":"Notifications"},{"location":"/cozy-stack/apps/#resource-caching","text":"To help caching of applications assets, we detect the presence of a unique identifier in the name of assets: a unique identifier is matched when the file base name contains a long hexadecimal subpart between . , of at least 10 characters. For instance app.badf00dbadf00d.js or icon.badbeefbadbeef.1.png . With such a unique identifier, the asset is considered immutable, and a long cache-control is added on corresponding HTTP responses. We recommend the use of bundling tools like webpack which offer the possibility to add such identifier on the building step of the application packages for all assets.","title":"Resource caching"},{"location":"/cozy-stack/apps/#sources","text":"Here is the available sources, defined by the scheme of the source URL: registry:// : to install an application from the instance registries git:// or git+ssh:// : to install an application from a git repository http:// or https:// : to install an application from an http server (via a tarball) file:// : to install an application from a local directory (for instance: file:///home/user/code/cozy-app ) The registry scheme expect the following elements: scheme: registry host: the name of the application path: /:channel the channel of the application (see the registry doc) Examples: registry://drive/stable , registry://drive/beta , and registry://drive/dev . For the git scheme, the fragment in the URL can be used to specify which branch to install. For the http and https schemes, the fragment can be used to give the expected sha256sum.","title":"Sources"},{"location":"/cozy-stack/apps/#post-appsslug","text":"Install an application, ie download the files and put them in /apps/:slug in the virtual file system of the user, create an io.cozy.apps document, register the permissions, etc. This endpoint is asynchronous and returns a successful return as soon as the application installation has started, meaning we have successfully reached the manifest and started to fetch application data. To make this endpoint synchronous, use the header Accept: text/event-stream . This will make a eventsource stream sending the manifest and returning when the application has been installed or failed.","title":"POST /apps/:slug"},{"location":"/cozy-stack/apps/#status-codes","text":"202 Accepted, when the application installation has been accepted. 400 Bad-Request, when the manifest of the application could not be processed (for instance, it is not valid JSON). 404 Not Found, when the manifest or the source of the application is not reachable. 422 Unprocessable Entity, when the sent data is invalid (for example, the slug is invalid or the Source parameter is not a proper or supported url)","title":"Status codes"},{"location":"/cozy-stack/apps/#query-string","text":"Parameter Description Source URL from where the app can be downloaded (only for install)","title":"Query-String"},{"location":"/cozy-stack/apps/#request","text":"POST /apps/emails?Source=git://github.com/cozy/cozy-emails.git HTTP/1.1 Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/apps/#response","text":"HTTP/1.1 202 Accepted Content-Type: application/vnd.api+json { data : [{ id : 4cfbd8be-8968-11e6-9708-ef55b7c20863 , type : io.cozy.apps , meta : { rev : 1-7a1f918147df94580c92b47275e4604a }, attributes : { name : calendar , state : installing , slug : calendar , ... }, links : { self : /apps/calendar } }] } Note : it s possible to choose a git branch by passing it in the fragment like this: POST /apps/emails-dev?Source=git://github.com/cozy/cozy-emails.git%23dev HTTP/1.1","title":"Response"},{"location":"/cozy-stack/apps/#put-appsslug","text":"Update an application with the specified slug name. This endpoint is asynchronous and returns a successful return as soon as the application installation has started, meaning we have successfully reached the manifest and started to fetch application data. To make this endpoint synchronous, use the header Accept: text/event-stream . This will make a eventsource stream sending the manifest and returning when the application has been updated or failed.","title":"PUT /apps/:slug"},{"location":"/cozy-stack/apps/#request_1","text":"PUT /apps/emails HTTP/1.1 Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/apps/#response_1","text":"HTTP/1.1 202 Accepted Content-Type: application/vnd.api+json { data : [{ id : 4cfbd8be-8968-11e6-9708-ef55b7c20863 , type : io.cozy.apps , meta : { rev : 1-7a1f918147df94580c92b47275e4604a }, attributes : { name : calendar , state : installing , slug : calendar , ... }, links : { self : /apps/calendar } }] }","title":"Response"},{"location":"/cozy-stack/apps/#status-codes_1","text":"202 Accepted, when the application installation has been accepted. 400 Bad-Request, when the manifest of the application could not be processed (for instance, it is not valid JSON). 404 Not Found, when the application with the specified slug was not found or when the manifest or the source of the application is not reachable. 422 Unprocessable Entity, when the sent data is invalid (for example, the slug is invalid or the Source parameter is not a proper or supported url)","title":"Status codes"},{"location":"/cozy-stack/apps/#list-installed-applications","text":"","title":"List installed applications"},{"location":"/cozy-stack/apps/#get-apps","text":"An application can be in one of these states: installed , the application is installed but still require some user interaction to accept its permissions ready , the user can use it installing , the installation is running and the app will soon be usable upgrading , a new version is being installed errored , the app is in an error state and can not be used.","title":"GET /apps/"},{"location":"/cozy-stack/apps/#request_2","text":"GET /apps/ HTTP/1.1 Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/apps/#response_2","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : [{ id : 4cfbd8be-8968-11e6-9708-ef55b7c20863 , type : io.cozy.apps , meta : { rev : 2-bbfb0fc32dfcdb5333b28934f195b96a }, attributes : { name : calendar , state : ready , slug : calendar , ... }, links : { self : /apps/calendar , icon : /apps/calendar/icon , related : https://calendar.alice.example.com/ } }] }","title":"Response"},{"location":"/cozy-stack/apps/#get-informations-about-an-application","text":"","title":"Get informations about an application"},{"location":"/cozy-stack/apps/#get-appsslug","text":"","title":"GET /apps/:slug"},{"location":"/cozy-stack/apps/#get-the-icon-of-an-application","text":"","title":"Get the icon of an application"},{"location":"/cozy-stack/apps/#get-appsslugicon","text":"","title":"GET /apps/:slug/icon"},{"location":"/cozy-stack/apps/#request_3","text":"GET /apps/calendar/icon HTTP/1.1","title":"Request"},{"location":"/cozy-stack/apps/#response_3","text":"HTTP/1.1 200 OK Content-Type: image/svg+xml svg xmlns= http://www.w3.org/2000/svg width= 60 height= 60 viewBox= 0 0 60 60 title Calendar /title path fill= #fff fill-opacity= .011 d= M30 58.75c15.878 0 28.75-12.872 28.75-28.75s-12.872-28.75-28.75-28.75-28.75 12.872-28.75 28.75 12.872 28.75 28.75 28.75zm0 1.25c-16.569 0-30-13.432-30-30 0-16.569 13.431-30 30-30 16.568 0 30 13.431 30 30 0 16.568-13.432 30-30 30z / path d= M47.997 9h-35.993c-1.654 0-3.004 1.345-3.004 3.004v35.993c0 1.653 1.345 3.004 3.004 3.004h35.993c1.653 0 3.004-1.345 3.004-3.004v-35.993c0-1.654-1.345-3.004-3.004-3.004zm-35.997 3.035h4.148v2.257c0 .856.7 1.556 1.556 1.556s1.556-.7 1.556-1.556v-2.257h5.136v2.257c0 .856.7 1.556 1.556 1.556s1.556-.7 1.556-1.556v-2.257h5.137v2.257c0 .856.699 1.556 1.556 1.556s1.556-.7 1.556-1.556v-2.257h5.137v2.257c0 .856.699 1.556 1.556 1.556s1.556-.7 1.556-1.556v-2.257h3.992v6.965h-35.998v-6.965zm36 35.965h-36v-27h36v27zm-21.71-10.15c-.433.34-.997.51-1.69.51-.64 0-1.207-.137-1.7-.409-.493-.273-.933-.603-1.32-.99l-1.1 1.479c.453.508 1.027.934 1.72 1.28.693.347 1.56.521 2.6.521.613 0 1.19-.083 1.73-.25.54-.167 1.013-.407 1.42-.721.407-.312.727-.696.96-1.149.233-.453.35-.974.35-1.56 0-.841-.25-1.527-.75-2.061s-1.13-.9-1.89-1.1v-.08c.693-.268 1.237-.641 1.63-1.12.393-.48.59-1.08.59-1.8 0-.533-.1-1.01-.3-1.43-.2-.42-.48-.772-.84-1.06-.36-.287-.793-.503-1.3-.65-.507-.147-1.067-.22-1.68-.22-.76 0-1.45.147-2.07.44s-1.203.68-1.75 1.16l1.18 1.42c.387-.36.783-.65 1.19-.87.407-.22.863-.33 1.37-.33.587 0 1.047.15 1.38.45.333.3.5.717.5 1.25 0 .293-.057.566-.17.819-.113.253-.3.47-.56.65-.26.18-.6.319-1.02.42-.42.1-.943.149-1.57.149v1.681c.72 0 1.32.05 1.8.149.48.101.863.243 1.15.43.287.188.49.414.61.681.12.267.18.567.18.899 0 .602-.217 1.072-.65 1.412zm13.71.15h-3v-11h-2c-.4.24-.65.723-1.109.89-.461.167-1.25.49-1.891.61v1.5h3v8h-3v2h8v-2z / /svg","title":"Response"},{"location":"/cozy-stack/apps/#uninstall-an-application","text":"","title":"Uninstall an application"},{"location":"/cozy-stack/apps/#delete-appsslug","text":"","title":"DELETE /apps/:slug"},{"location":"/cozy-stack/apps/#request_4","text":"DELETE /apps/tasky HTTP/1.1","title":"Request"},{"location":"/cozy-stack/apps/#response_4","text":"HTTP/1.1 204 No Content","title":"Response"},{"location":"/cozy-stack/apps/#access-an-application","text":"Each application will run on its sub-domain. The sub-domain is the slug used when installing the application ( calendar.cozy.example.org if it was installed via a POST on /apps/calendar). On the main domain ( cozy.example.org ), there will be the registration process, the login form, and it will redirect to home.cozy.example.org for logged-in users.","title":"Access an application"},{"location":"/cozy-stack/apps/#rationale","text":"The applications have different roles and permissions. An application is identified when talking to the stack via a token. The token has to be injected in the application, one way or another, and it have to be unaccessible from other apps. If the applications run on the same domain (for example https://cozy.example.org/apps/calendar ), it s nearly impossible to protect an application to take the token of another application. The security model of the web is based too heavily on Same Origin Policy for that. If the token is put in the html of the index.html page of an app, another app can use the fetch API to get the html page, parse its content and extract the token. We can think of other ways to inject the token (indexeddb, URL, cookies) but none will provide a better isolation. Maybe in a couple years, when the origin spec will be more advanced. So, if having the apps on the same origin is not possible, we have to put them on several origins. One interesting way to do that is using sandboxed iframes. An iframe with the sandbox attribute , and not allow-same-origin in it, will be assigned to a unique origin. The W3C warns: Potentially hostile files should not be served from the same server as the file containing the iframe element. Sandboxing hostile content is of minimal help if an attacker can convince the user to just visit the hostile content directly, rather than in the iframe. To limit the damage that can be caused by hostile HTML content, it should be served from a separate dedicated domain. Using a different domain ensures that scripts in the files are unable to attack the site, even if the user is tricked into visiting those pages directly, without the protection of the sandbox attribute. It may be possible to disable all html pages to have an html content-type, except the home, and having the home loading the apps in a sandboxed iframe, via the srcdoc attribute. But, it will mean that we will have to reinvent nearly everything. Even showing an image can no longer be done via an img tag, it will need to use post-message with the home. Such a solution is difficult to implement, is a very fragile (both for the apps developer than for security) and is an hell to debug when it breaks. Clearly, it s not an acceptable solution. Thus, the only choice is to have several origins, and sub-domains is the best way for that. Of course, it has the downside to be more complicated to deploy (DNS and TLS certificates). But, in the tradeoff between security and ease of administration, we definetively take the security first.","title":"Rationale"},{"location":"/cozy-stack/apps/#routes_1","text":"Should we be concerned that all the routes are on the same sub-domain? No, it s not an issue. There are two types of routes: the ones that are publics and those reserved to the authenticated user. Public routes have no token Private routes are private, they can be accessed only with a valid session cookie, ie by the owner of the instance. Another application can t use the user cookies to read the token, because of the restrictions of the same origin policy (they are on different domains). And the application can t use an open proxy to read the private route, because it doesn t have the user cookies for that (the cookie is marked as httpOnly ).","title":"Routes"},{"location":"/cozy-stack/registry/","text":"Apps registry The apps registry is a place where developers can submit their applications, both web apps and konnectors. The applications metadata are stored and versioned. It can be used by a cozy to list applications to be installed, and for auto-updating the applications. We define the applications registry as an API. This should allow us to defer the real implementation of the registry storage and allow different store implementations. The stack itself implement the querying part of the registry API , proxying the request to the registries attached to the instance . Publishing on our official registries In order for you to publish on our official registries, please follow this howto describing how to obtain a token and parameter you repository to automatically publish versions. Channels We differentiate three channels of release for each application: stable: for stable releases beta: for application that can be tested in advance dev: for the latest releases directly from the trunk of the repository For each of these channels, the version string has a different format which differentiate the version channel: stable: X.Y.Z where X , Y and Z are positive or null integers. beta: X.Y.Z-beta.M where X , Y , Z and M are positive or null integers dev: X.Y.Z-dev.checksum where X , Y and Z are positive or null integers and checksum is a unique identifier of the dev release (typically a shasum of the git commit) Version order TLDR: 1.0.0-dev. 1.0.0 and 1.0.0-beta. 1.0.0, make sure you upgrade your app version after publishing stable. The order used to determine the latest version of a channel is the following: - `1.0.0-dev.* 1.0.0 (dev stable)` - `1.0.0-beta.* 1.0.0 (beta stable)` - `1.0.0-beta.1 1.0.0-beta.2` To order beta and dev releases, we apply a sort by their creation date. Objects Two types of objects are managed in the registry: applications and versions. Application An application described a specific package. It is linked to multiple versions (releases) of the application. An application object is mutable . An application object contains the following fields: slug : the application slug (unique) type : the application type ( webapp or konnector ) editor : the application editor name versions : an object containing all the channels versions latest_version : the latest available version Example: { slug : drive , type : webapp , editor : cozy , versions : { stable : [ 3.1.1 ], beta : [ 3.1.1-beta.1 ], dev : [ 3.1.1-dev.7a8354f74b50d7beead7719252a18ed45f55d070 ] }, latest_version : { /* */ } } Version A version object describe a specific release of an application. A version object is immutable . An application version object contains the following fields: slug : the application slug type : the application type (webapp, konnector, ) manifest : the entire manifest defined in the package created_at : date of the release creation url : URL of the tarball containing the application at specified version size : the size of the application package (uncompressed) in bytes as string sha256 : the sha256 checksum of the application content tar_prefix : optional tar prefix directory specified to properly extract the application content The version string should follow the channels rule. Example: { slug : drive , type : webapp , version : 3.1.2 , created_at : 2017-07-05T07:54:40.982Z , url : http://.../3.1.2 , size : 1000 , sha256 : 466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f , manifest : { /* ... */ } } APIs: Adding to registry These APIs can be used to add elements to the registry. POST /registry/:app This route adds or modify an application to the registry. The content of the request should be a json object of an application. Status codes 201 Created, when the application has been successfully added 409 Conflict, when an application with the same slug already exists 400 Bad request, if the given application data is malformed (bad slug, missing editor, ) Request POST /registry/drive HTTP/1.1 Authorization: Token AbCdE { slug : drive , editor : cozy , name : { en : Drive , fr : Drive }, description : { en : The drive application }, repository : https://github.com/cozy/cozy-drive , tags : [ foo , bar , baz ] } POST /registry/:app/:version or POST /registry/:app/versions This route adds a version of an application to the registry to the specified channel (stable, beta or dev). The content of the manifest file extracted from the application data is used to fill the fields of the version. Before adding the application version to the registry, the registry should check the following: the manifest file contained in the tarball should be checked and have its fields checked against the application properties the application content should check the sha256 checksum Fields of the object sent to this request: url : the url where the application tarball is stored sha256 : the sha256 checksum of the tarball version : the version value (should match the one in the manifest) parameters? : an optional json value (any) that will override the parameters field of the manifest icon? : an optional path to override the icon field of the manifest screenshots? : and optional array of path to override the screenshots field of the manifest Status codes 201 Created, when the version has been successfully added to the registry 409 Conflict, when the version already exists 404 Not Found, when the application does not exist 412 Precondition Failed, when the sent application data is invalid (could not fetch data URL, bad checksum, bad manifest in the tarball ) 400 Bad request, when the request is invalid (bad checksum encoding, bad URL ) Request Request to add a stable release: POST /registry/drive/3.1.2 HTTP/1.1 Authorization: Token AbCdE { version : 3.1.2 , url : https://github.com/cozy/cozy-drive/archive/v3.1.2.tar.gz , sha256 : 466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f } Request to add a development release: POST /registry/drive/3.1.2-dev.7a1618dff78ba445650f266bbe334cbc9176f03a HTTP/1.1 Authorization: Token AbCdE { version : 3.1.2-dev.7a1618dff78ba445650f266bbe334cbc9176f03a , url : https://github.com/cozy/cozy-photos-v3/archive/7a1618dff78ba445650f266bbe334cbc9176f03a.zip , sha256 : 466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f } Request to add a version with optional parameters: POST /registry/drive/3.1.2 HTTP/1.1 Authorization: Token AbCdE { version : 3.1.2 , url : https://github.com/cozy/cozy-photos-v3/archive/7a1618dff78ba445650f266bbe334cbc9176f03a.zip , sha256 : 466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f , parameters : { foo : bar , baz : 123 } } Response HTTP/1.1 201 Created Content-Type: application/json Location: http://.../3.1.2 { slug : drive , type : webapp , version : 3.1.2-dev.7a1618dff78ba445650f266bbe334cbc9176f03a , created_at : 2017-07-05T07:54:40.982Z , url : http://.../7a1618dff78ba445650f266bbe334cbc9176f03a.zip , size : 1000 , sha256 : 466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f , manifest : { /* ... */ } } APIs: Querying registry These routes define the querying part of a registry to access to the available applications and versions. These APIs are also implemented directly by the cozy-stack. GET /registry Get the list of all applications. A pagination scheme is available via the limit and cursor query parameter. The filter[???] query parameters can be used to filter by fields values. Filtering is allowed on the following fields: type editor category tags Filtering is allowed on multiple tags with the , separator. For example: filter[tags]=foo,bar will match the applications with both foo and bar as tags. Sorting is allowed on the following fields: slug type editor category created_at updated_at Query-String Parameter Description cursor the cursor of the last application on the previous page limit the maximum number of applications to show filter[] a filter to apply on fields of the application sort name of the field on which to apply the sort of the list latestVersionChannel the channel from which we select the latest version Request GET /registry?filter[category]=main limit=20 sort=slug latest latestVersionChannel=beta HTTP/1.1 Response HTTP/1.1 200 OK Content-Type: application/json { data : [ { slug : drive , type : webapp , editor : cozy , versions : { stable : [ 3.1.1 ], beta : [ 3.1.1-beta.1 ], dev : [ 3.1.1-dev.7a8354f74b50d7beead7719252a18ed45f55d070 ] }, latest_version : { slug : drive , type : webapp , version : 3.1.1 , url : http://.../3.1.1 , sha256 : 466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f , size : 1000 , created_at : 2017-07-05T07:54:40.982Z , manifest : { /* ... */ } }, }, { // ... } ], meta : { count : 2, next_cursor : ... } } GET /registry/:app Get an application object by slug. Request GET /registry/drive HTTP/1.1 Response HTTP/1.1 200 OK Content-Type: application/json { slug : drive , editor : cozy , latest_version : { slug : drive , type : webapp , version : 3.1.1 , url : http://.../3.1.1 , sha256 : 466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f , size : 1000 , created_at : 2017-07-05T07:54:40.982Z , manifest : { /* ... */ } }, versions : { stable : [ 3.1.1 ], beta : [ 3.1.1-beta.1 ], dev : [ 3.1.1-dev.7a8354f74b50d7beead7719252a18ed45f55d070 ] } } GET /registry/:app/icon Get the current application icon. Request GET /registry/drive/icon HTTP/1.1 Response HTTP/1.1 200 OK Content-Type: image/svg+xml svg xmlns= http://www.w3.org/2000/svg width= 64 height= 64 viewBox= 0 0 64 64 g fill= none fill-rule= evenodd /g /svg GET /registry/:app/screenshots/:filename Get the screenshot with the specified filename from the field screenshots of the application. Request GET /registry/drive/screenshots/screen1.jpg HTTP/1.1 Response HTTP/1.1 200 OK Content-Type: image/jpeg ... GET /registry/:app/:version Get an application version. Request GET /registry/drive/3.1.1 HTTP/1.1 Response HTTP/1.1 200 OK Content-Type: application/json { slug : drive , type : webapp , version : 3.1.1 , url : http://.../3.1.1 , sha256 : 466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f , size : 1000 , created_at : 2017-07-05T07:54:40.982Z , manifest : { /* ... */ } } GET /registry/:app/:channel/latest Get the latest version available on the specified channel. Request GET /registry/drive/dev/latest HTTP/1.1 Response HTTP/1.1 200 OK Content-Type: application/json { slug : drive , type : webapp , version : 3.1.1 , url : http://.../3.1.1 , sha256 : 466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f , size : 1000 , created_at : 2017-07-05T07:54:40.982Z , manifest : { /* ... */ } } Attaching a cozy-stack to a registry or a list of registries In the configuration file of a stack, a registries namespace is added. This namespace can contain a list of URL for the different registries attached to the stack. The stack itself implements the querying API of a registry. When querying this API, to ask for an application, the stack uses this hierarchy of registries to proxy or redirect the user. The hierarchy can also be contextualised to specify different registries to different contexts. The default context is applied lastly. Examples: registries: - https://myregistry.home/ - https://main.registry.cozy.io/ # In this example, a context1 instance will have the equivalent of the # following list of registries: # # - https://context1.registry.cozy.io/ # - https://myregistry.home/ # - https://registry.cozy.io/ # registries: context1: - https://context1.registry.cozy.io/ context2: - https://context2.registry.cozy.io/ default: - https://myregistry.home/ - https://registry.cozy.io/ Authentication The authentication is based on a token that allow you to publish applications and versions with for one specific editor name. This token is base64 encoded. In order to receive this token, please take a look at the page on publication on the registry .","title":"Apps registry"},{"location":"/cozy-stack/registry/#apps-registry","text":"The apps registry is a place where developers can submit their applications, both web apps and konnectors. The applications metadata are stored and versioned. It can be used by a cozy to list applications to be installed, and for auto-updating the applications. We define the applications registry as an API. This should allow us to defer the real implementation of the registry storage and allow different store implementations. The stack itself implement the querying part of the registry API , proxying the request to the registries attached to the instance .","title":"Apps registry"},{"location":"/cozy-stack/registry/#publishing-on-our-official-registries","text":"In order for you to publish on our official registries, please follow this howto describing how to obtain a token and parameter you repository to automatically publish versions.","title":"Publishing on our official registries"},{"location":"/cozy-stack/registry/#channels","text":"We differentiate three channels of release for each application: stable: for stable releases beta: for application that can be tested in advance dev: for the latest releases directly from the trunk of the repository For each of these channels, the version string has a different format which differentiate the version channel: stable: X.Y.Z where X , Y and Z are positive or null integers. beta: X.Y.Z-beta.M where X , Y , Z and M are positive or null integers dev: X.Y.Z-dev.checksum where X , Y and Z are positive or null integers and checksum is a unique identifier of the dev release (typically a shasum of the git commit)","title":"Channels"},{"location":"/cozy-stack/registry/#version-order","text":"TLDR: 1.0.0-dev. 1.0.0 and 1.0.0-beta. 1.0.0, make sure you upgrade your app version after publishing stable. The order used to determine the latest version of a channel is the following: - `1.0.0-dev.* 1.0.0 (dev stable)` - `1.0.0-beta.* 1.0.0 (beta stable)` - `1.0.0-beta.1 1.0.0-beta.2` To order beta and dev releases, we apply a sort by their creation date.","title":"Version order"},{"location":"/cozy-stack/registry/#objects","text":"Two types of objects are managed in the registry: applications and versions.","title":"Objects"},{"location":"/cozy-stack/registry/#application","text":"An application described a specific package. It is linked to multiple versions (releases) of the application. An application object is mutable . An application object contains the following fields: slug : the application slug (unique) type : the application type ( webapp or konnector ) editor : the application editor name versions : an object containing all the channels versions latest_version : the latest available version Example: { slug : drive , type : webapp , editor : cozy , versions : { stable : [ 3.1.1 ], beta : [ 3.1.1-beta.1 ], dev : [ 3.1.1-dev.7a8354f74b50d7beead7719252a18ed45f55d070 ] }, latest_version : { /* */ } }","title":"Application"},{"location":"/cozy-stack/registry/#version","text":"A version object describe a specific release of an application. A version object is immutable . An application version object contains the following fields: slug : the application slug type : the application type (webapp, konnector, ) manifest : the entire manifest defined in the package created_at : date of the release creation url : URL of the tarball containing the application at specified version size : the size of the application package (uncompressed) in bytes as string sha256 : the sha256 checksum of the application content tar_prefix : optional tar prefix directory specified to properly extract the application content The version string should follow the channels rule. Example: { slug : drive , type : webapp , version : 3.1.2 , created_at : 2017-07-05T07:54:40.982Z , url : http://.../3.1.2 , size : 1000 , sha256 : 466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f , manifest : { /* ... */ } }","title":"Version"},{"location":"/cozy-stack/registry/#apis-adding-to-registry","text":"These APIs can be used to add elements to the registry.","title":"APIs: Adding to registry"},{"location":"/cozy-stack/registry/#post-registryapp","text":"This route adds or modify an application to the registry. The content of the request should be a json object of an application.","title":"POST /registry/:app"},{"location":"/cozy-stack/registry/#status-codes","text":"201 Created, when the application has been successfully added 409 Conflict, when an application with the same slug already exists 400 Bad request, if the given application data is malformed (bad slug, missing editor, )","title":"Status codes"},{"location":"/cozy-stack/registry/#request","text":"POST /registry/drive HTTP/1.1 Authorization: Token AbCdE { slug : drive , editor : cozy , name : { en : Drive , fr : Drive }, description : { en : The drive application }, repository : https://github.com/cozy/cozy-drive , tags : [ foo , bar , baz ] }","title":"Request"},{"location":"/cozy-stack/registry/#post-registryappversion-or-post-registryappversions","text":"This route adds a version of an application to the registry to the specified channel (stable, beta or dev). The content of the manifest file extracted from the application data is used to fill the fields of the version. Before adding the application version to the registry, the registry should check the following: the manifest file contained in the tarball should be checked and have its fields checked against the application properties the application content should check the sha256 checksum Fields of the object sent to this request: url : the url where the application tarball is stored sha256 : the sha256 checksum of the tarball version : the version value (should match the one in the manifest) parameters? : an optional json value (any) that will override the parameters field of the manifest icon? : an optional path to override the icon field of the manifest screenshots? : and optional array of path to override the screenshots field of the manifest","title":"POST /registry/:app/:version or POST /registry/:app/versions"},{"location":"/cozy-stack/registry/#status-codes_1","text":"201 Created, when the version has been successfully added to the registry 409 Conflict, when the version already exists 404 Not Found, when the application does not exist 412 Precondition Failed, when the sent application data is invalid (could not fetch data URL, bad checksum, bad manifest in the tarball ) 400 Bad request, when the request is invalid (bad checksum encoding, bad URL )","title":"Status codes"},{"location":"/cozy-stack/registry/#request_1","text":"Request to add a stable release: POST /registry/drive/3.1.2 HTTP/1.1 Authorization: Token AbCdE { version : 3.1.2 , url : https://github.com/cozy/cozy-drive/archive/v3.1.2.tar.gz , sha256 : 466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f } Request to add a development release: POST /registry/drive/3.1.2-dev.7a1618dff78ba445650f266bbe334cbc9176f03a HTTP/1.1 Authorization: Token AbCdE { version : 3.1.2-dev.7a1618dff78ba445650f266bbe334cbc9176f03a , url : https://github.com/cozy/cozy-photos-v3/archive/7a1618dff78ba445650f266bbe334cbc9176f03a.zip , sha256 : 466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f } Request to add a version with optional parameters: POST /registry/drive/3.1.2 HTTP/1.1 Authorization: Token AbCdE { version : 3.1.2 , url : https://github.com/cozy/cozy-photos-v3/archive/7a1618dff78ba445650f266bbe334cbc9176f03a.zip , sha256 : 466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f , parameters : { foo : bar , baz : 123 } }","title":"Request"},{"location":"/cozy-stack/registry/#response","text":"HTTP/1.1 201 Created Content-Type: application/json Location: http://.../3.1.2 { slug : drive , type : webapp , version : 3.1.2-dev.7a1618dff78ba445650f266bbe334cbc9176f03a , created_at : 2017-07-05T07:54:40.982Z , url : http://.../7a1618dff78ba445650f266bbe334cbc9176f03a.zip , size : 1000 , sha256 : 466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f , manifest : { /* ... */ } }","title":"Response"},{"location":"/cozy-stack/registry/#apis-querying-registry","text":"These routes define the querying part of a registry to access to the available applications and versions. These APIs are also implemented directly by the cozy-stack.","title":"APIs: Querying registry"},{"location":"/cozy-stack/registry/#get-registry","text":"Get the list of all applications. A pagination scheme is available via the limit and cursor query parameter. The filter[???] query parameters can be used to filter by fields values. Filtering is allowed on the following fields: type editor category tags Filtering is allowed on multiple tags with the , separator. For example: filter[tags]=foo,bar will match the applications with both foo and bar as tags. Sorting is allowed on the following fields: slug type editor category created_at updated_at","title":"GET /registry"},{"location":"/cozy-stack/registry/#query-string","text":"Parameter Description cursor the cursor of the last application on the previous page limit the maximum number of applications to show filter[] a filter to apply on fields of the application sort name of the field on which to apply the sort of the list latestVersionChannel the channel from which we select the latest version","title":"Query-String"},{"location":"/cozy-stack/registry/#request_2","text":"GET /registry?filter[category]=main limit=20 sort=slug latest latestVersionChannel=beta HTTP/1.1","title":"Request"},{"location":"/cozy-stack/registry/#response_1","text":"HTTP/1.1 200 OK Content-Type: application/json { data : [ { slug : drive , type : webapp , editor : cozy , versions : { stable : [ 3.1.1 ], beta : [ 3.1.1-beta.1 ], dev : [ 3.1.1-dev.7a8354f74b50d7beead7719252a18ed45f55d070 ] }, latest_version : { slug : drive , type : webapp , version : 3.1.1 , url : http://.../3.1.1 , sha256 : 466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f , size : 1000 , created_at : 2017-07-05T07:54:40.982Z , manifest : { /* ... */ } }, }, { // ... } ], meta : { count : 2, next_cursor : ... } }","title":"Response"},{"location":"/cozy-stack/registry/#get-registryapp","text":"Get an application object by slug.","title":"GET /registry/:app"},{"location":"/cozy-stack/registry/#request_3","text":"GET /registry/drive HTTP/1.1","title":"Request"},{"location":"/cozy-stack/registry/#response_2","text":"HTTP/1.1 200 OK Content-Type: application/json { slug : drive , editor : cozy , latest_version : { slug : drive , type : webapp , version : 3.1.1 , url : http://.../3.1.1 , sha256 : 466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f , size : 1000 , created_at : 2017-07-05T07:54:40.982Z , manifest : { /* ... */ } }, versions : { stable : [ 3.1.1 ], beta : [ 3.1.1-beta.1 ], dev : [ 3.1.1-dev.7a8354f74b50d7beead7719252a18ed45f55d070 ] } }","title":"Response"},{"location":"/cozy-stack/registry/#get-registryappicon","text":"Get the current application icon.","title":"GET /registry/:app/icon"},{"location":"/cozy-stack/registry/#request_4","text":"GET /registry/drive/icon HTTP/1.1","title":"Request"},{"location":"/cozy-stack/registry/#response_3","text":"HTTP/1.1 200 OK Content-Type: image/svg+xml svg xmlns= http://www.w3.org/2000/svg width= 64 height= 64 viewBox= 0 0 64 64 g fill= none fill-rule= evenodd /g /svg","title":"Response"},{"location":"/cozy-stack/registry/#get-registryappscreenshotsfilename","text":"Get the screenshot with the specified filename from the field screenshots of the application.","title":"GET /registry/:app/screenshots/:filename"},{"location":"/cozy-stack/registry/#request_5","text":"GET /registry/drive/screenshots/screen1.jpg HTTP/1.1","title":"Request"},{"location":"/cozy-stack/registry/#response_4","text":"HTTP/1.1 200 OK Content-Type: image/jpeg ...","title":"Response"},{"location":"/cozy-stack/registry/#get-registryappversion","text":"Get an application version.","title":"GET /registry/:app/:version"},{"location":"/cozy-stack/registry/#request_6","text":"GET /registry/drive/3.1.1 HTTP/1.1","title":"Request"},{"location":"/cozy-stack/registry/#response_5","text":"HTTP/1.1 200 OK Content-Type: application/json { slug : drive , type : webapp , version : 3.1.1 , url : http://.../3.1.1 , sha256 : 466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f , size : 1000 , created_at : 2017-07-05T07:54:40.982Z , manifest : { /* ... */ } }","title":"Response"},{"location":"/cozy-stack/registry/#get-registryappchannellatest","text":"Get the latest version available on the specified channel.","title":"GET /registry/:app/:channel/latest"},{"location":"/cozy-stack/registry/#request_7","text":"GET /registry/drive/dev/latest HTTP/1.1","title":"Request"},{"location":"/cozy-stack/registry/#response_6","text":"HTTP/1.1 200 OK Content-Type: application/json { slug : drive , type : webapp , version : 3.1.1 , url : http://.../3.1.1 , sha256 : 466aa0815926fdbf33fda523af2b9bf34520906ffbb9bf512ddf20df2992a46f , size : 1000 , created_at : 2017-07-05T07:54:40.982Z , manifest : { /* ... */ } }","title":"Response"},{"location":"/cozy-stack/registry/#attaching-a-cozy-stack-to-a-registry-or-a-list-of-registries","text":"In the configuration file of a stack, a registries namespace is added. This namespace can contain a list of URL for the different registries attached to the stack. The stack itself implements the querying API of a registry. When querying this API, to ask for an application, the stack uses this hierarchy of registries to proxy or redirect the user. The hierarchy can also be contextualised to specify different registries to different contexts. The default context is applied lastly.","title":"Attaching a cozy-stack to a registry or a list of registries"},{"location":"/cozy-stack/registry/#examples","text":"registries: - https://myregistry.home/ - https://main.registry.cozy.io/ # In this example, a context1 instance will have the equivalent of the # following list of registries: # # - https://context1.registry.cozy.io/ # - https://myregistry.home/ # - https://registry.cozy.io/ # registries: context1: - https://context1.registry.cozy.io/ context2: - https://context2.registry.cozy.io/ default: - https://myregistry.home/ - https://registry.cozy.io/","title":"Examples:"},{"location":"/cozy-stack/registry/#authentication","text":"The authentication is based on a token that allow you to publish applications and versions with for one specific editor name. This token is base64 encoded. In order to receive this token, please take a look at the page on publication on the registry .","title":"Authentication"},{"location":"/cozy-stack/data-system/","text":"Table of contents Data System Typing The notion of document type does not exist in Couchdb. Cozy-stack introduce this notion through a special _type field. This type name cannot contain / , and it should be unique among all developers, it is recommended to use the Java naming convention with a domain you own. All CozyCloud types will be prefixed by io.cozy and be pluralized. Example : /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee Where, io.cozy. is the developer specific prefix, events the actual type, and 6494e0ac-dfcb-11e5-88c1-472e84a9cbee the document s unique id . Access a document Request GET /data/:type/:id HTTP/1.1 GET /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee HTTP/1.1 Response OK HTTP/1.1 200 OK Date: Mon, 27 Sept 2016 12:28:53 GMT Content-Length: ... Content-Type: application/json Etag: 3-6494e0ac6494e0ac { _id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , _type : io.cozy.events , _rev : 3-6494e0ac6494e0ac , startdate : 20160823T150000Z , enddate : 20160923T160000Z , summary : A long month , description : I could go on and on and on .... } Response Error HTTP/1.1 404 Not Found Content-Length: ... Content-Type: application/json { status : 404, error : not_found , reason : deleted , title : Event deleted , details : Event 6494e0ac-dfcb-11e5-88c1-472e84a9cbee was deleted , links : { about : https://cozy.github.io/cozy-stack/errors.md#deleted } } possible errors : 401 unauthorized (no authentication has been provided) 403 forbidden (the authentication does not provide permissions for this action) 404 not_found reason: missing reason: deleted 500 internal server error Access multiple documents at once Request POST /data/:type/_all_docs HTTP/1.1 POST /data/io.cozy.files/_all_docs?include_docs=true HTTP/1.1 Content-Length: ... Content-Type: application/json Accept: application/json { keys : [ 7f46ed4ed2a775494da3b0b44e00314f , 7f46ed4ed2a775494da3b0b44e003b18 ] } Response OK HTTP/1.1 200 OK Date: Mon, 27 Sept 2016 12:28:53 GMT Content-Length: ... Content-Type: application/json Etag: 3-6494e0ac6494e0ac { total_rows : 11, rows : [ { id : 7f46ed4ed2a775494da3b0b44e00314f , key : 7f46ed4ed2a775494da3b0b44e00314f , value : { rev : 1-870e58f8a1b2130c3a41e767f9c7d93a }, doc : { _id : 7f46ed4ed2a775494da3b0b44e00314f , _rev : 1-870e58f8a1b2130c3a41e767f9c7d93a , type : directory , name : Uploaded from Cozy Photos , dir_id : 7f46ed4ed2a775494da3b0b44e0027df , created_at : 2017-07-04T06:49:12.844631837Z , updated_at : 2017-07-04T06:49:12.844631837Z , tags : [], path : /Photos/Uploaded from Cozy Photos } }, { key : 7f46ed4ed2a775494da3b0b44e003b18 , error : not_found } ] } possible errors : 401 unauthorized (no authentication has been provided) 403 forbidden (the authentication does not provide permissions for this action) 500 internal server error Details When some keys don t match an existing document, the response still has a status 200 and the errors are included in the rows field (see above, same behavior as CouchDB ). Create a document Request POST /data/:type/ HTTP/1.1 POST /data/io.cozy.events/ HTTP/1.1 Content-Length: ... Content-Type: application/json Accept: application/json { startdate : 20160712T150000 , enddate : 20160712T150000 } Response OK HTTP/1.1 201 Created Content-Length: ... Content-Type: application/json { id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , type : io.cozy.events , ok : true, rev : 1-6494e0ac6494e0ac , data : { _id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , _type : io.cozy.events , _rev : 1-6494e0ac6494e0ac , startdate : 20160712T150000 , enddate : 20160712T150000 } } possible errors : 400 bad request 401 unauthorized (no authentication has been provided) 403 forbidden (the authentication does not provide permissions for this action) 500 internal server error Details A doc cannot contain an _id field, if so an error 400 is returned A doc cannot contain any field starting with _ , those are reserved for future cozy couchdb api evolution Update an existing document Request PUT /data/:type/:id HTTP/1.1 PUT /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee HTTP/1.1 Content-Length: ... Content-Type: application/json Accept: application/json { _id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , _type : io.cozy.events , _rev : 1-6494e0ac6494e0ac , startdate : 20160712T150000 , enddate : 20160712T200000 } Response OK HTTP/1.1 200 OK Content-Length: ... Content-Type: application/json { id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , type : io.cozy.events , ok : true, rev : 2-056f5f44046ecafc08a2bc2b9c229e20 , data : { _id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , _type : io.cozy.events , _rev : 2-056f5f44046ecafc08a2bc2b9c229e20 , startdate : 20160712T150000 , enddate : 20160712T200000 } } Possible errors : 400 bad request 401 unauthorized (no authentication has been provided) 403 forbidden (the authentication does not provide permissions for this action) 404 not_found reason: missing reason: deleted 409 Conflict (see Conflict prevention section below) 500 internal server error Conflict prevention The client MUST give a _rev field in the document. If this field is different from the one in the current version of the document, an error 409 Conflict will be returned. Details If no id is provided in URL, an error 400 is returned If the id provided in URL is not the same than the one in document, an error 400 is returned. Create a document with a fixed id Request PUT /data/:type/:id HTTP/1.1 PUT /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee HTTP/1.1 Content-Length: ... Content-Type: application/json Accept: application/json { startdate : 20160712T150000 , enddate : 20160712T200000 } Response OK HTTP/1.1 200 OK Content-Length: ... Content-Type: application/json { id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , type : io.cozy.events , ok : true, rev : 1-056f5f44046ecafc08a2bc2b9c229e20 , data : { _id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , _type : io.cozy.events , _rev : 1-056f5f44046ecafc08a2bc2b9c229e20 , startdate : 20160712T150000 , enddate : 20160712T200000 } } Possible errors : 400 bad request 401 unauthorized (no authentication has been provided) 403 forbidden (the authentication does not provide permissions for this action) 404 not_found reason: missing reason: deleted 409 Conflict (see Conflict prevention section below) 500 internal server error Details No id should be provide in the document itself Delete a document Request DELETE /data/:type/:id?rev=:rev HTTP/1.1 DELETE /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee?rev=1-82a7144c9ec228c9a851b8a1c1aa225b HTTP/1.1 Accept: application/json Response OK HTTP/1.1 200 OK Content-Length: ... Content-Type: application/json { id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , type : io.cozy.events , ok : true, rev : 2-056f5f44046ecafc08a2bc2b9c229e20 , _deleted : true } Possible errors : 400 bad request 401 unauthorized (no authentication has been provided) 403 forbidden (the authentication does not provide permissions for this action) 404 not_found reason: missing reason: deleted 409 Conflict (see Conflict prevention section below) 500 internal server error Conflict prevention It is possible to use either a rev query string parameter or a HTTP If-Match header to prevent conflict on deletion: If none is passed or they are different, an error 400 is returned If only one is passed or they are equals, the document will only be deleted if its _rev match the passed one. Otherwise, an error 409 is returned. Details If no id is provided in URL, an error 400 is returned List all the documents Request GET /data/io.cozy.events/_all_docs?include_docs=true HTTP/1.1 Accept: application/json Response HTTP/1.1 200 OK Content-Type: application/json { offset : 0, rows : [ { id : 16e458537602f5ef2a710089dffd9453 , key : 16e458537602f5ef2a710089dffd9453 , value : { rev : 1-967a00dff5e02add41819138abb3284d }, doc : { field : value } }, { id : f4ca7773ddea715afebc4b4b15d4f0b3 , key : f4ca7773ddea715afebc4b4b15d4f0b3 , value : { rev : 2-7051cbe5c8faecd085a3fa619e6e6337 }, doc : { field : other-value } } ], total_rows : 2 } Details See _all_docs in couchdb docs List the known doctypes Request GET /data/_all_doctypes HTTP/1.1 Accept: application/json Response HTTP/1.1 200 OK Content-Type: application/json [ io.cozy.files , io.cozy.jobs , io.cozy.triggers , io.cozy.settings ] Others The creation and usage of Mango indexes is possible. CouchDB behaviors are not always straight forward: see some quirks for more details.","title":"/data - Data System"},{"location":"/cozy-stack/data-system/#data-system","text":"","title":"Data System"},{"location":"/cozy-stack/data-system/#typing","text":"The notion of document type does not exist in Couchdb. Cozy-stack introduce this notion through a special _type field. This type name cannot contain / , and it should be unique among all developers, it is recommended to use the Java naming convention with a domain you own. All CozyCloud types will be prefixed by io.cozy and be pluralized. Example : /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee Where, io.cozy. is the developer specific prefix, events the actual type, and 6494e0ac-dfcb-11e5-88c1-472e84a9cbee the document s unique id .","title":"Typing"},{"location":"/cozy-stack/data-system/#access-a-document","text":"","title":"Access a document"},{"location":"/cozy-stack/data-system/#request","text":"GET /data/:type/:id HTTP/1.1 GET /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee HTTP/1.1","title":"Request"},{"location":"/cozy-stack/data-system/#response-ok","text":"HTTP/1.1 200 OK Date: Mon, 27 Sept 2016 12:28:53 GMT Content-Length: ... Content-Type: application/json Etag: 3-6494e0ac6494e0ac { _id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , _type : io.cozy.events , _rev : 3-6494e0ac6494e0ac , startdate : 20160823T150000Z , enddate : 20160923T160000Z , summary : A long month , description : I could go on and on and on .... }","title":"Response OK"},{"location":"/cozy-stack/data-system/#response-error","text":"HTTP/1.1 404 Not Found Content-Length: ... Content-Type: application/json { status : 404, error : not_found , reason : deleted , title : Event deleted , details : Event 6494e0ac-dfcb-11e5-88c1-472e84a9cbee was deleted , links : { about : https://cozy.github.io/cozy-stack/errors.md#deleted } }","title":"Response Error"},{"location":"/cozy-stack/data-system/#possible-errors","text":"401 unauthorized (no authentication has been provided) 403 forbidden (the authentication does not provide permissions for this action) 404 not_found reason: missing reason: deleted 500 internal server error","title":"possible errors :"},{"location":"/cozy-stack/data-system/#access-multiple-documents-at-once","text":"","title":"Access multiple documents at once"},{"location":"/cozy-stack/data-system/#request_1","text":"POST /data/:type/_all_docs HTTP/1.1 POST /data/io.cozy.files/_all_docs?include_docs=true HTTP/1.1 Content-Length: ... Content-Type: application/json Accept: application/json { keys : [ 7f46ed4ed2a775494da3b0b44e00314f , 7f46ed4ed2a775494da3b0b44e003b18 ] }","title":"Request"},{"location":"/cozy-stack/data-system/#response-ok_1","text":"HTTP/1.1 200 OK Date: Mon, 27 Sept 2016 12:28:53 GMT Content-Length: ... Content-Type: application/json Etag: 3-6494e0ac6494e0ac { total_rows : 11, rows : [ { id : 7f46ed4ed2a775494da3b0b44e00314f , key : 7f46ed4ed2a775494da3b0b44e00314f , value : { rev : 1-870e58f8a1b2130c3a41e767f9c7d93a }, doc : { _id : 7f46ed4ed2a775494da3b0b44e00314f , _rev : 1-870e58f8a1b2130c3a41e767f9c7d93a , type : directory , name : Uploaded from Cozy Photos , dir_id : 7f46ed4ed2a775494da3b0b44e0027df , created_at : 2017-07-04T06:49:12.844631837Z , updated_at : 2017-07-04T06:49:12.844631837Z , tags : [], path : /Photos/Uploaded from Cozy Photos } }, { key : 7f46ed4ed2a775494da3b0b44e003b18 , error : not_found } ] }","title":"Response OK"},{"location":"/cozy-stack/data-system/#possible-errors_1","text":"401 unauthorized (no authentication has been provided) 403 forbidden (the authentication does not provide permissions for this action) 500 internal server error","title":"possible errors :"},{"location":"/cozy-stack/data-system/#details","text":"When some keys don t match an existing document, the response still has a status 200 and the errors are included in the rows field (see above, same behavior as CouchDB ).","title":"Details"},{"location":"/cozy-stack/data-system/#create-a-document","text":"","title":"Create a document"},{"location":"/cozy-stack/data-system/#request_2","text":"POST /data/:type/ HTTP/1.1 POST /data/io.cozy.events/ HTTP/1.1 Content-Length: ... Content-Type: application/json Accept: application/json { startdate : 20160712T150000 , enddate : 20160712T150000 }","title":"Request"},{"location":"/cozy-stack/data-system/#response-ok_2","text":"HTTP/1.1 201 Created Content-Length: ... Content-Type: application/json { id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , type : io.cozy.events , ok : true, rev : 1-6494e0ac6494e0ac , data : { _id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , _type : io.cozy.events , _rev : 1-6494e0ac6494e0ac , startdate : 20160712T150000 , enddate : 20160712T150000 } }","title":"Response OK"},{"location":"/cozy-stack/data-system/#possible-errors_2","text":"400 bad request 401 unauthorized (no authentication has been provided) 403 forbidden (the authentication does not provide permissions for this action) 500 internal server error","title":"possible errors :"},{"location":"/cozy-stack/data-system/#details_1","text":"A doc cannot contain an _id field, if so an error 400 is returned A doc cannot contain any field starting with _ , those are reserved for future cozy couchdb api evolution","title":"Details"},{"location":"/cozy-stack/data-system/#update-an-existing-document","text":"","title":"Update an existing document"},{"location":"/cozy-stack/data-system/#request_3","text":"PUT /data/:type/:id HTTP/1.1 PUT /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee HTTP/1.1 Content-Length: ... Content-Type: application/json Accept: application/json { _id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , _type : io.cozy.events , _rev : 1-6494e0ac6494e0ac , startdate : 20160712T150000 , enddate : 20160712T200000 }","title":"Request"},{"location":"/cozy-stack/data-system/#response-ok_3","text":"HTTP/1.1 200 OK Content-Length: ... Content-Type: application/json { id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , type : io.cozy.events , ok : true, rev : 2-056f5f44046ecafc08a2bc2b9c229e20 , data : { _id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , _type : io.cozy.events , _rev : 2-056f5f44046ecafc08a2bc2b9c229e20 , startdate : 20160712T150000 , enddate : 20160712T200000 } }","title":"Response OK"},{"location":"/cozy-stack/data-system/#possible-errors_3","text":"400 bad request 401 unauthorized (no authentication has been provided) 403 forbidden (the authentication does not provide permissions for this action) 404 not_found reason: missing reason: deleted 409 Conflict (see Conflict prevention section below) 500 internal server error","title":"Possible errors :"},{"location":"/cozy-stack/data-system/#conflict-prevention","text":"The client MUST give a _rev field in the document. If this field is different from the one in the current version of the document, an error 409 Conflict will be returned.","title":"Conflict prevention"},{"location":"/cozy-stack/data-system/#details_2","text":"If no id is provided in URL, an error 400 is returned If the id provided in URL is not the same than the one in document, an error 400 is returned.","title":"Details"},{"location":"/cozy-stack/data-system/#create-a-document-with-a-fixed-id","text":"","title":"Create a document with a fixed id"},{"location":"/cozy-stack/data-system/#request_4","text":"PUT /data/:type/:id HTTP/1.1 PUT /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee HTTP/1.1 Content-Length: ... Content-Type: application/json Accept: application/json { startdate : 20160712T150000 , enddate : 20160712T200000 }","title":"Request"},{"location":"/cozy-stack/data-system/#response-ok_4","text":"HTTP/1.1 200 OK Content-Length: ... Content-Type: application/json { id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , type : io.cozy.events , ok : true, rev : 1-056f5f44046ecafc08a2bc2b9c229e20 , data : { _id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , _type : io.cozy.events , _rev : 1-056f5f44046ecafc08a2bc2b9c229e20 , startdate : 20160712T150000 , enddate : 20160712T200000 } }","title":"Response OK"},{"location":"/cozy-stack/data-system/#possible-errors_4","text":"400 bad request 401 unauthorized (no authentication has been provided) 403 forbidden (the authentication does not provide permissions for this action) 404 not_found reason: missing reason: deleted 409 Conflict (see Conflict prevention section below) 500 internal server error","title":"Possible errors :"},{"location":"/cozy-stack/data-system/#details_3","text":"No id should be provide in the document itself","title":"Details"},{"location":"/cozy-stack/data-system/#delete-a-document","text":"","title":"Delete a document"},{"location":"/cozy-stack/data-system/#request_5","text":"DELETE /data/:type/:id?rev=:rev HTTP/1.1 DELETE /data/io.cozy.events/6494e0ac-dfcb-11e5-88c1-472e84a9cbee?rev=1-82a7144c9ec228c9a851b8a1c1aa225b HTTP/1.1 Accept: application/json","title":"Request"},{"location":"/cozy-stack/data-system/#response-ok_5","text":"HTTP/1.1 200 OK Content-Length: ... Content-Type: application/json { id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , type : io.cozy.events , ok : true, rev : 2-056f5f44046ecafc08a2bc2b9c229e20 , _deleted : true }","title":"Response OK"},{"location":"/cozy-stack/data-system/#possible-errors_5","text":"400 bad request 401 unauthorized (no authentication has been provided) 403 forbidden (the authentication does not provide permissions for this action) 404 not_found reason: missing reason: deleted 409 Conflict (see Conflict prevention section below) 500 internal server error","title":"Possible errors :"},{"location":"/cozy-stack/data-system/#conflict-prevention_1","text":"It is possible to use either a rev query string parameter or a HTTP If-Match header to prevent conflict on deletion: If none is passed or they are different, an error 400 is returned If only one is passed or they are equals, the document will only be deleted if its _rev match the passed one. Otherwise, an error 409 is returned.","title":"Conflict prevention"},{"location":"/cozy-stack/data-system/#details_4","text":"If no id is provided in URL, an error 400 is returned","title":"Details"},{"location":"/cozy-stack/data-system/#list-all-the-documents","text":"","title":"List all the documents"},{"location":"/cozy-stack/data-system/#request_6","text":"GET /data/io.cozy.events/_all_docs?include_docs=true HTTP/1.1 Accept: application/json","title":"Request"},{"location":"/cozy-stack/data-system/#response","text":"HTTP/1.1 200 OK Content-Type: application/json { offset : 0, rows : [ { id : 16e458537602f5ef2a710089dffd9453 , key : 16e458537602f5ef2a710089dffd9453 , value : { rev : 1-967a00dff5e02add41819138abb3284d }, doc : { field : value } }, { id : f4ca7773ddea715afebc4b4b15d4f0b3 , key : f4ca7773ddea715afebc4b4b15d4f0b3 , value : { rev : 2-7051cbe5c8faecd085a3fa619e6e6337 }, doc : { field : other-value } } ], total_rows : 2 }","title":"Response"},{"location":"/cozy-stack/data-system/#details_5","text":"See _all_docs in couchdb docs","title":"Details"},{"location":"/cozy-stack/data-system/#list-the-known-doctypes","text":"","title":"List the known doctypes"},{"location":"/cozy-stack/data-system/#request_7","text":"GET /data/_all_doctypes HTTP/1.1 Accept: application/json","title":"Request"},{"location":"/cozy-stack/data-system/#response_1","text":"HTTP/1.1 200 OK Content-Type: application/json [ io.cozy.files , io.cozy.jobs , io.cozy.triggers , io.cozy.settings ]","title":"Response"},{"location":"/cozy-stack/data-system/#others","text":"The creation and usage of Mango indexes is possible. CouchDB behaviors are not always straight forward: see some quirks for more details.","title":"Others"},{"location":"/cozy-stack/mango/","text":"Table of contents Mango Create an index for some documents The body should contain a index JSON field containing a fields which is an ordered array of fields to index. Request POST /data/:doctype/_index HTTP/1.1 POST /data/io.cozy.events/_index HTTP/1.1 Content-Type: application/json { index : { fields : [ calendar , date ] } } Response OK HTTP/1.1 200 OK Date: Mon, 27 Sept 2016 12:28:53 GMT Content-Length: ... Content-Type: application/json { result : created , id : _design/a5f4711fc9448864a13c81dc71e660b524d7410c , name : a5f4711fc9448864a13c81dc71e660b524d7410c } Details if the doctype does not exist, the database is created. if the index already exists, a {result: \"exists\"} is returned, but the response code is still 200 design doc name can be provided in request. This is not recommended , let couchdb handle naming and deduplication. { name : by-calendar-and-date , ddoc : _design/some-ddoc-name , index : { fields : ... } } possible errors : 401 unauthorized (no authentication has been provided) 403 forbidden (the authentication does not provide permissions for this action) 500 internal server error Find documents Find allows to find documents using a mango selector. You can read more about mango selectors here Request POST /data/:doctype/_find HTTP/1.1 POST /data/io.cozy.events/_find HTTP/1.1 Content-Type: application/json { selector : { calendar : perso , date : { $gt : 20161001T00:00:00 } }, limit : 2, skip : 3, sort : [ calendar , date ], fields : [ _id , _type , _date ], use_index : _design/a5f4711fc9448864a13c81dc71e660b524d7410c } Response OK HTTP/1.1 200 OK Date: Mon, 27 Sept 2016 12:28:53 GMT Content-Length: ... Content-Type: application/json { docs : [ { _id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , _type : io.cozy.events , date : 20161023T160000Z }, { _id : 6494e0ac-dfcb-472e84a9cbee , _type : io.cozy.events , date : 20161013T160000Z } ] } Details If an index does not exist for the selector, an error 400 is returned The sort field must contains all fields used in selector The sort field must match an existing index It is possible to sort in reverse direction sort:[{\"calendar\":\"desc\"}, {\"date\": \"desc\"}] but all fields must be sorted in same direction. use_index is optional but recommended. Pagination cookbook Pagination of mango query should be handled by the client. The stack will always limit query results to maximum 100 docs. The limit applied to a query is visible in the HTTP response. If the limit cause some docs to not be returned, the response will have a next=true top level values. { limit : 100, next : true, docs : [ ... first hundred docs ... ] } If the number of docs is lower or equal to the limit, next will be false { limit : 100, next : false, docs : [ ... less than a hundred docs ... ] } To paginate, the client should keep track of the value of the last index field. Exemple : Index on io.cozy.events with fields [\"calendar\", \"date\"] Try to get all events for a month : selector: { calendar : my-calendar , date : { $gt : 20161001 , $lt : 20161030 } } If there is less than 100 events, the response next field will be false and there is nothing more to do. If there is more than 100 events for this month, we have a next=true in the response. To keep iterating, we can take the date from the last item we received in the results and use it as next request $gte selector: { calendar : my-calendar , date : { $gte : 20161023 , $lt : 20161030 } }","title":"Mango"},{"location":"/cozy-stack/mango/#mango","text":"","title":"Mango"},{"location":"/cozy-stack/mango/#create-an-index-for-some-documents","text":"The body should contain a index JSON field containing a fields which is an ordered array of fields to index.","title":"Create an index for some documents"},{"location":"/cozy-stack/mango/#request","text":"POST /data/:doctype/_index HTTP/1.1 POST /data/io.cozy.events/_index HTTP/1.1 Content-Type: application/json { index : { fields : [ calendar , date ] } }","title":"Request"},{"location":"/cozy-stack/mango/#response-ok","text":"HTTP/1.1 200 OK Date: Mon, 27 Sept 2016 12:28:53 GMT Content-Length: ... Content-Type: application/json { result : created , id : _design/a5f4711fc9448864a13c81dc71e660b524d7410c , name : a5f4711fc9448864a13c81dc71e660b524d7410c }","title":"Response OK"},{"location":"/cozy-stack/mango/#details","text":"if the doctype does not exist, the database is created. if the index already exists, a {result: \"exists\"} is returned, but the response code is still 200 design doc name can be provided in request. This is not recommended , let couchdb handle naming and deduplication. { name : by-calendar-and-date , ddoc : _design/some-ddoc-name , index : { fields : ... } }","title":"Details"},{"location":"/cozy-stack/mango/#possible-errors","text":"401 unauthorized (no authentication has been provided) 403 forbidden (the authentication does not provide permissions for this action) 500 internal server error","title":"possible errors :"},{"location":"/cozy-stack/mango/#find-documents","text":"Find allows to find documents using a mango selector. You can read more about mango selectors here","title":"Find documents"},{"location":"/cozy-stack/mango/#request_1","text":"POST /data/:doctype/_find HTTP/1.1 POST /data/io.cozy.events/_find HTTP/1.1 Content-Type: application/json { selector : { calendar : perso , date : { $gt : 20161001T00:00:00 } }, limit : 2, skip : 3, sort : [ calendar , date ], fields : [ _id , _type , _date ], use_index : _design/a5f4711fc9448864a13c81dc71e660b524d7410c }","title":"Request"},{"location":"/cozy-stack/mango/#response-ok_1","text":"HTTP/1.1 200 OK Date: Mon, 27 Sept 2016 12:28:53 GMT Content-Length: ... Content-Type: application/json { docs : [ { _id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , _type : io.cozy.events , date : 20161023T160000Z }, { _id : 6494e0ac-dfcb-472e84a9cbee , _type : io.cozy.events , date : 20161013T160000Z } ] }","title":"Response OK"},{"location":"/cozy-stack/mango/#details_1","text":"If an index does not exist for the selector, an error 400 is returned The sort field must contains all fields used in selector The sort field must match an existing index It is possible to sort in reverse direction sort:[{\"calendar\":\"desc\"}, {\"date\": \"desc\"}] but all fields must be sorted in same direction. use_index is optional but recommended.","title":"Details"},{"location":"/cozy-stack/mango/#pagination-cookbook","text":"Pagination of mango query should be handled by the client. The stack will always limit query results to maximum 100 docs. The limit applied to a query is visible in the HTTP response. If the limit cause some docs to not be returned, the response will have a next=true top level values. { limit : 100, next : true, docs : [ ... first hundred docs ... ] } If the number of docs is lower or equal to the limit, next will be false { limit : 100, next : false, docs : [ ... less than a hundred docs ... ] } To paginate, the client should keep track of the value of the last index field.","title":"Pagination cookbook"},{"location":"/cozy-stack/mango/#exemple","text":"Index on io.cozy.events with fields [\"calendar\", \"date\"] Try to get all events for a month : selector: { calendar : my-calendar , date : { $gt : 20161001 , $lt : 20161030 } } If there is less than 100 events, the response next field will be false and there is nothing more to do. If there is more than 100 events for this month, we have a next=true in the response. To keep iterating, we can take the date from the last item we received in the results and use it as next request $gte selector: { calendar : my-calendar , date : { $gte : 20161023 , $lt : 20161030 } }","title":"Exemple :"},{"location":"/cozy-stack/replication/","text":"Table of contents Replication Replication is the ability of a cozy-stack to copy / move all or a subset of its data to another support. It should cover 2 use cases Devices: The continuous act of syncing change to a subset of the cozy documents and files to and from an user cozy to the same user s Devices through cozy-desktop and cozy-mobile Sharing: The continuous act of syncing change to a subset of the cozy documents and files to and from another user s cozy. Replication will not be used for Moving, nor Backup. See associated docs in this folder. CouchDB replication is a well-understood, safe and stable algorithm ensuring replication between two couchdb databases. It is delta-based, and is stateful: we sync changes since a given checkpoint. Files synchronization Replication of too heavy database (with a lot of attachments) has been, in cozy experience, the source of some bugs. To avoid that (and some other issues), in cozy-stack, the attachments are stored outside of couchdb. This means we need a way to synchronize files in parallel to couchdb replication. Rsync is a well-understood, safe and stable algorithm to replicate files hierarchy from one hosts to the other by only transfering changes. It is one-shot and stateless. It could be an inspiration if we have to focus on syncing small changes to big files. The option to use rsync/zsync have been discussed internally (https://github.com/cozy/cozy-stack/pull/57 Sprint Start 2016-10-24), but for now we should focus on using the files/folders couchdb document for synchronization purpose and upload/download the actual binaries with existing files routes or considering webdav. Useful golang package: http://rclone.org/ sync folder in FS / Swift (may be we can add a driver for cozy) Couchdb replication limitation Couchdb 2 replication protocol is described in details here . Quick summary The replicator figures out what was the last sequence number lastseqno which was correctly synced from the source database, using a _local/:replicationid document. The replicator GET :source/changes?since=lastseqno limit=batchsize and identify which docs have changed (and their open_revs ). The replicator POST :target/_revs_diff to get a list of all revisions of the changed documents the target does not know. The replicator GET :source/:docid?open_revs=['rev1', ...] several times to retrieve the missing documents revisions. The replicator POST :target/_bulk_docs with these documents revisions. Store the new last sequence number Repeat 2-5 until there is no more changes. Details In step 5, the replicator can also attempt to PUT :target/:docid if doc are too heavy, but this should not happens in cozy-stack considering there wont be attachment in couchdb. In step 4, the replicator can optimize by calling GET The main difference from couchdb 1.X is in the replication history and the manner to determine and store the last sequence number. TODO: actually understand this and how it might increase disk usage if we have a lot of replications. Couchdb _changes and by extension replication can be either by polling or continuous (SSE / COMET) In couchdb benchmarking, we understood that the number of couch databases only use a bit of disk space but no RAM or CPU as long as the database is not used . Having a continuous replication active force us to keep the database file open and will starve RAM FD usage. Moreover, continuous replication costs a lot (cf. ScienceTeam benchmark). To permit an unlimited number of inactive user on a single cozy-stack process, the stack should avoid continuous replication from couchdb . Two way replication is simply two one way replications Routes used by replication To be a source of replication, the stack only need to support the following route (and query parameters): GET :source/:docid get revisions of a document. The query parameters open_revs, revs, latest is necessary for replication. POST :source/_all_docs is used by current version of cozy-mobile and pouchdb as an optimization to fetch several document s revision at once. GET :source/_changes get a list of ID - New Revision since a given sequence number. The query parameters since, limit are necessary for replication. To be a target of replication, the stack need to support the following routes: POST :target/_revs_diff takes a list of ID - Rev and returns which one are missing. POST :target/_bulk_docs create several documents at once POST :target/_ensure_full_commit ensure the documents are written to disk. This is useless if couchdb is configured without delayed write (default), but remote couchdb will call, so the stack should return the expected 201 In both case, we need to support PUT :both/_local/:revdocid to store the current sequence number. Stack Sync API exploration Easy part: 1 db/doctype on stack AND remote, no binaries We just need to implement the routes described above by proxying to the underlying couchdb database. var db = new PouchDB( my-local-contacts ); db.replicate.from( https://bob.cozycloud.cc/data/contacts ); db.replicate.to( https://bob.cozycloud.cc/data/contacts ); To suport this we need to: Proxy /data/:doctype/_changes route with since, limit, feed=normal. Refuse all filter parameters with a clear error message. (Doc) Add support of open_revs , revs , latest query parameter to GET /data/:doctype/:docid (Doc) Proxy the /data/:doctype/_revs_diff (Doc) and /data/:doctype/_bulk_docs routes (Doc) routes Have /data/:doctype/_ensure_full_commit (Doc) returns 201 This will cover documents part of the Devices use case. Continuous replication It is impossible to implement it by simply proxying to couchdb (see unlimited inactive users). The current version of cozy-desktop uses it. TODISCUSS It could be replaced by 3-minutes polling without big losses in functionality, eventually with some more triggers based on user activity. The big use case for which we might want it is Sharing. But, because Sharing will (first) be stack to stack, we might imagine having the source of event ping the remote through a separate route. Conclusion: Start with polling replication. Consider alternative notifications mechanism when the usecase appears and eventually use time-limited continuous replication for a few special case (collaborative edit). Realtime One of the cool feature of cozy apps was how changes are sent to the client in realtime through websocket. However this have a cost: every cozy and every apps open in a browser, even while not used keep one socket open on the server, this is not scalable to thousands of users. Several technology can be used for realtime: Websocket, SSE or COMET like long-polling. Goroutines makes all solution similar performances wise. COMET is a hack, websocket seems more popular and tested (x/net/websocket vs html5-sse-example). SSE is not widely available and has some limitations (headers ) Depending on benchmarking, we can do some optimization on the feed: close feeds when the user is not on screen multiplex different applications feed, so each open cozy will only use one socket to the server. This is hard, as all apps live on separate domain, an (hackish) option might be a iframe/SharedWorker bridge. To have some form of couchdb-to-stack continuous changes monitoring, we can monitor _db_udpates (Doc) which gives us an update when a couchdb has changed. We can then perform a _changes query on this database to get the changed docs and proxy that to the stack-to-client change feed. Conclusion: We will use Websocket from the client to the stack. We will try to avoid using continuous changes feed from couchdb to the stack. We will optimize if proven needed by benchmarks, starting with useless changes and eventually some multiplexing. Sharing To be completed by discussing with Science team. Current ideas (as understood by Romain) any filtered replication is unscalable 1 db for all shared docs sharing_db . Cozy-stack is responsible for saving documents that should be shared in both their dg implemented by 2-way replication between the 2 users sharing_db , filtering is done by computing a list of IDs and then doc_ids (sharing with filters/views are not efficient) Sharing is performed by batches regularly. Continuous replication can be considered for collaborative editing. Proposal by Romain, if we find _selector filter replication performances to be acceptable on very large / very old databases. No sharing database A permission, for anything is a mango-style selector. on every query, the Mango selector is checked at the stack or couchdb level ( $and -ing for queries, testing output document, input document) Sharing is a filtered replication between user s 1 doctypedb et user s 2 samedoctypedb No continuous replication Upon update, the stack trigger a PUSH replication to its remote or ping the remote, and the remote perform a normal PULL replication. TODO experiment with performance of _selector filtered replication in couchdb2","title":"Replication"},{"location":"/cozy-stack/replication/#replication","text":"Replication is the ability of a cozy-stack to copy / move all or a subset of its data to another support. It should cover 2 use cases Devices: The continuous act of syncing change to a subset of the cozy documents and files to and from an user cozy to the same user s Devices through cozy-desktop and cozy-mobile Sharing: The continuous act of syncing change to a subset of the cozy documents and files to and from another user s cozy. Replication will not be used for Moving, nor Backup. See associated docs in this folder. CouchDB replication is a well-understood, safe and stable algorithm ensuring replication between two couchdb databases. It is delta-based, and is stateful: we sync changes since a given checkpoint.","title":"Replication"},{"location":"/cozy-stack/replication/#files-synchronization","text":"Replication of too heavy database (with a lot of attachments) has been, in cozy experience, the source of some bugs. To avoid that (and some other issues), in cozy-stack, the attachments are stored outside of couchdb. This means we need a way to synchronize files in parallel to couchdb replication. Rsync is a well-understood, safe and stable algorithm to replicate files hierarchy from one hosts to the other by only transfering changes. It is one-shot and stateless. It could be an inspiration if we have to focus on syncing small changes to big files. The option to use rsync/zsync have been discussed internally (https://github.com/cozy/cozy-stack/pull/57 Sprint Start 2016-10-24), but for now we should focus on using the files/folders couchdb document for synchronization purpose and upload/download the actual binaries with existing files routes or considering webdav. Useful golang package: http://rclone.org/ sync folder in FS / Swift (may be we can add a driver for cozy)","title":"Files synchronization"},{"location":"/cozy-stack/replication/#couchdb-replication-limitation","text":"Couchdb 2 replication protocol is described in details here .","title":"Couchdb replication &amp; limitation"},{"location":"/cozy-stack/replication/#quick-summary","text":"The replicator figures out what was the last sequence number lastseqno which was correctly synced from the source database, using a _local/:replicationid document. The replicator GET :source/changes?since=lastseqno limit=batchsize and identify which docs have changed (and their open_revs ). The replicator POST :target/_revs_diff to get a list of all revisions of the changed documents the target does not know. The replicator GET :source/:docid?open_revs=['rev1', ...] several times to retrieve the missing documents revisions. The replicator POST :target/_bulk_docs with these documents revisions. Store the new last sequence number Repeat 2-5 until there is no more changes.","title":"Quick summary"},{"location":"/cozy-stack/replication/#details","text":"In step 5, the replicator can also attempt to PUT :target/:docid if doc are too heavy, but this should not happens in cozy-stack considering there wont be attachment in couchdb. In step 4, the replicator can optimize by calling GET The main difference from couchdb 1.X is in the replication history and the manner to determine and store the last sequence number. TODO: actually understand this and how it might increase disk usage if we have a lot of replications. Couchdb _changes and by extension replication can be either by polling or continuous (SSE / COMET) In couchdb benchmarking, we understood that the number of couch databases only use a bit of disk space but no RAM or CPU as long as the database is not used . Having a continuous replication active force us to keep the database file open and will starve RAM FD usage. Moreover, continuous replication costs a lot (cf. ScienceTeam benchmark). To permit an unlimited number of inactive user on a single cozy-stack process, the stack should avoid continuous replication from couchdb . Two way replication is simply two one way replications","title":"Details"},{"location":"/cozy-stack/replication/#routes-used-by-replication","text":"To be a source of replication, the stack only need to support the following route (and query parameters): GET :source/:docid get revisions of a document. The query parameters open_revs, revs, latest is necessary for replication. POST :source/_all_docs is used by current version of cozy-mobile and pouchdb as an optimization to fetch several document s revision at once. GET :source/_changes get a list of ID - New Revision since a given sequence number. The query parameters since, limit are necessary for replication. To be a target of replication, the stack need to support the following routes: POST :target/_revs_diff takes a list of ID - Rev and returns which one are missing. POST :target/_bulk_docs create several documents at once POST :target/_ensure_full_commit ensure the documents are written to disk. This is useless if couchdb is configured without delayed write (default), but remote couchdb will call, so the stack should return the expected 201 In both case, we need to support PUT :both/_local/:revdocid to store the current sequence number.","title":"Routes used by replication"},{"location":"/cozy-stack/replication/#stack-sync-api-exploration","text":"","title":"Stack Sync API exploration"},{"location":"/cozy-stack/replication/#easy-part-1-dbdoctype-on-stack-and-remote-no-binaries","text":"We just need to implement the routes described above by proxying to the underlying couchdb database. var db = new PouchDB( my-local-contacts ); db.replicate.from( https://bob.cozycloud.cc/data/contacts ); db.replicate.to( https://bob.cozycloud.cc/data/contacts ); To suport this we need to: Proxy /data/:doctype/_changes route with since, limit, feed=normal. Refuse all filter parameters with a clear error message. (Doc) Add support of open_revs , revs , latest query parameter to GET /data/:doctype/:docid (Doc) Proxy the /data/:doctype/_revs_diff (Doc) and /data/:doctype/_bulk_docs routes (Doc) routes Have /data/:doctype/_ensure_full_commit (Doc) returns 201 This will cover documents part of the Devices use case.","title":"Easy part: 1 db/doctype on stack AND remote, no binaries"},{"location":"/cozy-stack/replication/#continuous-replication","text":"It is impossible to implement it by simply proxying to couchdb (see unlimited inactive users). The current version of cozy-desktop uses it. TODISCUSS It could be replaced by 3-minutes polling without big losses in functionality, eventually with some more triggers based on user activity. The big use case for which we might want it is Sharing. But, because Sharing will (first) be stack to stack, we might imagine having the source of event ping the remote through a separate route. Conclusion: Start with polling replication. Consider alternative notifications mechanism when the usecase appears and eventually use time-limited continuous replication for a few special case (collaborative edit).","title":"Continuous replication"},{"location":"/cozy-stack/replication/#realtime","text":"One of the cool feature of cozy apps was how changes are sent to the client in realtime through websocket. However this have a cost: every cozy and every apps open in a browser, even while not used keep one socket open on the server, this is not scalable to thousands of users. Several technology can be used for realtime: Websocket, SSE or COMET like long-polling. Goroutines makes all solution similar performances wise. COMET is a hack, websocket seems more popular and tested (x/net/websocket vs html5-sse-example). SSE is not widely available and has some limitations (headers ) Depending on benchmarking, we can do some optimization on the feed: close feeds when the user is not on screen multiplex different applications feed, so each open cozy will only use one socket to the server. This is hard, as all apps live on separate domain, an (hackish) option might be a iframe/SharedWorker bridge. To have some form of couchdb-to-stack continuous changes monitoring, we can monitor _db_udpates (Doc) which gives us an update when a couchdb has changed. We can then perform a _changes query on this database to get the changed docs and proxy that to the stack-to-client change feed. Conclusion: We will use Websocket from the client to the stack. We will try to avoid using continuous changes feed from couchdb to the stack. We will optimize if proven needed by benchmarks, starting with useless changes and eventually some multiplexing.","title":"Realtime"},{"location":"/cozy-stack/replication/#sharing","text":"To be completed by discussing with Science team. Current ideas (as understood by Romain) any filtered replication is unscalable 1 db for all shared docs sharing_db . Cozy-stack is responsible for saving documents that should be shared in both their dg implemented by 2-way replication between the 2 users sharing_db , filtering is done by computing a list of IDs and then doc_ids (sharing with filters/views are not efficient) Sharing is performed by batches regularly. Continuous replication can be considered for collaborative editing. Proposal by Romain, if we find _selector filter replication performances to be acceptable on very large / very old databases. No sharing database A permission, for anything is a mango-style selector. on every query, the Mango selector is checked at the stack or couchdb level ( $and -ing for queries, testing output document, input document) Sharing is a filtered replication between user s 1 doctypedb et user s 2 samedoctypedb No continuous replication Upon update, the stack trigger a PUSH replication to its remote or ping the remote, and the remote perform a normal PULL replication. TODO experiment with performance of _selector filtered replication in couchdb2","title":"Sharing"},{"location":"/cozy-stack/couchdb-quirks/","text":"CouchDB Quirks Mango indexes Exists operator The $exists operator can be used with a mango index for the true value, but not for the false value. For false , a more heavy solution is required: a partial index . Index selection CouchDB may accept or refuse to use a mango index for a query, with obsure reasons. In general, you can follow these two rules of thumb: An index on the fields foo, bar, baz can be used only to fetch documents where foo , bar , and baz exist. It means that a query that filters only on the value on foo won t use the mango index, because it can miss a document where foo has the expected value but without bar or baz . If you know that all the documents that you want have the bar and baz fields, you can just add two filters $exists: true (one for bar , the other for baz ). You should use exactly the same sequence of fields for creating the index and the sort operator of the query. If you have an index on os, browser, ip for the io.cozy.sessions.logins , and you want to have all the documents for a login from windows , sorted by browser , you can use the index, but you should use os, browser, ip for the sort (or at least os, browser , even if it is seems to weird to sort on os when all the sorted documents will have the same value, windows ). Please note that using use_index on a request, the results will be sorted by default according to this rule. So, you can omit the sort operator on the query (except if you want the descending order). Old revisions CouchDB keeps for each document a list of its revision (or more exactly a tree with replication and conflicts). It s possible to ask the list of the old revisions of a document with GET /db/{docid}?revs_info=true . It works only if the document has not been deleted. For a deleted document, a trick is to query the changes feed to know the last revision of the document, and to recreate the document from this revision. With an old revision, it s possible to get the content of the document at this revision with GET /db/{docid}?rev={rev} if the database was not compacted. On CouchDB 2.x, compacts happen automatically on all databases from times to times. A purge operation consists to remove the tombstone for the deleted documents. It is a manual operation, triggered by a POST /db/_purge . Conflicts It is possible to create a conflict on CouchDB like it does for the replication by using new_edits , but it is not well documented to say the least. The more accurate description is on the old wiki: https://wiki.apache.org/couchdb/HTTP_Bulk_Document_API#Posting_Existing_Revisions. In short, it s a PUT /doc/{id}?new_edits=false with _rev the new revision of the document, and _revisions the parents of this revision in the revisions tree of this document.","title":"CouchDB Quirks"},{"location":"/cozy-stack/couchdb-quirks/#couchdb-quirks","text":"","title":"CouchDB Quirks"},{"location":"/cozy-stack/couchdb-quirks/#mango-indexes","text":"","title":"Mango indexes"},{"location":"/cozy-stack/couchdb-quirks/#exists-operator","text":"The $exists operator can be used with a mango index for the true value, but not for the false value. For false , a more heavy solution is required: a partial index .","title":"Exists operator"},{"location":"/cozy-stack/couchdb-quirks/#index-selection","text":"CouchDB may accept or refuse to use a mango index for a query, with obsure reasons. In general, you can follow these two rules of thumb: An index on the fields foo, bar, baz can be used only to fetch documents where foo , bar , and baz exist. It means that a query that filters only on the value on foo won t use the mango index, because it can miss a document where foo has the expected value but without bar or baz . If you know that all the documents that you want have the bar and baz fields, you can just add two filters $exists: true (one for bar , the other for baz ). You should use exactly the same sequence of fields for creating the index and the sort operator of the query. If you have an index on os, browser, ip for the io.cozy.sessions.logins , and you want to have all the documents for a login from windows , sorted by browser , you can use the index, but you should use os, browser, ip for the sort (or at least os, browser , even if it is seems to weird to sort on os when all the sorted documents will have the same value, windows ). Please note that using use_index on a request, the results will be sorted by default according to this rule. So, you can omit the sort operator on the query (except if you want the descending order).","title":"Index selection"},{"location":"/cozy-stack/couchdb-quirks/#old-revisions","text":"CouchDB keeps for each document a list of its revision (or more exactly a tree with replication and conflicts). It s possible to ask the list of the old revisions of a document with GET /db/{docid}?revs_info=true . It works only if the document has not been deleted. For a deleted document, a trick is to query the changes feed to know the last revision of the document, and to recreate the document from this revision. With an old revision, it s possible to get the content of the document at this revision with GET /db/{docid}?rev={rev} if the database was not compacted. On CouchDB 2.x, compacts happen automatically on all databases from times to times. A purge operation consists to remove the tombstone for the deleted documents. It is a manual operation, triggered by a POST /db/_purge .","title":"Old revisions"},{"location":"/cozy-stack/couchdb-quirks/#conflicts","text":"It is possible to create a conflict on CouchDB like it does for the replication by using new_edits , but it is not well documented to say the least. The more accurate description is on the old wiki: https://wiki.apache.org/couchdb/HTTP_Bulk_Document_API#Posting_Existing_Revisions. In short, it s a PUT /doc/{id}?new_edits=false with _rev the new revision of the document, and _revisions the parents of this revision in the revisions tree of this document.","title":"Conflicts"},{"location":"/cozy-stack/files/","text":"Table of contents Virtual File System Cozy applications can use files for storing binary content, like photos or bills in PDF. This service offers a REST API to manipulate easily without having to know the underlying storage layer. The metadata are kept in CouchDB, but the binaries can go to the local system, or a Swift instance. Directories A directory is a container for files and sub-directories. Its path is the path of its parent, a slash ( / ), and its name. It s case sensitive. Root directory The root of the virtual file system is a special directory with id io.cozy.files.root-dir . You can use it in any request where you would use a directory, except you cannot delete it. POST /files/:dir-id Create a new directory. The dir-id parameter is optional. When it s not given, the directory is created at the root of the virtual file system. Query-String Parameter Description Type directory Name the directory name Tags an array of tags HTTP headers Parameter Description Date The modification date of the directory Request POST /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81?Type=directory Name=phone Tags=bills,konnectors HTTP/1.1 Accept: application/vnd.api+json Date: Mon, 19 Sep 2016 12:35:08 GMT Status codes 201 Created, when the directory has been successfully created 404 Not Found, when the parent directory does not exist 409 Conflict, when a directory with the same name already exists 422 Unprocessable Entity, when the Type or Name parameter is missing or invalid Response HTTP/1.1 201 Created Content-Type: application/vnd.api+json Location: http://cozy.example.com/files/6494e0ac-dfcb-11e5-88c1-472e84a9cbee { data : { type : io.cozy.files , id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , meta : { rev : 1-ff3beeb456eb }, attributes : { type : directory , name : phone , path : /Documents/phone , created_at : 2016-09-19T12:35:08Z , updated_at : 2016-09-19T12:35:08Z , tags : [ bills ] }, relationships : { parent : { links : { related : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 }, data : { type : io.cozy.files , id : fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 } } }, links : { self : /files/6494e0ac-dfcb-11e5-88c1-472e84a9cbee } } } GET /files/:file-id Get a directory or a file informations. In the case of a directory, it contains the list of files and sub-directories inside it. Contents is paginated following jsonapi conventions . The default limit is 30 entries. Request GET /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 HTTP/1.1 Accept: application/vnd.api+json Response HTTP/1.1 200 OK Content-Type: application/vnd.api+json { links : { next : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81?page[cursor]=9152d568-7e7c-11e6-a377-37cbfb190b4b }, data : { type : io.cozy.files , id : fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 , meta : { rev : 1-e36ab092 }, attributes : { type : directory , name : Documents , path : /Documents , created_at : 2016-09-19T12:35:00Z , updated_at : 2016-09-19T12:35:00Z , tags : [] }, relationships : { contents : { data : [ { type : io.cozy.files , id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee }, { type : io.cozy.files , id : 9152d568-7e7c-11e6-a377-37cbfb190b4b } ] } }, links : { self : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 } }, included : [ { type : io.cozy.files , id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , meta : { rev : 1-ff3beeb456eb }, attributes : { type : directory , name : phone , path : /Documents/phone , created_at : 2016-09-19T12:35:08Z , updated_at : 2016-09-19T12:35:08Z , tags : [ bills ] }, relationships : { parent : { links : { related : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 }, data : { type : io.cozy.files , id : fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 } } }, links : { self : /files/6494e0ac-dfcb-11e5-88c1-472e84a9cbee } }, { type : io.cozy.files , id : 9152d568-7e7c-11e6-a377-37cbfb190b4b , meta : { rev : 1-0e6d5b72 }, attributes : { type : file , name : hello.txt , trashed : false, md5sum : ODZmYjI2OWQxOTBkMmM4NQo= , created_at : 2016-09-19T12:38:04Z , updated_at : 2016-09-19T12:38:04Z , tags : [], size : 12, executable : false, class : document , mime : text/plain }, relationships : { parent : { links : { related : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 }, data : { type : io.cozy.files , id : fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 } } }, links : { self : /files/9152d568-7e7c-11e6-a377-37cbfb190b4b } } ] } DELETE /files/:dir-id Put a directory and its subtree in the trash. HTTP headers It s possible to send the If-Match header, with the previous revision of the file/directory (optional). Files A file is a binary content with some metadata. POST /files/:dir-id Upload a file Query-String Parameter Description Type file Name the file name Tags an array of tags Executable true if the file is executable (UNIX permission) HTTP headers Parameter Description Content-Length The file size Content-MD5 A Base64-encoded binary MD5 sum of the file Content-Type The mime-type of the file Date The modification date of the file Request POST /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81?Type=file Name=hello.txt HTTP/1.1 Accept: application/vnd.api+json Content-Length: 12 Content-MD5: hvsmnRkNLIX24EaM7KQqIA== Content-Type: text/plain Date: Mon, 19 Sep 2016 12:38:04 GMT Hello world! Status codes 201 Created, when the file has been successfully created 404 Not Found, when the parent directory does not exist 409 Conflict, when a file with the same name already exists 412 Precondition Failed, when the md5sum is Content-MD5 is not equal to the md5sum computed by the server 422 Unprocessable Entity, when the sent data is invalid (for example, the parent doesn t exist, Type or Name parameter is missing or invalid, etc.) Response HTTP/1.1 201 Created Content-Type: application/vnd.api+json Location: http://cozy.example.com/files/9152d568-7e7c-11e6-a377-37cbfb190b4b { data : { type : io.cozy.files , id : 9152d568-7e7c-11e6-a377-37cbfb190b4b , meta : { rev : 1-0e6d5b72 }, attributes : { type : file , name : sunset.jpg , trashed : false, md5sum : ODZmYjI2OWQxOTBkMmM4NQo= , created_at : 2016-09-19T12:38:04Z , updated_at : 2016-09-19T12:38:04Z , tags : [], metadata : { datetime : 2016-09-18T20:38:04Z , height : 1080, width : 1920 }, size : 12, executable : false, class : image , mime : image/jpg }, relationships : { parent : { links : { related : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 }, data : { type : io.cozy.files , id : fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 } }, referenced_by : { links : { self : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81/relationships/references }, data : [ { type : io.cozy.albums , id : 94375086-e2e2-11e6-81b9-5bc0b9dd4aa4 } ] } }, links : { self : /files/9152d568-7e7c-11e6-a377-37cbfb190b4b , small : /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/thumbnails/0f9cda56674282ac/small , medium : /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/thumbnails/0f9cda56674282ac/medium , large : /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/thumbnails/0f9cda56674282ac/large } } } Note : see references of documents in VFS for more informations about the references field. GET /files/download/:file-id Download the file content. By default the content-disposition will be inline , but it will be attachment if the query string contains the parameter Dl=1 Request GET /files/download/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 HTTP/1.1 Response HTTP/1.1 200 OK Content-Length: 12 Content-Disposition: inline; filename= hello.txt Content-Type: text/plain Hello world! GET /files/download Download the file content from its path. By default the content-disposition will be inline , but it will be attachment if the query string contains the parameter Dl=1 Request GET /files/download?Path=/Documents/hello.txt Dl=1 HTTP/1.1 GET /files/:file-id/thumbnails/:secret/:format Get a thumbnail of a file (for an image only). :format can be small (640x480), medium (1280x720), or large (1920x1080). PUT /files/:file-id Overwrite a file HTTP headers The HTTP headers are the same than for uploading a file. There is one additional header, If-Match , with the previous revision of the file (optional). Request PUT /files/9152d568-7e7c-11e6-a377-37cbfb190b4b HTTP/1.1 Accept: application/vnd.api+json Content-Length: 12 Content-MD5: hvsmnRkNLIX24EaM7KQqIA== Content-Type: text/plain Date: Mon, 20 Sep 2016 16:43:12 GMT If-Match: 1-0e6d5b72 HELLO WORLD! Status codes 200 OK, when the file has been successfully overwritten 404 Not Found, when the file wasn t existing 412 Precondition Failed, when the If-Match header is set and doesn t match the last revision of the file Response HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { type : io.cozy.files , id : 9152d568-7e7c-11e6-a377-37cbfb190b4b , meta : { rev : 2-d903b54c }, attributes : { type : file , name : hello.txt , trashed : false, md5sum : YjU5YmMzN2Q2NDQxZDk2Nwo= , created_at : 2016-09-19T12:38:04Z , updated_at : 2016-09-19T12:38:04Z , tags : [], size : 12, executable : false, class : document , mime : text/plain }, relationships : { parent : { links : { related : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 }, data : { type : io.cozy.files , id : fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 } } }, links : { self : /files/9152d568-7e7c-11e6-a377-37cbfb190b4b } } } DELETE /files/:file-id Put a file in the trash. Common GET /files/metadata Same as /files/:file-id but to retrieve informations from a path. Request GET /files/metadata?Path=/Documents/hello.txt HTTP/1.1 Response HTTP/1.1 200 OK Content-Type: application/vnd.api+json Location: http://cozy.example.com/files/9152d568-7e7c-11e6-a377-37cbfb190b4b { data : { type : io.cozy.files , id : 9152d568-7e7c-11e6-a377-37cbfb190b4b , meta : { rev : 1-0e6d5b72 }, attributes : { type : file , name : hello.txt , trashed : false, md5sum : ODZmYjI2OWQxOTBkMmM4NQo= , created_at : 2016-09-19T12:38:04Z , updated_at : 2016-09-19T12:38:04Z , tags : [], size : 12, executable : false, class : document , mime : text/plain }, relationships : { parent : { links : { related : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 }, data : { type : io.cozy.files , id : fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 } } }, links : { self : /files/9152d568-7e7c-11e6-a377-37cbfb190b4b } } } PATCH /files/:file-id and PATCH /files/metadata Both endpoints can be used to update the metadata of a file or directory, or to rename/move it. The difference is the first one uses an id to identify the file/directory to update, and the second one uses the path. The dir_id attribute can be updated to move a file or directory. HTTP headers It s possible to send the If-Match header, with the previous revision of the file/directory (optional). Request PATCH /files/9152d568-7e7c-11e6-a377-37cbfb190b4b HTTP/1.1 Accept: application/vnd.api+json Content-Type: application/vnd.api+json { data : { type : io.cozy.files , id : 9152d568-7e7c-11e6-a377-37cbfb190b4b , attributes : { type : file , name : hi.txt , dir_id : f2f36fec-8018-11e6-abd8-8b3814d9a465 , trashed : false, tags : [ poem ] } } } Status codes 200 OK, when the file or directory metadata has been successfully updated 400 Bad Request, when a the directory is asked to move to one of its sub-directories 404 Not Found, when the file/directory wasn t existing 412 Precondition Failed, when the If-Match header is set and doesn t match the last revision of the file/directory 422 Unprocessable Entity, when the sent data is invalid (for example, the parent doesn t exist) Response HTTP/1.1 200 OK Content-Type: application/vnd.api+json Location: http://cozy.example.com/files/9152d568-7e7c-11e6-a377-37cbfb190b4b { data : { type : io.cozy.files , id : 9152d568-7e7c-11e6-a377-37cbfb190b4b , meta : { rev : 1-0e6d5b72 }, attributes : { type : file , name : hi.txt , trashed : false, md5sum : ODZmYjI2OWQxOTBkMmM4NQo= , created_at : 2016-09-19T12:38:04Z , updated_at : 2016-09-19T12:38:04Z , tags : [ poem ], size : 12, executable : false, class : document , mime : text/plain }, relationships : { parent : { links : { related : /files/f2f36fec-8018-11e6-abd8-8b3814d9a465 }, data : { type : io.cozy.files , id : f2f36fec-8018-11e6-abd8-8b3814d9a465 } } }, links : { self : /files/9152d568-7e7c-11e6-a377-37cbfb190b4b } } } POST /files/archive Create an archive. The body of the request lists the files and directories that will be included in the archive. For directories, it includes all the files and sub-directories in the archive. It s possible to give a file by its id (in the ids array) or by its path (in the files array). Request POST /files/archive HTTP/1.1 Accept: application/zip Content-Type: application/vnd.api+json { data : { type : io.cozy.files.archives , attributes : { name : project-X , ids : [ a51aeeea-4f79-11e7-9dc4-83f67e9494ab ], files : [ /Documents/bills , /Documents/images/sunset.jpg , /Documents/images/eiffel-tower.jpg ] } } } Response HTTP/1.1 200 OK Content-Type: application/vnd.api+json { links : { related : /files/archive/4521DC87/project-X.zip }, data : { type : io.cozy.files.archives , id : 4521DC87 , attributes : { href : /files/archive/4521DC87/project-X.zip } } } GET /files/archive/:key/:name Download a previously created archive. The name parameter is not used in the stack but aims to allow setting a name even for browser / downloader that do not support Content-Disposition filename. This route does not require Basic Authentification GET /files/archive/4521DC87/project-X.zip HTTP/1.1 Accept: application/zip Content-Length: 12345 Content-Disposition: attachment; filename= project-X.zip Content-Type: application/zip POST /files/downloads?Path=file_path Create a file download. The Path query parameter specifies the file to download. The response json API links contains a related link for downloading the file, see below. POST /files/downloads?Id=file_id Also create a file download. But it takes the id of the file and not its path. GET /files/downloads/:secret/:name Allows to download a file with a secret created from the route above. The name parameter is not used in the stack but aims to allow setting a name even for browser / downloader that do not support Content-Disposition filename. By default the content-disposition will be inline , but it will be attachment if the query string contains the parameter Dl=1 This route does not require Basic Authentification Trash When a file is deleted, it is first moved to the trash. In the trash, it can be restored. Or, after some time, it will be removed from the trash and permanently destroyed. The file trashed attribute will be set to true. GET /files/trash List the files inside the trash. It s paginated. Query-String Parameter Description page[cursor] the last id of the results page[limit] the number of entries (30 by default) Request GET /files/trash HTTP/1.1 Accept: application/vnd.api+json Response HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : [ { type : io.cozy.files , id : df24aac0-7f3d-11e6-81c0-d38812bfa0a8 , meta : { rev : 1-3b75377c }, attributes : { type : file , name : foo.txt , trashed : true, md5sum : YjAxMzQxZTc4MDNjODAwYwo= , created_at : 2016-09-19T12:38:04Z , updated_at : 2016-09-19T12:38:04Z , tags : [], size : 123, executable : false, class : document , mime : text/plain }, links : { self : /files/trash/df24aac0-7f3d-11e6-81c0-d38812bfa0a8 } }, { type : io.cozy.files , id : 4a4fc582-7f3e-11e6-b9ca-278406b6ddd4 , meta : { rev : 1-4a09030e }, attributes : { type : file , name : bar.txt , trashed : true, md5sum : YWVhYjg3ZWI0OWQzZjRlMAo= , created_at : 2016-09-19T12:38:04Z , updated_at : 2016-09-19T12:38:04Z , tags : [], size : 456, executable : false, class : document , mime : text/plain }, links : { self : /files/trash/4a4fc582-7f3e-11e6-b9ca-278406b6ddd4 } } ] } POST /files/trash/:file-id Restore the file with the file-id identifiant. The file s trashed attributes will be set to false. DELETE /files/trash/:file-id Destroy the file and make it unrecoverable (it will still be available in backups). DELETE /files/trash Clear out the trash. Trashed attribute All files that are inside the trash will have a trashed: true attribute. This attribute can be used in mango queries to only get interesting files.","title":"/files - Virtual File System"},{"location":"/cozy-stack/files/#virtual-file-system","text":"Cozy applications can use files for storing binary content, like photos or bills in PDF. This service offers a REST API to manipulate easily without having to know the underlying storage layer. The metadata are kept in CouchDB, but the binaries can go to the local system, or a Swift instance.","title":"Virtual File System"},{"location":"/cozy-stack/files/#directories","text":"A directory is a container for files and sub-directories. Its path is the path of its parent, a slash ( / ), and its name. It s case sensitive.","title":"Directories"},{"location":"/cozy-stack/files/#root-directory","text":"The root of the virtual file system is a special directory with id io.cozy.files.root-dir . You can use it in any request where you would use a directory, except you cannot delete it.","title":"Root directory"},{"location":"/cozy-stack/files/#post-filesdir-id","text":"Create a new directory. The dir-id parameter is optional. When it s not given, the directory is created at the root of the virtual file system.","title":"POST /files/:dir-id"},{"location":"/cozy-stack/files/#query-string","text":"Parameter Description Type directory Name the directory name Tags an array of tags","title":"Query-String"},{"location":"/cozy-stack/files/#http-headers","text":"Parameter Description Date The modification date of the directory","title":"HTTP headers"},{"location":"/cozy-stack/files/#request","text":"POST /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81?Type=directory Name=phone Tags=bills,konnectors HTTP/1.1 Accept: application/vnd.api+json Date: Mon, 19 Sep 2016 12:35:08 GMT","title":"Request"},{"location":"/cozy-stack/files/#status-codes","text":"201 Created, when the directory has been successfully created 404 Not Found, when the parent directory does not exist 409 Conflict, when a directory with the same name already exists 422 Unprocessable Entity, when the Type or Name parameter is missing or invalid","title":"Status codes"},{"location":"/cozy-stack/files/#response","text":"HTTP/1.1 201 Created Content-Type: application/vnd.api+json Location: http://cozy.example.com/files/6494e0ac-dfcb-11e5-88c1-472e84a9cbee { data : { type : io.cozy.files , id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , meta : { rev : 1-ff3beeb456eb }, attributes : { type : directory , name : phone , path : /Documents/phone , created_at : 2016-09-19T12:35:08Z , updated_at : 2016-09-19T12:35:08Z , tags : [ bills ] }, relationships : { parent : { links : { related : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 }, data : { type : io.cozy.files , id : fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 } } }, links : { self : /files/6494e0ac-dfcb-11e5-88c1-472e84a9cbee } } }","title":"Response"},{"location":"/cozy-stack/files/#get-filesfile-id","text":"Get a directory or a file informations. In the case of a directory, it contains the list of files and sub-directories inside it. Contents is paginated following jsonapi conventions . The default limit is 30 entries.","title":"GET /files/:file-id"},{"location":"/cozy-stack/files/#request_1","text":"GET /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 HTTP/1.1 Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/files/#response_1","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json { links : { next : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81?page[cursor]=9152d568-7e7c-11e6-a377-37cbfb190b4b }, data : { type : io.cozy.files , id : fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 , meta : { rev : 1-e36ab092 }, attributes : { type : directory , name : Documents , path : /Documents , created_at : 2016-09-19T12:35:00Z , updated_at : 2016-09-19T12:35:00Z , tags : [] }, relationships : { contents : { data : [ { type : io.cozy.files , id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee }, { type : io.cozy.files , id : 9152d568-7e7c-11e6-a377-37cbfb190b4b } ] } }, links : { self : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 } }, included : [ { type : io.cozy.files , id : 6494e0ac-dfcb-11e5-88c1-472e84a9cbee , meta : { rev : 1-ff3beeb456eb }, attributes : { type : directory , name : phone , path : /Documents/phone , created_at : 2016-09-19T12:35:08Z , updated_at : 2016-09-19T12:35:08Z , tags : [ bills ] }, relationships : { parent : { links : { related : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 }, data : { type : io.cozy.files , id : fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 } } }, links : { self : /files/6494e0ac-dfcb-11e5-88c1-472e84a9cbee } }, { type : io.cozy.files , id : 9152d568-7e7c-11e6-a377-37cbfb190b4b , meta : { rev : 1-0e6d5b72 }, attributes : { type : file , name : hello.txt , trashed : false, md5sum : ODZmYjI2OWQxOTBkMmM4NQo= , created_at : 2016-09-19T12:38:04Z , updated_at : 2016-09-19T12:38:04Z , tags : [], size : 12, executable : false, class : document , mime : text/plain }, relationships : { parent : { links : { related : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 }, data : { type : io.cozy.files , id : fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 } } }, links : { self : /files/9152d568-7e7c-11e6-a377-37cbfb190b4b } } ] }","title":"Response"},{"location":"/cozy-stack/files/#delete-filesdir-id","text":"Put a directory and its subtree in the trash.","title":"DELETE /files/:dir-id"},{"location":"/cozy-stack/files/#http-headers_1","text":"It s possible to send the If-Match header, with the previous revision of the file/directory (optional).","title":"HTTP headers"},{"location":"/cozy-stack/files/#files","text":"A file is a binary content with some metadata.","title":"Files"},{"location":"/cozy-stack/files/#post-filesdir-id_1","text":"Upload a file","title":"POST /files/:dir-id"},{"location":"/cozy-stack/files/#query-string_1","text":"Parameter Description Type file Name the file name Tags an array of tags Executable true if the file is executable (UNIX permission)","title":"Query-String"},{"location":"/cozy-stack/files/#http-headers_2","text":"Parameter Description Content-Length The file size Content-MD5 A Base64-encoded binary MD5 sum of the file Content-Type The mime-type of the file Date The modification date of the file","title":"HTTP headers"},{"location":"/cozy-stack/files/#request_2","text":"POST /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81?Type=file Name=hello.txt HTTP/1.1 Accept: application/vnd.api+json Content-Length: 12 Content-MD5: hvsmnRkNLIX24EaM7KQqIA== Content-Type: text/plain Date: Mon, 19 Sep 2016 12:38:04 GMT Hello world!","title":"Request"},{"location":"/cozy-stack/files/#status-codes_1","text":"201 Created, when the file has been successfully created 404 Not Found, when the parent directory does not exist 409 Conflict, when a file with the same name already exists 412 Precondition Failed, when the md5sum is Content-MD5 is not equal to the md5sum computed by the server 422 Unprocessable Entity, when the sent data is invalid (for example, the parent doesn t exist, Type or Name parameter is missing or invalid, etc.)","title":"Status codes"},{"location":"/cozy-stack/files/#response_2","text":"HTTP/1.1 201 Created Content-Type: application/vnd.api+json Location: http://cozy.example.com/files/9152d568-7e7c-11e6-a377-37cbfb190b4b { data : { type : io.cozy.files , id : 9152d568-7e7c-11e6-a377-37cbfb190b4b , meta : { rev : 1-0e6d5b72 }, attributes : { type : file , name : sunset.jpg , trashed : false, md5sum : ODZmYjI2OWQxOTBkMmM4NQo= , created_at : 2016-09-19T12:38:04Z , updated_at : 2016-09-19T12:38:04Z , tags : [], metadata : { datetime : 2016-09-18T20:38:04Z , height : 1080, width : 1920 }, size : 12, executable : false, class : image , mime : image/jpg }, relationships : { parent : { links : { related : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 }, data : { type : io.cozy.files , id : fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 } }, referenced_by : { links : { self : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81/relationships/references }, data : [ { type : io.cozy.albums , id : 94375086-e2e2-11e6-81b9-5bc0b9dd4aa4 } ] } }, links : { self : /files/9152d568-7e7c-11e6-a377-37cbfb190b4b , small : /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/thumbnails/0f9cda56674282ac/small , medium : /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/thumbnails/0f9cda56674282ac/medium , large : /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/thumbnails/0f9cda56674282ac/large } } } Note : see references of documents in VFS for more informations about the references field.","title":"Response"},{"location":"/cozy-stack/files/#get-filesdownloadfile-id","text":"Download the file content. By default the content-disposition will be inline , but it will be attachment if the query string contains the parameter Dl=1","title":"GET /files/download/:file-id"},{"location":"/cozy-stack/files/#request_3","text":"GET /files/download/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 HTTP/1.1","title":"Request"},{"location":"/cozy-stack/files/#response_3","text":"HTTP/1.1 200 OK Content-Length: 12 Content-Disposition: inline; filename= hello.txt Content-Type: text/plain Hello world!","title":"Response"},{"location":"/cozy-stack/files/#get-filesdownload","text":"Download the file content from its path. By default the content-disposition will be inline , but it will be attachment if the query string contains the parameter Dl=1","title":"GET /files/download"},{"location":"/cozy-stack/files/#request_4","text":"GET /files/download?Path=/Documents/hello.txt Dl=1 HTTP/1.1","title":"Request"},{"location":"/cozy-stack/files/#get-filesfile-idthumbnailssecretformat","text":"Get a thumbnail of a file (for an image only). :format can be small (640x480), medium (1280x720), or large (1920x1080).","title":"GET /files/:file-id/thumbnails/:secret/:format"},{"location":"/cozy-stack/files/#put-filesfile-id","text":"Overwrite a file","title":"PUT /files/:file-id"},{"location":"/cozy-stack/files/#http-headers_3","text":"The HTTP headers are the same than for uploading a file. There is one additional header, If-Match , with the previous revision of the file (optional).","title":"HTTP headers"},{"location":"/cozy-stack/files/#request_5","text":"PUT /files/9152d568-7e7c-11e6-a377-37cbfb190b4b HTTP/1.1 Accept: application/vnd.api+json Content-Length: 12 Content-MD5: hvsmnRkNLIX24EaM7KQqIA== Content-Type: text/plain Date: Mon, 20 Sep 2016 16:43:12 GMT If-Match: 1-0e6d5b72 HELLO WORLD!","title":"Request"},{"location":"/cozy-stack/files/#status-codes_2","text":"200 OK, when the file has been successfully overwritten 404 Not Found, when the file wasn t existing 412 Precondition Failed, when the If-Match header is set and doesn t match the last revision of the file","title":"Status codes"},{"location":"/cozy-stack/files/#response_4","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { type : io.cozy.files , id : 9152d568-7e7c-11e6-a377-37cbfb190b4b , meta : { rev : 2-d903b54c }, attributes : { type : file , name : hello.txt , trashed : false, md5sum : YjU5YmMzN2Q2NDQxZDk2Nwo= , created_at : 2016-09-19T12:38:04Z , updated_at : 2016-09-19T12:38:04Z , tags : [], size : 12, executable : false, class : document , mime : text/plain }, relationships : { parent : { links : { related : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 }, data : { type : io.cozy.files , id : fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 } } }, links : { self : /files/9152d568-7e7c-11e6-a377-37cbfb190b4b } } }","title":"Response"},{"location":"/cozy-stack/files/#delete-filesfile-id","text":"Put a file in the trash.","title":"DELETE /files/:file-id"},{"location":"/cozy-stack/files/#common","text":"","title":"Common"},{"location":"/cozy-stack/files/#get-filesmetadata","text":"Same as /files/:file-id but to retrieve informations from a path.","title":"GET /files/metadata"},{"location":"/cozy-stack/files/#request_6","text":"GET /files/metadata?Path=/Documents/hello.txt HTTP/1.1","title":"Request"},{"location":"/cozy-stack/files/#response_5","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json Location: http://cozy.example.com/files/9152d568-7e7c-11e6-a377-37cbfb190b4b { data : { type : io.cozy.files , id : 9152d568-7e7c-11e6-a377-37cbfb190b4b , meta : { rev : 1-0e6d5b72 }, attributes : { type : file , name : hello.txt , trashed : false, md5sum : ODZmYjI2OWQxOTBkMmM4NQo= , created_at : 2016-09-19T12:38:04Z , updated_at : 2016-09-19T12:38:04Z , tags : [], size : 12, executable : false, class : document , mime : text/plain }, relationships : { parent : { links : { related : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 }, data : { type : io.cozy.files , id : fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 } } }, links : { self : /files/9152d568-7e7c-11e6-a377-37cbfb190b4b } } }","title":"Response"},{"location":"/cozy-stack/files/#patch-filesfile-id-and-patch-filesmetadata","text":"Both endpoints can be used to update the metadata of a file or directory, or to rename/move it. The difference is the first one uses an id to identify the file/directory to update, and the second one uses the path. The dir_id attribute can be updated to move a file or directory.","title":"PATCH /files/:file-id and PATCH /files/metadata"},{"location":"/cozy-stack/files/#http-headers_4","text":"It s possible to send the If-Match header, with the previous revision of the file/directory (optional).","title":"HTTP headers"},{"location":"/cozy-stack/files/#request_7","text":"PATCH /files/9152d568-7e7c-11e6-a377-37cbfb190b4b HTTP/1.1 Accept: application/vnd.api+json Content-Type: application/vnd.api+json { data : { type : io.cozy.files , id : 9152d568-7e7c-11e6-a377-37cbfb190b4b , attributes : { type : file , name : hi.txt , dir_id : f2f36fec-8018-11e6-abd8-8b3814d9a465 , trashed : false, tags : [ poem ] } } }","title":"Request"},{"location":"/cozy-stack/files/#status-codes_3","text":"200 OK, when the file or directory metadata has been successfully updated 400 Bad Request, when a the directory is asked to move to one of its sub-directories 404 Not Found, when the file/directory wasn t existing 412 Precondition Failed, when the If-Match header is set and doesn t match the last revision of the file/directory 422 Unprocessable Entity, when the sent data is invalid (for example, the parent doesn t exist)","title":"Status codes"},{"location":"/cozy-stack/files/#response_6","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json Location: http://cozy.example.com/files/9152d568-7e7c-11e6-a377-37cbfb190b4b { data : { type : io.cozy.files , id : 9152d568-7e7c-11e6-a377-37cbfb190b4b , meta : { rev : 1-0e6d5b72 }, attributes : { type : file , name : hi.txt , trashed : false, md5sum : ODZmYjI2OWQxOTBkMmM4NQo= , created_at : 2016-09-19T12:38:04Z , updated_at : 2016-09-19T12:38:04Z , tags : [ poem ], size : 12, executable : false, class : document , mime : text/plain }, relationships : { parent : { links : { related : /files/f2f36fec-8018-11e6-abd8-8b3814d9a465 }, data : { type : io.cozy.files , id : f2f36fec-8018-11e6-abd8-8b3814d9a465 } } }, links : { self : /files/9152d568-7e7c-11e6-a377-37cbfb190b4b } } }","title":"Response"},{"location":"/cozy-stack/files/#post-filesarchive","text":"Create an archive. The body of the request lists the files and directories that will be included in the archive. For directories, it includes all the files and sub-directories in the archive. It s possible to give a file by its id (in the ids array) or by its path (in the files array).","title":"POST /files/archive"},{"location":"/cozy-stack/files/#request_8","text":"POST /files/archive HTTP/1.1 Accept: application/zip Content-Type: application/vnd.api+json { data : { type : io.cozy.files.archives , attributes : { name : project-X , ids : [ a51aeeea-4f79-11e7-9dc4-83f67e9494ab ], files : [ /Documents/bills , /Documents/images/sunset.jpg , /Documents/images/eiffel-tower.jpg ] } } }","title":"Request"},{"location":"/cozy-stack/files/#response_7","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json { links : { related : /files/archive/4521DC87/project-X.zip }, data : { type : io.cozy.files.archives , id : 4521DC87 , attributes : { href : /files/archive/4521DC87/project-X.zip } } }","title":"Response"},{"location":"/cozy-stack/files/#get-filesarchivekeyname","text":"Download a previously created archive. The name parameter is not used in the stack but aims to allow setting a name even for browser / downloader that do not support Content-Disposition filename. This route does not require Basic Authentification GET /files/archive/4521DC87/project-X.zip HTTP/1.1 Accept: application/zip Content-Length: 12345 Content-Disposition: attachment; filename= project-X.zip Content-Type: application/zip","title":"GET /files/archive/:key/:name"},{"location":"/cozy-stack/files/#post-filesdownloadspathfile_path","text":"Create a file download. The Path query parameter specifies the file to download. The response json API links contains a related link for downloading the file, see below.","title":"POST /files/downloads?Path=file_path"},{"location":"/cozy-stack/files/#post-filesdownloadsidfile_id","text":"Also create a file download. But it takes the id of the file and not its path.","title":"POST /files/downloads?Id=file_id"},{"location":"/cozy-stack/files/#get-filesdownloadssecretname","text":"Allows to download a file with a secret created from the route above. The name parameter is not used in the stack but aims to allow setting a name even for browser / downloader that do not support Content-Disposition filename. By default the content-disposition will be inline , but it will be attachment if the query string contains the parameter Dl=1 This route does not require Basic Authentification","title":"GET /files/downloads/:secret/:name"},{"location":"/cozy-stack/files/#trash","text":"When a file is deleted, it is first moved to the trash. In the trash, it can be restored. Or, after some time, it will be removed from the trash and permanently destroyed. The file trashed attribute will be set to true.","title":"Trash"},{"location":"/cozy-stack/files/#get-filestrash","text":"List the files inside the trash. It s paginated.","title":"GET /files/trash"},{"location":"/cozy-stack/files/#query-string_2","text":"Parameter Description page[cursor] the last id of the results page[limit] the number of entries (30 by default)","title":"Query-String"},{"location":"/cozy-stack/files/#request_9","text":"GET /files/trash HTTP/1.1 Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/files/#response_8","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : [ { type : io.cozy.files , id : df24aac0-7f3d-11e6-81c0-d38812bfa0a8 , meta : { rev : 1-3b75377c }, attributes : { type : file , name : foo.txt , trashed : true, md5sum : YjAxMzQxZTc4MDNjODAwYwo= , created_at : 2016-09-19T12:38:04Z , updated_at : 2016-09-19T12:38:04Z , tags : [], size : 123, executable : false, class : document , mime : text/plain }, links : { self : /files/trash/df24aac0-7f3d-11e6-81c0-d38812bfa0a8 } }, { type : io.cozy.files , id : 4a4fc582-7f3e-11e6-b9ca-278406b6ddd4 , meta : { rev : 1-4a09030e }, attributes : { type : file , name : bar.txt , trashed : true, md5sum : YWVhYjg3ZWI0OWQzZjRlMAo= , created_at : 2016-09-19T12:38:04Z , updated_at : 2016-09-19T12:38:04Z , tags : [], size : 456, executable : false, class : document , mime : text/plain }, links : { self : /files/trash/4a4fc582-7f3e-11e6-b9ca-278406b6ddd4 } } ] }","title":"Response"},{"location":"/cozy-stack/files/#post-filestrashfile-id","text":"Restore the file with the file-id identifiant. The file s trashed attributes will be set to false.","title":"POST /files/trash/:file-id"},{"location":"/cozy-stack/files/#delete-filestrashfile-id","text":"Destroy the file and make it unrecoverable (it will still be available in backups).","title":"DELETE /files/trash/:file-id"},{"location":"/cozy-stack/files/#delete-filestrash","text":"Clear out the trash.","title":"DELETE /files/trash"},{"location":"/cozy-stack/files/#trashed-attribute","text":"All files that are inside the trash will have a trashed: true attribute. This attribute can be used in mango queries to only get interesting files.","title":"Trashed attribute"},{"location":"/cozy-stack/references-docs-in-vfs/","text":"Table of contents References of documents in the Virtual File System What we want? Cozy applications can use data from the Data System and files from the Virtual File System. Of course, sometimes a link between data and files can be useful. For example, the application can have an album with photos. The album will be a document in CouchDB (with a title and other fields), but il will also list the files to use as photos. A direct way to do that is storing the files IDs in the album document. It s simple and will work pretty well if the files are manipulated only from this application. But, files are often accessed from other apps, like cozy-desktop and cozy-drive. To improve the User eXperience, it should be nice to alert the user when a file in an album is modified or deleted. When a file is modified, we can offer the user the choice between keeping the original version in the album, or using the new modified file. When a file is moved to the trash, we can alert the user and let him/her restore the file. Cozy-desktop, cozy-drive, and the other apps can t scan all the documents with many different doctypes to find all the references to a file to detect such cases. The goal of this document is to offer a way to do that, and it is called References . The references of a file are listed in its JSON-API representation in the references field, within the relationships object of data . Example { data : { type : io.cozy.files , id : 9152d568-7e7c-11e6-a377-37cbfb190b4b , meta : { rev : 1-0e6d5b72 }, attributes : { type : file , name : hello.txt , md5sum : ODZmYjI2OWQxOTBkMmM4NQo= , created_at : 2016-09-19T12:38:04Z , updated_at : 2016-09-19T12:38:04Z , tags : [], size : 12, executable : false, class : document , mime : text/plain }, relationships : { parent : { links : { related : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 }, data : { type : io.cozy.files , id : fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 } }, referenced_by : { links : { self : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81/relationships/references }, data : [ { type : io.cozy.playlists , id : 94375086-e2e2-11e6-81b9-5bc0b9dd4aa4 } ] } }, links : { self : /files/9152d568-7e7c-11e6-a377-37cbfb190b4b } } } Routes PATCH /files/:file-id/relationships/referenced_by Replace the references for a file with the new ones. Request PATCH /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/relationships/referenced_by HTTP/1.1 Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : [ { type : io.cozy.playlists , id : 94375086-e2e2-11e6-81b9-5bc0b9dd4aa4 } ] } Response HTTP/1.1 204 No Content Content-Type: application/vnd.api+json POST /files/:file-id/relationships/referenced_by Add on a file one or more references to documents Request POST /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/relationships/referenced_by HTTP/1.1 Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : [ { type : io.cozy.playlists , id : f2625cc0-e2d6-11e6-a0d5-cfbbfb141af0 } ] } Response HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : [ { type : io.cozy.playlists , id : 94375086-e2e2-11e6-81b9-5bc0b9dd4aa4 }, { type : io.cozy.playlists , id : f2625cc0-e2d6-11e6-a0d5-cfbbfb141af0 } ] } DELETE /files/:file-id/relationships/referenced_by Remove one or more references to documents on a file Request DELETE /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/relationships/referenced_by HTTP/1.1 Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : [ { type : io.cozy.playlists , id : f2625cc0-e2d6-11e6-a0d5-cfbbfb141af0 } ] } Response HTTP/1.1 204 No Content Content-Type: application/vnd.api+json GET /data/:type/:doc-id/relationships/references Returns all the files associated to an album or playlist. Contents is paginated following jsonapi conventions . The default limit is 100 entries. It s also possible to sort the files by their datetime (for photos) with the sort query parameter: ?sort=datetime . Request GET /data/io.cozy.playlists/e9308dc2-e2e3-11e6-b685-fb88662613d4/relationships/references HTTP/1.1 Content-Type: application/vnd.api+json Accept: application/vnd.api+json Response HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : [ { type : io.cozy.files , id : 417c4e58-e2e4-11e6-b7dc-2b68ed7b77f4 }, { type : io.cozy.files , id : 4504f55c-e2e4-11e6-88f2-d77aeecab549 }, { type : io.cozy.files , id : 4587727a-e2e4-11e6-bfe9-ef1be7df7f26 }, { type : io.cozy.files , id : 45d591d0-e2e4-11e6-ab9a-ff3b218e31cc } ] } POST /data/:type/:doc-id/relationships/references When creating an album or a playlist, it s tedious to add the references to it for each file individually. This route allows to make it in bulk. Request POST /data/io.cozy.playlists/e9308dc2-e2e3-11e6-b685-fb88662613d4/relationships/references HTTP/1.1 Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : [ { type : io.cozy.files , id : 417c4e58-e2e4-11e6-b7dc-2b68ed7b77f4 }, { type : io.cozy.files , id : 4504f55c-e2e4-11e6-88f2-d77aeecab549 }, { type : io.cozy.files , id : 4587727a-e2e4-11e6-bfe9-ef1be7df7f26 }, { type : io.cozy.files , id : 45d591d0-e2e4-11e6-ab9a-ff3b218e31cc } ] } Response HTTP/1.1 204 No Content Content-Type: application/vnd.api+json Note : if one of the id is a directory, the response will be a 400 Bad Request. References are only for files. DELETE /data/:type/:doc-id/relationships/references This bulk deletion of references on many files can be useful when an album or playlist is deleted. Request DELETE /data/io.cozy.playlists/e9308dc2-e2e3-11e6-b685-fb88662613d4/relationships/references HTTP/1.1 Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : [ { type : io.cozy.files , id : 417c4e58-e2e4-11e6-b7dc-2b68ed7b77f4 }, { type : io.cozy.files , id : 4504f55c-e2e4-11e6-88f2-d77aeecab549 }, { type : io.cozy.files , id : 4587727a-e2e4-11e6-bfe9-ef1be7df7f26 }, { type : io.cozy.files , id : 45d591d0-e2e4-11e6-ab9a-ff3b218e31cc } ] } Response HTTP/1.1 204 No Content Content-Type: application/vnd.api+json Usage Modification of a referenced file Before an application updates a file, it can check if the file has some references. If it is the case, it may offer to the user two choices: update the file with the new version (the albums and playlists will use the new version) save the new version as a new file and preserve the old file (the old file may be moved to a originals directory). Moving a referenced file to the trash The stack will refuse to move a referenced file to the trash. It s the same for a folder that contains a referenced file. The application has to remove the references first. It s possible to clear all the references on a file with a PATCH request like this: PATCH /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/relationships/references HTTP/1.1 Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : [] } Implementation The references are persisted in the io.cozy.files documents in CouchDB. A mango index is used to fetch all the files that are associated to a given document (for GET /data/:type/:doc-id/relationships/references ). For request to update or move to trash a file, it is easy to fetch its CouchDB document to see if it has a reference. But it is more difficult when moving a folder to trash. To do that, we need two requests to fetch the number of references in a folder. 1/ Get all descendant folders from a given folder, with a CouchDB View: map = function(doc) { if (doc.type === folder ) emit(doc.path); }; query = { starkey: parent_folder_path + / , endkey: parent_folder_path + /\\uFFFF }; 2/ Get the total number of referenced file for this folders list, with a map/reduce CouchDB view: map = function(doc) { if(doc.referenced != null) emit(doc.parentID) } reduce = count query = {keys: [list from above]}","title":"References of documents in VFS"},{"location":"/cozy-stack/references-docs-in-vfs/#references-of-documents-in-the-virtual-file-system","text":"","title":"References of documents in the Virtual File System"},{"location":"/cozy-stack/references-docs-in-vfs/#what-we-want","text":"Cozy applications can use data from the Data System and files from the Virtual File System. Of course, sometimes a link between data and files can be useful. For example, the application can have an album with photos. The album will be a document in CouchDB (with a title and other fields), but il will also list the files to use as photos. A direct way to do that is storing the files IDs in the album document. It s simple and will work pretty well if the files are manipulated only from this application. But, files are often accessed from other apps, like cozy-desktop and cozy-drive. To improve the User eXperience, it should be nice to alert the user when a file in an album is modified or deleted. When a file is modified, we can offer the user the choice between keeping the original version in the album, or using the new modified file. When a file is moved to the trash, we can alert the user and let him/her restore the file. Cozy-desktop, cozy-drive, and the other apps can t scan all the documents with many different doctypes to find all the references to a file to detect such cases. The goal of this document is to offer a way to do that, and it is called References . The references of a file are listed in its JSON-API representation in the references field, within the relationships object of data .","title":"What we want?"},{"location":"/cozy-stack/references-docs-in-vfs/#example","text":"{ data : { type : io.cozy.files , id : 9152d568-7e7c-11e6-a377-37cbfb190b4b , meta : { rev : 1-0e6d5b72 }, attributes : { type : file , name : hello.txt , md5sum : ODZmYjI2OWQxOTBkMmM4NQo= , created_at : 2016-09-19T12:38:04Z , updated_at : 2016-09-19T12:38:04Z , tags : [], size : 12, executable : false, class : document , mime : text/plain }, relationships : { parent : { links : { related : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 }, data : { type : io.cozy.files , id : fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81 } }, referenced_by : { links : { self : /files/fce1a6c0-dfc5-11e5-8d1a-1f854d4aaf81/relationships/references }, data : [ { type : io.cozy.playlists , id : 94375086-e2e2-11e6-81b9-5bc0b9dd4aa4 } ] } }, links : { self : /files/9152d568-7e7c-11e6-a377-37cbfb190b4b } } }","title":"Example"},{"location":"/cozy-stack/references-docs-in-vfs/#routes","text":"","title":"Routes"},{"location":"/cozy-stack/references-docs-in-vfs/#patch-filesfile-idrelationshipsreferenced_by","text":"Replace the references for a file with the new ones.","title":"PATCH /files/:file-id/relationships/referenced_by"},{"location":"/cozy-stack/references-docs-in-vfs/#request","text":"PATCH /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/relationships/referenced_by HTTP/1.1 Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : [ { type : io.cozy.playlists , id : 94375086-e2e2-11e6-81b9-5bc0b9dd4aa4 } ] }","title":"Request"},{"location":"/cozy-stack/references-docs-in-vfs/#response","text":"HTTP/1.1 204 No Content Content-Type: application/vnd.api+json","title":"Response"},{"location":"/cozy-stack/references-docs-in-vfs/#post-filesfile-idrelationshipsreferenced_by","text":"Add on a file one or more references to documents","title":"POST /files/:file-id/relationships/referenced_by"},{"location":"/cozy-stack/references-docs-in-vfs/#request_1","text":"POST /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/relationships/referenced_by HTTP/1.1 Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : [ { type : io.cozy.playlists , id : f2625cc0-e2d6-11e6-a0d5-cfbbfb141af0 } ] }","title":"Request"},{"location":"/cozy-stack/references-docs-in-vfs/#response_1","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : [ { type : io.cozy.playlists , id : 94375086-e2e2-11e6-81b9-5bc0b9dd4aa4 }, { type : io.cozy.playlists , id : f2625cc0-e2d6-11e6-a0d5-cfbbfb141af0 } ] }","title":"Response"},{"location":"/cozy-stack/references-docs-in-vfs/#delete-filesfile-idrelationshipsreferenced_by","text":"Remove one or more references to documents on a file","title":"DELETE /files/:file-id/relationships/referenced_by"},{"location":"/cozy-stack/references-docs-in-vfs/#request_2","text":"DELETE /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/relationships/referenced_by HTTP/1.1 Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : [ { type : io.cozy.playlists , id : f2625cc0-e2d6-11e6-a0d5-cfbbfb141af0 } ] }","title":"Request"},{"location":"/cozy-stack/references-docs-in-vfs/#response_2","text":"HTTP/1.1 204 No Content Content-Type: application/vnd.api+json","title":"Response"},{"location":"/cozy-stack/references-docs-in-vfs/#get-datatypedoc-idrelationshipsreferences","text":"Returns all the files associated to an album or playlist. Contents is paginated following jsonapi conventions . The default limit is 100 entries. It s also possible to sort the files by their datetime (for photos) with the sort query parameter: ?sort=datetime .","title":"GET /data/:type/:doc-id/relationships/references"},{"location":"/cozy-stack/references-docs-in-vfs/#request_3","text":"GET /data/io.cozy.playlists/e9308dc2-e2e3-11e6-b685-fb88662613d4/relationships/references HTTP/1.1 Content-Type: application/vnd.api+json Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/references-docs-in-vfs/#response_3","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : [ { type : io.cozy.files , id : 417c4e58-e2e4-11e6-b7dc-2b68ed7b77f4 }, { type : io.cozy.files , id : 4504f55c-e2e4-11e6-88f2-d77aeecab549 }, { type : io.cozy.files , id : 4587727a-e2e4-11e6-bfe9-ef1be7df7f26 }, { type : io.cozy.files , id : 45d591d0-e2e4-11e6-ab9a-ff3b218e31cc } ] }","title":"Response"},{"location":"/cozy-stack/references-docs-in-vfs/#post-datatypedoc-idrelationshipsreferences","text":"When creating an album or a playlist, it s tedious to add the references to it for each file individually. This route allows to make it in bulk.","title":"POST /data/:type/:doc-id/relationships/references"},{"location":"/cozy-stack/references-docs-in-vfs/#request_4","text":"POST /data/io.cozy.playlists/e9308dc2-e2e3-11e6-b685-fb88662613d4/relationships/references HTTP/1.1 Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : [ { type : io.cozy.files , id : 417c4e58-e2e4-11e6-b7dc-2b68ed7b77f4 }, { type : io.cozy.files , id : 4504f55c-e2e4-11e6-88f2-d77aeecab549 }, { type : io.cozy.files , id : 4587727a-e2e4-11e6-bfe9-ef1be7df7f26 }, { type : io.cozy.files , id : 45d591d0-e2e4-11e6-ab9a-ff3b218e31cc } ] }","title":"Request"},{"location":"/cozy-stack/references-docs-in-vfs/#response_4","text":"HTTP/1.1 204 No Content Content-Type: application/vnd.api+json Note : if one of the id is a directory, the response will be a 400 Bad Request. References are only for files.","title":"Response"},{"location":"/cozy-stack/references-docs-in-vfs/#delete-datatypedoc-idrelationshipsreferences","text":"This bulk deletion of references on many files can be useful when an album or playlist is deleted.","title":"DELETE /data/:type/:doc-id/relationships/references"},{"location":"/cozy-stack/references-docs-in-vfs/#request_5","text":"DELETE /data/io.cozy.playlists/e9308dc2-e2e3-11e6-b685-fb88662613d4/relationships/references HTTP/1.1 Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : [ { type : io.cozy.files , id : 417c4e58-e2e4-11e6-b7dc-2b68ed7b77f4 }, { type : io.cozy.files , id : 4504f55c-e2e4-11e6-88f2-d77aeecab549 }, { type : io.cozy.files , id : 4587727a-e2e4-11e6-bfe9-ef1be7df7f26 }, { type : io.cozy.files , id : 45d591d0-e2e4-11e6-ab9a-ff3b218e31cc } ] }","title":"Request"},{"location":"/cozy-stack/references-docs-in-vfs/#response_5","text":"HTTP/1.1 204 No Content Content-Type: application/vnd.api+json","title":"Response"},{"location":"/cozy-stack/references-docs-in-vfs/#usage","text":"","title":"Usage"},{"location":"/cozy-stack/references-docs-in-vfs/#modification-of-a-referenced-file","text":"Before an application updates a file, it can check if the file has some references. If it is the case, it may offer to the user two choices: update the file with the new version (the albums and playlists will use the new version) save the new version as a new file and preserve the old file (the old file may be moved to a originals directory).","title":"Modification of a referenced file"},{"location":"/cozy-stack/references-docs-in-vfs/#moving-a-referenced-file-to-the-trash","text":"The stack will refuse to move a referenced file to the trash. It s the same for a folder that contains a referenced file. The application has to remove the references first. It s possible to clear all the references on a file with a PATCH request like this: PATCH /files/9152d568-7e7c-11e6-a377-37cbfb190b4b/relationships/references HTTP/1.1 Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : [] }","title":"Moving a referenced file to the trash"},{"location":"/cozy-stack/references-docs-in-vfs/#implementation","text":"The references are persisted in the io.cozy.files documents in CouchDB. A mango index is used to fetch all the files that are associated to a given document (for GET /data/:type/:doc-id/relationships/references ). For request to update or move to trash a file, it is easy to fetch its CouchDB document to see if it has a reference. But it is more difficult when moving a folder to trash. To do that, we need two requests to fetch the number of references in a folder. 1/ Get all descendant folders from a given folder, with a CouchDB View: map = function(doc) { if (doc.type === folder ) emit(doc.path); }; query = { starkey: parent_folder_path + / , endkey: parent_folder_path + /\\uFFFF }; 2/ Get the total number of referenced file for this folders list, with a map/reduce CouchDB view: map = function(doc) { if(doc.referenced != null) emit(doc.parentID) } reduce = count query = {keys: [list from above]}","title":"Implementation"},{"location":"/cozy-stack/intents/","text":"Table of contents Intents Overview Glossary Proposal 1. Manifest 2. Intent Start 3. Service Resolution 4. Handshake 5. Processing Terminating Routes Annexes Use cases Bibliography Prior Art Discarded Ideas Overview A typical Cozy Cloud runs multiple applications, but most of these applications are focused on one task and interact with one particular type of data. However, Cozy Cloud especially shines when data is combined across apps to provide an integrated experience. This is made difficult by the fact that apps have no dedicated back-end and that they have restricted access to documents. This document outlines a proposal for apps to rely on each other to accomplish certain tasks and gain access to new documents, in a way that hopefully is neither painful for the users nor the developers. Glossary Intent : Intents, sometimes also called Activities, is a pattern used in environments where multiple apps with different purposes coexist. The idea is that any app can express the need to do something that it can t do itself, and an app that can do it will take over from there. Stack : refers to cozy-stack , the server-side part of the Cozy infrastructure. Client : the client is the application that starts an intent. Service : the service is the application that handles an intent started by a client. Proposal In this proposal, services declare themselves through their manifest. When a clients starts an intent, the stack finds the appropriate service and help the two apps to create a communication channel between them. After the channel is ready, the intent is processed. These steps are detailed below. 1. Manifest Every app can register itself as a potential handler for one or more intents. To do so, it must provide the following information for each intent it wishes to handle: action : A verb that describes what the service should do. The most common actions are CREATE , EDIT , OPEN , PICK , and SHARE . While we recommend using one of these verbs, the list is not exhaustive and may be extended by any app. type : One or more types of data on which the service knows how to operate the action . A type can be expressed as a MIME type or a Cozy Document Type . The application must have permissions for any Cozy Document Type listed here. You can also think of the type as the intent s subject. href : the relative URL of the route designed to handle this intent. A query-string with the intent id will be added to this URL. These informations must be provided in the manifest of the application, inside the intents key. Here is a very simple example: intents : [ { action : PICK , type : [ io.cozy.files ], href : /pick } ] When this service is called, it will load the page https://service.domain.example.com/pick?intent=123abc . Here is an example of an app that supports multiple data types: intents : [ { action : PICK , type : [ io.cozy.files , image/* ], href : /pick } ] Finally, here is an example of an app that supports several intent types: intents : [ { action : PICK , type : [ io.cozy.files , image/* ], href : /pick }, { action : VIEW , type : [ image/gif ], href : /viewer } ] This information is stored by the stack when the application is installed. 2. Intent Start Any app can start a new intent whenever it wants. When it does, the app becomes the client . To start an intent, it must specify the following information: action : an action verb, which will be matched against the actions declared in services manifest files. type : a single data type, which will be matched against the types declared in services manifest files. There are also two optional fields that can be defined at the start of the intent: data : Any data that the client wants to make available to the service. data must be a JSON object but its structure is left to the discretion of the client. The only exception is when type is a MIME type and the client wishes to send a file to the service. In that case, the file should be represented as a base-64 encoded Data URL and must be named content . This convention is also recomended when dealing with other intent type s. See the examples below for an example of this. permissions : When type is a Cozy Document Type and the client expects to receive one or more documents as part of the reply from the service, the permissions field allows the client to request permissions for these documents. permissions is a list of HTTP Verbs. Refer to this section of the permission documentation for more information. Note : if the intent s subject is a Cozy Doctype that holds references to other Cozy Documents (such as an album referencing photos or a playlist referencing music files), the permissions should be granted for the referenced documents too, whenever possible. Here is an example of what the API could look like: // Let the user pick a file cozy.intents.start('PICK', 'io.cozy.files') .then(document = { // document is a JSON representation of the picked file }); // Create a contact, with some information already filled out cozy.intents.start('CREATE', 'io.cozy.contacts', { name: 'John Johnsons', tel: '+12345678' email: 'john@johnsons.com' }) .then(document = { // document is a JSON representation of the contact that was created }); // Save this file somewhere cozy.intents.start('CREATE', 'io.cozy.files', { content: 'data:application/zip;base64,UEsDB...', name: 'photos.zip' }); // Create a new note, and give me read-only access to it cozy.intents.start('CREATE', 'io.cozy.notes', {}, ['GET']) .then(document = { // document is a JSON representation of the note that was created. // Additionally, this note can now be retrieved through the API since we have read access on it. }); // Create an event based on the provided data, and give me full access to it cozy.intents.start('CREATE', 'io.cozy.events', { date: '2017/06/24', title: 'Beach day' }, ['ALL']) .then(document = { // document is a JSON representation of the note that was created. // Additionally, this note can now be retrieved through the API since we have read access on it. }); // Crop this picture cozy.intents.start('EDIT', 'image/png', { content: 'data:image/png;base64,iVBORw...', width: 50, height: 50 }) .then(image = { //image is the edited version of the image provided above. }) 3. Service Resolution The service resolution is the phase where a service is chosen to handle an intent. This phase is handled by the stack. After the client has started it s intent, it sends the action , the type and the permissions to the stack. The stack will then traverse the list of installed apps and find all the apps that can handle that specific combination. Note that if the intent request GET permissions on a certain Cozy Document Type, but the service does not have this permission itself, it can not handle the intent. The stack then stores the information for that intent: A unique id for that intent Client URL Service URL action type permissions Finally, the service URL is suffixed with ?intent= followed by the intent s id, and then sent to the client. Service choice If more than one service match the intent s criteria, the stack returns the list of all matching service URLs to the client (and stores it in the service URL version of the intent it keeps in memory). The client is then free to pick one arbitrarily. The client may also decide to let the user choose one of the services. To do this, it should start another intent with a PICK action and a io.cozy.apps type . This intent should be resolved by the stack to a special page, in order to avoid having multiple services trying to handle it and ending up in a loop. This special page is a service like any other; it expects the list of services to pick from as input data, and will return the one that has been picked to the client. The client can then proceed with the first intent. The user may decide to abort the intent before picking a service. If that is the case, the choice page will need to inform the client that the intent was aborted. No available service If no service is available to handle an intent, the stack returns an error to the client. At a later phase of this project, the stack may traverse the applications registered in a store to find suitable services, and prompt the user to install one. 4. Handshake The next phase consist of the client and the service establishing a communication channel between them. The communication will be done using the window.postMessage API. Service Initialization When the client receives the service URL from the stack, it starts to listen for messages coming from that URL. Once the listener is started, it opens an iframe that points to the service s URL. Service to Client At this point, the service app is opened on the route that it provided in the href part of it s manifest. This route now also contains the intent s id. The service queries the stack to find out information about the intent, passing along the intent id. In response, the stack sends the client s URL, the action , and the type . If the intent includes permissions , the stack sends them too, as well as the client s permission id. It then starts to listen for messages coming from the client s URL. Eventually, it sends a message to the client, as a mean to inform it that the service is now ready. Client to Service After the client receives the ready message from the service, it sends a message to the service acknowledging the ready state. Along with this message, it should send the data that was provided at the start of the intent, if any. 5. Processing Terminating After this handshake, there is a confirmed communication channel between the client and the service, and the service knows what it has to do. This is the phase where the user interacts with the service. If the service is going to grant extra permissions to the client app, it is strongly recommended to make this clear to the user. When the service has finished his task, it sends a completed message to the client. Permissions extensions should have been done before that. Along with the completed message, the service should send any data it deems relevant. This data should be a JSON object. Again, the structure of that object is left to the discretion of the service, except when type is a MIME type. In that case, the file should be represented as a base-64 encoded Data URL and must be named content . This convention is also recomended when dealing with other intent type s. After the client receives a completed message, it can close the service s iframe and resume operations as usual. If, for whatever reason, the service can not fulfill the intent, it can send an error message to the client. When the client receives an error message, the intent is aborted and the iframe can be closed. Routes POST /intents The client app can ask to start an intent via this route. Any client-side app can call this route, no permission is needed. Request POST /intents HTTP/1.1 Host: cozy.example.net Authorization: Bearer eyJhbG... Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : { type : io.cozy.intents , attributes : { action : PICK , type : io.cozy.files , permissions : [ GET ] } } } Response HTTP/1.1 201 Created Content-Type: application/vnd.api+json { data : { id : 77bcc42c-0fd8-11e7-ac95-8f605f6e8338 , type : io.cozy.intents , attributes : { action : PICK , type : io.cozy.files , permissions : [ GET ], client : https://contacts.cozy.example.net , services : [ { slug : files , href : https://files.cozy.example.net/pick?intent=77bcc42c-0fd8-11e7-ac95-8f605f6e8338 } ] }, links : { self : /intents/77bcc42c-0fd8-11e7-ac95-8f605f6e8338 , permissions : /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 } } } GET /intents/:id Get all the informations about the intent Note : only the service can access this route (no permission involved). Request GET /intents/77bcc42c-0fd8-11e7-ac95-8f605f6e8338 HTTP/1.1 Host: cozy.example.net Authorization: Bearer J9l-ZhwP... Content-Type: application/vnd.api+json Accept: application/vnd.api+json Response HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { id : 77bcc42c-0fd8-11e7-ac95-8f605f6e8338 , type : io.cozy.intents , attributes : { action : PICK , type : io.cozy.files , permissions : [ GET ], client : https://contacts.cozy.example.net , services : [ { slug : files , href : https://files.cozy.example.net/pick?intent=77bcc42c-0fd8-11e7-ac95-8f605f6e8338 } ] }, links : { self : /intents/77bcc42c-0fd8-11e7-ac95-8f605f6e8338 , permissions : /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 } } } Annexes Use Cases Here is a non exhaustive list of situations that may use intents: Configure a new connector account Share a photo album via email Add an attachment to an email Attach a note to a contact Create a contact based on an email Save an attachment received in an email Create a birthday event in a calendar, based on a contact Create an event based on an email s content Create an event based on an ICS file Chose an avatar for a contact Open a file from the file browser (music, PDF, image, ) Attach a receipt to an expense Provide a tip for another application Bibliography Prior Art Prior art: https://forum.cozy.io/t/cozy-tech-topic-inter-app-communication-architecture/2287 Web intents: http://webintents.org/ WebActivities: https://wiki.mozilla.org/WebAPI/WebActivities and https://developer.mozilla.org/en-US/docs/Archive/Firefox_OS/API/Web_Activities Siri Intents: https://developer.apple.com/library/content/documentation/Intents/Conceptual/SiriIntegrationGuide/ResolvingandHandlingIntents.html#//apple_ref/doc/uid/TP40016875-CH5-SW1 Android Intents: https://developer.android.com/reference/android/content/Intent.html iOS extensions: https://developer.apple.com/library/content/documentation/General/Conceptual/ExtensibilityPG/index.html Discarded Ideas Disposition Some specifications include a disposition field in the manifests, that gives a hint to the client about how to display the service (inlined or in a new window). Since we were unable to find a use case where a new window is required, we decided not to include the disposition in this specification. It might be added later if the need arises. Client / Server architecture Instead of letting the two applications communicate with each other, they could be made to talk through the stack. This would be useful as the stack could act as a middleware, transforming data on the fly or granting permissions where appropriate. However, this approach has also severe drawbacks, notably the fact that the stack must hold a copy of all the data that the apps want to transfer (which can include large files). It also makes it significantly harder for the client to know when the intent has been processed. Data representation The client could explicitly request a data format to be used in the communication. However, this idea was abandoned because the format is always json, except when then intent s type is a MIME type, in which case the data format also uses this type.","title":"/intents - Intents"},{"location":"/cozy-stack/intents/#intents","text":"Overview Glossary Proposal 1. Manifest 2. Intent Start 3. Service Resolution 4. Handshake 5. Processing Terminating Routes Annexes Use cases Bibliography Prior Art Discarded Ideas","title":"Intents"},{"location":"/cozy-stack/intents/#overview","text":"A typical Cozy Cloud runs multiple applications, but most of these applications are focused on one task and interact with one particular type of data. However, Cozy Cloud especially shines when data is combined across apps to provide an integrated experience. This is made difficult by the fact that apps have no dedicated back-end and that they have restricted access to documents. This document outlines a proposal for apps to rely on each other to accomplish certain tasks and gain access to new documents, in a way that hopefully is neither painful for the users nor the developers.","title":"Overview"},{"location":"/cozy-stack/intents/#glossary","text":"Intent : Intents, sometimes also called Activities, is a pattern used in environments where multiple apps with different purposes coexist. The idea is that any app can express the need to do something that it can t do itself, and an app that can do it will take over from there. Stack : refers to cozy-stack , the server-side part of the Cozy infrastructure. Client : the client is the application that starts an intent. Service : the service is the application that handles an intent started by a client.","title":"Glossary"},{"location":"/cozy-stack/intents/#proposal","text":"In this proposal, services declare themselves through their manifest. When a clients starts an intent, the stack finds the appropriate service and help the two apps to create a communication channel between them. After the channel is ready, the intent is processed. These steps are detailed below.","title":"Proposal"},{"location":"/cozy-stack/intents/#1-manifest","text":"Every app can register itself as a potential handler for one or more intents. To do so, it must provide the following information for each intent it wishes to handle: action : A verb that describes what the service should do. The most common actions are CREATE , EDIT , OPEN , PICK , and SHARE . While we recommend using one of these verbs, the list is not exhaustive and may be extended by any app. type : One or more types of data on which the service knows how to operate the action . A type can be expressed as a MIME type or a Cozy Document Type . The application must have permissions for any Cozy Document Type listed here. You can also think of the type as the intent s subject. href : the relative URL of the route designed to handle this intent. A query-string with the intent id will be added to this URL. These informations must be provided in the manifest of the application, inside the intents key. Here is a very simple example: intents : [ { action : PICK , type : [ io.cozy.files ], href : /pick } ] When this service is called, it will load the page https://service.domain.example.com/pick?intent=123abc . Here is an example of an app that supports multiple data types: intents : [ { action : PICK , type : [ io.cozy.files , image/* ], href : /pick } ] Finally, here is an example of an app that supports several intent types: intents : [ { action : PICK , type : [ io.cozy.files , image/* ], href : /pick }, { action : VIEW , type : [ image/gif ], href : /viewer } ] This information is stored by the stack when the application is installed.","title":"1. Manifest"},{"location":"/cozy-stack/intents/#2-intent-start","text":"Any app can start a new intent whenever it wants. When it does, the app becomes the client . To start an intent, it must specify the following information: action : an action verb, which will be matched against the actions declared in services manifest files. type : a single data type, which will be matched against the types declared in services manifest files. There are also two optional fields that can be defined at the start of the intent: data : Any data that the client wants to make available to the service. data must be a JSON object but its structure is left to the discretion of the client. The only exception is when type is a MIME type and the client wishes to send a file to the service. In that case, the file should be represented as a base-64 encoded Data URL and must be named content . This convention is also recomended when dealing with other intent type s. See the examples below for an example of this. permissions : When type is a Cozy Document Type and the client expects to receive one or more documents as part of the reply from the service, the permissions field allows the client to request permissions for these documents. permissions is a list of HTTP Verbs. Refer to this section of the permission documentation for more information. Note : if the intent s subject is a Cozy Doctype that holds references to other Cozy Documents (such as an album referencing photos or a playlist referencing music files), the permissions should be granted for the referenced documents too, whenever possible. Here is an example of what the API could look like: // Let the user pick a file cozy.intents.start('PICK', 'io.cozy.files') .then(document = { // document is a JSON representation of the picked file }); // Create a contact, with some information already filled out cozy.intents.start('CREATE', 'io.cozy.contacts', { name: 'John Johnsons', tel: '+12345678' email: 'john@johnsons.com' }) .then(document = { // document is a JSON representation of the contact that was created }); // Save this file somewhere cozy.intents.start('CREATE', 'io.cozy.files', { content: 'data:application/zip;base64,UEsDB...', name: 'photos.zip' }); // Create a new note, and give me read-only access to it cozy.intents.start('CREATE', 'io.cozy.notes', {}, ['GET']) .then(document = { // document is a JSON representation of the note that was created. // Additionally, this note can now be retrieved through the API since we have read access on it. }); // Create an event based on the provided data, and give me full access to it cozy.intents.start('CREATE', 'io.cozy.events', { date: '2017/06/24', title: 'Beach day' }, ['ALL']) .then(document = { // document is a JSON representation of the note that was created. // Additionally, this note can now be retrieved through the API since we have read access on it. }); // Crop this picture cozy.intents.start('EDIT', 'image/png', { content: 'data:image/png;base64,iVBORw...', width: 50, height: 50 }) .then(image = { //image is the edited version of the image provided above. })","title":"2. Intent Start"},{"location":"/cozy-stack/intents/#3-service-resolution","text":"The service resolution is the phase where a service is chosen to handle an intent. This phase is handled by the stack. After the client has started it s intent, it sends the action , the type and the permissions to the stack. The stack will then traverse the list of installed apps and find all the apps that can handle that specific combination. Note that if the intent request GET permissions on a certain Cozy Document Type, but the service does not have this permission itself, it can not handle the intent. The stack then stores the information for that intent: A unique id for that intent Client URL Service URL action type permissions Finally, the service URL is suffixed with ?intent= followed by the intent s id, and then sent to the client.","title":"3. Service Resolution"},{"location":"/cozy-stack/intents/#service-choice","text":"If more than one service match the intent s criteria, the stack returns the list of all matching service URLs to the client (and stores it in the service URL version of the intent it keeps in memory). The client is then free to pick one arbitrarily. The client may also decide to let the user choose one of the services. To do this, it should start another intent with a PICK action and a io.cozy.apps type . This intent should be resolved by the stack to a special page, in order to avoid having multiple services trying to handle it and ending up in a loop. This special page is a service like any other; it expects the list of services to pick from as input data, and will return the one that has been picked to the client. The client can then proceed with the first intent. The user may decide to abort the intent before picking a service. If that is the case, the choice page will need to inform the client that the intent was aborted.","title":"Service choice"},{"location":"/cozy-stack/intents/#no-available-service","text":"If no service is available to handle an intent, the stack returns an error to the client. At a later phase of this project, the stack may traverse the applications registered in a store to find suitable services, and prompt the user to install one.","title":"No available service"},{"location":"/cozy-stack/intents/#4-handshake","text":"The next phase consist of the client and the service establishing a communication channel between them. The communication will be done using the window.postMessage API.","title":"4. Handshake"},{"location":"/cozy-stack/intents/#service-initialization","text":"When the client receives the service URL from the stack, it starts to listen for messages coming from that URL. Once the listener is started, it opens an iframe that points to the service s URL.","title":"Service Initialization"},{"location":"/cozy-stack/intents/#service-to-client","text":"At this point, the service app is opened on the route that it provided in the href part of it s manifest. This route now also contains the intent s id. The service queries the stack to find out information about the intent, passing along the intent id. In response, the stack sends the client s URL, the action , and the type . If the intent includes permissions , the stack sends them too, as well as the client s permission id. It then starts to listen for messages coming from the client s URL. Eventually, it sends a message to the client, as a mean to inform it that the service is now ready.","title":"Service to Client"},{"location":"/cozy-stack/intents/#client-to-service","text":"After the client receives the ready message from the service, it sends a message to the service acknowledging the ready state. Along with this message, it should send the data that was provided at the start of the intent, if any.","title":"Client to Service"},{"location":"/cozy-stack/intents/#5-processing-terminating","text":"After this handshake, there is a confirmed communication channel between the client and the service, and the service knows what it has to do. This is the phase where the user interacts with the service. If the service is going to grant extra permissions to the client app, it is strongly recommended to make this clear to the user. When the service has finished his task, it sends a completed message to the client. Permissions extensions should have been done before that. Along with the completed message, the service should send any data it deems relevant. This data should be a JSON object. Again, the structure of that object is left to the discretion of the service, except when type is a MIME type. In that case, the file should be represented as a base-64 encoded Data URL and must be named content . This convention is also recomended when dealing with other intent type s. After the client receives a completed message, it can close the service s iframe and resume operations as usual. If, for whatever reason, the service can not fulfill the intent, it can send an error message to the client. When the client receives an error message, the intent is aborted and the iframe can be closed.","title":"5. Processing &amp; Terminating"},{"location":"/cozy-stack/intents/#routes","text":"","title":"Routes"},{"location":"/cozy-stack/intents/#post-intents","text":"The client app can ask to start an intent via this route. Any client-side app can call this route, no permission is needed.","title":"POST /intents"},{"location":"/cozy-stack/intents/#request","text":"POST /intents HTTP/1.1 Host: cozy.example.net Authorization: Bearer eyJhbG... Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : { type : io.cozy.intents , attributes : { action : PICK , type : io.cozy.files , permissions : [ GET ] } } }","title":"Request"},{"location":"/cozy-stack/intents/#response","text":"HTTP/1.1 201 Created Content-Type: application/vnd.api+json { data : { id : 77bcc42c-0fd8-11e7-ac95-8f605f6e8338 , type : io.cozy.intents , attributes : { action : PICK , type : io.cozy.files , permissions : [ GET ], client : https://contacts.cozy.example.net , services : [ { slug : files , href : https://files.cozy.example.net/pick?intent=77bcc42c-0fd8-11e7-ac95-8f605f6e8338 } ] }, links : { self : /intents/77bcc42c-0fd8-11e7-ac95-8f605f6e8338 , permissions : /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 } } }","title":"Response"},{"location":"/cozy-stack/intents/#get-intentsid","text":"Get all the informations about the intent Note : only the service can access this route (no permission involved).","title":"GET /intents/:id"},{"location":"/cozy-stack/intents/#request_1","text":"GET /intents/77bcc42c-0fd8-11e7-ac95-8f605f6e8338 HTTP/1.1 Host: cozy.example.net Authorization: Bearer J9l-ZhwP... Content-Type: application/vnd.api+json Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/intents/#response_1","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { id : 77bcc42c-0fd8-11e7-ac95-8f605f6e8338 , type : io.cozy.intents , attributes : { action : PICK , type : io.cozy.files , permissions : [ GET ], client : https://contacts.cozy.example.net , services : [ { slug : files , href : https://files.cozy.example.net/pick?intent=77bcc42c-0fd8-11e7-ac95-8f605f6e8338 } ] }, links : { self : /intents/77bcc42c-0fd8-11e7-ac95-8f605f6e8338 , permissions : /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 } } }","title":"Response"},{"location":"/cozy-stack/intents/#annexes","text":"","title":"Annexes"},{"location":"/cozy-stack/intents/#use-cases","text":"Here is a non exhaustive list of situations that may use intents: Configure a new connector account Share a photo album via email Add an attachment to an email Attach a note to a contact Create a contact based on an email Save an attachment received in an email Create a birthday event in a calendar, based on a contact Create an event based on an email s content Create an event based on an ICS file Chose an avatar for a contact Open a file from the file browser (music, PDF, image, ) Attach a receipt to an expense Provide a tip for another application","title":"Use Cases"},{"location":"/cozy-stack/intents/#bibliography-prior-art","text":"Prior art: https://forum.cozy.io/t/cozy-tech-topic-inter-app-communication-architecture/2287 Web intents: http://webintents.org/ WebActivities: https://wiki.mozilla.org/WebAPI/WebActivities and https://developer.mozilla.org/en-US/docs/Archive/Firefox_OS/API/Web_Activities Siri Intents: https://developer.apple.com/library/content/documentation/Intents/Conceptual/SiriIntegrationGuide/ResolvingandHandlingIntents.html#//apple_ref/doc/uid/TP40016875-CH5-SW1 Android Intents: https://developer.android.com/reference/android/content/Intent.html iOS extensions: https://developer.apple.com/library/content/documentation/General/Conceptual/ExtensibilityPG/index.html","title":"Bibliography &amp; Prior Art"},{"location":"/cozy-stack/intents/#discarded-ideas","text":"","title":"Discarded Ideas"},{"location":"/cozy-stack/intents/#disposition","text":"Some specifications include a disposition field in the manifests, that gives a hint to the client about how to display the service (inlined or in a new window). Since we were unable to find a use case where a new window is required, we decided not to include the disposition in this specification. It might be added later if the need arises.","title":"Disposition"},{"location":"/cozy-stack/intents/#client-server-architecture","text":"Instead of letting the two applications communicate with each other, they could be made to talk through the stack. This would be useful as the stack could act as a middleware, transforming data on the fly or granting permissions where appropriate. However, this approach has also severe drawbacks, notably the fact that the stack must hold a copy of all the data that the apps want to transfer (which can include large files). It also makes it significantly harder for the client to know when the intent has been processed.","title":"Client / Server architecture"},{"location":"/cozy-stack/intents/#data-representation","text":"The client could explicitly request a data format to be used in the communication. However, this idea was abandoned because the format is always json, except when then intent s type is a MIME type, in which case the data format also uses this type.","title":"Data representation"},{"location":"/cozy-stack/jobs/","text":"Table of contents Jobs Jobs are designed to represent asynchronous tasks that your cozy can execute. These tasks can be scheduled in advance, recurring or sudden and provide various services. At the time, we do not provide generic and programmable tasks. This list of available workers is part of the defined API. The job queue can be either local to the cozy-stack when used as a monolithic instance (self-hosted for instance) or distributed via a redis server for distributed infrastructures. This doc introduces two cozy types: io.cozy.jobs for jobs io.cozy.triggers for triggers Triggers Jobs can be launched by five different types of triggers: @at to schedule a one-time job executed after at a specific time in the future @in to schedule a one-time job executed after a specific amount of time @every to schedule periodic jobs executed at a given fix interval @cron to schedule recurring jobs scheduled at specific times @event to launch a job after a change in the cozy These five triggers have specific syntaxes to describe when jobs should be scheduled. See below for more informations. Jobs can also be queued up programatically, without the help of a specific trigger directly via the /jobs/queue API. In this case the trigger name is empty. @at syntax The @at trigger takes a ISO-8601 formatted string indicating a UTC time in the future. The date is of this form: YYYY-MM-DDTHH:mm:ss.sssZ Examples @at 2018-12-12T15:36:25.507Z @in syntax The @in trigger takes the same duration syntax as @every Examples @in 10m @in 1h30m @every syntax The @every trigger uses the same syntax as golang s time.ParseDuration (but only support time units above seconds): A duration string is a possibly signed sequence of decimal numbers, each with optional fraction and a unit suffix, such as 300ms , 1.5h or 2h45m . Valid time units are s , m , h . Examples @every 1.5h # schedules every 1 and a half hours @every 30m10s # schedules every 30 minutes and 10 seconds @cron syntax In order to schedule recurring jobs, the @cron trigger has the syntax using six fields: Field name Mandatory? Allowed values Allowed special characters Seconds Yes 0-59 * / , - Minutes Yes 0-59 * / , - Hours Yes 0-23 * / , - Day of month Yes 1-31 * / , - ? Month Yes 1-12 or JAN-DEC * / , - Day of week Yes 0-6 or SUN-SAT * / , - ? Asterisk ( * ) The asterisk indicates that the cron expression will match for all values of the field; e.g., using an asterisk in the 5th field (month) would indicate every month. Slash ( / ) Slashes are used to describe increments of ranges. For example 3-59/15 in the 1st field (minutes) would indicate the 3rd minute of the hour and every 15 minutes thereafter. The form \"*\\/...\" is equivalent to the form \"first-last/...\" , that is, an increment over the largest possible range of the field. The form \"N-/...\" is accepted as meaning \"N-MAX/...\" , that is, starting at N, use the increment until the end of that specific range. It does not wrap around. Comma ( , ) Commas are used to separate items of a list. For example, using \"MON,WED,FRI\" in the 5th field (day of week) would mean Mondays, Wednesdays and Fridays. Hyphen ( - ) Hyphens are used to define ranges. For example, 9-17 would indicate every hour between 9am and 5pm inclusive. Question mark ( ? ) Question mark may be used instead of * for leaving either day-of-month or day-of-week blank. To schedule jobs given an interval: Examples: @cron 0 0 0 1 1 * # Run once a year, midnight, Jan. 1st @cron 0 0 0 1 1 * # Run once a year, midnight, Jan. 1st @cron 0 0 0 1 * * # Run once a month, midnight, first of month @cron 0 0 0 * * 0 # Run once a week, midnight on Sunday @cron 0 0 0 * * * # Run once a day, midnight @cron 0 0 * * * * # Run once an hour, beginning of hour @event syntax The @event syntax allows to trigger a job when something occurs in the stack. It follows the same syntax than permissions scope string: type[:verb][:values][:selector] Unlike for permissions string, the verb should be one of CREATED , DELETED , UPDATED . The job worker will receive a compound message including original trigger_infos messages and the event which has triggered it. Examples @event io.cozy.files // anything happens on files @event io.cozy.files:CREATED // a file was created @event io.cozy.files:DELETED:image/jpg:mime // an image was deleted @event io.cozy.bank.operations:CREATED io.cozy.bank.bills:CREATED // a bank operation or a bill Error Handling Jobs can fail to execute their task. We have two ways to parameterize such cases. Retry A retry count can be optionally specified to ask the worker to re-execute the task if it has failed. Each retry is executed after a configurable delay. The try count is part of the attributes of the job. Also, each occurring error is kept in the errors field containing all the errors that may have happened. Timeout A worker may never end. To prevent this, a configurable timeout value is specified with the job. If a job does not end after the specified amount of time, it will be aborted. A timeout is just like another error from the worker and can provoke a retry if specified. Defaults By default, jobs are parameterized with a maximum of 3 tries with 1 minute timeout. These defaults may vary given the workload of the workers. Jobs API Example and description of the attributes of a io.cozy.jobs : { domain : me.cozy.tools , worker : sendmail , // worker type name options : { priority : 3, // priority from 1 to 100, higher number is higher priority timeout : 60, // timeout value in seconds max_exec_count : 3, // maximum number of time the job should be executed (including retries) }, state : running , // queued, running, errored queued_at : 2016-09-19T12:35:08Z , // time of the queuing started_at : 2016-09-19T12:35:08Z , // time of first execution error : // error message if any } Example and description of a job creation options \u2014 as you can see, the options are replicated in the io.cozy.jobs attributes: { priority : 3, // priority from 1 to 100 timeout : 60, // timeout value in seconds max_exec_count : 3, // maximum number of retry } GET /jobs/:job-id Get a job informations given its ID. Request GET /jobs/123123 HTTP/1.1 Accept: application/vnd.api+json Response { data : { type : io.cozy.jobs , id : 123123 , attributes : { domain : me.cozy.tools , worker : sendmail , options : { priority : 3, timeout : 60, max_exec_count : 3 }, state : running , queued_at : 2016-09-19T12:35:08Z , started_at : 2016-09-19T12:35:08Z , error : }, links : { self : /jobs/123123 } } } POST /jobs/queue/:worker-type Enqueue programmatically a new job. This route requires a specific permission on the worker-type. A global permission on the global io.cozy.jobs doctype is not allowed. Request POST /jobs/queue/sendmail HTTP/1.1 Accept: application/vnd.api+json { data : { attributes : { options : { priority : 3, timeout : 60, max_exec_count : 3 }, arguments : {} // any json value used as arguments for the job } } } Response { data : { type : io.cozy.jobs , id : 123123 , attributes : { domain : me.cozy.tools , worker : sendmail , options : { priority : 3, timeout : 60, max_exec_count : 3 }, state : running , queued_at : 2016-09-19T12:35:08Z , started_at : 2016-09-19T12:35:08Z , error : }, links : { self : /jobs/123123 } } } Permissions To use this endpoint, an application needs a permission on the type io.cozy.jobs for the verb POST . The is required to restrict its permission to specific worker(s), like this (a global permission on the doctype is not allowed): { permissions : { mail-from-the-user : { description : Required to send mails from the user to his/her friends , type : io.cozy.jobs , verbs : [ POST ], selector : worker , values : [ sendmail ] } } } GET /jobs/queue/:worker-type List the jobs in the queue. Request GET /jobs/queue/sendmail HTTP/1.1 Accept: application/vnd.api+json Response { data : [ { attributes : { domain : cozy.tools:8080 , options : null, queued_at : 2017-09-29T15:32:31.953878568+02:00 , started_at : 0001-01-01T00:00:00Z , state : queued , worker : log }, id : 77689bca9634b4fb08d6ca3d1643de5f , links : { self : /jobs/log/77689bca9634b4fb08d6ca3d1643de5f }, meta : { rev : 1-f823bcd2759103a5ad1a98f4bf083b36 }, type : io.cozy.jobs } ], meta : { count : 0 } } Permissions To use this endpoint, an application needs a permission on the type io.cozy.jobs for the verb GET . In most cases, the application will restrict its permission to only one worker, like this: { permissions : { mail-from-the-user : { description : Required to know the number of jobs in the sendmail queues , type : io.cozy.jobs , verbs : [ GET ], selector : worker , values : [ sendmail ] } } } POST /jobs/triggers Add a trigger of the worker. See triggers descriptions to see the types of trigger and their arguments syntax. This route requires a specific permission on the worker type. A global permission on the global io.cozy.triggers doctype is not allowed. The debounce parameter can be used to limit the number of jobs created in a burst. It delays the creation of the job on the first input by the given time argument, and if the trigger has its condition matched again during this period, it won t create another job. It can be useful to combine it with the changes feed of couchdb with a last sequence number persisted by the worker, as it allows to have a nice diff between two executions of the worker. Request POST /jobs/triggers HTTP/1.1 Accept: application/vnd.api+json { data : { attributes : { type : @event , arguments : io.cozy.invitations , debounce : 10m , worker : sendmail , worker_arguments : {}, options : { priority : 3, timeout : 60, max_exec_count : 3 } } } } Response { data : { type : io.cozy.triggers , id : 123123 , attributes : { type : @every , arguments : 30m10s , debounce : 10m , worker : sendmail , options : { priority : 3, timeout : 60, max_exec_count : 3 } }, links : { self : /jobs/triggers/123123 } } } Permissions To use this endpoint, an application needs a permission on the type io.cozy.triggers for the verb POST . In most cases, the application will restrict its permission to only one worker, like this: { permissions : { mail-from-the-user : { description : Required to send regularly mails from the user to his/her friends , type : io.cozy.triggers , verbs : [ POST ], selector : worker , values : [ sendmail ] } } } GET /jobs/triggers/:trigger-id Get a trigger informations given its ID. Request GET /jobs/triggers/123123 HTTP/1.1 Accept: application/vnd.api+json Response { data : { type : io.cozy.triggers , id : 123123 , attributes : { type : @every , arguments : 30m10s , worker : sendmail , options : { priority : 3, timeout : 60, max_exec_count : 3 }, current_state : { status : done , last_success : 2017-11-20T13:31:09.01641731 , last_successful_job_id : abcde , last_execution : 2017-11-20T13:31:09.01641731 , last_executed_job_id : abcde , last_failure : 2017-11-20T13:31:09.01641731 , last_failed_job_id : abcde , last_error : error value , last_manual_execution : 2017-11-20T13:31:09.01641731 , last_manual_job_id : abcde } }, links : { self : /jobs/triggers/123123 } } } Permissions To use this endpoint, an application needs a permission on the type io.cozy.triggers for the verb GET . GET /jobs/triggers/:trigger-id/state Get the trigger current state, to give a big picture of the health of the trigger. last executed job status ( done , errored , queued or running ) last executed job that resulted in a successful executoin last executed job that resulted in an error last executed job from a manual execution (not executed by the trigger directly) Request GET /jobs/triggers/123123/state HTTP/1.1 Accept: application/vnd.api+json Response { data : { type : io.cozy.jobs.state , id : 123123 , attributes : { status : done , last_success : 2017-11-20T13:31:09.01641731 , last_successful_job_id : abcde , last_execution : 2017-11-20T13:31:09.01641731 , last_executed_job_id : abcde , last_failure : 2017-11-20T13:31:09.01641731 , last_failed_job_id : abcde , last_error : error value , last_manual_execution : 2017-11-20T13:31:09.01641731 , last_manual_job_id : abcde } } } Permissions To use this endpoint, an application needs a permission on the type io.cozy.triggers for the verb GET . GET /jobs/triggers/:trigger-id/jobs Get the jobs launched by the trigger with the specified ID. Query parameters: Limit : to specify the number of jobs to get out Request GET /jobs/triggers/123123/jobs?Limit=1 HTTP/1.1 Accept: application/vnd.api+json Response { data : [ { type : io.cozy.jobs , id : 123123 , attributes : {}, links : { self : /jobs/123123 } } ] } POST /jobs/triggers/:trigger-id/launch Launch a trigger manually given its ID and return the created job. Request POST /jobs/triggers/123123/launch HTTP/1.1 Accept: application/vnd.api+json Response { data : { type : io.cozy.jobs , id : 123123 , attributes : { domain : me.cozy.tools , worker : sendmail , options : {}, state : running , queued_at : 2016-09-19T12:35:08Z , started_at : 2016-09-19T12:35:08Z , error : }, links : { self : /jobs/123123 } } } Permissions To use this endpoint, an application needs a permission on the type io.cozy.triggers for the verb POST . DELETE /jobs/triggers/:trigger-id Delete a trigger given its ID. Request DELETE /jobs/triggers/123123 HTTP/1.1 Accept: application/vnd.api+json Permissions To use this endpoint, an application needs a permission on the type io.cozy.triggers for the verb DELETE . GET /jobs/triggers Get the list of triggers. Query parameters: Worker : to filter only triggers associated with a specific worker. Request GET /jobs/triggers?Worker=konnector HTTP/1.1 Accept: application/vnd.api+json Response { data : [ { type : io.cozy.triggers , id : 123123 , attributes : {}, links : { self : /jobs/triggers/123123 } } ] } Permissions To use this endpoint, an application needs a permission on the type io.cozy.triggers for the verb GET . When used on a specific worker, the permission can be specified on the worker field. Worker pool The consuming side of the job queue is handled by a worker pool. On a monolithic cozy-stack, the worker pool has a configurable fixed size of workers. The default value is not yet determined. Each time a worker has finished a job, it check the queue and based on the priority and the queued date of the job, picks a new job to execute. Permissions In order to prevent jobs from leaking informations between applications, we may need to add filtering per applications: for instance one queue per applications. We should also have an explicit check on the permissions of the applications before launching a job scheduled by an application. For more information, refer to our permission document . Multi-stack When some instances are served by several stacks, the scheduling and running of jobs can be distributed on the stacks. The synchronization is done via redis. For scheduling, there is one important key in redis: triggers . It s a sorted set. The members are the identifiants of the triggers (with the domain name), and the score are the timestamp of the next time the trigger should occur. During the short period of time where a trigger is processed, its key is moved to scheduling (another sorted set). So, even if a stack crash during processing a trigger, this trigger won t be lost. For @event triggers, we don t use the same mechanism. Each stack has all the triggers in memory and is responsible to trigger them for the events generated by the HTTP requests of their API. They also publish them on redis: this pub/sub is used for the realtime API.","title":"/jobs Jobs"},{"location":"/cozy-stack/jobs/#jobs","text":"Jobs are designed to represent asynchronous tasks that your cozy can execute. These tasks can be scheduled in advance, recurring or sudden and provide various services. At the time, we do not provide generic and programmable tasks. This list of available workers is part of the defined API. The job queue can be either local to the cozy-stack when used as a monolithic instance (self-hosted for instance) or distributed via a redis server for distributed infrastructures. This doc introduces two cozy types: io.cozy.jobs for jobs io.cozy.triggers for triggers","title":"Jobs"},{"location":"/cozy-stack/jobs/#triggers","text":"Jobs can be launched by five different types of triggers: @at to schedule a one-time job executed after at a specific time in the future @in to schedule a one-time job executed after a specific amount of time @every to schedule periodic jobs executed at a given fix interval @cron to schedule recurring jobs scheduled at specific times @event to launch a job after a change in the cozy These five triggers have specific syntaxes to describe when jobs should be scheduled. See below for more informations. Jobs can also be queued up programatically, without the help of a specific trigger directly via the /jobs/queue API. In this case the trigger name is empty.","title":"Triggers"},{"location":"/cozy-stack/jobs/#at-syntax","text":"The @at trigger takes a ISO-8601 formatted string indicating a UTC time in the future. The date is of this form: YYYY-MM-DDTHH:mm:ss.sssZ Examples @at 2018-12-12T15:36:25.507Z","title":"@at syntax"},{"location":"/cozy-stack/jobs/#in-syntax","text":"The @in trigger takes the same duration syntax as @every Examples @in 10m @in 1h30m","title":"@in syntax"},{"location":"/cozy-stack/jobs/#every-syntax","text":"The @every trigger uses the same syntax as golang s time.ParseDuration (but only support time units above seconds): A duration string is a possibly signed sequence of decimal numbers, each with optional fraction and a unit suffix, such as 300ms , 1.5h or 2h45m . Valid time units are s , m , h . Examples @every 1.5h # schedules every 1 and a half hours @every 30m10s # schedules every 30 minutes and 10 seconds","title":"@every syntax"},{"location":"/cozy-stack/jobs/#cron-syntax","text":"In order to schedule recurring jobs, the @cron trigger has the syntax using six fields: Field name Mandatory? Allowed values Allowed special characters Seconds Yes 0-59 * / , - Minutes Yes 0-59 * / , - Hours Yes 0-23 * / , - Day of month Yes 1-31 * / , - ? Month Yes 1-12 or JAN-DEC * / , - Day of week Yes 0-6 or SUN-SAT * / , - ? Asterisk ( * ) The asterisk indicates that the cron expression will match for all values of the field; e.g., using an asterisk in the 5th field (month) would indicate every month. Slash ( / ) Slashes are used to describe increments of ranges. For example 3-59/15 in the 1st field (minutes) would indicate the 3rd minute of the hour and every 15 minutes thereafter. The form \"*\\/...\" is equivalent to the form \"first-last/...\" , that is, an increment over the largest possible range of the field. The form \"N-/...\" is accepted as meaning \"N-MAX/...\" , that is, starting at N, use the increment until the end of that specific range. It does not wrap around. Comma ( , ) Commas are used to separate items of a list. For example, using \"MON,WED,FRI\" in the 5th field (day of week) would mean Mondays, Wednesdays and Fridays. Hyphen ( - ) Hyphens are used to define ranges. For example, 9-17 would indicate every hour between 9am and 5pm inclusive. Question mark ( ? ) Question mark may be used instead of * for leaving either day-of-month or day-of-week blank. To schedule jobs given an interval: Examples: @cron 0 0 0 1 1 * # Run once a year, midnight, Jan. 1st @cron 0 0 0 1 1 * # Run once a year, midnight, Jan. 1st @cron 0 0 0 1 * * # Run once a month, midnight, first of month @cron 0 0 0 * * 0 # Run once a week, midnight on Sunday @cron 0 0 0 * * * # Run once a day, midnight @cron 0 0 * * * * # Run once an hour, beginning of hour","title":"@cron syntax"},{"location":"/cozy-stack/jobs/#event-syntax","text":"The @event syntax allows to trigger a job when something occurs in the stack. It follows the same syntax than permissions scope string: type[:verb][:values][:selector] Unlike for permissions string, the verb should be one of CREATED , DELETED , UPDATED . The job worker will receive a compound message including original trigger_infos messages and the event which has triggered it. Examples @event io.cozy.files // anything happens on files @event io.cozy.files:CREATED // a file was created @event io.cozy.files:DELETED:image/jpg:mime // an image was deleted @event io.cozy.bank.operations:CREATED io.cozy.bank.bills:CREATED // a bank operation or a bill","title":"@event syntax"},{"location":"/cozy-stack/jobs/#error-handling","text":"Jobs can fail to execute their task. We have two ways to parameterize such cases.","title":"Error Handling"},{"location":"/cozy-stack/jobs/#retry","text":"A retry count can be optionally specified to ask the worker to re-execute the task if it has failed. Each retry is executed after a configurable delay. The try count is part of the attributes of the job. Also, each occurring error is kept in the errors field containing all the errors that may have happened.","title":"Retry"},{"location":"/cozy-stack/jobs/#timeout","text":"A worker may never end. To prevent this, a configurable timeout value is specified with the job. If a job does not end after the specified amount of time, it will be aborted. A timeout is just like another error from the worker and can provoke a retry if specified.","title":"Timeout"},{"location":"/cozy-stack/jobs/#defaults","text":"By default, jobs are parameterized with a maximum of 3 tries with 1 minute timeout. These defaults may vary given the workload of the workers.","title":"Defaults"},{"location":"/cozy-stack/jobs/#jobs-api","text":"Example and description of the attributes of a io.cozy.jobs : { domain : me.cozy.tools , worker : sendmail , // worker type name options : { priority : 3, // priority from 1 to 100, higher number is higher priority timeout : 60, // timeout value in seconds max_exec_count : 3, // maximum number of time the job should be executed (including retries) }, state : running , // queued, running, errored queued_at : 2016-09-19T12:35:08Z , // time of the queuing started_at : 2016-09-19T12:35:08Z , // time of first execution error : // error message if any } Example and description of a job creation options \u2014 as you can see, the options are replicated in the io.cozy.jobs attributes: { priority : 3, // priority from 1 to 100 timeout : 60, // timeout value in seconds max_exec_count : 3, // maximum number of retry }","title":"Jobs API"},{"location":"/cozy-stack/jobs/#get-jobsjob-id","text":"Get a job informations given its ID.","title":"GET /jobs/:job-id"},{"location":"/cozy-stack/jobs/#request","text":"GET /jobs/123123 HTTP/1.1 Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/jobs/#response","text":"{ data : { type : io.cozy.jobs , id : 123123 , attributes : { domain : me.cozy.tools , worker : sendmail , options : { priority : 3, timeout : 60, max_exec_count : 3 }, state : running , queued_at : 2016-09-19T12:35:08Z , started_at : 2016-09-19T12:35:08Z , error : }, links : { self : /jobs/123123 } } }","title":"Response"},{"location":"/cozy-stack/jobs/#post-jobsqueueworker-type","text":"Enqueue programmatically a new job. This route requires a specific permission on the worker-type. A global permission on the global io.cozy.jobs doctype is not allowed.","title":"POST /jobs/queue/:worker-type"},{"location":"/cozy-stack/jobs/#request_1","text":"POST /jobs/queue/sendmail HTTP/1.1 Accept: application/vnd.api+json { data : { attributes : { options : { priority : 3, timeout : 60, max_exec_count : 3 }, arguments : {} // any json value used as arguments for the job } } }","title":"Request"},{"location":"/cozy-stack/jobs/#response_1","text":"{ data : { type : io.cozy.jobs , id : 123123 , attributes : { domain : me.cozy.tools , worker : sendmail , options : { priority : 3, timeout : 60, max_exec_count : 3 }, state : running , queued_at : 2016-09-19T12:35:08Z , started_at : 2016-09-19T12:35:08Z , error : }, links : { self : /jobs/123123 } } }","title":"Response"},{"location":"/cozy-stack/jobs/#permissions","text":"To use this endpoint, an application needs a permission on the type io.cozy.jobs for the verb POST . The is required to restrict its permission to specific worker(s), like this (a global permission on the doctype is not allowed): { permissions : { mail-from-the-user : { description : Required to send mails from the user to his/her friends , type : io.cozy.jobs , verbs : [ POST ], selector : worker , values : [ sendmail ] } } }","title":"Permissions"},{"location":"/cozy-stack/jobs/#get-jobsqueueworker-type","text":"List the jobs in the queue.","title":"GET /jobs/queue/:worker-type"},{"location":"/cozy-stack/jobs/#request_2","text":"GET /jobs/queue/sendmail HTTP/1.1 Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/jobs/#response_2","text":"{ data : [ { attributes : { domain : cozy.tools:8080 , options : null, queued_at : 2017-09-29T15:32:31.953878568+02:00 , started_at : 0001-01-01T00:00:00Z , state : queued , worker : log }, id : 77689bca9634b4fb08d6ca3d1643de5f , links : { self : /jobs/log/77689bca9634b4fb08d6ca3d1643de5f }, meta : { rev : 1-f823bcd2759103a5ad1a98f4bf083b36 }, type : io.cozy.jobs } ], meta : { count : 0 } }","title":"Response"},{"location":"/cozy-stack/jobs/#permissions_1","text":"To use this endpoint, an application needs a permission on the type io.cozy.jobs for the verb GET . In most cases, the application will restrict its permission to only one worker, like this: { permissions : { mail-from-the-user : { description : Required to know the number of jobs in the sendmail queues , type : io.cozy.jobs , verbs : [ GET ], selector : worker , values : [ sendmail ] } } }","title":"Permissions"},{"location":"/cozy-stack/jobs/#post-jobstriggers","text":"Add a trigger of the worker. See triggers descriptions to see the types of trigger and their arguments syntax. This route requires a specific permission on the worker type. A global permission on the global io.cozy.triggers doctype is not allowed. The debounce parameter can be used to limit the number of jobs created in a burst. It delays the creation of the job on the first input by the given time argument, and if the trigger has its condition matched again during this period, it won t create another job. It can be useful to combine it with the changes feed of couchdb with a last sequence number persisted by the worker, as it allows to have a nice diff between two executions of the worker.","title":"POST /jobs/triggers"},{"location":"/cozy-stack/jobs/#request_3","text":"POST /jobs/triggers HTTP/1.1 Accept: application/vnd.api+json { data : { attributes : { type : @event , arguments : io.cozy.invitations , debounce : 10m , worker : sendmail , worker_arguments : {}, options : { priority : 3, timeout : 60, max_exec_count : 3 } } } }","title":"Request"},{"location":"/cozy-stack/jobs/#response_3","text":"{ data : { type : io.cozy.triggers , id : 123123 , attributes : { type : @every , arguments : 30m10s , debounce : 10m , worker : sendmail , options : { priority : 3, timeout : 60, max_exec_count : 3 } }, links : { self : /jobs/triggers/123123 } } }","title":"Response"},{"location":"/cozy-stack/jobs/#permissions_2","text":"To use this endpoint, an application needs a permission on the type io.cozy.triggers for the verb POST . In most cases, the application will restrict its permission to only one worker, like this: { permissions : { mail-from-the-user : { description : Required to send regularly mails from the user to his/her friends , type : io.cozy.triggers , verbs : [ POST ], selector : worker , values : [ sendmail ] } } }","title":"Permissions"},{"location":"/cozy-stack/jobs/#get-jobstriggerstrigger-id","text":"Get a trigger informations given its ID.","title":"GET /jobs/triggers/:trigger-id"},{"location":"/cozy-stack/jobs/#request_4","text":"GET /jobs/triggers/123123 HTTP/1.1 Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/jobs/#response_4","text":"{ data : { type : io.cozy.triggers , id : 123123 , attributes : { type : @every , arguments : 30m10s , worker : sendmail , options : { priority : 3, timeout : 60, max_exec_count : 3 }, current_state : { status : done , last_success : 2017-11-20T13:31:09.01641731 , last_successful_job_id : abcde , last_execution : 2017-11-20T13:31:09.01641731 , last_executed_job_id : abcde , last_failure : 2017-11-20T13:31:09.01641731 , last_failed_job_id : abcde , last_error : error value , last_manual_execution : 2017-11-20T13:31:09.01641731 , last_manual_job_id : abcde } }, links : { self : /jobs/triggers/123123 } } }","title":"Response"},{"location":"/cozy-stack/jobs/#permissions_3","text":"To use this endpoint, an application needs a permission on the type io.cozy.triggers for the verb GET .","title":"Permissions"},{"location":"/cozy-stack/jobs/#get-jobstriggerstrigger-idstate","text":"Get the trigger current state, to give a big picture of the health of the trigger. last executed job status ( done , errored , queued or running ) last executed job that resulted in a successful executoin last executed job that resulted in an error last executed job from a manual execution (not executed by the trigger directly)","title":"GET /jobs/triggers/:trigger-id/state"},{"location":"/cozy-stack/jobs/#request_5","text":"GET /jobs/triggers/123123/state HTTP/1.1 Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/jobs/#response_5","text":"{ data : { type : io.cozy.jobs.state , id : 123123 , attributes : { status : done , last_success : 2017-11-20T13:31:09.01641731 , last_successful_job_id : abcde , last_execution : 2017-11-20T13:31:09.01641731 , last_executed_job_id : abcde , last_failure : 2017-11-20T13:31:09.01641731 , last_failed_job_id : abcde , last_error : error value , last_manual_execution : 2017-11-20T13:31:09.01641731 , last_manual_job_id : abcde } } }","title":"Response"},{"location":"/cozy-stack/jobs/#permissions_4","text":"To use this endpoint, an application needs a permission on the type io.cozy.triggers for the verb GET .","title":"Permissions"},{"location":"/cozy-stack/jobs/#get-jobstriggerstrigger-idjobs","text":"Get the jobs launched by the trigger with the specified ID. Query parameters: Limit : to specify the number of jobs to get out","title":"GET /jobs/triggers/:trigger-id/jobs"},{"location":"/cozy-stack/jobs/#request_6","text":"GET /jobs/triggers/123123/jobs?Limit=1 HTTP/1.1 Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/jobs/#response_6","text":"{ data : [ { type : io.cozy.jobs , id : 123123 , attributes : {}, links : { self : /jobs/123123 } } ] }","title":"Response"},{"location":"/cozy-stack/jobs/#post-jobstriggerstrigger-idlaunch","text":"Launch a trigger manually given its ID and return the created job.","title":"POST /jobs/triggers/:trigger-id/launch"},{"location":"/cozy-stack/jobs/#request_7","text":"POST /jobs/triggers/123123/launch HTTP/1.1 Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/jobs/#response_7","text":"{ data : { type : io.cozy.jobs , id : 123123 , attributes : { domain : me.cozy.tools , worker : sendmail , options : {}, state : running , queued_at : 2016-09-19T12:35:08Z , started_at : 2016-09-19T12:35:08Z , error : }, links : { self : /jobs/123123 } } }","title":"Response"},{"location":"/cozy-stack/jobs/#permissions_5","text":"To use this endpoint, an application needs a permission on the type io.cozy.triggers for the verb POST .","title":"Permissions"},{"location":"/cozy-stack/jobs/#delete-jobstriggerstrigger-id","text":"Delete a trigger given its ID.","title":"DELETE /jobs/triggers/:trigger-id"},{"location":"/cozy-stack/jobs/#request_8","text":"DELETE /jobs/triggers/123123 HTTP/1.1 Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/jobs/#permissions_6","text":"To use this endpoint, an application needs a permission on the type io.cozy.triggers for the verb DELETE .","title":"Permissions"},{"location":"/cozy-stack/jobs/#get-jobstriggers","text":"Get the list of triggers. Query parameters: Worker : to filter only triggers associated with a specific worker.","title":"GET /jobs/triggers"},{"location":"/cozy-stack/jobs/#request_9","text":"GET /jobs/triggers?Worker=konnector HTTP/1.1 Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/jobs/#response_8","text":"{ data : [ { type : io.cozy.triggers , id : 123123 , attributes : {}, links : { self : /jobs/triggers/123123 } } ] }","title":"Response"},{"location":"/cozy-stack/jobs/#permissions_7","text":"To use this endpoint, an application needs a permission on the type io.cozy.triggers for the verb GET . When used on a specific worker, the permission can be specified on the worker field.","title":"Permissions"},{"location":"/cozy-stack/jobs/#worker-pool","text":"The consuming side of the job queue is handled by a worker pool. On a monolithic cozy-stack, the worker pool has a configurable fixed size of workers. The default value is not yet determined. Each time a worker has finished a job, it check the queue and based on the priority and the queued date of the job, picks a new job to execute.","title":"Worker pool"},{"location":"/cozy-stack/jobs/#permissions_8","text":"In order to prevent jobs from leaking informations between applications, we may need to add filtering per applications: for instance one queue per applications. We should also have an explicit check on the permissions of the applications before launching a job scheduled by an application. For more information, refer to our permission document .","title":"Permissions"},{"location":"/cozy-stack/jobs/#multi-stack","text":"When some instances are served by several stacks, the scheduling and running of jobs can be distributed on the stacks. The synchronization is done via redis. For scheduling, there is one important key in redis: triggers . It s a sorted set. The members are the identifiants of the triggers (with the domain name), and the score are the timestamp of the next time the trigger should occur. During the short period of time where a trigger is processed, its key is moved to scheduling (another sorted set). So, even if a stack crash during processing a trigger, this trigger won t be lost. For @event triggers, we don t use the same mechanism. Each stack has all the triggers in memory and is responsible to trigger them for the events generated by the HTTP requests of their API. They also publish them on redis: this pub/sub is used for the realtime API.","title":"Multi-stack"},{"location":"/cozy-stack/konnectors/","text":"Table of contents Konnectors It is possible to manage konnectors applications from the stack. The source-code of the konnector is installed on the cozy and the user can manage its execution via our job system and the konnector worker . Install a konnector The manifest Field Description name the name to display on the home slug the default slug (it can be changed at install time) editor the editor s name to display on the cozy-bar of the app type the type of the konnector source ( node is the only supported for now) icon an icon for the home screenshots an array of path to the screenshots of the application category the category of the application short_description a short description of the application long_description a long description of the application source where the files of the app can be downloaded developer name and url for the developer ( {\"name\": \"Cozy\", \"url\": \"https://cozy.io\"} ) default_locale the locale used for the name and description fields locales translations of the name and description fields in other locales langs list of languages tags supported by the application version the current version number parameters any json object that will be passed to the konnector on execution in the COZY_PARAMETERS environment variable license the SPDX license identifier permissions a map of permissions needed by the app (see here for more details) POST /konnectors/:slug Install a konnector, ie download the files and put them in /konnectors/:slug in the virtual file system of the user, create an io.cozy.konnectors document, register the permissions, etc. This endpoint is asynchronous and returns a successful return as soon as the konnector installation has started, meaning we have successfully reached the manifest and started to fetch konnector source code. To make this endpoint synchronous, use the header Accept: text/event-stream . This will make a eventsource stream sending the manifest and returning when the konnector has been installed or failed. Status codes 202 Accepted, when the konnector installation has been accepted. 400 Bad-Request, when the manifest of the konnector could not be processed (for instance, it is not valid JSON). 404 Not Found, when the manifest or the source of the konnector is not reachable. 422 Unprocessable Entity, when the sent data is invalid (for example, the slug is invalid or the Source parameter is not a proper or supported url) Query-String Parameter Description Source URL from where the app can be downloaded (only for install) Request POST /konnectors/bank101?Source=git://github.com/cozy/cozy-bank101.git HTTP/1.1 Accept: application/vnd.api+json Response HTTP/1.1 202 Accepted Content-Type: application/vnd.api+json { data : [{ id : 4cfbd8be-8968-11e6-9708-ef55b7c20863 , type : io.cozy.konnectors , meta : { rev : 1-7a1f918147df94580c92b47275e4604a }, attributes : { name : bank101 , state : installing , slug : bank101 , ... }, links : { self : /konnectors/bank101 } }] } Note : it s possible to choose a git branch by passing it in the fragment like this: POST /konnectors/bank101-dev?Source=git://github.com/cozy/cozy-bank101.git%23dev HTTP/1.1 PUT /konnectors/:slug Update a konnector source code with the specified slug name. This endpoint is asynchronous and returns a successful return as soon as the konnector installation has started, meaning we have successfully reached the manifest and started to fetch konnector source code. To make this endpoint synchronous, use the header Accept: text/event-stream . This will make a eventsource stream sending the manifest and returning when the konnector has been updated or failed. Request PUT /konnectors/bank101 HTTP/1.1 Accept: application/vnd.api+json Response HTTP/1.1 202 Accepted Content-Type: application/vnd.api+json { data : [{ id : 4cfbd8be-8968-11e6-9708-ef55b7c20863 , type : io.cozy.konnectors , meta : { rev : 1-7a1f918147df94580c92b47275e4604a }, attributes : { name : bank101 , state : installing , slug : bank101 , ... }, links : { self : /konnectors/bank101 } }] } Status codes 202 Accepted, when the konnector installation has been accepted. 400 Bad-Request, when the manifest of the konnector could not be processed (for instance, it is not valid JSON). 404 Not Found, when the konnector with the specified slug was not found or when the manifest or the source of the konnector is not reachable. 422 Unprocessable Entity, when the sent data is invalid (for example, the slug is invalid or the Source parameter is not a proper or supported url) List installed konnectors GET /konnectors/ Request GET /konnectors/ HTTP/1.1 Accept: application/vnd.api+json Response HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : [{ id : 4cfbd8be-8968-11e6-9708-ef55b7c20863 , type : io.cozy.konnectors , meta : { rev : 1-7a1f918147df94580c92b47275e4604a }, attributes : { name : bank101 , state : installing , slug : bank101 , ... }, links : { self : /konnectors/bank101 } }] } Get informations about a konnector GET /konnectors/:slug Uninstall a konnector DELETE /apps/:slug Request DELETE /konnectors/bank101 HTTP/1.1 Response HTTP/1.1 204 No Content","title":"Konnectors"},{"location":"/cozy-stack/konnectors/#konnectors","text":"It is possible to manage konnectors applications from the stack. The source-code of the konnector is installed on the cozy and the user can manage its execution via our job system and the konnector worker .","title":"Konnectors"},{"location":"/cozy-stack/konnectors/#install-a-konnector","text":"","title":"Install a konnector"},{"location":"/cozy-stack/konnectors/#the-manifest","text":"Field Description name the name to display on the home slug the default slug (it can be changed at install time) editor the editor s name to display on the cozy-bar of the app type the type of the konnector source ( node is the only supported for now) icon an icon for the home screenshots an array of path to the screenshots of the application category the category of the application short_description a short description of the application long_description a long description of the application source where the files of the app can be downloaded developer name and url for the developer ( {\"name\": \"Cozy\", \"url\": \"https://cozy.io\"} ) default_locale the locale used for the name and description fields locales translations of the name and description fields in other locales langs list of languages tags supported by the application version the current version number parameters any json object that will be passed to the konnector on execution in the COZY_PARAMETERS environment variable license the SPDX license identifier permissions a map of permissions needed by the app (see here for more details)","title":"The manifest"},{"location":"/cozy-stack/konnectors/#post-konnectorsslug","text":"Install a konnector, ie download the files and put them in /konnectors/:slug in the virtual file system of the user, create an io.cozy.konnectors document, register the permissions, etc. This endpoint is asynchronous and returns a successful return as soon as the konnector installation has started, meaning we have successfully reached the manifest and started to fetch konnector source code. To make this endpoint synchronous, use the header Accept: text/event-stream . This will make a eventsource stream sending the manifest and returning when the konnector has been installed or failed.","title":"POST /konnectors/:slug"},{"location":"/cozy-stack/konnectors/#status-codes","text":"202 Accepted, when the konnector installation has been accepted. 400 Bad-Request, when the manifest of the konnector could not be processed (for instance, it is not valid JSON). 404 Not Found, when the manifest or the source of the konnector is not reachable. 422 Unprocessable Entity, when the sent data is invalid (for example, the slug is invalid or the Source parameter is not a proper or supported url)","title":"Status codes"},{"location":"/cozy-stack/konnectors/#query-string","text":"Parameter Description Source URL from where the app can be downloaded (only for install)","title":"Query-String"},{"location":"/cozy-stack/konnectors/#request","text":"POST /konnectors/bank101?Source=git://github.com/cozy/cozy-bank101.git HTTP/1.1 Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/konnectors/#response","text":"HTTP/1.1 202 Accepted Content-Type: application/vnd.api+json { data : [{ id : 4cfbd8be-8968-11e6-9708-ef55b7c20863 , type : io.cozy.konnectors , meta : { rev : 1-7a1f918147df94580c92b47275e4604a }, attributes : { name : bank101 , state : installing , slug : bank101 , ... }, links : { self : /konnectors/bank101 } }] } Note : it s possible to choose a git branch by passing it in the fragment like this: POST /konnectors/bank101-dev?Source=git://github.com/cozy/cozy-bank101.git%23dev HTTP/1.1","title":"Response"},{"location":"/cozy-stack/konnectors/#put-konnectorsslug","text":"Update a konnector source code with the specified slug name. This endpoint is asynchronous and returns a successful return as soon as the konnector installation has started, meaning we have successfully reached the manifest and started to fetch konnector source code. To make this endpoint synchronous, use the header Accept: text/event-stream . This will make a eventsource stream sending the manifest and returning when the konnector has been updated or failed.","title":"PUT /konnectors/:slug"},{"location":"/cozy-stack/konnectors/#request_1","text":"PUT /konnectors/bank101 HTTP/1.1 Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/konnectors/#response_1","text":"HTTP/1.1 202 Accepted Content-Type: application/vnd.api+json { data : [{ id : 4cfbd8be-8968-11e6-9708-ef55b7c20863 , type : io.cozy.konnectors , meta : { rev : 1-7a1f918147df94580c92b47275e4604a }, attributes : { name : bank101 , state : installing , slug : bank101 , ... }, links : { self : /konnectors/bank101 } }] }","title":"Response"},{"location":"/cozy-stack/konnectors/#status-codes_1","text":"202 Accepted, when the konnector installation has been accepted. 400 Bad-Request, when the manifest of the konnector could not be processed (for instance, it is not valid JSON). 404 Not Found, when the konnector with the specified slug was not found or when the manifest or the source of the konnector is not reachable. 422 Unprocessable Entity, when the sent data is invalid (for example, the slug is invalid or the Source parameter is not a proper or supported url)","title":"Status codes"},{"location":"/cozy-stack/konnectors/#list-installed-konnectors","text":"","title":"List installed konnectors"},{"location":"/cozy-stack/konnectors/#get-konnectors","text":"","title":"GET /konnectors/"},{"location":"/cozy-stack/konnectors/#request_2","text":"GET /konnectors/ HTTP/1.1 Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/konnectors/#response_2","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : [{ id : 4cfbd8be-8968-11e6-9708-ef55b7c20863 , type : io.cozy.konnectors , meta : { rev : 1-7a1f918147df94580c92b47275e4604a }, attributes : { name : bank101 , state : installing , slug : bank101 , ... }, links : { self : /konnectors/bank101 } }] }","title":"Response"},{"location":"/cozy-stack/konnectors/#get-informations-about-a-konnector","text":"","title":"Get informations about a konnector"},{"location":"/cozy-stack/konnectors/#get-konnectorsslug","text":"","title":"GET /konnectors/:slug"},{"location":"/cozy-stack/konnectors/#uninstall-a-konnector","text":"","title":"Uninstall a konnector"},{"location":"/cozy-stack/konnectors/#delete-appsslug","text":"","title":"DELETE /apps/:slug"},{"location":"/cozy-stack/konnectors/#request_3","text":"DELETE /konnectors/bank101 HTTP/1.1","title":"Request"},{"location":"/cozy-stack/konnectors/#response_3","text":"HTTP/1.1 204 No Content","title":"Response"},{"location":"/cozy-stack/workers/","text":"Table of contents Workers This page list all the currently available workers on the cozy-stack. It describes their input arguments object. See the jobs document to know more about the API context in which you can see how to use these arguments. log worker The log worker will just print in the log file the job sent to it. It can useful for debugging for example. push worker The push worker can be used to send push-notifications to a user s device. The options are: client_id : the ID of the oauth client to push a notification to. title : the title of the notification message : the content of the notification data : key-value string map for additional metadata (optional) priority : the notification priority: high or normal (optional) topic : the topic identifier of the notification (optional) sound : a sound associated with the notification (optional) Example { client_id : abcdef123123123 , title : My Notification , message : My notification content. , priority : high } Permissions To use this worker from a client-side application, you will need to ask the permission. It is done by adding this to the manifest: { permissions : { push-notification : { description : Required to send notifications , type : io.cozy.jobs , verbs : [ POST ], selector : worker , values : [ push ] } } } unzip worker The unzip worker can take a zip archive from the VFS, and will unzip the files inside it to a directory of the VFS. The options are: zip : the ID of the zip file destination : the ID of the directory where the files will be unzipped. Example { zip : 8737b5d6-51b6-11e7-9194-bf5b64b3bc9e , destination : 88750a84-51b6-11e7-ba90-4f0b1cb62b7b } Permissions To use this worker from a client-side application, you will need to ask the permission. It is done by adding this to the manifest: { permissions : { unzip-to-a-directory : { description : Required to unzip a file inside the cozy , type : io.cozy.jobs , verbs : [ POST ], selector : worker , values : [ unzip ] } } } sendmail worker The sendmail worker can be used to send mail from the stack. It implies that the stack has properly configured an access to an SMTP server. You can see an example of configuration in the cozy.example.yaml file at the root of this repository. sendmail options fields are the following: mode : string specifying the mode of the send: noreply to send a notification mail to the user from to send a mail from the user to : list of object {name, email} representing the addresses of the recipients. (should not be used in noreply mode) subject : string specifying the subject of the mail parts : list of part objects {type, body} listing representing the content parts of the type string of the content type: either text/html or text/plain body string of the actual body content of the part attachments : list of objects {filename, content} that represent the files attached to the email Examples // from mode sending mail from the user to a list of recipients { mode : from , to : [ { name : John Doe 1 , email : john1@doe }, { name : John Doe 2 , email : john2@doe } ], subject : Hey ! , parts : [ { type : text/html , body : h1 Hey ! /h1 }, { type : text/plain , body : Hey ! } ] } // noreply mode, sending a notification mail to the user { mode : noreply , subject : You've got a new file ! , parts : [ { type : text/html , body : h1 Hey ! /h1 }, { type : text/plain , body : Hey ! } ] } Permissions To use this worker from a client-side application, you will need to ask the permission. It is done by adding this to the manifest: { permissions : { mail-from-the-user : { description : Required to send mails from the user to his/her friends , type : io.cozy.jobs , verbs : [ POST ], selector : worker , values : [ sendmail ] } } } export The export worker can be used to generate allow the export of all data contained in the cozy. At the end of the export, a mail is sent to the user containing a link to access to its data. The progress of the export process can be followed with realtime events on the doctype io.cozy.exports . Its options are: parts_size : the size in bytes of the sizes index splitting done for multi-part download of files data max_age : the maximum age duration of the archive before it expires with_doctypes : list of string for a whitelist of doctypes to exports (exports all doctypes if empty) without_files : boolean to avoid exporting the index (preventing download file data) Example { parts_size : 52428800, max_age : 60000000000, // 1 minute with_doctypes : [ io.cozy.accounts ], // empty or null means all doctypes without_files : false } Permissions To use this worker from a client-side application, you will need to ask the permission. It is done by adding this to the manifest: { permissions : { mail-from-the-user : { description : Required to create a export of the user's data , type : io.cozy.jobs , verbs : [ POST ], selector : worker , values : [ export ] } } } share workers The stack have 3 workers to power the sharings (internal usage only): share-track , to update the io.cozy.shared database share-replicate , to start a replicator for most documents share-upload , to upload files Share-track The message is composed of 3 fields: the sharing ID, the rule index, and the doctype. The event is similar to a realtime event: a verb, a document, and optionaly the old version of this document. Share-replicate and share-upload The message is composed of a sharing ID and a count of the number of errors (i.e. the number of times this job was retried).","title":"Workers"},{"location":"/cozy-stack/workers/#workers","text":"This page list all the currently available workers on the cozy-stack. It describes their input arguments object. See the jobs document to know more about the API context in which you can see how to use these arguments.","title":"Workers"},{"location":"/cozy-stack/workers/#log-worker","text":"The log worker will just print in the log file the job sent to it. It can useful for debugging for example.","title":"log worker"},{"location":"/cozy-stack/workers/#push-worker","text":"The push worker can be used to send push-notifications to a user s device. The options are: client_id : the ID of the oauth client to push a notification to. title : the title of the notification message : the content of the notification data : key-value string map for additional metadata (optional) priority : the notification priority: high or normal (optional) topic : the topic identifier of the notification (optional) sound : a sound associated with the notification (optional)","title":"push worker"},{"location":"/cozy-stack/workers/#example","text":"{ client_id : abcdef123123123 , title : My Notification , message : My notification content. , priority : high }","title":"Example"},{"location":"/cozy-stack/workers/#permissions","text":"To use this worker from a client-side application, you will need to ask the permission. It is done by adding this to the manifest: { permissions : { push-notification : { description : Required to send notifications , type : io.cozy.jobs , verbs : [ POST ], selector : worker , values : [ push ] } } }","title":"Permissions"},{"location":"/cozy-stack/workers/#unzip-worker","text":"The unzip worker can take a zip archive from the VFS, and will unzip the files inside it to a directory of the VFS. The options are: zip : the ID of the zip file destination : the ID of the directory where the files will be unzipped.","title":"unzip worker"},{"location":"/cozy-stack/workers/#example_1","text":"{ zip : 8737b5d6-51b6-11e7-9194-bf5b64b3bc9e , destination : 88750a84-51b6-11e7-ba90-4f0b1cb62b7b }","title":"Example"},{"location":"/cozy-stack/workers/#permissions_1","text":"To use this worker from a client-side application, you will need to ask the permission. It is done by adding this to the manifest: { permissions : { unzip-to-a-directory : { description : Required to unzip a file inside the cozy , type : io.cozy.jobs , verbs : [ POST ], selector : worker , values : [ unzip ] } } }","title":"Permissions"},{"location":"/cozy-stack/workers/#sendmail-worker","text":"The sendmail worker can be used to send mail from the stack. It implies that the stack has properly configured an access to an SMTP server. You can see an example of configuration in the cozy.example.yaml file at the root of this repository. sendmail options fields are the following: mode : string specifying the mode of the send: noreply to send a notification mail to the user from to send a mail from the user to : list of object {name, email} representing the addresses of the recipients. (should not be used in noreply mode) subject : string specifying the subject of the mail parts : list of part objects {type, body} listing representing the content parts of the type string of the content type: either text/html or text/plain body string of the actual body content of the part attachments : list of objects {filename, content} that represent the files attached to the email","title":"sendmail worker"},{"location":"/cozy-stack/workers/#examples","text":"// from mode sending mail from the user to a list of recipients { mode : from , to : [ { name : John Doe 1 , email : john1@doe }, { name : John Doe 2 , email : john2@doe } ], subject : Hey ! , parts : [ { type : text/html , body : h1 Hey ! /h1 }, { type : text/plain , body : Hey ! } ] } // noreply mode, sending a notification mail to the user { mode : noreply , subject : You've got a new file ! , parts : [ { type : text/html , body : h1 Hey ! /h1 }, { type : text/plain , body : Hey ! } ] }","title":"Examples"},{"location":"/cozy-stack/workers/#permissions_2","text":"To use this worker from a client-side application, you will need to ask the permission. It is done by adding this to the manifest: { permissions : { mail-from-the-user : { description : Required to send mails from the user to his/her friends , type : io.cozy.jobs , verbs : [ POST ], selector : worker , values : [ sendmail ] } } }","title":"Permissions"},{"location":"/cozy-stack/workers/#export","text":"The export worker can be used to generate allow the export of all data contained in the cozy. At the end of the export, a mail is sent to the user containing a link to access to its data. The progress of the export process can be followed with realtime events on the doctype io.cozy.exports . Its options are: parts_size : the size in bytes of the sizes index splitting done for multi-part download of files data max_age : the maximum age duration of the archive before it expires with_doctypes : list of string for a whitelist of doctypes to exports (exports all doctypes if empty) without_files : boolean to avoid exporting the index (preventing download file data)","title":"export"},{"location":"/cozy-stack/workers/#example_2","text":"{ parts_size : 52428800, max_age : 60000000000, // 1 minute with_doctypes : [ io.cozy.accounts ], // empty or null means all doctypes without_files : false }","title":"Example"},{"location":"/cozy-stack/workers/#permissions_3","text":"To use this worker from a client-side application, you will need to ask the permission. It is done by adding this to the manifest: { permissions : { mail-from-the-user : { description : Required to create a export of the user's data , type : io.cozy.jobs , verbs : [ POST ], selector : worker , values : [ export ] } } }","title":"Permissions"},{"location":"/cozy-stack/workers/#share-workers","text":"The stack have 3 workers to power the sharings (internal usage only): share-track , to update the io.cozy.shared database share-replicate , to start a replicator for most documents share-upload , to upload files","title":"share workers"},{"location":"/cozy-stack/workers/#share-track","text":"The message is composed of 3 fields: the sharing ID, the rule index, and the doctype. The event is similar to a realtime event: a verb, a document, and optionaly the old version of this document.","title":"Share-track"},{"location":"/cozy-stack/workers/#share-replicate-and-share-upload","text":"The message is composed of a sharing ID and a count of the number of errors (i.e. the number of times this job was retried).","title":"Share-replicate and share-upload"},{"location":"/cozy-stack/move/","text":"Table of contents Move, export and import Export A Cozy s user can ask at any time to export a snapshot of all its data and metadata. This export takes place asynchronously and is separated in two parts: * a metadata tarball containing the in a JSON format all the doctypes * multi-part files tarballs containing the files (or a subpart of the files) The export process is part of a worker described in the workers section of the documentation. Endpoints described in this documentation require a permission on the io.cozy.exports doctype. POST /move/exports This endpoint can be used to create a new export job. Exports options fields are: parts_size (optional) (int): the size in bytes of a tarball files part. max_age (optional) (duration / nanosecs): the maximum age of the export data. with_doctypes (optional) (string array): the list of whitelisted exported doctypes without_files (optional) (boolean): whether or not the export contains the files index (if false, it is not possible to generate files tarball). Request POST /move/exports HTTP/1.1 Host: alice.cozy.tools Authorization: Bearer ... Content-Type: application/vnd.api+json { data : { attributes : { parts_size : 10240, with_doctypes : [], without_files : false, } } } GET /move/exports/:opaque-identifier This endpoint can be used to fetch the metadata of an export. Exports fields are: parts_size (int): the size in bytes of a tarball files part. parts_cursors (string array): the list of cursors to access to the different files parts. parts_length (int): number of parts with_doctypes (string array): the list of whitelisted exported doctypes (if empty of null, all doctypes are exported) without_files (boolean): whether or not the export contains the files index (if false, it is not possible to generate files tarball). state (string): the state of the export ( \"exporting\" / \"done\" / \"error\" ). created_at (string / time): the date of creation of the export expires_at (string / time): the date of expiration of the export total_size (int): the total size of the export metadata creation_duration (int): the amount of nanoseconds taken for the creation of the export error (string): an error string if the export is in an \"error\" state Request GET /move/exports/XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX HTTP/1.1 Host: alice.cozy.tools Authorization: Bearer ... Content-Type: application/vnd.api+json { data : { type : io.cozy.exports , id : 86dbb546ca49f0ed1ce0a1ff0d1b15e3 , meta : { rev : 2-XXX , }, attributes : { parts_size : 10240, parts_cursors : [ AAA , BBB , CCC ], with_doctypes : [], without_files : false, state : done , created_at : 2018-05-04T08:59:37.530693972+02:00 , expires_at : 2018-05-11T08:59:37.530693972+02:00 , total_size : 1123, creation_duration : 62978511, error : } } } GET /move/exports/data/:opaque-identifier?cursor=XXX This endpoint will download an archive containing the metadata and files of the user, as part of a multi-part download. The cursor given should be one of the defined in the export document parts_cursors . Only the first part of part of the data contains the metadata.","title":"/move - Move, export and import an instance"},{"location":"/cozy-stack/move/#move-export-and-import","text":"","title":"Move, export and import"},{"location":"/cozy-stack/move/#export","text":"A Cozy s user can ask at any time to export a snapshot of all its data and metadata. This export takes place asynchronously and is separated in two parts: * a metadata tarball containing the in a JSON format all the doctypes * multi-part files tarballs containing the files (or a subpart of the files) The export process is part of a worker described in the workers section of the documentation. Endpoints described in this documentation require a permission on the io.cozy.exports doctype.","title":"Export"},{"location":"/cozy-stack/move/#post-moveexports","text":"This endpoint can be used to create a new export job. Exports options fields are: parts_size (optional) (int): the size in bytes of a tarball files part. max_age (optional) (duration / nanosecs): the maximum age of the export data. with_doctypes (optional) (string array): the list of whitelisted exported doctypes without_files (optional) (boolean): whether or not the export contains the files index (if false, it is not possible to generate files tarball).","title":"POST /move/exports"},{"location":"/cozy-stack/move/#request","text":"POST /move/exports HTTP/1.1 Host: alice.cozy.tools Authorization: Bearer ... Content-Type: application/vnd.api+json { data : { attributes : { parts_size : 10240, with_doctypes : [], without_files : false, } } }","title":"Request"},{"location":"/cozy-stack/move/#get-moveexportsopaque-identifier","text":"This endpoint can be used to fetch the metadata of an export. Exports fields are: parts_size (int): the size in bytes of a tarball files part. parts_cursors (string array): the list of cursors to access to the different files parts. parts_length (int): number of parts with_doctypes (string array): the list of whitelisted exported doctypes (if empty of null, all doctypes are exported) without_files (boolean): whether or not the export contains the files index (if false, it is not possible to generate files tarball). state (string): the state of the export ( \"exporting\" / \"done\" / \"error\" ). created_at (string / time): the date of creation of the export expires_at (string / time): the date of expiration of the export total_size (int): the total size of the export metadata creation_duration (int): the amount of nanoseconds taken for the creation of the export error (string): an error string if the export is in an \"error\" state","title":"GET /move/exports/:opaque-identifier"},{"location":"/cozy-stack/move/#request_1","text":"GET /move/exports/XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX HTTP/1.1 Host: alice.cozy.tools Authorization: Bearer ... Content-Type: application/vnd.api+json { data : { type : io.cozy.exports , id : 86dbb546ca49f0ed1ce0a1ff0d1b15e3 , meta : { rev : 2-XXX , }, attributes : { parts_size : 10240, parts_cursors : [ AAA , BBB , CCC ], with_doctypes : [], without_files : false, state : done , created_at : 2018-05-04T08:59:37.530693972+02:00 , expires_at : 2018-05-11T08:59:37.530693972+02:00 , total_size : 1123, creation_duration : 62978511, error : } } }","title":"Request"},{"location":"/cozy-stack/move/#get-moveexportsdataopaque-identifiercursorxxx","text":"This endpoint will download an archive containing the metadata and files of the user, as part of a multi-part download. The cursor given should be one of the defined in the export document parts_cursors . Only the first part of part of the data contains the metadata.","title":"GET /move/exports/data/:opaque-identifier?cursor=XXX"},{"location":"/cozy-stack/notifications/","text":"Table of contents Notifications Cozy applications can send notifications to the user, in order to alert or notify for services message or state change that could be of interest to the user, in an asynchronous manner. These notifications are part of a Notification Center where the user can configure the behavior of these notifications and the channel in which they are sent. Declare application s notifications Each application have to declare in its manifest the notifications it needs to send. The notifications fields of the manifest can be used to define all these notifications, with the following properties: collapsible (boolean): defines a notification category for which only the last value is of interest to the user. For instance, a account-balance quota for a user s bank account: such notification is only useful as its last value. stateful (boolean): defines a notification storing a piece of state: for each new notification, the stack will check that the last sent notification has a different state. multiple (boolean): specify the possibility for a notification to have different sub-categories, defined by a programmable/dynamic identifier. collapsible and stateful properties are inherited for each sub- categories. default_priority : default priority to use, with values high or normal . This is propagated to the underlying mobile notifications system. templates : a link list to templates file contained in the application folder that can be used to write the content of the notification, depending on the communication channel. In this documentation, we take the example of an application with the following notification: { notifications : { account-balance : { description : Alert the user when its account balance is negative , collapsible : true, // only interested in the last value of the notification multiple : true, // require sub-categories for each account stateful : true, // piece of state to distinguish notifications default_priority : high , // high priority for this notification templates : { mail : file:./notifications/account-balance-mail.tpl } } } } Creating a notification POST /notifications This endpoint can be used to push a new notification to the user. Notifications fields are: category (string): name of the notification category category_id (string): category name if the category is multiple title (string): title of the notification (optionnal) message (string): message of of the notification (optionnal) priority (string): priority of the notification ( high or normal ), sent to the underlying channel to prioritize the notification state (string): state of the notification, used for stateful notification categories, to distinguish notifications preferred_channels (array of string): to select a list of preferred channels for this notification: either \"mobile\" or \"mail\" . The stack may chose another channels. data (map): key/value map used to create the notification from its template, or sent in the notification payload for mobiles Request POST /notifications HTTP/1.1 Host: alice.cozy.tools Authorization: Bearer ... Content-Type: application/vnd.api+json { data : { attributes : { category : account-balance , category_id : my-bank , title : Your account balance is not OK , message : Warning: we have detected a negative balance in your my-bank , priority : high , state : -1 , preferred_channels : [ mobile ], data : { key1 : value1 , key2 : value2 } } } } Response HTTP/1.1 201 Created Content-Type: application/vnd.api+json { data : { type : io.cozy.notifications , id : c57a548c-7602-11e7-933b-6f27603d27da , meta : { rev : 1-1f2903f9a867 }, attributes : { source_id : cozy/app/bank/account-balance/my-bank , originator : app , slug : bank , category : account-balance , category_id : my-bank , title : Your account balance is not OK , message : Warning: we have detected a negative balance in your my-bank , priority : high , state : -1 , data : { key1 : value1 , key2 : value2 } } } }","title":"/notifications - Notifications"},{"location":"/cozy-stack/notifications/#notifications","text":"Cozy applications can send notifications to the user, in order to alert or notify for services message or state change that could be of interest to the user, in an asynchronous manner. These notifications are part of a Notification Center where the user can configure the behavior of these notifications and the channel in which they are sent.","title":"Notifications"},{"location":"/cozy-stack/notifications/#declare-applications-notifications","text":"Each application have to declare in its manifest the notifications it needs to send. The notifications fields of the manifest can be used to define all these notifications, with the following properties: collapsible (boolean): defines a notification category for which only the last value is of interest to the user. For instance, a account-balance quota for a user s bank account: such notification is only useful as its last value. stateful (boolean): defines a notification storing a piece of state: for each new notification, the stack will check that the last sent notification has a different state. multiple (boolean): specify the possibility for a notification to have different sub-categories, defined by a programmable/dynamic identifier. collapsible and stateful properties are inherited for each sub- categories. default_priority : default priority to use, with values high or normal . This is propagated to the underlying mobile notifications system. templates : a link list to templates file contained in the application folder that can be used to write the content of the notification, depending on the communication channel. In this documentation, we take the example of an application with the following notification: { notifications : { account-balance : { description : Alert the user when its account balance is negative , collapsible : true, // only interested in the last value of the notification multiple : true, // require sub-categories for each account stateful : true, // piece of state to distinguish notifications default_priority : high , // high priority for this notification templates : { mail : file:./notifications/account-balance-mail.tpl } } } }","title":"Declare application's notifications"},{"location":"/cozy-stack/notifications/#creating-a-notification","text":"","title":"Creating a notification"},{"location":"/cozy-stack/notifications/#post-notifications","text":"This endpoint can be used to push a new notification to the user. Notifications fields are: category (string): name of the notification category category_id (string): category name if the category is multiple title (string): title of the notification (optionnal) message (string): message of of the notification (optionnal) priority (string): priority of the notification ( high or normal ), sent to the underlying channel to prioritize the notification state (string): state of the notification, used for stateful notification categories, to distinguish notifications preferred_channels (array of string): to select a list of preferred channels for this notification: either \"mobile\" or \"mail\" . The stack may chose another channels. data (map): key/value map used to create the notification from its template, or sent in the notification payload for mobiles","title":"POST /notifications"},{"location":"/cozy-stack/notifications/#request","text":"POST /notifications HTTP/1.1 Host: alice.cozy.tools Authorization: Bearer ... Content-Type: application/vnd.api+json { data : { attributes : { category : account-balance , category_id : my-bank , title : Your account balance is not OK , message : Warning: we have detected a negative balance in your my-bank , priority : high , state : -1 , preferred_channels : [ mobile ], data : { key1 : value1 , key2 : value2 } } } }","title":"Request"},{"location":"/cozy-stack/notifications/#response","text":"HTTP/1.1 201 Created Content-Type: application/vnd.api+json { data : { type : io.cozy.notifications , id : c57a548c-7602-11e7-933b-6f27603d27da , meta : { rev : 1-1f2903f9a867 }, attributes : { source_id : cozy/app/bank/account-balance/my-bank , originator : app , slug : bank , category : account-balance , category_id : my-bank , title : Your account balance is not OK , message : Warning: we have detected a negative balance in your my-bank , priority : high , state : -1 , data : { key1 : value1 , key2 : value2 } } } }","title":"Response"},{"location":"/cozy-stack/permissions/","text":"Table of contents Permissions When the permissions are used? The permissions are used when a request is made to cozy stack. It allows to let the owner of the cozy instance controls the access to her data, files and actions on them. The permissions are given in several contexts. Let s see them! Client-side apps When the user installs a new client-side app, she is asked to accept an initial set of permissions for this app. This set of permissions is described in the manifest of the app. Later, the application can gain more permissions via the intents and optional permissions. See below for more details. When the authentified user access a client-side app, the app receives a token from the stack that can be used in later requests to the stack as a proof of the permissions it owns. External apps via OAuth2 An external application can ask for permissions via the OAuth2 dance, and use them later with the access token. The permissions are in the scope parameter. Sharing with other users The owner of a cozy instance can share some documents and files with other users. It can be done in two ways: If the other user also has a cozy, it can be a cozy-to-cozy sharing. Else, the owner can give to him a link with a code. What is a permission? A permission gives the right for a request having it to do something on the stack. It is defined by four components. Type type is the attribute used in JSON-API or the docType for the Data System. It is the only mandatory component. If just the type is specified, it gives access to all the operations on this type . For example, a permission on type io.cozy.contacts gives the right to create, read, update and delete any contact, and to fetch all the contacts. A permission on type io.cozy.files allow to access and modify any file or directory. Some known types: io.cozy.files , for files and folder in the VFS io.cozy.apps , for apps io.cozy.settings , for the settings io.cozy.jobs and io.cozy.triggers , for jobs io.cozy.oauth.clients , to list and revoke OAuth 2 clients Verbs It says which HTTP verbs can be used for requests to the cozy-stack. GET will give read-only access, DELETE can be used for deletions, etc. Verbs should be declared in a list, like [\"GET\", \"POST\", \"DELETE\"] , and use [\"ALL\"] as a shortcut for [\"GET\", \"POST\", \"PUT\", \"PATCH\", \"DELETE\"] (it is the default). Note : HEAD is implicitely implied when GET is allowed. OPTIONS for Cross-Origin Resources Sharing is always allowed, the stack does not have the informations about the permission when it answers the request. Values It s possible to restrict the permissions to only some documents of a docType, or to just some files and folders. You can give a list of ids in values . Note : a permission for a folder also gives permissions with same verbs for files and folders inside it. Selector By default, the values are checked with the id . But it s possible to use a selector to filter on another field . In particular, it can be used for sharing. A user may share a calendar and all the events inside it. It will be done with two permissions. The first one is for the calendar: { type : io.cozy.calendars , verbs : [ GET ], values : [ 1355812c-d41e-11e6-8467-53be4648e3ad ] } And the other is for the events inside the calendar: { type : io.cozy.events , verbs : [ GET ], selector : calendar-id , values : [ 1355812c-d41e-11e6-8467-53be4648e3ad ] } What format for a permission? JSON The prefered format for permissions is JSON. Each permission is a map with the type , verbs , values and selector see above, plus a description that can be used to give more informations to the user. Only the type field is mandatory. In the manifest, the permissions are regrouped in a map. The key is not very relevant, it s just here for localization. The same key is used in the locales field to identify the permission. Example: { permissions : { contacts : { description : Required for autocompletion on @name , type : io.cozy.contacts , verbs : [ GET ] }, images : { description : Required for the background , type : io.cozy.files , verbs : [ GET , POST ], values : [ io.cozy.files.music-dir ] }, mail : { description : Required to send a congratulations email to your friends , type : io.cozy.jobs , selector : worker , values : [ sendmail ] } } } Inline OAuth2 as a scope parameter for defining the permissions given to the application. But it s only a string, not a JSON. In that case, we use a space delimited list of permissions, each permission is written compactly with : between the components. Example: io.cozy.contacts io.cozy.files:GET:io.cozy.files.music-dir io.cozy.jobs:POST:sendmail:worker Note : the verbs component can t be omitted when the values and selector are used. Inspiration Access control on other similar platforms Routes GET /permissions/self List the permissions for a given token Request GET /permissions/self HTTP/1.1 Host: cozy.example.net Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ Accept: application/vnd.api+json Response HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { type : io.cozy.permissions , id : 5a9c1844-d427-11e6-ab36-2b684d437b0d , attributes : { type : app , source_id : io.cozy.apps/my-awesome-game , permissions : { contacts : { description : Required for autocompletion on @name , type : io.cozy.contacts , verbs : [ GET ] }, images : { description : Required for the background , type : io.cozy.files , verbs : [ GET ], values : [ io.cozy.files.music-dir ] }, mail : { description : Required to send a congratulations email to your friends , type : io.cozy.jobs , selector : worker , values : [ sendmail ] } } } } } POST /permissions Create a new set of permissions. It can also associates one or more codes to it, via the codes parameter in the query string. These codes can then be sent to other people as a way to give these permissions (sharing by links). The parameter is comma separed list of values. The role of these values is to identify the codes if you want to revoke some of them later. A ttl parameter can also be given to make the codes expires after a delay ( bigduration format ). Note : it is only possible to create a strict subset of the permissions associated to the sent token. Request POST /permissions?codes=bob,jane ttl=1D HTTP/1.1 Host: cozy.example.net Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : { type : io.cozy.permissions , attributes : { source_id : io.cozy.apps/my-awesome-game , permissions : { images : { type : io.cozy.files , verbs : [ GET ], values : [ io.cozy.files.music-dir ] } } } } } Response HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { id : a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 , type : io.cozy.permissions , attributes : { type : share , source_id : io.cozy.apps/my-awesome-game , codes : { bob : yuot7NaiaeGugh8T , jane : Yohyoo8BHahh1lie }, expires_at : 1483951978, permissions : { images : { type : io.cozy.files , verbs : [ GET ], values : [ io.cozy.files.music-dir ] } } } } } GET /permissions/:id Return the informations about a set of permissions Request GET /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 HTTP/1.1 Host: cozy.example.net Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ Accept: application/vnd.api+json Response HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { id : a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 , type : io.cozy.permissions , attributes : { type : share , source_id : io.cozy.apps/my-awesome-game , codes : { bob : yuot7NaiaeGugh8T , jane : Yohyoo8BHahh1lie }, expires_at : 1483951978, permissions : { images : { type : io.cozy.files , verbs : [ GET ], values : [ io.cozy.files.music-dir ] } } } } } PATCH /permissions/:id Add permissions in this permissions set. It can be used in inter-apps context as a way to give another app the permission for some data. For example, the contact application can send a pick a photo intent to the photos application with its permission id, and the photos app can then let the user choose a photo and give the contacts application the permissions to use it. It can also be used to add or remove codes. Request to add / remove codes PATCH /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 HTTP/1.1 Host: cozy.example.net Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : { id : a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 , type : io.cozy.permissions , attributes : { codes : { jane : Yohyoo8BHahh1lie } } } } Request to add permissions PATCH /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 HTTP/1.1 Host: cozy.example.net Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : { id : a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 , type : io.cozy.permissions , permissions : { add-this : { type : io.cozy.files , verbs : [ GET ], values : [ some-picture-id ] } } } } Request to remove permissions PATCH /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 HTTP/1.1 Host: cozy.example.net Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : { id : a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 , type : io.cozy.permissions , permissions : { remove-this : {} } } } Reponse HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { id : a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 , type : io.cozy.permissions , attributes : { type : share , source_id : io.cozy.apps/my-awesome-game , codes : { bob : yuot7NaiaeGugh8T }, expires_at : 1483951978, permissions : { images : { type : io.cozy.files , verbs : [ GET ], values : [ io.cozy.files.music-dir ] } } } } } DELETE /permissions/:id Delete a set of permissions. For example, some permissions were used by a user to share a photo album with her friends, and then she changed her mind and cancel the sharing. Request DELETE /permissions/fa11561c-d645-11e6-83df-cbf577804d55 HTTP/1.1 Host: cozy.example.net Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ Reponse HTTP/1.1 204 No Content POST /permissions/exists List permissions for some documents Request POST /permissions/exists HTTP/1.1 Host: cozy.example.net Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : [ { type : io.cozy.files , id : 94375086-e2e2-11e6-81b9-5bc0b9dd4aa4 } { type : io.cozy.files , id : 4cfbd8be-8968-11e6-9708-ef55b7c20863 } { type : io.cozy.files , id : a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 } { type : io.cozy.files , id : 94375086-e2e2-11e6-81b9-5bc0b9dd4aa4 } ] } Reponse HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : [ { type : io.cozy.files , id : 94375086-e2e2-11e6-81b9-5bc0b9dd4aa4 , verbs :[ GET ] } { type : io.cozy.files , id : a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 , verbs :[ GET , POST ] } ] } PATCH /permissions/apps/:slug Add permissions or remove permissions to the web application with specified slug. It behaves like the PATCH /permissions/:id route. See this route for more examples. PATCH /permissions/konnectors/:slug Add permissions or remove permissions to the konnector with specified slug. It behaves like the PATCH /permissions/:id route. See this route for more examples. GET /permissions/doctype/:doctype/shared-by-link List permissions for a doctype that are used for a share by links Request GET /permissions/doctype/io.cozy.events/shared-by-link HTTP/1.1 Host: cozy.example.net Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ Content-Type: application/vnd.api+json Accept: application/vnd.api+json Reponse HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : [ { type : io.cozy.permissions , id : c47f82396d09bfcd270343c5855b30a0 , attributes : { type : share , permissions : { rule0 : { type : io.cozy.events , verbs : [ PATCH , DELETE ], values : [ c47f82396d09bfcd270343c5855b0eea ] } }, codes : { bob : secret } }, meta : { rev : 1-d46b6358683b80c8d59fc55d6de54127 }, links : { self : /permissions/c47f82396d09bfcd270343c5855b30a0 } }, { type : io.cozy.permissions , id : c47f82396d09bfcd270343c5855b351a , attributes : { type : share , permissions : { rule0 : { type : io.cozy.events , verbs : [ GET ], values : [ c47f82396d09bfcd270343c5855b169b ] } }, codes : { bob : secret } }, meta : { rev : 1-920af658575a56e9e84685f1b09e5c23 }, links : { self : /permissions/c47f82396d09bfcd270343c5855b351a } } ] } Permissions required : GET on the whole doctype","title":"/permissions - Permissions"},{"location":"/cozy-stack/permissions/#permissions","text":"","title":"Permissions"},{"location":"/cozy-stack/permissions/#when-the-permissions-are-used","text":"The permissions are used when a request is made to cozy stack. It allows to let the owner of the cozy instance controls the access to her data, files and actions on them. The permissions are given in several contexts. Let s see them!","title":"When the permissions are used?"},{"location":"/cozy-stack/permissions/#client-side-apps","text":"When the user installs a new client-side app, she is asked to accept an initial set of permissions for this app. This set of permissions is described in the manifest of the app. Later, the application can gain more permissions via the intents and optional permissions. See below for more details. When the authentified user access a client-side app, the app receives a token from the stack that can be used in later requests to the stack as a proof of the permissions it owns.","title":"Client-side apps"},{"location":"/cozy-stack/permissions/#external-apps-via-oauth2","text":"An external application can ask for permissions via the OAuth2 dance, and use them later with the access token. The permissions are in the scope parameter.","title":"External apps via OAuth2"},{"location":"/cozy-stack/permissions/#sharing-with-other-users","text":"The owner of a cozy instance can share some documents and files with other users. It can be done in two ways: If the other user also has a cozy, it can be a cozy-to-cozy sharing. Else, the owner can give to him a link with a code.","title":"Sharing with other users"},{"location":"/cozy-stack/permissions/#what-is-a-permission","text":"A permission gives the right for a request having it to do something on the stack. It is defined by four components.","title":"What is a permission?"},{"location":"/cozy-stack/permissions/#type","text":"type is the attribute used in JSON-API or the docType for the Data System. It is the only mandatory component. If just the type is specified, it gives access to all the operations on this type . For example, a permission on type io.cozy.contacts gives the right to create, read, update and delete any contact, and to fetch all the contacts. A permission on type io.cozy.files allow to access and modify any file or directory. Some known types: io.cozy.files , for files and folder in the VFS io.cozy.apps , for apps io.cozy.settings , for the settings io.cozy.jobs and io.cozy.triggers , for jobs io.cozy.oauth.clients , to list and revoke OAuth 2 clients","title":"Type"},{"location":"/cozy-stack/permissions/#verbs","text":"It says which HTTP verbs can be used for requests to the cozy-stack. GET will give read-only access, DELETE can be used for deletions, etc. Verbs should be declared in a list, like [\"GET\", \"POST\", \"DELETE\"] , and use [\"ALL\"] as a shortcut for [\"GET\", \"POST\", \"PUT\", \"PATCH\", \"DELETE\"] (it is the default). Note : HEAD is implicitely implied when GET is allowed. OPTIONS for Cross-Origin Resources Sharing is always allowed, the stack does not have the informations about the permission when it answers the request.","title":"Verbs"},{"location":"/cozy-stack/permissions/#values","text":"It s possible to restrict the permissions to only some documents of a docType, or to just some files and folders. You can give a list of ids in values . Note : a permission for a folder also gives permissions with same verbs for files and folders inside it.","title":"Values"},{"location":"/cozy-stack/permissions/#selector","text":"By default, the values are checked with the id . But it s possible to use a selector to filter on another field . In particular, it can be used for sharing. A user may share a calendar and all the events inside it. It will be done with two permissions. The first one is for the calendar: { type : io.cozy.calendars , verbs : [ GET ], values : [ 1355812c-d41e-11e6-8467-53be4648e3ad ] } And the other is for the events inside the calendar: { type : io.cozy.events , verbs : [ GET ], selector : calendar-id , values : [ 1355812c-d41e-11e6-8467-53be4648e3ad ] }","title":"Selector"},{"location":"/cozy-stack/permissions/#what-format-for-a-permission","text":"","title":"What format for a permission?"},{"location":"/cozy-stack/permissions/#json","text":"The prefered format for permissions is JSON. Each permission is a map with the type , verbs , values and selector see above, plus a description that can be used to give more informations to the user. Only the type field is mandatory. In the manifest, the permissions are regrouped in a map. The key is not very relevant, it s just here for localization. The same key is used in the locales field to identify the permission. Example: { permissions : { contacts : { description : Required for autocompletion on @name , type : io.cozy.contacts , verbs : [ GET ] }, images : { description : Required for the background , type : io.cozy.files , verbs : [ GET , POST ], values : [ io.cozy.files.music-dir ] }, mail : { description : Required to send a congratulations email to your friends , type : io.cozy.jobs , selector : worker , values : [ sendmail ] } } }","title":"JSON"},{"location":"/cozy-stack/permissions/#inline","text":"OAuth2 as a scope parameter for defining the permissions given to the application. But it s only a string, not a JSON. In that case, we use a space delimited list of permissions, each permission is written compactly with : between the components. Example: io.cozy.contacts io.cozy.files:GET:io.cozy.files.music-dir io.cozy.jobs:POST:sendmail:worker Note : the verbs component can t be omitted when the values and selector are used.","title":"Inline"},{"location":"/cozy-stack/permissions/#inspiration","text":"Access control on other similar platforms","title":"Inspiration"},{"location":"/cozy-stack/permissions/#routes","text":"","title":"Routes"},{"location":"/cozy-stack/permissions/#get-permissionsself","text":"List the permissions for a given token","title":"GET /permissions/self"},{"location":"/cozy-stack/permissions/#request","text":"GET /permissions/self HTTP/1.1 Host: cozy.example.net Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/permissions/#response","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { type : io.cozy.permissions , id : 5a9c1844-d427-11e6-ab36-2b684d437b0d , attributes : { type : app , source_id : io.cozy.apps/my-awesome-game , permissions : { contacts : { description : Required for autocompletion on @name , type : io.cozy.contacts , verbs : [ GET ] }, images : { description : Required for the background , type : io.cozy.files , verbs : [ GET ], values : [ io.cozy.files.music-dir ] }, mail : { description : Required to send a congratulations email to your friends , type : io.cozy.jobs , selector : worker , values : [ sendmail ] } } } } }","title":"Response"},{"location":"/cozy-stack/permissions/#post-permissions","text":"Create a new set of permissions. It can also associates one or more codes to it, via the codes parameter in the query string. These codes can then be sent to other people as a way to give these permissions (sharing by links). The parameter is comma separed list of values. The role of these values is to identify the codes if you want to revoke some of them later. A ttl parameter can also be given to make the codes expires after a delay ( bigduration format ). Note : it is only possible to create a strict subset of the permissions associated to the sent token.","title":"POST /permissions"},{"location":"/cozy-stack/permissions/#request_1","text":"POST /permissions?codes=bob,jane ttl=1D HTTP/1.1 Host: cozy.example.net Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : { type : io.cozy.permissions , attributes : { source_id : io.cozy.apps/my-awesome-game , permissions : { images : { type : io.cozy.files , verbs : [ GET ], values : [ io.cozy.files.music-dir ] } } } } }","title":"Request"},{"location":"/cozy-stack/permissions/#response_1","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { id : a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 , type : io.cozy.permissions , attributes : { type : share , source_id : io.cozy.apps/my-awesome-game , codes : { bob : yuot7NaiaeGugh8T , jane : Yohyoo8BHahh1lie }, expires_at : 1483951978, permissions : { images : { type : io.cozy.files , verbs : [ GET ], values : [ io.cozy.files.music-dir ] } } } } }","title":"Response"},{"location":"/cozy-stack/permissions/#get-permissionsid","text":"Return the informations about a set of permissions","title":"GET /permissions/:id"},{"location":"/cozy-stack/permissions/#request_2","text":"GET /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 HTTP/1.1 Host: cozy.example.net Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/permissions/#response_2","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { id : a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 , type : io.cozy.permissions , attributes : { type : share , source_id : io.cozy.apps/my-awesome-game , codes : { bob : yuot7NaiaeGugh8T , jane : Yohyoo8BHahh1lie }, expires_at : 1483951978, permissions : { images : { type : io.cozy.files , verbs : [ GET ], values : [ io.cozy.files.music-dir ] } } } } }","title":"Response"},{"location":"/cozy-stack/permissions/#patch-permissionsid","text":"Add permissions in this permissions set. It can be used in inter-apps context as a way to give another app the permission for some data. For example, the contact application can send a pick a photo intent to the photos application with its permission id, and the photos app can then let the user choose a photo and give the contacts application the permissions to use it. It can also be used to add or remove codes.","title":"PATCH /permissions/:id"},{"location":"/cozy-stack/permissions/#request-to-add-remove-codes","text":"PATCH /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 HTTP/1.1 Host: cozy.example.net Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : { id : a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 , type : io.cozy.permissions , attributes : { codes : { jane : Yohyoo8BHahh1lie } } } }","title":"Request to add / remove codes"},{"location":"/cozy-stack/permissions/#request-to-add-permissions","text":"PATCH /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 HTTP/1.1 Host: cozy.example.net Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : { id : a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 , type : io.cozy.permissions , permissions : { add-this : { type : io.cozy.files , verbs : [ GET ], values : [ some-picture-id ] } } } }","title":"Request to add permissions"},{"location":"/cozy-stack/permissions/#request-to-remove-permissions","text":"PATCH /permissions/a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 HTTP/1.1 Host: cozy.example.net Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : { id : a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 , type : io.cozy.permissions , permissions : { remove-this : {} } } }","title":"Request to remove permissions"},{"location":"/cozy-stack/permissions/#reponse","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { id : a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 , type : io.cozy.permissions , attributes : { type : share , source_id : io.cozy.apps/my-awesome-game , codes : { bob : yuot7NaiaeGugh8T }, expires_at : 1483951978, permissions : { images : { type : io.cozy.files , verbs : [ GET ], values : [ io.cozy.files.music-dir ] } } } } }","title":"Reponse"},{"location":"/cozy-stack/permissions/#delete-permissionsid","text":"Delete a set of permissions. For example, some permissions were used by a user to share a photo album with her friends, and then she changed her mind and cancel the sharing.","title":"DELETE /permissions/:id"},{"location":"/cozy-stack/permissions/#request_3","text":"DELETE /permissions/fa11561c-d645-11e6-83df-cbf577804d55 HTTP/1.1 Host: cozy.example.net Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ","title":"Request"},{"location":"/cozy-stack/permissions/#reponse_1","text":"HTTP/1.1 204 No Content","title":"Reponse"},{"location":"/cozy-stack/permissions/#post-permissionsexists","text":"List permissions for some documents","title":"POST /permissions/exists"},{"location":"/cozy-stack/permissions/#request_4","text":"POST /permissions/exists HTTP/1.1 Host: cozy.example.net Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ Content-Type: application/vnd.api+json Accept: application/vnd.api+json { data : [ { type : io.cozy.files , id : 94375086-e2e2-11e6-81b9-5bc0b9dd4aa4 } { type : io.cozy.files , id : 4cfbd8be-8968-11e6-9708-ef55b7c20863 } { type : io.cozy.files , id : a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 } { type : io.cozy.files , id : 94375086-e2e2-11e6-81b9-5bc0b9dd4aa4 } ] }","title":"Request"},{"location":"/cozy-stack/permissions/#reponse_2","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : [ { type : io.cozy.files , id : 94375086-e2e2-11e6-81b9-5bc0b9dd4aa4 , verbs :[ GET ] } { type : io.cozy.files , id : a340d5e0-d647-11e6-b66c-5fc9ce1e17c6 , verbs :[ GET , POST ] } ] }","title":"Reponse"},{"location":"/cozy-stack/permissions/#patch-permissionsappsslug","text":"Add permissions or remove permissions to the web application with specified slug. It behaves like the PATCH /permissions/:id route. See this route for more examples.","title":"PATCH /permissions/apps/:slug"},{"location":"/cozy-stack/permissions/#patch-permissionskonnectorsslug","text":"Add permissions or remove permissions to the konnector with specified slug. It behaves like the PATCH /permissions/:id route. See this route for more examples.","title":"PATCH /permissions/konnectors/:slug"},{"location":"/cozy-stack/permissions/#get-permissionsdoctypedoctypeshared-by-link","text":"List permissions for a doctype that are used for a share by links","title":"GET /permissions/doctype/:doctype/shared-by-link"},{"location":"/cozy-stack/permissions/#request_5","text":"GET /permissions/doctype/io.cozy.events/shared-by-link HTTP/1.1 Host: cozy.example.net Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ Content-Type: application/vnd.api+json Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/permissions/#reponse_3","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : [ { type : io.cozy.permissions , id : c47f82396d09bfcd270343c5855b30a0 , attributes : { type : share , permissions : { rule0 : { type : io.cozy.events , verbs : [ PATCH , DELETE ], values : [ c47f82396d09bfcd270343c5855b0eea ] } }, codes : { bob : secret } }, meta : { rev : 1-d46b6358683b80c8d59fc55d6de54127 }, links : { self : /permissions/c47f82396d09bfcd270343c5855b30a0 } }, { type : io.cozy.permissions , id : c47f82396d09bfcd270343c5855b351a , attributes : { type : share , permissions : { rule0 : { type : io.cozy.events , verbs : [ GET ], values : [ c47f82396d09bfcd270343c5855b169b ] } }, codes : { bob : secret } }, meta : { rev : 1-920af658575a56e9e84685f1b09e5c23 }, links : { self : /permissions/c47f82396d09bfcd270343c5855b351a } } ] } Permissions required : GET on the whole doctype","title":"Reponse"},{"location":"/cozy-stack/realtime/","text":"Realtime docs Context Definitions Event: Something happening in the stack. Most of them will come from couchdb, some jobs and user actions might also trigger them. Events feed: the feed of occurring events. There is two types of feeds: continuous allows to follow events as they occurs interval allow the see the history of the feed from any given time Realtime: user experienced updates of the interface from change happening from another source. Ie, I have a folder opened in cozy-files on the browser, I take some pictures from my smartphone, the pictures appears in the folder without me needing to refresh the browser tab. What couchdb offers Couchdb supports with its _changes API both events feeds types: using since=now continuous=true we get all events continuous ly as they happen (SSE) using since=(last known seq_number) we get all changes in the interval between last known seq_number and now. Couchdb also offers a _db_updates route, which give us continuous changes at the database level. This routes does not support a since parameter, as there is no global seq_number . Other events will be generated from the stack itself, such as session close or jobs activity. Performance limitation We cannot have a continuous _changes feed open to every databases Use cases for interval events feeds Replication Couchdb replication algorithm can work in one-shot mode, where it replicates changes since last sync up until now, or in continuous mode where it replicates changes as they happens. The stack will not allow continuous mode for replication. This is already supported with the _changes route Sharing Our sharing is based on couchdb replication rules, so also depends on _changes feed to ensure all changes have been applied. Considering these use cases, there is no need for non-couchdb event to be part of the interval events feed. Use cases for continuous events feeds Realtime Some events should be send to the client to update views as data change. @event jobs trigger Some event will trigger the activation of a job (ie. When a photo has been uploaded, generate thumbnails and extract EXIF metadatas). This should be done as soon as possible after the events Sharing ? While not absolutely necessary, having cozy A notify cozy B when a shared document is changed allows for both better user experience (faster propagation) and better performance (no need to poll every X minutes, the N cozy we are sharing from). Client realtime tech choice Options Polling: regularly ask the server what happened since last time. COMET: Leaving a normal HTTP connection open sending data and heartbeets regularly to keep it open, reading xhr.responseText at intervals without waiting for readyState == 4. Restart the connection when it breaks. SSE: Normalized standardized version of COMET with half-decent browser support (86% users) but easily polyfillable (it s just COMET). It is simpler and easier to debug. It has some limitations (no HTTP headers in JS api, counts toward the maximum number of http connection per domain). Websocket: keep a socket open, it allows 2 way data communication which we do not need, has better server support (92% users) but is impossible to polyfill client side, more popular, there is a better golang package SockJS cie they are a lot of packages which imitate Websocket API while using complicated client server polyfill to allow support of older browser. SockJS is a drop-in websocket replacement with a go package and javascript client. Choice = Websocket While SSE appears at first glance like a better fit for our use case, its limitation and lack of browser priority makes us choose websocket. In the event older browser supports becomes necessary we can use SockJS. optimization paths (future) bandwidth Limiting the number of events sent by allowing the client to specified it is only interested in events matching a selector (files app only care about changes in the files of the current folder view) number of connections Instead of 1 socket / tab, we can probably make 1 socket / browser using some hackish combination of SharedWorker / iframe.postMessage and a client-side demultiplexer. both No need for realtime if the user is not using the tab (for most usecases), we could cut the realtime feed depending on Page Visibility API Go/Stack architecture We assume all couchdb changes will originate from the stack Events are generated at the stack level We do NOT rely on couchdb _changes?continuous nor _db_udpates We create a realtime.Event interface, which we call in other packages. We accept websocket connection and bind them to a realtime.Dispatcher object. Small cozy version It all happens in RAM, realtime.Event are immediately transmited to the dispatcher. Big cozy version (ie. multiple stack instance) Redis pub/sub Websocket API We start with a normal websocket handshake. Websockets include a protocol description in handshake, the protocol described below is hereby named io.cozy.websocket . Changes to the websocket protocol should be given versions, support for older version should be maintained when reasonable. GET /realtime/ HTTP/1.1 Host: mycozy.example.com Upgrade: websocket Connection: Upgrade Origin: http://calendar.mycozy.example.com Sec-WebSocket-Key: x3JrandomLkh9GBhXDw== Sec-WebSocket-Protocol: io.cozy.websocket Sec-WebSocket-Version: 13 Then messages are sent using json client { method : AUTH , payload : xxAppOrAuthTokenxx= client { method : SUBSCRIBE , payload : { type : io.cozy.files } client { method : SUBSCRIBE , payload : { type : io.cozy.contacts } server { event : UPDATED , payload : { id : idA , rev : 2-705... , type : io.cozy.contacts , doc : {embeded doc ...}}} server { event : DELETED , payload : { id : idA , rev : 3-541... , type : io.cozy.contacts }} server { event : UPDATED , payload : { id : idB , rev : 6-457... , type : io.cozy.files , doc : {embeded doc ...}}} AUTH It must be the first command to be sent. The client gives its token with this command, and the stack will use it to know which are the permissions of the app. { method : AUTH , payload : eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhcHAiLCJpYXQiOjE0OTg4MTY1OTEsImlzcyI6ImNvenkudG9vbHM6ODA4MCIsInN1YiI6Im1pbmkifQ.eH9DhoHz7rg8gR7noAiKfeo8eL3Q_PzyuskO_x3T8Hlh9q_IV-4zqoGtjTiO7luD6_VcLboEU-6o3XBek84VTg } SUBSCRIBE A client can send a SUBSCRIBE request to be notified of changes. The payload is a selector for the events it wishes to receive For now the only possible selector is on type optionaly id { method : SUBSCRIBE , payload : { type : [desired doctype] }} { method : SUBSCRIBE , payload : { type : [desired doctype] , id : idA }} In order to subscribe, a client must have permission GET on the passed selector. Otherwise an error is passed in the message feed. server { event : error , payload : { status : 403 Forbidden code : forbidden title : The Application can't subscribe to io.cozy.files source : { method : SUBSCRIBE , payload : { type : io.cozy.files } } }}","title":"/realtime - Realtime"},{"location":"/cozy-stack/realtime/#realtime-docs","text":"","title":"Realtime docs"},{"location":"/cozy-stack/realtime/#context","text":"","title":"Context"},{"location":"/cozy-stack/realtime/#definitions","text":"Event: Something happening in the stack. Most of them will come from couchdb, some jobs and user actions might also trigger them. Events feed: the feed of occurring events. There is two types of feeds: continuous allows to follow events as they occurs interval allow the see the history of the feed from any given time Realtime: user experienced updates of the interface from change happening from another source. Ie, I have a folder opened in cozy-files on the browser, I take some pictures from my smartphone, the pictures appears in the folder without me needing to refresh the browser tab.","title":"Definitions"},{"location":"/cozy-stack/realtime/#what-couchdb-offers","text":"Couchdb supports with its _changes API both events feeds types: using since=now continuous=true we get all events continuous ly as they happen (SSE) using since=(last known seq_number) we get all changes in the interval between last known seq_number and now. Couchdb also offers a _db_updates route, which give us continuous changes at the database level. This routes does not support a since parameter, as there is no global seq_number . Other events will be generated from the stack itself, such as session close or jobs activity.","title":"What couchdb offers"},{"location":"/cozy-stack/realtime/#performance-limitation","text":"We cannot have a continuous _changes feed open to every databases","title":"Performance limitation"},{"location":"/cozy-stack/realtime/#use-cases-for-interval-events-feeds","text":"","title":"Use cases for interval events feeds"},{"location":"/cozy-stack/realtime/#replication","text":"Couchdb replication algorithm can work in one-shot mode, where it replicates changes since last sync up until now, or in continuous mode where it replicates changes as they happens. The stack will not allow continuous mode for replication. This is already supported with the _changes route","title":"Replication"},{"location":"/cozy-stack/realtime/#sharing","text":"Our sharing is based on couchdb replication rules, so also depends on _changes feed to ensure all changes have been applied. Considering these use cases, there is no need for non-couchdb event to be part of the interval events feed.","title":"Sharing"},{"location":"/cozy-stack/realtime/#use-cases-for-continuous-events-feeds","text":"","title":"Use cases for continuous events feeds"},{"location":"/cozy-stack/realtime/#realtime","text":"Some events should be send to the client to update views as data change.","title":"Realtime"},{"location":"/cozy-stack/realtime/#event-jobs-trigger","text":"Some event will trigger the activation of a job (ie. When a photo has been uploaded, generate thumbnails and extract EXIF metadatas). This should be done as soon as possible after the events","title":"@event jobs trigger"},{"location":"/cozy-stack/realtime/#sharing_1","text":"While not absolutely necessary, having cozy A notify cozy B when a shared document is changed allows for both better user experience (faster propagation) and better performance (no need to poll every X minutes, the N cozy we are sharing from).","title":"Sharing ?"},{"location":"/cozy-stack/realtime/#client-realtime-tech-choice","text":"","title":"Client realtime tech choice"},{"location":"/cozy-stack/realtime/#options","text":"Polling: regularly ask the server what happened since last time. COMET: Leaving a normal HTTP connection open sending data and heartbeets regularly to keep it open, reading xhr.responseText at intervals without waiting for readyState == 4. Restart the connection when it breaks. SSE: Normalized standardized version of COMET with half-decent browser support (86% users) but easily polyfillable (it s just COMET). It is simpler and easier to debug. It has some limitations (no HTTP headers in JS api, counts toward the maximum number of http connection per domain). Websocket: keep a socket open, it allows 2 way data communication which we do not need, has better server support (92% users) but is impossible to polyfill client side, more popular, there is a better golang package SockJS cie they are a lot of packages which imitate Websocket API while using complicated client server polyfill to allow support of older browser. SockJS is a drop-in websocket replacement with a go package and javascript client.","title":"Options"},{"location":"/cozy-stack/realtime/#choice-websocket","text":"While SSE appears at first glance like a better fit for our use case, its limitation and lack of browser priority makes us choose websocket. In the event older browser supports becomes necessary we can use SockJS.","title":"Choice = Websocket"},{"location":"/cozy-stack/realtime/#optimization-paths-future","text":"bandwidth Limiting the number of events sent by allowing the client to specified it is only interested in events matching a selector (files app only care about changes in the files of the current folder view) number of connections Instead of 1 socket / tab, we can probably make 1 socket / browser using some hackish combination of SharedWorker / iframe.postMessage and a client-side demultiplexer. both No need for realtime if the user is not using the tab (for most usecases), we could cut the realtime feed depending on Page Visibility API","title":"optimization paths (future)"},{"location":"/cozy-stack/realtime/#gostack-architecture","text":"We assume all couchdb changes will originate from the stack Events are generated at the stack level We do NOT rely on couchdb _changes?continuous nor _db_udpates We create a realtime.Event interface, which we call in other packages. We accept websocket connection and bind them to a realtime.Dispatcher object.","title":"Go/Stack architecture"},{"location":"/cozy-stack/realtime/#small-cozy-version","text":"It all happens in RAM, realtime.Event are immediately transmited to the dispatcher.","title":"Small cozy version"},{"location":"/cozy-stack/realtime/#big-cozy-version-ie-multiple-stack-instance","text":"Redis pub/sub","title":"Big cozy version (ie. multiple stack instance)"},{"location":"/cozy-stack/realtime/#websocket-api","text":"We start with a normal websocket handshake. Websockets include a protocol description in handshake, the protocol described below is hereby named io.cozy.websocket . Changes to the websocket protocol should be given versions, support for older version should be maintained when reasonable. GET /realtime/ HTTP/1.1 Host: mycozy.example.com Upgrade: websocket Connection: Upgrade Origin: http://calendar.mycozy.example.com Sec-WebSocket-Key: x3JrandomLkh9GBhXDw== Sec-WebSocket-Protocol: io.cozy.websocket Sec-WebSocket-Version: 13 Then messages are sent using json client { method : AUTH , payload : xxAppOrAuthTokenxx= client { method : SUBSCRIBE , payload : { type : io.cozy.files } client { method : SUBSCRIBE , payload : { type : io.cozy.contacts } server { event : UPDATED , payload : { id : idA , rev : 2-705... , type : io.cozy.contacts , doc : {embeded doc ...}}} server { event : DELETED , payload : { id : idA , rev : 3-541... , type : io.cozy.contacts }} server { event : UPDATED , payload : { id : idB , rev : 6-457... , type : io.cozy.files , doc : {embeded doc ...}}}","title":"Websocket API"},{"location":"/cozy-stack/realtime/#auth","text":"It must be the first command to be sent. The client gives its token with this command, and the stack will use it to know which are the permissions of the app. { method : AUTH , payload : eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhcHAiLCJpYXQiOjE0OTg4MTY1OTEsImlzcyI6ImNvenkudG9vbHM6ODA4MCIsInN1YiI6Im1pbmkifQ.eH9DhoHz7rg8gR7noAiKfeo8eL3Q_PzyuskO_x3T8Hlh9q_IV-4zqoGtjTiO7luD6_VcLboEU-6o3XBek84VTg }","title":"AUTH"},{"location":"/cozy-stack/realtime/#subscribe","text":"A client can send a SUBSCRIBE request to be notified of changes. The payload is a selector for the events it wishes to receive For now the only possible selector is on type optionaly id { method : SUBSCRIBE , payload : { type : [desired doctype] }} { method : SUBSCRIBE , payload : { type : [desired doctype] , id : idA }} In order to subscribe, a client must have permission GET on the passed selector. Otherwise an error is passed in the message feed. server { event : error , payload : { status : 403 Forbidden code : forbidden title : The Application can't subscribe to io.cozy.files source : { method : SUBSCRIBE , payload : { type : io.cozy.files } } }}","title":"SUBSCRIBE"},{"location":"/cozy-stack/remote/","text":"Table of contents Proxy for remote data/API The client side applications in Cozy are constrained and cannot speak with external websites to avoid leaking personal data. Technically, it is made with the Content Security Policy. These rules are very strict and it would be a pity to now allow a client side app to load public informations from a source like Wikipedia. Our proposal is to make client side apps able to query external websites of their choices, but these requests will be made via the cozy-stack (as a proxy) and will be logged to check later that no personal data was leaked unintentionally. We can see the data loaded from the external website as a document with a doctype: it s just not a doctype local to our cozy, but a remote one. A client side app can request data from external websites by doing these three steps: Declaring a remote doctype and its requests Declaring permissions on these doctypes in the manifest Calling the /remote API of cozy-stack Declaring a remote doctype Doctypes are formalized in this repository: github.com/cozy/cozy-doctypes . Each doctype has its own directory inside the repository. For a remote doctype, it will include a file called request that will describe how the cozy-stack will request the external website. Let s take an example: $ tree cozy-doctypes cozy-doctypes \u251c\u2500\u2500 [...] \u251c\u2500\u2500 org.wikidata.entity \u2502 \u2514\u2500\u2500 request \u2514\u2500\u2500 org.wikidata.search \u2514\u2500\u2500 request $ cat cozy-doctypes/org.wikidata.entity/request GET https://www.wikidata.org/wiki/Special:EntityData/{{entity}}.json Accept: application/json $ cat cozy-doctypes/org.wikidata.search/request GET https://www.wikidata.org/w/api.php?action=wbsearchentities search={{q}} language=en format=json Here, we have two remote doctypes. Each one has a request defined for it. The format for the request file is: the verb and the URL on the first line then some lines that describe the HTTP headers then a blank line and the body if the request is a POST For the path, the query-string, the headers, and the body, it s possible to have some dynamic part by using {{ , a variable name, and }} . Some templating helpers are available to escape specific variables using {{ function name - space - variable name }} . These helpers are only available for the body part of the template. Available helpers: json : for json parts ( { \"key\": \"{{json val}}\" } ) html : for html parts ( p {{html val}} /p ) query : for query parameter of a url ( http://foobar.com?q={{query q}} ) path : for path component of a url ( http://foobar.com/{{path p}} ) Values injected in the URL are automatically URI-escaped based on the part they are included in: namely as a query parameter or as a path component. Note : by default, the User-Agent is set to a default value ( cozy-stack and a version number). It can be overriden in the request description. Example: GET https://foobar.com/{{path}}?q={{query}} Content-Type: {{contentType}} { key : {{json value}} , url : http://anotherurl.com/{{path anotherPath}}?q={{query anotherQuery}} , } Declaring permissions Nothing special here. The client side app must declare that it will use these doctypes in its manifest, like for other doctypes: { ... : ... , permissions : { search : { description : Required for searching on wikidata , type : org.wikidata.search }, entity : { description : Required for getting more informations about an entity on wikidata , type : org.wikidata.entity } } } Calling the remote API GET/POST /remote/:doctype The client side app must use the same verb as the defined request ( GET in our two previous examples). It can use the query-string for GET, and a JSON body for POST, to give values for the variables. Example: GET /remote/org.wikidata.search?q=Douglas+Adams HTTP/1.1 Host: alice.cozy.tools It is possible to send some extra informations, to make it easier to understand the request. If no variable in the request matches it, it won t be send to the remote website. Example: POST /remote/org.example HTTP/1.1 Host: alice.cozy.tools Content-Type: application/json { query : Qbhtynf Nqnzf , comment : query is rot13 for Douglas Adams } Note : currently, only the response with a content-type that is an image, JSON or XML are accepted. Other content-types are blocked the time to evaluate if they are useful and their security implication (javascript is probably not something we want to allow). GET /remote/assets/:asset-name The client application can fetch a list of predefined assets via this route. The resources available are defined in the configuration file. Example: GET /remote/assets/bank HTTP/1.1 Host: alice.cozy.tools Logs The requests are logged as the io.cozy.remote.requests doctype, with the doctype asked, the parameter (even those that have not been used, like comment in the previous example), and the application that has made the request. For developers If you are a developer and you want to use a new remote doctype, it can be difficult to first make it available in the github.com/cozy/cozy-doctypes repository and only then test it. So, the cozy-stack serve command will have a --doctypes option to gives a local directory with the doctypes. You can fork the repository, clone it, work on a new doctype inside, test it locally, and when OK, make a pull request for it.","title":"/remote - Proxy for remote data/API"},{"location":"/cozy-stack/remote/#proxy-for-remote-dataapi","text":"The client side applications in Cozy are constrained and cannot speak with external websites to avoid leaking personal data. Technically, it is made with the Content Security Policy. These rules are very strict and it would be a pity to now allow a client side app to load public informations from a source like Wikipedia. Our proposal is to make client side apps able to query external websites of their choices, but these requests will be made via the cozy-stack (as a proxy) and will be logged to check later that no personal data was leaked unintentionally. We can see the data loaded from the external website as a document with a doctype: it s just not a doctype local to our cozy, but a remote one. A client side app can request data from external websites by doing these three steps: Declaring a remote doctype and its requests Declaring permissions on these doctypes in the manifest Calling the /remote API of cozy-stack","title":"Proxy for remote data/API"},{"location":"/cozy-stack/remote/#declaring-a-remote-doctype","text":"Doctypes are formalized in this repository: github.com/cozy/cozy-doctypes . Each doctype has its own directory inside the repository. For a remote doctype, it will include a file called request that will describe how the cozy-stack will request the external website. Let s take an example: $ tree cozy-doctypes cozy-doctypes \u251c\u2500\u2500 [...] \u251c\u2500\u2500 org.wikidata.entity \u2502 \u2514\u2500\u2500 request \u2514\u2500\u2500 org.wikidata.search \u2514\u2500\u2500 request $ cat cozy-doctypes/org.wikidata.entity/request GET https://www.wikidata.org/wiki/Special:EntityData/{{entity}}.json Accept: application/json $ cat cozy-doctypes/org.wikidata.search/request GET https://www.wikidata.org/w/api.php?action=wbsearchentities search={{q}} language=en format=json Here, we have two remote doctypes. Each one has a request defined for it. The format for the request file is: the verb and the URL on the first line then some lines that describe the HTTP headers then a blank line and the body if the request is a POST For the path, the query-string, the headers, and the body, it s possible to have some dynamic part by using {{ , a variable name, and }} . Some templating helpers are available to escape specific variables using {{ function name - space - variable name }} . These helpers are only available for the body part of the template. Available helpers: json : for json parts ( { \"key\": \"{{json val}}\" } ) html : for html parts ( p {{html val}} /p ) query : for query parameter of a url ( http://foobar.com?q={{query q}} ) path : for path component of a url ( http://foobar.com/{{path p}} ) Values injected in the URL are automatically URI-escaped based on the part they are included in: namely as a query parameter or as a path component. Note : by default, the User-Agent is set to a default value ( cozy-stack and a version number). It can be overriden in the request description. Example: GET https://foobar.com/{{path}}?q={{query}} Content-Type: {{contentType}} { key : {{json value}} , url : http://anotherurl.com/{{path anotherPath}}?q={{query anotherQuery}} , }","title":"Declaring a remote doctype"},{"location":"/cozy-stack/remote/#declaring-permissions","text":"Nothing special here. The client side app must declare that it will use these doctypes in its manifest, like for other doctypes: { ... : ... , permissions : { search : { description : Required for searching on wikidata , type : org.wikidata.search }, entity : { description : Required for getting more informations about an entity on wikidata , type : org.wikidata.entity } } }","title":"Declaring permissions"},{"location":"/cozy-stack/remote/#calling-the-remote-api","text":"","title":"Calling the remote API"},{"location":"/cozy-stack/remote/#getpost-remotedoctype","text":"The client side app must use the same verb as the defined request ( GET in our two previous examples). It can use the query-string for GET, and a JSON body for POST, to give values for the variables. Example: GET /remote/org.wikidata.search?q=Douglas+Adams HTTP/1.1 Host: alice.cozy.tools It is possible to send some extra informations, to make it easier to understand the request. If no variable in the request matches it, it won t be send to the remote website. Example: POST /remote/org.example HTTP/1.1 Host: alice.cozy.tools Content-Type: application/json { query : Qbhtynf Nqnzf , comment : query is rot13 for Douglas Adams } Note : currently, only the response with a content-type that is an image, JSON or XML are accepted. Other content-types are blocked the time to evaluate if they are useful and their security implication (javascript is probably not something we want to allow).","title":"GET/POST /remote/:doctype"},{"location":"/cozy-stack/remote/#get-remoteassetsasset-name","text":"The client application can fetch a list of predefined assets via this route. The resources available are defined in the configuration file. Example: GET /remote/assets/bank HTTP/1.1 Host: alice.cozy.tools","title":"GET /remote/assets/:asset-name"},{"location":"/cozy-stack/remote/#logs","text":"The requests are logged as the io.cozy.remote.requests doctype, with the doctype asked, the parameter (even those that have not been used, like comment in the previous example), and the application that has made the request.","title":"Logs"},{"location":"/cozy-stack/remote/#for-developers","text":"If you are a developer and you want to use a new remote doctype, it can be difficult to first make it available in the github.com/cozy/cozy-doctypes repository and only then test it. So, the cozy-stack serve command will have a --doctypes option to gives a local directory with the doctypes. You can fork the repository, clone it, work on a new doctype inside, test it locally, and when OK, make a pull request for it.","title":"For developers"},{"location":"/cozy-stack/settings/","text":"Table of contents Settings Disk usage GET /settings/disk-usage Says how many bytes are available and used to store files. When not limited the quota field is omitted. Request GET /settings/disk-usage HTTP/1.1 Host: alice.example.com Accept: application/vnd.api+json Authorization: Bearer ... Response HTTP/1.1 200 OK Content-type: application/vnd.api+json { data : { type : io.cozy.settings , id : io.cozy.settings.disk-usage , attributes : { is_limited : true, quota : 123456789 , used : 12345678 } } } Passphrase POST /settings/passphrase The onboarding application can send a request to this endpoint to register the passphrase of the user. The registration token can only be used once. Request POST /settings/passphrase HTTP/1.1 Host: alice.example.com Content-Type: application/json { register_token : 37cddf40d7724988860fa0e03efd30fe , passphrase : ThisIsTheNewShinnyPassphraseChoosedByAlice } Response HTTP/1.1 204 No Content Set-Cookie: cozysessid=AAAAAFhSXT81MWU0ZTBiMzllMmI1OGUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa; Path=/; Domain=alice.example.com; Max-Age=604800; HttpOnly; Secure PUT /settings/passphrase (without two-factor authentication) The user can change its passphrase with this route. For users with two-factor authentication activated, a second step on the same route is necessary to actually update the passphrase. See below. Request PUT /settings/passphrase HTTP/1.1 Host: alice.example.com Content-Type: application/json Cookie: cozysessid=AAAAAFhSXT81MWU0ZTBiMzllMmI1OGUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa { current_passphrase : ThisIsTheNewShinnyPassphraseChoosedByAlice , new_passphrase : AliceHasChangedHerPassphraseAndThisIsTheNewPassphrase } Response HTTP/1.1 204 No Content Set-Cookie: cozysessid=AAAAShoo3uo1Maic4VibuGohlik2eKUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa; Path=/; Domain=alice.example.com; Max-Age=604800; HttpOnly; Secure PUT /settings/passphrase (with two-factor authentication) The user can change its passphrase with this route, with two-factor authentication to verify the user with more than its passphrase. Request (first step) PUT /settings/passphrase HTTP/1.1 Host: alice.example.com Content-Type: application/json Cookie: cozysessid=AAAAAFhSXT81MWU0ZTBiMzllMmI1OGUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa { current_passphrase : ThisIsTheNewShinnyPassphraseChoosedByAlice } Response (first step) HTTP/1.1 200 OK Set-Cookie: cozysessid=AAAAShoo3uo1Maic4VibuGohlik2eKUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa; Path=/; Domain=alice.example.com; Max-Age=604800; HttpOnly; Secure { two_factor_token : YxOSUjxd0SNmuwEEDRHXfw== } At this point, the current passphrase has been exchanged against a token, and a passcode should have been sent to the user to authenticate on the second step. The token/passcode pair can be used on the second step to update the passphrase. Request (second step) PUT /settings/passphrase HTTP/1.1 Host: alice.example.com Content-Type: application/json Cookie: cozysessid=AAAAAFhSXT81MWU0ZTBiMzllMmI1OGUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa { new_passphrase : AliceHasChangedHerPassphraseAndThisIsTheNewPassphrase , two_factor_token : YxOSUjxd0SNmuwEEDRHXfw== , two_factor_passcode : 4947178 } Response (second step) HTTP/1.1 204 No Content Set-Cookie: cozysessid=AAAAShoo3uo1Maic4VibuGohlik2eKUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa; Path=/; Domain=alice.example.com; Max-Age=604800; HttpOnly; Secure Response HTTP/1.1 204 No Content Instance GET /settings/instance If the user is logged in, display all instance settings. If the user is not logged in, the register token can be used to read the informations. Request GET /settings/instance HTTP/1.1 Host: alice.example.com Accept: application/vnd.api+json Cookie: sessionid=xxxx Response { data : { type : io.cozy.settings , id : io.cozy.settings.instance , meta : { rev : 3-56521545485448482 }, attributes : { locale : fr , auto_update : true, email : alice@example.com , public_name : Alice Martin , auth_mode : basic } } } Permissions To use this endpoint, an application needs a permission on the type io.cozy.settings for the verb GET . PUT /settings/instance If the user is logged in, allow to set the instance fields Request POST /settings/instance HTTP/1.1 Host: alice.example.com Accept: application/vnd.api+json Content-type: application/vnd.api+json Cookie: sessionid=xxxxx Authorization: Bearer settings-token { data : { type : io.cozy.settings , id : io.cozy.settings.instance , meta : { rev : 3-56521545485448482 }, attributes : { locale : fr , email : alice@example.com , public_name : Alice Martin , timezone : Europe/Berlin , auth_mode : two_factor_mail } } } Response HTTP/1.1 200 OK Content-type: application/json { data : { type : io.cozy.settings , id : io.cozy.settings.instance , meta : { rev : 4-5a3e315e }, attributes : { locale : fr , email : alice@example.com , public_name : Alice Martin , timezone : Europe/Berlin , auth_mode : two_factor_mail } } } Permissions To use this endpoint, an application needs a permission on the type io.cozy.settings for the verb PUT . PUT /settings/instance/auth_mode With this route, the user can ask for the activation of different authentication modes, like two-factor authentication. Available authentication modes: basic : basic authentication only with passphrase two_factor_mail : authentication with passphrase and validation with a code sent via email to the user. When asking for activation of the two-factor authentication, a side-effect can be triggered to send the user its code (via email for instance), and the activation not being effective. This side-effect should provide the user with a code that can be used to finalize the activation of the two-factor authentication. Hence, this route has two behaviors: the code is not provided: the route is a side effect to ask for the activation of 2FA, and a code is sent the code is provided, and valid: the two-factor authentication is actually activated. Status codes: 204 No Content : when the mail has been confirmed and two-factor authentication is activated 422 Unprocessable Entity : when the given confirmation code is not good. Request PUT /settings/instance/auth_mode HTTP/1.1 Host: alice.example.com Content-Type: application/json Cookie: cozysessid=AAAAAFhSXT81MWU0ZTBiMzllMmI1OGUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa { auth_mode : two_factor_mail , two_factor_activation_code : 12345678 } GET /settings/sessions This route allows to get all the currently active sessions. GET /settings/sessions HTTP/1.1 Host: cozy.example.org Cookie: ... Authorization: Bearer ... HTTP/1.1 200 OK Content-Type: application/json { data : [ { id : ... , attributes : { last_seen : }, meta : { rev : ... } } ] } Permissions This route requires the application to have permissions on the io.cozy.sessions doctype with the GET verb. OAuth 2 clients GET /settings/clients Get the list of the registered clients Request GET /settings/clients HTTP/1.1 Host: alice.example.com Accept: application/vnd.api+json Cookie: sessionid=xxxxx Authorization: Bearer oauth2-clients-token Response HTTP/1.1 200 OK Content-type: application/json { data : [ { type : io.cozy.oauth.clients , id : 30e84c10-e6cf-11e6-9bfd-a7106972de51 , attributes : { redirect_uris : [ http://localhost:4000/oauth/callback ], client_name : Cozy-Desktop on my-new-laptop , client_kind : desktop , client_uri : https://docs.cozy.io/en/mobile/desktop.html , logo_uri : https://docs.cozy.io/assets/images/cozy-logo-docs.svg , policy_uri : https://cozy.io/policy , software_id : /github.com/cozy-labs/cozy-desktop , software_version : 0.16.0 , synchronized_at : 2017-09-05T16:23:04Z }, links : { self : /settings/clients/30e84c10-e6cf-11e6-9bfd-a7106972de51 } } ] } Permissions To use this endpoint, an application needs a permission on the type io.cozy.oauth.clients for the verb GET (only client-side apps). DELETE /settings/clients/:client-id Request DELETE /settings/clients/30e84c10-e6cf-11e6-9bfd-a7106972de51 HTTP/1.1 Host: alice.example.com Authorization: Bearer oauth2-clients-token Response HTTP/1.1 204 No Content Permissions To use this endpoint, an application needs a permission on the type io.cozy.oauth.clients for the verb DELETE (only client-side apps). POST /settings/synchronized Any OAuth2 client can make a request to this endpoint with its token, no permission is needed. It will update the date of last synchronization for this device. Request POST /settings/synchronized HTTP/1.1 Host: alice.example.com Authorization: Bearer oauth2-access-token Response HTTP/1.1 204 No Content Context GET /settings/onboarded It redirects the user to an application after the onboarding. The application is selected according to the context of the instance and the configuration of the stack. GET /settings/context It gives the keys/values from the config for the context of the instance. Request GET /settings/context HTTP/1.1 Host: alice.example.com Accept: application/vnd.api+json Cookie: sessionid=xxxx Response { data : { type : io.cozy.settings , id : io.cozy.settings.context , attributes : { default_redirection : drive/#/files , help_link : https://forum.cozy.io/ , onboarded_redirection : collect/#/discovery/?intro }, links : { self : /settings/context } } } Permissions To use this endpoint, an application needs a valid token, but no explicit permission is required.","title":"/settings - Settings"},{"location":"/cozy-stack/settings/#settings","text":"","title":"Settings"},{"location":"/cozy-stack/settings/#disk-usage","text":"","title":"Disk usage"},{"location":"/cozy-stack/settings/#get-settingsdisk-usage","text":"Says how many bytes are available and used to store files. When not limited the quota field is omitted.","title":"GET /settings/disk-usage"},{"location":"/cozy-stack/settings/#request","text":"GET /settings/disk-usage HTTP/1.1 Host: alice.example.com Accept: application/vnd.api+json Authorization: Bearer ...","title":"Request"},{"location":"/cozy-stack/settings/#response","text":"HTTP/1.1 200 OK Content-type: application/vnd.api+json { data : { type : io.cozy.settings , id : io.cozy.settings.disk-usage , attributes : { is_limited : true, quota : 123456789 , used : 12345678 } } }","title":"Response"},{"location":"/cozy-stack/settings/#passphrase","text":"","title":"Passphrase"},{"location":"/cozy-stack/settings/#post-settingspassphrase","text":"The onboarding application can send a request to this endpoint to register the passphrase of the user. The registration token can only be used once.","title":"POST /settings/passphrase"},{"location":"/cozy-stack/settings/#request_1","text":"POST /settings/passphrase HTTP/1.1 Host: alice.example.com Content-Type: application/json { register_token : 37cddf40d7724988860fa0e03efd30fe , passphrase : ThisIsTheNewShinnyPassphraseChoosedByAlice }","title":"Request"},{"location":"/cozy-stack/settings/#response_1","text":"HTTP/1.1 204 No Content Set-Cookie: cozysessid=AAAAAFhSXT81MWU0ZTBiMzllMmI1OGUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa; Path=/; Domain=alice.example.com; Max-Age=604800; HttpOnly; Secure","title":"Response"},{"location":"/cozy-stack/settings/#put-settingspassphrase-without-two-factor-authentication","text":"The user can change its passphrase with this route. For users with two-factor authentication activated, a second step on the same route is necessary to actually update the passphrase. See below.","title":"PUT /settings/passphrase (without two-factor authentication)"},{"location":"/cozy-stack/settings/#request_2","text":"PUT /settings/passphrase HTTP/1.1 Host: alice.example.com Content-Type: application/json Cookie: cozysessid=AAAAAFhSXT81MWU0ZTBiMzllMmI1OGUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa { current_passphrase : ThisIsTheNewShinnyPassphraseChoosedByAlice , new_passphrase : AliceHasChangedHerPassphraseAndThisIsTheNewPassphrase }","title":"Request"},{"location":"/cozy-stack/settings/#response_2","text":"HTTP/1.1 204 No Content Set-Cookie: cozysessid=AAAAShoo3uo1Maic4VibuGohlik2eKUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa; Path=/; Domain=alice.example.com; Max-Age=604800; HttpOnly; Secure","title":"Response"},{"location":"/cozy-stack/settings/#put-settingspassphrase-with-two-factor-authentication","text":"The user can change its passphrase with this route, with two-factor authentication to verify the user with more than its passphrase.","title":"PUT /settings/passphrase (with two-factor authentication)"},{"location":"/cozy-stack/settings/#request-first-step","text":"PUT /settings/passphrase HTTP/1.1 Host: alice.example.com Content-Type: application/json Cookie: cozysessid=AAAAAFhSXT81MWU0ZTBiMzllMmI1OGUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa { current_passphrase : ThisIsTheNewShinnyPassphraseChoosedByAlice }","title":"Request (first step)"},{"location":"/cozy-stack/settings/#response-first-step","text":"HTTP/1.1 200 OK Set-Cookie: cozysessid=AAAAShoo3uo1Maic4VibuGohlik2eKUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa; Path=/; Domain=alice.example.com; Max-Age=604800; HttpOnly; Secure { two_factor_token : YxOSUjxd0SNmuwEEDRHXfw== } At this point, the current passphrase has been exchanged against a token, and a passcode should have been sent to the user to authenticate on the second step. The token/passcode pair can be used on the second step to update the passphrase.","title":"Response (first step)"},{"location":"/cozy-stack/settings/#request-second-step","text":"PUT /settings/passphrase HTTP/1.1 Host: alice.example.com Content-Type: application/json Cookie: cozysessid=AAAAAFhSXT81MWU0ZTBiMzllMmI1OGUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa { new_passphrase : AliceHasChangedHerPassphraseAndThisIsTheNewPassphrase , two_factor_token : YxOSUjxd0SNmuwEEDRHXfw== , two_factor_passcode : 4947178 }","title":"Request (second step)"},{"location":"/cozy-stack/settings/#response-second-step","text":"HTTP/1.1 204 No Content Set-Cookie: cozysessid=AAAAShoo3uo1Maic4VibuGohlik2eKUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa; Path=/; Domain=alice.example.com; Max-Age=604800; HttpOnly; Secure","title":"Response (second step)"},{"location":"/cozy-stack/settings/#response_3","text":"HTTP/1.1 204 No Content","title":"Response"},{"location":"/cozy-stack/settings/#instance","text":"","title":"Instance"},{"location":"/cozy-stack/settings/#get-settingsinstance","text":"If the user is logged in, display all instance settings. If the user is not logged in, the register token can be used to read the informations.","title":"GET /settings/instance"},{"location":"/cozy-stack/settings/#request_3","text":"GET /settings/instance HTTP/1.1 Host: alice.example.com Accept: application/vnd.api+json Cookie: sessionid=xxxx","title":"Request"},{"location":"/cozy-stack/settings/#response_4","text":"{ data : { type : io.cozy.settings , id : io.cozy.settings.instance , meta : { rev : 3-56521545485448482 }, attributes : { locale : fr , auto_update : true, email : alice@example.com , public_name : Alice Martin , auth_mode : basic } } }","title":"Response"},{"location":"/cozy-stack/settings/#permissions","text":"To use this endpoint, an application needs a permission on the type io.cozy.settings for the verb GET .","title":"Permissions"},{"location":"/cozy-stack/settings/#put-settingsinstance","text":"If the user is logged in, allow to set the instance fields","title":"PUT /settings/instance"},{"location":"/cozy-stack/settings/#request_4","text":"POST /settings/instance HTTP/1.1 Host: alice.example.com Accept: application/vnd.api+json Content-type: application/vnd.api+json Cookie: sessionid=xxxxx Authorization: Bearer settings-token { data : { type : io.cozy.settings , id : io.cozy.settings.instance , meta : { rev : 3-56521545485448482 }, attributes : { locale : fr , email : alice@example.com , public_name : Alice Martin , timezone : Europe/Berlin , auth_mode : two_factor_mail } } }","title":"Request"},{"location":"/cozy-stack/settings/#response_5","text":"HTTP/1.1 200 OK Content-type: application/json { data : { type : io.cozy.settings , id : io.cozy.settings.instance , meta : { rev : 4-5a3e315e }, attributes : { locale : fr , email : alice@example.com , public_name : Alice Martin , timezone : Europe/Berlin , auth_mode : two_factor_mail } } }","title":"Response"},{"location":"/cozy-stack/settings/#permissions_1","text":"To use this endpoint, an application needs a permission on the type io.cozy.settings for the verb PUT .","title":"Permissions"},{"location":"/cozy-stack/settings/#put-settingsinstanceauth_mode","text":"With this route, the user can ask for the activation of different authentication modes, like two-factor authentication. Available authentication modes: basic : basic authentication only with passphrase two_factor_mail : authentication with passphrase and validation with a code sent via email to the user. When asking for activation of the two-factor authentication, a side-effect can be triggered to send the user its code (via email for instance), and the activation not being effective. This side-effect should provide the user with a code that can be used to finalize the activation of the two-factor authentication. Hence, this route has two behaviors: the code is not provided: the route is a side effect to ask for the activation of 2FA, and a code is sent the code is provided, and valid: the two-factor authentication is actually activated. Status codes: 204 No Content : when the mail has been confirmed and two-factor authentication is activated 422 Unprocessable Entity : when the given confirmation code is not good.","title":"PUT /settings/instance/auth_mode"},{"location":"/cozy-stack/settings/#request_5","text":"PUT /settings/instance/auth_mode HTTP/1.1 Host: alice.example.com Content-Type: application/json Cookie: cozysessid=AAAAAFhSXT81MWU0ZTBiMzllMmI1OGUyMmZiN2Q0YTYzNDAxN2Y5NjCmp2Ja56hPgHwufpJCBBGJC2mLeJ5LCRrFFkHwaVVa { auth_mode : two_factor_mail , two_factor_activation_code : 12345678 }","title":"Request"},{"location":"/cozy-stack/settings/#get-settingssessions","text":"This route allows to get all the currently active sessions. GET /settings/sessions HTTP/1.1 Host: cozy.example.org Cookie: ... Authorization: Bearer ... HTTP/1.1 200 OK Content-Type: application/json { data : [ { id : ... , attributes : { last_seen : }, meta : { rev : ... } } ] }","title":"GET /settings/sessions"},{"location":"/cozy-stack/settings/#permissions_2","text":"This route requires the application to have permissions on the io.cozy.sessions doctype with the GET verb.","title":"Permissions"},{"location":"/cozy-stack/settings/#oauth-2-clients","text":"","title":"OAuth 2 clients"},{"location":"/cozy-stack/settings/#get-settingsclients","text":"Get the list of the registered clients","title":"GET /settings/clients"},{"location":"/cozy-stack/settings/#request_6","text":"GET /settings/clients HTTP/1.1 Host: alice.example.com Accept: application/vnd.api+json Cookie: sessionid=xxxxx Authorization: Bearer oauth2-clients-token","title":"Request"},{"location":"/cozy-stack/settings/#response_6","text":"HTTP/1.1 200 OK Content-type: application/json { data : [ { type : io.cozy.oauth.clients , id : 30e84c10-e6cf-11e6-9bfd-a7106972de51 , attributes : { redirect_uris : [ http://localhost:4000/oauth/callback ], client_name : Cozy-Desktop on my-new-laptop , client_kind : desktop , client_uri : https://docs.cozy.io/en/mobile/desktop.html , logo_uri : https://docs.cozy.io/assets/images/cozy-logo-docs.svg , policy_uri : https://cozy.io/policy , software_id : /github.com/cozy-labs/cozy-desktop , software_version : 0.16.0 , synchronized_at : 2017-09-05T16:23:04Z }, links : { self : /settings/clients/30e84c10-e6cf-11e6-9bfd-a7106972de51 } } ] }","title":"Response"},{"location":"/cozy-stack/settings/#permissions_3","text":"To use this endpoint, an application needs a permission on the type io.cozy.oauth.clients for the verb GET (only client-side apps).","title":"Permissions"},{"location":"/cozy-stack/settings/#delete-settingsclientsclient-id","text":"","title":"DELETE /settings/clients/:client-id"},{"location":"/cozy-stack/settings/#request_7","text":"DELETE /settings/clients/30e84c10-e6cf-11e6-9bfd-a7106972de51 HTTP/1.1 Host: alice.example.com Authorization: Bearer oauth2-clients-token","title":"Request"},{"location":"/cozy-stack/settings/#response_7","text":"HTTP/1.1 204 No Content","title":"Response"},{"location":"/cozy-stack/settings/#permissions_4","text":"To use this endpoint, an application needs a permission on the type io.cozy.oauth.clients for the verb DELETE (only client-side apps).","title":"Permissions"},{"location":"/cozy-stack/settings/#post-settingssynchronized","text":"Any OAuth2 client can make a request to this endpoint with its token, no permission is needed. It will update the date of last synchronization for this device.","title":"POST /settings/synchronized"},{"location":"/cozy-stack/settings/#request_8","text":"POST /settings/synchronized HTTP/1.1 Host: alice.example.com Authorization: Bearer oauth2-access-token","title":"Request"},{"location":"/cozy-stack/settings/#response_8","text":"HTTP/1.1 204 No Content","title":"Response"},{"location":"/cozy-stack/settings/#context","text":"","title":"Context"},{"location":"/cozy-stack/settings/#get-settingsonboarded","text":"It redirects the user to an application after the onboarding. The application is selected according to the context of the instance and the configuration of the stack.","title":"GET /settings/onboarded"},{"location":"/cozy-stack/settings/#get-settingscontext","text":"It gives the keys/values from the config for the context of the instance.","title":"GET /settings/context"},{"location":"/cozy-stack/settings/#request_9","text":"GET /settings/context HTTP/1.1 Host: alice.example.com Accept: application/vnd.api+json Cookie: sessionid=xxxx","title":"Request"},{"location":"/cozy-stack/settings/#response_9","text":"{ data : { type : io.cozy.settings , id : io.cozy.settings.context , attributes : { default_redirection : drive/#/files , help_link : https://forum.cozy.io/ , onboarded_redirection : collect/#/discovery/?intro }, links : { self : /settings/context } } }","title":"Response"},{"location":"/cozy-stack/settings/#permissions_5","text":"To use this endpoint, an application needs a valid token, but no explicit permission is required.","title":"Permissions"},{"location":"/cozy-stack/sharing/","text":"Table of contents Sharing The owner of a cozy instance can share access to her documents to other users. Sharing by links A client-side application can propose sharing by links: The application must have a public route in its manifest. See Apps documentation for how to do that. The application can create a set of permissions for the shared documents, with codes. See permissions documentation for the details. The application can then create a shareable link (e.g. https://calendar.cozy.example.net/public?sharecode=eiJ3iepoaihohz1Y ) by putting together the app sub-domain, the public route path, and a code for the permissions set. The app can then send this link by mail, via the jobs system , or just give it to the user, so he can transmit it to her friends via chat or other ways. When someone opens the shared link, the stack will load the public route, find the corresponding index.html file, and replace {{.Token}} inside it by a token with the same set of permissions that sharecode offers. This token can then be used as a Bearer token in the Authorization header for requests to the stack (or via cozy-client-js). If necessary, the application can list the permissions for the token by calling /permissions/self with this token. Cozy to cozy sharing The owner of a cozy instance can send and synchronize documents to others cozy users. Routes POST /sharings/ Create a new sharing. The sharing rules and recipients must be specified. The description , preview_path , and open_sharing fields are optional. The app_slug field is optional and is the slug of the web app by default. To create a sharing, no permissions on io.cozy.sharings are needed: an application can create a sharing on the documents for whose it has a permission. Request POST /sharings/ HTTP/1.1 Host: alice.example.net Content-Type: application/vnd.api+json { data : { type : io.cozy.sharings , attributes : { description : sharing test , preview_path : /preview-sharing , rules : [ { title : Hawaii , doctype : io.cozy.files , values : [ 612acf1c-1d72-11e8-b043-ef239d3074dd ], add : sync , update : sync , remove : sync } ] }, relationships : { recipients : { data : [ { id : 2a31ce0128b5f89e40fd90da3f014087 , type : io.cozy.contacts } ] } } } } Response HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { type : io.cozy.sharings , id : ce8835a061d0ef68947afe69a0046722 , meta : { rev : 1-4859c6c755143adf0838d225c5e97882 }, attributes : { description : sharing test , preview_path : /preview-sharing , app_slug : drive , owner : true, created_at : 2018-01-04T12:35:08Z , updated_at : 2018-01-04T13:45:43Z , members : [ { status : owner , public_name : Alice , email : alice@example.net , instance : alice.example.net }, { status : mail-not-sent , name : Bob , email : bob@example.net } ], rules : [ { title : Hawaii , doctype : io.cozy.files , values : [ 612acf1c-1d72-11e8-b043-ef239d3074dd ], add : sync , update : sync , remove : sync } ] }, links : { self : /sharings/ce8835a061d0ef68947afe69a0046722 } } } GET /sharings/:sharing-id/discovery If no preview_path is set, it s an URL to this route that will be sent to the users to notify them that someone wants to share something with them. On this page, they can fill the URL of their Cozy (if the user has already filled its Cozy URL in a previous sharing, the form will be pre-filled and the user will just have to click OK). Query-String Parameter Description state a code that identify the recipient Example GET /sharings/ce8835a061d0ef68947afe69a0046722/discovery?state=eiJ3iepoaihohz1Y HTTP/1.1 Host: alice.example.net POST /sharings/:sharing-id/discovery Give to the cozy of the sharer the URL of the Cozy of one recipient. The sharer will register its-self as an OAuth client on the recipient cozy, and then will ask the recipient to accept the permissions on its instance. This route exists in two versions, the version is selected by the HTTP header Accept Classical ( x-www-url-encoded ) Parameter Description state a code that identify the recipient url the URL of the Cozy for the recipient Example POST /sharings/ce8835a061d0ef68947afe69a0046722/discovery HTTP/1.1 Host: alice.example.org Content-Type: application/x-www-form-urlencoded Accept: text/html state=eiJ3iepoaihohz1Y url=https://bob.example.net/ HTTP/1.1 302 Moved Temporarily Location: https://bob.example.net/auth/sharing?... JSON This version can be more convenient for applications that implement the preview page. To do that, an application must give a preview_path when creating the sharing. This path must be a public route of this application. The recipients will receive a link to the application subdomain, on this page, and with a sharecode in the query string (like for a share by link). To know the sharing-id , it s possible to ask GET /permissions/self , with the sharecode in the Authorization header (it s a JWT token). In the response, the source_id field will be io.cozy.sharings/ sharing-id . Parameters Parameter Description sharecode a code that identify the recipient url the URL of the Cozy for the recipient Example POST /sharings/ce8835a061d0ef68947afe69a0046722/discovery HTTP/1.1 Host: alice.example.org Content-Type: application/x-www-form-urlencoded Accept: application/json sharecode=eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhcHAiLCJpYXQiOjE1MjAzNDM4NTc url=https://bob.example.net/ HTTP/1.1 200 OK Content-Type: application/json { redirect : https://bob.example.net/auth/sharing?... } GET /sharings/:sharing-id Get the information about a sharing. This includes the content of the rules, the members, as well as the already shared documents for this sharing. For a member, we can have the following fields: a contact name ( name ), that is the name of this user as it appears in its contact document (if there is one such document) a public name ( public_name ), that is the name this user has put on his cozy as a public name (it is used for sending emails for example) an email addresse ( email ) an instance URL ( instance ) and a status ( status ). Notes: the first member is always the sharer to display the list of members to a user, the name should be use if available, and if it is not the case, you can use the public_name or the email on a recipient, the only member with an instance is the local user. Request GET /sharings/ce8835a061d0ef68947afe69a0046722 HTTP/1.1 Host: alice.example.net Accept: application/vnd.api+json Response HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { type : io.cozy.sharings , id : ce8835a061d0ef68947afe69a0046722 , meta : { rev : 1-4859c6c755143adf0838d225c5e97882 }, attributes : { description : sharing test , preview_path : /preview-sharing , app_slug : drive , owner : true, created_at : 2018-01-04T12:35:08Z , updated_at : 2018-01-04T13:45:43Z , members : [ { status : owner , public_name : Alice , email : alice@example.net , instance : alice.example.net }, { status : ready , name : Bob , email : bob@example.net } ], rules : [ { title : Hawaii , doctype : io.cozy.files , values : [ 612acf1c-1d72-11e8-b043-ef239d3074dd ], add : sync , update : sync , remove : sync } ] }, relationships : { shared_docs : { data : [ { id : 612acf1c-1d72-11e8-b043-ef239d3074dd , type : io.cozy.files }, { id : a34528d2-13fb-9482-8d20-bf1972531225 , type : io.cozy.files } ] } }, links : { self : /sharings/ce8835a061d0ef68947afe69a0046722 } } } GET /sharings/doctype/:doctype Get information about all the sharings that have a rule for the given doctype. This includes the content of the rules, the members, as well as the already shared documents for this sharing. Request GET /sharings/doctype/io.cozy.files HTTP/1.1 Host: alice.example.net Accept: application/vnd.api+json Response HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : [ { type : io.cozy.sharings , id : ce8835a061d0ef68947afe69a0046722 , attributes : { description : sharing test , preview_path : /preview-sharing , app_slug : drive , owner : true, created_at : 2018-01-04T12:35:08Z , updated_at : 2018-01-04T13:45:43Z , members : [ { status : owner , public_name : Alice , email : alice@example.net , instance : alice.example.net }, { status : ready , name : Bob , email : bob@example.net } ], rules : [ { title : Hawaii , doctype : io.cozy.files , values : [ 612acf1c-1d72-11e8-b043-ef239d3074dd ], add : sync , update : sync , remove : sync } ] }, meta : { rev : 1-4859c6c755143adf0838d225c5e97882 }, links : { self : /sharings/ce8835a061d0ef68947afe69a0046722 }, relationships : { shared_docs : { data : [ { id : 612acf1c-1d72-11e8-b043-ef239d3074dd , type : io.cozy.files }, { id : a34528d2-13fb-9482-8d20-bf1972531225 , type : io.cozy.files } ] } } }, { type : io.cozy.sharings , id : b4e58d039c03d01742085de5e505284e , attributes : { description : another sharing test , preview_path : /preview-sharing , app_slug : drive , owner : true, created_at : 2018-02-04T12:35:08Z , updated_at : 2018-02-04T13:45:43Z , members : [ { status : owner , public_name : Alice , email : alice@example.net , instance : alice.example.net }, { status : ready , name : Bob , email : bob@example.net } ], rules : [ { title : Singapore , doctype : io.cozy.files , values : [ e18e30e2-8eda-1bde-afce-edafc6b1a91b ], add : sync , update : sync , remove : sync } ] }, meta : { rev : 1-7ac5f1252a0c513186a5d35b1a6fd350 }, links : { self : /sharings/b4e58d039c03d01742085de5e505284e }, relationships : { shared_docs : { data : [ { id : dcc52bee-1277-a6b3-b36f-369ffd81a4ee , type : io.cozy.files } ] } } } ], meta : { count : 3 } } PUT /sharings/:sharing-id The sharer s cozy sends a request to this route on the recipient s cozy to create a sharing request, with most of the information about the sharing. This request will be displayed to the recipient just before its final acceptation of the sharing, to be sure he/she knows what will be shared. Request PUT /sharings/ce8835a061d0ef68947afe69a0046722 HTTP/1.1 Host: bob.example.net Content-Type: application/vnd.api+json { data : { type : io.cozy.sharings , id : ce8835a061d0ef68947afe69a0046722 , attributes : { description : sharing test , preview_path : /preview-sharing , app_slug : drive , owner : true, created_at : 2018-01-04T12:35:08Z , updated_at : 2018-01-04T13:45:43Z , members : [ { status : owner , public_name : Alice , email : alice@example.net , instance : alice.example.net }, { status : mail-not-sent , email : bob@example.net , instance : bob.example.net } ], rules : [ { title : Hawaii , doctype : io.cozy.files , values : [ 612acf1c-1d72-11e8-b043-ef239d3074dd ], add : sync , update : sync , remove : sync } ] } } } Response HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { type : io.cozy.sharings , id : ce8835a061d0ef68947afe69a0046722 , meta : { rev : 1-f579a69a9fa5dd720010a1dbb82320be }, attributes : { description : sharing test , preview_path : /preview-sharing , app_slug : drive , owner : true, created_at : 2018-01-04T12:35:08Z , updated_at : 2018-01-04T13:45:43Z , members : [ { status : owner , public_name : Alice , email : alice@example.net , instance : alice.example.net }, { status : mail-not-sent , name : Bob , email : bob@example.net , instance : bob.example.net } ], rules : [ { title : Hawaii , doctype : io.cozy.files , values : [ 612acf1c-1d72-11e8-b043-ef239d3074dd ], add : sync , update : sync , remove : sync } ] }, links : { self : /sharings/ce8835a061d0ef68947afe69a0046722 } } } POST /sharings/:sharing-id/answer This route is used by the Cozy of a recipient to exchange credentials with the Cozy of the sharer, after the recipient has accepted a sharing. Request POST /sharings/ce8835a061d0ef68947afe69a0046722/answer HTTP/1.1 Host: alice.example.net Content-Type: application/vnd.api+json { data : { type : io.cozy.sharings.answer , id : ce8835a061d0ef68947afe69a0046722 , attributes : { public_name : Bob , state : eiJ3iepoaihohz1Y , client : {...}, access_token : uia7b85928e5cf } } } Response HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { type : io.cozy.sharings.answer , id : ce8835a061d0ef68947afe69a0046722 , attributes : { client : {...}, access_token : ui77bd4670fbd3 } } } POST /sharings/:sharing-id/recipient This route allow to the sharer to add a new recipient to a sharing. Request POST /sharings/ce8835a061d0ef68947afe69a0046722/recipients HTTP/1.1 Host: alice.example.net Content-Type: application/vnd.api+json { data : { type : io.cozy.sharings.sharings , id : ce8835a061d0ef68947afe69a0046722 , relationships : { recipients : { data : [ { id : ce7b1dfbd460039159f228298a29b2aa , type : io.cozy.contacts } ] } } } } Response HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { type : io.cozy.sharings , id : ce8835a061d0ef68947afe69a0046722 , meta : { rev : 1-4859c6c755143adf0838d225c5e97882 }, attributes : { description : sharing test , preview_path : /preview-sharing , app_slug : drive , owner : true, created_at : 2018-01-04T12:35:08Z , updated_at : 2018-01-04T13:45:43Z , members : [ { status : owner , public_name : Alice , email : alice@example.net , instance : alice.example.net }, { status : ready , name : Bob , public_name : Bob , email : bob@example.net }, { status : pending , name : Charlie , email : charlie@example.net } ], rules : [ { title : Hawaii , doctype : io.cozy.files , values : [ 612acf1c-1d72-11e8-b043-ef239d3074dd ], add : sync , update : sync , remove : sync } ] }, relationships : { shared_docs : { data : [ { id : 612acf1c-1d72-11e8-b043-ef239d3074dd , type : io.cozy.files }, { id : a34528d2-13fb-9482-8d20-bf1972531225 , type : io.cozy.files } ] } }, links : { self : /sharings/ce8835a061d0ef68947afe69a0046722 } } } PUT /sharings/:sharing-id/recipients This internal route is used to update the list of members, their states and names, on the recipients cozy. Request PUT /sharings/ce8835a061d0ef68947afe69a0046722/recipients HTTP/1.1 Host: bob.example.net Content-Type: application/vnd.api+json { data : [ { status : owner , public_name : Alice , email : alice@example.net , instance : alice.example.net }, { status : ready , name : Bob , public_name : Bob , email : bob@example.net }, { status : ready , name : Charlie , public_name : Charlie , email : charlie@example.net } ] } Response HTTP/1.1 204 No Content DELETE /sharings/:sharing-id/recipients This route is used by an application on the owner s cozy to revoke the sharing for all the members. After that, the sharing active flag will be false, the credentials for all members will be revoked, the members that have accepted the sharing will have their cozy informed that the sharing has been revoked, and pending members can no longer accept this sharing. Request DELETE /sharings/ce8835a061d0ef68947afe69a0046722/recipients HTTP/1.1 Host: alice.example.net Response HTTP/1.1 204 No Content DELETE /sharings/:sharing-id/recipients/:index This route is used to revoke only one recipient of the sharing. The parameter is the index of this recipient in the members array of the sharing. The status for this member will be set to revoked , its cozy will be informed of the revokation, and the credentials for this cozy will be deleted. Note : 0 is not accepted for index , as it is the sharer him-self. Request DELETE /sharings/ce8835a061d0ef68947afe69a0046722/recipients/1 HTTP/1.1 Host: alice.example.net Response HTTP/1.1 204 No Content DELETE /sharings/:sharing-id/recipients/self This route can be used by an application in the cozy of a recipient to remove it from the sharing. Request DELETE /sharings/ce8835a061d0ef68947afe69a0046722/recipients/self HTTP/1.1 Host: bob.example.net Response HTTP/1.1 204 No Content DELETE /sharings/:sharing-id This is an internal route used by the cozy of the sharing s owner to inform a recipient s cozy that it was revoked. Request DELETE /sharings/ce8835a061d0ef68947afe69a0046722 HTTP/1.1 Host: bob.example.net Response HTTP/1.1 204 No Content DELETE /sharings/:sharing-id/answer This is an internal route used by a recipient s cozy to inform the owner s cozy that this recipient no longer wants to be part of the sharing. Request DELETE /sharings/ce8835a061d0ef68947afe69a0046722/answer HTTP/1.1 Host: alice.example.net Response HTTP/1.1 204 No Content POST /sharings/:sharing-id/_revs_diff This endpoint is used by the sharing replicator of the stack to know which documents must be sent to the other cozy. It is inspired by http://docs.couchdb.org/en/2.1.1/api/database/misc.html#db-revs-diff. Request POST /sharings/ce8835a061d0ef68947afe69a0046722/_revs_diff HTTP/1.1 Host: bob.example.net Accept: application/json Content-Type: application/json Authorization: Bearer ... { io.cozy.files/29631902-2cec-11e8-860d-435b24c2cc58 : [ 2-4a7e4ae49c4366eaed8edeaea8f784ad ], io.cozy.files/44f5752a-2cec-11e8-b227-abfc3cfd4b6e : [ 4-2ee767305024673cfb3f5af037cd2729 , 4-efc54218773c6acd910e2e97fea2a608 ] } Response HTTP/1.1 200 OK Content-Type: application/json { io.cozy.files/44f5752a-2cec-11e8-b227-abfc3cfd4b6e : { missing : [ 4-2ee767305024673cfb3f5af037cd2729 ], possible_ancestors : [ 3-753875d51501a6b1883a9d62b4d33f91 ] } } POST /sharings/:sharing-id/_bulk_docs This endpoint is used by the sharing replicator of the stack to send documents in a bulk to the other cozy. It is inspired by http://docs.couchdb.org/en/2.1.1/api/database/bulk-api.html#db-bulk-docs. Note : we force new_edits to false . Request POST /sharings/ce8835a061d0ef68947afe69a0046722/_bulk_docs HTTP/1.1 Host: bob.example.net Accept: application/json Content-Type: application/json Authorization: Bearer ... { io.cozy.files : [ { _id : 44f5752a-2cec-11e8-b227-abfc3cfd4b6e , _rev : 4-2ee767305024673cfb3f5af037cd2729 , _revisions : { start : 4, ids : [ 2ee767305024673cfb3f5af037cd2729 , 753875d51501a6b1883a9d62b4d33f91 ] } } ] } Response HTTP/1.1 200 OK Content-Type: application/json [] GET /sharings/:sharing-id/io.cozy.files/:file-id This is an internal endpoint used by a stack to get information about a folder. It is used when a cozy sent to another cozy a file or folder inside a folder that was trashed (and trash was emptied): the recipient does no longer have information about the parent directory. To resolve the conflict, it recreates the missing parent directory by asking the other cozy informations about it. Request GET /sharings/ce8835a061d0ef68947afe69a0046722/io.cozy.files/6d245d072be5522bd3a6f273dd000c65 HTTP/1.1 Host: alice.example.net Accept: application/json Authorization: Bearer ... Response HTTP/1.1 200 OK Content-Type: application/json { _id : 6d245d072be5522bd3a6f273dd000c65 , _rev : 1-de4ec176ffa9ddafe8bdcc739dc60fed , type : directory , name : phone , dir_id : 6d245d072be5522bd3a6f273dd007396 , created_at : 2016-09-19T12:35:08Z , updated_at : 2016-09-19T12:35:08Z , tags : [ bills ] } PUT /sharings/:sharing-id/io.cozy.files/:file-id/metadata This is an internal endpoint used by a stack to send the new metadata about a file that has changed. Request PUT /sharings/ce8835a061d0ef68947afe69a0046722/io.cozy.files/0c1116b028c6ae6f5cdafb949c088265/metadata HTTP/1.1 Host: bob.example.net Accept: application/json Content-Type: application/json Authorization: Bearer ... { _id : 4b24ab130b2538b7b444fc65430198ad , _rev : 1-356bf77c03baa1da851a2be1f06aba81 , _revisions : { start : 1, ids : [ 356bf77c03baa1da851a2be1f06aba81 ] }, type : file , name : cloudy.jpg , dir_id : 4b24ab130b2538b7b444fc65430188cd , created_at : 2018-01-03T16:10:36.885807013+01:00 , updated_at : 2018-01-03T16:10:36.885807013+01:00 , size : 84980 , md5sum : SuRJOiD/QPwDUpKpQujcVA== , mime : image/jpeg , class : image , executable : false, trashed : false, tags : [], metadata : { datetime : 2018-01-03T16:10:36.89118949+01:00 , extractor_version : 2, height : 1200, width : 1600 } } Response If only the metadata has changed (not the content), the response will be a 204: HTTP/1.1 204 No Content Else, the content will need to be uploaded: HTTP/1.1 200 OK Content-Type: application/json { key : dcd478c6-46cf-11e8-9c3f-535468cbce7b } PUT /sharings/:sharing-id/io.cozy.files/:key Upload the content of a file (new file or its content has changed since the last synchronization). Request PUT /sharings/ce8835a061d0ef68947afe69a0046722/io.cozy.files/dcd478c6-46cf-11e8-9c3f-535468cbce7b HTTP/1.1 Host: bob.example.net Content-Type: image/jpeg Authorization: Bearer ... Response HTTP/1.1 204 No Content","title":"/sharings - Sharing"},{"location":"/cozy-stack/sharing/#sharing","text":"The owner of a cozy instance can share access to her documents to other users.","title":"Sharing"},{"location":"/cozy-stack/sharing/#sharing-by-links","text":"A client-side application can propose sharing by links: The application must have a public route in its manifest. See Apps documentation for how to do that. The application can create a set of permissions for the shared documents, with codes. See permissions documentation for the details. The application can then create a shareable link (e.g. https://calendar.cozy.example.net/public?sharecode=eiJ3iepoaihohz1Y ) by putting together the app sub-domain, the public route path, and a code for the permissions set. The app can then send this link by mail, via the jobs system , or just give it to the user, so he can transmit it to her friends via chat or other ways. When someone opens the shared link, the stack will load the public route, find the corresponding index.html file, and replace {{.Token}} inside it by a token with the same set of permissions that sharecode offers. This token can then be used as a Bearer token in the Authorization header for requests to the stack (or via cozy-client-js). If necessary, the application can list the permissions for the token by calling /permissions/self with this token.","title":"Sharing by links"},{"location":"/cozy-stack/sharing/#cozy-to-cozy-sharing","text":"The owner of a cozy instance can send and synchronize documents to others cozy users.","title":"Cozy to cozy sharing"},{"location":"/cozy-stack/sharing/#routes","text":"","title":"Routes"},{"location":"/cozy-stack/sharing/#post-sharings","text":"Create a new sharing. The sharing rules and recipients must be specified. The description , preview_path , and open_sharing fields are optional. The app_slug field is optional and is the slug of the web app by default. To create a sharing, no permissions on io.cozy.sharings are needed: an application can create a sharing on the documents for whose it has a permission.","title":"POST /sharings/"},{"location":"/cozy-stack/sharing/#request","text":"POST /sharings/ HTTP/1.1 Host: alice.example.net Content-Type: application/vnd.api+json { data : { type : io.cozy.sharings , attributes : { description : sharing test , preview_path : /preview-sharing , rules : [ { title : Hawaii , doctype : io.cozy.files , values : [ 612acf1c-1d72-11e8-b043-ef239d3074dd ], add : sync , update : sync , remove : sync } ] }, relationships : { recipients : { data : [ { id : 2a31ce0128b5f89e40fd90da3f014087 , type : io.cozy.contacts } ] } } } }","title":"Request"},{"location":"/cozy-stack/sharing/#response","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { type : io.cozy.sharings , id : ce8835a061d0ef68947afe69a0046722 , meta : { rev : 1-4859c6c755143adf0838d225c5e97882 }, attributes : { description : sharing test , preview_path : /preview-sharing , app_slug : drive , owner : true, created_at : 2018-01-04T12:35:08Z , updated_at : 2018-01-04T13:45:43Z , members : [ { status : owner , public_name : Alice , email : alice@example.net , instance : alice.example.net }, { status : mail-not-sent , name : Bob , email : bob@example.net } ], rules : [ { title : Hawaii , doctype : io.cozy.files , values : [ 612acf1c-1d72-11e8-b043-ef239d3074dd ], add : sync , update : sync , remove : sync } ] }, links : { self : /sharings/ce8835a061d0ef68947afe69a0046722 } } }","title":"Response"},{"location":"/cozy-stack/sharing/#get-sharingssharing-iddiscovery","text":"If no preview_path is set, it s an URL to this route that will be sent to the users to notify them that someone wants to share something with them. On this page, they can fill the URL of their Cozy (if the user has already filled its Cozy URL in a previous sharing, the form will be pre-filled and the user will just have to click OK).","title":"GET /sharings/:sharing-id/discovery"},{"location":"/cozy-stack/sharing/#query-string","text":"Parameter Description state a code that identify the recipient","title":"Query-String"},{"location":"/cozy-stack/sharing/#example","text":"GET /sharings/ce8835a061d0ef68947afe69a0046722/discovery?state=eiJ3iepoaihohz1Y HTTP/1.1 Host: alice.example.net","title":"Example"},{"location":"/cozy-stack/sharing/#post-sharingssharing-iddiscovery","text":"Give to the cozy of the sharer the URL of the Cozy of one recipient. The sharer will register its-self as an OAuth client on the recipient cozy, and then will ask the recipient to accept the permissions on its instance. This route exists in two versions, the version is selected by the HTTP header Accept","title":"POST /sharings/:sharing-id/discovery"},{"location":"/cozy-stack/sharing/#classical-x-www-url-encoded","text":"Parameter Description state a code that identify the recipient url the URL of the Cozy for the recipient","title":"Classical (x-www-url-encoded)"},{"location":"/cozy-stack/sharing/#example_1","text":"POST /sharings/ce8835a061d0ef68947afe69a0046722/discovery HTTP/1.1 Host: alice.example.org Content-Type: application/x-www-form-urlencoded Accept: text/html state=eiJ3iepoaihohz1Y url=https://bob.example.net/ HTTP/1.1 302 Moved Temporarily Location: https://bob.example.net/auth/sharing?...","title":"Example"},{"location":"/cozy-stack/sharing/#json","text":"This version can be more convenient for applications that implement the preview page. To do that, an application must give a preview_path when creating the sharing. This path must be a public route of this application. The recipients will receive a link to the application subdomain, on this page, and with a sharecode in the query string (like for a share by link). To know the sharing-id , it s possible to ask GET /permissions/self , with the sharecode in the Authorization header (it s a JWT token). In the response, the source_id field will be io.cozy.sharings/ sharing-id .","title":"JSON"},{"location":"/cozy-stack/sharing/#parameters","text":"Parameter Description sharecode a code that identify the recipient url the URL of the Cozy for the recipient","title":"Parameters"},{"location":"/cozy-stack/sharing/#example_2","text":"POST /sharings/ce8835a061d0ef68947afe69a0046722/discovery HTTP/1.1 Host: alice.example.org Content-Type: application/x-www-form-urlencoded Accept: application/json sharecode=eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhcHAiLCJpYXQiOjE1MjAzNDM4NTc url=https://bob.example.net/ HTTP/1.1 200 OK Content-Type: application/json { redirect : https://bob.example.net/auth/sharing?... }","title":"Example"},{"location":"/cozy-stack/sharing/#get-sharingssharing-id","text":"Get the information about a sharing. This includes the content of the rules, the members, as well as the already shared documents for this sharing. For a member, we can have the following fields: a contact name ( name ), that is the name of this user as it appears in its contact document (if there is one such document) a public name ( public_name ), that is the name this user has put on his cozy as a public name (it is used for sending emails for example) an email addresse ( email ) an instance URL ( instance ) and a status ( status ). Notes: the first member is always the sharer to display the list of members to a user, the name should be use if available, and if it is not the case, you can use the public_name or the email on a recipient, the only member with an instance is the local user.","title":"GET /sharings/:sharing-id"},{"location":"/cozy-stack/sharing/#request_1","text":"GET /sharings/ce8835a061d0ef68947afe69a0046722 HTTP/1.1 Host: alice.example.net Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/sharing/#response_1","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { type : io.cozy.sharings , id : ce8835a061d0ef68947afe69a0046722 , meta : { rev : 1-4859c6c755143adf0838d225c5e97882 }, attributes : { description : sharing test , preview_path : /preview-sharing , app_slug : drive , owner : true, created_at : 2018-01-04T12:35:08Z , updated_at : 2018-01-04T13:45:43Z , members : [ { status : owner , public_name : Alice , email : alice@example.net , instance : alice.example.net }, { status : ready , name : Bob , email : bob@example.net } ], rules : [ { title : Hawaii , doctype : io.cozy.files , values : [ 612acf1c-1d72-11e8-b043-ef239d3074dd ], add : sync , update : sync , remove : sync } ] }, relationships : { shared_docs : { data : [ { id : 612acf1c-1d72-11e8-b043-ef239d3074dd , type : io.cozy.files }, { id : a34528d2-13fb-9482-8d20-bf1972531225 , type : io.cozy.files } ] } }, links : { self : /sharings/ce8835a061d0ef68947afe69a0046722 } } }","title":"Response"},{"location":"/cozy-stack/sharing/#get-sharingsdoctypedoctype","text":"Get information about all the sharings that have a rule for the given doctype. This includes the content of the rules, the members, as well as the already shared documents for this sharing.","title":"GET /sharings/doctype/:doctype"},{"location":"/cozy-stack/sharing/#request_2","text":"GET /sharings/doctype/io.cozy.files HTTP/1.1 Host: alice.example.net Accept: application/vnd.api+json","title":"Request"},{"location":"/cozy-stack/sharing/#response_2","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : [ { type : io.cozy.sharings , id : ce8835a061d0ef68947afe69a0046722 , attributes : { description : sharing test , preview_path : /preview-sharing , app_slug : drive , owner : true, created_at : 2018-01-04T12:35:08Z , updated_at : 2018-01-04T13:45:43Z , members : [ { status : owner , public_name : Alice , email : alice@example.net , instance : alice.example.net }, { status : ready , name : Bob , email : bob@example.net } ], rules : [ { title : Hawaii , doctype : io.cozy.files , values : [ 612acf1c-1d72-11e8-b043-ef239d3074dd ], add : sync , update : sync , remove : sync } ] }, meta : { rev : 1-4859c6c755143adf0838d225c5e97882 }, links : { self : /sharings/ce8835a061d0ef68947afe69a0046722 }, relationships : { shared_docs : { data : [ { id : 612acf1c-1d72-11e8-b043-ef239d3074dd , type : io.cozy.files }, { id : a34528d2-13fb-9482-8d20-bf1972531225 , type : io.cozy.files } ] } } }, { type : io.cozy.sharings , id : b4e58d039c03d01742085de5e505284e , attributes : { description : another sharing test , preview_path : /preview-sharing , app_slug : drive , owner : true, created_at : 2018-02-04T12:35:08Z , updated_at : 2018-02-04T13:45:43Z , members : [ { status : owner , public_name : Alice , email : alice@example.net , instance : alice.example.net }, { status : ready , name : Bob , email : bob@example.net } ], rules : [ { title : Singapore , doctype : io.cozy.files , values : [ e18e30e2-8eda-1bde-afce-edafc6b1a91b ], add : sync , update : sync , remove : sync } ] }, meta : { rev : 1-7ac5f1252a0c513186a5d35b1a6fd350 }, links : { self : /sharings/b4e58d039c03d01742085de5e505284e }, relationships : { shared_docs : { data : [ { id : dcc52bee-1277-a6b3-b36f-369ffd81a4ee , type : io.cozy.files } ] } } } ], meta : { count : 3 } }","title":"Response"},{"location":"/cozy-stack/sharing/#put-sharingssharing-id","text":"The sharer s cozy sends a request to this route on the recipient s cozy to create a sharing request, with most of the information about the sharing. This request will be displayed to the recipient just before its final acceptation of the sharing, to be sure he/she knows what will be shared.","title":"PUT /sharings/:sharing-id"},{"location":"/cozy-stack/sharing/#request_3","text":"PUT /sharings/ce8835a061d0ef68947afe69a0046722 HTTP/1.1 Host: bob.example.net Content-Type: application/vnd.api+json { data : { type : io.cozy.sharings , id : ce8835a061d0ef68947afe69a0046722 , attributes : { description : sharing test , preview_path : /preview-sharing , app_slug : drive , owner : true, created_at : 2018-01-04T12:35:08Z , updated_at : 2018-01-04T13:45:43Z , members : [ { status : owner , public_name : Alice , email : alice@example.net , instance : alice.example.net }, { status : mail-not-sent , email : bob@example.net , instance : bob.example.net } ], rules : [ { title : Hawaii , doctype : io.cozy.files , values : [ 612acf1c-1d72-11e8-b043-ef239d3074dd ], add : sync , update : sync , remove : sync } ] } } }","title":"Request"},{"location":"/cozy-stack/sharing/#response_3","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { type : io.cozy.sharings , id : ce8835a061d0ef68947afe69a0046722 , meta : { rev : 1-f579a69a9fa5dd720010a1dbb82320be }, attributes : { description : sharing test , preview_path : /preview-sharing , app_slug : drive , owner : true, created_at : 2018-01-04T12:35:08Z , updated_at : 2018-01-04T13:45:43Z , members : [ { status : owner , public_name : Alice , email : alice@example.net , instance : alice.example.net }, { status : mail-not-sent , name : Bob , email : bob@example.net , instance : bob.example.net } ], rules : [ { title : Hawaii , doctype : io.cozy.files , values : [ 612acf1c-1d72-11e8-b043-ef239d3074dd ], add : sync , update : sync , remove : sync } ] }, links : { self : /sharings/ce8835a061d0ef68947afe69a0046722 } } }","title":"Response"},{"location":"/cozy-stack/sharing/#post-sharingssharing-idanswer","text":"This route is used by the Cozy of a recipient to exchange credentials with the Cozy of the sharer, after the recipient has accepted a sharing.","title":"POST /sharings/:sharing-id/answer"},{"location":"/cozy-stack/sharing/#request_4","text":"POST /sharings/ce8835a061d0ef68947afe69a0046722/answer HTTP/1.1 Host: alice.example.net Content-Type: application/vnd.api+json { data : { type : io.cozy.sharings.answer , id : ce8835a061d0ef68947afe69a0046722 , attributes : { public_name : Bob , state : eiJ3iepoaihohz1Y , client : {...}, access_token : uia7b85928e5cf } } }","title":"Request"},{"location":"/cozy-stack/sharing/#response_4","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { type : io.cozy.sharings.answer , id : ce8835a061d0ef68947afe69a0046722 , attributes : { client : {...}, access_token : ui77bd4670fbd3 } } }","title":"Response"},{"location":"/cozy-stack/sharing/#post-sharingssharing-idrecipient","text":"This route allow to the sharer to add a new recipient to a sharing.","title":"POST /sharings/:sharing-id/recipient"},{"location":"/cozy-stack/sharing/#request_5","text":"POST /sharings/ce8835a061d0ef68947afe69a0046722/recipients HTTP/1.1 Host: alice.example.net Content-Type: application/vnd.api+json { data : { type : io.cozy.sharings.sharings , id : ce8835a061d0ef68947afe69a0046722 , relationships : { recipients : { data : [ { id : ce7b1dfbd460039159f228298a29b2aa , type : io.cozy.contacts } ] } } } }","title":"Request"},{"location":"/cozy-stack/sharing/#response_5","text":"HTTP/1.1 200 OK Content-Type: application/vnd.api+json { data : { type : io.cozy.sharings , id : ce8835a061d0ef68947afe69a0046722 , meta : { rev : 1-4859c6c755143adf0838d225c5e97882 }, attributes : { description : sharing test , preview_path : /preview-sharing , app_slug : drive , owner : true, created_at : 2018-01-04T12:35:08Z , updated_at : 2018-01-04T13:45:43Z , members : [ { status : owner , public_name : Alice , email : alice@example.net , instance : alice.example.net }, { status : ready , name : Bob , public_name : Bob , email : bob@example.net }, { status : pending , name : Charlie , email : charlie@example.net } ], rules : [ { title : Hawaii , doctype : io.cozy.files , values : [ 612acf1c-1d72-11e8-b043-ef239d3074dd ], add : sync , update : sync , remove : sync } ] }, relationships : { shared_docs : { data : [ { id : 612acf1c-1d72-11e8-b043-ef239d3074dd , type : io.cozy.files }, { id : a34528d2-13fb-9482-8d20-bf1972531225 , type : io.cozy.files } ] } }, links : { self : /sharings/ce8835a061d0ef68947afe69a0046722 } } }","title":"Response"},{"location":"/cozy-stack/sharing/#put-sharingssharing-idrecipients","text":"This internal route is used to update the list of members, their states and names, on the recipients cozy.","title":"PUT /sharings/:sharing-id/recipients"},{"location":"/cozy-stack/sharing/#request_6","text":"PUT /sharings/ce8835a061d0ef68947afe69a0046722/recipients HTTP/1.1 Host: bob.example.net Content-Type: application/vnd.api+json { data : [ { status : owner , public_name : Alice , email : alice@example.net , instance : alice.example.net }, { status : ready , name : Bob , public_name : Bob , email : bob@example.net }, { status : ready , name : Charlie , public_name : Charlie , email : charlie@example.net } ] }","title":"Request"},{"location":"/cozy-stack/sharing/#response_6","text":"HTTP/1.1 204 No Content","title":"Response"},{"location":"/cozy-stack/sharing/#delete-sharingssharing-idrecipients","text":"This route is used by an application on the owner s cozy to revoke the sharing for all the members. After that, the sharing active flag will be false, the credentials for all members will be revoked, the members that have accepted the sharing will have their cozy informed that the sharing has been revoked, and pending members can no longer accept this sharing.","title":"DELETE /sharings/:sharing-id/recipients"},{"location":"/cozy-stack/sharing/#request_7","text":"DELETE /sharings/ce8835a061d0ef68947afe69a0046722/recipients HTTP/1.1 Host: alice.example.net","title":"Request"},{"location":"/cozy-stack/sharing/#response_7","text":"HTTP/1.1 204 No Content","title":"Response"},{"location":"/cozy-stack/sharing/#delete-sharingssharing-idrecipientsindex","text":"This route is used to revoke only one recipient of the sharing. The parameter is the index of this recipient in the members array of the sharing. The status for this member will be set to revoked , its cozy will be informed of the revokation, and the credentials for this cozy will be deleted. Note : 0 is not accepted for index , as it is the sharer him-self.","title":"DELETE /sharings/:sharing-id/recipients/:index"},{"location":"/cozy-stack/sharing/#request_8","text":"DELETE /sharings/ce8835a061d0ef68947afe69a0046722/recipients/1 HTTP/1.1 Host: alice.example.net","title":"Request"},{"location":"/cozy-stack/sharing/#response_8","text":"HTTP/1.1 204 No Content","title":"Response"},{"location":"/cozy-stack/sharing/#delete-sharingssharing-idrecipientsself","text":"This route can be used by an application in the cozy of a recipient to remove it from the sharing.","title":"DELETE /sharings/:sharing-id/recipients/self"},{"location":"/cozy-stack/sharing/#request_9","text":"DELETE /sharings/ce8835a061d0ef68947afe69a0046722/recipients/self HTTP/1.1 Host: bob.example.net","title":"Request"},{"location":"/cozy-stack/sharing/#response_9","text":"HTTP/1.1 204 No Content","title":"Response"},{"location":"/cozy-stack/sharing/#delete-sharingssharing-id","text":"This is an internal route used by the cozy of the sharing s owner to inform a recipient s cozy that it was revoked.","title":"DELETE /sharings/:sharing-id"},{"location":"/cozy-stack/sharing/#request_10","text":"DELETE /sharings/ce8835a061d0ef68947afe69a0046722 HTTP/1.1 Host: bob.example.net","title":"Request"},{"location":"/cozy-stack/sharing/#response_10","text":"HTTP/1.1 204 No Content","title":"Response"},{"location":"/cozy-stack/sharing/#delete-sharingssharing-idanswer","text":"This is an internal route used by a recipient s cozy to inform the owner s cozy that this recipient no longer wants to be part of the sharing.","title":"DELETE /sharings/:sharing-id/answer"},{"location":"/cozy-stack/sharing/#request_11","text":"DELETE /sharings/ce8835a061d0ef68947afe69a0046722/answer HTTP/1.1 Host: alice.example.net","title":"Request"},{"location":"/cozy-stack/sharing/#response_11","text":"HTTP/1.1 204 No Content","title":"Response"},{"location":"/cozy-stack/sharing/#post-sharingssharing-id95revs_diff","text":"This endpoint is used by the sharing replicator of the stack to know which documents must be sent to the other cozy. It is inspired by http://docs.couchdb.org/en/2.1.1/api/database/misc.html#db-revs-diff.","title":"POST /sharings/:sharing-id/_revs_diff"},{"location":"/cozy-stack/sharing/#request_12","text":"POST /sharings/ce8835a061d0ef68947afe69a0046722/_revs_diff HTTP/1.1 Host: bob.example.net Accept: application/json Content-Type: application/json Authorization: Bearer ... { io.cozy.files/29631902-2cec-11e8-860d-435b24c2cc58 : [ 2-4a7e4ae49c4366eaed8edeaea8f784ad ], io.cozy.files/44f5752a-2cec-11e8-b227-abfc3cfd4b6e : [ 4-2ee767305024673cfb3f5af037cd2729 , 4-efc54218773c6acd910e2e97fea2a608 ] }","title":"Request"},{"location":"/cozy-stack/sharing/#response_12","text":"HTTP/1.1 200 OK Content-Type: application/json { io.cozy.files/44f5752a-2cec-11e8-b227-abfc3cfd4b6e : { missing : [ 4-2ee767305024673cfb3f5af037cd2729 ], possible_ancestors : [ 3-753875d51501a6b1883a9d62b4d33f91 ] } }","title":"Response"},{"location":"/cozy-stack/sharing/#post-sharingssharing-id95bulk_docs","text":"This endpoint is used by the sharing replicator of the stack to send documents in a bulk to the other cozy. It is inspired by http://docs.couchdb.org/en/2.1.1/api/database/bulk-api.html#db-bulk-docs. Note : we force new_edits to false .","title":"POST /sharings/:sharing-id/_bulk_docs"},{"location":"/cozy-stack/sharing/#request_13","text":"POST /sharings/ce8835a061d0ef68947afe69a0046722/_bulk_docs HTTP/1.1 Host: bob.example.net Accept: application/json Content-Type: application/json Authorization: Bearer ... { io.cozy.files : [ { _id : 44f5752a-2cec-11e8-b227-abfc3cfd4b6e , _rev : 4-2ee767305024673cfb3f5af037cd2729 , _revisions : { start : 4, ids : [ 2ee767305024673cfb3f5af037cd2729 , 753875d51501a6b1883a9d62b4d33f91 ] } } ] }","title":"Request"},{"location":"/cozy-stack/sharing/#response_13","text":"HTTP/1.1 200 OK Content-Type: application/json []","title":"Response"},{"location":"/cozy-stack/sharing/#get-sharingssharing-idiocozyfilesfile-id","text":"This is an internal endpoint used by a stack to get information about a folder. It is used when a cozy sent to another cozy a file or folder inside a folder that was trashed (and trash was emptied): the recipient does no longer have information about the parent directory. To resolve the conflict, it recreates the missing parent directory by asking the other cozy informations about it.","title":"GET /sharings/:sharing-id/io.cozy.files/:file-id"},{"location":"/cozy-stack/sharing/#request_14","text":"GET /sharings/ce8835a061d0ef68947afe69a0046722/io.cozy.files/6d245d072be5522bd3a6f273dd000c65 HTTP/1.1 Host: alice.example.net Accept: application/json Authorization: Bearer ...","title":"Request"},{"location":"/cozy-stack/sharing/#response_14","text":"HTTP/1.1 200 OK Content-Type: application/json { _id : 6d245d072be5522bd3a6f273dd000c65 , _rev : 1-de4ec176ffa9ddafe8bdcc739dc60fed , type : directory , name : phone , dir_id : 6d245d072be5522bd3a6f273dd007396 , created_at : 2016-09-19T12:35:08Z , updated_at : 2016-09-19T12:35:08Z , tags : [ bills ] }","title":"Response"},{"location":"/cozy-stack/sharing/#put-sharingssharing-idiocozyfilesfile-idmetadata","text":"This is an internal endpoint used by a stack to send the new metadata about a file that has changed.","title":"PUT /sharings/:sharing-id/io.cozy.files/:file-id/metadata"},{"location":"/cozy-stack/sharing/#request_15","text":"PUT /sharings/ce8835a061d0ef68947afe69a0046722/io.cozy.files/0c1116b028c6ae6f5cdafb949c088265/metadata HTTP/1.1 Host: bob.example.net Accept: application/json Content-Type: application/json Authorization: Bearer ... { _id : 4b24ab130b2538b7b444fc65430198ad , _rev : 1-356bf77c03baa1da851a2be1f06aba81 , _revisions : { start : 1, ids : [ 356bf77c03baa1da851a2be1f06aba81 ] }, type : file , name : cloudy.jpg , dir_id : 4b24ab130b2538b7b444fc65430188cd , created_at : 2018-01-03T16:10:36.885807013+01:00 , updated_at : 2018-01-03T16:10:36.885807013+01:00 , size : 84980 , md5sum : SuRJOiD/QPwDUpKpQujcVA== , mime : image/jpeg , class : image , executable : false, trashed : false, tags : [], metadata : { datetime : 2018-01-03T16:10:36.89118949+01:00 , extractor_version : 2, height : 1200, width : 1600 } }","title":"Request"},{"location":"/cozy-stack/sharing/#response_15","text":"If only the metadata has changed (not the content), the response will be a 204: HTTP/1.1 204 No Content Else, the content will need to be uploaded: HTTP/1.1 200 OK Content-Type: application/json { key : dcd478c6-46cf-11e8-9c3f-535468cbce7b }","title":"Response"},{"location":"/cozy-stack/sharing/#put-sharingssharing-idiocozyfileskey","text":"Upload the content of a file (new file or its content has changed since the last synchronization).","title":"PUT /sharings/:sharing-id/io.cozy.files/:key"},{"location":"/cozy-stack/sharing/#request_16","text":"PUT /sharings/ce8835a061d0ef68947afe69a0046722/io.cozy.files/dcd478c6-46cf-11e8-9c3f-535468cbce7b HTTP/1.1 Host: bob.example.net Content-Type: image/jpeg Authorization: Bearer ...","title":"Request"},{"location":"/cozy-stack/sharing/#response_16","text":"HTTP/1.1 204 No Content","title":"Response"},{"location":"/cozy-stack/sharing-design/","text":"Request for comments about the sharings Hypothesis A sharer may not know the adresses of the recipients cozy instances, but he/she has a way to send them an URL on his/her cozy to start the process. A user can preview a sharing before accepting it if the application supports this option. Else, he/she will have only the description and rules to make his/her mind about accepting or refusing the sharing. The data is duplicated: it is both on the owner s cozy, and on the recipients cozy (no cloud federation like NextCloud). The applications say what is shared, the stack synchronizes that. The stack does the low-level stuff and gives primitives to the applications. The applications must use them in a responsible manner, and in particular, to avoid transitivity issues. The CouchDB replication will be used to synchronize the documents. It means that the documents will be same on the owner and on the recipients ( symetric sharing ). For files and folders, the replicator will be customized to handle the specificities of the io.cozy.files doctype. The applications must be able to work with broken relationships between documents. The applications should know how to deal with CouchDB conflicts. At least, the default choice of a winner for conflicts by CouchDB should be acceptable if the applications don t do anything to detect and resolve conflicts. First safety principle: when a user B accepts a sharing from user A, the documents that were on the user B s cozy before the sharing are not sent to user A without an explicit action of user B (like moving a file to a shared directory). Second safety principle: when two users, A and B, are sharing documents, a change of a document on the user A s cozy can t make an exiting document of user B enter in the sharing. Setup of a sharing Step 1: the owner creates the sharing One person decides to share something with other people from an application on her cozy. In our example, Alice wants to share a todo list with her friends, Bob and Charlie, and it is done from the Todo application. The application calls the stack with the rules for this sharing and the identifiers of the contacts with whom to share. The stack persists an io.cozy.sharings document and sends an email to the recipients (Bob an Charlie). Step 2: a recipient accepts the sharing A recipient, let\u2019s say Bob, receives the email and clicks on the link. His browser shows him the Todo application on Alice\u2019s Cozy so that he can preview the todo list, and a modal asks him if he wants to continue the sharing acceptation workflow. If he does, a form will ask him what is the address of his Cozy (the form can be pre-filled if he has already accepted another sharing in the past). After he has filled the form and submitted it, he is redirected on his Cozy. If he is not logged in, he has to login first. Then, a page describes him how the sharing will work and what technical permissions it implies. It also asks him to confirm the sharing. If he accepts, his instance will send to Alice\u2019s instance the answer. Step 3: the initial replication starts Alice\u2019s Cozy instance creates token and sends them with other informations as the response of the answer request from Bob\u2019s instance. At this moment, both instances are ready to start to replicate data to the other instances. So, let\u2019s do the initial replication. Alice\u2019s instance starts to fill the io.cozy.shared database with all the documents that match a rule of the sharing (except the rules with local: true ), and create triggers for the future documents to be also added in this database (the exact triggers depend of the parameters of the rules). And, when done, it creates a job for the replicator, and setups a trigger for future changes in the io.cozy.shared start a replicator job. Bob\u2019s instance also checks if any document matches a sharing rule. In most cases, it won\u2019t. But in some very special cases (e.g. a previous revoked sharing on the same documents), there are some documents that match a rule. They are added to the io.cozy.shared database, but with a conflict flag. They won\u2019t be replicated unless Bob accepts to in his Todo application. Triggers are also added on Bob\u2019s instance for filling the io.cozy.shared database, and to call the replicator after that. Note: there will be a lock around the initial filling of the io.cozy.shared database to avoid concurrency issues if two recipients accept the sharing at the same time. Workflow Step 1: a todo item is added on Bob\u2019s Cozy, a trigger is fired and it adds the new document to the io.cozy.shared database Step 2: a debounced trigger on the io.cozy.shared database is used to start a replicator Step 3: the replicator does the following steps it queries a local document of the io.cozy.shared database to get the last sequence number of a successful replication with this sequence number, it requests the changes feed of io.cozy.shared with a filter on the sharing id the results is a list of document doctype + id + rev that is sent to Alice\u2019s Cozy Alice\u2019s Cozy checks which revisions are known, and send a response with the list of those that are not for each not known revision, Bob\u2019s Cozy send the document to Alice\u2019s Cozy (in bulk) and, if it\u2019s all good, it persists the new sequence number in the local document, as a start point for the next replication Step 4: the changes are put in the io.cozy.shared database on Alice\u2019s Cozy Step 5: it starts a replicator on Alice\u2019s Cozy Step 6: the replicator send the changes to Charlie\u2019s Cozy, all the cozy instances are synchronized again! Note: when a todo item is moved fron a shared todo list to a not shared todo list, the document in io.cozy.shared for the todo item is kept, and the sharing id is associated to the keyword removed inside it. The remove behavior of the sharing rule is then applied. Files and folders Why are they special? Files are special for several reasons. First and foremost, they have a binary attached to them that can be quite heavy. The stack also enforces some rules on them (e.g. a file can\u2019t be added to a deleted folder) and has some specific code for the tree nature of files and folders (e.g. a permission on a folder is inherited on all the files and folders inside it, even if they are several levels below). Thus, the workflow explained just before is not compatible with the files. As we need to introduce some code specific to the files, we have also wanted to improve the sharing of files. First, we don\u2019t want to force the recipients to put the shared folder at exactly the same place as the owner. In fact, we think that putting the shared folder in a folder called Shared with me is more friendly. We also think that a file that has been shared in the past but is no longer (the sharing has been revoked) can evolve on both the owner\u2019s cozy and on the recipients\u2019 cozy in different ways, and in such a case, it\u2019s more logical to consider them as different files. These two reasons implies, on a technical level, that the identifiers for files and folders are not the same on the owner and the recipients of a sharing. The replicator will translate the identifiers from one system to another during the replications. Of course, it will also translate the id in the sharing rules, and the dir_id to preserve the relationship between a file and its parent folder. The path attribute will be seen as a cache, and recomputed when a cozy instance receives a folder document from a sharing replication. We will continue to have a replication as close to the CouchDB replication as possible. It means we synchronize a state, and not looking for the history of operations like cozy-desktop does. It is less accurate and can lead more often to conflicts. The cozy instances are expected to be online most of the time and have a short delay for replications: we think that the conflicts will happen only on rares occasions. This make acceptable to take this shortcut. And, in case of conflicts, we will preserve the content of the files (no data loss), even if it means duplicating the files. How a sharing involving files works? When a sharing involves a rule on the io.cozy.files doctype, a folder is created on the recipients cozy where the files will be put. It is created inside the Shared with me folder by default, but can be moved somewhere else after that. The folder won\u2019t be synchronized its-self later, and if the folder is trashed, the sharing is automatically revoked. As it is not a reversible action, a confirmation is asked before doing that. Note: we will forbid the sharing of the root of the virtual file system, of the trash and trashed files/folders, and of the Shared with me folder. The step 3 described above, aka the replicator, will be more complicated for folders and files. First change, it will work on two phases: 1. what can be synchronized without transfering the binaries first, and 2. the synchronization of files with a binary attached. Second change, the replicator will acquire the Virtual File System lock on the cozy instance where it will write things to ensure the consistency of what it writes. Third change, before inserting a folder or file in the database, the replicator checks that its parent exists, and if it\u2019s not the case, it creates it. Last change, we will avoid CouchDB conflicts for files and folder by using a special conflict resolution process. Sequence diagram Conflict resolution We have several cases of conflicts: When two cozy instances have modified the same file concurrently Same for a folder When two files or folders are renamed concurrently to the same name inside the same directory When a file or folder is created or updated on cozy instance while the parent directory is trashed concurrently on another cozy instance. For 1. and 2., we will reconciliate the changes except for a file with two versions having a distinct binary (we rely on size and checksum to detect that). In such a case, we create a copy of the file with one version, while keeping the other version in the original file. For 3., we rename the file or folder with the smaller id . For 4., we restore the trashed parent, or recreate it if it the trash was emptied. Conflict with no reconciliation When a file is modified concurrently on two cozy instances, and at least one change involve the content, we can t reconciliate the modifications. To know which version of the file is the winner and will keep the same identifier, and which version is the loser and will have a new identifier, we compare the revisions and the higher wins. This conflict is particulary tricky to resolve, with a lot of subcases. In particular, we try to converge to the same revisions on all the instances for the winner file (and for the loser too). We have 3 sets of attributes for files: size and md5sum (they change when the content has changed) name and dir_id (they change when the file is moved or renamed) created_at , updated_at , tags , referenced_by , etc. For the first two sets, the operation on the Virtual File System will needs to reach the storage (Swift), not just CouchDB. For the third set, it s easy: we can do the change at the same time as another change, because these attributes are only used in CouchDB. But we can t do a change on the first two sets at the same time: the Virtual File System can t update the content and move/rename a file in the same operation. If we needs to do both, it will generate 2 revisions in CouchDB for the file. Note: you can see that using CouchDB-like replication protocol means that we have some replications that can look useless, just some echo to a writing. In fact, it is used to acknowledge the writing and is helpful for conflict resolutions. It may be conter-intuitive, but removing them will harm the stability of the system, even if they do nothing most of the time. Example 1 Here, Alice uploads a file on her Cozy. It creates two revisions for this file (it s what the Virtual File System does). Then, she shares the directory with this file to her friend Bob. When Bob accepts the sharing, the file is sent to his Cozy, with the same revision (2-2aa). Later, Bob renames the file. It creates a new revision (3-3aa). The change is replicated to Alice s Cozy. And we have a replication from Alice to Bob to ensure that every thing is fine. Even later, Alice and Bob both renames the file at the same time. It creates a conflict. We have a first replication (from Alice to Bob), but nothing happens on B because the local revision (4-4bb) is greater than the candidate revision (4-4aa) and the content is the same. Just after that, we have a revision on the opposite direction (from Bob to Alice). The candidate revision wins (4-4bb), but for files, we don t use CouchDB conflict, thus it s not possible to write a new revision at the same generation (4). The only option is to create a new revision (5-5bb). This revision is then sent to Bob: Bob s Cozy accepts the new revision even if it has no effect on the file (it was already the good name), just to resolve the conflict. Example 2 Like in the last example, Alice uploads a file and share a directory to Bob with this file, Bob acccepts. But then, several actions are made on the file in a short lapse of time and it generates a difficult conflict: Alice renames the file, and then uploads a new version with cozy-desktop Bob moves the file to a sub-directory. So, when the replication comes, we have two versions of the file with different name, parent directory, and content. The winner is the higher revision (4-4aa). The resolution takes 4 steps: A copy of the file is created from the revision 3-3bb, with the new identifier id2 = XorID(id, 3-3bb). The new content is written on Bob s Cozy: we can t use the revisions 3-3aa (same generation as 3-3bb) and 4-4aa (it will mean the conflict is fixed, but it s not the case, the filenames are still different), so a new revision is used (4-4cc). The file is moved and renamed on Bob s Cozy, with a next revision (5-5bb). The two files are sent to Alice s Cozy: 5-5bb is accepted just to resolve the conflict, and id2 is uploaded as a new file. Schema Description of a sharing An identifier (the same for all members of the sharing) A list of members . The first one is the owner. For each member, we have the URL of the cozy, a contact name, a public name, an email, a status and some credentials to authorize the transfer of data between the owner and the recipients A description (one sentence that will help people understand what is shared and why) a flag active that says if the sharing is currently active for at least one member a flag owner , true for the document on the cozy of the sharer, and false on the other cozy instance a flag open_sharing : true if any member of the sharing can add a new recipient false if only the owner can add a new recipient Some technical data ( created_at , updated_at , app_slug , preview_path , triggers , credentials ) A list of sharing rules , each rule being composed of: a title , that will be displayed to the recipients before they accept the sharing a doctype a selector (by default, it\u2019s the id ) and values (one identifier, a list of identifiers, files and folders inside a folder, files that are referenced by the same document, documents bound to a previous sharing rule) local : by default false , but it can false true for documents that are useful for the preview page but doesn\u2019t need to be send to the recipients (e.g. a setting document of the application) add : a behavior when a new document matches this rule (the document is created, or it was a document that didn\u2019t match the rule and is modified and the new version matches the rule): none : the updates are never propagated (the default) push : the updates made on the owner are sent to the recipients sync : the updates on any member are propagated to the other members update : a behavior when a document matched by this rule is modified. Can be: none : the updates are never propagated (the default) push : the updates made on the owner are sent to the recipients sync : the updates on any member are propagated to the other members remove : a behavior when a document no longer matches this rule (the document is deleted, or it was a document that matched the rule, and is modified and the new version doesn\u2019t match the rule): none : the updates are never propagated (the default) push : the updates made on the owner are sent to the recipients sync : the updates on any member are propagated to the other members revoke : the sharing is revoked. Example: I want to share a folder in read/write mode rule 1 title: folder doctype: io.cozy.files values: \"ca527016-0d83-11e8-a580-3b965c80c7f7\" add: sync update: sync remove: sync Example: I want to share a playlist where I\u2019m the only one that can add and remove items rule 1 title: playlist doctype: io.cozy.music.playlists values: \"99445b14-0d84-11e8-ae72-4b96fcbf0552\" update: none remove: revoke rule 2 title: items doctype: io.cozy.files selector: referenced_by values: \"io.cozy.files/ca527016-0d83-11e8-a580-3b965c80c7f7\" add: push update: none remove: push io.cozy.shared This doctype is an internal one for the stack. It is used to track what documents are shared, and to replicate changes from one Cozy to the others. _id : its identifier is the doctype and id of the referenced objet, separated by a / (e.g. io.cozy.contacts/c1f5dae4-0d87-11e8-b91b-1f41c005768b ) _rev : the CouchDB default revision for this document (not very meaningful, it\u2019s here to avoid concurrency issues) revisions : a tree with the last known _rev s of the referenced object infos , a map of sharing ids \u2192 {rule, removed, binary} rule says which rule from the sharing must be applied for this document removed will be true for a deleted document, a trashed file, or if the document does no longer match the sharing rule binary is a boolean flag that is true only for files (and not even folders) with removed: false","title":"Request for comments"},{"location":"/cozy-stack/sharing-design/#request-for-comments-about-the-sharings","text":"","title":"Request for comments about the sharings"},{"location":"/cozy-stack/sharing-design/#hypothesis","text":"A sharer may not know the adresses of the recipients cozy instances, but he/she has a way to send them an URL on his/her cozy to start the process. A user can preview a sharing before accepting it if the application supports this option. Else, he/she will have only the description and rules to make his/her mind about accepting or refusing the sharing. The data is duplicated: it is both on the owner s cozy, and on the recipients cozy (no cloud federation like NextCloud). The applications say what is shared, the stack synchronizes that. The stack does the low-level stuff and gives primitives to the applications. The applications must use them in a responsible manner, and in particular, to avoid transitivity issues. The CouchDB replication will be used to synchronize the documents. It means that the documents will be same on the owner and on the recipients ( symetric sharing ). For files and folders, the replicator will be customized to handle the specificities of the io.cozy.files doctype. The applications must be able to work with broken relationships between documents. The applications should know how to deal with CouchDB conflicts. At least, the default choice of a winner for conflicts by CouchDB should be acceptable if the applications don t do anything to detect and resolve conflicts. First safety principle: when a user B accepts a sharing from user A, the documents that were on the user B s cozy before the sharing are not sent to user A without an explicit action of user B (like moving a file to a shared directory). Second safety principle: when two users, A and B, are sharing documents, a change of a document on the user A s cozy can t make an exiting document of user B enter in the sharing.","title":"Hypothesis"},{"location":"/cozy-stack/sharing-design/#setup-of-a-sharing","text":"","title":"Setup of a sharing"},{"location":"/cozy-stack/sharing-design/#step-1-the-owner-creates-the-sharing","text":"One person decides to share something with other people from an application on her cozy. In our example, Alice wants to share a todo list with her friends, Bob and Charlie, and it is done from the Todo application. The application calls the stack with the rules for this sharing and the identifiers of the contacts with whom to share. The stack persists an io.cozy.sharings document and sends an email to the recipients (Bob an Charlie).","title":"Step 1: the owner creates the sharing"},{"location":"/cozy-stack/sharing-design/#step-2-a-recipient-accepts-the-sharing","text":"A recipient, let\u2019s say Bob, receives the email and clicks on the link. His browser shows him the Todo application on Alice\u2019s Cozy so that he can preview the todo list, and a modal asks him if he wants to continue the sharing acceptation workflow. If he does, a form will ask him what is the address of his Cozy (the form can be pre-filled if he has already accepted another sharing in the past). After he has filled the form and submitted it, he is redirected on his Cozy. If he is not logged in, he has to login first. Then, a page describes him how the sharing will work and what technical permissions it implies. It also asks him to confirm the sharing. If he accepts, his instance will send to Alice\u2019s instance the answer.","title":"Step 2: a recipient accepts the sharing"},{"location":"/cozy-stack/sharing-design/#step-3-the-initial-replication-starts","text":"Alice\u2019s Cozy instance creates token and sends them with other informations as the response of the answer request from Bob\u2019s instance. At this moment, both instances are ready to start to replicate data to the other instances. So, let\u2019s do the initial replication. Alice\u2019s instance starts to fill the io.cozy.shared database with all the documents that match a rule of the sharing (except the rules with local: true ), and create triggers for the future documents to be also added in this database (the exact triggers depend of the parameters of the rules). And, when done, it creates a job for the replicator, and setups a trigger for future changes in the io.cozy.shared start a replicator job. Bob\u2019s instance also checks if any document matches a sharing rule. In most cases, it won\u2019t. But in some very special cases (e.g. a previous revoked sharing on the same documents), there are some documents that match a rule. They are added to the io.cozy.shared database, but with a conflict flag. They won\u2019t be replicated unless Bob accepts to in his Todo application. Triggers are also added on Bob\u2019s instance for filling the io.cozy.shared database, and to call the replicator after that. Note: there will be a lock around the initial filling of the io.cozy.shared database to avoid concurrency issues if two recipients accept the sharing at the same time.","title":"Step 3: the initial replication starts"},{"location":"/cozy-stack/sharing-design/#workflow","text":"Step 1: a todo item is added on Bob\u2019s Cozy, a trigger is fired and it adds the new document to the io.cozy.shared database Step 2: a debounced trigger on the io.cozy.shared database is used to start a replicator Step 3: the replicator does the following steps it queries a local document of the io.cozy.shared database to get the last sequence number of a successful replication with this sequence number, it requests the changes feed of io.cozy.shared with a filter on the sharing id the results is a list of document doctype + id + rev that is sent to Alice\u2019s Cozy Alice\u2019s Cozy checks which revisions are known, and send a response with the list of those that are not for each not known revision, Bob\u2019s Cozy send the document to Alice\u2019s Cozy (in bulk) and, if it\u2019s all good, it persists the new sequence number in the local document, as a start point for the next replication Step 4: the changes are put in the io.cozy.shared database on Alice\u2019s Cozy Step 5: it starts a replicator on Alice\u2019s Cozy Step 6: the replicator send the changes to Charlie\u2019s Cozy, all the cozy instances are synchronized again! Note: when a todo item is moved fron a shared todo list to a not shared todo list, the document in io.cozy.shared for the todo item is kept, and the sharing id is associated to the keyword removed inside it. The remove behavior of the sharing rule is then applied.","title":"Workflow"},{"location":"/cozy-stack/sharing-design/#files-and-folders","text":"","title":"Files and folders"},{"location":"/cozy-stack/sharing-design/#why-are-they-special","text":"Files are special for several reasons. First and foremost, they have a binary attached to them that can be quite heavy. The stack also enforces some rules on them (e.g. a file can\u2019t be added to a deleted folder) and has some specific code for the tree nature of files and folders (e.g. a permission on a folder is inherited on all the files and folders inside it, even if they are several levels below). Thus, the workflow explained just before is not compatible with the files. As we need to introduce some code specific to the files, we have also wanted to improve the sharing of files. First, we don\u2019t want to force the recipients to put the shared folder at exactly the same place as the owner. In fact, we think that putting the shared folder in a folder called Shared with me is more friendly. We also think that a file that has been shared in the past but is no longer (the sharing has been revoked) can evolve on both the owner\u2019s cozy and on the recipients\u2019 cozy in different ways, and in such a case, it\u2019s more logical to consider them as different files. These two reasons implies, on a technical level, that the identifiers for files and folders are not the same on the owner and the recipients of a sharing. The replicator will translate the identifiers from one system to another during the replications. Of course, it will also translate the id in the sharing rules, and the dir_id to preserve the relationship between a file and its parent folder. The path attribute will be seen as a cache, and recomputed when a cozy instance receives a folder document from a sharing replication. We will continue to have a replication as close to the CouchDB replication as possible. It means we synchronize a state, and not looking for the history of operations like cozy-desktop does. It is less accurate and can lead more often to conflicts. The cozy instances are expected to be online most of the time and have a short delay for replications: we think that the conflicts will happen only on rares occasions. This make acceptable to take this shortcut. And, in case of conflicts, we will preserve the content of the files (no data loss), even if it means duplicating the files.","title":"Why are they special?"},{"location":"/cozy-stack/sharing-design/#how-a-sharing-involving-files-works","text":"When a sharing involves a rule on the io.cozy.files doctype, a folder is created on the recipients cozy where the files will be put. It is created inside the Shared with me folder by default, but can be moved somewhere else after that. The folder won\u2019t be synchronized its-self later, and if the folder is trashed, the sharing is automatically revoked. As it is not a reversible action, a confirmation is asked before doing that. Note: we will forbid the sharing of the root of the virtual file system, of the trash and trashed files/folders, and of the Shared with me folder. The step 3 described above, aka the replicator, will be more complicated for folders and files. First change, it will work on two phases: 1. what can be synchronized without transfering the binaries first, and 2. the synchronization of files with a binary attached. Second change, the replicator will acquire the Virtual File System lock on the cozy instance where it will write things to ensure the consistency of what it writes. Third change, before inserting a folder or file in the database, the replicator checks that its parent exists, and if it\u2019s not the case, it creates it. Last change, we will avoid CouchDB conflicts for files and folder by using a special conflict resolution process.","title":"How a sharing involving files works?"},{"location":"/cozy-stack/sharing-design/#sequence-diagram","text":"","title":"Sequence diagram"},{"location":"/cozy-stack/sharing-design/#conflict-resolution","text":"We have several cases of conflicts: When two cozy instances have modified the same file concurrently Same for a folder When two files or folders are renamed concurrently to the same name inside the same directory When a file or folder is created or updated on cozy instance while the parent directory is trashed concurrently on another cozy instance. For 1. and 2., we will reconciliate the changes except for a file with two versions having a distinct binary (we rely on size and checksum to detect that). In such a case, we create a copy of the file with one version, while keeping the other version in the original file. For 3., we rename the file or folder with the smaller id . For 4., we restore the trashed parent, or recreate it if it the trash was emptied.","title":"Conflict resolution"},{"location":"/cozy-stack/sharing-design/#conflict-with-no-reconciliation","text":"When a file is modified concurrently on two cozy instances, and at least one change involve the content, we can t reconciliate the modifications. To know which version of the file is the winner and will keep the same identifier, and which version is the loser and will have a new identifier, we compare the revisions and the higher wins. This conflict is particulary tricky to resolve, with a lot of subcases. In particular, we try to converge to the same revisions on all the instances for the winner file (and for the loser too). We have 3 sets of attributes for files: size and md5sum (they change when the content has changed) name and dir_id (they change when the file is moved or renamed) created_at , updated_at , tags , referenced_by , etc. For the first two sets, the operation on the Virtual File System will needs to reach the storage (Swift), not just CouchDB. For the third set, it s easy: we can do the change at the same time as another change, because these attributes are only used in CouchDB. But we can t do a change on the first two sets at the same time: the Virtual File System can t update the content and move/rename a file in the same operation. If we needs to do both, it will generate 2 revisions in CouchDB for the file. Note: you can see that using CouchDB-like replication protocol means that we have some replications that can look useless, just some echo to a writing. In fact, it is used to acknowledge the writing and is helpful for conflict resolutions. It may be conter-intuitive, but removing them will harm the stability of the system, even if they do nothing most of the time.","title":"Conflict with no reconciliation"},{"location":"/cozy-stack/sharing-design/#example-1","text":"Here, Alice uploads a file on her Cozy. It creates two revisions for this file (it s what the Virtual File System does). Then, she shares the directory with this file to her friend Bob. When Bob accepts the sharing, the file is sent to his Cozy, with the same revision (2-2aa). Later, Bob renames the file. It creates a new revision (3-3aa). The change is replicated to Alice s Cozy. And we have a replication from Alice to Bob to ensure that every thing is fine. Even later, Alice and Bob both renames the file at the same time. It creates a conflict. We have a first replication (from Alice to Bob), but nothing happens on B because the local revision (4-4bb) is greater than the candidate revision (4-4aa) and the content is the same. Just after that, we have a revision on the opposite direction (from Bob to Alice). The candidate revision wins (4-4bb), but for files, we don t use CouchDB conflict, thus it s not possible to write a new revision at the same generation (4). The only option is to create a new revision (5-5bb). This revision is then sent to Bob: Bob s Cozy accepts the new revision even if it has no effect on the file (it was already the good name), just to resolve the conflict.","title":"Example 1"},{"location":"/cozy-stack/sharing-design/#example-2","text":"Like in the last example, Alice uploads a file and share a directory to Bob with this file, Bob acccepts. But then, several actions are made on the file in a short lapse of time and it generates a difficult conflict: Alice renames the file, and then uploads a new version with cozy-desktop Bob moves the file to a sub-directory. So, when the replication comes, we have two versions of the file with different name, parent directory, and content. The winner is the higher revision (4-4aa). The resolution takes 4 steps: A copy of the file is created from the revision 3-3bb, with the new identifier id2 = XorID(id, 3-3bb). The new content is written on Bob s Cozy: we can t use the revisions 3-3aa (same generation as 3-3bb) and 4-4aa (it will mean the conflict is fixed, but it s not the case, the filenames are still different), so a new revision is used (4-4cc). The file is moved and renamed on Bob s Cozy, with a next revision (5-5bb). The two files are sent to Alice s Cozy: 5-5bb is accepted just to resolve the conflict, and id2 is uploaded as a new file.","title":"Example 2"},{"location":"/cozy-stack/sharing-design/#schema","text":"","title":"Schema"},{"location":"/cozy-stack/sharing-design/#description-of-a-sharing","text":"An identifier (the same for all members of the sharing) A list of members . The first one is the owner. For each member, we have the URL of the cozy, a contact name, a public name, an email, a status and some credentials to authorize the transfer of data between the owner and the recipients A description (one sentence that will help people understand what is shared and why) a flag active that says if the sharing is currently active for at least one member a flag owner , true for the document on the cozy of the sharer, and false on the other cozy instance a flag open_sharing : true if any member of the sharing can add a new recipient false if only the owner can add a new recipient Some technical data ( created_at , updated_at , app_slug , preview_path , triggers , credentials ) A list of sharing rules , each rule being composed of: a title , that will be displayed to the recipients before they accept the sharing a doctype a selector (by default, it\u2019s the id ) and values (one identifier, a list of identifiers, files and folders inside a folder, files that are referenced by the same document, documents bound to a previous sharing rule) local : by default false , but it can false true for documents that are useful for the preview page but doesn\u2019t need to be send to the recipients (e.g. a setting document of the application) add : a behavior when a new document matches this rule (the document is created, or it was a document that didn\u2019t match the rule and is modified and the new version matches the rule): none : the updates are never propagated (the default) push : the updates made on the owner are sent to the recipients sync : the updates on any member are propagated to the other members update : a behavior when a document matched by this rule is modified. Can be: none : the updates are never propagated (the default) push : the updates made on the owner are sent to the recipients sync : the updates on any member are propagated to the other members remove : a behavior when a document no longer matches this rule (the document is deleted, or it was a document that matched the rule, and is modified and the new version doesn\u2019t match the rule): none : the updates are never propagated (the default) push : the updates made on the owner are sent to the recipients sync : the updates on any member are propagated to the other members revoke : the sharing is revoked.","title":"Description of a sharing"},{"location":"/cozy-stack/sharing-design/#example-i-want-to-share-a-folder-in-readwrite-mode","text":"rule 1 title: folder doctype: io.cozy.files values: \"ca527016-0d83-11e8-a580-3b965c80c7f7\" add: sync update: sync remove: sync","title":"Example: I want to share a folder in read/write mode"},{"location":"/cozy-stack/sharing-design/#example-i-want-to-share-a-playlist-where-im-the-only-one-that-can-add-and-remove-items","text":"rule 1 title: playlist doctype: io.cozy.music.playlists values: \"99445b14-0d84-11e8-ae72-4b96fcbf0552\" update: none remove: revoke rule 2 title: items doctype: io.cozy.files selector: referenced_by values: \"io.cozy.files/ca527016-0d83-11e8-a580-3b965c80c7f7\" add: push update: none remove: push","title":"Example: I want to share a playlist where I\u2019m the only one that can add and remove items"},{"location":"/cozy-stack/sharing-design/#iocozyshared","text":"This doctype is an internal one for the stack. It is used to track what documents are shared, and to replicate changes from one Cozy to the others. _id : its identifier is the doctype and id of the referenced objet, separated by a / (e.g. io.cozy.contacts/c1f5dae4-0d87-11e8-b91b-1f41c005768b ) _rev : the CouchDB default revision for this document (not very meaningful, it\u2019s here to avoid concurrency issues) revisions : a tree with the last known _rev s of the referenced object infos , a map of sharing ids \u2192 {rule, removed, binary} rule says which rule from the sharing must be applied for this document removed will be true for a deleted document, a trashed file, or if the document does no longer match the sharing rule binary is a boolean flag that is true only for files (and not even folders) with removed: false","title":"io.cozy.shared"},{"location":"/konitor/cli/","text":"Manpages of the command-line tool Table of Contents konitor or konitor interactive konitor pulls konitor test trainline konitor testit ../trainline Interactive To launch konitor with interactive mode, so it ask you what do you want to do. Help $ konitor interactive --help _ _ _ | | __ ___ _ __ (_) | |_ ___ _ __ | |/ / / _ \\ | '_ \\ | | | __| / _ \\ | '__| | | (_) | | | | | | | | |_ | (_) | | | |_|\\_\\ \\___/ |_| |_| |_| \\__| \\___/ |_| vX.X.X konitor interactive Launch interactive mode Options: --help Show help [boolean] --version Show version number [boolean] Example _ _ _ | | __ ___ _ __ (_) | |_ ___ _ __ | |/ / / _ \\ | '_ \\ | | | __| / _ \\ | '__| | | (_) | | | | | | | | |_ | (_) | | | |_|\\_\\ \\___/ |_| |_| |_| \\__| \\___/ |_| vX.X.X ? What do you want to do? (Use arrow keys) \u276f Test a konnector Pull all konnectors Quit Pulls Pulls all konnectors into ${XDG_CONFIG_HOME:-~/.config}/configstore/konitor/ Help $ konitor pulls --help _ _ _ | | __ ___ _ __ (_) | |_ ___ _ __ | |/ / / _ \\ | '_ \\ | | | __| / _ \\ | '__| | | (_) | | | | | | | | |_ | (_) | | | |_|\\_\\ \\___/ |_| |_| |_| \\__| \\___/ |_| vX.X.X konitor pulls Pull all konnectors Options: --help Show help [boolean] --version Show version number [boolean] Example $ konitor pulls _ _ _ | | __ ___ _ __ (_) | |_ ___ _ __ | |/ / / _ \\ | '_ \\ | | | __| / _ \\ | '__| | | (_) | | | | | | | | |_ | (_) | | | |_|\\_\\ \\___/ |_| |_| |_| \\__| \\___/ |_| vX.X.X Pull all konnectors: - \u2705 cozy-konnector-ameli: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-bouyguesbox: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-bouyguestelecom: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-digiposte: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-free: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-free-mobile: { changes :2, insertions :53, deletions :5} - \u2705 cozy-konnector-harmonie: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-maif: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-malakoffmederic: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-materielnet: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-mgen: { changes :1, insertions :13, deletions :9} - \u2705 cozy-konnector-numericable: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-orange: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-orangevod: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-sosh: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-sfrbox: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-sfrmobile: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-redbox: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-redmobile: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-trainline: { changes :4, insertions :59, deletions :6} - \u2705 cozy-konnector-uber: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-sncf: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-virgin-mobile: { changes :0, insertions :0, deletions :0} Test You can test a konnector with slug or repository name: konitor test trainline konitor test cozy-konnector-trainline Help $ konitor test --help _ _ _ | | __ ___ _ __ (_) | |_ ___ _ __ | |/ / / _ \\ | '_ \\ | | | __| / _ \\ | '__| | | (_) | | | | | | | | |_ | (_) | | | |_|\\_\\ \\___/ |_| |_| |_| \\__| \\___/ |_| vX.X.X konitor test name [options] Test a konnector Options: --help Show help [boolean] --version Show version number [boolean] --config, -c Path to a config file [default: false] --interactive, -i Launch interactive mode [default: true] Example $ konitor test trainline _ _ _ | | __ ___ _ __ (_) | |_ ___ _ __ | |/ / / _ \\ | '_ \\ | | | __| / _ \\ | '__| | | (_) | | | | | | | | |_ | (_) | | | |_|\\_\\ \\___/ |_| |_| |_| \\__| \\___/ |_| vX.X.X Test konnector trainline: - \u2705 repository is up to date. - \u2705 dependencies is installed. - \u2705 repository is clean. - \u2705 Correctly executed. - \u2705 Correctly logged in. - \u2705 PDF is imported. - \u2705 repository is clean. testit You can test a konnector with path Help $ konitor testit --help _ _ _ | | __ ___ _ __ (_) | |_ ___ _ __ | |/ / / _ \\ | '_ \\ | | | __| / _ \\ | '__| | | (_) | | | | | | | | |_ | (_) | | | |_|\\_\\ \\___/ |_| |_| |_| \\__| \\___/ |_| vX.X.X konitor testit path [options] Test from a konnector Options: --help Show help [boolean] --version Show version number [boolean] --config, -c Path to a config file [default: false] --interactive, -i Launch interactive mode [default: true] Example $ konitor testit ../trainline _ _ _ | | __ ___ _ __ (_) | |_ ___ _ __ | |/ / / _ \\ | '_ \\ | | | __| / _ \\ | '__| | | (_) | | | | | | | | |_ | (_) | | | |_|\\_\\ \\___/ |_| |_| |_| \\__| \\___/ |_| vX.X.X Test konnector trainline: - \u2705 dependencies is installed. - \u2705 repository is clean. - \u2705 Correctly executed. - \u2705 Correctly logged in. - \u2705 PDF is imported. - \u2705 repository is clean. check \ud83e\udd13 Check is used to programmatically check our guidelines against a repository. Use it before publishing your konnector for it to be production ready \ud83d\ude80 Here is a sample output : $ konitor check ./cozy-konnector-ameli/ ## Checking ../cozy-konnector-ameli/ * Eslint with prettier is used to lint the code (check for eslintConfig in package.json) \u274c - eslintConfig should extend from prettier \u274c Check the documentation: https://github.com/konnectors/docs/blob/master/status.md#linting * Fields (necessary for login) are defined in manifest.konnector \u274c - The fields should not be in old format \u274c * Travis is correctly configured to deploy master/prod. \u2705 * Renovate should be correctly configured. \u274c - Renovate config should extend from the cozy-konnector config \u274c Check the documentation: https://github.com/konnectors/docs/blob/master/status.md#renovate * Repository should have 4 branches. \u2705 You can check multiple repositories : $ konitor check ./cozy-konnector-ameli/ ./cozy-konnector-orange/ ...","title":"CLI"},{"location":"/konitor/cli/#manpages-of-the-command-line-tool","text":"","title":"Manpages of the command-line tool"},{"location":"/konitor/cli/#table-of-contents","text":"konitor or konitor interactive konitor pulls konitor test trainline konitor testit ../trainline","title":"Table of Contents"},{"location":"/konitor/cli/#interactive","text":"To launch konitor with interactive mode, so it ask you what do you want to do.","title":"Interactive"},{"location":"/konitor/cli/#help","text":"$ konitor interactive --help _ _ _ | | __ ___ _ __ (_) | |_ ___ _ __ | |/ / / _ \\ | '_ \\ | | | __| / _ \\ | '__| | | (_) | | | | | | | | |_ | (_) | | | |_|\\_\\ \\___/ |_| |_| |_| \\__| \\___/ |_| vX.X.X konitor interactive Launch interactive mode Options: --help Show help [boolean] --version Show version number [boolean]","title":"Help"},{"location":"/konitor/cli/#example","text":"_ _ _ | | __ ___ _ __ (_) | |_ ___ _ __ | |/ / / _ \\ | '_ \\ | | | __| / _ \\ | '__| | | (_) | | | | | | | | |_ | (_) | | | |_|\\_\\ \\___/ |_| |_| |_| \\__| \\___/ |_| vX.X.X ? What do you want to do? (Use arrow keys) \u276f Test a konnector Pull all konnectors Quit","title":"Example"},{"location":"/konitor/cli/#pulls","text":"Pulls all konnectors into ${XDG_CONFIG_HOME:-~/.config}/configstore/konitor/","title":"Pulls"},{"location":"/konitor/cli/#help_1","text":"$ konitor pulls --help _ _ _ | | __ ___ _ __ (_) | |_ ___ _ __ | |/ / / _ \\ | '_ \\ | | | __| / _ \\ | '__| | | (_) | | | | | | | | |_ | (_) | | | |_|\\_\\ \\___/ |_| |_| |_| \\__| \\___/ |_| vX.X.X konitor pulls Pull all konnectors Options: --help Show help [boolean] --version Show version number [boolean]","title":"Help"},{"location":"/konitor/cli/#example_1","text":"$ konitor pulls _ _ _ | | __ ___ _ __ (_) | |_ ___ _ __ | |/ / / _ \\ | '_ \\ | | | __| / _ \\ | '__| | | (_) | | | | | | | | |_ | (_) | | | |_|\\_\\ \\___/ |_| |_| |_| \\__| \\___/ |_| vX.X.X Pull all konnectors: - \u2705 cozy-konnector-ameli: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-bouyguesbox: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-bouyguestelecom: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-digiposte: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-free: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-free-mobile: { changes :2, insertions :53, deletions :5} - \u2705 cozy-konnector-harmonie: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-maif: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-malakoffmederic: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-materielnet: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-mgen: { changes :1, insertions :13, deletions :9} - \u2705 cozy-konnector-numericable: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-orange: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-orangevod: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-sosh: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-sfrbox: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-sfrmobile: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-redbox: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-redmobile: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-trainline: { changes :4, insertions :59, deletions :6} - \u2705 cozy-konnector-uber: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-sncf: { changes :0, insertions :0, deletions :0} - \u2705 cozy-konnector-virgin-mobile: { changes :0, insertions :0, deletions :0}","title":"Example"},{"location":"/konitor/cli/#test","text":"You can test a konnector with slug or repository name: konitor test trainline konitor test cozy-konnector-trainline","title":"Test"},{"location":"/konitor/cli/#help_2","text":"$ konitor test --help _ _ _ | | __ ___ _ __ (_) | |_ ___ _ __ | |/ / / _ \\ | '_ \\ | | | __| / _ \\ | '__| | | (_) | | | | | | | | |_ | (_) | | | |_|\\_\\ \\___/ |_| |_| |_| \\__| \\___/ |_| vX.X.X konitor test name [options] Test a konnector Options: --help Show help [boolean] --version Show version number [boolean] --config, -c Path to a config file [default: false] --interactive, -i Launch interactive mode [default: true]","title":"Help"},{"location":"/konitor/cli/#example_2","text":"$ konitor test trainline _ _ _ | | __ ___ _ __ (_) | |_ ___ _ __ | |/ / / _ \\ | '_ \\ | | | __| / _ \\ | '__| | | (_) | | | | | | | | |_ | (_) | | | |_|\\_\\ \\___/ |_| |_| |_| \\__| \\___/ |_| vX.X.X Test konnector trainline: - \u2705 repository is up to date. - \u2705 dependencies is installed. - \u2705 repository is clean. - \u2705 Correctly executed. - \u2705 Correctly logged in. - \u2705 PDF is imported. - \u2705 repository is clean.","title":"Example"},{"location":"/konitor/cli/#testit","text":"You can test a konnector with path","title":"testit"},{"location":"/konitor/cli/#help_3","text":"$ konitor testit --help _ _ _ | | __ ___ _ __ (_) | |_ ___ _ __ | |/ / / _ \\ | '_ \\ | | | __| / _ \\ | '__| | | (_) | | | | | | | | |_ | (_) | | | |_|\\_\\ \\___/ |_| |_| |_| \\__| \\___/ |_| vX.X.X konitor testit path [options] Test from a konnector Options: --help Show help [boolean] --version Show version number [boolean] --config, -c Path to a config file [default: false] --interactive, -i Launch interactive mode [default: true]","title":"Help"},{"location":"/konitor/cli/#example_3","text":"$ konitor testit ../trainline _ _ _ | | __ ___ _ __ (_) | |_ ___ _ __ | |/ / / _ \\ | '_ \\ | | | __| / _ \\ | '__| | | (_) | | | | | | | | |_ | (_) | | | |_|\\_\\ \\___/ |_| |_| |_| \\__| \\___/ |_| vX.X.X Test konnector trainline: - \u2705 dependencies is installed. - \u2705 repository is clean. - \u2705 Correctly executed. - \u2705 Correctly logged in. - \u2705 PDF is imported. - \u2705 repository is clean.","title":"Example"},{"location":"/konitor/cli/#check","text":"Check is used to programmatically check our guidelines against a repository. Use it before publishing your konnector for it to be production ready \ud83d\ude80 Here is a sample output : $ konitor check ./cozy-konnector-ameli/ ## Checking ../cozy-konnector-ameli/ * Eslint with prettier is used to lint the code (check for eslintConfig in package.json) \u274c - eslintConfig should extend from prettier \u274c Check the documentation: https://github.com/konnectors/docs/blob/master/status.md#linting * Fields (necessary for login) are defined in manifest.konnector \u274c - The fields should not be in old format \u274c * Travis is correctly configured to deploy master/prod. \u2705 * Renovate should be correctly configured. \u274c - Renovate config should extend from the cozy-konnector config \u274c Check the documentation: https://github.com/konnectors/docs/blob/master/status.md#renovate * Repository should have 4 branches. \u2705 You can check multiple repositories : $ konitor check ./cozy-konnector-ameli/ ./cozy-konnector-orange/ ...","title":"check \ud83e\udd13"},{"location":"/cozy-client-js/README/","text":"Cozy Javascript Client cozy-client-js is a javascript library made by Cozy. It enables applications (client-side apps, konnectors, OAuth apps, etc.) to make requests to the cozy stack. cozy-client-js is compatible with both cozy architectures, V2 and V3. Cozy-client-js is still a work-in-progress. There may be some bugs, if you find any, please open an issue . Guides Introduction Transition from cozy-browser-sdk How to support offline OAuth guide Modules API Authentication Data System Files Jobs Intents Settings Sharing","title":"README"},{"location":"/cozy-client-js/README/#cozy-javascript-client","text":"cozy-client-js is a javascript library made by Cozy. It enables applications (client-side apps, konnectors, OAuth apps, etc.) to make requests to the cozy stack. cozy-client-js is compatible with both cozy architectures, V2 and V3. Cozy-client-js is still a work-in-progress. There may be some bugs, if you find any, please open an issue .","title":"Cozy Javascript Client"},{"location":"/cozy-client-js/README/#guides","text":"Introduction Transition from cozy-browser-sdk How to support offline OAuth guide","title":"Guides"},{"location":"/cozy-client-js/README/#modules-api","text":"Authentication Data System Files Jobs Intents Settings Sharing","title":"Modules API"},{"location":"/cozy-doctypes/docs/README/","text":"Table of contents Cozy doctypes Accounts : Konnector accounts Bank : banking related data Bills : bills Payslips : payslips Contacts : instance owner contacts Files : files documents Konnectors : Connectors Notifications : notifications made by the apps Photos Albums : photos albums Remote requests : logs of requests via the remote doctypes Sessions Logins : sessions logins entry Sharings : documents used for Cozy to Cozy sharings Triggers : Job triggers Metadata Every doctype should have metadata fields. version is be useful for migrations dateImport is useful for debugging purposes { _id: '123456', metadata: { version: 1, dateImport: '2018-02-22T14:54:36.861Z' } } Date format Date should be formatted in ISO8601 : 2017-04-22T01:00:00-05:00 \u2705 2017-04-22T01:00:00Z \u2705 2017-04-22 01:00 \u274c","title":"README"},{"location":"/cozy-doctypes/docs/README/#table-of-contents","text":"","title":"Table of contents"},{"location":"/cozy-doctypes/docs/README/#cozy-doctypes","text":"Accounts : Konnector accounts Bank : banking related data Bills : bills Payslips : payslips Contacts : instance owner contacts Files : files documents Konnectors : Connectors Notifications : notifications made by the apps Photos Albums : photos albums Remote requests : logs of requests via the remote doctypes Sessions Logins : sessions logins entry Sharings : documents used for Cozy to Cozy sharings Triggers : Job triggers","title":"Cozy doctypes"},{"location":"/cozy-doctypes/docs/README/#metadata","text":"Every doctype should have metadata fields. version is be useful for migrations dateImport is useful for debugging purposes { _id: '123456', metadata: { version: 1, dateImport: '2018-02-22T14:54:36.861Z' } }","title":"Metadata"},{"location":"/cozy-doctypes/docs/README/#date-format","text":"Date should be formatted in ISO8601 : 2017-04-22T01:00:00-05:00 \u2705 2017-04-22T01:00:00Z \u2705 2017-04-22 01:00 \u274c","title":"Date format"},{"location":"/cozy-konnector-libs/migrations/v2-to-v3/","text":"Migrating from v2 to v3 Oviously, start by upgrading the cozy-konnector-libs package. $ yarn upgrade cozy-konnector-libs --save Deprecated attributes Following konnector s attributes may be removed, as they are not used anymore: color name models category dataType customView Removed models The following models has been removed and code using them has to be adapted: * Bill Removed methods The following methods has been removed from codebase: filterExisting linkBankOperation saveFiles filterData * addDataandlinkBankOperation These ones have been directly encapsulated into saveBills Konnector instanciation To instanciate a konnector, juste instanciate a new BaseKonnector with a fetch method as parameter. Replace every previous baseKonnector.createNew() call. The fetch method should take fields as parameter. The fields parameter contains all data related to the konnector, like login/password or the folder information where the data fetchd by the konnector will be stored. Goobye callbacks, hello promises The callback mechanism has been replaced by the use of promise. So All next parameter can be replaced by promises. No more request , now use request The request method is now provided directly by cozy-konnector-libs , so the following import const request = require('request') have to be replaced by const { request } = require('cozy-konnector-libs') request is a function returning an instance of request-promise with a custom configuration ( followAllRedirects is set to true ).","title":"v2-to-v3"},{"location":"/cozy-konnector-libs/migrations/v2-to-v3/#migrating-from-v2-to-v3","text":"Oviously, start by upgrading the cozy-konnector-libs package. $ yarn upgrade cozy-konnector-libs --save","title":"Migrating from v2 to v3"},{"location":"/cozy-konnector-libs/migrations/v2-to-v3/#deprecated-attributes","text":"Following konnector s attributes may be removed, as they are not used anymore: color name models category dataType customView","title":"Deprecated attributes"},{"location":"/cozy-konnector-libs/migrations/v2-to-v3/#removed-models","text":"The following models has been removed and code using them has to be adapted: * Bill","title":"Removed models"},{"location":"/cozy-konnector-libs/migrations/v2-to-v3/#removed-methods","text":"The following methods has been removed from codebase: filterExisting linkBankOperation saveFiles filterData * addDataandlinkBankOperation These ones have been directly encapsulated into saveBills","title":"Removed methods"},{"location":"/cozy-konnector-libs/migrations/v2-to-v3/#konnector-instanciation","text":"To instanciate a konnector, juste instanciate a new BaseKonnector with a fetch method as parameter. Replace every previous baseKonnector.createNew() call. The fetch method should take fields as parameter. The fields parameter contains all data related to the konnector, like login/password or the folder information where the data fetchd by the konnector will be stored.","title":"Konnector instanciation"},{"location":"/cozy-konnector-libs/migrations/v2-to-v3/#goobye-callbacks-hello-promises","text":"The callback mechanism has been replaced by the use of promise. So All next parameter can be replaced by promises.","title":"Goobye callbacks, hello promises"},{"location":"/cozy-konnector-libs/migrations/v2-to-v3/#no-more-request-now-use-request","text":"The request method is now provided directly by cozy-konnector-libs , so the following import const request = require('request') have to be replaced by const { request } = require('cozy-konnector-libs') request is a function returning an instance of request-promise with a custom configuration ( followAllRedirects is set to true ).","title":"No more request, now use request"},{"location":"/cozy-stack/account_types/","text":"Table of contents Account types Google Example creation of google account_type for the stack at .mycozy.cloud Go to https://console.developers.google.com Select or Create Project (up left near the logo) Enable desired APIs (TBD with usages) Click Credentials Create credentials Oauth Client ID Web application Set redirectURI to https://oauthcallback.mycozy.cloud/accounts/google/redirect Copy and paste provided Client ID and Client Secret. Then save the data in the console http PUT localhost:5984/secrets%2Fio-cozy-accounts_types/google grant_mode=authorization_code redirect_uri= https://oauthcallback.mycozy.cloud/accounts/google/redirect token_mode=basic token_endpoint= https://www.googleapis.com/oauth2/v4/token auth_endpoint= https://accounts.google.com/o/oauth2/v2/auth client_id=$CLIENT_ID client_secret=$CLIENT_SECRET","title":"account_types"},{"location":"/cozy-stack/account_types/#account-types","text":"","title":"Account types"},{"location":"/cozy-stack/account_types/#google","text":"Example creation of google account_type for the stack at .mycozy.cloud Go to https://console.developers.google.com Select or Create Project (up left near the logo) Enable desired APIs (TBD with usages) Click Credentials Create credentials Oauth Client ID Web application Set redirectURI to https://oauthcallback.mycozy.cloud/accounts/google/redirect Copy and paste provided Client ID and Client Secret. Then save the data in the console http PUT localhost:5984/secrets%2Fio-cozy-accounts_types/google grant_mode=authorization_code redirect_uri= https://oauthcallback.mycozy.cloud/accounts/google/redirect token_mode=basic token_endpoint= https://www.googleapis.com/oauth2/v4/token auth_endpoint= https://accounts.google.com/o/oauth2/v2/auth client_id=$CLIENT_ID client_secret=$CLIENT_SECRET","title":"Google"},{"location":"/cozy-stack/cli/cozy-stack_apps/","text":"cozy-stack apps Interact with the applications Synopsis cozy-stack apps allows to interact with the cozy applications. It provides commands to install or update applications on a cozy. cozy-stack apps [command] [flags] Options --all-domains work on all domains iterativelly --domain string specify the domain name of the instance (default cozy.tools:8080 ) -h, --help help for apps Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack - cozy-stack is the main command cozy-stack apps install - Install an application with the specified slug name from the given source URL. cozy-stack apps ls - List the installed applications. cozy-stack apps show - Show the application attributes cozy-stack apps uninstall - Uninstall the application with the specified slug name. cozy-stack apps update - Update the application with the specified slug name.","title":"cozy-stack_apps"},{"location":"/cozy-stack/cli/cozy-stack_apps/#cozy-stack-apps","text":"Interact with the applications","title":"cozy-stack apps"},{"location":"/cozy-stack/cli/cozy-stack_apps/#synopsis","text":"cozy-stack apps allows to interact with the cozy applications. It provides commands to install or update applications on a cozy. cozy-stack apps [command] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_apps/#options","text":"--all-domains work on all domains iterativelly --domain string specify the domain name of the instance (default cozy.tools:8080 ) -h, --help help for apps","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_apps/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_apps/#see-also","text":"cozy-stack - cozy-stack is the main command cozy-stack apps install - Install an application with the specified slug name from the given source URL. cozy-stack apps ls - List the installed applications. cozy-stack apps show - Show the application attributes cozy-stack apps uninstall - Uninstall the application with the specified slug name. cozy-stack apps update - Update the application with the specified slug name.","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_apps_install/","text":"cozy-stack apps install Install an application with the specified slug name from the given source URL. Synopsis Some schemes are allowed as [sourceurl] . cozy-stack apps install [slug] [sourceurl] [flags] Examples $ cozy-stack apps install --domain cozy.tools:8080 drive 'git://github.com/cozy/cozy-drive.git#latest-drive' Options --ask-permissions specify that the application should not be activated after installation -h, --help help for install Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack apps - Interact with the applications","title":"cozy-stack_apps_install"},{"location":"/cozy-stack/cli/cozy-stack_apps_install/#cozy-stack-apps-install","text":"Install an application with the specified slug name from the given source URL.","title":"cozy-stack apps install"},{"location":"/cozy-stack/cli/cozy-stack_apps_install/#synopsis","text":"Some schemes are allowed as [sourceurl] . cozy-stack apps install [slug] [sourceurl] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_apps_install/#examples","text":"$ cozy-stack apps install --domain cozy.tools:8080 drive 'git://github.com/cozy/cozy-drive.git#latest-drive'","title":"Examples"},{"location":"/cozy-stack/cli/cozy-stack_apps_install/#options","text":"--ask-permissions specify that the application should not be activated after installation -h, --help help for install","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_apps_install/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_apps_install/#see-also","text":"cozy-stack apps - Interact with the applications","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_apps_ls/","text":"cozy-stack apps ls List the installed applications. Synopsis List the installed applications. cozy-stack apps ls [flags] Options -h, --help help for ls Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack apps - Interact with the applications","title":"cozy-stack_apps_ls"},{"location":"/cozy-stack/cli/cozy-stack_apps_ls/#cozy-stack-apps-ls","text":"List the installed applications.","title":"cozy-stack apps ls"},{"location":"/cozy-stack/cli/cozy-stack_apps_ls/#synopsis","text":"List the installed applications. cozy-stack apps ls [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_apps_ls/#options","text":"-h, --help help for ls","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_apps_ls/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_apps_ls/#see-also","text":"cozy-stack apps - Interact with the applications","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_apps_show/","text":"cozy-stack apps show Show the application attributes Synopsis Show the application attributes cozy-stack apps show [slug] [flags] Options -h, --help help for show Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack apps - Interact with the applications","title":"cozy-stack_apps_show"},{"location":"/cozy-stack/cli/cozy-stack_apps_show/#cozy-stack-apps-show","text":"Show the application attributes","title":"cozy-stack apps show"},{"location":"/cozy-stack/cli/cozy-stack_apps_show/#synopsis","text":"Show the application attributes cozy-stack apps show [slug] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_apps_show/#options","text":"-h, --help help for show","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_apps_show/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_apps_show/#see-also","text":"cozy-stack apps - Interact with the applications","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_apps_uninstall/","text":"cozy-stack apps uninstall Uninstall the application with the specified slug name. Synopsis Uninstall the application with the specified slug name. cozy-stack apps uninstall [slug] [flags] Options -h, --help help for uninstall Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack apps - Interact with the applications","title":"cozy-stack_apps_uninstall"},{"location":"/cozy-stack/cli/cozy-stack_apps_uninstall/#cozy-stack-apps-uninstall","text":"Uninstall the application with the specified slug name.","title":"cozy-stack apps uninstall"},{"location":"/cozy-stack/cli/cozy-stack_apps_uninstall/#synopsis","text":"Uninstall the application with the specified slug name. cozy-stack apps uninstall [slug] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_apps_uninstall/#options","text":"-h, --help help for uninstall","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_apps_uninstall/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_apps_uninstall/#see-also","text":"cozy-stack apps - Interact with the applications","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_apps_update/","text":"cozy-stack apps update Update the application with the specified slug name. Synopsis Update the application with the specified slug name. cozy-stack apps update [slug] [sourceurl] [flags] Options -h, --help help for update Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack apps - Interact with the applications","title":"cozy-stack_apps_update"},{"location":"/cozy-stack/cli/cozy-stack_apps_update/#cozy-stack-apps-update","text":"Update the application with the specified slug name.","title":"cozy-stack apps update"},{"location":"/cozy-stack/cli/cozy-stack_apps_update/#synopsis","text":"Update the application with the specified slug name. cozy-stack apps update [slug] [sourceurl] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_apps_update/#options","text":"-h, --help help for update","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_apps_update/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_apps_update/#see-also","text":"cozy-stack apps - Interact with the applications","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_bug/","text":"cozy-stack bug start a bug report Synopsis Bug opens the default browser and starts a new bug report. The report includes useful system information. cozy-stack bug [flags] Options -h, --help help for bug Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack - cozy-stack is the main command","title":"cozy-stack_bug"},{"location":"/cozy-stack/cli/cozy-stack_bug/#cozy-stack-bug","text":"start a bug report","title":"cozy-stack bug"},{"location":"/cozy-stack/cli/cozy-stack_bug/#synopsis","text":"Bug opens the default browser and starts a new bug report. The report includes useful system information. cozy-stack bug [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_bug/#options","text":"-h, --help help for bug","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_bug/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_bug/#see-also","text":"cozy-stack - cozy-stack is the main command","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_completion/","text":"cozy-stack completion Output shell completion code for the specified shell Synopsis Output shell completion code for the specified shell (bash or zsh). The shell code must be evalutated to provide interactive completion of kubectl commands. This can be done by sourcing it from the .bash_profile. Note: this requires the bash-completion framework, which is not installed by default on Mac. This can be installed by using homebrew: $ brew install bash-completion Once installed, bash_completion must be evaluated. This can be done by adding the following line to the .bash_profile $ source $(brew --prefix)/etc/bash_completion cozy-stack completion [shell] [flags] Examples # cozy-stack completion bash /etc/bash_completion.d/cozy-stack Options -h, --help help for completion Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack - cozy-stack is the main command","title":"cozy-stack_completion"},{"location":"/cozy-stack/cli/cozy-stack_completion/#cozy-stack-completion","text":"Output shell completion code for the specified shell","title":"cozy-stack completion"},{"location":"/cozy-stack/cli/cozy-stack_completion/#synopsis","text":"Output shell completion code for the specified shell (bash or zsh). The shell code must be evalutated to provide interactive completion of kubectl commands. This can be done by sourcing it from the .bash_profile. Note: this requires the bash-completion framework, which is not installed by default on Mac. This can be installed by using homebrew: $ brew install bash-completion Once installed, bash_completion must be evaluated. This can be done by adding the following line to the .bash_profile $ source $(brew --prefix)/etc/bash_completion cozy-stack completion [shell] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_completion/#examples","text":"# cozy-stack completion bash /etc/bash_completion.d/cozy-stack","title":"Examples"},{"location":"/cozy-stack/cli/cozy-stack_completion/#options","text":"-h, --help help for completion","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_completion/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_completion/#see-also","text":"cozy-stack - cozy-stack is the main command","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_config/","text":"cozy-stack config Show and manage configuration elements Synopsis cozy-stack config allows to print and generate some parts of the configuration Options -h, --help help for config Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack - cozy-stack is the main command cozy-stack config decrypt-creds - Decrypt the given credentials cipher text with the specified decryption keyfile. cozy-stack config gen-keys - Generate an key pair for encryption and decryption of credentials cozy-stack config passwd - Generate an admin passphrase cozy-stack config print - Display the configuration","title":"cozy-stack_config"},{"location":"/cozy-stack/cli/cozy-stack_config/#cozy-stack-config","text":"Show and manage configuration elements","title":"cozy-stack config"},{"location":"/cozy-stack/cli/cozy-stack_config/#synopsis","text":"cozy-stack config allows to print and generate some parts of the configuration","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_config/#options","text":"-h, --help help for config","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_config/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_config/#see-also","text":"cozy-stack - cozy-stack is the main command cozy-stack config decrypt-creds - Decrypt the given credentials cipher text with the specified decryption keyfile. cozy-stack config gen-keys - Generate an key pair for encryption and decryption of credentials cozy-stack config passwd - Generate an admin passphrase cozy-stack config print - Display the configuration","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_config_decrypt-creds/","text":"cozy-stack config decrypt-creds Decrypt the given credentials cipher text with the specified decryption keyfile. Synopsis Decrypt the given credentials cipher text with the specified decryption keyfile. cozy-stack config decrypt-creds [keyfile] [ciphertext] [flags] Options -h, --help help for decrypt-creds Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack config - Show and manage configuration elements","title":"cozy-stack_config_decrypt-creds"},{"location":"/cozy-stack/cli/cozy-stack_config_decrypt-creds/#cozy-stack-config-decrypt-creds","text":"Decrypt the given credentials cipher text with the specified decryption keyfile.","title":"cozy-stack config decrypt-creds"},{"location":"/cozy-stack/cli/cozy-stack_config_decrypt-creds/#synopsis","text":"Decrypt the given credentials cipher text with the specified decryption keyfile. cozy-stack config decrypt-creds [keyfile] [ciphertext] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_config_decrypt-creds/#options","text":"-h, --help help for decrypt-creds","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_config_decrypt-creds/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_config_decrypt-creds/#see-also","text":"cozy-stack config - Show and manage configuration elements","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_config_gen-keys/","text":"cozy-stack config gen-keys Generate an key pair for encryption and decryption of credentials Synopsis cozy-stack config gen-keys generate a key-pair and save them in the specified path. The decryptor key filename is given the .dec extension suffix. The encryptor key filename is given the .enc extension suffix. The files permissions are 0400. example: cozy-stack config gen-keys ~/credentials-key keyfiles written in: ~/credentials-key.enc ~/credentials-key.dec cozy-stack config gen-keys [filepath] [flags] Options -h, --help help for gen-keys Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack config - Show and manage configuration elements","title":"cozy-stack_config_gen-keys"},{"location":"/cozy-stack/cli/cozy-stack_config_gen-keys/#cozy-stack-config-gen-keys","text":"Generate an key pair for encryption and decryption of credentials","title":"cozy-stack config gen-keys"},{"location":"/cozy-stack/cli/cozy-stack_config_gen-keys/#synopsis","text":"cozy-stack config gen-keys generate a key-pair and save them in the specified path. The decryptor key filename is given the .dec extension suffix. The encryptor key filename is given the .enc extension suffix. The files permissions are 0400. example: cozy-stack config gen-keys ~/credentials-key keyfiles written in: ~/credentials-key.enc ~/credentials-key.dec cozy-stack config gen-keys [filepath] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_config_gen-keys/#options","text":"-h, --help help for gen-keys","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_config_gen-keys/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_config_gen-keys/#see-also","text":"cozy-stack config - Show and manage configuration elements","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_config_passwd/","text":"cozy-stack config passwd Generate an admin passphrase Synopsis cozy-stack instances passphrase generate a passphrase hash and save it to the specified file. If no file is specified, it is directly printed in standard output. This passphrase is the one used to authenticate accesses to the administration API. The environment variable COZY_ADMIN_PASSPHRASE can be used to pass the passphrase if needed. example: cozy-stack config passwd ~/.cozy/ cozy-stack config passwd [filepath] [flags] Options -h, --help help for passwd Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack config - Show and manage configuration elements","title":"cozy-stack_config_passwd"},{"location":"/cozy-stack/cli/cozy-stack_config_passwd/#cozy-stack-config-passwd","text":"Generate an admin passphrase","title":"cozy-stack config passwd"},{"location":"/cozy-stack/cli/cozy-stack_config_passwd/#synopsis","text":"cozy-stack instances passphrase generate a passphrase hash and save it to the specified file. If no file is specified, it is directly printed in standard output. This passphrase is the one used to authenticate accesses to the administration API. The environment variable COZY_ADMIN_PASSPHRASE can be used to pass the passphrase if needed. example: cozy-stack config passwd ~/.cozy/ cozy-stack config passwd [filepath] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_config_passwd/#options","text":"-h, --help help for passwd","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_config_passwd/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_config_passwd/#see-also","text":"cozy-stack config - Show and manage configuration elements","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_config_print/","text":"cozy-stack config print Display the configuration Synopsis Read the environment variables, the config file and the given parameters to display the configuration. cozy-stack config print [flags] Options -h, --help help for print Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack config - Show and manage configuration elements","title":"cozy-stack_config_print"},{"location":"/cozy-stack/cli/cozy-stack_config_print/#cozy-stack-config-print","text":"Display the configuration","title":"cozy-stack config print"},{"location":"/cozy-stack/cli/cozy-stack_config_print/#synopsis","text":"Read the environment variables, the config file and the given parameters to display the configuration. cozy-stack config print [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_config_print/#options","text":"-h, --help help for print","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_config_print/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_config_print/#see-also","text":"cozy-stack config - Show and manage configuration elements","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_doc/","text":"cozy-stack doc Print the documentation Synopsis Print the documentation about the usage of cozy-stack in command-line cozy-stack doc [command] [flags] Options -h, --help help for doc Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack - cozy-stack is the main command cozy-stack doc man - Print the manpages of cozy-stack cozy-stack doc markdown - Print the documentation of cozy-stack as markdown","title":"cozy-stack_doc"},{"location":"/cozy-stack/cli/cozy-stack_doc/#cozy-stack-doc","text":"Print the documentation","title":"cozy-stack doc"},{"location":"/cozy-stack/cli/cozy-stack_doc/#synopsis","text":"Print the documentation about the usage of cozy-stack in command-line cozy-stack doc [command] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_doc/#options","text":"-h, --help help for doc","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_doc/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_doc/#see-also","text":"cozy-stack - cozy-stack is the main command cozy-stack doc man - Print the manpages of cozy-stack cozy-stack doc markdown - Print the documentation of cozy-stack as markdown","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_doc_man/","text":"cozy-stack doc man Print the manpages of cozy-stack Synopsis Print the manual pages for using cozy-stack in command-line cozy-stack doc man [directory] [flags] Examples $ mkdir -p ~/share/man $ export MANPATH=~/share/man:$MANPATH $ cozy-stack doc man ~/share/man $ man cozy-stack Options -h, --help help for man Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack doc - Print the documentation","title":"cozy-stack_doc_man"},{"location":"/cozy-stack/cli/cozy-stack_doc_man/#cozy-stack-doc-man","text":"Print the manpages of cozy-stack","title":"cozy-stack doc man"},{"location":"/cozy-stack/cli/cozy-stack_doc_man/#synopsis","text":"Print the manual pages for using cozy-stack in command-line cozy-stack doc man [directory] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_doc_man/#examples","text":"$ mkdir -p ~/share/man $ export MANPATH=~/share/man:$MANPATH $ cozy-stack doc man ~/share/man $ man cozy-stack","title":"Examples"},{"location":"/cozy-stack/cli/cozy-stack_doc_man/#options","text":"-h, --help help for man","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_doc_man/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_doc_man/#see-also","text":"cozy-stack doc - Print the documentation","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_doc_markdown/","text":"cozy-stack doc markdown Print the documentation of cozy-stack as markdown Synopsis Print the documentation of cozy-stack as markdown cozy-stack doc markdown [directory] [flags] Examples $ cozy-stack doc markdown docs/cli Options -h, --help help for markdown Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack doc - Print the documentation","title":"cozy-stack_doc_markdown"},{"location":"/cozy-stack/cli/cozy-stack_doc_markdown/#cozy-stack-doc-markdown","text":"Print the documentation of cozy-stack as markdown","title":"cozy-stack doc markdown"},{"location":"/cozy-stack/cli/cozy-stack_doc_markdown/#synopsis","text":"Print the documentation of cozy-stack as markdown cozy-stack doc markdown [directory] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_doc_markdown/#examples","text":"$ cozy-stack doc markdown docs/cli","title":"Examples"},{"location":"/cozy-stack/cli/cozy-stack_doc_markdown/#options","text":"-h, --help help for markdown","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_doc_markdown/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_doc_markdown/#see-also","text":"cozy-stack doc - Print the documentation","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_files/","text":"cozy-stack files Interact with the cozy filesystem Synopsis cozy-stack files allows to interact with the cozy filesystem. It provides command to create, move copy or delete files and directories inside your cozy instance, using the command line interface. It also provide an import command to import from your current filesystem into cozy. cozy-stack files [command] [flags] Options --domain string specify the domain name of the instance (default cozy.tools:8080 ) -h, --help help for files Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack - cozy-stack is the main command cozy-stack files exec - Execute the given command on the specified domain and leave cozy-stack files import - Import the specified file or directory into cozy","title":"cozy-stack_files"},{"location":"/cozy-stack/cli/cozy-stack_files/#cozy-stack-files","text":"Interact with the cozy filesystem","title":"cozy-stack files"},{"location":"/cozy-stack/cli/cozy-stack_files/#synopsis","text":"cozy-stack files allows to interact with the cozy filesystem. It provides command to create, move copy or delete files and directories inside your cozy instance, using the command line interface. It also provide an import command to import from your current filesystem into cozy. cozy-stack files [command] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_files/#options","text":"--domain string specify the domain name of the instance (default cozy.tools:8080 ) -h, --help help for files","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_files/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_files/#see-also","text":"cozy-stack - cozy-stack is the main command cozy-stack files exec - Execute the given command on the specified domain and leave cozy-stack files import - Import the specified file or directory into cozy","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_files_exec/","text":"cozy-stack files exec Execute the given command on the specified domain and leave Synopsis Execute a command on the VFS of the specified domain. Available commands: mkdir [name] Creates a directory with specified name ls [-l] [-a] [-h] [name] Prints the children of the specified directory tree [name] Prints the tree structure of the specified directory attrs [name] Prints the attributes of the specified file or directory cat [name] Echo the file content in stdout mv [from] [to] Rename a file or directory rm [-f] [-r] [name] Move the file to trash, or delete it permanently with -f flag restore [name] Restore a file or directory from trash Don't forget to put quotes around the command! cozy-stack files exec [--domain domain] [command] [flags] Options -h, --help help for exec Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack files - Interact with the cozy filesystem","title":"cozy-stack_files_exec"},{"location":"/cozy-stack/cli/cozy-stack_files_exec/#cozy-stack-files-exec","text":"Execute the given command on the specified domain and leave","title":"cozy-stack files exec"},{"location":"/cozy-stack/cli/cozy-stack_files_exec/#synopsis","text":"Execute a command on the VFS of the specified domain. Available commands: mkdir [name] Creates a directory with specified name ls [-l] [-a] [-h] [name] Prints the children of the specified directory tree [name] Prints the tree structure of the specified directory attrs [name] Prints the attributes of the specified file or directory cat [name] Echo the file content in stdout mv [from] [to] Rename a file or directory rm [-f] [-r] [name] Move the file to trash, or delete it permanently with -f flag restore [name] Restore a file or directory from trash Don't forget to put quotes around the command! cozy-stack files exec [--domain domain] [command] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_files_exec/#options","text":"-h, --help help for exec","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_files_exec/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_files_exec/#see-also","text":"cozy-stack files - Interact with the cozy filesystem","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_files_import/","text":"cozy-stack files import Import the specified file or directory into cozy Synopsis Import the specified file or directory into cozy cozy-stack files import [--domain domain] [--from name] [--to name] [--match pattern] [flags] Options --dry-run do not actually import the files --from string directory to import from in cozy -h, --help help for import --match string pattern that the imported files must match --to string directory to import to in cozy (default / ) Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack files - Interact with the cozy filesystem","title":"cozy-stack_files_import"},{"location":"/cozy-stack/cli/cozy-stack_files_import/#cozy-stack-files-import","text":"Import the specified file or directory into cozy","title":"cozy-stack files import"},{"location":"/cozy-stack/cli/cozy-stack_files_import/#synopsis","text":"Import the specified file or directory into cozy cozy-stack files import [--domain domain] [--from name] [--to name] [--match pattern] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_files_import/#options","text":"--dry-run do not actually import the files --from string directory to import from in cozy -h, --help help for import --match string pattern that the imported files must match --to string directory to import to in cozy (default / )","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_files_import/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_files_import/#see-also","text":"cozy-stack files - Interact with the cozy filesystem","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_fixer/","text":"cozy-stack fixer A set of tools to fix issues or migrate content for retro-compatibility. Synopsis A set of tools to fix issues or migrate content for retro-compatibility. cozy-stack fixer [command] [flags] Options -h, --help help for fixer Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack - cozy-stack is the main command cozy-stack fixer accounts-orphans - Rebuild triggers associated with orphan accounts cozy-stack fixer albums-created-at - Add a created_at field for albums where it s missing cozy-stack fixer jobs - Take a look at the consistency of the jobs cozy-stack fixer md5 - Fix missing md5 from contents in the vfs cozy-stack fixer mime - Fix the class computed from the mime-type cozy-stack fixer onboardings - Add the onboarding_finished flag to user that have registered their passphrase cozy-stack fixer redis - Rebuild scheduling data strucutures in redis cozy-stack fixer thumbnails - Rebuild thumbnails image for images files","title":"cozy-stack_fixer"},{"location":"/cozy-stack/cli/cozy-stack_fixer/#cozy-stack-fixer","text":"A set of tools to fix issues or migrate content for retro-compatibility.","title":"cozy-stack fixer"},{"location":"/cozy-stack/cli/cozy-stack_fixer/#synopsis","text":"A set of tools to fix issues or migrate content for retro-compatibility. cozy-stack fixer [command] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_fixer/#options","text":"-h, --help help for fixer","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_fixer/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_fixer/#see-also","text":"cozy-stack - cozy-stack is the main command cozy-stack fixer accounts-orphans - Rebuild triggers associated with orphan accounts cozy-stack fixer albums-created-at - Add a created_at field for albums where it s missing cozy-stack fixer jobs - Take a look at the consistency of the jobs cozy-stack fixer md5 - Fix missing md5 from contents in the vfs cozy-stack fixer mime - Fix the class computed from the mime-type cozy-stack fixer onboardings - Add the onboarding_finished flag to user that have registered their passphrase cozy-stack fixer redis - Rebuild scheduling data strucutures in redis cozy-stack fixer thumbnails - Rebuild thumbnails image for images files","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_fixer_accounts-orphans/","text":"cozy-stack fixer accounts-orphans Rebuild triggers associated with orphan accounts Synopsis Rebuild triggers associated with orphan accounts cozy-stack fixer accounts-orphans [domain] [flags] Options --dry-run Dry run -h, --help help for accounts-orphans Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack fixer - A set of tools to fix issues or migrate content for retro-compatibility.","title":"cozy-stack_fixer_accounts-orphans"},{"location":"/cozy-stack/cli/cozy-stack_fixer_accounts-orphans/#cozy-stack-fixer-accounts-orphans","text":"Rebuild triggers associated with orphan accounts","title":"cozy-stack fixer accounts-orphans"},{"location":"/cozy-stack/cli/cozy-stack_fixer_accounts-orphans/#synopsis","text":"Rebuild triggers associated with orphan accounts cozy-stack fixer accounts-orphans [domain] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_fixer_accounts-orphans/#options","text":"--dry-run Dry run -h, --help help for accounts-orphans","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_fixer_accounts-orphans/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_fixer_accounts-orphans/#see-also","text":"cozy-stack fixer - A set of tools to fix issues or migrate content for retro-compatibility.","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_fixer_albums-created-at/","text":"cozy-stack fixer albums-created-at Add a created_at field for albums where it s missing Synopsis Add a created_at field for albums where it s missing cozy-stack fixer albums-created-at [domain] [flags] Options -h, --help help for albums-created-at Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack fixer - A set of tools to fix issues or migrate content for retro-compatibility.","title":"cozy-stack_fixer_albums-created-at"},{"location":"/cozy-stack/cli/cozy-stack_fixer_albums-created-at/#cozy-stack-fixer-albums-created-at","text":"Add a created_at field for albums where it s missing","title":"cozy-stack fixer albums-created-at"},{"location":"/cozy-stack/cli/cozy-stack_fixer_albums-created-at/#synopsis","text":"Add a created_at field for albums where it s missing cozy-stack fixer albums-created-at [domain] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_fixer_albums-created-at/#options","text":"-h, --help help for albums-created-at","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_fixer_albums-created-at/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_fixer_albums-created-at/#see-also","text":"cozy-stack fixer - A set of tools to fix issues or migrate content for retro-compatibility.","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_fixer_jobs/","text":"cozy-stack fixer jobs Take a look at the consistency of the jobs Synopsis Take a look at the consistency of the jobs cozy-stack fixer jobs [domain] [flags] Options -h, --help help for jobs Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack fixer - A set of tools to fix issues or migrate content for retro-compatibility.","title":"cozy-stack_fixer_jobs"},{"location":"/cozy-stack/cli/cozy-stack_fixer_jobs/#cozy-stack-fixer-jobs","text":"Take a look at the consistency of the jobs","title":"cozy-stack fixer jobs"},{"location":"/cozy-stack/cli/cozy-stack_fixer_jobs/#synopsis","text":"Take a look at the consistency of the jobs cozy-stack fixer jobs [domain] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_fixer_jobs/#options","text":"-h, --help help for jobs","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_fixer_jobs/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_fixer_jobs/#see-also","text":"cozy-stack fixer - A set of tools to fix issues or migrate content for retro-compatibility.","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_fixer_md5/","text":"cozy-stack fixer md5 Fix missing md5 from contents in the vfs Synopsis Fix missing md5 from contents in the vfs cozy-stack fixer md5 [domain] [flags] Options -h, --help help for md5 Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack fixer - A set of tools to fix issues or migrate content for retro-compatibility.","title":"cozy-stack_fixer_md5"},{"location":"/cozy-stack/cli/cozy-stack_fixer_md5/#cozy-stack-fixer-md5","text":"Fix missing md5 from contents in the vfs","title":"cozy-stack fixer md5"},{"location":"/cozy-stack/cli/cozy-stack_fixer_md5/#synopsis","text":"Fix missing md5 from contents in the vfs cozy-stack fixer md5 [domain] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_fixer_md5/#options","text":"-h, --help help for md5","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_fixer_md5/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_fixer_md5/#see-also","text":"cozy-stack fixer - A set of tools to fix issues or migrate content for retro-compatibility.","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_fixer_mime/","text":"cozy-stack fixer mime Fix the class computed from the mime-type Synopsis Fix the class computed from the mime-type cozy-stack fixer mime [domain] [flags] Options -h, --help help for mime Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack fixer - A set of tools to fix issues or migrate content for retro-compatibility.","title":"cozy-stack_fixer_mime"},{"location":"/cozy-stack/cli/cozy-stack_fixer_mime/#cozy-stack-fixer-mime","text":"Fix the class computed from the mime-type","title":"cozy-stack fixer mime"},{"location":"/cozy-stack/cli/cozy-stack_fixer_mime/#synopsis","text":"Fix the class computed from the mime-type cozy-stack fixer mime [domain] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_fixer_mime/#options","text":"-h, --help help for mime","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_fixer_mime/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_fixer_mime/#see-also","text":"cozy-stack fixer - A set of tools to fix issues or migrate content for retro-compatibility.","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_fixer_onboardings/","text":"cozy-stack fixer onboardings Add the onboarding_finished flag to user that have registered their passphrase Synopsis Add the onboarding_finished flag to user that have registered their passphrase cozy-stack fixer onboardings [flags] Options -h, --help help for onboardings Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack fixer - A set of tools to fix issues or migrate content for retro-compatibility.","title":"cozy-stack_fixer_onboardings"},{"location":"/cozy-stack/cli/cozy-stack_fixer_onboardings/#cozy-stack-fixer-onboardings","text":"Add the onboarding_finished flag to user that have registered their passphrase","title":"cozy-stack fixer onboardings"},{"location":"/cozy-stack/cli/cozy-stack_fixer_onboardings/#synopsis","text":"Add the onboarding_finished flag to user that have registered their passphrase cozy-stack fixer onboardings [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_fixer_onboardings/#options","text":"-h, --help help for onboardings","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_fixer_onboardings/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_fixer_onboardings/#see-also","text":"cozy-stack fixer - A set of tools to fix issues or migrate content for retro-compatibility.","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_fixer_redis/","text":"cozy-stack fixer redis Rebuild scheduling data strucutures in redis Synopsis Rebuild scheduling data strucutures in redis cozy-stack fixer redis [flags] Options -h, --help help for redis Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack fixer - A set of tools to fix issues or migrate content for retro-compatibility.","title":"cozy-stack_fixer_redis"},{"location":"/cozy-stack/cli/cozy-stack_fixer_redis/#cozy-stack-fixer-redis","text":"Rebuild scheduling data strucutures in redis","title":"cozy-stack fixer redis"},{"location":"/cozy-stack/cli/cozy-stack_fixer_redis/#synopsis","text":"Rebuild scheduling data strucutures in redis cozy-stack fixer redis [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_fixer_redis/#options","text":"-h, --help help for redis","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_fixer_redis/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_fixer_redis/#see-also","text":"cozy-stack fixer - A set of tools to fix issues or migrate content for retro-compatibility.","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_fixer_thumbnails/","text":"cozy-stack fixer thumbnails Rebuild thumbnails image for images files Synopsis Rebuild thumbnails image for images files cozy-stack fixer thumbnails [domain] [flags] Options --dry-run Dry run -h, --help help for thumbnails --with-metadata Recalculate images metadata Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack fixer - A set of tools to fix issues or migrate content for retro-compatibility.","title":"cozy-stack_fixer_thumbnails"},{"location":"/cozy-stack/cli/cozy-stack_fixer_thumbnails/#cozy-stack-fixer-thumbnails","text":"Rebuild thumbnails image for images files","title":"cozy-stack fixer thumbnails"},{"location":"/cozy-stack/cli/cozy-stack_fixer_thumbnails/#synopsis","text":"Rebuild thumbnails image for images files cozy-stack fixer thumbnails [domain] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_fixer_thumbnails/#options","text":"--dry-run Dry run -h, --help help for thumbnails --with-metadata Recalculate images metadata","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_fixer_thumbnails/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_fixer_thumbnails/#see-also","text":"cozy-stack fixer - A set of tools to fix issues or migrate content for retro-compatibility.","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_instances/","text":"cozy-stack instances Manage instances of a stack Synopsis cozy-stack instances allows to manage the instances of this stack An instance is a logical space owned by one user and identified by a domain. For example, bob.cozycloud.cc is the instance of Bob. A single cozy-stack process can manage several instances. Each instance has a separate space for storing files and a prefix used to create its CouchDB databases. cozy-stack instances [command] [flags] Options -h, --help help for instances Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack - cozy-stack is the main command cozy-stack instances add - Manage instances of a stack cozy-stack instances clean - Clean badly removed instances cozy-stack instances client-oauth - Register a new OAuth client cozy-stack instances debug - Activate or deactivate debugging of the instance cozy-stack instances destroy - Remove instance cozy-stack instances export - Export an instance to a tarball cozy-stack instances fsck - Check and repair a vfs cozy-stack instances import - Import a tarball cozy-stack instances ls - List instances cozy-stack instances modify - Modify the instance properties cozy-stack instances refresh-token-oauth - Generate a new OAuth refresh token cozy-stack instances set-disk-quota - Change the disk-quota of the instance cozy-stack instances show - Show the instance of the specified domain cozy-stack instances token-app - Generate a new application token cozy-stack instances token-cli - Generate a new CLI access token (global access) cozy-stack instances token-konnector - Generate a new konnector token cozy-stack instances token-oauth - Generate a new OAuth access token cozy-stack instances update - Start the updates for the specified domain instance.","title":"cozy-stack_instances"},{"location":"/cozy-stack/cli/cozy-stack_instances/#cozy-stack-instances","text":"Manage instances of a stack","title":"cozy-stack instances"},{"location":"/cozy-stack/cli/cozy-stack_instances/#synopsis","text":"cozy-stack instances allows to manage the instances of this stack An instance is a logical space owned by one user and identified by a domain. For example, bob.cozycloud.cc is the instance of Bob. A single cozy-stack process can manage several instances. Each instance has a separate space for storing files and a prefix used to create its CouchDB databases. cozy-stack instances [command] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_instances/#options","text":"-h, --help help for instances","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_instances/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_instances/#see-also","text":"cozy-stack - cozy-stack is the main command cozy-stack instances add - Manage instances of a stack cozy-stack instances clean - Clean badly removed instances cozy-stack instances client-oauth - Register a new OAuth client cozy-stack instances debug - Activate or deactivate debugging of the instance cozy-stack instances destroy - Remove instance cozy-stack instances export - Export an instance to a tarball cozy-stack instances fsck - Check and repair a vfs cozy-stack instances import - Import a tarball cozy-stack instances ls - List instances cozy-stack instances modify - Modify the instance properties cozy-stack instances refresh-token-oauth - Generate a new OAuth refresh token cozy-stack instances set-disk-quota - Change the disk-quota of the instance cozy-stack instances show - Show the instance of the specified domain cozy-stack instances token-app - Generate a new application token cozy-stack instances token-cli - Generate a new CLI access token (global access) cozy-stack instances token-konnector - Generate a new konnector token cozy-stack instances token-oauth - Generate a new OAuth access token cozy-stack instances update - Start the updates for the specified domain instance.","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_instances_add/","text":"cozy-stack instances add Manage instances of a stack Synopsis cozy-stack instances add allows to create an instance on the cozy for a given domain. If the COZY_DISABLE_INSTANCES_ADD_RM env variable is set, creating and destroying instances will be desactivated and the content of this variable will be used as the error message. cozy-stack instances add [domain] [flags] Examples $ cozy-stack instances add --dev --passphrase cozy --apps drive,photos,settings cozy.tools:8080 Options --apps strings Apps to be preinstalled --context-name string Context name of the instance --dev To create a development instance --disk-quota string The quota allowed to the instance's VFS --email string The email of the owner -h, --help help for add --locale string Locale of the new cozy instance (default en ) --passphrase string Register the instance with this passphrase (useful for tests) --public-name string The public name of the owner --settings string A list of settings (eg context:foo,offer:premium) --swift-cluster int Specify a cluster number for swift --tos string The TOS version signed --tz string The timezone for the user --uuid string The UUID of the instance Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack instances - Manage instances of a stack","title":"cozy-stack_instances_add"},{"location":"/cozy-stack/cli/cozy-stack_instances_add/#cozy-stack-instances-add","text":"Manage instances of a stack","title":"cozy-stack instances add"},{"location":"/cozy-stack/cli/cozy-stack_instances_add/#synopsis","text":"cozy-stack instances add allows to create an instance on the cozy for a given domain. If the COZY_DISABLE_INSTANCES_ADD_RM env variable is set, creating and destroying instances will be desactivated and the content of this variable will be used as the error message. cozy-stack instances add [domain] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_instances_add/#examples","text":"$ cozy-stack instances add --dev --passphrase cozy --apps drive,photos,settings cozy.tools:8080","title":"Examples"},{"location":"/cozy-stack/cli/cozy-stack_instances_add/#options","text":"--apps strings Apps to be preinstalled --context-name string Context name of the instance --dev To create a development instance --disk-quota string The quota allowed to the instance's VFS --email string The email of the owner -h, --help help for add --locale string Locale of the new cozy instance (default en ) --passphrase string Register the instance with this passphrase (useful for tests) --public-name string The public name of the owner --settings string A list of settings (eg context:foo,offer:premium) --swift-cluster int Specify a cluster number for swift --tos string The TOS version signed --tz string The timezone for the user --uuid string The UUID of the instance","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_instances_add/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_instances_add/#see-also","text":"cozy-stack instances - Manage instances of a stack","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_instances_clean/","text":"cozy-stack instances clean Clean badly removed instances Synopsis Clean badly removed instances cozy-stack instances clean [domain] [flags] Options -h, --help help for clean Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack instances - Manage instances of a stack","title":"cozy-stack_instances_clean"},{"location":"/cozy-stack/cli/cozy-stack_instances_clean/#cozy-stack-instances-clean","text":"Clean badly removed instances","title":"cozy-stack instances clean"},{"location":"/cozy-stack/cli/cozy-stack_instances_clean/#synopsis","text":"Clean badly removed instances cozy-stack instances clean [domain] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_instances_clean/#options","text":"-h, --help help for clean","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_instances_clean/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_instances_clean/#see-also","text":"cozy-stack instances - Manage instances of a stack","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_instances_client-oauth/","text":"cozy-stack instances client-oauth Register a new OAuth client Synopsis It registers a new OAuth client and returns its client_id cozy-stack instances client-oauth [domain] [redirect_uri] [client_name] [software_id] [flags] Options -h, --help help for client-oauth --json Output more informations in JSON format Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack instances - Manage instances of a stack","title":"cozy-stack_instances_client-oauth"},{"location":"/cozy-stack/cli/cozy-stack_instances_client-oauth/#cozy-stack-instances-client-oauth","text":"Register a new OAuth client","title":"cozy-stack instances client-oauth"},{"location":"/cozy-stack/cli/cozy-stack_instances_client-oauth/#synopsis","text":"It registers a new OAuth client and returns its client_id cozy-stack instances client-oauth [domain] [redirect_uri] [client_name] [software_id] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_instances_client-oauth/#options","text":"-h, --help help for client-oauth --json Output more informations in JSON format","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_instances_client-oauth/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_instances_client-oauth/#see-also","text":"cozy-stack instances - Manage instances of a stack","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_instances_debug/","text":"cozy-stack instances debug Activate or deactivate debugging of the instance Synopsis cozy-stack instances debug allows to activate or deactivate the debugging of a specific domain. cozy-stack instances debug [domain] [true/false] [flags] Options -h, --help help for debug Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack instances - Manage instances of a stack","title":"cozy-stack_instances_debug"},{"location":"/cozy-stack/cli/cozy-stack_instances_debug/#cozy-stack-instances-debug","text":"Activate or deactivate debugging of the instance","title":"cozy-stack instances debug"},{"location":"/cozy-stack/cli/cozy-stack_instances_debug/#synopsis","text":"cozy-stack instances debug allows to activate or deactivate the debugging of a specific domain. cozy-stack instances debug [domain] [true/false] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_instances_debug/#options","text":"-h, --help help for debug","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_instances_debug/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_instances_debug/#see-also","text":"cozy-stack instances - Manage instances of a stack","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_instances_destroy/","text":"cozy-stack instances destroy Remove instance Synopsis cozy-stack instances destroy allows to remove an instance and all its data. cozy-stack instances destroy [domain] [flags] Options --force Force the deletion without asking for confirmation -h, --help help for destroy Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack instances - Manage instances of a stack","title":"cozy-stack_instances_destroy"},{"location":"/cozy-stack/cli/cozy-stack_instances_destroy/#cozy-stack-instances-destroy","text":"Remove instance","title":"cozy-stack instances destroy"},{"location":"/cozy-stack/cli/cozy-stack_instances_destroy/#synopsis","text":"cozy-stack instances destroy allows to remove an instance and all its data. cozy-stack instances destroy [domain] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_instances_destroy/#options","text":"--force Force the deletion without asking for confirmation -h, --help help for destroy","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_instances_destroy/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_instances_destroy/#see-also","text":"cozy-stack instances - Manage instances of a stack","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_instances_export/","text":"cozy-stack instances export Export an instance to a tarball Synopsis Export the files and photos albums to a tarball (.tar.gz) cozy-stack instances export [domain] [flags] Options --domain string Specify the domain name of the instance -h, --help help for export Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack instances - Manage instances of a stack","title":"cozy-stack_instances_export"},{"location":"/cozy-stack/cli/cozy-stack_instances_export/#cozy-stack-instances-export","text":"Export an instance to a tarball","title":"cozy-stack instances export"},{"location":"/cozy-stack/cli/cozy-stack_instances_export/#synopsis","text":"Export the files and photos albums to a tarball (.tar.gz) cozy-stack instances export [domain] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_instances_export/#options","text":"--domain string Specify the domain name of the instance -h, --help help for export","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_instances_export/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_instances_export/#see-also","text":"cozy-stack instances - Manage instances of a stack","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_instances_fsck/","text":"cozy-stack instances fsck Check and repair a vfs Synopsis The cozy-stack fsck command checks that the files in the VFS are not desynchronized, ie a file present in CouchDB but not swift/localfs, or present in swift/localfs but not couchdb. cozy-stack instances fsck [domain] [flags] Options --dry Don't modify the VFS, only show the inconsistencies -h, --help help for fsck --prune Try to solve inconsistencies by modifying the file system Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack instances - Manage instances of a stack","title":"cozy-stack_instances_fsck"},{"location":"/cozy-stack/cli/cozy-stack_instances_fsck/#cozy-stack-instances-fsck","text":"Check and repair a vfs","title":"cozy-stack instances fsck"},{"location":"/cozy-stack/cli/cozy-stack_instances_fsck/#synopsis","text":"The cozy-stack fsck command checks that the files in the VFS are not desynchronized, ie a file present in CouchDB but not swift/localfs, or present in swift/localfs but not couchdb. cozy-stack instances fsck [domain] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_instances_fsck/#options","text":"--dry Don't modify the VFS, only show the inconsistencies -h, --help help for fsck --prune Try to solve inconsistencies by modifying the file system","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_instances_fsck/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_instances_fsck/#see-also","text":"cozy-stack instances - Manage instances of a stack","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_instances_import/","text":"cozy-stack instances import Import a tarball Synopsis Import a tarball with files, photos albums and contacts to an instance cozy-stack instances import [domain] [tarball] [flags] Options --directory string Put the imported files inside this directory --domain string Specify the domain name of the instance -h, --help help for import --increase-quota Increase the disk quota if needed for importing all the files Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack instances - Manage instances of a stack","title":"cozy-stack_instances_import"},{"location":"/cozy-stack/cli/cozy-stack_instances_import/#cozy-stack-instances-import","text":"Import a tarball","title":"cozy-stack instances import"},{"location":"/cozy-stack/cli/cozy-stack_instances_import/#synopsis","text":"Import a tarball with files, photos albums and contacts to an instance cozy-stack instances import [domain] [tarball] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_instances_import/#options","text":"--directory string Put the imported files inside this directory --domain string Specify the domain name of the instance -h, --help help for import --increase-quota Increase the disk quota if needed for importing all the files","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_instances_import/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_instances_import/#see-also","text":"cozy-stack instances - Manage instances of a stack","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_instances_ls/","text":"cozy-stack instances ls List instances Synopsis cozy-stack instances ls allows to list all the instances that can be served by this server. cozy-stack instances ls [flags] Options -h, --help help for ls Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack instances - Manage instances of a stack","title":"cozy-stack_instances_ls"},{"location":"/cozy-stack/cli/cozy-stack_instances_ls/#cozy-stack-instances-ls","text":"List instances","title":"cozy-stack instances ls"},{"location":"/cozy-stack/cli/cozy-stack_instances_ls/#synopsis","text":"cozy-stack instances ls allows to list all the instances that can be served by this server. cozy-stack instances ls [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_instances_ls/#options","text":"-h, --help help for ls","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_instances_ls/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_instances_ls/#see-also","text":"cozy-stack instances - Manage instances of a stack","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_instances_modify/","text":"cozy-stack instances modify Modify the instance properties Synopsis cozy-stack instances modify allows to change the instance properties and settings for a specified domain. cozy-stack instances modify [domain] [flags] Options --context-name string New context name --disk-quota string Specify a new disk quota --email string New email -h, --help help for modify --locale string New locale (default en ) --onboarding-finished Force the finishing of the onboarding --public-name string New public name --settings string New list of settings (eg offer:premium) --swift-cluster int New swift cluster --tos string Update the TOS version signed --tos-latest string Update the latest TOS version --tz string New timezone --uuid string New UUID Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack instances - Manage instances of a stack","title":"cozy-stack_instances_modify"},{"location":"/cozy-stack/cli/cozy-stack_instances_modify/#cozy-stack-instances-modify","text":"Modify the instance properties","title":"cozy-stack instances modify"},{"location":"/cozy-stack/cli/cozy-stack_instances_modify/#synopsis","text":"cozy-stack instances modify allows to change the instance properties and settings for a specified domain. cozy-stack instances modify [domain] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_instances_modify/#options","text":"--context-name string New context name --disk-quota string Specify a new disk quota --email string New email -h, --help help for modify --locale string New locale (default en ) --onboarding-finished Force the finishing of the onboarding --public-name string New public name --settings string New list of settings (eg offer:premium) --swift-cluster int New swift cluster --tos string Update the TOS version signed --tos-latest string Update the latest TOS version --tz string New timezone --uuid string New UUID","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_instances_modify/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_instances_modify/#see-also","text":"cozy-stack instances - Manage instances of a stack","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_instances_refresh-token-oauth/","text":"cozy-stack instances refresh-token-oauth Generate a new OAuth refresh token Synopsis Generate a new OAuth refresh token cozy-stack instances refresh-token-oauth [domain] [clientid] [scopes] [flags] Options -h, --help help for refresh-token-oauth Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack instances - Manage instances of a stack","title":"cozy-stack_instances_refresh-token-oauth"},{"location":"/cozy-stack/cli/cozy-stack_instances_refresh-token-oauth/#cozy-stack-instances-refresh-token-oauth","text":"Generate a new OAuth refresh token","title":"cozy-stack instances refresh-token-oauth"},{"location":"/cozy-stack/cli/cozy-stack_instances_refresh-token-oauth/#synopsis","text":"Generate a new OAuth refresh token cozy-stack instances refresh-token-oauth [domain] [clientid] [scopes] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_instances_refresh-token-oauth/#options","text":"-h, --help help for refresh-token-oauth","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_instances_refresh-token-oauth/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_instances_refresh-token-oauth/#see-also","text":"cozy-stack instances - Manage instances of a stack","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_instances_set-disk-quota/","text":"cozy-stack instances set-disk-quota Change the disk-quota of the instance Synopsis cozy-stack instances set-disk-quota allows to change the disk-quota of the instance of the given domain. Set the quota to 0 to remove the quota. cozy-stack instances set-disk-quota [domain] [disk-quota] [flags] Examples $ cozy-stack instances set-disk-quota cozy.tools:8080 3GB Options -h, --help help for set-disk-quota Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack instances - Manage instances of a stack","title":"cozy-stack_instances_set-disk-quota"},{"location":"/cozy-stack/cli/cozy-stack_instances_set-disk-quota/#cozy-stack-instances-set-disk-quota","text":"Change the disk-quota of the instance","title":"cozy-stack instances set-disk-quota"},{"location":"/cozy-stack/cli/cozy-stack_instances_set-disk-quota/#synopsis","text":"cozy-stack instances set-disk-quota allows to change the disk-quota of the instance of the given domain. Set the quota to 0 to remove the quota. cozy-stack instances set-disk-quota [domain] [disk-quota] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_instances_set-disk-quota/#examples","text":"$ cozy-stack instances set-disk-quota cozy.tools:8080 3GB","title":"Examples"},{"location":"/cozy-stack/cli/cozy-stack_instances_set-disk-quota/#options","text":"-h, --help help for set-disk-quota","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_instances_set-disk-quota/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_instances_set-disk-quota/#see-also","text":"cozy-stack instances - Manage instances of a stack","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_instances_show/","text":"cozy-stack instances show Show the instance of the specified domain Synopsis cozy-stack instances show allows to show the instance on the cozy for a given domain. cozy-stack instances show [domain] [flags] Examples $ cozy-stack instances show cozy.tools:8080 Options -h, --help help for show Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack instances - Manage instances of a stack","title":"cozy-stack_instances_show"},{"location":"/cozy-stack/cli/cozy-stack_instances_show/#cozy-stack-instances-show","text":"Show the instance of the specified domain","title":"cozy-stack instances show"},{"location":"/cozy-stack/cli/cozy-stack_instances_show/#synopsis","text":"cozy-stack instances show allows to show the instance on the cozy for a given domain. cozy-stack instances show [domain] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_instances_show/#examples","text":"$ cozy-stack instances show cozy.tools:8080","title":"Examples"},{"location":"/cozy-stack/cli/cozy-stack_instances_show/#options","text":"-h, --help help for show","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_instances_show/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_instances_show/#see-also","text":"cozy-stack instances - Manage instances of a stack","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-app/","text":"cozy-stack instances token-app Generate a new application token Synopsis Generate a new application token cozy-stack instances token-app [domain] [slug] [flags] Options -h, --help help for token-app Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack instances - Manage instances of a stack","title":"cozy-stack_instances_token-app"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-app/#cozy-stack-instances-token-app","text":"Generate a new application token","title":"cozy-stack instances token-app"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-app/#synopsis","text":"Generate a new application token cozy-stack instances token-app [domain] [slug] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-app/#options","text":"-h, --help help for token-app","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-app/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-app/#see-also","text":"cozy-stack instances - Manage instances of a stack","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-cli/","text":"cozy-stack instances token-cli Generate a new CLI access token (global access) Synopsis Generate a new CLI access token (global access) cozy-stack instances token-cli [domain] [scopes] [flags] Options -h, --help help for token-cli Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack instances - Manage instances of a stack","title":"cozy-stack_instances_token-cli"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-cli/#cozy-stack-instances-token-cli","text":"Generate a new CLI access token (global access)","title":"cozy-stack instances token-cli"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-cli/#synopsis","text":"Generate a new CLI access token (global access) cozy-stack instances token-cli [domain] [scopes] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-cli/#options","text":"-h, --help help for token-cli","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-cli/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-cli/#see-also","text":"cozy-stack instances - Manage instances of a stack","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-konnector/","text":"cozy-stack instances token-konnector Generate a new konnector token Synopsis Generate a new konnector token cozy-stack instances token-konnector [domain] [slug] [flags] Options -h, --help help for token-konnector Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack instances - Manage instances of a stack","title":"cozy-stack_instances_token-konnector"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-konnector/#cozy-stack-instances-token-konnector","text":"Generate a new konnector token","title":"cozy-stack instances token-konnector"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-konnector/#synopsis","text":"Generate a new konnector token cozy-stack instances token-konnector [domain] [slug] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-konnector/#options","text":"-h, --help help for token-konnector","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-konnector/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-konnector/#see-also","text":"cozy-stack instances - Manage instances of a stack","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-oauth/","text":"cozy-stack instances token-oauth Generate a new OAuth access token Synopsis Generate a new OAuth access token cozy-stack instances token-oauth [domain] [clientid] [scopes] [flags] Options -h, --help help for token-oauth Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack instances - Manage instances of a stack","title":"cozy-stack_instances_token-oauth"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-oauth/#cozy-stack-instances-token-oauth","text":"Generate a new OAuth access token","title":"cozy-stack instances token-oauth"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-oauth/#synopsis","text":"Generate a new OAuth access token cozy-stack instances token-oauth [domain] [clientid] [scopes] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-oauth/#options","text":"-h, --help help for token-oauth","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-oauth/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_instances_token-oauth/#see-also","text":"cozy-stack instances - Manage instances of a stack","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_instances_update/","text":"cozy-stack instances update Start the updates for the specified domain instance. Synopsis Start the updates for the specified domain instance. Use whether the domain flag to specify the instance or the all-domains flags to updates all domains. The slugs arguments can be used to select which applications should be updated. cozy-stack instances update [slugs...] [flags] Options --all-domains Work on all domains iterativelly --domain string Specify the domain name of the instance --force-registry Force to update all applications sources from git to the registry -h, --help help for update Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack instances - Manage instances of a stack","title":"cozy-stack_instances_update"},{"location":"/cozy-stack/cli/cozy-stack_instances_update/#cozy-stack-instances-update","text":"Start the updates for the specified domain instance.","title":"cozy-stack instances update"},{"location":"/cozy-stack/cli/cozy-stack_instances_update/#synopsis","text":"Start the updates for the specified domain instance. Use whether the domain flag to specify the instance or the all-domains flags to updates all domains. The slugs arguments can be used to select which applications should be updated. cozy-stack instances update [slugs...] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_instances_update/#options","text":"--all-domains Work on all domains iterativelly --domain string Specify the domain name of the instance --force-registry Force to update all applications sources from git to the registry -h, --help help for update","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_instances_update/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_instances_update/#see-also","text":"cozy-stack instances - Manage instances of a stack","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_konnectors/","text":"cozy-stack konnectors Interact with the konnectors Synopsis cozy-stack konnectors allows to interact with the cozy konnectors. It provides commands to install or update applications on a cozy. cozy-stack konnectors [command] [flags] Options --all-domains work on all domains iterativelly --domain string specify the domain name of the instance (default cozy.tools:8080 ) -h, --help help for konnectors --parameters string override the parameters of the installed konnector Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack - cozy-stack is the main command cozy-stack konnectors install - Install a konnector with the specified slug name from the given source URL. cozy-stack konnectors ls - List the installed konnectors. cozy-stack konnectors run - Run a konnector. cozy-stack konnectors show - Show the application attributes cozy-stack konnectors uninstall - Uninstall the konnector with the specified slug name. cozy-stack konnectors update - Update the konnector with the specified slug name.","title":"cozy-stack_konnectors"},{"location":"/cozy-stack/cli/cozy-stack_konnectors/#cozy-stack-konnectors","text":"Interact with the konnectors","title":"cozy-stack konnectors"},{"location":"/cozy-stack/cli/cozy-stack_konnectors/#synopsis","text":"cozy-stack konnectors allows to interact with the cozy konnectors. It provides commands to install or update applications on a cozy. cozy-stack konnectors [command] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_konnectors/#options","text":"--all-domains work on all domains iterativelly --domain string specify the domain name of the instance (default cozy.tools:8080 ) -h, --help help for konnectors --parameters string override the parameters of the installed konnector","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_konnectors/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_konnectors/#see-also","text":"cozy-stack - cozy-stack is the main command cozy-stack konnectors install - Install a konnector with the specified slug name from the given source URL. cozy-stack konnectors ls - List the installed konnectors. cozy-stack konnectors run - Run a konnector. cozy-stack konnectors show - Show the application attributes cozy-stack konnectors uninstall - Uninstall the konnector with the specified slug name. cozy-stack konnectors update - Update the konnector with the specified slug name.","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_install/","text":"cozy-stack konnectors install Install a konnector with the specified slug name from the given source URL. Synopsis Install a konnector with the specified slug name from the given source URL. cozy-stack konnectors install [slug] [sourceurl] [flags] Examples $ cozy-stack konnectors install --domain cozy.tools:8080 trainline 'git://github.com/cozy/cozy-konnector-trainline.git#build' Options -h, --help help for install Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) --parameters string override the parameters of the installed konnector -p, --port int server port (default 8080) SEE ALSO cozy-stack konnectors - Interact with the konnectors","title":"cozy-stack_konnectors_install"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_install/#cozy-stack-konnectors-install","text":"Install a konnector with the specified slug name from the given source URL.","title":"cozy-stack konnectors install"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_install/#synopsis","text":"Install a konnector with the specified slug name from the given source URL. cozy-stack konnectors install [slug] [sourceurl] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_install/#examples","text":"$ cozy-stack konnectors install --domain cozy.tools:8080 trainline 'git://github.com/cozy/cozy-konnector-trainline.git#build'","title":"Examples"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_install/#options","text":"-h, --help help for install","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_install/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) --parameters string override the parameters of the installed konnector -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_install/#see-also","text":"cozy-stack konnectors - Interact with the konnectors","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_ls/","text":"cozy-stack konnectors ls List the installed konnectors. Synopsis List the installed konnectors. cozy-stack konnectors ls [flags] Options -h, --help help for ls Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) --parameters string override the parameters of the installed konnector -p, --port int server port (default 8080) SEE ALSO cozy-stack konnectors - Interact with the konnectors","title":"cozy-stack_konnectors_ls"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_ls/#cozy-stack-konnectors-ls","text":"List the installed konnectors.","title":"cozy-stack konnectors ls"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_ls/#synopsis","text":"List the installed konnectors. cozy-stack konnectors ls [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_ls/#options","text":"-h, --help help for ls","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_ls/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) --parameters string override the parameters of the installed konnector -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_ls/#see-also","text":"cozy-stack konnectors - Interact with the konnectors","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_run/","text":"cozy-stack konnectors run Run a konnector. Synopsis Run a konnector named with specified slug using the specified options. cozy-stack konnectors run [slug] [flags] Options --account-id string specify the account ID to use for running the konnector -h, --help help for run Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) --parameters string override the parameters of the installed konnector -p, --port int server port (default 8080) SEE ALSO cozy-stack konnectors - Interact with the konnectors","title":"cozy-stack_konnectors_run"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_run/#cozy-stack-konnectors-run","text":"Run a konnector.","title":"cozy-stack konnectors run"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_run/#synopsis","text":"Run a konnector named with specified slug using the specified options. cozy-stack konnectors run [slug] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_run/#options","text":"--account-id string specify the account ID to use for running the konnector -h, --help help for run","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_run/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) --parameters string override the parameters of the installed konnector -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_run/#see-also","text":"cozy-stack konnectors - Interact with the konnectors","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_show/","text":"cozy-stack konnectors show Show the application attributes Synopsis Show the application attributes cozy-stack konnectors show [slug] [flags] Options -h, --help help for show Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) --parameters string override the parameters of the installed konnector -p, --port int server port (default 8080) SEE ALSO cozy-stack konnectors - Interact with the konnectors","title":"cozy-stack_konnectors_show"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_show/#cozy-stack-konnectors-show","text":"Show the application attributes","title":"cozy-stack konnectors show"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_show/#synopsis","text":"Show the application attributes cozy-stack konnectors show [slug] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_show/#options","text":"-h, --help help for show","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_show/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) --parameters string override the parameters of the installed konnector -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_show/#see-also","text":"cozy-stack konnectors - Interact with the konnectors","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_uninstall/","text":"cozy-stack konnectors uninstall Uninstall the konnector with the specified slug name. Synopsis Uninstall the konnector with the specified slug name. cozy-stack konnectors uninstall [slug] [flags] Options -h, --help help for uninstall Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) --parameters string override the parameters of the installed konnector -p, --port int server port (default 8080) SEE ALSO cozy-stack konnectors - Interact with the konnectors","title":"cozy-stack_konnectors_uninstall"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_uninstall/#cozy-stack-konnectors-uninstall","text":"Uninstall the konnector with the specified slug name.","title":"cozy-stack konnectors uninstall"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_uninstall/#synopsis","text":"Uninstall the konnector with the specified slug name. cozy-stack konnectors uninstall [slug] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_uninstall/#options","text":"-h, --help help for uninstall","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_uninstall/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) --parameters string override the parameters of the installed konnector -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_uninstall/#see-also","text":"cozy-stack konnectors - Interact with the konnectors","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_update/","text":"cozy-stack konnectors update Update the konnector with the specified slug name. Synopsis Update the konnector with the specified slug name. cozy-stack konnectors update [slug] [sourceurl] [flags] Options -h, --help help for update Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) --parameters string override the parameters of the installed konnector -p, --port int server port (default 8080) SEE ALSO cozy-stack konnectors - Interact with the konnectors","title":"cozy-stack_konnectors_update"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_update/#cozy-stack-konnectors-update","text":"Update the konnector with the specified slug name.","title":"cozy-stack konnectors update"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_update/#synopsis","text":"Update the konnector with the specified slug name. cozy-stack konnectors update [slug] [sourceurl] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_update/#options","text":"-h, --help help for update","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_update/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) --all-domains work on all domains iterativelly -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) --parameters string override the parameters of the installed konnector -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_konnectors_update/#see-also","text":"cozy-stack konnectors - Interact with the konnectors","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_serve/","text":"cozy-stack serve Starts the stack and listens for HTTP calls Synopsis Starts the stack and listens for HTTP calls It will accept HTTP requests on localhost:8080 by default. Use the port and host flags to change the listening option. The SIGINT signal will trigger a graceful stop of cozy-stack: it will wait that current HTTP requests and jobs are finished (in a limit of 2 minutes) before exiting. If you are the developer of a client-side app, you can use appdir to mount a directory as the application with the app slug. cozy-stack serve [flags] Examples The most often, this command is used in its simple form: $ cozy-stack serve But if you want to develop two apps in local (to test their interactions for example), you can use the --appdir flag like this: $ cozy-stack serve --appdir appone:/path/to/app_one,apptwo:/path/to/app_two Options --allow-root Allow to start as root (disabled by default) --appdir strings Mount a directory as the 'app' application --assets string path to the directory with the assets (use the packed assets by default) --cache-url string URL for the cache, redis or in-memory --couchdb-url string CouchDB URL (default http://localhost:5984/ ) --csp-whitelist string Whitelisted domains for the default allowed origins of the Content Secury Policy --dev Allow to run without in dev release mode (disabled by default) --disable-csp Disable the Content Security Policy (only available for development) --doctypes string path to the directory with the doctypes (for developing/testing a remote doctype) --downloads-url string URL for the download secret storage, redis or in-memory --fs-url string filesystem url (default file:///storage ) --geodb string define the location of the database for IP - City lookups (default . ) -h, --help help for serve --hooks string define the directory used for hook scripts (default . ) --jobs-url string URL for the jobs system synchronization, redis or in-memory --konnectors-cmd string konnectors command to be executed --konnectors-oauthstate string URL for the storage of OAuth state for konnectors, redis or in-memory --lock-url string URL for the locks, redis or in-memory --log-level string define the log level (default info ) --log-syslog use the local syslog for logging --mail-disable-tls disable smtp over tls --mail-host string mail smtp host (default localhost ) --mail-noreply-address string mail address used for sending mail as a noreply (forgot passwords for example) --mail-noreply-name string mail name used for sending mail as a noreply (forgot passwords for example) --mail-password string mail smtp password --mail-port int mail smtp port (default 465) --mail-username string mail smtp username --password-reset-interval string minimal duration between two password reset (default 15m ) --realtime-url string URL for realtime in the browser via webocket, redis or in-memory --sessions-url string URL for the sessions storage, redis or in-memory --subdomains string how to structure the subdomains for apps (can be nested or flat) (default nested ) Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack - cozy-stack is the main command","title":"cozy-stack_serve"},{"location":"/cozy-stack/cli/cozy-stack_serve/#cozy-stack-serve","text":"Starts the stack and listens for HTTP calls","title":"cozy-stack serve"},{"location":"/cozy-stack/cli/cozy-stack_serve/#synopsis","text":"Starts the stack and listens for HTTP calls It will accept HTTP requests on localhost:8080 by default. Use the port and host flags to change the listening option. The SIGINT signal will trigger a graceful stop of cozy-stack: it will wait that current HTTP requests and jobs are finished (in a limit of 2 minutes) before exiting. If you are the developer of a client-side app, you can use appdir to mount a directory as the application with the app slug. cozy-stack serve [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_serve/#examples","text":"The most often, this command is used in its simple form: $ cozy-stack serve But if you want to develop two apps in local (to test their interactions for example), you can use the --appdir flag like this: $ cozy-stack serve --appdir appone:/path/to/app_one,apptwo:/path/to/app_two","title":"Examples"},{"location":"/cozy-stack/cli/cozy-stack_serve/#options","text":"--allow-root Allow to start as root (disabled by default) --appdir strings Mount a directory as the 'app' application --assets string path to the directory with the assets (use the packed assets by default) --cache-url string URL for the cache, redis or in-memory --couchdb-url string CouchDB URL (default http://localhost:5984/ ) --csp-whitelist string Whitelisted domains for the default allowed origins of the Content Secury Policy --dev Allow to run without in dev release mode (disabled by default) --disable-csp Disable the Content Security Policy (only available for development) --doctypes string path to the directory with the doctypes (for developing/testing a remote doctype) --downloads-url string URL for the download secret storage, redis or in-memory --fs-url string filesystem url (default file:///storage ) --geodb string define the location of the database for IP - City lookups (default . ) -h, --help help for serve --hooks string define the directory used for hook scripts (default . ) --jobs-url string URL for the jobs system synchronization, redis or in-memory --konnectors-cmd string konnectors command to be executed --konnectors-oauthstate string URL for the storage of OAuth state for konnectors, redis or in-memory --lock-url string URL for the locks, redis or in-memory --log-level string define the log level (default info ) --log-syslog use the local syslog for logging --mail-disable-tls disable smtp over tls --mail-host string mail smtp host (default localhost ) --mail-noreply-address string mail address used for sending mail as a noreply (forgot passwords for example) --mail-noreply-name string mail name used for sending mail as a noreply (forgot passwords for example) --mail-password string mail smtp password --mail-port int mail smtp port (default 465) --mail-username string mail smtp username --password-reset-interval string minimal duration between two password reset (default 15m ) --realtime-url string URL for realtime in the browser via webocket, redis or in-memory --sessions-url string URL for the sessions storage, redis or in-memory --subdomains string how to structure the subdomains for apps (can be nested or flat) (default nested )","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_serve/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_serve/#see-also","text":"cozy-stack - cozy-stack is the main command","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_settings/","text":"cozy-stack settings Display and update settings Synopsis cozy-stack settings displays the settings. It can also take a list of settings to update. cozy-stack settings [settings] [flags] Examples $ cozy-stack settings --domain cozy.tools:8080 context:beta,public_name:John Options --domain string specify the domain name of the instance (default cozy.tools:8080 ) -h, --help help for settings Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack - cozy-stack is the main command","title":"cozy-stack_settings"},{"location":"/cozy-stack/cli/cozy-stack_settings/#cozy-stack-settings","text":"Display and update settings","title":"cozy-stack settings"},{"location":"/cozy-stack/cli/cozy-stack_settings/#synopsis","text":"cozy-stack settings displays the settings. It can also take a list of settings to update. cozy-stack settings [settings] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_settings/#examples","text":"$ cozy-stack settings --domain cozy.tools:8080 context:beta,public_name:John","title":"Examples"},{"location":"/cozy-stack/cli/cozy-stack_settings/#options","text":"--domain string specify the domain name of the instance (default cozy.tools:8080 ) -h, --help help for settings","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_settings/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_settings/#see-also","text":"cozy-stack - cozy-stack is the main command","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_status/","text":"cozy-stack status Check if the HTTP server is running Synopsis Check if the HTTP server has been started and answer 200 for /status. cozy-stack status [flags] Options -h, --help help for status Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack - cozy-stack is the main command","title":"cozy-stack_status"},{"location":"/cozy-stack/cli/cozy-stack_status/#cozy-stack-status","text":"Check if the HTTP server is running","title":"cozy-stack status"},{"location":"/cozy-stack/cli/cozy-stack_status/#synopsis","text":"Check if the HTTP server has been started and answer 200 for /status. cozy-stack status [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_status/#options","text":"-h, --help help for status","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_status/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_status/#see-also","text":"cozy-stack - cozy-stack is the main command","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_triggers/","text":"cozy-stack triggers Interact with the triggers Synopsis cozy-stack apps allows to interact with the cozy triggers. It provides command to run a specific trigger. cozy-stack triggers [command] [flags] Options --domain string specify the domain name of the instance (default cozy.tools:8080 ) -h, --help help for triggers Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack - cozy-stack is the main command cozy-stack triggers launch - Creates a job from a specific trigger cozy-stack triggers ls - List triggers cozy-stack triggers show-from-app - Show the application triggers","title":"cozy-stack_triggers"},{"location":"/cozy-stack/cli/cozy-stack_triggers/#cozy-stack-triggers","text":"Interact with the triggers","title":"cozy-stack triggers"},{"location":"/cozy-stack/cli/cozy-stack_triggers/#synopsis","text":"cozy-stack apps allows to interact with the cozy triggers. It provides command to run a specific trigger. cozy-stack triggers [command] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_triggers/#options","text":"--domain string specify the domain name of the instance (default cozy.tools:8080 ) -h, --help help for triggers","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_triggers/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_triggers/#see-also","text":"cozy-stack - cozy-stack is the main command cozy-stack triggers launch - Creates a job from a specific trigger cozy-stack triggers ls - List triggers cozy-stack triggers show-from-app - Show the application triggers","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_triggers_launch/","text":"cozy-stack triggers launch Creates a job from a specific trigger Synopsis Creates a job from a specific trigger cozy-stack triggers launch [triggerId] [flags] Examples $ cozy-stack triggers launch --domain cozy.tools:8080 748f42b65aca8c99ec2492eb660d1891 Options -h, --help help for launch Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack triggers - Interact with the triggers","title":"cozy-stack_triggers_launch"},{"location":"/cozy-stack/cli/cozy-stack_triggers_launch/#cozy-stack-triggers-launch","text":"Creates a job from a specific trigger","title":"cozy-stack triggers launch"},{"location":"/cozy-stack/cli/cozy-stack_triggers_launch/#synopsis","text":"Creates a job from a specific trigger cozy-stack triggers launch [triggerId] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_triggers_launch/#examples","text":"$ cozy-stack triggers launch --domain cozy.tools:8080 748f42b65aca8c99ec2492eb660d1891","title":"Examples"},{"location":"/cozy-stack/cli/cozy-stack_triggers_launch/#options","text":"-h, --help help for launch","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_triggers_launch/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_triggers_launch/#see-also","text":"cozy-stack triggers - Interact with the triggers","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_triggers_ls/","text":"cozy-stack triggers ls List triggers Synopsis List triggers cozy-stack triggers ls [flags] Examples $ cozy-stack triggers ls --domain cozy.tools:8080 Options -h, --help help for ls Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack triggers - Interact with the triggers","title":"cozy-stack_triggers_ls"},{"location":"/cozy-stack/cli/cozy-stack_triggers_ls/#cozy-stack-triggers-ls","text":"List triggers","title":"cozy-stack triggers ls"},{"location":"/cozy-stack/cli/cozy-stack_triggers_ls/#synopsis","text":"List triggers cozy-stack triggers ls [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_triggers_ls/#examples","text":"$ cozy-stack triggers ls --domain cozy.tools:8080","title":"Examples"},{"location":"/cozy-stack/cli/cozy-stack_triggers_ls/#options","text":"-h, --help help for ls","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_triggers_ls/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_triggers_ls/#see-also","text":"cozy-stack triggers - Interact with the triggers","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_triggers_show-from-app/","text":"cozy-stack triggers show-from-app Show the application triggers Synopsis Show the application triggers cozy-stack triggers show-from-app [slug] [flags] Options -h, --help help for show-from-app Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack triggers - Interact with the triggers","title":"cozy-stack_triggers_show-from-app"},{"location":"/cozy-stack/cli/cozy-stack_triggers_show-from-app/#cozy-stack-triggers-show-from-app","text":"Show the application triggers","title":"cozy-stack triggers show-from-app"},{"location":"/cozy-stack/cli/cozy-stack_triggers_show-from-app/#synopsis","text":"Show the application triggers cozy-stack triggers show-from-app [slug] [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_triggers_show-from-app/#options","text":"-h, --help help for show-from-app","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_triggers_show-from-app/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --domain string specify the domain name of the instance (default cozy.tools:8080 ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_triggers_show-from-app/#see-also","text":"cozy-stack triggers - Interact with the triggers","title":"SEE ALSO"},{"location":"/cozy-stack/cli/cozy-stack_version/","text":"cozy-stack version Print the version number Synopsis Print the current version number of the binary cozy-stack version [flags] Options -h, --help help for version Options inherited from parent commands --admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080) SEE ALSO cozy-stack - cozy-stack is the main command","title":"cozy-stack_version"},{"location":"/cozy-stack/cli/cozy-stack_version/#cozy-stack-version","text":"Print the version number","title":"cozy-stack version"},{"location":"/cozy-stack/cli/cozy-stack_version/#synopsis","text":"Print the current version number of the binary cozy-stack version [flags]","title":"Synopsis"},{"location":"/cozy-stack/cli/cozy-stack_version/#options","text":"-h, --help help for version","title":"Options"},{"location":"/cozy-stack/cli/cozy-stack_version/#options-inherited-from-parent-commands","text":"--admin-host string administration server host (default localhost ) --admin-port int administration server port (default 6060) -c, --config string configuration file (default $HOME/.cozy.yaml ) --host string server host (default localhost ) -p, --port int server port (default 8080)","title":"Options inherited from parent commands"},{"location":"/cozy-stack/cli/cozy-stack_version/#see-also","text":"cozy-stack - cozy-stack is the main command","title":"SEE ALSO"},{"location":"/cozy-stack/couchdb-plugins/","text":"Table of contents Couchdb plugins analysis (original discussion is at https://github.com/cozy/cozy-stack/issues/9) Existing packages https://github.com/timjacobi/go-couchdb last edit 2016-08 Apparently one of the firsts Includes a http module, trying to figure out why, might simply be history (started in 2014) fork of the original https://github.com/fjl/go-couchdb brother of https://github.com/pokstad/go-couchdb which is used in this cool article : http://pokstad.com/2015/04/18/couchdb-and-go.html Have tools to run as couchdbapp / couchdbdaemon (we wont use these) Allow to pass a net/http.RoundTripper for fine transport tunning. Pr merged with some fix for couchdb2, not sure if there is more issue https://github.com/zemirco/couchdb last edit 2016-08 No functions for changes API Have a special interface for document {GetID(), GetRev()} https://github.com/rhinoman/couchdb-go last edit 2016-04 No functions for changes API Have functions for managing users and roles Have functions for proxying requests (downloads / uploads) support json byte[] as well as interface{} for documents Is clean and clear, but more complex because of more functions. We will need most those (users, proxy) https://github.com/dustin/go-couch last edit 2016-08 Simplest Plan B - Make our own from net/http If we go this way, it will be a good idea to look at the code of the other packages for each function, some pitfalls could be avoided : ex: https://github.com/rhinoman/couchdb-go/blob/94e6ab663d5789615eb061b52ed2e67310bac13f/connection.go#L81 Use custom Director httputil.ReverseProxy for file download / upload Considerations on how we will use it (see the architecture for more info) One stack instance communicate with one couchdb 2.x server or cluster. The couchdb server/cluster has a lot of databases (nb_users x nb_data_types). The pair stack+couch should handle as many active users as possible. Number of unactive users must not impact perfs too much. Note : definition of active user TBD (mobile app and 3rd party software are syncing using *dav and some background jobs like fetching banks accounts and threshold alerts ) HTTPS between stack and couchdb is not a priority. If it s an option, it will allow more flexibility for ops team, but we can always find alternative solution to secure channel between stack and couchdb and self-hosted users will probably have both on an single machine. We wont keep changes feed open, as it was identified in couchdb workshop as the limiting factor on number of databases we can have and we want to have a bazillion databases. We will probably do some kind of polling, this will need to be investigated deeper. Binaries will NOT be stored in couchdb. We will only store in couchdb reference to the file in another storage solution (FS / Swift) The stack will use couchdb in 2 ways : 1. Just proxying to/from the client, we will still need to parse the JSON, but will only read or changes a few special fields ( _id , _type , _tags ....) for ACL and then pipe it to/from couchdb. We wont need to make sense of the whole document and can eventually get away without parsing it on some routes. This part should be totally flexible on the json content. 2. Some APIs and Jobs will need to make sense of the given documents, so (un)marshal them from/into smarter struct (CalendarEvent) to be used in business logic. Analysis They are all relatively similar in term of API. rhinoman has some more functions that we will need but lack changes feed. They all have a struct for database which hold configuration, as most of our request will be on different databases, we will have a great churn for these structure. This is less than optimal for RAM GC, but probably insignificant against JSON parsing. They all use JSON Marshal et encode to accept any interface{} as couchdb doc. They are all relatively inactive / stable, not sure if it is because they are finished or abandonware. No library has a notion of pooling connection. This is handled at the net/http.Transport level in golang. Only the first library has option for fine-tunning of the internal Client/Transport, No library support couchdb2 mango Going further (thanks @tomquest) Another advantage of a DIY solution: building exactly what stack needs. This is orienting the CouchDB access code for Cozy usage. And this could be implemented as a DSL . For example: (if I understand the architecture, the goal is for an User to have many Databases, one for each DocumentType) // Create an Email couchdb .Doc(anEmail) // deduce the database from the type of the parameters .Create() // .Update() // .Delete() // List emails from 100 to 200 emails = couchdb .emails() // pick the appropriate database .Offset(100) .Limit(200) .Order(DATE, DESC) .select() // Create the adhoc CouchDb query (`Mango` style ?) BTW, couchdb could be an already configured object with the appropriate user credentials. Pros: Cozy-stack oriented (functionally) Still able to access CouchDb natively (eg. couchdb.Connection() ) Can hide technical stuff: access to the pool, concurrency, caching, https, retries, timeouts Build and maintained by Cozy Cons: DSL to write (and testing is a bit harder) To be maintained, but in fact, this is already the case for the other wrappers Current decision We will make our own driver by cherry picking relevant codes in other libraries.","title":"couchdb-plugins"},{"location":"/cozy-stack/couchdb-plugins/#couchdb-plugins-analysis","text":"(original discussion is at https://github.com/cozy/cozy-stack/issues/9)","title":"Couchdb plugins analysis"},{"location":"/cozy-stack/couchdb-plugins/#existing-packages","text":"","title":"Existing packages"},{"location":"/cozy-stack/couchdb-plugins/#httpsgithubcomtimjacobigo-couchdb","text":"last edit 2016-08 Apparently one of the firsts Includes a http module, trying to figure out why, might simply be history (started in 2014) fork of the original https://github.com/fjl/go-couchdb brother of https://github.com/pokstad/go-couchdb which is used in this cool article : http://pokstad.com/2015/04/18/couchdb-and-go.html Have tools to run as couchdbapp / couchdbdaemon (we wont use these) Allow to pass a net/http.RoundTripper for fine transport tunning. Pr merged with some fix for couchdb2, not sure if there is more issue","title":"https://github.com/timjacobi/go-couchdb"},{"location":"/cozy-stack/couchdb-plugins/#httpsgithubcomzemircocouchdb","text":"last edit 2016-08 No functions for changes API Have a special interface for document {GetID(), GetRev()}","title":"https://github.com/zemirco/couchdb"},{"location":"/cozy-stack/couchdb-plugins/#httpsgithubcomrhinomancouchdb-go","text":"last edit 2016-04 No functions for changes API Have functions for managing users and roles Have functions for proxying requests (downloads / uploads) support json byte[] as well as interface{} for documents Is clean and clear, but more complex because of more functions. We will need most those (users, proxy)","title":"https://github.com/rhinoman/couchdb-go"},{"location":"/cozy-stack/couchdb-plugins/#httpsgithubcomdustingo-couch","text":"last edit 2016-08 Simplest","title":"https://github.com/dustin/go-couch"},{"location":"/cozy-stack/couchdb-plugins/#plan-b-make-our-own-from-nethttp","text":"If we go this way, it will be a good idea to look at the code of the other packages for each function, some pitfalls could be avoided : ex: https://github.com/rhinoman/couchdb-go/blob/94e6ab663d5789615eb061b52ed2e67310bac13f/connection.go#L81 Use custom Director httputil.ReverseProxy for file download / upload","title":"Plan B - Make our own from net/http"},{"location":"/cozy-stack/couchdb-plugins/#considerations-on-how-we-will-use-it","text":"(see the architecture for more info) One stack instance communicate with one couchdb 2.x server or cluster. The couchdb server/cluster has a lot of databases (nb_users x nb_data_types). The pair stack+couch should handle as many active users as possible. Number of unactive users must not impact perfs too much. Note : definition of active user TBD (mobile app and 3rd party software are syncing using *dav and some background jobs like fetching banks accounts and threshold alerts ) HTTPS between stack and couchdb is not a priority. If it s an option, it will allow more flexibility for ops team, but we can always find alternative solution to secure channel between stack and couchdb and self-hosted users will probably have both on an single machine. We wont keep changes feed open, as it was identified in couchdb workshop as the limiting factor on number of databases we can have and we want to have a bazillion databases. We will probably do some kind of polling, this will need to be investigated deeper. Binaries will NOT be stored in couchdb. We will only store in couchdb reference to the file in another storage solution (FS / Swift) The stack will use couchdb in 2 ways : 1. Just proxying to/from the client, we will still need to parse the JSON, but will only read or changes a few special fields ( _id , _type , _tags ....) for ACL and then pipe it to/from couchdb. We wont need to make sense of the whole document and can eventually get away without parsing it on some routes. This part should be totally flexible on the json content. 2. Some APIs and Jobs will need to make sense of the given documents, so (un)marshal them from/into smarter struct (CalendarEvent) to be used in business logic.","title":"Considerations on how we will use it"},{"location":"/cozy-stack/couchdb-plugins/#analysis","text":"They are all relatively similar in term of API. rhinoman has some more functions that we will need but lack changes feed. They all have a struct for database which hold configuration, as most of our request will be on different databases, we will have a great churn for these structure. This is less than optimal for RAM GC, but probably insignificant against JSON parsing. They all use JSON Marshal et encode to accept any interface{} as couchdb doc. They are all relatively inactive / stable, not sure if it is because they are finished or abandonware. No library has a notion of pooling connection. This is handled at the net/http.Transport level in golang. Only the first library has option for fine-tunning of the internal Client/Transport, No library support couchdb2 mango","title":"Analysis"},{"location":"/cozy-stack/couchdb-plugins/#going-further-thanks-tomquest","text":"Another advantage of a DIY solution: building exactly what stack needs. This is orienting the CouchDB access code for Cozy usage. And this could be implemented as a DSL . For example: (if I understand the architecture, the goal is for an User to have many Databases, one for each DocumentType) // Create an Email couchdb .Doc(anEmail) // deduce the database from the type of the parameters .Create() // .Update() // .Delete() // List emails from 100 to 200 emails = couchdb .emails() // pick the appropriate database .Offset(100) .Limit(200) .Order(DATE, DESC) .select() // Create the adhoc CouchDb query (`Mango` style ?) BTW, couchdb could be an already configured object with the appropriate user credentials. Pros: Cozy-stack oriented (functionally) Still able to access CouchDb natively (eg. couchdb.Connection() ) Can hide technical stuff: access to the pool, concurrency, caching, https, retries, timeouts Build and maintained by Cozy Cons: DSL to write (and testing is a bit harder) To be maintained, but in fact, this is already the case for the other wrappers","title":"Going further (thanks @tomquest)"},{"location":"/cozy-stack/couchdb-plugins/#current-decision","text":"We will make our own driver by cherry picking relevant codes in other libraries.","title":"Current decision"},{"location":"/cozy-stack/import_export_exploration/","text":"Format de fichier Les applications cozy peuvent utiliser des fichiers pour stocker du contenu binaire, comme des photos ou des PDF. Les m\u00e9tadonn\u00e9es sont conserv\u00e9es dans CouchDB, mais les binaires peuvent acc\u00e9der au syst\u00e8me de fichier ou \u00e0 une instance Swift. Les formats standards utilis\u00e9s pour : Les fichiers/dossiers les attributs \u00e9tendus permettent \u00e0 l\u2019utilisateur d\u2019un systeme de fichier d\u2019associer des m\u00e9tadonn\u00e9es. https://godoc.org/github.com/ivaxer/go-xattr librairie go supportant les attributs \u00e9tendus Extensible Metadata Platform ou XMP est un format de m\u00e9tadonn\u00e9es bas\u00e9 sur XML. XMP permet d enregistrer sous forme d un document XML des informations relatives \u00e0 un fichier XMP d\u00e9finit diff\u00e9rentes m\u00e9thodes pour stocker ce document XML au sein m\u00eame de fichiers JPEG, GIF, HTML\u2026. stocker les fichiers json avec les m\u00e9tadonn\u00e9es dans un autre r\u00e9pertoire et les fichiers binaires \u00e0 part pour pouvoir r\u00e9cup\u00e9rer tous les fichiers lors de l\u2019export et remettre tout ca correctement lors de l\u2019import avec les json. Les albums (?) r\u00e9pertoires avec le nom de l\u2019album contenant les photos associ\u00e9es Les contacts Plusieurs formats sont utilis\u00e9s et ceci peut provoquer des incompatibilit\u00e9s entre differents clients. Google propose par exemple au client les deux types de formats (vcard et csv) (Il prend en charge l importation de fichiers CSV \u00e0 partir d Outlook, d Outlook Express, de Yahoo! Mail, de Hotmail, d Eudora et de certaines autres applications. Il prend \u00e9galement en charge l importation de fichiers vCard \u00e0 partir d applications telles que le Carnet d adresses Apple.) Les contacts iCloud sont import\u00e9s et export\u00e9s au format vCard vcard est un format standard ouvert d \u00e9change de donn\u00e9es personnelles (fichier d\u2019extension .vcf) Exemple BEGIN:VCARD VERSION:2.1 FN:Jean Dupont N:Dupont;Jean ADR;WORK;PREF;QUOTED-PRINTABLE:;Bruxelles 1200=Belgique;6A Rue Th. Decuyper LABEL;QUOTED-PRINTABLE;WORK;PREF:Rue Th. Decuyper 6A=Bruxelles 1200=Belgique TEL;CELL:+1234 56789 EMAIL;INTERNET:jean.dupont@example.com UID: END:VCARD csv format utilis\u00e9 pour les contacts \u00e9galement Exemple Prenom , Nom , Email , Age Jean , Petit , jean@monsite.fr , 34 Anne , Le Gall , anne@exemple.net , 21 Pierre , Diawara , pierre@sonsite.com , 44 Les calendriers iCalendar est un format de donn\u00e9es d\u00e9fini pour les \u00e9changes de donn\u00e9es de calendrier (fichier d\u2019extension .ical, ou .ics comme owncloud) Exemple BEGIN:VCALENDAR VERSION:2.0 PRODID:-//hacksw/handcal//NONSGML v1.0//EN BEGIN:VEVENT DTSTART:19970714T170000Z DTEND:19970715T035959Z SUMMARY:F\u00eate \u00e0 la Bastille END:VEVENT END:VCALENDAR Les formats utilis\u00e9s dans Cozy pour : Les fichiers/dossiers Un fichier est un contenu binaire avec certaines m\u00e9tadonn\u00e9es. Un fichier Json dans CouchDB contient un champ id , un champ rev et des m\u00e9tadonn\u00e9es . Ce fichier est reli\u00e9 au fichier binaire qui se trouve dans le systeme de fichier. Un fichier a un champ parent et lorsqu il est deplac\u00e9 dans l arboresence on ne modifie que le fichier Json sans toucher au contenu dans le systeme de fichier. Dans CouchDB, les fichers sont index\u00e9s et ont une structure arborescente. Les albums L album est un document dans CouchDB qui va lister les photos qu il contient.","title":"import_export_exploration"},{"location":"/cozy-stack/import_export_exploration/#format-de-fichier","text":"Les applications cozy peuvent utiliser des fichiers pour stocker du contenu binaire, comme des photos ou des PDF. Les m\u00e9tadonn\u00e9es sont conserv\u00e9es dans CouchDB, mais les binaires peuvent acc\u00e9der au syst\u00e8me de fichier ou \u00e0 une instance Swift.","title":"Format de fichier"},{"location":"/cozy-stack/import_export_exploration/#les-formats-standards-utilises-pour","text":"","title":"Les formats standards utilis\u00e9s pour :"},{"location":"/cozy-stack/import_export_exploration/#les-fichiersdossiers","text":"les attributs \u00e9tendus permettent \u00e0 l\u2019utilisateur d\u2019un systeme de fichier d\u2019associer des m\u00e9tadonn\u00e9es. https://godoc.org/github.com/ivaxer/go-xattr librairie go supportant les attributs \u00e9tendus Extensible Metadata Platform ou XMP est un format de m\u00e9tadonn\u00e9es bas\u00e9 sur XML. XMP permet d enregistrer sous forme d un document XML des informations relatives \u00e0 un fichier XMP d\u00e9finit diff\u00e9rentes m\u00e9thodes pour stocker ce document XML au sein m\u00eame de fichiers JPEG, GIF, HTML\u2026. stocker les fichiers json avec les m\u00e9tadonn\u00e9es dans un autre r\u00e9pertoire et les fichiers binaires \u00e0 part pour pouvoir r\u00e9cup\u00e9rer tous les fichiers lors de l\u2019export et remettre tout ca correctement lors de l\u2019import avec les json.","title":"Les fichiers/dossiers"},{"location":"/cozy-stack/import_export_exploration/#les-albums","text":"r\u00e9pertoires avec le nom de l\u2019album contenant les photos associ\u00e9es","title":"Les albums (?)"},{"location":"/cozy-stack/import_export_exploration/#les-contacts","text":"Plusieurs formats sont utilis\u00e9s et ceci peut provoquer des incompatibilit\u00e9s entre differents clients. Google propose par exemple au client les deux types de formats (vcard et csv) (Il prend en charge l importation de fichiers CSV \u00e0 partir d Outlook, d Outlook Express, de Yahoo! Mail, de Hotmail, d Eudora et de certaines autres applications. Il prend \u00e9galement en charge l importation de fichiers vCard \u00e0 partir d applications telles que le Carnet d adresses Apple.) Les contacts iCloud sont import\u00e9s et export\u00e9s au format vCard vcard est un format standard ouvert d \u00e9change de donn\u00e9es personnelles (fichier d\u2019extension .vcf) Exemple BEGIN:VCARD VERSION:2.1 FN:Jean Dupont N:Dupont;Jean ADR;WORK;PREF;QUOTED-PRINTABLE:;Bruxelles 1200=Belgique;6A Rue Th. Decuyper LABEL;QUOTED-PRINTABLE;WORK;PREF:Rue Th. Decuyper 6A=Bruxelles 1200=Belgique TEL;CELL:+1234 56789 EMAIL;INTERNET:jean.dupont@example.com UID: END:VCARD csv format utilis\u00e9 pour les contacts \u00e9galement Exemple Prenom , Nom , Email , Age Jean , Petit , jean@monsite.fr , 34 Anne , Le Gall , anne@exemple.net , 21 Pierre , Diawara , pierre@sonsite.com , 44","title":"Les contacts"},{"location":"/cozy-stack/import_export_exploration/#les-calendriers","text":"iCalendar est un format de donn\u00e9es d\u00e9fini pour les \u00e9changes de donn\u00e9es de calendrier (fichier d\u2019extension .ical, ou .ics comme owncloud) Exemple BEGIN:VCALENDAR VERSION:2.0 PRODID:-//hacksw/handcal//NONSGML v1.0//EN BEGIN:VEVENT DTSTART:19970714T170000Z DTEND:19970715T035959Z SUMMARY:F\u00eate \u00e0 la Bastille END:VEVENT END:VCALENDAR","title":"Les calendriers"},{"location":"/cozy-stack/import_export_exploration/#les-formats-utilises-dans-cozy-pour","text":"","title":"Les formats utilis\u00e9s dans Cozy pour :"},{"location":"/cozy-stack/import_export_exploration/#les-fichiersdossiers_1","text":"Un fichier est un contenu binaire avec certaines m\u00e9tadonn\u00e9es. Un fichier Json dans CouchDB contient un champ id , un champ rev et des m\u00e9tadonn\u00e9es . Ce fichier est reli\u00e9 au fichier binaire qui se trouve dans le systeme de fichier. Un fichier a un champ parent et lorsqu il est deplac\u00e9 dans l arboresence on ne modifie que le fichier Json sans toucher au contenu dans le systeme de fichier. Dans CouchDB, les fichers sont index\u00e9s et ont une structure arborescente.","title":"Les fichiers/dossiers"},{"location":"/cozy-stack/import_export_exploration/#les-albums_1","text":"L album est un document dans CouchDB qui va lister les photos qu il contient.","title":"Les albums"},{"location":"/cozy-stack/jsonapi/","text":"Table of contents JSON-API Introduction Except for the routes in /data , which imitate couchdb, most of the stack exposes a JSON-API interface. See JSON-API specification for more information. Pagination All routes that return a list are (or will be) paginated. As recommended for couchdb, we use cursor-based pagination. The default page limit is determined on a by-route basis. The client can require a different limit using page[limit] query parameter. If the client does not specify a limit, default limit will be used instead. If there is more docs after the limit, the response will contain a next key in its links section, with a page[cursor] set to fetch docs starting after the last one from current request. Alternatively, the client can opt in for skip mode by using page[skip] . When using skip, the number given in page[skip] is number of element ignored before returning value. Similarly, the response will contain a next link with a page[skip] set for next page (skip + limit). Example The /relationships/references as a default limit of 100. GET /data/some-type/some-id/relationships/references HTTP/1.1 { data : [ ... 100 docs ... ], links : { next : /data/some-type/some-id/relationships/references?page[limit]=100 page[cursor]=7845122548848454212 } } GET /data/some-type/some-id/relationships/references?page[limit]=10 HTTP/1.1 { data : [ ... 10 docs ... ], links : { next : /data/some-type/some-id/relationships/references?page[limit]=10 page[cursor]=5487ba7596 } } GET /data/some-type/some-id/relationships/references?page[limit]=100 page[cursor]=7845122548848454212 HTTP/1.1 { data : [ ... 20 docs ... ] } GET /data/some-type/some-id/relationships/references?page[limit]=10 page[skip]=0 HTTP/1.1 { data : [ ... 10 docs ... ], links : { next : /data/some-type/some-id/relationships/references?page[limit]=10 page[skip]=10 } }","title":"jsonapi"},{"location":"/cozy-stack/jsonapi/#json-api","text":"","title":"JSON-API"},{"location":"/cozy-stack/jsonapi/#introduction","text":"Except for the routes in /data , which imitate couchdb, most of the stack exposes a JSON-API interface. See JSON-API specification for more information.","title":"Introduction"},{"location":"/cozy-stack/jsonapi/#pagination","text":"All routes that return a list are (or will be) paginated. As recommended for couchdb, we use cursor-based pagination. The default page limit is determined on a by-route basis. The client can require a different limit using page[limit] query parameter. If the client does not specify a limit, default limit will be used instead. If there is more docs after the limit, the response will contain a next key in its links section, with a page[cursor] set to fetch docs starting after the last one from current request. Alternatively, the client can opt in for skip mode by using page[skip] . When using skip, the number given in page[skip] is number of element ignored before returning value. Similarly, the response will contain a next link with a page[skip] set for next page (skip + limit).","title":"Pagination"},{"location":"/cozy-stack/jsonapi/#example","text":"The /relationships/references as a default limit of 100. GET /data/some-type/some-id/relationships/references HTTP/1.1 { data : [ ... 100 docs ... ], links : { next : /data/some-type/some-id/relationships/references?page[limit]=100 page[cursor]=7845122548848454212 } } GET /data/some-type/some-id/relationships/references?page[limit]=10 HTTP/1.1 { data : [ ... 10 docs ... ], links : { next : /data/some-type/some-id/relationships/references?page[limit]=10 page[cursor]=5487ba7596 } } GET /data/some-type/some-id/relationships/references?page[limit]=100 page[cursor]=7845122548848454212 HTTP/1.1 { data : [ ... 20 docs ... ] } GET /data/some-type/some-id/relationships/references?page[limit]=10 page[skip]=0 HTTP/1.1 { data : [ ... 10 docs ... ], links : { next : /data/some-type/some-id/relationships/references?page[limit]=10 page[skip]=10 } }","title":"Example"},{"location":"/cozy-stack/konnectors_design/","text":"Table of contents Konnectors What we want ? Konnectors is an application for Cozy v2 that fetch data from different web sites and services, and save them into a Cozy. The 50+ connectors represent a lot of work from the community. So, we want to port it to Cozy v3. There will be 2 parts: My Accounts, a client-side app, that will offer the possibility for the user to configure her accounts, and choose when to start the import of data (see the architecture doc ). Konnectors, a worker for the job service , with the code to import data from the web sites. Security The risks Konnectors is not just a random application. It s a very good target for attacks on Cozy because of these specificities: It run on the server, where there is no Content Security Policy, or firewall to protect the stack. It has access to Internet, by design. It is written in nodejs, with a lot of dependencies where it is easy to hide malicious code. It is a collection of connectors written by a lot of people. We welcome these contributions, but it also means that we take into account that we can t review in depth all the contributions. Access to couchdb The stack has the admin credentials of couchdb. If a rogue code can read its configuration file or intercept connexions between the stack and couchdb, it will have access to couchdb with the admin credentials, and can do anything on couchdb. Access to the stack An attacker can try to profit of konnectors for accessing the stack. It can target the port 6060, used by the stack to manage the cozy instances. Or, it can use its privileged position for timing attacks on passwords. Spying other connectors A rogue connector may try to spy other connectors to pick the credentials for external web sites. It can be done by reading the environment variables or ptracing them. DoS A connector can use a lot of CPU, Ram, or generate a lot of disk I/O to make a deny of service on the server. The connector can remove files on the server to make konnectors stop working. Exploiting the CPU or the bandwidth The resources of the server can be seen as valuable: the CPU can be used for bitcoins mining. The bandwidth can be used for DDoS of an external target. Sending spam Profit of the configured SMTP server to send spams. Be root Row hammer can be a way to gain root access on a server. Possible measures Permissions We can forbid the konnectors to speak directly with couchdb, and pass by the stack for that. And use the permissions to restrict what each konnectors can do with the cozy-stack. ignore-scripts for npm/yarn Npm and yarn can execute scripts defined in package.json when installing nodejs dependencies. We can use the ignore-scripts option to disable this behaviour. Forbid addons in nodejs Nodejs can require addons , ie C/C++ compiled libraries. I ve found no flag to disable the install of such modules for npm/yarn, and no flag for nodejs to prevent loading them. We can try to detect and remove such modules just after the installation of node modules. They should have a .node extension. Note : not having a compiler on the server is not enough. Npm can install precompiled modules. vm/sandbox for Nodejs vm2 is a sandbox that can run untrusted code with whitelisted Node s built-in modules. Mock net We can mock the net module of nodejs to add some restrictions on what it can do. For example, we can check that it does only http/https, and blacklist connection to localhost:6060. It is only effective if the konnector has no way to start a new node processus. Timeout If a konnector takes too long, after a timeout, it should be killed. It implies that the cozy-stacks supervises the konnectors. Chroot Chroot is a UNIX syscall that makes an application see only a part of the file-system. In particular, we can remove access to /proc and /sys by not mounting them, and limit access to /dev to just /dev/null , /dev/zero , and /dev/random by symlinks them. Executing as another user We can create UNIX users that will just serve to execute the konnectors, and nothing else. It s a nice way to give more isolation, but it means that we have to find a way to execute the konnectors: either run the cozy-stack as root, or have a daemon that launches the konnectors. Ulimit Prlimit ulimit provides control over the resources available to the shell and to processes started by it, on systems that allow such control. It can be used to linit the number of processes (protection against fork bombs), or the memory that can be used. prlimit can do the same for just one command (technically, for a new session, not the current one). Linux namespaces One feature Linux provides here is namespaces. There are a bunch of different kinds: in a pid namespace you become PID 1 and then your children are other processes. All the other programs are gone in a networking namespace you can run programs on any port you want without it conflicting with what\u2019s already running in a mount namespace you can mount and unmount filesystems without it affecting the host filesystem. So you can have a totally different set of devices mounted (usually less). It turns out that making namespaces is totally easy! You can just run a program called unshare . Source: What even is a container, by Julia Evans Cgroups cgroups (abbreviated from control groups) is a Linux kernel feature that limits, accounts for, and isolates the resource usage (CPU, memory, disk I/O, network, etc.) of a collection of processes. Seccomp BPF Seccomp BPF is an extension to seccomp that allows filtering of system calls using a configurable policy implemented using Berkeley Packet Filter rules. Isolation in a docker Isode is a 3 years old project that aims to isolate nodejs apps in docker containers. A possibility would be to follow this path and isolate the konnectors inside docker. It s a real burden for administrators. And its command line options often changes from one version to another, making difficult to deploy something reliable for self-hosted users. So we will try to avoid it. Isolation in docker contains is mostly a combination of Linux Namespaces, Cgroups, and Seccomp BPF. There are other options with those (see below). Rkt Rkt is a security-minded, standard-based container engine. It is similar to Docker, but Docker needs running a daemon whereas rkt can be launched from command-line with no daemon. NsJail / FireJail NsJail and FireJail are two tools that use Linux Namespaces and Seccomp BPF to reduce the risks to run untrusted applications on Linux. FireJail seems to be more suited for graphical apps, and NsJail for networking services. NaCl / ZeroVM ZeroVM is an open source virtualization technology that is based on the Chromium Native Client (NaCl) project. ZeroVM creates a secure and isolated execution environment which can run a single thread or application. But NaCl is no longer maintained and ZeroVM has some severe limitations, so, it won t be used. Konnector isolation study The short list of tools which will be tested to isolate connectors is Rkt and NsJail which on paper better fullfill our needs. NsJail NsJail is a lightweight process isolation tool, making use of Linux namespaces and seccomp-bpf syscall filters. It is not a container tool like docker. Its features are quite extensive regarding isolation. The README gives the full list of available options. Although available in the google github, it is not an official google tool. NsJail is: easy to install : just a make away with standard build tools offers a full list or isolation tools lightly documented the only documentation is nsjail -h (also available in the main github page) and it is quite cryptic for a non-sysadmin like me. I could not find any help in any search engine. Some examples are available to run a back in an isolated process and work but I could not run a full nodejs (only nodejs -v worked) The konnectors will need a full nodejs installed on the host Is still actively maintained Rkt Rkt is very similar to docker. It can even directly run docker images from the docker registry, which gives us a lot of existing images to use, even if we want to be able to use other languages than node. For example, we could have also a container dedicated to weboob, another container could use phantomjs or casper and without forcing self-hosted users to do complicated installation procedures. Rkt is : easy to install : debian, rpm package available, archlinux community package : https://github.com/coreos/rkt/releases has network isolation like docker offers CPU, memory limitation, seccomp isolation (but the set of rules to use is out of my understanding) is well documented , complete man pages, but not as well known as docker, then there is not a lot of things to find outside the official documentation. can use docker image directly or can convert them to one runnable aci file with one simple cli command (rkt export) is in active developpement but relatively stable regarding core features. container images can be easily signed and the signature is checked by default when running a container. I managed to run a nodejs container with just the following commands : rkt run --insecure-options=image --interactive docker://node:slim --name nodeslim -- -v rkt list # to get the container uuid rkt export --app=nodeslim uuid nodeslim.aci rkt run --insecure-options=image --interactive nodeslim.aci -- -v # to run node -v in the new container Note: the insecure-options param is to avoid the check of the image signature to ease the demonstration Choice The best choice would be Rkt for it s ease of use (which is good for contribution) and wide range of isolation features + access to the big docker ecosystem without beeing a burden for the host administrator. Note : the limitation of NsJail I saw might be due to my lack of knowledge regarding system administration. Proposed use of rkt regarding connectors Installation As stated before, rkt is easy to install. It may also be possible to make it available in the cozy-stack docker image but I did not test it (TODO) Image creation To create an ACI file image, you just need to run a docker image one time : rkt run --uuid-file-save=$PWD/uuid --insecure-options=image --interactive docker://node:slim --name nodeslim -- -v rkt export --app=nodeslim `cat uuid` nodeslim.aci rm uuid The node:slim image weights 84M at this time. The node:alpine image also exists and is way lighter (19M) but I had problems with DNS with this, and alpine can cause some nasty bugs that are difficult to track. Running a connector A path dedicated to run the konnectors with a predefined list of node packages available (the net module could be mocked with special limitations to blacklist some urls) A script will run the node container giving as option the script to launch. The path is mounted inside the container. The following script does just that #!/usr/bin/env bash rm -rf ./container_dir cp -r ./container_dir_template ./container_dir rkt run --net=host --environment=CREDENTIAL=value;COZY_URL=url --uuid-file-save=$PWD/uuid --volume data,kind=host,source=$PWD/container_dir --insecure-options=image nodeslim.aci --cpu=100m --memory=128M --name rktnode --mount volume=data,target=/usr/src/app --exec node -- /usr/src/app/$1 $2 # the container will handle itself the communication with the stack sleep 60 rkt stop --force --uuid-file=uuid rkt rm --uuid-file=uuid rm -rf ./container_dir This script can be run like this : ./rkt.sh mynewkonnector.js If the mynewkonnector.js file is available in the container_dir_template directory. Cons : must forbid access to port 5984 and 6060 + SMTP server The limitation of time, CPU and memory will avoid most DOS attacks (to my knowledge). For memory use, I still don t see a way to prevent the excessive use of swap from the container. To prevent the connectors from listening to each other, they should be run in containers with different uid, avoiding them to listen to each other. Solution to limit access of the container to 5984 and 6060 ports + SMTP The container must be started in bridged mode. With that, the container still has access to localhost but through a specific IP address visible with ifconfig. That way, the host can have iptable rules to forbid access to specified ports to the bridge. To connect a container in bridge mode : On the host create the file /etc/rkt/net.d/10-containers.conf { name : bridge , type : bridge , bridge : rkt-bridge-nat , ipMasq : true, isGateway : true, ipam : { type : host-local , subnet : 10.2.0.0/24 , routes : [ { dst : 0.0.0.0/0 } ] } } and run your container with the net=bridge option. That way, a new interface is available in the container and gives you access to the host. Konnector install and run details Install The konnectors will be installed in the .cozy_konnectors directory which is in the VFS using git clone (like the apps at the moment). The konnectors installation may be triggered when the user says he wants to use it. The resulting repository is then kept for each run of the konnector. It may then be given to the user the possibility to upgrade the konnector to the latest version if any. To update a given konnector, a git pull command is run on the konnector. Details about running a konnector To run a given konnector, the stack will copy this connector in a run directory, which is not in the VFS. This directory will be given to the rocket container as the current working directory with full read and write access on it. This is where the container will put its logs and any temp file needed. There will be also cozy-client.js and the shared libraries in a lib directory inside this directory. The lib directory will be the content of the actual server lib directory . The konnector will be run with the following environment variables : COZY_CREDENTIALS : containing the response to Oauth request as json string COZY_URL : to know what instance is running the konnector COZY_FIELDS : as a json string with all the values from the account associated to the konnector. COZY_PARAMETERS : optional json string associated with the application, used to parameterize a konnector based on a common set of code. In the end of the konnector execution (or timeout), the logs are read in the log.txt file and added to the konnector own log file (in VFS) and the run directory is then destroyed. Multi-account handling This section is devoted to allow the user to use one account for multiple konnectors. It will follow the following constraints in mind: The migration path must be as easy as possible The developpement and maintainance of konnector must also be as easy as possible New doctype : io.cozy.accounts A new doctype will have to be created to allow to keep konnector accounts independently from each konnector. The one once used by the email application seems to be a good candidate : io.cozy.accounts Here is an example document with this doctype : { _id: ojpiojpoij , name: user decided name for the account , accountType: google , login: mylogin , password: 123456 } Any attribute needed for the account may be added : email, etc Updates needed in existing application and konnectors CRUD manipulation of io.cozy.accounts and linking them with konnectors will be handled by the my accounts client application. Each konnector need also to declare a new field in the fields attribute which will be the type of account, related to the accountType field in the new account docType. Ex: module.exports = baseKonnector.createNew({ name: 'Trainline', vendorLink: 'www.captaintrain.com', category: 'transport', color: { hex: '#48D5B5', css: '#48D5B5' }, fields: { login: { type: 'text' }, password: { type: 'password' }, folderPath: { type: 'folder', advanced: true }, accountType: trainline }, dataType: ['bill'], models: [Bill], fetchOperations: [ ... ] }) With this new field, which will appear also in the io.cozy.konnectors docType, the my account client appliction will be able to propose existing accounts of the good type for activating a new konnector. Migration path For the migration of existing, activated konnectors in V2, the type of account for each konnector will have to be indicated in a V2 my account application update. After that, it will be possible to create the accounts associated to each activated konnectors an link the konnectors to these accounts in a migration script. Study on konnectors installation on VFS The VFS is slow and installing npm packages on it will cause some performance problem. We are trying to find solution to handle that. We found 3 possible solutions : Install the konnector on VFS as tar.gz files with all the dependencies included by the konnector developper advantages : easy for the konnector developper, as performant as a cp, no nedd for a compiled version of the konnector source, no duplication of code in the repo drawbacks : The source are not readable in files application then more complicated to study the konnector source, not really nice , still could take a lot of space on VFS Use webpack with target: node option to make a node bundle of the dependencies advantages : the konnector itself stays in clear on the VFS drawbacks : forces a compilation of the sources and then a sync between the source and bundle in the git repo by the konnector developper, forces konnector developpers to use webpack. Install the npm dependencies with yarn in an immutable cache ( cache-folder option) in a directory like deps-${konnector-git-sha1} not in VFS. advantages : easier for the konnector developper, no particular dependency handling, no mandatory compilation, just a package.json in the git repository, the cache can be shared by instances drawbacks : node only solution, maybe more work on the cozy-stack side TODO [x] How to install and update the konnectors? [x] Are the konnectors installed once per server or per instance (in the VFS like client-side apps)? [x] One git repository with all the konnectors (like now), or one repos per konnector? Same question for package.json [ ] What API to list the konnectors for My Accounts? [ ] What workflow for developing a konnector? [ ] How to test konnectors? [x] How are managed the locales? : declared in manfiest.konnector [x] Which version of nodejs? Last LTS version bundled in a rocket container [ ] Do you keep coffeescript? Or move every konnector to ES2017? 28 konnectors in coffee 22 konnectors in JS [ ] What about weboob? [ ] What roadmap for transforming the konnectors-v2 in konnectors-v3? [x] What format for the konnectors manifest? [x] What permissions for a konnector? [ ] For konnectors that import files, how can we let the user select a folder and have an associated permission for the konnector in this folder (and not anywhere else on the virtual file system)? [ ] Can we associate the data retrieved by a konnector to a profile ? The goal is to allow a client-side to have a permission on this profile and be able to read all the data fetched by a given konnector (or is tied to an account)? [ ] How are logged the data exported/synchronized by a push konnector? [x] Analyze the konnectors node_modules no compiled modules currently 28 dependencies that install 65 MB for 271 modules in production 71 dependencies that install 611 MB for 858 modules with dev dependencies [ ] How are persisted the accounts? [x] How is executed a konnector? In particular, how the credentials are given to the konnector? [ ] what should expose a konnector (data, functions, etc)? https://github.com/cozy-labs/konnectors/issues/695 [ ] How can we support konnectors with OAuth?","title":"konnectors_design"},{"location":"/cozy-stack/konnectors_design/#konnectors","text":"","title":"Konnectors"},{"location":"/cozy-stack/konnectors_design/#what-we-want","text":"Konnectors is an application for Cozy v2 that fetch data from different web sites and services, and save them into a Cozy. The 50+ connectors represent a lot of work from the community. So, we want to port it to Cozy v3. There will be 2 parts: My Accounts, a client-side app, that will offer the possibility for the user to configure her accounts, and choose when to start the import of data (see the architecture doc ). Konnectors, a worker for the job service , with the code to import data from the web sites.","title":"What we want ?"},{"location":"/cozy-stack/konnectors_design/#security","text":"","title":"Security"},{"location":"/cozy-stack/konnectors_design/#the-risks","text":"Konnectors is not just a random application. It s a very good target for attacks on Cozy because of these specificities: It run on the server, where there is no Content Security Policy, or firewall to protect the stack. It has access to Internet, by design. It is written in nodejs, with a lot of dependencies where it is easy to hide malicious code. It is a collection of connectors written by a lot of people. We welcome these contributions, but it also means that we take into account that we can t review in depth all the contributions.","title":"The risks"},{"location":"/cozy-stack/konnectors_design/#access-to-couchdb","text":"The stack has the admin credentials of couchdb. If a rogue code can read its configuration file or intercept connexions between the stack and couchdb, it will have access to couchdb with the admin credentials, and can do anything on couchdb.","title":"Access to couchdb"},{"location":"/cozy-stack/konnectors_design/#access-to-the-stack","text":"An attacker can try to profit of konnectors for accessing the stack. It can target the port 6060, used by the stack to manage the cozy instances. Or, it can use its privileged position for timing attacks on passwords.","title":"Access to the stack"},{"location":"/cozy-stack/konnectors_design/#spying-other-connectors","text":"A rogue connector may try to spy other connectors to pick the credentials for external web sites. It can be done by reading the environment variables or ptracing them.","title":"Spying other connectors"},{"location":"/cozy-stack/konnectors_design/#dos","text":"A connector can use a lot of CPU, Ram, or generate a lot of disk I/O to make a deny of service on the server. The connector can remove files on the server to make konnectors stop working.","title":"DoS"},{"location":"/cozy-stack/konnectors_design/#exploiting-the-cpu-or-the-bandwidth","text":"The resources of the server can be seen as valuable: the CPU can be used for bitcoins mining. The bandwidth can be used for DDoS of an external target.","title":"Exploiting the CPU or the bandwidth"},{"location":"/cozy-stack/konnectors_design/#sending-spam","text":"Profit of the configured SMTP server to send spams.","title":"Sending spam"},{"location":"/cozy-stack/konnectors_design/#be-root","text":"Row hammer can be a way to gain root access on a server.","title":"Be root"},{"location":"/cozy-stack/konnectors_design/#possible-measures","text":"","title":"Possible measures"},{"location":"/cozy-stack/konnectors_design/#permissions","text":"We can forbid the konnectors to speak directly with couchdb, and pass by the stack for that. And use the permissions to restrict what each konnectors can do with the cozy-stack.","title":"Permissions"},{"location":"/cozy-stack/konnectors_design/#ignore-scripts-for-npmyarn","text":"Npm and yarn can execute scripts defined in package.json when installing nodejs dependencies. We can use the ignore-scripts option to disable this behaviour.","title":"ignore-scripts for npm/yarn"},{"location":"/cozy-stack/konnectors_design/#forbid-addons-in-nodejs","text":"Nodejs can require addons , ie C/C++ compiled libraries. I ve found no flag to disable the install of such modules for npm/yarn, and no flag for nodejs to prevent loading them. We can try to detect and remove such modules just after the installation of node modules. They should have a .node extension. Note : not having a compiler on the server is not enough. Npm can install precompiled modules.","title":"Forbid addons in nodejs"},{"location":"/cozy-stack/konnectors_design/#vmsandbox-for-nodejs","text":"vm2 is a sandbox that can run untrusted code with whitelisted Node s built-in modules.","title":"vm/sandbox for Nodejs"},{"location":"/cozy-stack/konnectors_design/#mock-net","text":"We can mock the net module of nodejs to add some restrictions on what it can do. For example, we can check that it does only http/https, and blacklist connection to localhost:6060. It is only effective if the konnector has no way to start a new node processus.","title":"Mock net"},{"location":"/cozy-stack/konnectors_design/#timeout","text":"If a konnector takes too long, after a timeout, it should be killed. It implies that the cozy-stacks supervises the konnectors.","title":"Timeout"},{"location":"/cozy-stack/konnectors_design/#chroot","text":"Chroot is a UNIX syscall that makes an application see only a part of the file-system. In particular, we can remove access to /proc and /sys by not mounting them, and limit access to /dev to just /dev/null , /dev/zero , and /dev/random by symlinks them.","title":"Chroot"},{"location":"/cozy-stack/konnectors_design/#executing-as-another-user","text":"We can create UNIX users that will just serve to execute the konnectors, and nothing else. It s a nice way to give more isolation, but it means that we have to find a way to execute the konnectors: either run the cozy-stack as root, or have a daemon that launches the konnectors.","title":"Executing as another user"},{"location":"/cozy-stack/konnectors_design/#ulimit-prlimit","text":"ulimit provides control over the resources available to the shell and to processes started by it, on systems that allow such control. It can be used to linit the number of processes (protection against fork bombs), or the memory that can be used. prlimit can do the same for just one command (technically, for a new session, not the current one).","title":"Ulimit &amp; Prlimit"},{"location":"/cozy-stack/konnectors_design/#linux-namespaces","text":"One feature Linux provides here is namespaces. There are a bunch of different kinds: in a pid namespace you become PID 1 and then your children are other processes. All the other programs are gone in a networking namespace you can run programs on any port you want without it conflicting with what\u2019s already running in a mount namespace you can mount and unmount filesystems without it affecting the host filesystem. So you can have a totally different set of devices mounted (usually less). It turns out that making namespaces is totally easy! You can just run a program called unshare . Source: What even is a container, by Julia Evans","title":"Linux namespaces"},{"location":"/cozy-stack/konnectors_design/#cgroups","text":"cgroups (abbreviated from control groups) is a Linux kernel feature that limits, accounts for, and isolates the resource usage (CPU, memory, disk I/O, network, etc.) of a collection of processes.","title":"Cgroups"},{"location":"/cozy-stack/konnectors_design/#seccomp-bpf","text":"Seccomp BPF is an extension to seccomp that allows filtering of system calls using a configurable policy implemented using Berkeley Packet Filter rules.","title":"Seccomp BPF"},{"location":"/cozy-stack/konnectors_design/#isolation-in-a-docker","text":"Isode is a 3 years old project that aims to isolate nodejs apps in docker containers. A possibility would be to follow this path and isolate the konnectors inside docker. It s a real burden for administrators. And its command line options often changes from one version to another, making difficult to deploy something reliable for self-hosted users. So we will try to avoid it. Isolation in docker contains is mostly a combination of Linux Namespaces, Cgroups, and Seccomp BPF. There are other options with those (see below).","title":"Isolation in a docker"},{"location":"/cozy-stack/konnectors_design/#rkt","text":"Rkt is a security-minded, standard-based container engine. It is similar to Docker, but Docker needs running a daemon whereas rkt can be launched from command-line with no daemon.","title":"Rkt"},{"location":"/cozy-stack/konnectors_design/#nsjail-firejail","text":"NsJail and FireJail are two tools that use Linux Namespaces and Seccomp BPF to reduce the risks to run untrusted applications on Linux. FireJail seems to be more suited for graphical apps, and NsJail for networking services.","title":"NsJail / FireJail"},{"location":"/cozy-stack/konnectors_design/#nacl-zerovm","text":"ZeroVM is an open source virtualization technology that is based on the Chromium Native Client (NaCl) project. ZeroVM creates a secure and isolated execution environment which can run a single thread or application. But NaCl is no longer maintained and ZeroVM has some severe limitations, so, it won t be used.","title":"NaCl / ZeroVM"},{"location":"/cozy-stack/konnectors_design/#konnector-isolation-study","text":"The short list of tools which will be tested to isolate connectors is Rkt and NsJail which on paper better fullfill our needs.","title":"Konnector isolation study"},{"location":"/cozy-stack/konnectors_design/#nsjail","text":"NsJail is a lightweight process isolation tool, making use of Linux namespaces and seccomp-bpf syscall filters. It is not a container tool like docker. Its features are quite extensive regarding isolation. The README gives the full list of available options. Although available in the google github, it is not an official google tool. NsJail is: easy to install : just a make away with standard build tools offers a full list or isolation tools lightly documented the only documentation is nsjail -h (also available in the main github page) and it is quite cryptic for a non-sysadmin like me. I could not find any help in any search engine. Some examples are available to run a back in an isolated process and work but I could not run a full nodejs (only nodejs -v worked) The konnectors will need a full nodejs installed on the host Is still actively maintained","title":"NsJail"},{"location":"/cozy-stack/konnectors_design/#rkt_1","text":"Rkt is very similar to docker. It can even directly run docker images from the docker registry, which gives us a lot of existing images to use, even if we want to be able to use other languages than node. For example, we could have also a container dedicated to weboob, another container could use phantomjs or casper and without forcing self-hosted users to do complicated installation procedures. Rkt is : easy to install : debian, rpm package available, archlinux community package : https://github.com/coreos/rkt/releases has network isolation like docker offers CPU, memory limitation, seccomp isolation (but the set of rules to use is out of my understanding) is well documented , complete man pages, but not as well known as docker, then there is not a lot of things to find outside the official documentation. can use docker image directly or can convert them to one runnable aci file with one simple cli command (rkt export) is in active developpement but relatively stable regarding core features. container images can be easily signed and the signature is checked by default when running a container. I managed to run a nodejs container with just the following commands : rkt run --insecure-options=image --interactive docker://node:slim --name nodeslim -- -v rkt list # to get the container uuid rkt export --app=nodeslim uuid nodeslim.aci rkt run --insecure-options=image --interactive nodeslim.aci -- -v # to run node -v in the new container Note: the insecure-options param is to avoid the check of the image signature to ease the demonstration","title":"Rkt"},{"location":"/cozy-stack/konnectors_design/#choice","text":"The best choice would be Rkt for it s ease of use (which is good for contribution) and wide range of isolation features + access to the big docker ecosystem without beeing a burden for the host administrator. Note : the limitation of NsJail I saw might be due to my lack of knowledge regarding system administration.","title":"Choice"},{"location":"/cozy-stack/konnectors_design/#proposed-use-of-rkt-regarding-connectors","text":"","title":"Proposed use of rkt regarding connectors"},{"location":"/cozy-stack/konnectors_design/#installation","text":"As stated before, rkt is easy to install. It may also be possible to make it available in the cozy-stack docker image but I did not test it (TODO)","title":"Installation"},{"location":"/cozy-stack/konnectors_design/#image-creation","text":"To create an ACI file image, you just need to run a docker image one time : rkt run --uuid-file-save=$PWD/uuid --insecure-options=image --interactive docker://node:slim --name nodeslim -- -v rkt export --app=nodeslim `cat uuid` nodeslim.aci rm uuid The node:slim image weights 84M at this time. The node:alpine image also exists and is way lighter (19M) but I had problems with DNS with this, and alpine can cause some nasty bugs that are difficult to track.","title":"Image creation"},{"location":"/cozy-stack/konnectors_design/#running-a-connector","text":"A path dedicated to run the konnectors with a predefined list of node packages available (the net module could be mocked with special limitations to blacklist some urls) A script will run the node container giving as option the script to launch. The path is mounted inside the container. The following script does just that #!/usr/bin/env bash rm -rf ./container_dir cp -r ./container_dir_template ./container_dir rkt run --net=host --environment=CREDENTIAL=value;COZY_URL=url --uuid-file-save=$PWD/uuid --volume data,kind=host,source=$PWD/container_dir --insecure-options=image nodeslim.aci --cpu=100m --memory=128M --name rktnode --mount volume=data,target=/usr/src/app --exec node -- /usr/src/app/$1 $2 # the container will handle itself the communication with the stack sleep 60 rkt stop --force --uuid-file=uuid rkt rm --uuid-file=uuid rm -rf ./container_dir This script can be run like this : ./rkt.sh mynewkonnector.js If the mynewkonnector.js file is available in the container_dir_template directory. Cons : must forbid access to port 5984 and 6060 + SMTP server The limitation of time, CPU and memory will avoid most DOS attacks (to my knowledge). For memory use, I still don t see a way to prevent the excessive use of swap from the container. To prevent the connectors from listening to each other, they should be run in containers with different uid, avoiding them to listen to each other.","title":"Running a connector"},{"location":"/cozy-stack/konnectors_design/#solution-to-limit-access-of-the-container-to-5984-and-6060-ports-smtp","text":"The container must be started in bridged mode. With that, the container still has access to localhost but through a specific IP address visible with ifconfig. That way, the host can have iptable rules to forbid access to specified ports to the bridge. To connect a container in bridge mode : On the host create the file /etc/rkt/net.d/10-containers.conf { name : bridge , type : bridge , bridge : rkt-bridge-nat , ipMasq : true, isGateway : true, ipam : { type : host-local , subnet : 10.2.0.0/24 , routes : [ { dst : 0.0.0.0/0 } ] } } and run your container with the net=bridge option. That way, a new interface is available in the container and gives you access to the host.","title":"Solution to limit access of the container to 5984 and 6060 ports + SMTP"},{"location":"/cozy-stack/konnectors_design/#konnector-install-and-run-details","text":"","title":"Konnector install and run details"},{"location":"/cozy-stack/konnectors_design/#install","text":"The konnectors will be installed in the .cozy_konnectors directory which is in the VFS using git clone (like the apps at the moment). The konnectors installation may be triggered when the user says he wants to use it. The resulting repository is then kept for each run of the konnector. It may then be given to the user the possibility to upgrade the konnector to the latest version if any. To update a given konnector, a git pull command is run on the konnector.","title":"Install"},{"location":"/cozy-stack/konnectors_design/#details-about-running-a-konnector","text":"To run a given konnector, the stack will copy this connector in a run directory, which is not in the VFS. This directory will be given to the rocket container as the current working directory with full read and write access on it. This is where the container will put its logs and any temp file needed. There will be also cozy-client.js and the shared libraries in a lib directory inside this directory. The lib directory will be the content of the actual server lib directory . The konnector will be run with the following environment variables : COZY_CREDENTIALS : containing the response to Oauth request as json string COZY_URL : to know what instance is running the konnector COZY_FIELDS : as a json string with all the values from the account associated to the konnector. COZY_PARAMETERS : optional json string associated with the application, used to parameterize a konnector based on a common set of code. In the end of the konnector execution (or timeout), the logs are read in the log.txt file and added to the konnector own log file (in VFS) and the run directory is then destroyed.","title":"Details about running a konnector"},{"location":"/cozy-stack/konnectors_design/#multi-account-handling","text":"This section is devoted to allow the user to use one account for multiple konnectors. It will follow the following constraints in mind: The migration path must be as easy as possible The developpement and maintainance of konnector must also be as easy as possible","title":"Multi-account handling"},{"location":"/cozy-stack/konnectors_design/#new-doctype-iocozyaccounts","text":"A new doctype will have to be created to allow to keep konnector accounts independently from each konnector. The one once used by the email application seems to be a good candidate : io.cozy.accounts Here is an example document with this doctype : { _id: ojpiojpoij , name: user decided name for the account , accountType: google , login: mylogin , password: 123456 } Any attribute needed for the account may be added : email, etc","title":"New doctype : io.cozy.accounts"},{"location":"/cozy-stack/konnectors_design/#updates-needed-in-existing-application-and-konnectors","text":"CRUD manipulation of io.cozy.accounts and linking them with konnectors will be handled by the my accounts client application. Each konnector need also to declare a new field in the fields attribute which will be the type of account, related to the accountType field in the new account docType. Ex: module.exports = baseKonnector.createNew({ name: 'Trainline', vendorLink: 'www.captaintrain.com', category: 'transport', color: { hex: '#48D5B5', css: '#48D5B5' }, fields: { login: { type: 'text' }, password: { type: 'password' }, folderPath: { type: 'folder', advanced: true }, accountType: trainline }, dataType: ['bill'], models: [Bill], fetchOperations: [ ... ] }) With this new field, which will appear also in the io.cozy.konnectors docType, the my account client appliction will be able to propose existing accounts of the good type for activating a new konnector.","title":"Updates needed in existing application and konnectors"},{"location":"/cozy-stack/konnectors_design/#migration-path","text":"For the migration of existing, activated konnectors in V2, the type of account for each konnector will have to be indicated in a V2 my account application update. After that, it will be possible to create the accounts associated to each activated konnectors an link the konnectors to these accounts in a migration script.","title":"Migration path"},{"location":"/cozy-stack/konnectors_design/#study-on-konnectors-installation-on-vfs","text":"The VFS is slow and installing npm packages on it will cause some performance problem. We are trying to find solution to handle that. We found 3 possible solutions : Install the konnector on VFS as tar.gz files with all the dependencies included by the konnector developper advantages : easy for the konnector developper, as performant as a cp, no nedd for a compiled version of the konnector source, no duplication of code in the repo drawbacks : The source are not readable in files application then more complicated to study the konnector source, not really nice , still could take a lot of space on VFS Use webpack with target: node option to make a node bundle of the dependencies advantages : the konnector itself stays in clear on the VFS drawbacks : forces a compilation of the sources and then a sync between the source and bundle in the git repo by the konnector developper, forces konnector developpers to use webpack. Install the npm dependencies with yarn in an immutable cache ( cache-folder option) in a directory like deps-${konnector-git-sha1} not in VFS. advantages : easier for the konnector developper, no particular dependency handling, no mandatory compilation, just a package.json in the git repository, the cache can be shared by instances drawbacks : node only solution, maybe more work on the cozy-stack side","title":"Study on konnectors installation on VFS"},{"location":"/cozy-stack/konnectors_design/#todo","text":"[x] How to install and update the konnectors? [x] Are the konnectors installed once per server or per instance (in the VFS like client-side apps)? [x] One git repository with all the konnectors (like now), or one repos per konnector? Same question for package.json [ ] What API to list the konnectors for My Accounts? [ ] What workflow for developing a konnector? [ ] How to test konnectors? [x] How are managed the locales? : declared in manfiest.konnector [x] Which version of nodejs? Last LTS version bundled in a rocket container [ ] Do you keep coffeescript? Or move every konnector to ES2017? 28 konnectors in coffee 22 konnectors in JS [ ] What about weboob? [ ] What roadmap for transforming the konnectors-v2 in konnectors-v3? [x] What format for the konnectors manifest? [x] What permissions for a konnector? [ ] For konnectors that import files, how can we let the user select a folder and have an associated permission for the konnector in this folder (and not anywhere else on the virtual file system)? [ ] Can we associate the data retrieved by a konnector to a profile ? The goal is to allow a client-side to have a permission on this profile and be able to read all the data fetched by a given konnector (or is tied to an account)? [ ] How are logged the data exported/synchronized by a push konnector? [x] Analyze the konnectors node_modules no compiled modules currently 28 dependencies that install 65 MB for 271 modules in production 71 dependencies that install 611 MB for 858 modules with dev dependencies [ ] How are persisted the accounts? [x] How is executed a konnector? In particular, how the credentials are given to the konnector? [ ] what should expose a konnector (data, functions, etc)? https://github.com/cozy-labs/konnectors/issues/695 [ ] How can we support konnectors with OAuth?","title":"TODO"},{"location":"/cozy-stack/konnectors_oauth/","text":"Doctypes io.cozy.konnectors gives their desiderata for an account { fields : { account : { doctype : io.cozy.accounts , account_type : maif , scope : openid profile offline_access } } } io.cozy.accounts contains authentication information for an account, as well as the associated scope { name : Mon Compte Maif , account_type : maif , status : connected , oauth : { access_token : akosaksoakso , refresh_token : okoakozkaozk , scope : openid profile offline_access } } io.cozy.account_types contains the oauth configuration { _id : service.example , grant_mode : authorization_code , client_id : the registered client id , client_secret : client_secret is necessary for server-flow , auth_endpoint : https://service.example/auth , token_endpoint : https://api.service.example/token } io.cozy.account_types should not be accessible to the applications. They will be loaded into the stack by infra and will be configurable through config files for self-hosters. Reminder OAuth flow Service is the website from which konnector aims to retrieve informations. Stack is the cozy stack Oauth is divided in 3 steps Client Registration: the client application (the Stack) needs to be registered with the Service. Obtaining Refreshing Authorization: all the steps from client_id to access_token, the Stack will handle those Using the access_token: Ideally, the konnector should only concern itself with this part; it receives an access_token and uses it. Client Registration Before beginning the Grant process, most Services require the application to be registered with a defined redirect_uri. TL:DR Lot of options, which we will choose from when actually implementing konnectors using them. Manually Most services requires a human developer to create the client manually and define its redirect_uri. However each instance has its own domain, so for these services, we will need to: A. Register a proxy client , which is a static page performing redirections as needed, as was done for Facebook events in v2 konnectors. We will register a well known cozy domain, like oauth-proxy.cozy.io and registers it with all providers. The use and risks associated with this domain should be made clear to the user. B. Register each Stack with a redirect_uri on the main stack domain, if we go this way, the register_uri below moves from bob.cozy.rocks/accounts/redirect to _cozy_oauth.cozy.rocks/redirect and the domain will be prepended to the state. This is feasible at cozy scale, but requires more knowledge and work for self-hosters. Dynamic Registration Protocol A few services allows client to register programaticaly through the Dynamic Client Registration Protocol RFC7591 , we should allow the Stack to register using this protocol when we first need to implement a Konnector connecting to such a Service. No redirect_url enforcement A few services allows to specify arbitrary redirect_url without registering beforehand as a client. Authorization Grant flows webserver flow (Authorization Code Grant) A. In SettingsApp give a link a href= https://bob.cozy.rocks/accounts/service-name/start? (url) scope=photos state=1234zyx NOTE the scope may depends on other fields being configured (checkboxes), this will be described in json in the konnectors manifest. The format will be determined upon implementation. NOTE To limit bandwidth and risk of state corruption, SettingsApp should save its state under a random key into localStorage, the key is then passed as the state in this query. B. Service let the user login, allow or deny scope Then redirect to https://bob.cozy.rocks/accounts/service-name/redirect? (url) code=AUTH_CODE_HERE state=1234zyx C. The Stack does Server side POST https://api.service.example/token Content-Type: grant_type=authorization_code code=AUTH_CODE_HERE redirect_uri=https://bob.cozy.rocks/accounts/service-name/redirect client_id=CLIENT_ID client_secret=CLIENT_SECRET D. The Service responds (server side) with (json) { access_token : ACCESS_TOKEN , token_type : bearer , expires_in : 2592000, refresh_token : REFRESH_TOKEN , scope : read , uid : 100101, info : { name : Claude Douillet , email : claude.douillet@example.com } } This whole object is saved as-is into a io.cozy.accounts s extras field. The known fields access_token , refresh_token scope will be also saved on the account s oauth itself E. The Stack redirect the user to SettingsApp HTTP/1.1 302 Found Location: https://bob-settings.cozy.rocks/?state=1234zyx account=accountID SettingsApp check the state is expected and restore its state to the form but whith account completed. SPA flow (Implicit grant) A. In SettingsApp give a link a href= https://service.example/auth? (url) response_type=token client_id=CLIENT_ID redirect_uri=https://bob-settings.cozy.rocks/ scope=photos state=1234zyx See server-flow for state rules. B. Service let the user login, allow or deny scope Then redirects to https://bob-settings.cozy.rocks/? access_token=ACCESS_TOKEN state=1234zyx C. SettingsApp adds the token to the io.cozy.accounts and save it before starting konnector. Accessing data Once we have an account, SettingsApp starts the konnector with the proper account id. The konnector can then fetch the account and use its access_token to performs a request to fetch data POST https://api.service.com/resource Authorization: Bearer ACCESS_TOKEN Refreshing token When using the server-flow, we also get a refresh_token. It is used to get a new access_token when it expires. However, if konnectors are responsible for refreshing token there is a race condition risk : (konnector A) GET https://api.service.com/resource TOKEN1 - expired (konnector B) GET https://api.service.com/resource TOKEN1 - expired (konnector A) POST https://api.service.com/token REFRESH_TOKEN - TOKEN2a (konnector B) POST https://api.service.com/token REFRESH_TOKEN - TOKEN2b (konnector A) GET https://api.service.com/token TOKEN2a - invalid To avoid this, the stack will be responsible to perform token refresh. A konnector can requires the stack to refresh an account token with an HTTP request. POST https://bob-settings.cozy.rocks/accounts/:accountID/refresh Konnectors Marketplace Requirements The following is a few points to be careful for in konnectors when we start allowing non-cozy developped OAuth konnectors. With SPA flow, because of advanced security concerns (confused deputy problem), cozy should validate the access_token . However, the way to do that depends on the provider and cannot be described in json, it is therefore the responsibility of the konnector itself. Account types security rules With server flow, an evil account type with proper auth_endpoint but bad token_endpoint could retrieve a valid token as well as cozy client secret. The reviewer of an account_type should make sure both these endpoints are on domains belonging to the Service provider. Notes for MesInfos experiment MAIF konnector uses the webserver flow without redirect_uri validation Orange konnector uses the client-side proxy but hosted on their own servers (/!\\ redirect_uri vs redirect_url)","title":"konnectors_oauth"},{"location":"/cozy-stack/konnectors_oauth/#doctypes","text":"io.cozy.konnectors gives their desiderata for an account { fields : { account : { doctype : io.cozy.accounts , account_type : maif , scope : openid profile offline_access } } } io.cozy.accounts contains authentication information for an account, as well as the associated scope { name : Mon Compte Maif , account_type : maif , status : connected , oauth : { access_token : akosaksoakso , refresh_token : okoakozkaozk , scope : openid profile offline_access } } io.cozy.account_types contains the oauth configuration { _id : service.example , grant_mode : authorization_code , client_id : the registered client id , client_secret : client_secret is necessary for server-flow , auth_endpoint : https://service.example/auth , token_endpoint : https://api.service.example/token } io.cozy.account_types should not be accessible to the applications. They will be loaded into the stack by infra and will be configurable through config files for self-hosters.","title":"Doctypes"},{"location":"/cozy-stack/konnectors_oauth/#reminder-oauth-flow","text":"Service is the website from which konnector aims to retrieve informations. Stack is the cozy stack Oauth is divided in 3 steps Client Registration: the client application (the Stack) needs to be registered with the Service. Obtaining Refreshing Authorization: all the steps from client_id to access_token, the Stack will handle those Using the access_token: Ideally, the konnector should only concern itself with this part; it receives an access_token and uses it.","title":"Reminder OAuth flow"},{"location":"/cozy-stack/konnectors_oauth/#client-registration","text":"Before beginning the Grant process, most Services require the application to be registered with a defined redirect_uri. TL:DR Lot of options, which we will choose from when actually implementing konnectors using them.","title":"Client Registration"},{"location":"/cozy-stack/konnectors_oauth/#manually","text":"Most services requires a human developer to create the client manually and define its redirect_uri. However each instance has its own domain, so for these services, we will need to: A. Register a proxy client , which is a static page performing redirections as needed, as was done for Facebook events in v2 konnectors. We will register a well known cozy domain, like oauth-proxy.cozy.io and registers it with all providers. The use and risks associated with this domain should be made clear to the user. B. Register each Stack with a redirect_uri on the main stack domain, if we go this way, the register_uri below moves from bob.cozy.rocks/accounts/redirect to _cozy_oauth.cozy.rocks/redirect and the domain will be prepended to the state. This is feasible at cozy scale, but requires more knowledge and work for self-hosters.","title":"Manually"},{"location":"/cozy-stack/konnectors_oauth/#dynamic-registration-protocol","text":"A few services allows client to register programaticaly through the Dynamic Client Registration Protocol RFC7591 , we should allow the Stack to register using this protocol when we first need to implement a Konnector connecting to such a Service.","title":"Dynamic Registration Protocol"},{"location":"/cozy-stack/konnectors_oauth/#no-redirect_url-enforcement","text":"A few services allows to specify arbitrary redirect_url without registering beforehand as a client.","title":"No redirect_url enforcement"},{"location":"/cozy-stack/konnectors_oauth/#authorization-grant-flows","text":"","title":"Authorization Grant flows"},{"location":"/cozy-stack/konnectors_oauth/#webserver-flow-authorization-code-grant","text":"A. In SettingsApp give a link a href= https://bob.cozy.rocks/accounts/service-name/start? (url) scope=photos state=1234zyx NOTE the scope may depends on other fields being configured (checkboxes), this will be described in json in the konnectors manifest. The format will be determined upon implementation. NOTE To limit bandwidth and risk of state corruption, SettingsApp should save its state under a random key into localStorage, the key is then passed as the state in this query. B. Service let the user login, allow or deny scope Then redirect to https://bob.cozy.rocks/accounts/service-name/redirect? (url) code=AUTH_CODE_HERE state=1234zyx C. The Stack does Server side POST https://api.service.example/token Content-Type: grant_type=authorization_code code=AUTH_CODE_HERE redirect_uri=https://bob.cozy.rocks/accounts/service-name/redirect client_id=CLIENT_ID client_secret=CLIENT_SECRET D. The Service responds (server side) with (json) { access_token : ACCESS_TOKEN , token_type : bearer , expires_in : 2592000, refresh_token : REFRESH_TOKEN , scope : read , uid : 100101, info : { name : Claude Douillet , email : claude.douillet@example.com } } This whole object is saved as-is into a io.cozy.accounts s extras field. The known fields access_token , refresh_token scope will be also saved on the account s oauth itself E. The Stack redirect the user to SettingsApp HTTP/1.1 302 Found Location: https://bob-settings.cozy.rocks/?state=1234zyx account=accountID SettingsApp check the state is expected and restore its state to the form but whith account completed.","title":"webserver flow (Authorization Code Grant)"},{"location":"/cozy-stack/konnectors_oauth/#spa-flow-implicit-grant","text":"A. In SettingsApp give a link a href= https://service.example/auth? (url) response_type=token client_id=CLIENT_ID redirect_uri=https://bob-settings.cozy.rocks/ scope=photos state=1234zyx See server-flow for state rules. B. Service let the user login, allow or deny scope Then redirects to https://bob-settings.cozy.rocks/? access_token=ACCESS_TOKEN state=1234zyx C. SettingsApp adds the token to the io.cozy.accounts and save it before starting konnector.","title":"SPA flow (Implicit grant)"},{"location":"/cozy-stack/konnectors_oauth/#accessing-data","text":"Once we have an account, SettingsApp starts the konnector with the proper account id. The konnector can then fetch the account and use its access_token to performs a request to fetch data POST https://api.service.com/resource Authorization: Bearer ACCESS_TOKEN","title":"Accessing data"},{"location":"/cozy-stack/konnectors_oauth/#refreshing-token","text":"When using the server-flow, we also get a refresh_token. It is used to get a new access_token when it expires. However, if konnectors are responsible for refreshing token there is a race condition risk : (konnector A) GET https://api.service.com/resource TOKEN1 - expired (konnector B) GET https://api.service.com/resource TOKEN1 - expired (konnector A) POST https://api.service.com/token REFRESH_TOKEN - TOKEN2a (konnector B) POST https://api.service.com/token REFRESH_TOKEN - TOKEN2b (konnector A) GET https://api.service.com/token TOKEN2a - invalid To avoid this, the stack will be responsible to perform token refresh. A konnector can requires the stack to refresh an account token with an HTTP request. POST https://bob-settings.cozy.rocks/accounts/:accountID/refresh","title":"Refreshing token"},{"location":"/cozy-stack/konnectors_oauth/#konnectors-marketplace-requirements","text":"The following is a few points to be careful for in konnectors when we start allowing non-cozy developped OAuth konnectors. With SPA flow, because of advanced security concerns (confused deputy problem), cozy should validate the access_token . However, the way to do that depends on the provider and cannot be described in json, it is therefore the responsibility of the konnector itself.","title":"Konnectors Marketplace Requirements"},{"location":"/cozy-stack/konnectors_oauth/#account-types-security-rules","text":"With server flow, an evil account type with proper auth_endpoint but bad token_endpoint could retrieve a valid token as well as cozy client secret. The reviewer of an account_type should make sure both these endpoints are on domains belonging to the Service provider.","title":"Account types security rules"},{"location":"/cozy-stack/konnectors_oauth/#notes-for-mesinfos-experiment","text":"MAIF konnector uses the webserver flow without redirect_uri validation Orange konnector uses the client-side proxy but hosted on their own servers (/!\\ redirect_uri vs redirect_url)","title":"Notes for MesInfos experiment"},{"location":"/cozy-stack/konnectors_workflow_example/","text":"Konnectors workflow Types Accounts io.cozy.accounts contains authentification information for an account { name : Gmail Perso , account_type : google , status : connected , auth : { user : my-personal-account@gmail.com , password : my-secret } } accounts are manipulated through the /data/ API. Accounts fields name User defined name for the account ( Perso , Pro ) account_type A type of account, like google or trainlines , a list will be published by Cozy Cloud for current konnectors and most commons one. It s recommended to use the associated website domain otherwise. status one of NoAttempt Connected or Errored error the (optional) error for last connection to this account auth An object defining auth method for this account. For now only {login, password} is supported. OAuth accounts will be explored later. The auth fields will be encrypted on disk. Account permissions should appear different in permission modal. Konnectors io.cozy.konnectors are installed similarly to io.cozy.apps (see doc ) Permissions Like client-side applications, each konnector has an associated io.cozy.permissions with type=app doc. Triggers io.cozy.triggers are used to define when konnectors are launched See https://docs.cozy.io/en/cozy-stack/jobs/#post-jobstriggers Routes konnectors [ ] GET /konnectors/marketplace Lists available konnectors [x] POST /konnectors/:slug?Source=xxxx Installs a konnector [ ] GET /konnectors Lists installed konnectors triggers [x] GET /jobs/triggers?Worker=konnector Lists konnectors with a configured recurrence. [x] POST /jobs/triggers Enables a konnector recurrence. [x] DELETE /jobs/triggers/:triggerid Disables a konnector recurrence jobs [x] POST /jobs/queue/konnector Starts a konnector now [x] GET /jobs/queue/konnector Lists pending konnectors Complete flow example As a user, from the expenses management app, I have a clean flow to configure a connector to retrieve my travel expenses 1 - User is in my-expenses and clicks on [configure travels] 2 - my-expenses triggers an intent cozy.intents.start( CREATE , io.cozy.konnectors , { category: transport }); 3 - SettingsApp catch the intent, fetch all available konnectors and let the user choose GET /konnectors/marketplace 4 - SettingsApp fetch selected konnector (trainlines) manifest GET /konnectors/manifests?Source=git://github.com/konnectors/trainlines.git { name : Trainline , type : konnector , slug : konnector-trainline , description : Konnector for trainline . com , source : https://github.com/konnectors/trainlines.git@build , developer : { name : XXX , url : https://www.xxx.fr }, version : 3.0.0 , licence : AGPL-3.0 , fields : { save_folder : { doctype : io.cozy.files , type : folder , verbs : [ ALL ] }, account : { doctype : io.cozy.accounts , account_type : trainlines , accountFormat : login,password } }, category : transport , frequency : weekly , permissions : { events : { description : Connect train bill with event in your calendar , type : io.cozy.events , verbs : [ PATCH ] } } } 5 - SettingsApp asks the user for account config and create the io.cozy.accounts POST /data/io.cozy.accounts { account_type : google , status : PENDING , auth : { login : xxxx , password : yyyyy } } HTTP/1.1 200 OK { _id : 123-account-id-123 , _rev : 1-asasasasa , account_type : google , status : PENDING , auth : { login : xxxx , password : yyyyy } } 6 - SettingsApp asks the user for the additional save_folder config fields. It could for example use a PICK intents for files. 7 - SettingsApp does install the konnector POST /konnectors/konnector-trainlines?Source=git://github.com/konnectors/trainlines.git HTTP/1.1 200 OK { data : { id : io.cozy.konnectors/trainlines , type : io.cozy.konnectors , attributes : { name : trainline , state : installing , slug : trainline , ... }, links : { self : /konnectors/trainline , permissions : /permissions/456-permission-doc-id-456 } } } 8 - SettingsApp changes the konnector permissions doc to include save folder PATCH /permissions/456-permission-doc-id-456 { data : { id : 456-permission-doc-id-456 , type : io.cozy.permissions , attributes : { type : app , source_id : io.cozy.konnectors/trainlines , permissions : { save_folder : { type : io.cozy.files , verbs : [ ALL ], values : [ 123-selected-folder-id-123 ] } } } } } HTTP/1.1 200 OK { data : { id : 456-permission-doc-id-456 , type : io.cozy.permissions , attributes : { type : app , source_id : io.cozy.konnectors/trainlines , permissions : { events : { description : Connect train bill with event in your calendar , type : io.cozy.events , verbs : [ PATCH ] }, save_folder : { type : io.cozy.files , verbs : [ ALL ], values : [ 123-selected-folder-id-123 ] } } } } } 9 - SettingsApp add a Reference from konnector to folder to prevent folder destruction POST /files/123-selected-folder-id-123/relationships/referenced_by { data : [ { type : io.cozy.konnectors , id : io.cozy.konnectors/trainlines } ] } 10 - SettingsApp runs the konnector the first time POST /jobs/queue/konnector { data : { attributes : { arguments : { konnector : trainline , account : 123-account-id-123 , folder_to_save : 123-selected-folder-id-123 } } } } HTTP/1.1 200 OK { data : { id : 789-job-id-789 , type : io.cozy.jobs , attributes : { worker : konnector , options : { priority : 3, timeout : 60, max_exec_count : 3 }, arguments : { konnector : trainline , account : 123-account-id-123 , folder_to_save : 123-selected-folder-id-123 }, state : running , try_count : 1, queued_at : 2016-09-19T12:35:08Z , started_at : 2016-09-19T12:35:08Z , errors : [], output : {} } } } 11 - SettingsApp follow konnector status to check if all is properly configured. It uses the realtime to subscribes to changes on 789-job-id-789 and is therefore informed of it s status / errors / ect TODO Look at current konnectors sources to defines a protocol between konnectors and SettingsApp to display the nice progress modal. [ ] 250 events imported [ ] 150 / 3500 contacts importing [ ] TODO there should be some persistence for jobs error / status 12 - SettingsApp creates a trigger to setup the konnector recurence POST /jobs/io.cozy.triggers { data : { attributes : { type : @cron , arguments : 0 0 0 0 1 1 , worker : konnector , worker_arguments : { konnector : trainline , account : 5165621628784562148955 , folder_to_save : 877854878455 } } } } If the user wants to use several account, Settings can setup several triggers for the same konnector various accounts. Relations and DELETE CASCADE When a konnector is deleted, its triggers should be deleted When an account is deleted, its triggers should be deleted TODO Should stack validate konnector value on trigger creation / to be extended to all workers pre-validating worker arguments ? Konnector Worker specs Start the konnector through Rkt, passing as ENV variables : - `COZY_URL`: the starting instance URL - `COZY_CREDENTIALS`: security token to communicate with Cozy - `COZY_FIELDS`: JSON-encoded worker_arguments - `COZY_PARAMETERS`: JSON-encoded parameters associated with the konnector - `COZY_LANGUAGE`: the language field of the konnector (eg. node etc.) - `COZY_LOCALE`: the locale of the user (eg. en etc.) - `COZY_TIME_LIMIT`: how much time the konnector has to run - `COZY_JOB_ID`: id of the job - `COZY_JOB_MANUAL_EXECUTION`: whether the job was started manually (in Collect) or automatically (via a cron trigger or event) The konnector process can send events trough it s stdout (newline separated JSON object), the konnector worker pass these events to the realtime hub as io.cozy.jobs.events . Only JSON formatted events are forwarded to the client-side throught realtime Otherwise formatted lines (such as node Error) will be kept in some system logs. Konnectors should NOT log the received account login values in production. Konnector error handling Rocket does not allow to pass error output from the app to it s own error output. We have to find another way to pass error messages. Here is a proposition : The konnector will output json formated messages as stated before (the events) and those events will be typed and formatted like this : { type: messagetype , // can be error , debug , warning , and maybe progress message: message // can be any string } For the case of error type, the message will be a string coming from a npm package shared between the data-connect application and the connectors to allow the data-connect application to display localized error messages.","title":"konnectors_workflow_example"},{"location":"/cozy-stack/konnectors_workflow_example/#konnectors-workflow","text":"","title":"Konnectors workflow"},{"location":"/cozy-stack/konnectors_workflow_example/#types","text":"","title":"Types"},{"location":"/cozy-stack/konnectors_workflow_example/#accounts","text":"io.cozy.accounts contains authentification information for an account { name : Gmail Perso , account_type : google , status : connected , auth : { user : my-personal-account@gmail.com , password : my-secret } } accounts are manipulated through the /data/ API.","title":"Accounts"},{"location":"/cozy-stack/konnectors_workflow_example/#accounts-fields","text":"name User defined name for the account ( Perso , Pro ) account_type A type of account, like google or trainlines , a list will be published by Cozy Cloud for current konnectors and most commons one. It s recommended to use the associated website domain otherwise. status one of NoAttempt Connected or Errored error the (optional) error for last connection to this account auth An object defining auth method for this account. For now only {login, password} is supported. OAuth accounts will be explored later. The auth fields will be encrypted on disk. Account permissions should appear different in permission modal.","title":"Accounts fields"},{"location":"/cozy-stack/konnectors_workflow_example/#konnectors","text":"io.cozy.konnectors are installed similarly to io.cozy.apps (see doc )","title":"Konnectors"},{"location":"/cozy-stack/konnectors_workflow_example/#permissions","text":"Like client-side applications, each konnector has an associated io.cozy.permissions with type=app doc.","title":"Permissions"},{"location":"/cozy-stack/konnectors_workflow_example/#triggers","text":"io.cozy.triggers are used to define when konnectors are launched See https://docs.cozy.io/en/cozy-stack/jobs/#post-jobstriggers","title":"Triggers"},{"location":"/cozy-stack/konnectors_workflow_example/#routes","text":"konnectors [ ] GET /konnectors/marketplace Lists available konnectors [x] POST /konnectors/:slug?Source=xxxx Installs a konnector [ ] GET /konnectors Lists installed konnectors triggers [x] GET /jobs/triggers?Worker=konnector Lists konnectors with a configured recurrence. [x] POST /jobs/triggers Enables a konnector recurrence. [x] DELETE /jobs/triggers/:triggerid Disables a konnector recurrence jobs [x] POST /jobs/queue/konnector Starts a konnector now [x] GET /jobs/queue/konnector Lists pending konnectors","title":"Routes"},{"location":"/cozy-stack/konnectors_workflow_example/#complete-flow-example","text":"As a user, from the expenses management app, I have a clean flow to configure a connector to retrieve my travel expenses 1 - User is in my-expenses and clicks on [configure travels] 2 - my-expenses triggers an intent cozy.intents.start( CREATE , io.cozy.konnectors , { category: transport }); 3 - SettingsApp catch the intent, fetch all available konnectors and let the user choose GET /konnectors/marketplace 4 - SettingsApp fetch selected konnector (trainlines) manifest GET /konnectors/manifests?Source=git://github.com/konnectors/trainlines.git { name : Trainline , type : konnector , slug : konnector-trainline , description : Konnector for trainline . com , source : https://github.com/konnectors/trainlines.git@build , developer : { name : XXX , url : https://www.xxx.fr }, version : 3.0.0 , licence : AGPL-3.0 , fields : { save_folder : { doctype : io.cozy.files , type : folder , verbs : [ ALL ] }, account : { doctype : io.cozy.accounts , account_type : trainlines , accountFormat : login,password } }, category : transport , frequency : weekly , permissions : { events : { description : Connect train bill with event in your calendar , type : io.cozy.events , verbs : [ PATCH ] } } } 5 - SettingsApp asks the user for account config and create the io.cozy.accounts POST /data/io.cozy.accounts { account_type : google , status : PENDING , auth : { login : xxxx , password : yyyyy } } HTTP/1.1 200 OK { _id : 123-account-id-123 , _rev : 1-asasasasa , account_type : google , status : PENDING , auth : { login : xxxx , password : yyyyy } } 6 - SettingsApp asks the user for the additional save_folder config fields. It could for example use a PICK intents for files. 7 - SettingsApp does install the konnector POST /konnectors/konnector-trainlines?Source=git://github.com/konnectors/trainlines.git HTTP/1.1 200 OK { data : { id : io.cozy.konnectors/trainlines , type : io.cozy.konnectors , attributes : { name : trainline , state : installing , slug : trainline , ... }, links : { self : /konnectors/trainline , permissions : /permissions/456-permission-doc-id-456 } } } 8 - SettingsApp changes the konnector permissions doc to include save folder PATCH /permissions/456-permission-doc-id-456 { data : { id : 456-permission-doc-id-456 , type : io.cozy.permissions , attributes : { type : app , source_id : io.cozy.konnectors/trainlines , permissions : { save_folder : { type : io.cozy.files , verbs : [ ALL ], values : [ 123-selected-folder-id-123 ] } } } } } HTTP/1.1 200 OK { data : { id : 456-permission-doc-id-456 , type : io.cozy.permissions , attributes : { type : app , source_id : io.cozy.konnectors/trainlines , permissions : { events : { description : Connect train bill with event in your calendar , type : io.cozy.events , verbs : [ PATCH ] }, save_folder : { type : io.cozy.files , verbs : [ ALL ], values : [ 123-selected-folder-id-123 ] } } } } } 9 - SettingsApp add a Reference from konnector to folder to prevent folder destruction POST /files/123-selected-folder-id-123/relationships/referenced_by { data : [ { type : io.cozy.konnectors , id : io.cozy.konnectors/trainlines } ] } 10 - SettingsApp runs the konnector the first time POST /jobs/queue/konnector { data : { attributes : { arguments : { konnector : trainline , account : 123-account-id-123 , folder_to_save : 123-selected-folder-id-123 } } } } HTTP/1.1 200 OK { data : { id : 789-job-id-789 , type : io.cozy.jobs , attributes : { worker : konnector , options : { priority : 3, timeout : 60, max_exec_count : 3 }, arguments : { konnector : trainline , account : 123-account-id-123 , folder_to_save : 123-selected-folder-id-123 }, state : running , try_count : 1, queued_at : 2016-09-19T12:35:08Z , started_at : 2016-09-19T12:35:08Z , errors : [], output : {} } } } 11 - SettingsApp follow konnector status to check if all is properly configured. It uses the realtime to subscribes to changes on 789-job-id-789 and is therefore informed of it s status / errors / ect TODO Look at current konnectors sources to defines a protocol between konnectors and SettingsApp to display the nice progress modal. [ ] 250 events imported [ ] 150 / 3500 contacts importing [ ] TODO there should be some persistence for jobs error / status 12 - SettingsApp creates a trigger to setup the konnector recurence POST /jobs/io.cozy.triggers { data : { attributes : { type : @cron , arguments : 0 0 0 0 1 1 , worker : konnector , worker_arguments : { konnector : trainline , account : 5165621628784562148955 , folder_to_save : 877854878455 } } } } If the user wants to use several account, Settings can setup several triggers for the same konnector various accounts.","title":"Complete flow example"},{"location":"/cozy-stack/konnectors_workflow_example/#relations-and-delete-cascade","text":"When a konnector is deleted, its triggers should be deleted When an account is deleted, its triggers should be deleted TODO Should stack validate konnector value on trigger creation / to be extended to all workers pre-validating worker arguments ?","title":"Relations and DELETE CASCADE"},{"location":"/cozy-stack/konnectors_workflow_example/#konnector-worker-specs","text":"Start the konnector through Rkt, passing as ENV variables : - `COZY_URL`: the starting instance URL - `COZY_CREDENTIALS`: security token to communicate with Cozy - `COZY_FIELDS`: JSON-encoded worker_arguments - `COZY_PARAMETERS`: JSON-encoded parameters associated with the konnector - `COZY_LANGUAGE`: the language field of the konnector (eg. node etc.) - `COZY_LOCALE`: the locale of the user (eg. en etc.) - `COZY_TIME_LIMIT`: how much time the konnector has to run - `COZY_JOB_ID`: id of the job - `COZY_JOB_MANUAL_EXECUTION`: whether the job was started manually (in Collect) or automatically (via a cron trigger or event) The konnector process can send events trough it s stdout (newline separated JSON object), the konnector worker pass these events to the realtime hub as io.cozy.jobs.events . Only JSON formatted events are forwarded to the client-side throught realtime Otherwise formatted lines (such as node Error) will be kept in some system logs. Konnectors should NOT log the received account login values in production.","title":"Konnector Worker specs"},{"location":"/cozy-stack/konnectors_workflow_example/#konnector-error-handling","text":"Rocket does not allow to pass error output from the app to it s own error output. We have to find another way to pass error messages. Here is a proposition : The konnector will output json formated messages as stated before (the events) and those events will be typed and formatted like this : { type: messagetype , // can be error , debug , warning , and maybe progress message: message // can be any string } For the case of error type, the message will be a string coming from a npm package shared between the data-connect application and the connectors to allow the data-connect application to display localized error messages.","title":"Konnector error handling"},{"location":"/cozy-stack/moving/","text":"Table of contents Moving This document is a stub to hold information about moving one s cozy from an hosting provider to another. We do moving by exporting data to a tarball, and then importing the tarball. The files inside the tarball should be organized in a documented way, and with standard formats, to open interoperability with cloud solutions. You also have DNS and TLS certificates to change Once we start doing some intercozy communication, we might have issues with the transition period. I export my bob.cozycloud.cc from host1 as a tarball My friend A s cozy send me an update notification the message gets to host1 I trigger DNS change My friend B s cozy send me something, its DNS is not up-to-date, the message gets to host1 DNS change is complete, all further messages will reach host2 The sharing protocol have to take into account the fact that a cozy can have accepted a message, but then forget about it (better, as it also covers the crash case).","title":"moving"},{"location":"/cozy-stack/moving/#moving","text":"This document is a stub to hold information about moving one s cozy from an hosting provider to another. We do moving by exporting data to a tarball, and then importing the tarball. The files inside the tarball should be organized in a documented way, and with standard formats, to open interoperability with cloud solutions. You also have DNS and TLS certificates to change Once we start doing some intercozy communication, we might have issues with the transition period. I export my bob.cozycloud.cc from host1 as a tarball My friend A s cozy send me an update notification the message gets to host1 I trigger DNS change My friend B s cozy send me something, its DNS is not up-to-date, the message gets to host1 DNS change is complete, all further messages will reach host2 The sharing protocol have to take into account the fact that a cozy can have accepted a message, but then forget about it (better, as it also covers the crash case).","title":"Moving"},{"location":"/cozy-stack/registry-publish/","text":"Apps registry publication Automate publication The following tutorial explains how to connect your continuous integration based on Travis to automatically publish new versions on the apps registry. In this tutorial, we assume: you have a token allowing you to publish applications for your editor : AbCdEf you are working on a repository plugged on travis and named on github cozy/cozy-example You first need to add the token to your travis configuration file .travis.yml . To do so, you need the travis utility to encrypt its value. $ travis encrypt REGISTRY_TOKEN=AbCdEf --add -r cozy/cozy-example Please add the following to your .travis.yml file: secure: jUAjkXNXfGIXyx2MKnnJ5HwCzhrQ29SaWBTmRpU6Rwi2XRieCnb2+MKZtjVcmEjfvJO38VjPozW2F4MYIxRXf9cD+ZRAEroZRcRSNHpoi/FJ6Ra767H7AbFDGpSSUSx7UDeZbSRNazCXJ55F/JaCq6F3XGeurrJbJ/tvMoIEvjg4qcOJpBgSxXEeyEnx5L3zbDoIqDo8hx9UtZoisiTC3TGq1CGFPe35VXnv/g23Uwg2Wux1drXXnMVghoVM8SDuoE9gf4LfppVHbYmowm25tylsvNKESbYiwJIkvPciPl2rABplJLJ4nuVpeWKHx1g+bChzlR5rhgXVJidua//yFD28xWS1+j+FhCGcYuPttYTntBVTiif0DVKS3gC1FFbf2ktgJVT7nYN2z0arhdPeK7Wtv8R+0SqlXUfBA/nam1pAS1xg2MTekVKxw+FmW0r6Ct4/Dta4d4XWsYiPMBrUOaCAqo+TkxBrVvM/LcM91ua33GKzMRLmKgbDY2k7lQpt3xA0Se02p4yiWcpN+3JzwVNRkuAQfw79ItJzhBP7ZTaQMwDByD/sN4ybhICWxTOLRh6kgfw+Xxv86aADvMVwfPcLljfk5Ot3kfLyaIyqrkIF9ePGSblt7RGzHiOECFr8qUtoGQAfekM+NmKzFSkeJU8t0EvHMen1NOsZhTemx9Q= Like said, you need to add this block of ciphered data in the .travis.yml . This will allow you to use the REGISTRY_TOKEN variable in your deployment script. Then you can adapt this script as your after_deploy or after_success script. It contains environment variables that you can adapt as your need: COZY_APP_VERSION : the version string of the deployed version COZY_APP_PARAMETERS : an optional JSON object (string, object or array) that will parameterize the application on its execution. COZY_BUILD_URL : the URL of the deployed tarball for your application COZY_BUILD_BRANCH : the name of the build branch from which the script creates dev releases #!/bin/bash set -e # Environnment variables: # COZY_APP_VERSION: the version string of the deployed version # COZY_BUILD_URL: the URL of the deployed tarball for your application # COZY_BUILD_BRANCH: the name of the build branch from which the script # creates dev releases [ -z ${COZY_BUILD_BRANCH} ] COZY_BUILD_BRANCH= master [ -z ${COZY_APP_PARAMETERS} ] COZY_APP_PARAMETERS= null if [ ${TRAVIS_PULL_REQUEST} != false ]; then echo No deployment: in pull-request exit 0 fi if [ ${TRAVIS_BRANCH} != ${COZY_BUILD_BRANCH} ] [ -z ${TRAVIS_TAG} ]; then printf 'No deployment: not in %s branch nor tag (TRAVIS_BRANCH=%s TRAVIS_TAG=%s)\\n' ${COZY_BUILD_BRANCH} ${TRAVIS_BRANCH} ${TRAVIS_TAG} exit 0 fi if ! jq ${COZY_APP_PARAMETERS} /dev/null; then printf Could not parse COZY_APP_PARAMETERS=%s as JSON\\n ${COZY_APP_PARAMETERS} exit 1 fi if [ -z ${COZY_APP_VERSION} ]; then if [ -n ${TRAVIS_TAG} ]; then COZY_APP_VERSION= ${TRAVIS_TAG} else manfile=$(find ${TRAVIS_BUILD_DIR} \\( -name manifest.webapp -o -name manifest.konnector \\) | head -n1) COZY_APP_VERSION= $(jq -r '.version' ${manfile} )-dev.${TRAVIS_COMMIT} fi fi if [ -z ${COZY_BUILD_URL} ]; then url= https://github.com/${TRAVIS_REPO_SLUG}/archive if [ -n ${TRAVIS_TAG} ]; then COZY_BUILD_URL= ${url}/${TRAVIS_TAG}.tar.gz else COZY_BUILD_URL= ${url}/${TRAVIS_COMMIT}.tar.gz fi fi shasum=$(curl -sSL --fail ${COZY_BUILD_URL} | shasum -a 256 | cut -d -f1) printf 'Publishing version %s from %s (%s)\\n' ${COZY_APP_VERSION} ${COZY_BUILD_URL}\\n ${shasum} curl -sS --fail -X POST \\ -H Content-Type: application/json \\ -H Authorization: Token ${REGISTRY_TOKEN} \\ -d {\\ version\\ : \\ ${COZY_APP_VERSION}\\ , \\ url\\ : \\ ${COZY_BUILD_URL}\\ , \\ sha256\\ : \\ ${shasum}\\ , \\ parameters\\ : ${COZY_APP_PARAMETERS}} \\ https://registry.cozy.io/registry/versions Access to our official apps registry In order to access to our official repository, you need a token for a specific editor. To do so, concact us directly at the address contact@cozycloud.cc with a mail using the following title prefix: [registry] and precising the name of the editor of your application. We will provide you with the correct token.","title":"registry-publish"},{"location":"/cozy-stack/registry-publish/#apps-registry-publication","text":"","title":"Apps registry publication"},{"location":"/cozy-stack/registry-publish/#automate-publication","text":"The following tutorial explains how to connect your continuous integration based on Travis to automatically publish new versions on the apps registry. In this tutorial, we assume: you have a token allowing you to publish applications for your editor : AbCdEf you are working on a repository plugged on travis and named on github cozy/cozy-example You first need to add the token to your travis configuration file .travis.yml . To do so, you need the travis utility to encrypt its value. $ travis encrypt REGISTRY_TOKEN=AbCdEf --add -r cozy/cozy-example Please add the following to your .travis.yml file: secure: jUAjkXNXfGIXyx2MKnnJ5HwCzhrQ29SaWBTmRpU6Rwi2XRieCnb2+MKZtjVcmEjfvJO38VjPozW2F4MYIxRXf9cD+ZRAEroZRcRSNHpoi/FJ6Ra767H7AbFDGpSSUSx7UDeZbSRNazCXJ55F/JaCq6F3XGeurrJbJ/tvMoIEvjg4qcOJpBgSxXEeyEnx5L3zbDoIqDo8hx9UtZoisiTC3TGq1CGFPe35VXnv/g23Uwg2Wux1drXXnMVghoVM8SDuoE9gf4LfppVHbYmowm25tylsvNKESbYiwJIkvPciPl2rABplJLJ4nuVpeWKHx1g+bChzlR5rhgXVJidua//yFD28xWS1+j+FhCGcYuPttYTntBVTiif0DVKS3gC1FFbf2ktgJVT7nYN2z0arhdPeK7Wtv8R+0SqlXUfBA/nam1pAS1xg2MTekVKxw+FmW0r6Ct4/Dta4d4XWsYiPMBrUOaCAqo+TkxBrVvM/LcM91ua33GKzMRLmKgbDY2k7lQpt3xA0Se02p4yiWcpN+3JzwVNRkuAQfw79ItJzhBP7ZTaQMwDByD/sN4ybhICWxTOLRh6kgfw+Xxv86aADvMVwfPcLljfk5Ot3kfLyaIyqrkIF9ePGSblt7RGzHiOECFr8qUtoGQAfekM+NmKzFSkeJU8t0EvHMen1NOsZhTemx9Q= Like said, you need to add this block of ciphered data in the .travis.yml . This will allow you to use the REGISTRY_TOKEN variable in your deployment script. Then you can adapt this script as your after_deploy or after_success script. It contains environment variables that you can adapt as your need: COZY_APP_VERSION : the version string of the deployed version COZY_APP_PARAMETERS : an optional JSON object (string, object or array) that will parameterize the application on its execution. COZY_BUILD_URL : the URL of the deployed tarball for your application COZY_BUILD_BRANCH : the name of the build branch from which the script creates dev releases #!/bin/bash set -e # Environnment variables: # COZY_APP_VERSION: the version string of the deployed version # COZY_BUILD_URL: the URL of the deployed tarball for your application # COZY_BUILD_BRANCH: the name of the build branch from which the script # creates dev releases [ -z ${COZY_BUILD_BRANCH} ] COZY_BUILD_BRANCH= master [ -z ${COZY_APP_PARAMETERS} ] COZY_APP_PARAMETERS= null if [ ${TRAVIS_PULL_REQUEST} != false ]; then echo No deployment: in pull-request exit 0 fi if [ ${TRAVIS_BRANCH} != ${COZY_BUILD_BRANCH} ] [ -z ${TRAVIS_TAG} ]; then printf 'No deployment: not in %s branch nor tag (TRAVIS_BRANCH=%s TRAVIS_TAG=%s)\\n' ${COZY_BUILD_BRANCH} ${TRAVIS_BRANCH} ${TRAVIS_TAG} exit 0 fi if ! jq ${COZY_APP_PARAMETERS} /dev/null; then printf Could not parse COZY_APP_PARAMETERS=%s as JSON\\n ${COZY_APP_PARAMETERS} exit 1 fi if [ -z ${COZY_APP_VERSION} ]; then if [ -n ${TRAVIS_TAG} ]; then COZY_APP_VERSION= ${TRAVIS_TAG} else manfile=$(find ${TRAVIS_BUILD_DIR} \\( -name manifest.webapp -o -name manifest.konnector \\) | head -n1) COZY_APP_VERSION= $(jq -r '.version' ${manfile} )-dev.${TRAVIS_COMMIT} fi fi if [ -z ${COZY_BUILD_URL} ]; then url= https://github.com/${TRAVIS_REPO_SLUG}/archive if [ -n ${TRAVIS_TAG} ]; then COZY_BUILD_URL= ${url}/${TRAVIS_TAG}.tar.gz else COZY_BUILD_URL= ${url}/${TRAVIS_COMMIT}.tar.gz fi fi shasum=$(curl -sSL --fail ${COZY_BUILD_URL} | shasum -a 256 | cut -d -f1) printf 'Publishing version %s from %s (%s)\\n' ${COZY_APP_VERSION} ${COZY_BUILD_URL}\\n ${shasum} curl -sS --fail -X POST \\ -H Content-Type: application/json \\ -H Authorization: Token ${REGISTRY_TOKEN} \\ -d {\\ version\\ : \\ ${COZY_APP_VERSION}\\ , \\ url\\ : \\ ${COZY_BUILD_URL}\\ , \\ sha256\\ : \\ ${shasum}\\ , \\ parameters\\ : ${COZY_APP_PARAMETERS}} \\ https://registry.cozy.io/registry/versions","title":"Automate publication"},{"location":"/cozy-stack/registry-publish/#access-to-our-official-apps-registry","text":"In order to access to our official repository, you need a token for a specific editor. To do so, concact us directly at the address contact@cozycloud.cc with a mail using the following title prefix: [registry] and precising the name of the editor of your application. We will provide you with the correct token.","title":"Access to our official apps registry"},{"location":"/cozy-stack/user-action-required/","text":"Table of contents User action is required This document explains how the stack can alert applications that an user action is required to perform the expected services. For example, the stack can block most of its API until the user read and sign new terms of services. HTTP 402 Error In some cases the stack will return a 402 error to API requests. 402 will be used to denote error that require an user s action. For now, the only use case is a Terms Of Services update, but some other use cases might appear in the future. The specific cause of this error will be provided within the body of the response (see examples below). HTTP/1.1 402 Payment Required Content-Length: ... Content-Type: application/vnd.api+json { errors : [ { status : 402 , title : TOS Updated , code : tos-updated , detail : Terms of services have been updated , links : { self : https://manager.cozycloud.cc/cozy/tos?domain=... } } ] } If they receive such a code, the clients should block any further action on the stack, warn the user with the necessary message and provide a button allowing the user to perform the required action. If the client knows the specific error code, display a beautiful message. Otherwise, display the message provided by the stack and use the links.action on the button. Possible other codes in the future: payment_required for functions requiring a premium account, etc. Anticipating these errors and warning the user An enpoints exists to get the list of warnings that the user can anticipate. For applications these warnings are included directly into the HTML of the index page, as follow: meta name= user-action-required data-title= {{ .Title }} data-code= {{ .Code }} data-detail= {{ .Detail }} data-links= {{ .Links.Self }} } / Request GET /settings/warnings HTTP/1.1 Response HTTP/1.1 402 Payment Required Content-Length: ... Content-Type: application/vnd.api+json { errors : [ { status : 402 , title : TOS Updated , code : tos-updated , detail : Terms of services have been updated , links : { self : https://manager.cozycloud.cc/cozy/tos?domain=... } } ] }","title":"user-action-required"},{"location":"/cozy-stack/user-action-required/#user-action-is-required","text":"This document explains how the stack can alert applications that an user action is required to perform the expected services. For example, the stack can block most of its API until the user read and sign new terms of services.","title":"User action is required"},{"location":"/cozy-stack/user-action-required/#http-402-error","text":"In some cases the stack will return a 402 error to API requests. 402 will be used to denote error that require an user s action. For now, the only use case is a Terms Of Services update, but some other use cases might appear in the future. The specific cause of this error will be provided within the body of the response (see examples below). HTTP/1.1 402 Payment Required Content-Length: ... Content-Type: application/vnd.api+json { errors : [ { status : 402 , title : TOS Updated , code : tos-updated , detail : Terms of services have been updated , links : { self : https://manager.cozycloud.cc/cozy/tos?domain=... } } ] } If they receive such a code, the clients should block any further action on the stack, warn the user with the necessary message and provide a button allowing the user to perform the required action. If the client knows the specific error code, display a beautiful message. Otherwise, display the message provided by the stack and use the links.action on the button. Possible other codes in the future: payment_required for functions requiring a premium account, etc.","title":"HTTP 402 Error"},{"location":"/cozy-stack/user-action-required/#anticipating-these-errors-and-warning-the-user","text":"An enpoints exists to get the list of warnings that the user can anticipate. For applications these warnings are included directly into the HTML of the index page, as follow: meta name= user-action-required data-title= {{ .Title }} data-code= {{ .Code }} data-detail= {{ .Detail }} data-links= {{ .Links.Self }} } /","title":"Anticipating these errors and warning the user"},{"location":"/cozy-stack/user-action-required/#request","text":"GET /settings/warnings HTTP/1.1","title":"Request"},{"location":"/cozy-stack/user-action-required/#response","text":"HTTP/1.1 402 Payment Required Content-Length: ... Content-Type: application/vnd.api+json { errors : [ { status : 402 , title : TOS Updated , code : tos-updated , detail : Terms of services have been updated , links : { self : https://manager.cozycloud.cc/cozy/tos?domain=... } } ] }","title":"Response"},{"location":"/dev/app/","text":"How to create your first Cozy application Prerequisite Developing an application for Cozy is quite easy. All you need to have is: NodeJS 8+ Yarn : a NodeJS package manager, like npm Docker to have a Cozy for dev Some basics about developing a single page application in HTML/JS or you just want to learn :) The only tool required to have a Cozy for development is Docker. We have been told that installing Docker on some familial flavours of Windows may be a bit difficult. If you use Windows, please check if Docker is available on your system. Install the development environment On GNU/Linux, according to the documentation : \u00ab The docker daemon binds to a Unix socket instead of a TCP port. By default that Unix socket is owned by the user root and other users can only access it using sudo. If you don\u2019t want to use sudo when you use the docker command, create a Unix group called docker and add users to it. Be warned that the docker group grants privileges equivalent to the root user. You should have a look at Docker\u2019s documentation on security . Every application running inside Cozy is a client-side HTML5 application interacting with your data through the API of the server. To develop an application, you\u2019ll require a running Cozy server. The easiest way is to use the Docker image for developers we provide. Just install it: docker pull cozy/cozy-app-dev (We update this image on a regular basis with the latest version of the server and our library. Don\u2019t forget to update the image by running docker pull cozy/cozy-app-dev from time to time). Create your application You can boostrap your application from scratch if you want, but we recommand to use our new community tool create-cozy-app to bootstrap very easily a Cozy application for you. This tool will generate an application using (P)React, the framework we internally use in the Cozy Front team. But options are available if you want to use other frameworks. For now the new cozy-client is used only in the (P)React template (it doesn t use the previous cozy-client-js anymore). This library is at an early stage but you can use it, it will be our next Cozy client for application development. First of all, run directly create-cozy-app without installing it globally by using the yarn create cozy-app command to bootstrap your application: yarn create cozy-app mycozyapp The script will download some dependencies (may take a while) and ask you a few questions, then create an application skeleton inside mycozyapp . That s all! You can start hacking: cd mycozyapp yarn watch:standalone After the webpack build, your app should be available at http://localhost:8888 You can change the host and the port of your application server here by using respectively the environment variables HOST and PORT Run it inside a Cozy using Docker You can run your application (here mycozyapp ) inside a Cozy thanks to the [cozy-stack docker image][cozy-stack-docker]: # in a terminal, run your app in watch mode $ cd mycozyapp $ yarn watch:browser Then, in another terminal: # in another terminal, run the docker container $ yarn stack:docker # or if you want the complete command (see more documentation below) $ docker run --rm -it -p 8080:8080 -v $(pwd)/build :/data/cozy-app/mycozyapp cozy/cozy-app-dev Your app is now available at http://mycozyapp.cozy.tools:8080. Extra documentation about application development How is the application working? The minimal application consist of only two files: an HTML file, index.html , with the markup and the code of your application a manifest describing the application. It\u2019s a JSON file named manifest.webapp with the name of the application, the permissions it requires\u2026 We\u2019ll have a deeper look to it content later. Your application requires some informations to interact with the server API, for example the URL of its entrypoint, and an auth token. This data will be dynamically injected into index.html when it serves the page. So the index.html file has to contain some string that will be replaced by the server. The general syntax of this variables is {{\u2026}} , so don\u2019t use this syntax for other purpose in the page, for example inside comments. You can use the following variables: {{.Domain}} will be substituted by the URL of the API entrypoint {{.Token}} will be replaced by a token that authenticate your application when accessing the API {{.Locale}} : the lang f the instance {{.AppName}} : the name of the application {{.IconPath}} will be replaced by HTML code to display the favicon {{.CozyClientJS}} will be replaced with HTML code to inject the Cozy client library {{.CozyBar}} will be replaced with HTML code to inject the upper menu bar. Use the API with cozy-client-js We are currently working on a new cozy-client library which will be more updated and used in the future than cozy-client-js . But the two libraries ( cozy-client and cozy-client-js ) don t rely on each other so you can still use the one you want to handle Cozy data for now. If you added {{.CozyClientJS}} to your page, interacting with the server will be as easy as using the Cozy Client JS library. All you have to do is to initiate the library with the server parameters (the URL of the API and the auth token of your application): window.cozy.client.init({cozyURL: \u2026 , token: \u2026 }); You can then interact with the server by using methods of the window.cozy.client properties. For example, to get current disk usage: cozy.client.settings.diskUsage() .then(function (usage) {console.log( Usage (promise) , usage);}); .catch(function(err){ console.log( fail , err); }); This library embeds most of the available server APIs: manipulate documents and files, manage applications and server settings\u2026 It also provides some some methods to help application keep working while being offline. Some server APIs may not be available right now through the library. If you want to use one of this method, you\u2019ll have to call it manually. See below. #TODO - add inner link. Behind the magic Some server APIs may not be available right now through the library. If you want to use one of this method, you\u2019ll have to call it manually. We\u2019ll describe here how to access the API without using the Cozy Client JS library. Connecting to the API requires three things: its URL, injected into the page through the {{.Domain}} variable the application auth token, injected into the page through the {{.Token}} variable. Each request sent to the server must include this token in the Authorization header the session cookie, created when you connect to your server. This is an HttpOnly cookie , meaning that JavaScript applications can\u2019t read it. This prevent a malicious script to stole the cookie. Here\u2019s a sample code that get API informations provided by the server and query the API: div data-cozy-token= {{.Token}} data-cozy-domain= {{.Domain}} / document.addEventListener('DOMContentLoaded', () = { use strict ; const app = document.querySelector('[data-cozy-token]'); fetch(`//${app.dataset.cozyDomain}/apps`, { method: 'GET', headers: { Authorization: `Bearer ${app.dataset.cozyToken}` // Here we use the auth token }, credentials: 'include' // don\u2019t forget to include the session cookie }) .then(function (response) { if (response.ok) { response.json().then((result) = { console.log(result); }); } else { throw new Error('Network response was not ok.'); } }) .catch(function (error) { console.log('There has been a problem with your fetch operation: ' + error.message); }); }); The manifest Each application must have a \u201cmanifest\u201d. It\u2019s a JSON file named manifest.webapp stored at the root of the application directory. It describes the application, the type of documents it uses, the permissions it require\u2026 Here\u2019s a sample manifest: { name : My Awesome application , permissions : { apps : { type : io.cozy.apps }, permissions : { type : io.cozy.permissions }, settings : { type : io.cozy.settings }, sample : { type : io.cozy.dev.sample , verbs : [ GET , POST , PUT , PATCH , DELETE ] }, jobs : { type : io.cozy.jobs } }, routes : { / : { folder : / , index : index.html , public : false }, /public : { folder : /public , index : index.html , public : true } } } Permissions Applications require permissions to use most of the APIs. Permissions can be described inside the manifest, so the server can ask the user to grant them during installation. Applications can also request permissions at run time. A permission must at type contain a target, the type of objects the application want to interact with. Can be a document type, or an action on the server. By default, all grant on this object are granted, but we can also request fine grained permissions, for example limiting to read access. We can also limit the scope to a subset of the documents. In the manifest, each permission is an object, with a random name and some properties: type : mandatory the document type or action name description : a text that will be displayed to the user to explain why the application require this permission verbs : an array of HTTP verbs. For example, to limit permissions to read access, use [\"GET\"] selector : a document attribute to limit access to a subset of documents values : array of allowed values for this attribute. An application can request a token that grant access to a subset of its own permissions. For example if the application has full access to the files, it can obtain a token that give only read access on a file. Thus, the application can make some documents publicly available. The public page of the application will use this token as authentication token when accessing the API. Samples Application require full access to files: { permissions : { files : { description : \u2026 , type : io.cozy.files }, } } Application want to be able to read the contact informations of cozy@cozycloud.cc { permissions : { contact : { type : io.cozy.contacts , verbs : [ GET ], selector : email , values : [ cozy@cozycloud.cc ] } } } Routing The application must declare all of its URLs (routes) inside the manifest. A route is an object associating an URL to an HTML file. Each route has the following properties: folder : the base folder of the route index : the name of the file inside this folder public : a boolean specifying whether the route is public or private (default). Sample: routes : { /admin : { folder : / , index : admin.html , public : false }, /public : { folder : /public , index : index.html , public : true }, /assets : { folder : /assets , public : true } } cozy-client-js This library embeds most of the available server APIs: manipulate documents and files, manage applications and server settings\u2026 It also provides some some methods to help application keep working while being offline. The library expose a client API under the window.cozy.client namespace. Before using it, you have to initiate the library with the server parameters (the URL of the API and the auth token of your application): window.cozy.client.init({cozyURL: \u2026 , token: \u2026 }); The library supports two programming paradigms: callback and Promises, so you can use your favorite one. If you prefer using callbacks rather than Promises, just add disablePromises to the options when initializing the library: window.cozy.client.init({cozyURL: \u2026 , token: \u2026 , disablePromises: true}); window.client.settings.diskUsage(function (err, res) { (\u2026) }); Raw API documentation In this tutorial, we\u2019ll only see a few samples of how to use the library. For a complete description of all available methods, please refer to its own documentation: documents files authentification authentication with OAuth2 settings inter-app communication jobs and triggers sharing offline Cozy Bar Manipulating documents Inside cozy data system, all documents are typed. To prevent applications to create document types with the same name but different description, the naming of the doctypes use the Java specification . Every document type name must be prefixed by the reverted domain name of its creator. If you don\u2019t own a domain name, you can also use your email address. For example, doctypes created by Cozy are prefixed by io.cozy or io.cozy.labs . If you don\u2019t own a domain name, and your email address is foo@bar.cloud , prefix your doctype names with cloud.bar.foo . We maintain an index of all the currently available doctypes . To make your own doctypes available to other applications, please send a pull request to this repository. Before manipulating documents, you have to request permission to access their doctype, either in the manifest or dynamically. Every method allowing to handle document are available under the cozy.client.data namespace. For example: cozy.client.data.create(doctype, attributes) , cozy.client.data.update(doctype, doc, newdoc) cozy.client.data.delete(doctype, doc) to create, update and delete documents cozy.client.data.updateAttributes(doctype, id, changes) to only update some attributes of a document cozy.client.data.find(doctype, id) return a document using its ident cozy.client.data.changesFeed(doctype, options) get the latests updates of documents of a doctype you can attach files to a document using cozy.client.data.addReferencedFiles(doc, fileIds) and list attachments with cozy.client.data.listReferencedFiles(doc) Querying To search documents inside the database, you first need to create an index on some attributes of the documents, then perform a query on this index. The library offers the following methods: cozy.client.data.defineIndex(doctype, fields) to create the index cozy.client.data.query(indexReference, query) to query an index. The query parameter uses the syntax of the Mango API from CouchDB 2. For example, to search contacts by their email address, you could use: cozy.client.data.defineIndex( io.cozy.contacts , [ email ]) .then((index) = { return cozy.data.query(index, { selector : {email: cozy@cozycloud.cc }}) }) .then( (result) = { console.log(result[0].name); }); Manipulating files The metadata of the files are stored inside the server database, allowing to perform advanced queries, and the files themselves on a virtual file system. The library offer a lot of methods under cozy.client.files namespace to manipulate files. Most of the methods allows to manipulate a file or folder either by its id or by its full path. Here are the most commons ones, but a lot of other methods are available in the raw API documentation : create() and updateById() to create and update a file createDirectory() to create a folder updateAttributesById() et updateAttributesByPath() allow to update some metadata use destroyById to remove a file a virtual trash is available. You can put files into the trash ( trashById() ) and restore them ( restoreById() ). You can also list the content of the trash ( listTrash() ) and purge all trashed files ( clearTrash() ) statById(id) et statByPath(path) return the metadata and, or folders, their content Folders When using statById() or statByPath() to get metadata of of folder, you can than call relations() on the resulting object to access their content. For example, to list content of the root folder, use: cozy.client.files.statByPath( / ) .then((dir) = { console.log(dir.relations( contents )); }) Some special folder have a pre-defined id that will never change: io.cozy.files.root-dir is the root of the filesystem io.cozy.files.trash-dir is the trash. The Cozy Bar The Cozy Bar is a component that display the Cozy menu on the top of your application and allow inter-apps features like content sharing. Your application interacts with this component through cozy-bar.js , a library injected into your pages by the server when you add {{.CozyBar}} in the header. It exposes an API behind the window.cozy.bar namespace. Before using it, you have to initialize the library: window.cozy.bar.init({appName: \"Mon application\"}) . Styling If you plan to build a webapp to run on Cozy, you\u2019ll probably want to use a simple and elegant solution to build your interfaces without the mess of dealing with complex markup and CSS. Then Cozy UI is here for you! It relies on Stylus as preprocessor. You can add it as a library in your project to use it out-of-the-box. The development server using Docker (remember what we previously said about the permissions required to run Docker: if your user doesn\u2019t belong to the docker group, you\u2019ll have to use sudo to run each of this commands.) To run your application inside the development server, just run the following command from the folder where your index.html and manifest.webapp files leave: docker run --rm -it -p 8080:8080 -p 5984:5984 -p 8025:8025 -v $(pwd):/data/cozy-app --name cozydev cozy/cozy-app-dev Let\u2019s have a quick look at this command, so you can adapt it to your needs: --rm will delete the server when you stop it. This prevent Docker from keeping a lot of unused stopped images -it allow to attach an interactive terminal, so you\u2019ll be able to use the command line inside the server -p 8080:8080 : the server listens on port 8080 on the virtual machine. We forward this port to the same port on your local machine. To use another local port, for example 9090, use -p 9090:8080 -p 5984:5984 : this is just a convenient way to access the CouchDB database running inside the server. Point your browser to http://cozy.tools:5984/_utils/ to access its administrative interface -p 8025:8025 : Cozy requires a mail server. In the development image, we don\u2019t use a real email server, but a software that can display the sent messages. Just point your browser to http://cozy.tools:8025/ to display the messages sent by the server -v $(pwd):/data/cozy-app this mount the current folder, where your application leaves, inside the server. This is what make the application available on the server --name cozydev name the running virtual machine cozydev , so you can easily refer to it from other Docker commands. For example, if you want to connect to a shell inside the server, you can use docker exec -ti /bin/bash With this syntax, there is no data persistance: all your test data will be lost every time you stop the server. This is a good way to prevent side effects and start on a clean base, with an empty database. However, if you want to persist data, you have to mount two folders from the virtual server to local folders: /usr/local/couchdb/data (database) and /data/cozy-storage (the virtual filesystem). This can be achieved by adding to the command line -v ~/cozy/data/db:/usr/local/couchdb/data -v ~/cozy/data/storage:/data/cozy-storage which will store the server\u2019s data into ~/cozy/data . Once the server started, go to http://app.cozy.tools:8080/# , connect to the server with the default password cozy and you should be able to start testing your application. You can also access the following URLs: http://cozy.tools:5984/_utils to get the database administrative panel http://cozy.tools:8025/ to display the emails sent by the server. Test multiple applications You can install more than one application into the development server, for example to test communication between applications. In order to achieve this, you have to mount the folder where your application leaves into subfolders of /data/cozy-apps . For example, if the code of Cozy Drive and Cozy Photos is on your local filesystem in ~/cozy/drive and ~/cozy/photos , start the development server with: docker run --rm -it -p 8080:8080 -p 5984:5984 -p 8025:8025 -v ~/cozy/drive:/data/cozy-app/drive -v ~/cozy/photos:/data-cozy-app/photos --name=cozydev cozy/cozy-app-dev You\u2019ll access the applications by connecting to http://drive.cozy.tools:8080/ and http://photos.cozy.tools:8080 . What is cozy.tools ? This development server use the domain names *.cozy.tools . We have parameterized this domain to always redirect to 127.0.0.1 , your local computer address. With that, no need to configure your environment to set extra local hosts for development anymore.","title":"app"},{"location":"/dev/app/#how-to-create-your-first-cozy-application","text":"","title":"How to create your first Cozy application"},{"location":"/dev/app/#prerequisite","text":"Developing an application for Cozy is quite easy. All you need to have is: NodeJS 8+ Yarn : a NodeJS package manager, like npm Docker to have a Cozy for dev Some basics about developing a single page application in HTML/JS or you just want to learn :) The only tool required to have a Cozy for development is Docker. We have been told that installing Docker on some familial flavours of Windows may be a bit difficult. If you use Windows, please check if Docker is available on your system.","title":"Prerequisite"},{"location":"/dev/app/#install-the-development-environment","text":"On GNU/Linux, according to the documentation : \u00ab The docker daemon binds to a Unix socket instead of a TCP port. By default that Unix socket is owned by the user root and other users can only access it using sudo. If you don\u2019t want to use sudo when you use the docker command, create a Unix group called docker and add users to it. Be warned that the docker group grants privileges equivalent to the root user. You should have a look at Docker\u2019s documentation on security . Every application running inside Cozy is a client-side HTML5 application interacting with your data through the API of the server. To develop an application, you\u2019ll require a running Cozy server. The easiest way is to use the Docker image for developers we provide. Just install it: docker pull cozy/cozy-app-dev (We update this image on a regular basis with the latest version of the server and our library. Don\u2019t forget to update the image by running docker pull cozy/cozy-app-dev from time to time).","title":"Install the development environment"},{"location":"/dev/app/#create-your-application","text":"You can boostrap your application from scratch if you want, but we recommand to use our new community tool create-cozy-app to bootstrap very easily a Cozy application for you. This tool will generate an application using (P)React, the framework we internally use in the Cozy Front team. But options are available if you want to use other frameworks. For now the new cozy-client is used only in the (P)React template (it doesn t use the previous cozy-client-js anymore). This library is at an early stage but you can use it, it will be our next Cozy client for application development. First of all, run directly create-cozy-app without installing it globally by using the yarn create cozy-app command to bootstrap your application: yarn create cozy-app mycozyapp The script will download some dependencies (may take a while) and ask you a few questions, then create an application skeleton inside mycozyapp . That s all! You can start hacking: cd mycozyapp yarn watch:standalone After the webpack build, your app should be available at http://localhost:8888 You can change the host and the port of your application server here by using respectively the environment variables HOST and PORT","title":"Create your application"},{"location":"/dev/app/#run-it-inside-a-cozy-using-docker","text":"You can run your application (here mycozyapp ) inside a Cozy thanks to the [cozy-stack docker image][cozy-stack-docker]: # in a terminal, run your app in watch mode $ cd mycozyapp $ yarn watch:browser Then, in another terminal: # in another terminal, run the docker container $ yarn stack:docker # or if you want the complete command (see more documentation below) $ docker run --rm -it -p 8080:8080 -v $(pwd)/build :/data/cozy-app/mycozyapp cozy/cozy-app-dev Your app is now available at http://mycozyapp.cozy.tools:8080.","title":"Run it inside a Cozy using Docker"},{"location":"/dev/app/#extra-documentation-about-application-development","text":"","title":"Extra documentation about application development"},{"location":"/dev/app/#how-is-the-application-working","text":"The minimal application consist of only two files: an HTML file, index.html , with the markup and the code of your application a manifest describing the application. It\u2019s a JSON file named manifest.webapp with the name of the application, the permissions it requires\u2026 We\u2019ll have a deeper look to it content later. Your application requires some informations to interact with the server API, for example the URL of its entrypoint, and an auth token. This data will be dynamically injected into index.html when it serves the page. So the index.html file has to contain some string that will be replaced by the server. The general syntax of this variables is {{\u2026}} , so don\u2019t use this syntax for other purpose in the page, for example inside comments. You can use the following variables: {{.Domain}} will be substituted by the URL of the API entrypoint {{.Token}} will be replaced by a token that authenticate your application when accessing the API {{.Locale}} : the lang f the instance {{.AppName}} : the name of the application {{.IconPath}} will be replaced by HTML code to display the favicon {{.CozyClientJS}} will be replaced with HTML code to inject the Cozy client library {{.CozyBar}} will be replaced with HTML code to inject the upper menu bar.","title":"How is the application working?"},{"location":"/dev/app/#use-the-api-with-cozy-client-js","text":"We are currently working on a new cozy-client library which will be more updated and used in the future than cozy-client-js . But the two libraries ( cozy-client and cozy-client-js ) don t rely on each other so you can still use the one you want to handle Cozy data for now. If you added {{.CozyClientJS}} to your page, interacting with the server will be as easy as using the Cozy Client JS library. All you have to do is to initiate the library with the server parameters (the URL of the API and the auth token of your application): window.cozy.client.init({cozyURL: \u2026 , token: \u2026 }); You can then interact with the server by using methods of the window.cozy.client properties. For example, to get current disk usage: cozy.client.settings.diskUsage() .then(function (usage) {console.log( Usage (promise) , usage);}); .catch(function(err){ console.log( fail , err); }); This library embeds most of the available server APIs: manipulate documents and files, manage applications and server settings\u2026 It also provides some some methods to help application keep working while being offline. Some server APIs may not be available right now through the library. If you want to use one of this method, you\u2019ll have to call it manually. See below. #TODO - add inner link.","title":"Use the API with cozy-client-js"},{"location":"/dev/app/#behind-the-magic","text":"Some server APIs may not be available right now through the library. If you want to use one of this method, you\u2019ll have to call it manually. We\u2019ll describe here how to access the API without using the Cozy Client JS library. Connecting to the API requires three things: its URL, injected into the page through the {{.Domain}} variable the application auth token, injected into the page through the {{.Token}} variable. Each request sent to the server must include this token in the Authorization header the session cookie, created when you connect to your server. This is an HttpOnly cookie , meaning that JavaScript applications can\u2019t read it. This prevent a malicious script to stole the cookie. Here\u2019s a sample code that get API informations provided by the server and query the API: div data-cozy-token= {{.Token}} data-cozy-domain= {{.Domain}} / document.addEventListener('DOMContentLoaded', () = { use strict ; const app = document.querySelector('[data-cozy-token]'); fetch(`//${app.dataset.cozyDomain}/apps`, { method: 'GET', headers: { Authorization: `Bearer ${app.dataset.cozyToken}` // Here we use the auth token }, credentials: 'include' // don\u2019t forget to include the session cookie }) .then(function (response) { if (response.ok) { response.json().then((result) = { console.log(result); }); } else { throw new Error('Network response was not ok.'); } }) .catch(function (error) { console.log('There has been a problem with your fetch operation: ' + error.message); }); });","title":"Behind the magic"},{"location":"/dev/app/#the-manifest","text":"Each application must have a \u201cmanifest\u201d. It\u2019s a JSON file named manifest.webapp stored at the root of the application directory. It describes the application, the type of documents it uses, the permissions it require\u2026 Here\u2019s a sample manifest: { name : My Awesome application , permissions : { apps : { type : io.cozy.apps }, permissions : { type : io.cozy.permissions }, settings : { type : io.cozy.settings }, sample : { type : io.cozy.dev.sample , verbs : [ GET , POST , PUT , PATCH , DELETE ] }, jobs : { type : io.cozy.jobs } }, routes : { / : { folder : / , index : index.html , public : false }, /public : { folder : /public , index : index.html , public : true } } }","title":"The manifest"},{"location":"/dev/app/#permissions","text":"Applications require permissions to use most of the APIs. Permissions can be described inside the manifest, so the server can ask the user to grant them during installation. Applications can also request permissions at run time. A permission must at type contain a target, the type of objects the application want to interact with. Can be a document type, or an action on the server. By default, all grant on this object are granted, but we can also request fine grained permissions, for example limiting to read access. We can also limit the scope to a subset of the documents. In the manifest, each permission is an object, with a random name and some properties: type : mandatory the document type or action name description : a text that will be displayed to the user to explain why the application require this permission verbs : an array of HTTP verbs. For example, to limit permissions to read access, use [\"GET\"] selector : a document attribute to limit access to a subset of documents values : array of allowed values for this attribute. An application can request a token that grant access to a subset of its own permissions. For example if the application has full access to the files, it can obtain a token that give only read access on a file. Thus, the application can make some documents publicly available. The public page of the application will use this token as authentication token when accessing the API.","title":"Permissions"},{"location":"/dev/app/#samples","text":"Application require full access to files: { permissions : { files : { description : \u2026 , type : io.cozy.files }, } } Application want to be able to read the contact informations of cozy@cozycloud.cc { permissions : { contact : { type : io.cozy.contacts , verbs : [ GET ], selector : email , values : [ cozy@cozycloud.cc ] } } }","title":"Samples"},{"location":"/dev/app/#routing","text":"The application must declare all of its URLs (routes) inside the manifest. A route is an object associating an URL to an HTML file. Each route has the following properties: folder : the base folder of the route index : the name of the file inside this folder public : a boolean specifying whether the route is public or private (default). Sample: routes : { /admin : { folder : / , index : admin.html , public : false }, /public : { folder : /public , index : index.html , public : true }, /assets : { folder : /assets , public : true } }","title":"Routing"},{"location":"/dev/app/#cozy-client-js","text":"This library embeds most of the available server APIs: manipulate documents and files, manage applications and server settings\u2026 It also provides some some methods to help application keep working while being offline. The library expose a client API under the window.cozy.client namespace. Before using it, you have to initiate the library with the server parameters (the URL of the API and the auth token of your application): window.cozy.client.init({cozyURL: \u2026 , token: \u2026 }); The library supports two programming paradigms: callback and Promises, so you can use your favorite one. If you prefer using callbacks rather than Promises, just add disablePromises to the options when initializing the library: window.cozy.client.init({cozyURL: \u2026 , token: \u2026 , disablePromises: true}); window.client.settings.diskUsage(function (err, res) { (\u2026) });","title":"cozy-client-js"},{"location":"/dev/app/#raw-api-documentation","text":"In this tutorial, we\u2019ll only see a few samples of how to use the library. For a complete description of all available methods, please refer to its own documentation: documents files authentification authentication with OAuth2 settings inter-app communication jobs and triggers sharing offline Cozy Bar","title":"Raw API documentation"},{"location":"/dev/app/#manipulating-documents","text":"Inside cozy data system, all documents are typed. To prevent applications to create document types with the same name but different description, the naming of the doctypes use the Java specification . Every document type name must be prefixed by the reverted domain name of its creator. If you don\u2019t own a domain name, you can also use your email address. For example, doctypes created by Cozy are prefixed by io.cozy or io.cozy.labs . If you don\u2019t own a domain name, and your email address is foo@bar.cloud , prefix your doctype names with cloud.bar.foo . We maintain an index of all the currently available doctypes . To make your own doctypes available to other applications, please send a pull request to this repository. Before manipulating documents, you have to request permission to access their doctype, either in the manifest or dynamically. Every method allowing to handle document are available under the cozy.client.data namespace. For example: cozy.client.data.create(doctype, attributes) , cozy.client.data.update(doctype, doc, newdoc) cozy.client.data.delete(doctype, doc) to create, update and delete documents cozy.client.data.updateAttributes(doctype, id, changes) to only update some attributes of a document cozy.client.data.find(doctype, id) return a document using its ident cozy.client.data.changesFeed(doctype, options) get the latests updates of documents of a doctype you can attach files to a document using cozy.client.data.addReferencedFiles(doc, fileIds) and list attachments with cozy.client.data.listReferencedFiles(doc)","title":"Manipulating documents"},{"location":"/dev/app/#querying","text":"To search documents inside the database, you first need to create an index on some attributes of the documents, then perform a query on this index. The library offers the following methods: cozy.client.data.defineIndex(doctype, fields) to create the index cozy.client.data.query(indexReference, query) to query an index. The query parameter uses the syntax of the Mango API from CouchDB 2. For example, to search contacts by their email address, you could use: cozy.client.data.defineIndex( io.cozy.contacts , [ email ]) .then((index) = { return cozy.data.query(index, { selector : {email: cozy@cozycloud.cc }}) }) .then( (result) = { console.log(result[0].name); });","title":"Querying"},{"location":"/dev/app/#manipulating-files","text":"The metadata of the files are stored inside the server database, allowing to perform advanced queries, and the files themselves on a virtual file system. The library offer a lot of methods under cozy.client.files namespace to manipulate files. Most of the methods allows to manipulate a file or folder either by its id or by its full path. Here are the most commons ones, but a lot of other methods are available in the raw API documentation : create() and updateById() to create and update a file createDirectory() to create a folder updateAttributesById() et updateAttributesByPath() allow to update some metadata use destroyById to remove a file a virtual trash is available. You can put files into the trash ( trashById() ) and restore them ( restoreById() ). You can also list the content of the trash ( listTrash() ) and purge all trashed files ( clearTrash() ) statById(id) et statByPath(path) return the metadata and, or folders, their content","title":"Manipulating files"},{"location":"/dev/app/#folders","text":"When using statById() or statByPath() to get metadata of of folder, you can than call relations() on the resulting object to access their content. For example, to list content of the root folder, use: cozy.client.files.statByPath( / ) .then((dir) = { console.log(dir.relations( contents )); }) Some special folder have a pre-defined id that will never change: io.cozy.files.root-dir is the root of the filesystem io.cozy.files.trash-dir is the trash.","title":"Folders"},{"location":"/dev/app/#the-cozy-bar","text":"The Cozy Bar is a component that display the Cozy menu on the top of your application and allow inter-apps features like content sharing. Your application interacts with this component through cozy-bar.js , a library injected into your pages by the server when you add {{.CozyBar}} in the header. It exposes an API behind the window.cozy.bar namespace. Before using it, you have to initialize the library: window.cozy.bar.init({appName: \"Mon application\"}) .","title":"The Cozy Bar"},{"location":"/dev/app/#styling","text":"If you plan to build a webapp to run on Cozy, you\u2019ll probably want to use a simple and elegant solution to build your interfaces without the mess of dealing with complex markup and CSS. Then Cozy UI is here for you! It relies on Stylus as preprocessor. You can add it as a library in your project to use it out-of-the-box.","title":"Styling"},{"location":"/dev/app/#the-development-server-using-docker","text":"(remember what we previously said about the permissions required to run Docker: if your user doesn\u2019t belong to the docker group, you\u2019ll have to use sudo to run each of this commands.) To run your application inside the development server, just run the following command from the folder where your index.html and manifest.webapp files leave: docker run --rm -it -p 8080:8080 -p 5984:5984 -p 8025:8025 -v $(pwd):/data/cozy-app --name cozydev cozy/cozy-app-dev Let\u2019s have a quick look at this command, so you can adapt it to your needs: --rm will delete the server when you stop it. This prevent Docker from keeping a lot of unused stopped images -it allow to attach an interactive terminal, so you\u2019ll be able to use the command line inside the server -p 8080:8080 : the server listens on port 8080 on the virtual machine. We forward this port to the same port on your local machine. To use another local port, for example 9090, use -p 9090:8080 -p 5984:5984 : this is just a convenient way to access the CouchDB database running inside the server. Point your browser to http://cozy.tools:5984/_utils/ to access its administrative interface -p 8025:8025 : Cozy requires a mail server. In the development image, we don\u2019t use a real email server, but a software that can display the sent messages. Just point your browser to http://cozy.tools:8025/ to display the messages sent by the server -v $(pwd):/data/cozy-app this mount the current folder, where your application leaves, inside the server. This is what make the application available on the server --name cozydev name the running virtual machine cozydev , so you can easily refer to it from other Docker commands. For example, if you want to connect to a shell inside the server, you can use docker exec -ti /bin/bash With this syntax, there is no data persistance: all your test data will be lost every time you stop the server. This is a good way to prevent side effects and start on a clean base, with an empty database. However, if you want to persist data, you have to mount two folders from the virtual server to local folders: /usr/local/couchdb/data (database) and /data/cozy-storage (the virtual filesystem). This can be achieved by adding to the command line -v ~/cozy/data/db:/usr/local/couchdb/data -v ~/cozy/data/storage:/data/cozy-storage which will store the server\u2019s data into ~/cozy/data . Once the server started, go to http://app.cozy.tools:8080/# , connect to the server with the default password cozy and you should be able to start testing your application. You can also access the following URLs: http://cozy.tools:5984/_utils to get the database administrative panel http://cozy.tools:8025/ to display the emails sent by the server.","title":"The development server using Docker"},{"location":"/dev/app/#test-multiple-applications","text":"You can install more than one application into the development server, for example to test communication between applications. In order to achieve this, you have to mount the folder where your application leaves into subfolders of /data/cozy-apps . For example, if the code of Cozy Drive and Cozy Photos is on your local filesystem in ~/cozy/drive and ~/cozy/photos , start the development server with: docker run --rm -it -p 8080:8080 -p 5984:5984 -p 8025:8025 -v ~/cozy/drive:/data/cozy-app/drive -v ~/cozy/photos:/data-cozy-app/photos --name=cozydev cozy/cozy-app-dev You\u2019ll access the applications by connecting to http://drive.cozy.tools:8080/ and http://photos.cozy.tools:8080 .","title":"Test multiple applications"},{"location":"/dev/app/#what-is-cozytools","text":"This development server use the domain names *.cozy.tools . We have parameterized this domain to always redirect to 127.0.0.1 , your local computer address. With that, no need to configure your environment to set extra local hosts for development anymore.","title":"What is cozy.tools ?"},{"location":"/dev/connect-mobile-app-local-stack/","text":"How to connect a mobile app to your local stack Sometimes we need to test a feature on a mobile app by connecting it to our locally installed stack. For this to work, we need to achieve some things. Prerequisite Have a local stack installed Have an Android emulator created Start the emulator with the ability to remount its file system as writable Since we will need to edit the hosts of the emulator, we need to be able to remount its file system as writable. For that, we need to start our emulator with the following command : ./emulator -writable-system -avd Pixel_API_27 The emulator binary is located at /home/user/Android/Sdk/emulator/ on Linux systems by default. Pixel_API_27 is the name of the emulator I want to start. If you don t know the name of your emulator, you can get it with : ./emulator -list-avds Root the emulator Now that the emulator is started, we need to gain root access on it. Run the following command : adb root This restarts the adb daemon with root privileges. Remount the file sytem as writable By default, the file system is read-only. We need it to be writable, so we run this command : adb remount Pull the emulator s hosts file To edit the hosts file, we need to pull it on our system : adb pull /etc/hosts hosts This creates a hosts file in your current directory. Edit the hosts For the emulator to be able to connect to our stack, we need to add the IP address of our machine to the hosts. Actually, we don t really need it since in an Android emulator 10.0.2.2 is automatically pointing to our machine. So we just need to add this to the hosts file : 10.0.2.2 cozy.tools Push the new file to the emulator Now that we have added what s necessary in the file, we have to push it to the emulator : adb push hosts /system/etc/hosts Then try to ping cozy.tools to see if everything is working well : adb shell ping api.dev.local You can now enter http://cozy.tools in the login page of your mobile app and you will not get an error anymore.","title":"connect-mobile-app-local-stack"},{"location":"/dev/connect-mobile-app-local-stack/#how-to-connect-a-mobile-app-to-your-local-stack","text":"Sometimes we need to test a feature on a mobile app by connecting it to our locally installed stack. For this to work, we need to achieve some things.","title":"How to connect a mobile app to your local stack"},{"location":"/dev/connect-mobile-app-local-stack/#prerequisite","text":"Have a local stack installed Have an Android emulator created","title":"Prerequisite"},{"location":"/dev/connect-mobile-app-local-stack/#start-the-emulator-with-the-ability-to-remount-its-file-system-as-writable","text":"Since we will need to edit the hosts of the emulator, we need to be able to remount its file system as writable. For that, we need to start our emulator with the following command : ./emulator -writable-system -avd Pixel_API_27 The emulator binary is located at /home/user/Android/Sdk/emulator/ on Linux systems by default. Pixel_API_27 is the name of the emulator I want to start. If you don t know the name of your emulator, you can get it with : ./emulator -list-avds","title":"Start the emulator with the ability to remount its file system as writable"},{"location":"/dev/connect-mobile-app-local-stack/#root-the-emulator","text":"Now that the emulator is started, we need to gain root access on it. Run the following command : adb root This restarts the adb daemon with root privileges.","title":"Root the emulator"},{"location":"/dev/connect-mobile-app-local-stack/#remount-the-file-sytem-as-writable","text":"By default, the file system is read-only. We need it to be writable, so we run this command : adb remount","title":"Remount the file sytem as writable"},{"location":"/dev/connect-mobile-app-local-stack/#pull-the-emulators-hosts-file","text":"To edit the hosts file, we need to pull it on our system : adb pull /etc/hosts hosts This creates a hosts file in your current directory.","title":"Pull the emulator's hosts file"},{"location":"/dev/connect-mobile-app-local-stack/#edit-the-hosts","text":"For the emulator to be able to connect to our stack, we need to add the IP address of our machine to the hosts. Actually, we don t really need it since in an Android emulator 10.0.2.2 is automatically pointing to our machine. So we just need to add this to the hosts file : 10.0.2.2 cozy.tools","title":"Edit the hosts"},{"location":"/dev/connect-mobile-app-local-stack/#push-the-new-file-to-the-emulator","text":"Now that we have added what s necessary in the file, we have to push it to the emulator : adb push hosts /system/etc/hosts Then try to ping cozy.tools to see if everything is working well : adb shell ping api.dev.local You can now enter http://cozy.tools in the login page of your mobile app and you will not get an error anymore.","title":"Push the new file to the emulator"},{"location":"/dev/cordova/","text":"How to create a mobile Cozy application The simplest way to create a mobile Cozy application is to use JavaScript as there already are JavaScript libraries to connect to the Cozy server, as known as cozy-stack. Therefore we will use the classical stack: a JavaScript web application and cordova At the end of this documentation , you will find how-tos to help you with cordova configuration , webpack builds and cordova deployments for Android and iOS . To create your first Cozy application , just follow the guide. As you can read there, Cozy applications are served by the Cozy server, this is the way that Cozy applications retrieve a token to query data. In the case of a mobile application, you need to retrieve a token differently. Hopefully we provide everything you need to do it easily. You ll need two libraries: cozy-client ( source ) cozy-bar ( source ) In the case of Cozy web applications served by the Cozy server, these two libraries are injected in the html file with variables {{.CozyClientJS}} and {{.CozyBar}} . Setup index.html First thing first, add JavaScript libraries files into your index.html : !DOCTYPE html html lang= en head meta charset= utf-8 title mobile Cozy application with Cordova /title script src= cozy-client.js /script script src= cozy-bar.js /script /head body !-- page content -- /body /html Connect to Cozy server When an user will start your mobile Cozy application, she/he will need to point to her/his server url to ask for permissions for her/his device. This is done by our library cozy-client , you just need to add a HTML form: form id= form label What is your cozy server url? input name= url id= url type= text / /label button type= submit Submit /button /form const urlInput = document.getElementById( url ); const form = document.getElementById( form ); form.addEventListener( submit , registerClient); function registerClient (event) { event.preventDefault(); const url = urlInput.value; const { client, token } = await cozyClient.register(url); // do whatever you need with client and token like persist } JS Bin on jsbin.com When cozyClient.register(url) is called, the cordova inapp browser plugin is used to display a password request and a permission acceptation page to let the end-user to register her/his device. That s all! Then you can use the cozy-client library as you would within a classic Cozy application . Initialize the Cozy bar The Cozy bar needs some information to be initialized and its initialization must be done in your front-end code: cozy.bar.init({ appName: App Name , appEditor: Editor Name , iconPath: require( ./assets/app-icon.svg ), lang: en-US , replaceTitleOnMobile: true }) Use Cordova Install and setup cordova Cordova is a tool to build Android and iOS applications from a web app. It works with a CLI that needs node . Look at the cordova documentation to install everything needed . Once cordova is installed, just run cordova create cozy-app com.example.cozyapp CozyApp and you get the following structure: ./ \u251c\u2500\u2500 config.xml \u251c\u2500\u2500 hooks \u2502 \u2514\u2500\u2500 README.md \u251c\u2500\u2500 platforms \u251c\u2500\u2500 plugins \u2514\u2500\u2500 www \u251c\u2500\u2500 css \u2502 \u2514\u2500\u2500 index.css \u251c\u2500\u2500 img \u2502 \u2514\u2500\u2500 logo.png \u251c\u2500\u2500 index.html \u2514\u2500\u2500 js \u2514\u2500\u2500 index.js 7 directories, 6 files Note: everything you put in www/ will be served as your application content. Configure your build tool If you use a build tool to transpile your JavaScript code, you need to configure your tool to output the build into www/ . webpack configuration As Webpack is the most used build tool we will show you how to configure it with cordova: Create a webpack.config.js on the root folder of your project with: const path = require('path'); module.exports = { entry: './src/app.js', output: { filename: 'bundle.js', path.resolve(__dirname, 'www') } } And add the output bundle in the www/index.html file: html head ... /head body ... script src= bundle.js /script /body /html See the official webpack documentation for more details. Cordova Android Platform Use cordova platform add android and check your environment with cordova requirements : A bad requirements check: Requirements check results for android: Java JDK: installed . Android SDK: installed Android target: not installed Android SDK not found. Make sure that it is installed. If it is not at the default location, set the ANDROID_HOME environment variable. Gradle: installed Error: Some of requirements check failed A good requirements check: Requirements check results for android: Java JDK: installed . Android SDK: installed Android target: installed android-19,android-21,android-22,android-23,Google Inc.:Google APIs:19,Google Inc.:Google APIs (x86 System Image):19,Google Inc.:Google APIs:23 Gradle: installed See cordova, android and ios documentation to customize your development environment for your special needs. Once everything is right, you could run cordova build and cordova run android to create an APK and push the APK on a device. Note: The device should be connected with usb. See official android documentation for more details . iOS development For building an iOS app, you need xcode . [[more to come]] See further details on the cordova official documentation about iOS .","title":"cordova"},{"location":"/dev/cordova/#how-to-create-a-mobile-cozy-application","text":"The simplest way to create a mobile Cozy application is to use JavaScript as there already are JavaScript libraries to connect to the Cozy server, as known as cozy-stack. Therefore we will use the classical stack: a JavaScript web application and cordova At the end of this documentation , you will find how-tos to help you with cordova configuration , webpack builds and cordova deployments for Android and iOS . To create your first Cozy application , just follow the guide. As you can read there, Cozy applications are served by the Cozy server, this is the way that Cozy applications retrieve a token to query data. In the case of a mobile application, you need to retrieve a token differently. Hopefully we provide everything you need to do it easily. You ll need two libraries: cozy-client ( source ) cozy-bar ( source ) In the case of Cozy web applications served by the Cozy server, these two libraries are injected in the html file with variables {{.CozyClientJS}} and {{.CozyBar}} .","title":"How to create a mobile Cozy application"},{"location":"/dev/cordova/#setup-indexhtml","text":"First thing first, add JavaScript libraries files into your index.html : !DOCTYPE html html lang= en head meta charset= utf-8 title mobile Cozy application with Cordova /title script src= cozy-client.js /script script src= cozy-bar.js /script /head body !-- page content -- /body /html","title":"Setup index.html"},{"location":"/dev/cordova/#connect-to-cozy-server","text":"When an user will start your mobile Cozy application, she/he will need to point to her/his server url to ask for permissions for her/his device. This is done by our library cozy-client , you just need to add a HTML form: form id= form label What is your cozy server url? input name= url id= url type= text / /label button type= submit Submit /button /form const urlInput = document.getElementById( url ); const form = document.getElementById( form ); form.addEventListener( submit , registerClient); function registerClient (event) { event.preventDefault(); const url = urlInput.value; const { client, token } = await cozyClient.register(url); // do whatever you need with client and token like persist } JS Bin on jsbin.com When cozyClient.register(url) is called, the cordova inapp browser plugin is used to display a password request and a permission acceptation page to let the end-user to register her/his device. That s all! Then you can use the cozy-client library as you would within a classic Cozy application .","title":"Connect to Cozy server"},{"location":"/dev/cordova/#initialize-the-cozy-bar","text":"The Cozy bar needs some information to be initialized and its initialization must be done in your front-end code: cozy.bar.init({ appName: App Name , appEditor: Editor Name , iconPath: require( ./assets/app-icon.svg ), lang: en-US , replaceTitleOnMobile: true })","title":"Initialize the Cozy bar"},{"location":"/dev/cordova/#use-cordova","text":"","title":"Use Cordova"},{"location":"/dev/cordova/#install-and-setup-cordova","text":"Cordova is a tool to build Android and iOS applications from a web app. It works with a CLI that needs node . Look at the cordova documentation to install everything needed . Once cordova is installed, just run cordova create cozy-app com.example.cozyapp CozyApp and you get the following structure: ./ \u251c\u2500\u2500 config.xml \u251c\u2500\u2500 hooks \u2502 \u2514\u2500\u2500 README.md \u251c\u2500\u2500 platforms \u251c\u2500\u2500 plugins \u2514\u2500\u2500 www \u251c\u2500\u2500 css \u2502 \u2514\u2500\u2500 index.css \u251c\u2500\u2500 img \u2502 \u2514\u2500\u2500 logo.png \u251c\u2500\u2500 index.html \u2514\u2500\u2500 js \u2514\u2500\u2500 index.js 7 directories, 6 files Note: everything you put in www/ will be served as your application content.","title":"Install and setup cordova"},{"location":"/dev/cordova/#configure-your-build-tool","text":"If you use a build tool to transpile your JavaScript code, you need to configure your tool to output the build into www/ .","title":"Configure your build tool"},{"location":"/dev/cordova/#webpack-configuration","text":"As Webpack is the most used build tool we will show you how to configure it with cordova: Create a webpack.config.js on the root folder of your project with: const path = require('path'); module.exports = { entry: './src/app.js', output: { filename: 'bundle.js', path.resolve(__dirname, 'www') } } And add the output bundle in the www/index.html file: html head ... /head body ... script src= bundle.js /script /body /html See the official webpack documentation for more details.","title":"webpack configuration"},{"location":"/dev/cordova/#cordova","text":"","title":"Cordova"},{"location":"/dev/cordova/#android-platform","text":"Use cordova platform add android and check your environment with cordova requirements : A bad requirements check: Requirements check results for android: Java JDK: installed . Android SDK: installed Android target: not installed Android SDK not found. Make sure that it is installed. If it is not at the default location, set the ANDROID_HOME environment variable. Gradle: installed Error: Some of requirements check failed A good requirements check: Requirements check results for android: Java JDK: installed . Android SDK: installed Android target: installed android-19,android-21,android-22,android-23,Google Inc.:Google APIs:19,Google Inc.:Google APIs (x86 System Image):19,Google Inc.:Google APIs:23 Gradle: installed See cordova, android and ios documentation to customize your development environment for your special needs. Once everything is right, you could run cordova build and cordova run android to create an APK and push the APK on a device. Note: The device should be connected with usb. See official android documentation for more details .","title":"Android Platform"},{"location":"/dev/cordova/#ios-development","text":"For building an iOS app, you need xcode . [[more to come]] See further details on the cordova official documentation about iOS .","title":"iOS development"},{"location":"/dev/","text":"Let s hack some code Tutorials introduction to Cozy architecture how to develop your first application how to develop a connector how to create a mobile application with cordova how to send mail in development How to Coming soon! API References Cozy Client JS Reference Iintroduction documents files authentification authentication with OAuth2 settings inter-app communication jobs and triggers offline Cozy Bar Cozy UI introduction styleguide react components in storybook Raw Server API introduction: API architecture conventions JSON-API applications : install, update, list applications marketplace permissions notifications settings auth documents query the database files link files to documents jobs workers architecture and API inter-application communication sharing connectors realtime Proxy for remote data/API Available doctypes We maintain an index of all the currently available doctypes . To make your own doctypes available to other applications, please send a pull request to this repository.","title":"index"},{"location":"/dev/#lets-hack-some-code","text":"","title":"Let's hack some code"},{"location":"/dev/#tutorials","text":"introduction to Cozy architecture how to develop your first application how to develop a connector how to create a mobile application with cordova how to send mail in development","title":"Tutorials"},{"location":"/dev/#how-to","text":"Coming soon!","title":"How to"},{"location":"/dev/#api-references","text":"","title":"API References"},{"location":"/dev/#cozy-client-js-reference","text":"Iintroduction documents files authentification authentication with OAuth2 settings inter-app communication jobs and triggers offline Cozy Bar","title":"Cozy Client JS Reference"},{"location":"/dev/#cozy-ui","text":"introduction styleguide react components in storybook","title":"Cozy UI"},{"location":"/dev/#raw-server-api","text":"introduction: API architecture conventions JSON-API applications : install, update, list applications marketplace permissions notifications settings auth documents query the database files link files to documents jobs workers architecture and API inter-application communication sharing connectors realtime Proxy for remote data/API","title":"Raw Server API"},{"location":"/dev/#available-doctypes","text":"We maintain an index of all the currently available doctypes . To make your own doctypes available to other applications, please send a pull request to this repository.","title":"Available doctypes"},{"location":"/dev/intro/","text":"Introduction Cozy is a personal server hosting applications that allow collect and manipulate all your personal data. There are two kind of applications: web applications : that s Single Page Applications (SPA) written in HTML and JavaScript that run inside the user s browser. They interact with the server through its API. This API allows to manipulate data and files and to perform miscellaneous tasks, like send emails connectors : that s small application written in JavaScript, running on the server side, that import your data from remote sources. In this tutorial, you ll learn how to write a client application and a connector . Architecture Several layers can be distinguished. From inside to outside: the core is a database that store all user data; the database is accessible through a layer that control accesses and expose a REST API; Web applications and other clients offer nice user interfaces to interact with the data. One of our motto is \u00ab Cozy is Simple, Versatile, Yours \u00bb. This applies to our architecture: simple and easy to understand and deploy. Cozy doesn\u2019t require to setup and manage a lot of micro-services; versatile : our server is comfortable anywhere. You can host a single instance on a small Raspberry \u03c0 at home, or a cluster of thousands instances on dedicated servers inside a datacenter; yours : the users are the owners of their data, they keep the control. They can migrate their data from one server to another, and are not dependant from a single hosting provider. As we say: \u201cyou will stay because you can leave\u201d; The server The server consist of a single process. We call it the Cozy stack . It provides services through a REST API that allow to: create, update, delete documents inside the database; send emails; launch jobs on the server. Connectors that import data from remote websites are some sort of jobs. Jobs can be one time tasks (sending a message) or periodic tasks. Some jobs, like the connectors, that require executing third party code on the server side, are sandboxed (we user nsjail for now). \u2026 The server also allow to access the database replication API, allowing to sync documents between the server and local databases, for example in mobile clients. Two authentication methods are available: Web applications running on the server get a session token when the user log in; OAuth2 for other applications. The server is in charge of serving the Web applications users have installed from the application store. The database CouchDB is a document database. Everything, from user data to server settings, is stored inside typed documents, identified by an unique id. Two request methods are allowed: map-reduce or Mango , a specific query language. Every document has a doctype , and we keep an index of the definition of every doctype. Binary data are stored outside the database. Depending on the server configuration, they may be stored on a file system or a dedicated object storage like swift . The datasystem layer inside the Cozy stack is in charge of controlling access rights on documents and binaries. It allows fine gained access control, on a whole doctype or on a set of documents. The applications The server provide services to applications: real time notifications of events; methods allowing applications to communicate and share data; methods allowing sharing of documents between servers. Application store An application registry lists every available applications, and their characteristics. Each application can: create its own doctypes; request permission to access documents; offer services to other applications; register publics routes; create jobs that will be run on server side. Security Each application uses its own sub-domain name, so it gets sandboxed inside the browser: other application are not able to steal it access token and access its data. We use Content Security Policy to control what the application is allowed to do. For example, Web applications running inside Cozy are not allowed to send requests to other websites. This allow a strict control over applications, preventing them to leak your data.","title":"intro"},{"location":"/dev/intro/#introduction","text":"Cozy is a personal server hosting applications that allow collect and manipulate all your personal data. There are two kind of applications: web applications : that s Single Page Applications (SPA) written in HTML and JavaScript that run inside the user s browser. They interact with the server through its API. This API allows to manipulate data and files and to perform miscellaneous tasks, like send emails connectors : that s small application written in JavaScript, running on the server side, that import your data from remote sources. In this tutorial, you ll learn how to write a client application and a connector .","title":"Introduction"},{"location":"/dev/intro/#architecture","text":"Several layers can be distinguished. From inside to outside: the core is a database that store all user data; the database is accessible through a layer that control accesses and expose a REST API; Web applications and other clients offer nice user interfaces to interact with the data. One of our motto is \u00ab Cozy is Simple, Versatile, Yours \u00bb. This applies to our architecture: simple and easy to understand and deploy. Cozy doesn\u2019t require to setup and manage a lot of micro-services; versatile : our server is comfortable anywhere. You can host a single instance on a small Raspberry \u03c0 at home, or a cluster of thousands instances on dedicated servers inside a datacenter; yours : the users are the owners of their data, they keep the control. They can migrate their data from one server to another, and are not dependant from a single hosting provider. As we say: \u201cyou will stay because you can leave\u201d;","title":"Architecture"},{"location":"/dev/intro/#the-server","text":"The server consist of a single process. We call it the Cozy stack . It provides services through a REST API that allow to: create, update, delete documents inside the database; send emails; launch jobs on the server. Connectors that import data from remote websites are some sort of jobs. Jobs can be one time tasks (sending a message) or periodic tasks. Some jobs, like the connectors, that require executing third party code on the server side, are sandboxed (we user nsjail for now). \u2026 The server also allow to access the database replication API, allowing to sync documents between the server and local databases, for example in mobile clients. Two authentication methods are available: Web applications running on the server get a session token when the user log in; OAuth2 for other applications. The server is in charge of serving the Web applications users have installed from the application store.","title":"The server"},{"location":"/dev/intro/#the-database","text":"CouchDB is a document database. Everything, from user data to server settings, is stored inside typed documents, identified by an unique id. Two request methods are allowed: map-reduce or Mango , a specific query language. Every document has a doctype , and we keep an index of the definition of every doctype. Binary data are stored outside the database. Depending on the server configuration, they may be stored on a file system or a dedicated object storage like swift . The datasystem layer inside the Cozy stack is in charge of controlling access rights on documents and binaries. It allows fine gained access control, on a whole doctype or on a set of documents.","title":"The database"},{"location":"/dev/intro/#the-applications","text":"The server provide services to applications: real time notifications of events; methods allowing applications to communicate and share data; methods allowing sharing of documents between servers.","title":"The applications"},{"location":"/dev/intro/#application-store","text":"An application registry lists every available applications, and their characteristics. Each application can: create its own doctypes; request permission to access documents; offer services to other applications; register publics routes; create jobs that will be run on server side.","title":"Application store"},{"location":"/dev/intro/#security","text":"Each application uses its own sub-domain name, so it gets sandboxed inside the browser: other application are not able to steal it access token and access its data. We use Content Security Policy to control what the application is allowed to do. For example, Web applications running inside Cozy are not allowed to send requests to other websites. This allow a strict control over applications, preventing them to leak your data.","title":"Security"},{"location":"/dev/konnector/","text":"How to write a connector Introduction A connector (also known as konnector ) is a script that imports data from another web service and put those data into your cozy. Each connector is an independant application, managed by the Cozy Collect application. To protect your data, each connector runs inside a container in order to sandbox all their interactions with your data. How does it work? A connector is a NodeJS script. The target node version used to run your connector is the current LTS version (8 at the time this doc was written). Like client side apps, connectors communicate with the Cozy Stack using its HTTP API, and get an unique auth token every time they start. They need to register with a manifest, and ask the user for permissions. To facilitate connector development, a npm package, [konnectors/libs], provides some shared libraries that are adapted to be used for a connector: cheerio to easily query a HTML page request-promise : request with Promise support request-debug that displays all the requests and responses in the standard output. Toggle debug option in requestFactory options Besides, you ll probably need some other npm packages to help you run your connector: momentjs or date-fns to manage dates bluebird to get enhanced promises When the connector is started, it also receives some data via environment variables: COZY_CREDENTIALS : an auth token used by cozy-client-js to communicate with the server COZY_URL : the Cozy Stack API entry point COZY_FIELDS : settings coming from Cozy Collect and filled by the user (login, password, directory path). These variables are used by the connector and the cozy-client to configure the connection to the Cozy Stack with the right permissions as defined in the connector manifest. They are simulated in standalone mode so that you do not need a real Cozy Stack to develop a connector. [ More about BaseKonnector ] From the server point of view, each connector is a job which is executed periodically via a trigger . [ More about Cozy Stack jobs ] Let\u2019s create our first connector The easiest way to create a new connector is to use cozy-konnector-template : Run the sample First of all, download or clone the repository: git clone https://github.com/konnectors/cozy-konnector-template cozy-konnector-newservice cd cozy-konnector-newservice rm -rf .git git init yarn install # or npm install note: we use yarn , but if you prefer npm , keep using it, everything should work. The connector is ready to run with sample code. As a demo we will scrape a fictional website: books.toscrape.com , for which you do not need credentials . As indicated in the README.md file, just run: yarn standalone # or npm run standalone The very first run will create a konnector-dev-config.json file that allows you to configure the connector input when executing it with the CLI. This configuration comes from Cozy Collect when deployed. { COZY_URL : http://cozy.tools:8080 , fields : { // configuration injected to the start function } } The fields property allow you to set credentials for the targeted web service, such as login and password as if they come from Cozy Stack . The COZY_URL property will be used later. As explained earlier, the demo website books.toscrape.com does not need any credentials. But for the code to run without error, you need to register a fake login and a fake password: { COZY_URL : http://cozy.tools:8080 , fields : { login : zuck.m@rk.fb , password : 123456 } } In cozy-konnector-template, this configuration file is already added to .gitignore file to be sure your credentials stay private. Now you can run the connector again in standalone mode to see how jpg and related data are downloaded. In this mode, [ cozy-client-js ] is stubbed and all data meant to be saved in a cozy are displayed in the standard output and files are saved in the root directory of the connector. This is useful to start developing your connector without handling the state of a real Cozy Stack . Please check CLI section of the documentation for more information. Implement your connector There are four steps for a connector to save data to Cozy Stack : authentication request data parse and format data save data to cozy stack You can see these steps in the src/index.js in the konnectors/cozy-konnector-template : async function start(fields) { // step 1. log('info', 'Authenticating ...') await authenticate(fields.login, fields.password) log('info', 'Successfully logged in') // step 2. // The BaseKonnector instance expects a Promise as return of the function log('info', 'Fetching the list of documents') const $ = await request(`${baseUrl}/index.html`) // step 3. log('info', 'Parsing list of documents') const documents = await parseDocuments($) // step 4. // here we use the saveBills function even if what we fetch are not bills, but this is the most // common case in connectors log('info', 'Saving data to Cozy') await saveBills(documents, fields.folderPath, { // this is a bank identifier which will be used to link bills to bank operations. These // identifiers should be at least a word found in the title of a bank operation related to this // bill. It is not case sensitive. identifiers: ['books'] }) } Authentication Open the src/index.js file, there are comments to guide you through it. The very first step is to be able to authenticate to the remote service, this is done with the line: await authenticate(fields.login, fields.password) There are many obstacles at this level: is there a captcha? is there a 2FA? how is the form ? note: if the remote service exposes an API, you should use classical request call. Let s say the remote service exposes a simple classical form like https://www.trainline.eu/signin: form id= signin-form novalidate= class= signin__form data-ember-action= data-ember-action-680= 680 input name= email autocomplete= on placeholder= Email Address id= ember691 class= ember-text-field textfield ember-view data-enpass.usermodified= yes type= email input name= password autocomplete= on placeholder= Password id= ember696 class= ember-text-field textfield ember-view data-enpass.usermodified= yes type= password div class= signin__forgot span data-ember-action= data-ember-action-697= 697 a href= /password id= ember698 class= ember-view Forgot your password? /a /span /div div class= signin__buttons div class= signin__buttons-block button type= submit class= signin__button Sign In /button /div /div /form Find a CSS selector for the form tag: form#signin-form . Find the name of the input tags used to host user s credentials: email and password . You are ready to complete the signin(options) object called in the authenticate(username, password) function: function authenticate(username, password) { return signin({ url: `https://www.trainline.eu/signin`, formSelector: 'form#signin-form', formData: { email: username, password }, validate: (statusCode, $) = { // write some code to validate the form submission } }) } To implement the validate function, you need to check what is happening on a successful login and on an unsuccessful login. With the https://www.trainline.eu/signin example, fill the form with wrong credentials, open your browser s devtools (and check the network tab) and submit the form. Here it is clear, on incorrect credentials, the response have a status code 422 : HTTP/2.0 422 No Reason Phrase Do the same with valid crendentials. HTTP/2.0 200 OK Then you can write a simple and straight forward validate code: function authenticate(username, password) { return signin({ url: `https://www.trainline.eu/signin`, formSelector: 'form#signin-form', formData: { email: username, password }, validate: (statusCode, $) = { return statusCode === 200 || log('error', 'Invalid credentials') } }) } Request data Once the konnector is able to be authenticated by the online service, the next step is to fetch data. The most common case is that the invoices we want to fetch are listed in a HTML page. So to request data, we fetch the target webpage that contains invoices list. But sometimes, the webpage is a JavaScript page that uses a JSON API url. JSON is easier to parse than full HTML webpages. For the purpose of this guide, let s consider we are in the case of a full HTML webpage, like the service given as an example in the template: http://books.toscrape.com This is the easiest part, juste fetch the webpage: const $ = await request('http://books.toscrape.com/index.html') The $ variable is set to a cheerio object with useful API to crawl the webpage . That object will be very useful for the next step. Parse the document We want to get every article / of the page in a JavaScript Array: const articles = [].map.call($('article', node = node)) For every book, we want to catch the title attribute of this tag article h3 a . This is a CSS Selector that cheerio understands to select some part of the tree. In order to crawl a list of items to create an Array of json object, we can use the function scrape from the konnector libs : const docs = scrape( $, { title: { sel: 'h3 a', attr: 'title' }, amount: { sel: '.price_color', parse: normalizePrice }, url: { sel: 'h3 a', attr: 'href', parse: url = `${baseUrl}/${url}` }, fileurl: { sel: 'img', attr: 'src', parse: src = `${baseUrl}/${src}` }, filename: { sel: 'h3 a', attr: 'title', parse: title = `${title}.jpg` } }, 'article' ) This code will loop on article / and for each item will create a JSON object with the selector sel and the value of attribute attr if specified, otherwise it takes the value of the child node, this value can be edited with the parse function. Here is a sample for the following markup from http://books.toscrape.com: article class= product_pod div class= image_container a href= catalogue/a-light-in-the-attic_1000/index.html img src= media/cache/2c/da/2cdad67c44b002e7ead0cc35693c0e8b.jpg alt= A Light in the Attic class= thumbnail /a /div p class= star-rating Three i class= icon-star /i i class= icon-star /i i class= icon-star /i i class= icon-star /i i class= icon-star /i /p h3 a href= catalogue/a-light-in-the-attic_1000/index.html title= A Light in the Attic A Light in the ... /a /h3 div class= product_price p class= price_color \u00a351.77 /p p class= instock availability i class= icon-ok /i In stock /p form button type= submit class= btn btn-primary btn-block data-loading-text= Adding... Add to basket /button /form /div /article And we will get the following JSON object: { title : A Light in the Attic , amount : 51.77, url : http://books.toscrape.com/catalogue/a-light-in-the-attic_1000/index.html , fileurl : http://books.toscrape.com/media/cache/2c/da/2cdad67c44b002e7ead0cc35693c0e8b.jpg , filename : A Light in the Attic.jpg } The code sample includes some other function to manipulate the result object, but we have the idea. Once we build a correct object, we can save it to Cozy Stack. Save data to Cozy Stack In the example we use some built-in function to save a bill to the Cozy Stack. But there is a bunch of functions available depending on what you want: addData filterData saveBills saveFiles and so on\u2026 We can find more information in the libs repository . Now that we pass on every steps, it is time to test the connector with yarn standalone . We will see in the following how to connect it effectively to a Cozy Stack. Going further Connector structure Basically, a connector is just a function passed to the BaseKonnector constructor, and which eventually returns a promise: To create the connector, just create a new instance of BaseKonnector with a function as argument: const {BaseKonnector} = require('cozy-konnector-libs') module.exports = new BaseKonnector(fields = { // use fields to get user credentials and choices console.log(fields, 'fields') }) Typical workflow Everytime the connector is run, it will call the function and wait for the resolution of the returned promise. This function can then: log into the target website, fetch data, and save them as an array of objects with specific attributes expected by the save function ( saveFiles , addData , filterData , saveBills ). A basic connector workflow involves: authenticate on the website or API. Might be tricky, but that s the fun :-) getting data from the online service. You can get the data by calling an API or scraping the webpage. Check if the webpage itself is not using an API to retrieve data, might speed up our job. Mobile phones applications usually connects to an API that might be a reliable source of data. A quick exemple of a scraper here . filtering data to remove the ones already present inside the database using filterData save the filtered data into the database ( addData ) save the related files using ( saveFiles ) Error handling If your connector hits an issue fetching or saving the data, it can return an error code by throwing it as an error. The error codes are defined inside the Cozy Collect application and will display an explicit error to the user: LOGIN_FAILED : the konnector could not login NOT_EXISTING_DIRECTORY : the folder specified as folder_to_save does not exist (checked automatically by the BaseKonnector) UNKNOWN_ERROR : there was an unexpected error, please take a look at the logs to know what appened VENDOR_DOWN : the target web site is down now USER_ACTION_NEEDED : The user needs to login to the service to do manual actions (could be Terms Of Service to validate) You can get the list of error codes in require('cozy-konnector-libs').errors ( source ) const {BaseKonnector, errors} = require('cozy-konnector-libs') module.exports = new BaseKonnector(fields = { // Here, the following message will be displayed in cozy-collect : Bad credentials. Check the konnector fields and run the connection again. throw new Error(errors.LOGIN_FAILED) }) cozy-konnector-libs The Cozy Konnector Libs provide several useful methods for common tasks: BaseKonnector : creates the connector and fetches from the stack the connector s parameters (COZY_FIELDS ) cozyClient gives an instance of cozy-client-js already initialized according to COZY_URL , and COZY_CREDENTIALS . Your code can immediately interact with the server thanks to this client. requestFactory a function which returns an instance of request-promise initialized with defaults often used in connector development. log allows to log messages with different levels filterData to filter data addData to store the retrieved data into the cozy linkBankOperations to link a bill to a bank operation saveBills which uses filterData, addData, saveFiles and linkBankOperations and which is specific to bills updateOrCreate create or update documents inside database Linking your connector to a cozy : dev mode After several yarn standalone , your connector is able to automaticaly gather data from the targeted web service. It s time now to put this data in a real cozy. Here comes the dev mode . For that your connector needs more setup : a manifest.konnector file a COZY_URL section in konnector-dev-config.json The manifest Each connector is described by a manifest. This is a JSON file named manifest.konnector at the root of your code folder. It should include the following minimal information: { name : konnector name , type : node , slug : konnectorslug , description : description , source : git://github.com/cozy/cozy-konnector-thename.git , permissions : { accounts : { description : Required to get the account's data , type : io.cozy.accounts , verbs : [ GET ] } } } cozy-konnector-template already has a manifest which you can customize. You may add some permissions for your own doctype. Here is the detailed list of fields for a connector manifest file. You can also get more information on permissions in the official cozy-stack documentation konnector-dev-config.json If you want to put data from your connector to a real cozy, your must define where to find this cozy, and this must be a cozy for which you have the credentials. Here comes the COZY_URL in konnector-dev-config.json which defines just that. Run the dev mode Then you just have to run: yarn dev For the first run, the CLI will open a tab in your browser asking you to grant permissions to the connector. The connector will then save data directly into your cozy. This will validate that your manifest has the needed permissions on the data you want to save. This is the dev mode Integration in the store for all the users To run a connector, we do not want the cozy to install all dependencies of the connector each time it installs it. To avoid this, the connectors need to be compiled into one file in a dedicated branch of the repository and the repository needs to be a public git repository. The package.json file from cozy-konnector-template gives you the commands to do this : yarn build and yarn deploy but the last one needs to be configured in package.json Once your public git repository is configured, you only have to declare it. Cozy will soon have a store for connectors and you will be able to publish connectors yourself. But at the moment, you need to declare your new connector on the cozy forum . The Cozy team will review your code and add your connector to the Cozy Collect application. To make the connector available more quickly for all cozys, you can follow this few steps of packaging: Icon You need to push an icon in assets/ . Please respect this rules : Square icon, possibly a png or svg Try the Apple app store icon if needed Package.json Edit the name to be cozy-konnector- slug> Edit the repository URL Edit the command deploy with the correct repository URL Manifest.konnector Edit the name with a nice name (Capitals and spaces allowed here) Edit icon as needed Edit slug Edit source with the correct repository URL Add a correct vendor link Choose one or more categories in this list : banking, shopping, insurance, isp, telecom, energy, public_service, other If needed, change the input type the target website use to login the user: text , email or phone for instance, this will enforce pre-checking Edit for both locales en and fr the short description and long description FAQ When I run my connector, a ghost node process eats all my memory Cozy-konnector-libs uses cheerio which is great but causes some problems when you try to console.log a cheerio object. In standalone or dev mode, the BaseKonnector tries to catch errors and display a maximum of details about them. But when the error contains a cheerio object, the problem happens. If you get this problem, catch the error yourself and only display the message : .catch(err) { console.log(err.message) // good console.log(err) // bad } How do I scrap a website Use the request function from cozy-konnector-libs with the proper options. Here\u2019s a sample code that will fetch the login page to get the value of the anti-CSRF token, submit the login form, browse to the bills page and fetch a bill: const {BaseKonnector, requestFactory} = require('cozy-konnector-libs') const rq = requestFactory({ jar: true, // handle the cookies like a browser json: false, // do not try to parse the result as a json document cheerio: true // automatically parse the result with [cheerio](https://github.com/cheeriojs/cheerio) }) const moment = require('moment') module.exports = new BaseKonnector(function fetch (fields) { return rq( https://login.remote.web ) .then($ = { // the result is automatically wrapped with cheerio and you can use it like jQuery const form = { form: { login: fields.login, password: fields.password, csrf_token: $('[name= csrf_token ]').val(), } } return rq({ method: 'POST', form }) }) .then($ = rq( https://admin.remote.web/bills )) .then($ = { return [{date: moment($( #bill_date )), value: $( #bill_value )}] }) .then(entries = addData(entries, 'io.cozy.bills')) })","title":"konnector"},{"location":"/dev/konnector/#how-to-write-a-connector","text":"","title":"How to write a connector"},{"location":"/dev/konnector/#introduction","text":"A connector (also known as konnector ) is a script that imports data from another web service and put those data into your cozy. Each connector is an independant application, managed by the Cozy Collect application. To protect your data, each connector runs inside a container in order to sandbox all their interactions with your data.","title":"Introduction"},{"location":"/dev/konnector/#how-does-it-work","text":"A connector is a NodeJS script. The target node version used to run your connector is the current LTS version (8 at the time this doc was written). Like client side apps, connectors communicate with the Cozy Stack using its HTTP API, and get an unique auth token every time they start. They need to register with a manifest, and ask the user for permissions. To facilitate connector development, a npm package, [konnectors/libs], provides some shared libraries that are adapted to be used for a connector: cheerio to easily query a HTML page request-promise : request with Promise support request-debug that displays all the requests and responses in the standard output. Toggle debug option in requestFactory options Besides, you ll probably need some other npm packages to help you run your connector: momentjs or date-fns to manage dates bluebird to get enhanced promises When the connector is started, it also receives some data via environment variables: COZY_CREDENTIALS : an auth token used by cozy-client-js to communicate with the server COZY_URL : the Cozy Stack API entry point COZY_FIELDS : settings coming from Cozy Collect and filled by the user (login, password, directory path). These variables are used by the connector and the cozy-client to configure the connection to the Cozy Stack with the right permissions as defined in the connector manifest. They are simulated in standalone mode so that you do not need a real Cozy Stack to develop a connector. [ More about BaseKonnector ] From the server point of view, each connector is a job which is executed periodically via a trigger . [ More about Cozy Stack jobs ]","title":"How does it work?"},{"location":"/dev/konnector/#lets-create-our-first-connector","text":"The easiest way to create a new connector is to use cozy-konnector-template :","title":"Let\u2019s create our first connector"},{"location":"/dev/konnector/#run-the-sample","text":"First of all, download or clone the repository: git clone https://github.com/konnectors/cozy-konnector-template cozy-konnector-newservice cd cozy-konnector-newservice rm -rf .git git init yarn install # or npm install note: we use yarn , but if you prefer npm , keep using it, everything should work. The connector is ready to run with sample code. As a demo we will scrape a fictional website: books.toscrape.com , for which you do not need credentials . As indicated in the README.md file, just run: yarn standalone # or npm run standalone The very first run will create a konnector-dev-config.json file that allows you to configure the connector input when executing it with the CLI. This configuration comes from Cozy Collect when deployed. { COZY_URL : http://cozy.tools:8080 , fields : { // configuration injected to the start function } } The fields property allow you to set credentials for the targeted web service, such as login and password as if they come from Cozy Stack . The COZY_URL property will be used later. As explained earlier, the demo website books.toscrape.com does not need any credentials. But for the code to run without error, you need to register a fake login and a fake password: { COZY_URL : http://cozy.tools:8080 , fields : { login : zuck.m@rk.fb , password : 123456 } } In cozy-konnector-template, this configuration file is already added to .gitignore file to be sure your credentials stay private. Now you can run the connector again in standalone mode to see how jpg and related data are downloaded. In this mode, [ cozy-client-js ] is stubbed and all data meant to be saved in a cozy are displayed in the standard output and files are saved in the root directory of the connector. This is useful to start developing your connector without handling the state of a real Cozy Stack . Please check CLI section of the documentation for more information.","title":"Run the sample"},{"location":"/dev/konnector/#implement-your-connector","text":"There are four steps for a connector to save data to Cozy Stack : authentication request data parse and format data save data to cozy stack You can see these steps in the src/index.js in the konnectors/cozy-konnector-template : async function start(fields) { // step 1. log('info', 'Authenticating ...') await authenticate(fields.login, fields.password) log('info', 'Successfully logged in') // step 2. // The BaseKonnector instance expects a Promise as return of the function log('info', 'Fetching the list of documents') const $ = await request(`${baseUrl}/index.html`) // step 3. log('info', 'Parsing list of documents') const documents = await parseDocuments($) // step 4. // here we use the saveBills function even if what we fetch are not bills, but this is the most // common case in connectors log('info', 'Saving data to Cozy') await saveBills(documents, fields.folderPath, { // this is a bank identifier which will be used to link bills to bank operations. These // identifiers should be at least a word found in the title of a bank operation related to this // bill. It is not case sensitive. identifiers: ['books'] }) }","title":"Implement your connector"},{"location":"/dev/konnector/#authentication","text":"Open the src/index.js file, there are comments to guide you through it. The very first step is to be able to authenticate to the remote service, this is done with the line: await authenticate(fields.login, fields.password) There are many obstacles at this level: is there a captcha? is there a 2FA? how is the form ? note: if the remote service exposes an API, you should use classical request call. Let s say the remote service exposes a simple classical form like https://www.trainline.eu/signin: form id= signin-form novalidate= class= signin__form data-ember-action= data-ember-action-680= 680 input name= email autocomplete= on placeholder= Email Address id= ember691 class= ember-text-field textfield ember-view data-enpass.usermodified= yes type= email input name= password autocomplete= on placeholder= Password id= ember696 class= ember-text-field textfield ember-view data-enpass.usermodified= yes type= password div class= signin__forgot span data-ember-action= data-ember-action-697= 697 a href= /password id= ember698 class= ember-view Forgot your password? /a /span /div div class= signin__buttons div class= signin__buttons-block button type= submit class= signin__button Sign In /button /div /div /form Find a CSS selector for the form tag: form#signin-form . Find the name of the input tags used to host user s credentials: email and password . You are ready to complete the signin(options) object called in the authenticate(username, password) function: function authenticate(username, password) { return signin({ url: `https://www.trainline.eu/signin`, formSelector: 'form#signin-form', formData: { email: username, password }, validate: (statusCode, $) = { // write some code to validate the form submission } }) } To implement the validate function, you need to check what is happening on a successful login and on an unsuccessful login. With the https://www.trainline.eu/signin example, fill the form with wrong credentials, open your browser s devtools (and check the network tab) and submit the form. Here it is clear, on incorrect credentials, the response have a status code 422 : HTTP/2.0 422 No Reason Phrase Do the same with valid crendentials. HTTP/2.0 200 OK Then you can write a simple and straight forward validate code: function authenticate(username, password) { return signin({ url: `https://www.trainline.eu/signin`, formSelector: 'form#signin-form', formData: { email: username, password }, validate: (statusCode, $) = { return statusCode === 200 || log('error', 'Invalid credentials') } }) }","title":"Authentication"},{"location":"/dev/konnector/#request-data","text":"Once the konnector is able to be authenticated by the online service, the next step is to fetch data. The most common case is that the invoices we want to fetch are listed in a HTML page. So to request data, we fetch the target webpage that contains invoices list. But sometimes, the webpage is a JavaScript page that uses a JSON API url. JSON is easier to parse than full HTML webpages. For the purpose of this guide, let s consider we are in the case of a full HTML webpage, like the service given as an example in the template: http://books.toscrape.com This is the easiest part, juste fetch the webpage: const $ = await request('http://books.toscrape.com/index.html') The $ variable is set to a cheerio object with useful API to crawl the webpage . That object will be very useful for the next step.","title":"Request data"},{"location":"/dev/konnector/#parse-the-document","text":"We want to get every article / of the page in a JavaScript Array: const articles = [].map.call($('article', node = node)) For every book, we want to catch the title attribute of this tag article h3 a . This is a CSS Selector that cheerio understands to select some part of the tree. In order to crawl a list of items to create an Array of json object, we can use the function scrape from the konnector libs : const docs = scrape( $, { title: { sel: 'h3 a', attr: 'title' }, amount: { sel: '.price_color', parse: normalizePrice }, url: { sel: 'h3 a', attr: 'href', parse: url = `${baseUrl}/${url}` }, fileurl: { sel: 'img', attr: 'src', parse: src = `${baseUrl}/${src}` }, filename: { sel: 'h3 a', attr: 'title', parse: title = `${title}.jpg` } }, 'article' ) This code will loop on article / and for each item will create a JSON object with the selector sel and the value of attribute attr if specified, otherwise it takes the value of the child node, this value can be edited with the parse function. Here is a sample for the following markup from http://books.toscrape.com: article class= product_pod div class= image_container a href= catalogue/a-light-in-the-attic_1000/index.html img src= media/cache/2c/da/2cdad67c44b002e7ead0cc35693c0e8b.jpg alt= A Light in the Attic class= thumbnail /a /div p class= star-rating Three i class= icon-star /i i class= icon-star /i i class= icon-star /i i class= icon-star /i i class= icon-star /i /p h3 a href= catalogue/a-light-in-the-attic_1000/index.html title= A Light in the Attic A Light in the ... /a /h3 div class= product_price p class= price_color \u00a351.77 /p p class= instock availability i class= icon-ok /i In stock /p form button type= submit class= btn btn-primary btn-block data-loading-text= Adding... Add to basket /button /form /div /article And we will get the following JSON object: { title : A Light in the Attic , amount : 51.77, url : http://books.toscrape.com/catalogue/a-light-in-the-attic_1000/index.html , fileurl : http://books.toscrape.com/media/cache/2c/da/2cdad67c44b002e7ead0cc35693c0e8b.jpg , filename : A Light in the Attic.jpg } The code sample includes some other function to manipulate the result object, but we have the idea. Once we build a correct object, we can save it to Cozy Stack.","title":"Parse the document"},{"location":"/dev/konnector/#save-data-to-cozy-stack","text":"In the example we use some built-in function to save a bill to the Cozy Stack. But there is a bunch of functions available depending on what you want: addData filterData saveBills saveFiles and so on\u2026 We can find more information in the libs repository . Now that we pass on every steps, it is time to test the connector with yarn standalone . We will see in the following how to connect it effectively to a Cozy Stack.","title":"Save data to Cozy Stack"},{"location":"/dev/konnector/#going-further","text":"","title":"Going further"},{"location":"/dev/konnector/#connector-structure","text":"Basically, a connector is just a function passed to the BaseKonnector constructor, and which eventually returns a promise: To create the connector, just create a new instance of BaseKonnector with a function as argument: const {BaseKonnector} = require('cozy-konnector-libs') module.exports = new BaseKonnector(fields = { // use fields to get user credentials and choices console.log(fields, 'fields') })","title":"Connector structure"},{"location":"/dev/konnector/#typical-workflow","text":"Everytime the connector is run, it will call the function and wait for the resolution of the returned promise. This function can then: log into the target website, fetch data, and save them as an array of objects with specific attributes expected by the save function ( saveFiles , addData , filterData , saveBills ). A basic connector workflow involves: authenticate on the website or API. Might be tricky, but that s the fun :-) getting data from the online service. You can get the data by calling an API or scraping the webpage. Check if the webpage itself is not using an API to retrieve data, might speed up our job. Mobile phones applications usually connects to an API that might be a reliable source of data. A quick exemple of a scraper here . filtering data to remove the ones already present inside the database using filterData save the filtered data into the database ( addData ) save the related files using ( saveFiles )","title":"Typical workflow"},{"location":"/dev/konnector/#error-handling","text":"If your connector hits an issue fetching or saving the data, it can return an error code by throwing it as an error. The error codes are defined inside the Cozy Collect application and will display an explicit error to the user: LOGIN_FAILED : the konnector could not login NOT_EXISTING_DIRECTORY : the folder specified as folder_to_save does not exist (checked automatically by the BaseKonnector) UNKNOWN_ERROR : there was an unexpected error, please take a look at the logs to know what appened VENDOR_DOWN : the target web site is down now USER_ACTION_NEEDED : The user needs to login to the service to do manual actions (could be Terms Of Service to validate) You can get the list of error codes in require('cozy-konnector-libs').errors ( source ) const {BaseKonnector, errors} = require('cozy-konnector-libs') module.exports = new BaseKonnector(fields = { // Here, the following message will be displayed in cozy-collect : Bad credentials. Check the konnector fields and run the connection again. throw new Error(errors.LOGIN_FAILED) })","title":"Error handling"},{"location":"/dev/konnector/#cozy-konnector-libs","text":"The Cozy Konnector Libs provide several useful methods for common tasks: BaseKonnector : creates the connector and fetches from the stack the connector s parameters (COZY_FIELDS ) cozyClient gives an instance of cozy-client-js already initialized according to COZY_URL , and COZY_CREDENTIALS . Your code can immediately interact with the server thanks to this client. requestFactory a function which returns an instance of request-promise initialized with defaults often used in connector development. log allows to log messages with different levels filterData to filter data addData to store the retrieved data into the cozy linkBankOperations to link a bill to a bank operation saveBills which uses filterData, addData, saveFiles and linkBankOperations and which is specific to bills updateOrCreate create or update documents inside database","title":"cozy-konnector-libs"},{"location":"/dev/konnector/#linking-your-connector-to-a-cozy-dev-mode","text":"After several yarn standalone , your connector is able to automaticaly gather data from the targeted web service. It s time now to put this data in a real cozy. Here comes the dev mode . For that your connector needs more setup : a manifest.konnector file a COZY_URL section in konnector-dev-config.json","title":"Linking your connector to a cozy : dev mode"},{"location":"/dev/konnector/#the-manifest","text":"Each connector is described by a manifest. This is a JSON file named manifest.konnector at the root of your code folder. It should include the following minimal information: { name : konnector name , type : node , slug : konnectorslug , description : description , source : git://github.com/cozy/cozy-konnector-thename.git , permissions : { accounts : { description : Required to get the account's data , type : io.cozy.accounts , verbs : [ GET ] } } } cozy-konnector-template already has a manifest which you can customize. You may add some permissions for your own doctype. Here is the detailed list of fields for a connector manifest file. You can also get more information on permissions in the official cozy-stack documentation","title":"The manifest"},{"location":"/dev/konnector/#konnector-dev-configjson","text":"If you want to put data from your connector to a real cozy, your must define where to find this cozy, and this must be a cozy for which you have the credentials. Here comes the COZY_URL in konnector-dev-config.json which defines just that.","title":"konnector-dev-config.json"},{"location":"/dev/konnector/#run-the-dev-mode","text":"Then you just have to run: yarn dev For the first run, the CLI will open a tab in your browser asking you to grant permissions to the connector. The connector will then save data directly into your cozy. This will validate that your manifest has the needed permissions on the data you want to save. This is the dev mode","title":"Run the dev mode"},{"location":"/dev/konnector/#integration-in-the-store-for-all-the-users","text":"To run a connector, we do not want the cozy to install all dependencies of the connector each time it installs it. To avoid this, the connectors need to be compiled into one file in a dedicated branch of the repository and the repository needs to be a public git repository. The package.json file from cozy-konnector-template gives you the commands to do this : yarn build and yarn deploy but the last one needs to be configured in package.json Once your public git repository is configured, you only have to declare it. Cozy will soon have a store for connectors and you will be able to publish connectors yourself. But at the moment, you need to declare your new connector on the cozy forum . The Cozy team will review your code and add your connector to the Cozy Collect application. To make the connector available more quickly for all cozys, you can follow this few steps of packaging:","title":"Integration in the store for all the users"},{"location":"/dev/konnector/#icon","text":"You need to push an icon in assets/ . Please respect this rules : Square icon, possibly a png or svg Try the Apple app store icon if needed","title":"Icon"},{"location":"/dev/konnector/#packagejson","text":"Edit the name to be cozy-konnector- slug> Edit the repository URL Edit the command deploy with the correct repository URL","title":"Package.json"},{"location":"/dev/konnector/#manifestkonnector","text":"Edit the name with a nice name (Capitals and spaces allowed here) Edit icon as needed Edit slug Edit source with the correct repository URL Add a correct vendor link Choose one or more categories in this list : banking, shopping, insurance, isp, telecom, energy, public_service, other If needed, change the input type the target website use to login the user: text , email or phone for instance, this will enforce pre-checking Edit for both locales en and fr the short description and long description","title":"Manifest.konnector"},{"location":"/dev/konnector/#faq","text":"","title":"FAQ"},{"location":"/dev/konnector/#when-i-run-my-connector-a-ghost-node-process-eats-all-my-memory","text":"Cozy-konnector-libs uses cheerio which is great but causes some problems when you try to console.log a cheerio object. In standalone or dev mode, the BaseKonnector tries to catch errors and display a maximum of details about them. But when the error contains a cheerio object, the problem happens. If you get this problem, catch the error yourself and only display the message : .catch(err) { console.log(err.message) // good console.log(err) // bad }","title":"When I run my connector, a ghost node process eats all my memory"},{"location":"/dev/konnector/#how-do-i-scrap-a-website","text":"Use the request function from cozy-konnector-libs with the proper options. Here\u2019s a sample code that will fetch the login page to get the value of the anti-CSRF token, submit the login form, browse to the bills page and fetch a bill: const {BaseKonnector, requestFactory} = require('cozy-konnector-libs') const rq = requestFactory({ jar: true, // handle the cookies like a browser json: false, // do not try to parse the result as a json document cheerio: true // automatically parse the result with [cheerio](https://github.com/cheeriojs/cheerio) }) const moment = require('moment') module.exports = new BaseKonnector(function fetch (fields) { return rq( https://login.remote.web ) .then($ = { // the result is automatically wrapped with cheerio and you can use it like jQuery const form = { form: { login: fields.login, password: fields.password, csrf_token: $('[name= csrf_token ]').val(), } } return rq({ method: 'POST', form }) }) .then($ = rq( https://admin.remote.web/bills )) .then($ = { return [{date: moment($( #bill_date )), value: $( #bill_value )}] }) .then(entries = addData(entries, 'io.cozy.bills')) })","title":"How do I scrap a website"},{"location":"/dev/sendmail/","text":"Share and send mail in development Cozy apps let users share documents from cozy to cozy . Meet Alice and Bob. Alice wants to share a folder with Bob. Alice clicks on the share button and fills in the email input with Bob s email address. Bob receives an email with a \u00ab Accept the sharing \u00bb button. Bob clicks on that button and is redirected to Alice s cozy to enter his own cozy url to link both cozys. Bob sees Alice s shared folder in his own cozy. \ud83e\udd14 But how could we do this scenario on development environment? With the docker image If you develop with the cozy-app-dev docker image , MailHog is running inside it to catch emails. If cozy-stack has to send an email, MailHog catches it and exposes it on its web interface on http://cozy.tools:8025/. With the binary cozy-stack If you develop with the cozy-stack CLI , you have to run MailHog on your computer and tell cozy-stack serve where to find the mail server with some options : ./cozy-stack serve --appdir drive:../cozy-drive/build,settings:../cozy-settings/build --mail-disable-tls --mail-port 1025 This commands assumes you git clone cozy-drive and cozy-settings in the same folder than you git clone cozy-stack . Then simply run MailHog and open http://cozy.tools:8025/. Retrieve sent emails With MailHog, every email sent by cozy-stack is caught. That means the email address does not have to be a real one , ie. bob@cozy , bob@cozy.tools are perfectly fine. It could be a real one , but the email will not reach the real recipient s inbox, say contact@cozycloud.cc .","title":"sendmail"},{"location":"/dev/sendmail/#share-and-send-mail-in-development","text":"Cozy apps let users share documents from cozy to cozy . Meet Alice and Bob. Alice wants to share a folder with Bob. Alice clicks on the share button and fills in the email input with Bob s email address. Bob receives an email with a \u00ab Accept the sharing \u00bb button. Bob clicks on that button and is redirected to Alice s cozy to enter his own cozy url to link both cozys. Bob sees Alice s shared folder in his own cozy. \ud83e\udd14 But how could we do this scenario on development environment?","title":"Share and send mail in development"},{"location":"/dev/sendmail/#with-the-docker-image","text":"If you develop with the cozy-app-dev docker image , MailHog is running inside it to catch emails. If cozy-stack has to send an email, MailHog catches it and exposes it on its web interface on http://cozy.tools:8025/.","title":"With the docker image"},{"location":"/dev/sendmail/#with-the-binary-cozy-stack","text":"If you develop with the cozy-stack CLI , you have to run MailHog on your computer and tell cozy-stack serve where to find the mail server with some options : ./cozy-stack serve --appdir drive:../cozy-drive/build,settings:../cozy-settings/build --mail-disable-tls --mail-port 1025 This commands assumes you git clone cozy-drive and cozy-settings in the same folder than you git clone cozy-stack . Then simply run MailHog and open http://cozy.tools:8025/.","title":"With the binary cozy-stack"},{"location":"/dev/sendmail/#retrieve-sent-emails","text":"With MailHog, every email sent by cozy-stack is caught. That means the email address does not have to be a real one , ie. bob@cozy , bob@cozy.tools are perfectly fine. It could be a real one , but the email will not reach the real recipient s inbox, say contact@cozycloud.cc .","title":"Retrieve sent emails"},{"location":"/download/","text":"Download Cozy Drive for all your devices Cozy Drive on your phone Cozy Drive for iOS Requires iOS 8.0 or later Cozy Drive for Android Requires Android 5.0.0 (Advanced users that don\u2019t want to connect to Google Play can use the APK ) Cozy Banks on your phone Cozy Banks for iOS Requires iOS 8.0 or later Cozy Drive for Android Requires Android 5.0.0 or later (Advanced users that don\u2019t want to connect to Google Play can use the APK ) Cozy Drive on your computer Cozy Drive for Mac OS Download for MacOS Actively tested on MacOS 10.12.x Sierra and higher, should work on older versions Cozy Drive for Windows Download for Microsoft Windows Actively tested on Windows 10, should work on older versions Cozy Drive for GNU/Linux Full documentation on how to install Cozy Drive for GNU/Linux. List of known to work distributions","title":"index"},{"location":"/download/#download-cozy-drive-for-all-your-devices","text":"","title":"Download Cozy Drive for all your devices"},{"location":"/download/#cozy-drive-on-your-phone","text":"","title":"Cozy Drive on your phone"},{"location":"/download/#cozy-drive-for-ios","text":"Requires iOS 8.0 or later","title":"Cozy Drive for iOS"},{"location":"/download/#cozy-drive-for-android","text":"Requires Android 5.0.0 (Advanced users that don\u2019t want to connect to Google Play can use the APK )","title":"Cozy Drive for Android"},{"location":"/download/#cozy-banks-on-your-phone","text":"","title":"Cozy Banks on your phone"},{"location":"/download/#cozy-banks-for-ios","text":"Requires iOS 8.0 or later","title":"Cozy Banks for iOS"},{"location":"/download/#cozy-drive-for-android_1","text":"Requires Android 5.0.0 or later (Advanced users that don\u2019t want to connect to Google Play can use the APK )","title":"Cozy Drive for Android"},{"location":"/download/#cozy-drive-on-your-computer","text":"","title":"Cozy Drive on your computer"},{"location":"/download/#cozy-drive-for-mac-os","text":"Download for MacOS Actively tested on MacOS 10.12.x Sierra and higher, should work on older versions","title":"Cozy Drive for Mac OS"},{"location":"/download/#cozy-drive-for-windows","text":"Download for Microsoft Windows Actively tested on Windows 10, should work on older versions","title":"Cozy Drive for Windows"},{"location":"/download/#cozy-drive-for-gnulinux","text":"Full documentation on how to install Cozy Drive for GNU/Linux. List of known to work distributions","title":"Cozy Drive for GNU/Linux"},{"location":"/faq/","text":"Frequently Asked Questions Before starting Security","title":"index"},{"location":"/faq/#frequently-asked-questions","text":"Before starting Security","title":"Frequently Asked Questions"},{"location":"/faq/security/","text":"Security Are my data encrypted? No Where are my data hosted? On our servers. In the cloud.","title":"security"},{"location":"/faq/security/#security","text":"","title":"Security"},{"location":"/faq/security/#are-my-data-encrypted","text":"No","title":"Are my data encrypted?"},{"location":"/faq/security/#where-are-my-data-hosted","text":"On our servers. In the cloud.","title":"Where are my data hosted?"},{"location":"/faq/start/","text":"","title":"start"},{"location":"/","text":"Cozy Documentation The go-to website about Cozy configuration and setup. Keep your devices in sync Install your own server Develop applications Learn how to develop applications and connectors. Get in touch If you have any questions, you can contact us via these 3 medias: Write an email to our Support team: contact at cozy.io Post on the forum Chat with us on IRC","title":"index"},{"location":"/#cozy-documentation","text":"The go-to website about Cozy configuration and setup. Keep your devices in sync Install your own server Develop applications Learn how to develop applications and connectors.","title":"Cozy Documentation"},{"location":"/#get-in-touch","text":"If you have any questions, you can contact us via these 3 medias: Write an email to our Support team: contact at cozy.io Post on the forum Chat with us on IRC","title":"Get in touch"},{"location":"/index_fr/","text":"Cozy Documentation The go-to website about Cozy configuration and setup. Synchronisez toutes vos donn\u00e9es Installez votre propre serveur D\u00e9veloppez ! Apprenez \u00e0 d\u00e9velopper des applications et des connecteurs. Get in touch If you have any questions, you can contact us via these 3 medias: write an email to our Support team: contact at cozy.io post on the forum chat with us on IRC","title":"index_fr"},{"location":"/index_fr/#cozy-documentation","text":"The go-to website about Cozy configuration and setup. Synchronisez toutes vos donn\u00e9es Installez votre propre serveur D\u00e9veloppez ! Apprenez \u00e0 d\u00e9velopper des applications et des connecteurs.","title":"Cozy Documentation"},{"location":"/index_fr/#get-in-touch","text":"If you have any questions, you can contact us via these 3 medias: write an email to our Support team: contact at cozy.io post on the forum chat with us on IRC","title":"Get in touch"},{"location":"/install/debian/","text":"Install Cozy on a Debian server A Debian repository serves packages to setup a Cozy self-hosted environment. It provides: cozy-couchdb : CouchDB database engine used by cozy cozy-nsjail : NSJail isolation tool used by konnectors cozy-stack : Cozy core cozy-coclyco : CLI to manage vhosts and certificates cozy : metapackage installing everything to setup a self-hosted environment This repository currently supports: Debian Stretch (9.x): amd64 Ubuntu Xenial (16.04 LTS): amd64 Raspbian Stretch (9.x): armhf Available channels are: stable : official and supported releases testing : future official releases, for testing purposes. Updated \u00b1 twice a month. unstable : nightly builds, to be use with caution cozy-couchdb and cozy-nsjail are temporary packages. They will be removed when official couchdb and nsjail will be available You can choose to install cozy-couchdb on the same host as cozy-stack , or use a remote CouchDB server. Cozy only needs a 2.x CouchDB (1.x not supported). Like CouchDB, you can choose to install your reverse proxy on the same host, or use a remote one. Right now cozy-coclyco supports only local nginx . If you want to use apache2 or remote reverse proxy, you need to manually configure it for vhost or TLS certificate issuances. Prerequisites Third party repositories Let s Encrypt official packages require to use unofficial/third party repositories to have recent and supported version of ACME libraries. Packages provided by standard Debian or Ubuntu repositories are quite old and not compatible with cozy-coclyco . For Debian/Raspbian, you need to enable backports repository . For Ubuntu, you need to activate a third party ppa repository . Refer to the certbot documentation to activate needed repositories. (You don t need to install packages like certbot or python-certbot-xxx , only to activate repositories.) You may change your APT preferences to allow APT to install from backports/ppa by default instead of from official repositories. For example: /etc/apt/preferences.d/cozy Package: python3-acme Pin: release n=stretch-backports Pin-Priority: 510 EOF Cozy repositories First, install the packages required to install cozy apt install ca-certificates apt-transport-https curl Then, fetch the GPG Cozy signing key: curl https://apt.cozy.io/cozy.gpg | \\ apt-key --keyring /etc/apt/trusted.gpg.d/cozy.gpg add - curl https://apt.cozy.io/nightly/cozy.gpg | \\ apt-key --keyring /etc/apt/trusted.gpg.d/cozy.gpg add - Finally, setup your repository. Select the channel that best fit your needs: For now, we recommend to use testing repositories, or nightly/unstable channels. stable packages are quite old and currently provide deprecated and unsecured CouchDB version (2.0.x). Adapt your sources.list accordingly. Supported repositories are: Debian Stretch (9.x) deb https://apt.cozy.io/debian/ stretch stable deb https://apt.cozy.io/debian/ stretch testing deb https://apt.cozy.io/nightly/debian/ stretch unstable Ubuntu Xenial (16.04 LTS) deb https://apt.cozy.io/ubuntu/ xenial stable deb https://apt.cozy.io/ubuntu/ xenial testing deb https://apt.cozy.io/nightly/ubuntu/ xenial unstable Raspbian Stretch (9.x) deb https://apt.cozy.io/raspbian/ stretch stable deb https://apt.cozy.io/raspbian/ stretch testing deb https://apt.cozy.io/nightly/raspbian/ stretch unstable echo deb https://apt.cozy.io/debian/ stretch testing /etc/apt/sources.list.d/cozy.list apt update If you want to use unstable/nightly builds, you have to accept another key (weaker and passwordless on our side because of unattended automated builds) curl https://apt.cozy.io/nightly/cozy.gpg | \\ apt-key --keyring /etc/apt/trusted.gpg.d/cozy.gpg add - Setup For the rest of this document, we assume you install components one by one to allow intermediate verification For a full local environment ( couchdb + nginx + cozy ), just install the cozy package which can install all needed packages in one shot. CouchDB apt install cozy-couchdb Install CouchDB in standalone mode Configure CouchDB to listen on 127.0.0.1 Pick an administrator password (This password is used by shell scripts, so currently avoid to use one with simple or double quotes or others shell meaningfull symbols. We advice you to choose one with only alphanumeric digits to avoid troubles.) At this point, you must have a working CouchDB instance curl http://localhost:5984/ { couchdb : Welcome , version : 2.1.0 , features :[ scheduler ], vendor :{ name : The Apache Software Foundation }} If you want to use unstable/nightly builds, you might get another version of the database. Cozy stack apt install cozy-stack Cozy need to create a CouchDB administrator and so to connect as admin to the CouchDB. Fill those mandatory parameters to allow this creation: Address: by default, it s localhost:5984 Node name: by default, it s couchdb@localhost Admin user: by default, it s admin Admin password: put the one you choose during CouchDB setup Cozy user: by default, it s cozy Cozy password: pick a password (Those passwords are used by shell scripts, so currently avoid to use ones with simple or double quotes or others shell meaningfull symbols. We advice you to choose ones with only alphanumeric digits to avoid troubles.) For stack management (create instances, install applications ), Cozy need an administrator password . So pick a new one. When invoking cozy-stack (or cozy-coclyco which use it under the hood), you need to set the COZY_ADMIN_PASSWORD environment variable with this password. You can put it on your .bashrc for simplier life if you want. If you don t, cozy-stack will simply ask for it. At this point, you must have a working Cozy stack, depending on the branch you ve chosen you can get a different version displayed. curl http://localhost:8080/version { build_mode : production , build_time : 2017-09-28T10:26:03Z , runtime_version : go1.8.1 , version : 0.1.0 }# If you want to use konnectors, you need to initialize the NodeJS chroot (Currently this script only works for Debian and will be adapted for Ubuntu and Raspbian soon) /usr/share/cozy/konnector-create-chroot.sh If you use a self-signed certificate or a not official certificate authority, you need to deploy the corresponding root certificate in /usr/share/cozy/chroot/etc/ssl/certs/custom.crt . For example, if you use Let s Encrypt staging environment for testing purpose : wget -q https://letsencrypt.org/certs/fakelerootx1.pem \\ -O /usr/share/cozy/chroot/etc/ssl/certs/custom.crt Finally apt install cozy Cozy instance setup DNS Cozy relies on sub-domains for each applications you installed on your instance. For an instance cozy.example.org , app .cozy.example.org must be available too. Currently, you need at least: onboarding.cozy.example.org settings.cozy.example.org drive.cozy.example.org photos.cozy.example.org collect.cozy.example.org store.cozy.example.org app .cozy.example.org for each application you use Follow your usual way to create those entries on your domain zone. The simpliest way to handle this is to use a wildcard entry if supported by your domain hosting. cozy 1h IN A x.x.x.x *.cozy 1h IN CNAME cozy ACME (Let s Encrypt) Like DNS, each application will use a different sub-domain and so request a certificate which include all needed domains. cozy-coclyco use Let s Encrypt and it ACME protocol to prove your ownership over the domain you try to issue a certificate. This protocol requires your reverse proxy to be able to serve http:// app .cozy.example.org/.well-known/acme-challenge/ requests correctly. The simplest way to achieve this is to configure your reverse proxy with a generic rule to forward any /.well-known/acme-challenge/ request to the corresponding /etc /ssl/private/acme-challenge/ folder. For nginx , this can be done with /etc/nginx/sites-available/default server { listen 80 default_server; listen [::]:80 default_server; root /var/www/html; server_name _; location /.well-known/acme-challenge/ { alias /etc/ssl/private/acme-challenge/; } location / { return 301 https://$host$request_uri; } } apt install ssl-cert adduser www-data ssl-cert systemctl restart nginx Create instances Once you ve got a stack, your DNS and your reverse proxy correctly configured, you can create instances on your Cozy stack. Remember to set the COZY_ADMIN_PASSWORD environment variable. export COZY_ADMIN_PASSWORD= your-admin-password cozy-coclyco create cozy.example.org me@example.org For complete reference of Coclyco, refer to the documentation of cozy-coclyco .","title":"debian"},{"location":"/install/debian/#install-cozy-on-a-debian-server","text":"A Debian repository serves packages to setup a Cozy self-hosted environment. It provides: cozy-couchdb : CouchDB database engine used by cozy cozy-nsjail : NSJail isolation tool used by konnectors cozy-stack : Cozy core cozy-coclyco : CLI to manage vhosts and certificates cozy : metapackage installing everything to setup a self-hosted environment This repository currently supports: Debian Stretch (9.x): amd64 Ubuntu Xenial (16.04 LTS): amd64 Raspbian Stretch (9.x): armhf Available channels are: stable : official and supported releases testing : future official releases, for testing purposes. Updated \u00b1 twice a month. unstable : nightly builds, to be use with caution cozy-couchdb and cozy-nsjail are temporary packages. They will be removed when official couchdb and nsjail will be available You can choose to install cozy-couchdb on the same host as cozy-stack , or use a remote CouchDB server. Cozy only needs a 2.x CouchDB (1.x not supported). Like CouchDB, you can choose to install your reverse proxy on the same host, or use a remote one. Right now cozy-coclyco supports only local nginx . If you want to use apache2 or remote reverse proxy, you need to manually configure it for vhost or TLS certificate issuances.","title":"Install Cozy on a Debian server"},{"location":"/install/debian/#prerequisites","text":"","title":"Prerequisites"},{"location":"/install/debian/#third-party-repositories","text":"Let s Encrypt official packages require to use unofficial/third party repositories to have recent and supported version of ACME libraries. Packages provided by standard Debian or Ubuntu repositories are quite old and not compatible with cozy-coclyco . For Debian/Raspbian, you need to enable backports repository . For Ubuntu, you need to activate a third party ppa repository . Refer to the certbot documentation to activate needed repositories. (You don t need to install packages like certbot or python-certbot-xxx , only to activate repositories.) You may change your APT preferences to allow APT to install from backports/ppa by default instead of from official repositories. For example: /etc/apt/preferences.d/cozy Package: python3-acme Pin: release n=stretch-backports Pin-Priority: 510 EOF","title":"Third party repositories"},{"location":"/install/debian/#cozy-repositories","text":"First, install the packages required to install cozy apt install ca-certificates apt-transport-https curl Then, fetch the GPG Cozy signing key: curl https://apt.cozy.io/cozy.gpg | \\ apt-key --keyring /etc/apt/trusted.gpg.d/cozy.gpg add - curl https://apt.cozy.io/nightly/cozy.gpg | \\ apt-key --keyring /etc/apt/trusted.gpg.d/cozy.gpg add - Finally, setup your repository. Select the channel that best fit your needs: For now, we recommend to use testing repositories, or nightly/unstable channels. stable packages are quite old and currently provide deprecated and unsecured CouchDB version (2.0.x). Adapt your sources.list accordingly. Supported repositories are: Debian Stretch (9.x) deb https://apt.cozy.io/debian/ stretch stable deb https://apt.cozy.io/debian/ stretch testing deb https://apt.cozy.io/nightly/debian/ stretch unstable Ubuntu Xenial (16.04 LTS) deb https://apt.cozy.io/ubuntu/ xenial stable deb https://apt.cozy.io/ubuntu/ xenial testing deb https://apt.cozy.io/nightly/ubuntu/ xenial unstable Raspbian Stretch (9.x) deb https://apt.cozy.io/raspbian/ stretch stable deb https://apt.cozy.io/raspbian/ stretch testing deb https://apt.cozy.io/nightly/raspbian/ stretch unstable echo deb https://apt.cozy.io/debian/ stretch testing /etc/apt/sources.list.d/cozy.list apt update If you want to use unstable/nightly builds, you have to accept another key (weaker and passwordless on our side because of unattended automated builds) curl https://apt.cozy.io/nightly/cozy.gpg | \\ apt-key --keyring /etc/apt/trusted.gpg.d/cozy.gpg add -","title":"Cozy repositories"},{"location":"/install/debian/#setup","text":"For the rest of this document, we assume you install components one by one to allow intermediate verification For a full local environment ( couchdb + nginx + cozy ), just install the cozy package which can install all needed packages in one shot.","title":"Setup"},{"location":"/install/debian/#couchdb","text":"apt install cozy-couchdb Install CouchDB in standalone mode Configure CouchDB to listen on 127.0.0.1 Pick an administrator password (This password is used by shell scripts, so currently avoid to use one with simple or double quotes or others shell meaningfull symbols. We advice you to choose one with only alphanumeric digits to avoid troubles.) At this point, you must have a working CouchDB instance curl http://localhost:5984/ { couchdb : Welcome , version : 2.1.0 , features :[ scheduler ], vendor :{ name : The Apache Software Foundation }} If you want to use unstable/nightly builds, you might get another version of the database.","title":"CouchDB"},{"location":"/install/debian/#cozy-stack","text":"apt install cozy-stack Cozy need to create a CouchDB administrator and so to connect as admin to the CouchDB. Fill those mandatory parameters to allow this creation: Address: by default, it s localhost:5984 Node name: by default, it s couchdb@localhost Admin user: by default, it s admin Admin password: put the one you choose during CouchDB setup Cozy user: by default, it s cozy Cozy password: pick a password (Those passwords are used by shell scripts, so currently avoid to use ones with simple or double quotes or others shell meaningfull symbols. We advice you to choose ones with only alphanumeric digits to avoid troubles.) For stack management (create instances, install applications ), Cozy need an administrator password . So pick a new one. When invoking cozy-stack (or cozy-coclyco which use it under the hood), you need to set the COZY_ADMIN_PASSWORD environment variable with this password. You can put it on your .bashrc for simplier life if you want. If you don t, cozy-stack will simply ask for it. At this point, you must have a working Cozy stack, depending on the branch you ve chosen you can get a different version displayed. curl http://localhost:8080/version { build_mode : production , build_time : 2017-09-28T10:26:03Z , runtime_version : go1.8.1 , version : 0.1.0 }# If you want to use konnectors, you need to initialize the NodeJS chroot (Currently this script only works for Debian and will be adapted for Ubuntu and Raspbian soon) /usr/share/cozy/konnector-create-chroot.sh If you use a self-signed certificate or a not official certificate authority, you need to deploy the corresponding root certificate in /usr/share/cozy/chroot/etc/ssl/certs/custom.crt . For example, if you use Let s Encrypt staging environment for testing purpose : wget -q https://letsencrypt.org/certs/fakelerootx1.pem \\ -O /usr/share/cozy/chroot/etc/ssl/certs/custom.crt","title":"Cozy stack"},{"location":"/install/debian/#finally","text":"apt install cozy","title":"Finally"},{"location":"/install/debian/#cozy-instance-setup","text":"","title":"Cozy instance setup"},{"location":"/install/debian/#dns","text":"Cozy relies on sub-domains for each applications you installed on your instance. For an instance cozy.example.org , app .cozy.example.org must be available too. Currently, you need at least: onboarding.cozy.example.org settings.cozy.example.org drive.cozy.example.org photos.cozy.example.org collect.cozy.example.org store.cozy.example.org app .cozy.example.org for each application you use Follow your usual way to create those entries on your domain zone. The simpliest way to handle this is to use a wildcard entry if supported by your domain hosting. cozy 1h IN A x.x.x.x *.cozy 1h IN CNAME cozy","title":"DNS"},{"location":"/install/debian/#acme-lets-encrypt","text":"Like DNS, each application will use a different sub-domain and so request a certificate which include all needed domains. cozy-coclyco use Let s Encrypt and it ACME protocol to prove your ownership over the domain you try to issue a certificate. This protocol requires your reverse proxy to be able to serve http:// app .cozy.example.org/.well-known/acme-challenge/ requests correctly. The simplest way to achieve this is to configure your reverse proxy with a generic rule to forward any /.well-known/acme-challenge/ request to the corresponding /etc /ssl/private/acme-challenge/ folder. For nginx , this can be done with /etc/nginx/sites-available/default server { listen 80 default_server; listen [::]:80 default_server; root /var/www/html; server_name _; location /.well-known/acme-challenge/ { alias /etc/ssl/private/acme-challenge/; } location / { return 301 https://$host$request_uri; } } apt install ssl-cert adduser www-data ssl-cert systemctl restart nginx","title":"ACME (Let's Encrypt)"},{"location":"/install/debian/#create-instances","text":"Once you ve got a stack, your DNS and your reverse proxy correctly configured, you can create instances on your Cozy stack. Remember to set the COZY_ADMIN_PASSWORD environment variable. export COZY_ADMIN_PASSWORD= your-admin-password cozy-coclyco create cozy.example.org me@example.org For complete reference of Coclyco, refer to the documentation of cozy-coclyco .","title":"Create instances"},{"location":"/install/","text":"Install Cozy on your own server Learn how to install Cozy on Debian Stretch, Ubuntu Xenial or Raspbian Stretch ;","title":"index"},{"location":"/install/#install-cozy-on-your-own-server","text":"Learn how to install Cozy on Debian Stretch, Ubuntu Xenial or Raspbian Stretch ;","title":"Install Cozy on your own server"},{"location":"/install/manual/","text":"How to install Cozy on Debian Stable \u26a0\ufe0f This is a work in progress. For now, there\u2019s no easy and officially supported way to install Cozy. You have to install it and all this dependencies by hand. This tutorial is intended for tech savvy people wanting to give Cozy a first try without waiting for the official documentation and images. For now, this documentation don\u2019t explain how to install the technology stack required for connector, as the technology we use may evolve. So you won\u2019t be able to run the connectors. Most of the following commands require root privileges. You can either open a root shell or use sudo when needed; Pre-requisites Cozy requires a CouchDB 2 database server, a reverse proxy and an SMTP server. We\u2019ll use Nginx in this tutorial but feel free to use your reverse proxy of choice. You ll also need a domain name and know how to associate all of its subdomains to the IP address of your server. Install dependencies On a fresh new Debian Stretch, here are the packages that may be useful to install and manage your server: apt-get update apt-get --no-install-recommends -y install \\ ca-certificates \\ curl \\ net-tools \\ nginx \\ sudo \\ vim-tiny \\ build-essential \\ pkg-config \\ erlang \\ libicu-dev \\ libmozjs185-dev \\ libcurl4-openssl-dev Install CouchDB Download the source code on CouchDB 2 and install it . cd /tmp curl -LO https://dist.apache.org/repos/dist/release/couchdb/source/2.1.1/apache-couchdb-2.1.1.tar.gz tar xf apache-couchdb-2.1.1.tar.gz cd apache-couchdb-2.1.1 ./configure make release adduser --system \\ --no-create-home \\ --shell /bin/bash \\ --group --gecos \\ CouchDB Administrator couchdb We\u2019ll install CouchDB inside /home/couchdb : cp -R rel/couchdb /home/couchdb chown -R couchdb:couchdb /home/couchdb find /home/couchdb -type d -exec chmod 0770 {} \\; chmod -R 0644 /home/couchdb/etc/* mkdir /var/log/couchdb chown couchdb: /var/log/couchdb For now, we\u2019ll just run the database as a background job, but it is highly recommended to use some supervisor software. sudo -b -i -u couchdb sh -c '/home/couchdb/bin/couchdb /var/log/couchdb/couch.log 2 /var/log/couchdb/couch-err.log' Alternatively, you can setup a service script, and use systemd to run couchdb as a service : cat EOT /etc/systemd/system/couchdb.service [Unit] Description=Couchdb service After=network.target [Service] Type=simple User=couchdb ExecStart=/home/couchdb/bin/couchdb -o /dev/stdout -e /dev/stderr Restart=always [Install] WantedBy=multi-user.target EOT Then to start and enable (start at boot) the service : systemctl daemon-reload systemctl start couchdb.service systemctl enable couchdb.service Last but not least, let\u2019s create the default databases: curl -X PUT http://127.0.0.1:5984/_users curl -X PUT http://127.0.0.1:5984/_replicator curl -X PUT http://127.0.0.1:5984/_global_changes \u26a0\ufe0f The default CouchDB installation has no admin user. Everybody can query the server. So, in production environment, make sure to create en admin user and update the CouchDB connexion URL inside the configuration file of Cozy. Install the Cozy Stack The Cozy server is just a single binary. You can fetch one of its releases from Github: curl -o /usr/local/bin/cozy-stack \\ -L https://github.com/cozy/cozy-stack/releases/download/2017M2-alpha/cozy-stack-linux-amd64-2017M2-alpha chmod +x /usr/local/bin/cozy-stack adduser --system \\ --no-create-home \\ --shell /bin/bash \\ --group --gecos \\ Cozy cozy mkdir /var/log/cozy chown cozy: /var/log/cozy mkdir /var/lib/cozy chown -R cozy: /var/lib/cozy You can configure your server using a JSON or YAML file. Let\u2019s fetch the sample configuration file: mkdir /etc/cozy curl -o /etc/cozy/cozy.yaml \\ https://raw.githubusercontent.com/cozy/cozy-stack/master/cozy.example.yaml chown -R cozy: /etc/cozy Edit this file to adapt it to your configuration. You should setup a directory to store the files. For example: fs: url: file://localhost/var/lib/cozy Don\u2019t forget to allow Cozy user to write inside this folder. Compile a recent stack The released build may not contain the latest fixes. If you want an up to date version of the stack, you can compile it from the sources. This requires to install the Go compiler, fetch the sources and compile them: apt-get --no-install-recommends -y install \\ ca-certificates \\ curl \\ net-tools \\ nginx \\ sudo \\ vim-tiny \\ build-essential \\ pkg-config \\ erlang \\ libicu-dev \\ libmozjs185-dev \\ libcurl4-openssl-dev \\ git cd /tmp curl -LO https://storage.googleapis.com/golang/go1.8.3.linux-amd64.tar.gz tar -C /usr/local -xzf go1.8.3.linux-amd64.tar.gz PATH=$PATH:/usr/local/go/bin go get -u github.com/cozy/cozy-stack cp /root/go/bin/cozy-stack /usr/local/bin/cozy-stack chmod +x /usr/local/bin/cozy-stack Configuration NGinx Let\u2019s assume you want to host a server on mycozy.tld with a self-signed certificate. Generate the certificate. We need a wild-card certificate, as every application inside Cozy will have it\u2019s own sub-domain: sudo openssl req -x509 -nodes -newkey rsa:4096 \\ -keyout /etc/cozy/mycozy.tld.key \\ -out /etc/cozy/mycozy.tld.crt \\ -days 365 -subj /CN={*.mycozy.tld} Then create a virtual host for your server by creating a file at /etc/cozy/sites-available/mycozy.tld.conf with the following configuration template . And enable it by creating a symbolic link: sudo ln -s /etc/nginx/sites-available/mycozy.tld.conf \\ /etc/nginx/sites-enabled/ You can check that your configuration is valid by running sudo nginx -t -c /etc/nginx/nginx.conf And start NGinx: sudo service nginx start Or, if you use systemd: sudo systemctl start nginx sudo systemctl enable nginx # enable the nginx service at startup, if need to Cozy The Cozy server requires a main password: sudo /usr/local/bin/cozy-stack config passwd /etc/cozy/ This password will be asked every time you use the cozy-stack command line. To prevent this, you can set the COZY_ADMIN_PASSWORD environment variable. DNS Make sure to associate *.mycozy.tld with the IP address of your server. For example, add the following records to your DNS (replacing mycozy.tld with your domain of choice): mycozy.tld A your IP *.mycozy.tld CNAME mycozy.tld Running For now, we\u2019ll just run the server as a background job, but it is highly recommended to use some supervisor software. First, start the server: sudo -b -u cozy sh -c '/usr/local/bin/cozy-stack serve \\ --log-level info \\ --host 0.0.0.0 /var/log/cozy/cozy.log 2 /var/log/cozy/cozy-err.log' Then, create your instance and install the applications: cozy-stack instances add \\ --host 0.0.0.0 \\ --apps drive,photos,collect,settings \\ --passphrase XXX \\ mycozy.tld --passphrase \"XXX\" allows to set the initial password of the instance. You can add other instances by just running this commands again. The url of your cozy determines the name of your instance. If you choose another public port than the default public port for SSL (443), say 1443 , then you should reflect this when creating your cozy instance with the ${instance_domain} as mycozy.tld:1443 . Sample configuration files Nginx Put this file into /etc/nginx/sites-available and enable it by creating a symlink in /etc/nginx/sites-enabled . In this template, you need to replace the following placeholders: %PORT% with the public port nginx will listen to (default should be 443) %SERVER_PORT% with the private port cozy will listen to (default should be 8080) %DOMAIN% with your domain of choice: mycozy.tld in this example server { listen %PORT%; server_name *.%DOMAIN%; ssl_certificate /etc/cozy/%DOMAIN%.crt; ssl_certificate_key /etc/cozy/%DOMAIN%.key; ssl_session_cache shared:SSL:10m; ssl_session_timeout 10m; ssl_protocols TLSv1 TLSv1.1 TLSv1.2; ssl_ciphers EECDH+AES; ssl_prefer_server_ciphers on; ssl on; gzip_vary on; client_max_body_size 1024M; add_header Strict-Transport-Security max-age=31536000; location / { proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header Host $http_host; proxy_redirect http:// https://; proxy_pass http://127.0.0.1:8080; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection upgrade ; } access_log /var/log/nginx/cozy.log; } TODO Cozy also requires a SMTP server (or relay).","title":"manual"},{"location":"/install/manual/#how-to-install-cozy-on-debian-stable","text":"\u26a0\ufe0f This is a work in progress. For now, there\u2019s no easy and officially supported way to install Cozy. You have to install it and all this dependencies by hand. This tutorial is intended for tech savvy people wanting to give Cozy a first try without waiting for the official documentation and images. For now, this documentation don\u2019t explain how to install the technology stack required for connector, as the technology we use may evolve. So you won\u2019t be able to run the connectors. Most of the following commands require root privileges. You can either open a root shell or use sudo when needed;","title":"How to install Cozy on Debian Stable"},{"location":"/install/manual/#pre-requisites","text":"Cozy requires a CouchDB 2 database server, a reverse proxy and an SMTP server. We\u2019ll use Nginx in this tutorial but feel free to use your reverse proxy of choice. You ll also need a domain name and know how to associate all of its subdomains to the IP address of your server.","title":"Pre-requisites"},{"location":"/install/manual/#install-dependencies","text":"On a fresh new Debian Stretch, here are the packages that may be useful to install and manage your server: apt-get update apt-get --no-install-recommends -y install \\ ca-certificates \\ curl \\ net-tools \\ nginx \\ sudo \\ vim-tiny \\ build-essential \\ pkg-config \\ erlang \\ libicu-dev \\ libmozjs185-dev \\ libcurl4-openssl-dev","title":"Install dependencies"},{"location":"/install/manual/#install-couchdb","text":"Download the source code on CouchDB 2 and install it . cd /tmp curl -LO https://dist.apache.org/repos/dist/release/couchdb/source/2.1.1/apache-couchdb-2.1.1.tar.gz tar xf apache-couchdb-2.1.1.tar.gz cd apache-couchdb-2.1.1 ./configure make release adduser --system \\ --no-create-home \\ --shell /bin/bash \\ --group --gecos \\ CouchDB Administrator couchdb We\u2019ll install CouchDB inside /home/couchdb : cp -R rel/couchdb /home/couchdb chown -R couchdb:couchdb /home/couchdb find /home/couchdb -type d -exec chmod 0770 {} \\; chmod -R 0644 /home/couchdb/etc/* mkdir /var/log/couchdb chown couchdb: /var/log/couchdb For now, we\u2019ll just run the database as a background job, but it is highly recommended to use some supervisor software. sudo -b -i -u couchdb sh -c '/home/couchdb/bin/couchdb /var/log/couchdb/couch.log 2 /var/log/couchdb/couch-err.log' Alternatively, you can setup a service script, and use systemd to run couchdb as a service : cat EOT /etc/systemd/system/couchdb.service [Unit] Description=Couchdb service After=network.target [Service] Type=simple User=couchdb ExecStart=/home/couchdb/bin/couchdb -o /dev/stdout -e /dev/stderr Restart=always [Install] WantedBy=multi-user.target EOT Then to start and enable (start at boot) the service : systemctl daemon-reload systemctl start couchdb.service systemctl enable couchdb.service Last but not least, let\u2019s create the default databases: curl -X PUT http://127.0.0.1:5984/_users curl -X PUT http://127.0.0.1:5984/_replicator curl -X PUT http://127.0.0.1:5984/_global_changes \u26a0\ufe0f The default CouchDB installation has no admin user. Everybody can query the server. So, in production environment, make sure to create en admin user and update the CouchDB connexion URL inside the configuration file of Cozy.","title":"Install CouchDB"},{"location":"/install/manual/#install-the-cozy-stack","text":"The Cozy server is just a single binary. You can fetch one of its releases from Github: curl -o /usr/local/bin/cozy-stack \\ -L https://github.com/cozy/cozy-stack/releases/download/2017M2-alpha/cozy-stack-linux-amd64-2017M2-alpha chmod +x /usr/local/bin/cozy-stack adduser --system \\ --no-create-home \\ --shell /bin/bash \\ --group --gecos \\ Cozy cozy mkdir /var/log/cozy chown cozy: /var/log/cozy mkdir /var/lib/cozy chown -R cozy: /var/lib/cozy You can configure your server using a JSON or YAML file. Let\u2019s fetch the sample configuration file: mkdir /etc/cozy curl -o /etc/cozy/cozy.yaml \\ https://raw.githubusercontent.com/cozy/cozy-stack/master/cozy.example.yaml chown -R cozy: /etc/cozy Edit this file to adapt it to your configuration. You should setup a directory to store the files. For example: fs: url: file://localhost/var/lib/cozy Don\u2019t forget to allow Cozy user to write inside this folder.","title":"Install the Cozy Stack"},{"location":"/install/manual/#compile-a-recent-stack","text":"The released build may not contain the latest fixes. If you want an up to date version of the stack, you can compile it from the sources. This requires to install the Go compiler, fetch the sources and compile them: apt-get --no-install-recommends -y install \\ ca-certificates \\ curl \\ net-tools \\ nginx \\ sudo \\ vim-tiny \\ build-essential \\ pkg-config \\ erlang \\ libicu-dev \\ libmozjs185-dev \\ libcurl4-openssl-dev \\ git cd /tmp curl -LO https://storage.googleapis.com/golang/go1.8.3.linux-amd64.tar.gz tar -C /usr/local -xzf go1.8.3.linux-amd64.tar.gz PATH=$PATH:/usr/local/go/bin go get -u github.com/cozy/cozy-stack cp /root/go/bin/cozy-stack /usr/local/bin/cozy-stack chmod +x /usr/local/bin/cozy-stack","title":"Compile a recent stack"},{"location":"/install/manual/#configuration","text":"","title":"Configuration"},{"location":"/install/manual/#nginx","text":"Let\u2019s assume you want to host a server on mycozy.tld with a self-signed certificate. Generate the certificate. We need a wild-card certificate, as every application inside Cozy will have it\u2019s own sub-domain: sudo openssl req -x509 -nodes -newkey rsa:4096 \\ -keyout /etc/cozy/mycozy.tld.key \\ -out /etc/cozy/mycozy.tld.crt \\ -days 365 -subj /CN={*.mycozy.tld} Then create a virtual host for your server by creating a file at /etc/cozy/sites-available/mycozy.tld.conf with the following configuration template . And enable it by creating a symbolic link: sudo ln -s /etc/nginx/sites-available/mycozy.tld.conf \\ /etc/nginx/sites-enabled/ You can check that your configuration is valid by running sudo nginx -t -c /etc/nginx/nginx.conf And start NGinx: sudo service nginx start Or, if you use systemd: sudo systemctl start nginx sudo systemctl enable nginx # enable the nginx service at startup, if need to","title":"NGinx"},{"location":"/install/manual/#cozy","text":"The Cozy server requires a main password: sudo /usr/local/bin/cozy-stack config passwd /etc/cozy/ This password will be asked every time you use the cozy-stack command line. To prevent this, you can set the COZY_ADMIN_PASSWORD environment variable.","title":"Cozy"},{"location":"/install/manual/#dns","text":"Make sure to associate *.mycozy.tld with the IP address of your server. For example, add the following records to your DNS (replacing mycozy.tld with your domain of choice): mycozy.tld A your IP *.mycozy.tld CNAME mycozy.tld","title":"DNS"},{"location":"/install/manual/#running","text":"For now, we\u2019ll just run the server as a background job, but it is highly recommended to use some supervisor software. First, start the server: sudo -b -u cozy sh -c '/usr/local/bin/cozy-stack serve \\ --log-level info \\ --host 0.0.0.0 /var/log/cozy/cozy.log 2 /var/log/cozy/cozy-err.log' Then, create your instance and install the applications: cozy-stack instances add \\ --host 0.0.0.0 \\ --apps drive,photos,collect,settings \\ --passphrase XXX \\ mycozy.tld --passphrase \"XXX\" allows to set the initial password of the instance. You can add other instances by just running this commands again. The url of your cozy determines the name of your instance. If you choose another public port than the default public port for SSL (443), say 1443 , then you should reflect this when creating your cozy instance with the ${instance_domain} as mycozy.tld:1443 .","title":"Running"},{"location":"/install/manual/#sample-configuration-files","text":"","title":"Sample configuration files"},{"location":"/install/manual/#nginx_1","text":"Put this file into /etc/nginx/sites-available and enable it by creating a symlink in /etc/nginx/sites-enabled . In this template, you need to replace the following placeholders: %PORT% with the public port nginx will listen to (default should be 443) %SERVER_PORT% with the private port cozy will listen to (default should be 8080) %DOMAIN% with your domain of choice: mycozy.tld in this example server { listen %PORT%; server_name *.%DOMAIN%; ssl_certificate /etc/cozy/%DOMAIN%.crt; ssl_certificate_key /etc/cozy/%DOMAIN%.key; ssl_session_cache shared:SSL:10m; ssl_session_timeout 10m; ssl_protocols TLSv1 TLSv1.1 TLSv1.2; ssl_ciphers EECDH+AES; ssl_prefer_server_ciphers on; ssl on; gzip_vary on; client_max_body_size 1024M; add_header Strict-Transport-Security max-age=31536000; location / { proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header Host $http_host; proxy_redirect http:// https://; proxy_pass http://127.0.0.1:8080; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection upgrade ; } access_log /var/log/nginx/cozy.log; }","title":"Nginx"},{"location":"/install/manual/#todo","text":"Cozy also requires a SMTP server (or relay).","title":"TODO"},{"location":"/install/raspberry/","text":"","title":"raspberry"},{"location":"/sync/desktop/","text":"Sync your desktop computer with your server Cozy Drive for desktop allows you to synchronize your files and folders between your Cozy and your desktop. Thus, you can work on your files offline. Your modifications will be synchronized as soon as network will be available. Installation Before installing Cozy Drive, make sure your Cozy should be up-to-date. Windows You can download Cozy Drive for Windows on this page . List of known to work versions MacOS You can download Cozy Drive for macOS on this page . List of known to work versions Linux Learn how to download and use the GNU/linux client on this page . Configuration At the end of the installation, application will start and ask you for a few informations: Your Cozy URL. In other words, the address used to access to your Cozy. Your Cozy password. We don\u2019t save your password, we only use it to create a new device login which it uses to synchronize your files. The folder where you want to synchronize your files. Once done, you will be redirected to the dashboard. First synchronization can now start. The dashboard is composed of : An information panel about synchronizations and available disk space on your Cozy. A settings panel to configure autostart. An account panel with information on your Cozy and possibility to unlink your Cozy. A help panel in case of problem Troubleshooting When you hit a problem with the application, you can send us a message with the application logs, so we can try to understand and fix the problem. Open help panel, then click on Send us a message in Official support . Don\u2019t forget to describe your problem by adding as many details as you can.","title":"desktop"},{"location":"/sync/desktop/#sync-your-desktop-computer-with-your-server","text":"Cozy Drive for desktop allows you to synchronize your files and folders between your Cozy and your desktop. Thus, you can work on your files offline. Your modifications will be synchronized as soon as network will be available.","title":"Sync your desktop computer with your server"},{"location":"/sync/desktop/#installation","text":"Before installing Cozy Drive, make sure your Cozy should be up-to-date.","title":"Installation"},{"location":"/sync/desktop/#windows","text":"You can download Cozy Drive for Windows on this page . List of known to work versions","title":"Windows"},{"location":"/sync/desktop/#macos","text":"You can download Cozy Drive for macOS on this page . List of known to work versions","title":"MacOS"},{"location":"/sync/desktop/#linux","text":"Learn how to download and use the GNU/linux client on this page .","title":"Linux"},{"location":"/sync/desktop/#configuration","text":"At the end of the installation, application will start and ask you for a few informations: Your Cozy URL. In other words, the address used to access to your Cozy. Your Cozy password. We don\u2019t save your password, we only use it to create a new device login which it uses to synchronize your files. The folder where you want to synchronize your files. Once done, you will be redirected to the dashboard. First synchronization can now start. The dashboard is composed of : An information panel about synchronizations and available disk space on your Cozy. A settings panel to configure autostart. An account panel with information on your Cozy and possibility to unlink your Cozy. A help panel in case of problem","title":"Configuration"},{"location":"/sync/desktop/#troubleshooting","text":"When you hit a problem with the application, you can send us a message with the application logs, so we can try to understand and fix the problem. Open help panel, then click on Send us a message in Official support . Don\u2019t forget to describe your problem by adding as many details as you can.","title":"Troubleshooting"},{"location":"/sync/","text":"Sync all your devices with your server synchronize your phone synchronize your desktop computer","title":"index"},{"location":"/sync/#sync-all-your-devices-with-your-server","text":"synchronize your phone synchronize your desktop computer","title":"Sync all your devices with your server"},{"location":"/sync/linux/","text":"Install the desktop client on your GNU/Linux system To ease the use of Cozy Drive on any distribution, we distribute the application using the AppImage format. This way, you have nothing to install, just download the application and run it. We provide packages for both 32 bits and 64 bits systems. All you have to do is download the file, move it to some dedicated folder, make it executable and run it. List of known to work distributions Detailed instructions on Gnome Click on one of these links to download Cozy Drive for your OS: Cozy Drive for GNU/Linux 32 bits ; Cozy Drive for GNU/Linux 64 bits ; Once the binary file downloaded, go to the folder where your browser has stored it. For example, if you use Firefox, click on the folder icon in the download list. To be able to run the application, you have to edit its properties to make it executable. Just right click on the application and select Properties inside the context menu: Then go to the Permissions tab and check the box to make the application executable: There\u2019s no need to install the application, you can just run it from the folder you have downloaded it, but we recommend to move it to a dedicated folder to be able to find it easily. You can create an Applications folder inside your home directory and move the application there: Tip: you can add this folder to your bookmarks to find it easily: From 3.26 onwards, GNOME removed the systray (that little bar with some icons) which is the interface for Cozy Drive . You will need to install an extension such as TopIcons in order to see the cozy-desktop application and launch it. That\u2019s all. You can now double-click on the application to launch it and connect it to your server. Have fun! More More in deep insights on the GNU/Linux client . If your distribution is not supported, you can try the manual build guide .","title":"linux"},{"location":"/sync/linux/#install-the-desktop-client-on-your-gnulinux-system","text":"To ease the use of Cozy Drive on any distribution, we distribute the application using the AppImage format. This way, you have nothing to install, just download the application and run it. We provide packages for both 32 bits and 64 bits systems. All you have to do is download the file, move it to some dedicated folder, make it executable and run it. List of known to work distributions","title":"Install the desktop client on your GNU/Linux system"},{"location":"/sync/linux/#detailed-instructions-on-gnome","text":"Click on one of these links to download Cozy Drive for your OS: Cozy Drive for GNU/Linux 32 bits ; Cozy Drive for GNU/Linux 64 bits ; Once the binary file downloaded, go to the folder where your browser has stored it. For example, if you use Firefox, click on the folder icon in the download list. To be able to run the application, you have to edit its properties to make it executable. Just right click on the application and select Properties inside the context menu: Then go to the Permissions tab and check the box to make the application executable: There\u2019s no need to install the application, you can just run it from the folder you have downloaded it, but we recommend to move it to a dedicated folder to be able to find it easily. You can create an Applications folder inside your home directory and move the application there: Tip: you can add this folder to your bookmarks to find it easily: From 3.26 onwards, GNOME removed the systray (that little bar with some icons) which is the interface for Cozy Drive . You will need to install an extension such as TopIcons in order to see the cozy-desktop application and launch it. That\u2019s all. You can now double-click on the application to launch it and connect it to your server. Have fun!","title":"Detailed instructions on Gnome"},{"location":"/sync/linux/#more","text":"More in deep insights on the GNU/Linux client . If your distribution is not supported, you can try the manual build guide .","title":"More"},{"location":"/sync/phone/","text":"Sync your phone with your server Coming soon!","title":"phone"},{"location":"/sync/phone/#sync-your-phone-with-your-server","text":"Coming soon!","title":"Sync your phone with your server"},{"location":"/use/","text":"Welcome to your new home Hello, I\u2019m Claude, Cozy support team member. Let me introduce you to your new home in the cloud. Our charter Before starting the visit, I\u2019d like to tell you a few words about our values. Our priority is to help you take back the control on your data, by importing them into a safe place, a place that you\u2019re the only one to have access. In your personal cloud, you\u2019re at home By default, you are the only one that can access your data. (\u2026) Your data belongs to you Your are the one and only owner of the data stored on your cloud. Openness brings confidence Cozy is and will stay a service built on free software: you can use, copy, improve the source code. You decide how your data can be used Your Cozy server allows to control the data that you share with third party. Create your home in the cloud Your home has an address. Your home in the cloud also has an address. Let\u2019s choose it! Claude\u2019s tip Creating a good password may be hard. Your toolbox Save all your files and documents in just a click Access your files wherever your are, whenever you want Connect to deconnect Checklist Have you installed the Cozy application on your phone? Have you installed the Cozy application on your computers? Any question? One last surprise","title":"index"},{"location":"/use/#welcome-to-your-new-home","text":"Hello, I\u2019m Claude, Cozy support team member. Let me introduce you to your new home in the cloud.","title":"Welcome to your new home"},{"location":"/use/#our-charter","text":"Before starting the visit, I\u2019d like to tell you a few words about our values. Our priority is to help you take back the control on your data, by importing them into a safe place, a place that you\u2019re the only one to have access.","title":"Our charter"},{"location":"/use/#in-your-personal-cloud-youre-at-home","text":"By default, you are the only one that can access your data. (\u2026)","title":"In your personal cloud, you\u2019re at home"},{"location":"/use/#your-data-belongs-to-you","text":"Your are the one and only owner of the data stored on your cloud.","title":"Your data belongs to you"},{"location":"/use/#openness-brings-confidence","text":"Cozy is and will stay a service built on free software: you can use, copy, improve the source code.","title":"Openness brings confidence"},{"location":"/use/#you-decide-how-your-data-can-be-used","text":"Your Cozy server allows to control the data that you share with third party.","title":"You decide how your data can be used"},{"location":"/use/#create-your-home-in-the-cloud","text":"Your home has an address. Your home in the cloud also has an address. Let\u2019s choose it! Claude\u2019s tip Creating a good password may be hard.","title":"Create your home in the cloud"},{"location":"/use/#your-toolbox","text":"","title":"Your toolbox"},{"location":"/use/#save-all-your-files-and-documents-in-just-a-click","text":"","title":"Save all your files and documents in just a click"},{"location":"/use/#access-your-files-wherever-your-are-whenever-you-want","text":"","title":"Access your files wherever your are, whenever you want"},{"location":"/use/#connect-to-deconnect","text":"","title":"Connect to deconnect"},{"location":"/use/#checklist","text":"","title":"Checklist"},{"location":"/use/#have-you-installed-the-cozy-application-on-your-phone","text":"","title":"Have you installed the Cozy application on your phone?"},{"location":"/use/#have-you-installed-the-cozy-application-on-your-computers","text":"","title":"Have you installed the Cozy application on your computers?"},{"location":"/use/#any-question","text":"","title":"Any question?"},{"location":"/use/#one-last-surprise","text":"","title":"One last surprise"},{"location":"/use/index_fr/","text":"Bienvenue chez vous ! Voil\u00e0 c\u2019est parti, votre Cozy est sur le point de changer votre vie quotidienne ! Pour y parvenir et afin de vous faciliter au mieux cette installation, nous avons imagin\u00e9 pour vous un mini-guide avec tous les indispensables pour d\u00e9marrer votre Cozy. Claude, notre expert de l\u2019\u00e9quipe Support qui connait Cozy comme sa maison, est l\u2019auteur de cette documentation et vous livrera ses astuces. Pr\u00eat (e) \u00e0 adopter Cozy ? Nous vous accompagnons dans vos premiers pas ! Introduction Notre charte d\u2019engagement : vous redonner vos donn\u00e9es personnelles dans un endroit s\u00fbr et accessible par vous seul est notre priorit\u00e9 Comment vos donn\u00e9es personnelles sont-elles prot\u00e9g\u00e9es ? Dans votre cloud personnel, vous \u00eates chez vous Vous \u00eates la seule personne \u00e0 avoir acc\u00e8s \u00e0 vos donn\u00e9es, lesquelles ne sont partag\u00e9es avec aucun prestataire, sauf accord explicite et pr\u00e9alable de votre part donn\u00e9 au prestataire concern\u00e9. Vos donn\u00e9es vous appartiennent et nous n\u2019y toucherons pas Vos photos, vos donn\u00e9es bancaires ou l\u2019historique de votre poids, vous seul choisissez les donn\u00e9es que vous souhaitez r\u00e9cup\u00e9rer aupr\u00e8s des tiers qui aujourd\u2019hui les d\u00e9tiennent. Vous \u00eates l\u2019unique propri\u00e9taire des donn\u00e9es de votre service Cozy et des sauvegardes que Cozy Cloud r\u00e9alise automatiquement. Toute utilisation de vos donn\u00e9es par un tiers suppose votre accord explicite et pr\u00e9alable. Vous \u00eates libre de supprimer, modifier, copier, partager vos donn\u00e9es gr\u00e2ce au service Cozy, et ce aussi longtemps que vous \u00eates utilisateur du service. Nous ne regardons pas vos donn\u00e9es personnelles comme nous ne vous espionnons pas quand vous prenez votre douche. Nous garantissons la transparence de notre plateforme. Cozy est et restera un service reposant sur un logiciel libre : vous pouvez utiliser, copier, modifier (et am\u00e9liorer !) le code source. Le choix de l\u2019approche logiciel libre garantit la transparence du service Cozy, qui est auditable en toute circonstance, conform\u00e9ment \u00e0 la licence libre du logiciel utilis\u00e9 par Cozy Cloud. Vous d\u00e9cidez de l\u2019utilisation de vos donn\u00e9es La plateforme Cozy est con\u00e7ue pour vous permettre de contr\u00f4ler les donn\u00e9es sortantes de votre Cozy. Ce contr\u00f4le des applications tierces est partag\u00e9 par les utilisateurs de la communaut\u00e9 des Cozynautes, et Cozy Cloud s\u2019engage \u00e0 faciliter pour tous les utilisateurs de Cozy le signalement d\u2019applications malicieuses. Notre objectif : ce qui est dans votre Cozy reste dans votre Cozy. Bien d\u00e9marrer avec Cozy Cr\u00e9ez votre adresse Cozy Avant d\u2019arriver \u00e0 la maison, vous devez rentrer votre adresse dans un GPS ou la connaitre par c\u0153ur. C\u2019est exactement la m\u00eame chose pour votre Cozy mais sans la boussole ! L\u2019adresse de votre Cozy, c\u2019est la v\u00f4tre et \u00e0 la diff\u00e9rence de votre maison, elle ne figure pas dans les pages blanches visibles par tous. Vous manquez d\u2019imagination pour la cr\u00e9er ? Pas de panique ! Nous vous avons pr\u00e9par\u00e9 quelques exemples pour vous aider \u2013 attention, il ne suffit pas de les recopier mais bien d\u2019imaginer votre adresse personnalis\u00e9e : isabelledurand73.mycozy.cloud bernardlhermite.mycozy.cloud zazadurand.mycozy.cloud L\u2019astuce de Claude Ajoutez votre adresse Cozy \u00e0 vos favoris pour y acc\u00e9der en un seul clic Cr\u00e9er votre mot de passe L\u2019astuce de Claude Pour cr\u00e9er un mot de passe complexe mais facile \u00e0 retenir, imaginez une phrase absurde et cr\u00e9ez le mot de passe \u00e0 partir des initiales des mots et de la ponctuation. Ainsi, \u00ab Ma\u00eetre renard, sur un nuage perch\u00e9, tenait en son bec de la pluie \u00bb deviendra \u00ab Mr,s1np,tesb2lp \u00bb Bien utiliser votre Cozy Nous avons \u00e9labor\u00e9 une bo\u00eete \u00e0 outils pour param\u00e9trer votre Cozy et d\u00e9cupler ses capacit\u00e9s. Sauvegardez vos fichiers et documents en un seul clic Cozy vous permet d\u2019enregistrer tous vos fichiers (photos, vid\u00e9os, documents administratifs, factures etc.) au m\u00eame endroit et de les sauvegarder automatiquement. Ainsi, m\u00eame si votre ordinateur tombe en panne ou si vous oubliez votre t\u00e9l\u00e9phone dans le train, tous vos fichiers restent prot\u00e9g\u00e9s. Plus besoin d\u2019un disque externe pour sauvegarder vos documents ! Ajout de fichiers \u00e0 votre Cozy sur un ordinateur Windows ou Mac V\u00e9rifiez que l\u2019application de bureau est install\u00e9e sur votre ordinateur. Si vous n\u2019avez pas rencontr\u00e9 de soucis en suivants nos conseils, vous devriez passer cette \u00e9tape sans difficult\u00e9s. Faites glisser et d\u00e9posez les fichiers souhait\u00e9s dans le dossier Cozy Drive. Simple comme dire bonjour n\u2019est-ce pas ? Votre Cozy garde vos fichiers bien au chaud \u00e0 l\u2019abri de tous ! Sur votre Cozy depuis un navigateur Connectez-vous \u00e0 votre Cozy en suivant l\u2019adresse Internet que vous avez cr\u00e9\u00e9 au d\u00e9but (Par exemple : isabelledurand.mycozy.cloud) Ouvrez votre application Drive dans le menu Applications si ce n\u2019est pas d\u00e9j\u00e0 fait Cliquez sur le bouton bleu Transf\u00e9rer des fichiers en haut \u00e0 droite de la fen\u00eatre. Choisissez le fichier \u00e0 ajouter, puis cliquez sur Ouvrir. Acc\u00e9dez \u00e0 vos fichiers ou que vous soyez et quand vous voulez Enregistrez vos photos et vos documents dans Cozy, puis consultez-les \u00e0 partir de l\u2019application Cozy sur un ordinateur, un t\u00e9l\u00e9phone ou une tablette. Tous les fichiers que vous enregistrez dans Cozy sont automatiquement synchronis\u00e9s sur l\u2019ensemble de vos appareils, et restent ainsi toujours \u00e0 port\u00e9e de main. Pour retrouver vos fichiers sur tous vos appareils (PC, mobile et tablette) et synchroniser vos photos avec votre Cozy, t\u00e9l\u00e9chargez l\u2019application de Cozy pour iOS et l\u2019 application pour Android . Connectez-vous pour enfin d\u00e9connecter ! Cliquez sur Applications en haut \u00e0 droite de votre \u00e9cran et cliquez sur Cozy Collect, votre application regroupant les collecteurs disponibles dans votre Cozy. En s\u00e9lectionnant les connecteurs de vos fournisseurs, vous allez automatiser la r\u00e9cup\u00e9ration de vos donn\u00e9es li\u00e9es \u00e0 vos diff\u00e9rents comptes client. C\u2019est tr\u00e8s simple : s\u00e9lectionnez le fournisseur, entrez vos identifiant et mot de passe \u2013 ce sont ceux qui vous permettent de rentrer sur votre espace client. En un seul clic, votre connecteur est op\u00e9rationnel et actif. Un macaron vert apparaitra sur le connecteur ainsi actif. Vous pouvez renouveler l\u2019op\u00e9ration avec autant de connecteurs que vous le souhaitez (dans la mesure ou vous avez un compte client associ\u00e9). Avez-vous pens\u00e9 \u00e0 tout ? Avez-vous t\u00e9l\u00e9charg\u00e9 l\u2019application Cozy Drive sur votre iPhone ou votre Android ? Si oui, bravo ! Vous \u00eates d\u00e9j\u00e0 un Cozynaute confirm\u00e9 ! Si non, voici la marche \u00e0 suivre : Connectez-vous \u00e0 l\u2019adresse de notre site cozy.io Allez au bas de la page et cliquez sur le lien \u00ab T\u00e9l\u00e9charger l\u2019app mobile \u00bb Vous \u00eates d\u00e9sormais sur la page : https://docs.cozy.io/fr/download/ , vous pouvez cliquer sur le lien de votre choix en fonction de l\u2019OS de votre appareil. O\u00f9 alors cliquez sur les ic\u00f4nes ci-dessous : Avez-vous t\u00e9l\u00e9charg\u00e9 l\u2019application Cozy de bureau ? Si oui, bravo ! Vous \u00eates d\u00e9j\u00e0 un Cozynaute confirm\u00e9 ! Si ce n\u2019est pas d\u00e9j\u00e0 fait, cela vous prendra moins de deux minutes pour l\u2019installer : Connectez-vous \u00e0 l\u2019adresse de notre site cozy.io Allez au bas de la page et cliquez sur le lien \u00ab T\u00e9l\u00e9charger l\u2019app PC\u00bb Vous \u00eates d\u00e9sormais sur la page : https://docs.cozy.io/fr/download/ , vous pouvez cliquer sur le lien de votre choix en fonction de l\u2019OS de votre PC : MacOS ou Microsoft Windows . F\u00e9licitations ! Votre Cozy n\u2019a d\u00e9sormais plus de secret pour vous. Encore des questions ? Notre \u00e9quipe support se tient \u00e0 votre disposition pour toute autre question. Visitez notre page Aide en ligne sur le site cozy.io. Venez \u00e9galement nous dire bonjour sur Twitter et Facebook .","title":"index_fr"},{"location":"/use/index_fr/#bienvenue-chez-vous","text":"Voil\u00e0 c\u2019est parti, votre Cozy est sur le point de changer votre vie quotidienne ! Pour y parvenir et afin de vous faciliter au mieux cette installation, nous avons imagin\u00e9 pour vous un mini-guide avec tous les indispensables pour d\u00e9marrer votre Cozy. Claude, notre expert de l\u2019\u00e9quipe Support qui connait Cozy comme sa maison, est l\u2019auteur de cette documentation et vous livrera ses astuces. Pr\u00eat (e) \u00e0 adopter Cozy ? Nous vous accompagnons dans vos premiers pas !","title":"Bienvenue chez vous\u00a0!"},{"location":"/use/index_fr/#introduction","text":"","title":"Introduction"},{"location":"/use/index_fr/#notre-charte-dengagement-vous-redonner-vos-donnees-personnelles-dans-un-endroit-sur-et-accessible-par-vous-seul-est-notre-priorite","text":"","title":"Notre charte d\u2019engagement\u00a0: vous redonner vos donn\u00e9es personnelles dans un endroit s\u00fbr et accessible par vous seul est notre priorit\u00e9"},{"location":"/use/index_fr/#comment-vos-donnees-personnelles-sont-elles-protegees","text":"","title":"Comment vos donn\u00e9es personnelles sont-elles prot\u00e9g\u00e9es\u00a0?"},{"location":"/use/index_fr/#dans-votre-cloud-personnel-vous-etes-chez-vous","text":"Vous \u00eates la seule personne \u00e0 avoir acc\u00e8s \u00e0 vos donn\u00e9es, lesquelles ne sont partag\u00e9es avec aucun prestataire, sauf accord explicite et pr\u00e9alable de votre part donn\u00e9 au prestataire concern\u00e9.","title":"Dans votre cloud personnel, vous \u00eates chez vous"},{"location":"/use/index_fr/#vos-donnees-vous-appartiennent-et-nous-ny-toucherons-pas","text":"Vos photos, vos donn\u00e9es bancaires ou l\u2019historique de votre poids, vous seul choisissez les donn\u00e9es que vous souhaitez r\u00e9cup\u00e9rer aupr\u00e8s des tiers qui aujourd\u2019hui les d\u00e9tiennent. Vous \u00eates l\u2019unique propri\u00e9taire des donn\u00e9es de votre service Cozy et des sauvegardes que Cozy Cloud r\u00e9alise automatiquement. Toute utilisation de vos donn\u00e9es par un tiers suppose votre accord explicite et pr\u00e9alable. Vous \u00eates libre de supprimer, modifier, copier, partager vos donn\u00e9es gr\u00e2ce au service Cozy, et ce aussi longtemps que vous \u00eates utilisateur du service. Nous ne regardons pas vos donn\u00e9es personnelles comme nous ne vous espionnons pas quand vous prenez votre douche.","title":"Vos donn\u00e9es vous appartiennent et nous n\u2019y toucherons pas"},{"location":"/use/index_fr/#nous-garantissons-la-transparence-de-notre-plateforme","text":"Cozy est et restera un service reposant sur un logiciel libre : vous pouvez utiliser, copier, modifier (et am\u00e9liorer !) le code source. Le choix de l\u2019approche logiciel libre garantit la transparence du service Cozy, qui est auditable en toute circonstance, conform\u00e9ment \u00e0 la licence libre du logiciel utilis\u00e9 par Cozy Cloud.","title":"Nous garantissons la transparence de notre plateforme."},{"location":"/use/index_fr/#vous-decidez-de-lutilisation-de-vos-donnees","text":"La plateforme Cozy est con\u00e7ue pour vous permettre de contr\u00f4ler les donn\u00e9es sortantes de votre Cozy. Ce contr\u00f4le des applications tierces est partag\u00e9 par les utilisateurs de la communaut\u00e9 des Cozynautes, et Cozy Cloud s\u2019engage \u00e0 faciliter pour tous les utilisateurs de Cozy le signalement d\u2019applications malicieuses. Notre objectif : ce qui est dans votre Cozy reste dans votre Cozy.","title":"Vous d\u00e9cidez de l\u2019utilisation de vos donn\u00e9es"},{"location":"/use/index_fr/#bien-demarrer-avec-cozy","text":"","title":"Bien d\u00e9marrer avec Cozy"},{"location":"/use/index_fr/#creez-votre-adresse-cozy","text":"Avant d\u2019arriver \u00e0 la maison, vous devez rentrer votre adresse dans un GPS ou la connaitre par c\u0153ur. C\u2019est exactement la m\u00eame chose pour votre Cozy mais sans la boussole ! L\u2019adresse de votre Cozy, c\u2019est la v\u00f4tre et \u00e0 la diff\u00e9rence de votre maison, elle ne figure pas dans les pages blanches visibles par tous. Vous manquez d\u2019imagination pour la cr\u00e9er ? Pas de panique ! Nous vous avons pr\u00e9par\u00e9 quelques exemples pour vous aider \u2013 attention, il ne suffit pas de les recopier mais bien d\u2019imaginer votre adresse personnalis\u00e9e : isabelledurand73.mycozy.cloud bernardlhermite.mycozy.cloud zazadurand.mycozy.cloud L\u2019astuce de Claude Ajoutez votre adresse Cozy \u00e0 vos favoris pour y acc\u00e9der en un seul clic","title":"Cr\u00e9ez votre adresse Cozy"},{"location":"/use/index_fr/#creer-votre-mot-de-passe","text":"L\u2019astuce de Claude Pour cr\u00e9er un mot de passe complexe mais facile \u00e0 retenir, imaginez une phrase absurde et cr\u00e9ez le mot de passe \u00e0 partir des initiales des mots et de la ponctuation. Ainsi, \u00ab Ma\u00eetre renard, sur un nuage perch\u00e9, tenait en son bec de la pluie \u00bb deviendra \u00ab Mr,s1np,tesb2lp \u00bb","title":"Cr\u00e9er votre mot de passe"},{"location":"/use/index_fr/#bien-utiliser-votre-cozy","text":"Nous avons \u00e9labor\u00e9 une bo\u00eete \u00e0 outils pour param\u00e9trer votre Cozy et d\u00e9cupler ses capacit\u00e9s.","title":"Bien utiliser votre Cozy"},{"location":"/use/index_fr/#sauvegardez-vos-fichiers-et-documents-en-un-seul-clic","text":"Cozy vous permet d\u2019enregistrer tous vos fichiers (photos, vid\u00e9os, documents administratifs, factures etc.) au m\u00eame endroit et de les sauvegarder automatiquement. Ainsi, m\u00eame si votre ordinateur tombe en panne ou si vous oubliez votre t\u00e9l\u00e9phone dans le train, tous vos fichiers restent prot\u00e9g\u00e9s. Plus besoin d\u2019un disque externe pour sauvegarder vos documents !","title":"Sauvegardez vos fichiers et documents en un seul clic"},{"location":"/use/index_fr/#ajout-de-fichiers-a-votre-cozy-sur-un-ordinateur-windows-ou-mac","text":"V\u00e9rifiez que l\u2019application de bureau est install\u00e9e sur votre ordinateur. Si vous n\u2019avez pas rencontr\u00e9 de soucis en suivants nos conseils, vous devriez passer cette \u00e9tape sans difficult\u00e9s. Faites glisser et d\u00e9posez les fichiers souhait\u00e9s dans le dossier Cozy Drive. Simple comme dire bonjour n\u2019est-ce pas ? Votre Cozy garde vos fichiers bien au chaud \u00e0 l\u2019abri de tous !","title":"Ajout de fichiers \u00e0 votre Cozy sur un ordinateur Windows ou Mac"},{"location":"/use/index_fr/#sur-votre-cozy-depuis-un-navigateur","text":"Connectez-vous \u00e0 votre Cozy en suivant l\u2019adresse Internet que vous avez cr\u00e9\u00e9 au d\u00e9but (Par exemple : isabelledurand.mycozy.cloud) Ouvrez votre application Drive dans le menu Applications si ce n\u2019est pas d\u00e9j\u00e0 fait Cliquez sur le bouton bleu Transf\u00e9rer des fichiers en haut \u00e0 droite de la fen\u00eatre. Choisissez le fichier \u00e0 ajouter, puis cliquez sur Ouvrir.","title":"Sur votre Cozy depuis un navigateur"},{"location":"/use/index_fr/#accedez-a-vos-fichiers-ou-que-vous-soyez-et-quand-vous-voulez","text":"Enregistrez vos photos et vos documents dans Cozy, puis consultez-les \u00e0 partir de l\u2019application Cozy sur un ordinateur, un t\u00e9l\u00e9phone ou une tablette. Tous les fichiers que vous enregistrez dans Cozy sont automatiquement synchronis\u00e9s sur l\u2019ensemble de vos appareils, et restent ainsi toujours \u00e0 port\u00e9e de main. Pour retrouver vos fichiers sur tous vos appareils (PC, mobile et tablette) et synchroniser vos photos avec votre Cozy, t\u00e9l\u00e9chargez l\u2019application de Cozy pour iOS et l\u2019 application pour Android .","title":"Acc\u00e9dez \u00e0 vos fichiers ou que vous soyez et quand vous voulez"},{"location":"/use/index_fr/#connectez-vous-pour-enfin-deconnecter","text":"Cliquez sur Applications en haut \u00e0 droite de votre \u00e9cran et cliquez sur Cozy Collect, votre application regroupant les collecteurs disponibles dans votre Cozy. En s\u00e9lectionnant les connecteurs de vos fournisseurs, vous allez automatiser la r\u00e9cup\u00e9ration de vos donn\u00e9es li\u00e9es \u00e0 vos diff\u00e9rents comptes client. C\u2019est tr\u00e8s simple : s\u00e9lectionnez le fournisseur, entrez vos identifiant et mot de passe \u2013 ce sont ceux qui vous permettent de rentrer sur votre espace client. En un seul clic, votre connecteur est op\u00e9rationnel et actif. Un macaron vert apparaitra sur le connecteur ainsi actif. Vous pouvez renouveler l\u2019op\u00e9ration avec autant de connecteurs que vous le souhaitez (dans la mesure ou vous avez un compte client associ\u00e9).","title":"Connectez-vous pour enfin d\u00e9connecter\u00a0!"},{"location":"/use/index_fr/#avez-vous-pense-a-tout","text":"","title":"Avez-vous pens\u00e9 \u00e0 tout\u00a0?"},{"location":"/use/index_fr/#avez-vous-telecharge-lapplication-cozy-drive-sur-votre-iphone-ou-votre-android","text":"Si oui, bravo ! Vous \u00eates d\u00e9j\u00e0 un Cozynaute confirm\u00e9 ! Si non, voici la marche \u00e0 suivre : Connectez-vous \u00e0 l\u2019adresse de notre site cozy.io Allez au bas de la page et cliquez sur le lien \u00ab T\u00e9l\u00e9charger l\u2019app mobile \u00bb Vous \u00eates d\u00e9sormais sur la page : https://docs.cozy.io/fr/download/ , vous pouvez cliquer sur le lien de votre choix en fonction de l\u2019OS de votre appareil. O\u00f9 alors cliquez sur les ic\u00f4nes ci-dessous :","title":"Avez-vous t\u00e9l\u00e9charg\u00e9 l\u2019application Cozy Drive sur votre iPhone ou votre Android\u00a0?"},{"location":"/use/index_fr/#avez-vous-telecharge-lapplication-cozy-de-bureau","text":"Si oui, bravo ! Vous \u00eates d\u00e9j\u00e0 un Cozynaute confirm\u00e9 ! Si ce n\u2019est pas d\u00e9j\u00e0 fait, cela vous prendra moins de deux minutes pour l\u2019installer : Connectez-vous \u00e0 l\u2019adresse de notre site cozy.io Allez au bas de la page et cliquez sur le lien \u00ab T\u00e9l\u00e9charger l\u2019app PC\u00bb Vous \u00eates d\u00e9sormais sur la page : https://docs.cozy.io/fr/download/ , vous pouvez cliquer sur le lien de votre choix en fonction de l\u2019OS de votre PC : MacOS ou Microsoft Windows . F\u00e9licitations ! Votre Cozy n\u2019a d\u00e9sormais plus de secret pour vous.","title":"Avez-vous t\u00e9l\u00e9charg\u00e9 l\u2019application Cozy de bureau\u00a0?"},{"location":"/use/index_fr/#encore-des-questions","text":"Notre \u00e9quipe support se tient \u00e0 votre disposition pour toute autre question. Visitez notre page Aide en ligne sur le site cozy.io. Venez \u00e9galement nous dire bonjour sur Twitter et Facebook .","title":"Encore des questions\u00a0?"}]}